/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","./org.mng.main","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/components/list.base","runtime_dependencies/jrs-ui/src/tenantImportExport/utils/RegExpRepresenter","runtime_dependencies/jrs-ui/src/components/components.dialogs","runtime_dependencies/jrs-ui/src/actionModel/actionModel.primaryNavigation","jquery","runtime_dependencies/js-sdk/src/common/util/xssUtil","runtime_dependencies/jrs-ui/src/util/utils.common"],function(e,t,i){var s=e("prototype"),r=s.$,a=e("./org.mng.main"),n=e("runtime_dependencies/jrs-ui/src/core/core.layout"),o=e("runtime_dependencies/jrs-ui/src/components/list.base"),g=o.dynamicList,d=e("runtime_dependencies/jrs-ui/src/tenantImportExport/utils/RegExpRepresenter"),l=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),u=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.primaryNavigation"),p=e("jquery"),c=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),h=e("runtime_dependencies/jrs-ui/src/util/utils.common"),_=h.ValidationModule,A=h.matchAny,E=h.encodeUriParameter;a.orgManager.orgList={LIST_TEMPLATE_ID:"tabular_threeColumn",ITEM_TEMPLATE_ID:"tabular_threeColumn:leaf",ORG_ID_PATTERN:".ID > a",ORG_NAME_PATTERN:".name",ORG_ORGANIZATIONS_PATTERN:".organization",initialize:function(e){a.entityList.initialize({listTemplateId:this.LIST_TEMPLATE_ID,itemTemplateId:this.ITEM_TEMPLATE_ID,toolbarModel:e.toolbarModel,text:e.text}),a.entityList._createEntityItem=function(e){var t=new g.ListItem({label:e.id,value:e});return t.processTemplate=function(e){var t=a.orgManager.orgList,i=e.select(t.ORG_ID_PATTERN)[0],s=e.select(t.ORG_NAME_PATTERN)[0],r=e.select(t.ORG_ORGANIZATIONS_PATTERN)[0];i.update(c.hardEscape(this.getValue().id)),s.update(c.hardEscape(this.getValue().name));var n=this.getValue().subTenantCount;return n=n||0,r.update(c.hardEscape(a.getMessage("MT_SUB_TENANT_COUNT",{count:n}))),e},t}}},a.orgManager.addDialog={_ADD_ORGANIZATION_ID:"addOrganization",_ADD_BUTTON_ID:"addOrgBtn",_CANCEL_BUTTON_ID:"cancelOrgBtn",_ORG_NAME_ID:"addOrgName",_ORG_ID_ID:"addOrgID",_ORG_ALIAS_ID:"addOrgAlias",_ORG_DESC_ID:"addOrgDesc",_ADD_BUTTON_TITLE_PATTERN:".wrap",initialize:function(){this.addOrganization=r(this._ADD_ORGANIZATION_ID),this.addBtn=r(this._ADD_BUTTON_ID),this.cancelBtn=r(this._CANCEL_BUTTON_ID),this.orgName=r(this._ORG_NAME_ID),this.orgId=r(this._ORG_ID_ID),this.orgAlias=r(this._ORG_ALIAS_ID),this.orgDesc=r(this._ORG_DESC_ID),this.idUnsupportedSymbols=new d(a.Configuration.tenantIdNotSupportedSymbols).getRepresentedString(),this.aliasUnsupportedSymbols=this.idUnsupportedSymbols,this.nameUnsupportedSymbols=new d(a.Configuration.tenantNameNotSupportedSymbols).getRepresentedString(),this.orgId.regExp=a.orgManager.ID_REG_EXP,this.orgId.regExpForReplacement=a.orgManager.ID_REG_EXP_FOR_REPLACEMENT,this.orgName.regExp=a.orgManager.NAME_REG_EXP,this.orgAlias.regExp=a.orgManager.ALIAS_REG_EXP,this.orgAlias.regExpForReplacement=a.orgManager.ALIAS_REG_EXP_FOR_REPLACEMENT,this.orgId.unsupportedSymbols=new d(a.Configuration.tenantIdNotSupportedSymbols).getRepresentedString(),this.orgName.unsupportedSymbols=new d(a.Configuration.tenantNameNotSupportedSymbols).getRepresentedString(),this.orgAlias.unsupportedSymbols=this.orgId.unsupportedSymbols,this.orgId.inputValidator=a.createInputRegExValidator(this.orgId),this.orgName.inputValidator=a.createInputRegExValidator(this.orgName),this.orgAlias.inputValidator=a.createInputRegExValidator(this.orgAlias),this.addOrganization.observe("keyup",function(e){var t=e.element();if([this.orgId,this.orgName,this.orgAlias].include(t)){if(_.validate(t.inputValidator),this.orgName==t){var i=this.orgName;[this.orgId,this.orgAlias].each(function(e){e.changedByUser||(e.regExp.test(i.getValue())?e.setValue(i.getValue().replace(e.regExpForReplacement,"_")):e.setValue(i.getValue()))})}else t.changedByUser||(t.changedByUser=t.getValue()!=t.prevValue);e.stop()}}.bindAsEventListener(this)),this.addOrganization.observe("keydown",function(e){var t=e.element();[this.orgId,this.orgAlias].include(t)&&(t.prevValue=t.getValue())}.bindAsEventListener(this))},_clickButtonHandler:function(e){var t=A(e.element(),[n.BUTTON_PATTERN],!0);if(t==this.addBtn){var i=this,s=function e(t){i.addOrganization.stopObserving("click"),a.stopObserving("entity:created",e)};a.observe("entity:created",s),this._doAdd()}else t==this.cancelBtn&&(this.hide(),this.addOrganization.stopObserving("click"))},_hideValidationErrors:function(){[this.orgName,this.orgId,this.orgAlias,this.orgDesc].each(function(e){_.hideError(e,!0),e.changedByUser=!1})},show:function(e){this.organization=e,this._hideValidationErrors();var t=this.addBtn.select(this._ADD_BUTTON_TITLE_PATTERN)[0];if(t){var i=this.organization&&!this.organization.isRoot()?a.getMessage("addOrgTo",{organizationName:a.truncateOrgName(this.organization.id)}):a.getMessage("addOrg");t.update(i)}this.addBtn.title=this.organization&&!this.organization.isRoot()?a.getMessage("addOrgTo",{organizationName:this.organization.id}):a.getMessage("addOrg"),l.popup.show(this.addOrganization,!0),this.addOrganization.observe("click",this._clickButtonHandler.bindAsEventListener(this));try{this.orgName.focus()}catch(e){}},hide:function(){l.popup.hide(this.addOrganization),this.orgName.setValue(""),this.orgId.setValue(""),this.orgAlias.setValue(""),this.orgDesc.setValue("")},_validate:function(){return _.validateLegacy([a.createBlankValidator(this.orgId,"orgIdIsEmpty"),a.createBlankValidator(this.orgName,"orgNameIsEmpty"),a.createBlankValidator(this.orgAlias,"orgAliasIsEmpty"),this.orgId.inputValidator,this.orgName.inputValidator,this.orgAlias.inputValidator,a.createMaxLengthValidator(this.orgDesc,"error.length.description","{0,number,integer}")])},_autoFill:function(){},_doAdd:function(){if(this._validate()){var e=new a.Organization({tenantId:this.orgId.getValue(),tenantName:this.orgName.getValue(),tenantDesc:this.orgDesc.getValue(),tenantAlias:this.orgAlias.getValue()});return this.organization&&!this.organization.isRoot()&&(e.parentId=this.organization.id),this._checkId(e,function(e){this._checkAlias(e,function(e){a.invokeServerAction(a.ActionMap.CREATE,{entity:e.toJSON()})})}.bind(this)),!0}return!1},_checkId:function(e,t){a.invokeServerAction(a.ActionMap.EXIST,{entity:e,onExist:function(e){_.showError(this.orgId,a.getMessage("orgIdIsAlreadyInUse",{id:e}))}.bind(this),onNotExist:function(){_.hideError(this.orgId),Object.isFunction(t)&&t(e)}.bind(this)})},_checkAlias:function(e,t){e.alias.blank()?Object.isFunction(t)&&t(e):a.invokeOrgAction(a.orgManager.Action.ALIAS_EXIST,{org:e,onExist:function(e){_.showError(this.orgAlias,a.getMessage("orgAliasIsAlreadyInUse",{alias:e}))}.bind(this),onNotExist:function(){_.hideError(this.orgAlias),Object.isFunction(t)&&t(e)}.bind(this)})}},a.orgManager.properties={NAME_PATTERN:"#orgName",ID_PATTERN:"#orgID",ALIAS_PATTERN:"#orgAlias",DESC_PATTERN:"#orgDesc",MANAGE_USERS_PATTERN:"#manageUsers",MANAGE_ROLES_PATTERN:"#manageRoles",ASSIGNED_USERS_PATTERN:"#assignedUsers",ASSIGNED_ROLES_PATTERN:"#assignedRoles",org:null,initialize:function(e){var t=r(a.properties._id);this.orgName=t.select(this.NAME_PATTERN)[0],this.orgId=t.select(this.ID_PATTERN)[0],this.orgAlias=t.select(this.ALIAS_PATTERN)[0],this.orgDesc=t.select(this.DESC_PATTERN)[0],this.assignedUsers=t.select(this.ASSIGNED_USERS_PATTERN)[0],this.assignedRoles=t.select(this.ASSIGNED_ROLES_PATTERN)[0],this.manageUsers=t.select(this.MANAGE_USERS_PATTERN)[0],this.manageRoles=t.select(this.MANAGE_ROLES_PATTERN)[0],this.orgName.regExp=a.orgManager.NAME_REG_EXP,this.orgAlias.regExp=a.orgManager.ALIAS_REG_EXP,this.orgName.unsupportedSymbols=new d(a.Configuration.tenantNameNotSupportedSymbols).getRepresentedString(),this.orgAlias.unsupportedSymbols=new d(a.Configuration.tenantIdNotSupportedSymbols).getRepresentedString(),this.orgName.inputValidator=a.createInputRegExValidator(this.orgName),this.orgAlias.inputValidator=a.createInputRegExValidator(this.orgAlias),this._validators=[a.createBlankValidator(this.orgName,"orgNameIsEmpty"),a.createBlankValidator(this.orgAlias,"orgAliasIsEmpty"),this.orgName.inputValidator,this.orgAlias.inputValidator,a.createMaxLengthValidator(this.orgDesc,"error.length.description","{0,number,integer}")],a.properties.initialize(e._.extend(e,{viewAssignedListTemplateDomId:"list_type_attributes",viewAssignedItemTemplateDomId:"list_type_attributes:role",searchAssigned:!1,attributes:{context:{urlGETTemplate:"rest_v2/attributes?_embedded=permission&includeInherited=true{{ if (id) { }}&holder=tenant:/{{-id}}{{ } }}&group=custom&excludeGroup=serverSettings",urlPUTTemplate:"rest_v2{{ if (id) { }}/organizations/{{-id}}{{ } }}/attributes?_embedded=permission"}},showAssigned:!1})),this._initCustomEvents(),a.properties.setProperties=function(e){var t=a.orgManager.properties;t.orgName.setValue(e.name),t.orgId.setValue(e.id),t.orgAlias.setValue(e.alias),t.orgDesc.setValue(e.desc)},a.properties._deleteEntity=function(){a.invokeClientAction("delete",{entity:this._value,entityEvent:!!a.entityList.getSelectedEntities().length})},a.properties._editEntity=function(){var e=a.orgManager.properties;this.resetValidation([e.NAME_PATTERN,e.ALIAS_PATTERN,e.DESC_PATTERN]),this.changeReadonly(!0,[e.NAME_PATTERN,e.ALIAS_PATTERN,e.DESC_PATTERN])},a.properties._showEntity=function(){var e=a.orgManager.properties;this.resetValidation([e.NAME_PATTERN,e.ALIAS_PATTERN,e.DESC_PATTERN]),this.changeReadonly(!1,[e.NAME_PATTERN,e.ALIAS_PATTERN,e.DESC_PATTERN])},a.properties.validate=function(){var e=a.orgManager.properties,t=e._toOrg(this._value);if(_.validateLegacy(e._validators)&&(a.invokeOrgAction("aliasExist",{org:t,onExist:function(t){_.showError(e.orgAlias,a.getMessage("orgAliasIsAlreadyInUse",{alias:t}))}.bind(this),onNotExist:function(){_.hideError(e.orgAlias),this.save(t)}.bind(this)}),a.properties.attributesFacade))return!0},a.properties.isChanged=function(){var e=a.orgManager.properties,t=a.properties.attributesFacade.containsUnsavedItems(),i=this._value,s=e._toOrg(this._value);return this.isEditMode&&(t||i.name!=s.name||i.alias!=s.alias||i.desc!=s.desc)},a.properties.save=function(e){var t=a.orgManager.properties,i=t._toOrg(e);a.invokeServerAction("update",{entityName:this._value.getNameWithTenant(),entity:i,assigned:[],unassigned:[]})},a.properties.cancel=function(){var e=new p.Deferred;return this.setProperties(this._value),this.attributesFacade?this.attributesFacade.cancel():e.resolve()},a.properties.manageUsers=function(){u.navigationPaths.user.params+="&tenantId="+E(this._value.id),u.navigationOption("user")},a.properties.manageRoles=function(){u.navigationPaths.role.params+="&tenantId="+E(this._value.id),u.navigationOption("role")}},_initCustomEvents:function(e){var t=(a.orgManager.properties,r(a.properties._id));t.observe("keyup",function(e){var t=e.element();A(t,[this.NAME_PATTERN,this.ALIAS_PATTERN])&&(t.inputValidator&&_.validate([t.inputValidator]),e.stop()),a.properties._toggleButton()}.bindAsEventListener(this)),t.observe("click",function(e){var t=e.element();t==this.manageUsers?(a.properties.manageUsers(),e.stop()):t==this.manageRoles&&(a.properties.manageRoles(),e.stop())}.bindAsEventListener(this)),a.properties._toggleButton()},_toOrg:function(e){e=e||{};var t=new a.Organization({tenantName:this.orgName.getValue(),tenantId:this.orgId.getValue(),tenantAlias:this.orgAlias.getValue(),tenantDesc:this.orgDesc.getValue(),tenantUri:e.uri});return e.parentId&&(t.parentId=e.parentId),t},setAssigned:function(e,t){this.assignedUsers.update(e),this.assignedRoles.update(t)}}});