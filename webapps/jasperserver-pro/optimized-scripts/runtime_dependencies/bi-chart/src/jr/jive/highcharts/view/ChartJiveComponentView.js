/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","jquery","runtime_dependencies/bi-adhoc/src/adhoc/api/visualChooser/VisualChooserDialog","runtime_dependencies/bi-adhoc/src/adhoc/api/visualChooser/VisualizationTypesController","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","text!../template/chartMenuTemplate.htm","bundle!adhoc_messages","highcharts","./enum/reportCreatorEnum","csslink!../theme/highcharts.csslink.css"],function(e,t,i){function n(e,t){e.chart.animation=t,e.plotOptions||(e.plotOptions={}),e.plotOptions.series||(e.plotOptions.series={}),e.plotOptions.series.animation=t,e.legend||(e.legend={}),e.legend.navigation||(e.legend.navigation={}),e.legend.navigation.animation=t,e.tooltip||(e.tooltip={}),e.tooltip.animation=t}var s=e("backbone"),o=e("underscore"),r=e("jquery"),a=e("runtime_dependencies/bi-adhoc/src/adhoc/api/visualChooser/VisualChooserDialog"),h=e("runtime_dependencies/bi-adhoc/src/adhoc/api/visualChooser/VisualizationTypesController"),c=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),l=e("text!../template/chartMenuTemplate.htm"),d=e("bundle!adhoc_messages"),g=e("highcharts"),u=e("./enum/reportCreatorEnum");e("csslink!../theme/highcharts.csslink.css");var p=0,m=function(){return p++,function(e){return function(){}}()},v={dataSettingService:"../services/dataSettingService",defaultSettingService:"../services/defaultSettingService",dualPieSettingService:"../services/dualPieSettingService",treemapSettingService:"../services/treemapSettingService",gaugeSettingService:"../services/gaugeSettingService",itemHyperlinkSettingService:"../services/itemHyperlinkSettingService",yAxisSettingService:"../services/yAxisSettingService"},f=function(e,t,i){if(this._logger=i||m(),this.initCompleteDfr=new r.Deferred,!e.hcinstancedata.width||!e.hcinstancedata.height)return this._logger("jive constructor: got wrong container with size:",e.hcinstancedata.width,e.hcinstancedata.height),void this.initCompleteDfr.reject({name:"error",type:"wrongContainerSize",data:{width:e.hcinstancedata.width,height:e.hcinstancedata.height}});this.config=e,this.instanceData=JSON.parse(JSON.stringify(this.config.hcinstancedata)),this.renderTo=t,this.parent=null,this.loader=null,this.highchartsInstance=null,this.services=v,this._init()};f.prototype={_init:function(){var t=this,i=new r.Deferred;this.config.globalOptions&&g.setOptions(this.config.globalOptions),this.hcConfig={},i.resolve(),r.each(this.instanceData.services,function(n,s){var a=s.service,h=v[s.service]||a,c=s.data;i=i.then(function(){var i=new r.Deferred;return e([h],function(e){if("itemHyperlinkSettingService"===a){var n=o.extend({},c,{linkOptions:t.config.linkOptions});new e(t,t.hcConfig,n).perform()}else e.perform(t.hcConfig,c,t.config.linkOptions);i.resolve()}),i})}),i.then(function(){t.hcConfig.chart.renderTo=r("#"+t.instanceData.renderto,t.renderTo)[0],t.hcConfig.chart.width=t.instanceData.width-5,t.hcConfig.chart.height=t.instanceData.height-5,t.hcConfig.title&&!t.hcConfig.title.text&&(t.hcConfig.title=t.instanceData.title),o.isUndefined(t.config.chart.animation)||n(t.hcConfig,t.config.chart.animation),o.isUndefined(t.config.chart.zoom)||(t.hcConfig.chart.zoomType=t.config.chart.zoom),t.initCompleteDfr.resolve()})},render:function(){var e=this,t=new r.Deferred;return this.initCompleteDfr.then(function(){var i=e._renderChart(),n=i.status,s=i.error,o=i.errorMessage;n?t.resolve():t.reject({name:"error",type:"highchartsInternalError",data:{error:s,message:o}})}),t},_renderChart:function(){try{this.highchartsInstance=new g.Chart(this.hcConfig)}catch(t){this._destroyAllChartsWhichAreStillRendered();var e=d.ADH_1214_ICHARTS_ERROR_UNCAUGHT;return/\#19/.test(t)&&(e=d.ADH_1214_ICHARTS_ERROR_TOO_MANY_VALUES),{status:!1,error:t,errorMessage:e}}return{status:!0,error:null,errorMessage:""}},remove:function(){this.highchartsInstance&&this.highchartsInstance.destroy&&(this.highchartsInstance.destroy(),this.highchartsInstance=void 0)},_destroyAllChartsWhichAreStillRendered:function(){var e=this;o.each(g.charts,function(t){t&&e.hcConfig.chart.renderTo===t.renderTo&&t.destroy()})}};var C={opacity:"0.3"},S={opacity:"1"};i.exports=s.View.extend({initialize:function(e){this._logger=m(),this.isRendered=!1,this.initOptions=e,this.stateModel=this.initOptions.stateModel,this.report=this.initOptions.report,this.typesManager=new h},render:function(e,t){var i=this;this.renderTo=e,this.renderMenuTo=r("#"+this.model.get("hcinstancedata").renderto);var n=this.model.get("id")+"_visualChooser";this.visualChooserDialogStateHolder=this.initOptions.dialogStates.register(n,null);this.visualChooserDialogStateHolder.get();this.options=t||{},this._getSizeOfContainer();var s=this._renderComponent();if(s.done(function(){i.isRendered=!0}),this.model.get("hcinstancedata").services&&o.findWhere(this.model.get("hcinstancedata").services,{service:"adhocHighchartsSettingService"})){var a=this.component.services.adhocHighchartsSettingService,h=o.findWhere(this.model.get("hcinstancedata").services,{service:"adhocHighchartsSettingService"}).data.queryData.metadata.isOLAP,l=[];a&&(o.each(this.component.hcConfig.series,function(e){l=l.concat(o.map(e.data,function(t){return a.getHyperlink(e,t,h)}))}),this.model.set("hyperlinks",l))}return this.errorDialog=new c({additionalCssClasses:"jive_dialog"}),this.listenTo(this.model,"serverError",function(e){if(i.showError({devmsg:e.devmsg}),"changeChartType"===e.actionName){var t=i.model.get("charttype");i.visualChooserDialog.setSelectedType(t)}}),this.model.get("interactive")&&this.stateModel.isDefaultJiveUiEnabled()?(this._setupVisualChooserDialog(),this._renderMenu(),s):(s.resolve(),s)},_getSizeOfContainer:function(){this.model.get("creator")===u.AD_HOC_DESIGNER&&this.model.set("hcinstancedata",o.extend({},this.model.get("hcinstancedata"),{width:this.renderTo.width(),height:this.renderTo.height()||400,title:{text:this.options.highchartsReportTitle||""}}),{silent:!0})},_setupVisualChooserDialog:function(){if(!this.visualChooserDialog){this.visualChooserDialog=new a({typesToExclude:["Crosstab","Table"]}),this.listenTo(this.visualChooserDialog,"visualizationTypeChange",this._onVisualizationTypeChange),this.listenTo(this.visualChooserDialog,"close",this._onVisualChooserDialogCloseEvent);var e=this.model.get("charttype");this.visualChooserDialog.setSelectedType(e);var t=[];this.model.get("datetimeSupported")||(t=t.concat(["TimeSeriesLine","TimeSeriesSpline","TimeSeriesArea","TimeSeriesAreaSpline","TimeSeriesHeatMap"])),this.model.get("treemapSupported")||(t=t.concat(["DualMeasureTreeMap","TreeMap","OneParentTreeMap"])),t=o.uniq(t),this.visualChooserDialog.setDisabledTypes(t);var i=this.visualChooserDialogStateHolder.get();i&&this.visualChooserDialog.applyDialogState(i)}},_onVisualizationTypeChange:function(e){var t=this.visualChooserDialog.getDialogState();this.visualChooserDialogStateHolder.set(t),this.model.changeType({type:e.type})},_onVisualChooserDialogCloseEvent:function(){var e=this.visualChooserDialog.getDialogState();e.isDialogOpen=!1,this.visualChooserDialogStateHolder.set(e)},_renderComponent:function(){var e=this,t=new r.Deferred,i=this.model.collection?this.model.collection.linkOptions:null,n=o.extend(this.model.toJSON(),{chart:o.clone(this.stateModel.get("chart"))});return i&&(n.linkOptions=i),this.component&&this.component.remove&&this.component.remove(),this.component=new f(n,this.renderTo,this._logger),this.component.initCompleteDfr.done(function(){e.component.render().then(t.resolve,function(i){t.reject(i),e._renderComponentFailed(i)})}),this.component.initCompleteDfr.fail(function(i){e._logger("failed to initialize JiveHighcharts component because",i),t.reject(i)}),t},_renderComponentFailed:function(e){if("highchartsInternalError"===e.type){var t=d.ADH_1214_ICHARTS_ERROR_CANT_RENDER_CHART+":"+e.data.error;this.showError({devmsg:t})}},_renderMenu:function(){var e=this,t=r(o.template(l,{i18n:d}));this.$menu=t,t.insertBefore(this.renderMenuTo),t.css({top:"0"}),t.css(C);var i=t.find(".jive_chartSettingsIcon"),n=t.find(".jive_chartMenu");i.on("mouseenter touchstart",function(){i.addClass("over"),n.show().position({top:i.height(),left:0}),t.css(S)}),n.on("mouseleave touchend",function(){i.removeClass("over"),n.hide(),t.css(C)}),n.on("mouseenter touchstart","p.wrap",function(){r(this).addClass("over")}),n.on("mouseleave touchend","p.wrap",function(){r(this).removeClass("over")}),n.on("click touchend","li.jive_chartTypeMenuEntry",function(s){s.preventDefault(),s.stopPropagation(),n.hide(),i.removeClass("over"),t.css(C),e.visualChooserDialog.open()})},showError:function(e){this.errorDialog.setMessage(e.devmsg),this.errorDialog.open()},setSize:function(e,t,i){e<1||t<1||this.isRendered&&(this._resizeTimer&&clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout(this._reactOnResize.bind(this,i),500))},_reactOnResize:function(e){this._resizeTimer=null,this._getSizeOfContainer();var t=this.model.get("charttype");if(this.typesManager.doesChartSupportResizing(t)){var i=this.model.get("hcinstancedata");this.component&&this.component.highchartsInstance&&this.component.highchartsInstance.setSize(i.width,i.height,e)}else this._renderComponent()},remove:function(){this.$menu&&this.$menu.find(".jive_chartMenu").off("click mouseenter touchstart mouseleave touchend").find(".jive_chartSettingsIcon").off("mouseenter"),this.$menu&&this.$menu.remove(),this.stopListening(this.visualChooserDialog),this.visualChooserDialog&&this.visualChooserDialog.remove(),this.errorDialog&&this.errorDialog.remove(),s.View.prototype.remove.call(this,arguments)}})});