/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","bundle!DashboardBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../../enum/dashboardComponentTypes","../../enum/dashboardWiringStandardIds","../../enum/dashletTechnicalOutputs","./DashletModel","../../dashboardSettings","runtime_dependencies/bi-report/src/bi/report/enum/scaleStrategies","../../collection/ReportsParametersCollection"],function(e,r,t){function n(e){var r=e.get("parameters"),t=e.get("outputParameters"),n={signals:o.pluck(t,"id"),slots:{}};return o.each(r.concat([{id:l.APPLY_SLOT},{id:l.REFRESH_SLOT}]),function(r){n.slots[r.id]=function(r){return function(t,n){(e.lastPayload||(e.lastPayload={}))[r]=t,(e.lastSender||(e.lastSender={}))[r]=n,e.trigger("signal",{name:r,value:t},n)}}(r.id)}),n}function s(e){return o.map(e||[],function(e){return{id:e.id,uri:e.uri,label:e.label}})}function a(e){return o.filter(e||[],function(e){return-1===o.indexOf(E,e.id)})}var i=e("jquery"),o=e("underscore"),d=e("bundle!DashboardBundle"),u=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),h=e("../../enum/dashboardComponentTypes"),l=e("../../enum/dashboardWiringStandardIds"),c=e("../../enum/dashletTechnicalOutputs"),p=e("./DashletModel"),f=e("../../dashboardSettings"),m=e("runtime_dependencies/bi-report/src/bi/report/enum/scaleStrategies"),T=e("../../collection/ReportsParametersCollection"),_=T.instance,g=u.extend({bundle:d}),E=o.values(c);t.exports=p.extend({componentName:d["dashboard.component.report.component.name"],defaults:o.extend({},p.prototype.defaults,{type:h.REPORT,scaleToFit:f.DASHLET_SCALE_TO_FIT,autoRefresh:f.DASHLET_AUTO_REFRESH,refreshInterval:f.DASHLET_REFRESH_INTERVAL_TIME_UNIT_DEFAULT_MINUTES,refreshIntervalUnit:f.DASHBOARD_REFRESH_INTERVAL_UNIT,showTitleBar:f.DASHLET_SHOW_TITLE_BAR,showExportButton:f.DASHLET_SHOW_EXPORT_BUTTON,showRefreshButton:f.DASHLET_SHOW_REFRESH_BUTTON,showMaximizeButton:f.DASHLET_SHOW_MAXIMIZE_BUTTON,showPaginationControl:f.DASHLET_SHOW_PAGINATION_CONTROL}),validation:o.extend({},p.prototype.validation,{scaleToFit:[{required:!0,msg:new g("dashboard.component.error.scale.to.fit.required")},{oneOf:[1,m.HEIGHT,m.WIDTH,m.CONTAINER],msg:new g("dashboard.component.error.scale.to.fit.oneOf",d["dashboard.component.dialog.properties.scale.to.fit.no"],d["dashboard.component.dialog.properties.scale.to.fit.width"],d["dashboard.component.dialog.properties.scale.to.fit.height"],d["dashboard.component.dialog.properties.scale.to.fit.page"])}],refreshInterval:[{required:!0,msg:new g("dashboard.error.report.refreshInterval.required")},{integerNumber:!0,msg:new g("dashboard.error.report.refreshInterval.integer")},{fn:function(e,r,t){var n=t.refreshIntervalUnit,s={second:f.DASHLET_REFRESH_INTERVAL_TIME_UNIT_SECONDS,minute:f.DASHLET_REFRESH_INTERVAL_TIME_UNIT_MINUTES};if(e<s[n])return"Value must be bigger than "+s[n]},msg:new g("dashboard.error.report.refreshInterval.min",f.DASHLET_REFRESH_INTERVAL_TIME_UNIT_MINUTES,f.DASHLET_REFRESH_INTERVAL_TIME_UNIT_SECONDS)}],refreshIntervalUnit:[{required:!0,msg:new g("dashboard.error.report.refreshIntervalUnit.required")},{oneOf:["second","minute"],msg:new g("dashboard.error.report.refreshIntervalUnit.oneOf",d["dashboard.dialog.properties.refresh.interval.second"],d["dashboard.dialog.properties.refresh.interval.minute"])}]}),initialize:function(){var e=this;this.paramsDfd=new i.Deferred,this.componentInitializedDfd=new i.Deferred,p.prototype.initialize.apply(this,arguments),this.set("dataSourceUri",this._getDataSourceUri()),this.on("change:autoRefresh",function(){this.get("autoRefresh")||this.isValid(["refreshInterval","refreshIntervalUnit"])||this.set({refreshInterval:this.defaults.refreshInterval,refreshIntervalUnit:this.defaults.refreshIntervalUnit})},this),this.paramsModel.on("change",function(r){var t=o.reduce(e.get("parameters"),function(e,r){return r.parametrizeProperty&&e.push(r.id),e},[]);o.difference(o.keys(r.changed),t).length&&(this.paramsChanged=!0)})},getReportResourceUri:function(){return this.componentInitializedDfd.resolve(this.resource.resource.get("uri")).promise()},_getDataSourceUri:function(){return this.resource&&this.resource.resource&&this.resource.resource.get("uri")||this.get("dataSourceUri")},_getWiringMetadata:function(){var e=this,r=this.paramsDfd;if("pending"===this.paramsDfd.state()){if(!this.paramsDfd._running)if(this.get("parameters"))this.paramsDfd.resolve(this,n(this));else{this.paramsDfd._running=!0;var t=this.getReportResourceUri(),o=new i.Deferred;_.getReportParameters(this.resource.resource.get("uri")).done(function(r,t){e.set({outputParameters:s(a(t)),parameters:s(r)})}).fail(function(){e.set({outputParameters:[],parameters:[]})}).always(function(){o.resolve()}),i.when(t,o).then(function(){e.paramsDfd.resolve(e,n(e))})}}else r=new i.Deferred,r.resolve(this,n(this));return r.promise()}})});