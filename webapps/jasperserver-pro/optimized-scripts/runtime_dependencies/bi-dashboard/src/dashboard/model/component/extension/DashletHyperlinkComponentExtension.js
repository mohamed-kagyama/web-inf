/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","request","bundle!DashboardBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../../../dashboardSettings","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","../../../util/Dashboardi18nMessage"],function(e,r,t){function s(e,r,t){var s;try{s=e.getParametrizationResult("dashletHyperlinkUrl",n(t),{tolerateMissing:!0})}catch(e){r.reject(new g("dashboard.error.dialog.text.url.parameters.not.set",e))}if(s&&0===s.indexOf("repo:/")&&e.get("dashletHyperlinkTarget")){var a,d=s.indexOf("?"),u="";d<0?a=s.substring("repo:".length):(a=s.substring("repo:".length,d),u=s.substring(d+"?".length)),l({headers:{Accept:"application/json"},url:c.CONTEXT_PATH+"/rest_v2/discovery"+a}).fail(function(){r.reject(new g("dashboard.error.dialog.text.url.resource.not.accessible",a))}).done(function(e){s=o(e.uri,e.repositoryType,u),s?i(r,s):r.reject(new g("dashboard.error.dialog.text.url.unsupported.resource.type",a,e.repositoryType))})}else s?i(r,s):r.reject(new g("dashboard.error.dialog.text.url.empty"))}function n(e){return d.reduce(d.keys(e),function(r,t){return r[t]=d.map(e[t],encodeURIComponent),r},{})}function i(e,r){-1===r.toLowerCase().indexOf("javascript:")?e.resolve(r):e.reject(new g("dashboard.error.dialog.text.url.empty"))}function o(e,r,t){var s,n=c.CONTEXT_PATH||"";switch(r){case h.DASHBOARD:s=n+"/dashboard/viewer.html?"+t+"#"+e;break;case h.REPORT_UNIT:s=n+"/flow.html?_flowId=viewReportFlow&standAlone=true&ParentFolderUri="+e.substring(0,e.lastIndexOf("/"))+"&reportUnit="+e+"&"+t;break;case h.ADHOC_DATA_VIEW:s=n+"/flow.html?_flowId=adhocFlow&ParentFolderUri="+e.substring(0,e.lastIndexOf("/"))+"&resource="+e+"&"+t}return s}var a=e("jquery"),d=e("underscore"),l=e("request"),u=e("bundle!DashboardBundle"),p=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),c=e("../../../dashboardSettings"),h=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),g=e("../../../util/Dashboardi18nMessage"),f=p.extend({bundle:u});t.exports={defaults:{exposeOutputsToFilterManager:!1,dashletHyperlinkTarget:"",dashletHyperlinkUrl:void 0},validation:{dashletHyperlinkUrl:[{fn:function(e,r,t){if(""!==t.dashletHyperlinkTarget&&t.exposeOutputsToFilterManager&&d.isEmpty(e))return"URL is required"},msg:new f("dashboard.component.error.url.required")}]},mixin:{isValueProducer:function(){return this.get("exposeOutputsToFilterManager")&&this.has("outputParameters")&&this.get("outputParameters").length},getLinkUrl:function(e){var r=this.get("dashletHyperlinkUrl")&&this.get("dashletHyperlinkUrl").indexOf("$P{")>0;return(!this._linkUrlDfd||r&&e)&&(this._linkUrlDfd=a.Deferred(),s(this,this._linkUrlDfd,e||{})),this._linkUrlDfd}}}});