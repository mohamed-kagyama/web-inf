/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","jquery","runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension","bundle!DashboardBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../../enum/dashboardComponentTypes","runtime_dependencies/bi-control/src/bi/control/enum/substitutionConstants","runtime_dependencies/js-sdk/src/common/logging/logger","../parameters/ParameterParser","../parameters/DashboardParametersModel","../../dashboardSettings"],function(e,t,r){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){var r,n,i=e.length;for(r=0;r<i;r++)if(n=t(e[r]))return n}function s(e){return e=u.trim(e),e.match(_)?e.replace(v,"_"):null}function o(e,t,r){return u.trim(e)+(t>1?(r||"_")+t:"")}var a=e("backbone"),u=e("underscore"),d=e("jquery"),c=e("runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension"),h=e("bundle!DashboardBundle"),m=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),l=e("../../enum/dashboardComponentTypes"),p=e("runtime_dependencies/bi-control/src/bi/control/enum/substitutionConstants"),f=e("runtime_dependencies/js-sdk/src/common/logging/logger"),g=e("../parameters/ParameterParser"),b=e("../parameters/DashboardParametersModel"),y=e("../../dashboardSettings"),I=f.register("DashboardComponentModel"),P=m.extend({bundle:h}),_=new RegExp(y.DASHLET_ID_VALID_WORD_PATTERN),v=new RegExp(y.DASHLET_ID_BLACK_LIST_CHARS_PATTERN,"g"),S=a.Model.extend({defaults:{id:void 0,type:void 0,name:void 0,resource:void 0,selected:!1,interactive:!0},validation:{name:[{required:!0,msg:new P("dashboard.component.error.name.required")},{fn:function(e,t,r){return this.collection.find(function(t){return t.get("name")==e&&t.get("id")!==r.id})},msg:new P("dashboard.component.error.name.duplication")}]},componentName:"Component",initialize:function(e,t){this.get("name")||this.set("name",this.generateName()),this.get("id")||this.set("id",this.generateId()),t||(t={}),t.resource&&(this.resource=t.resource),t.dashboardId&&(this.dashboardId=t.dashboardId),this.paramsModel=new b,this.listenTo(this.paramsModel,"change",u.partial(this.trigger,"paramsModelChanged",this))},set:function(e,t,r){var i,s,o,d,c,h,m,l=this;return null==e?this:("object"===n(e)?(i=e,r=t):(i={})[e]=t,u.each(u.keys(i),function(e){i[e]&&i[e].indexOf&&i[e].indexOf("$P{")>=0&&(s||(s=[]),g.substitute(i[e],function(e){-1==u.indexOf(s,e)&&s.push(e)})),e&&this.get(e)&&this.get(e).indexOf&&this.get(e).indexOf("$P{")>=0&&(o||(o=[]),g.substitute(this.get(e),function(e){-1==u.indexOf(o,e)&&o.push(e)}))},this),s?o?(d=u.difference(s,o),c=u.difference(o,s)):d=s:c=o,this.parametersFromProperties=u.difference((this.parametersFromProperties||[]).concat(d||[]),c),h=d||c||i.parameters,h&&(i.parameters=u.reduce(this.parametersFromProperties,function(e,t){var r,n=t;return u.findWhere(e,{id:t})||(l.has("outputParameters")&&(r=u.findWhere(l.get("outputParameters"),{id:t}))&&(n=r.label),e.push({id:t,label:n,parametrizeProperty:!0})),e},i.parameters||u.filter(this.get("parameters")||[],function(e){return!e.parametrizeProperty}))),m=a.Model.prototype.set.call(this,i,r),!h&&!i.outputParameters||r&&r.silent||this.trigger("parameters:set"),m)},getChildren:function(){var e=this;return this.collection.filter(function(t){return t.get("parentId")===e.get("id")})},getParent:function(){if(this.has("parentId"))return this.collection.findWhere({id:this.get("parentId")})},generateName:function(e){var t,r=e||u.trim(this.get("label"))||this.componentName,n=s(this.get("type")===l.INPUT_CONTROL&&this.has("resourceId")?this.get("resourceId"):r);return n||(n=this.componentName,this.set("id",this.generateId(n))),t=this.generateIndex(r,"name"," "),o(r,t," ")},generateId:function(e){var t=i([e,this.get("type")===l.INPUT_CONTROL&&this.has("resourceId")?this.get("resourceId"):this.get("name"),this.componentName,this.get("type")],s);return o(t,this.generateIndex(t,"id","_"))},generateIndex:function(e,t,r){if(!this.collection)return 1;for(var n=1;;){var i=e+(n>1?r+n:""),s={};if(s[t]=i,!this.collection.findWhere(s))break;n++}return n},isVisualization:function(){return this.get("type")===l.REPORT||this.get("type")===l.WEB_PAGE_VIEW||this.get("type")===l.IMAGE||this.get("type")===l.ADHOC_VIEW||this.get("type")===l.TABLE||this.get("type")===l.CHART||this.get("type")===l.CROSSTAB},isValueProducer:function(){return!1},isVisible:function(){return!0},isAutoRefreshable:function(){return this.has("autoRefresh")&&this.has("refreshInterval")&&this.has("refreshIntervalUnit")},isParametrized:function(){return this.has("parameters")&&this.get("parameters").length>0},notify:function(e){u.each(u.keys(e||{}),function(t){this.trigger(t,e[t])},this)},acceptWiringVisitor:function(e){this._getWiringMetadata().done(e.register)},_getWiringMetadata:function(){var e=new d.Deferred;return e.resolve(this,{signals:[],slots:{}}),e.promise()},clone:function(){var e=a.Model.prototype.clone.call(this);return e.collection=this.collection,e},toJSON:function(){var e=a.Model.prototype.toJSON.apply(this,arguments);return delete e.selected,delete e.interactive,e},toDashboardComponentObject:function(){var e=this.pick("id","name","type","interactive","resource");try{e.name=this.getParametrizationResult("name",this.paramsModel.attributes,{tolerateMissing:!0})}catch(e){I.error(e)}return e.position=null,e.toolbar=null,e.maximized=null,e.pagination=null,u.isUndefined(e.resource)&&(e.resource=null),e},updateFromDashboardComponentObject:function(e){var t=u.omit(e,"id","name","type","toolbar","position","maximized","pagination","resource");this.set(t)},getParametrizationResult:function(e,t,r){if(!u.isUndefined(this.get(e))){var n=u.isFunction(t)?t:function(e,r){if(!t[e]||!t[e][0]||u.intersection(t[e],[p.NOTHING_SUBSTITUTION_VALUE,p.NULL_SUBSTITUTION_VALUE]).length){if(r)return[];throw e}return t[e]};return g.substitute(this.get(e),n,r)}},pushParametersState:function(){this.paramsModel.pushState()},popParametersState:function(e){this.paramsModel.popState(e)},resetParametersState:function(e){this.paramsModel.clear(e)},setCurrentParametersStateAsDefault:function(e){this.paramsModel.setDefault(e)}});u.extend(S.prototype,c.mixin),r.exports=S});