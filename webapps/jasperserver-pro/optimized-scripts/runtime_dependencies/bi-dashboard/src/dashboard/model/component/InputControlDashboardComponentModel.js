/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","./DashboardComponentModel","./ValueDashboardComponentModel","../../collection/ReportsParametersCollection","bundle!DashboardBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","jquery","underscore"],function(e,t,n){function r(e,t){var n={signals:[e.getOwnerParameterName()],slots:{}};return f.each(t,function(t){n.slots[t]=function(t){return function(n,r){e.trigger("signal",{name:t,value:n},r)}}(t)}),n}function i(){this._defer=!0}function s(e,t){var n=e.collection.filter(function(t){return t.get("ownerResourceId")===e.get("ownerResourceId")&&f.contains(e.get("masterDependencies"),t.getOwnerParameterName())});return f.reduce(n,function(e,n){return e||f.has(t,n.getOwnerParameterName())||s(n,t)},!1)}function o(e){return e.isValue?f.isArray(e.get("value"))?e.get("value"):[e.get("value")]:e.options.reduce(function(e,t){return t.get("selected")&&e.push(t.get("value")),e},[])}function a(e){return e.options?f.reduce(e.options,function(e,t){return t.selected&&e.push(t.value),e},[]):f.isArray(e.value)?e.value:[e.value]}var u=e("./DashboardComponentModel"),l=e("./ValueDashboardComponentModel"),c=e("../../collection/ReportsParametersCollection"),d=e("bundle!DashboardBundle"),h=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),p=e("jquery"),f=e("underscore"),m=h.extend({bundle:d}),g=c.instance;n.exports=l.extend({componentName:d["dashboard.component.input.control.component.name"],defaults:f.extend({},u.prototype.defaults,{label:void 0}),validation:f.extend({},u.prototype.validation,{label:[{required:!0,msg:new m("dashboard.component.error.filter.label.required")}]}),initializeSpecific:function(e,t){this.componentInitializedDfd=new p.Deferred},isVisible:function(){return this.resource.resource.has("visible")?this.resource.resource.get("visible"):this.has("parentId")},getOwnerUri:function(){var e=this.collection.findWhere({resource:this.get("ownerResourceId")});return e?e.resource.resource.get("uri"):void 0},getOwnerParameterName:function(){return this.get("ownerResourceParameterName")},notify:function(){this.trigger(this.getOwnerParameterName(),this.get("value"))},toDashboardComponentObject:function(){var e=u.prototype.toDashboardComponentObject.apply(this,arguments);return e.resource=null,e},toJSON:function(){return f.omit(this.attributes,"value")},acceptControlState:function(e){this.unset("value",{silent:!0}),this.set("value",o(e)),this.get("parentId")&&this.collection.get(this.get("parentId")).notify()},prepareForAcquire:function(e){var t=this;if(this.has("masterDependencies")&&this.get("masterDependencies").length){var n=this.collection.filter(function(e){return e.get("ownerResourceId")===t.get("ownerResourceId")&&f.contains(t.get("masterDependencies"),e.getOwnerParameterName())});f.each(n,function(n){f.isUndefined(e[n.id])||t.paramsModel.unset(n.id,{silent:!0}),n.prepareForAcquire(e)})}},acquireValue:function(e,t){var n;return this.has("masterDependencies")&&this.get("masterDependencies").length&&s(this,e)?(this._deferredExternalValue=e[this.id],n=this._isValueApplying=p.Deferred()):(f.isUndefined(e[this.id])?this.unset("value",t):(this.unset("value",{silent:!0}),this.set("value",e[this.id],t)),this._isValueApplying&&(n=this._isValueApplying,this._isValueApplying=void 0,this._deferredExternalValue=void 0,n.resolve()),n=(new p.Deferred).resolve()),n.promise()},acceptWiringVisitor:function(e){var t=this;e.register(this,r(this,this.get("masterDependencies"))),g.getInputControlAsParameter(this.getOwnerUri(),this.getOwnerParameterName(),{full:this.get("fullCollectionRequired")}).done(function(e){t.set("value",a(e.state),{silent:!0}),t.notify(),t.componentInitializedDfd.resolve()}).fail(function(){t.componentInitializedDfd.resolve()})},popParametersState:function(e){this.paramsModel.on("change",i,this),l.prototype.popParametersState.call(this,e),this.paramsModel.off("change",i,this),this._defer=!1},resetParametersState:function(e){this.paramsModel.on("change",i,this),l.prototype.resetParametersState.call(this,e),this.paramsModel.off("change",i,this),this._defer=!1},_deferValue:function(){return this._defer}})});