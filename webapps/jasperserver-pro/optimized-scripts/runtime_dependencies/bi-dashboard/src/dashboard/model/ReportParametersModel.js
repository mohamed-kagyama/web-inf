/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","../dashboardSettings","jquery","underscore"],function(t,e,r){function s(t,e){var r;return t?(r=t,r.push.apply(r,l.filter(e,function(e){return!l.findWhere(t,{id:e.id})}))):r=e,r}var a=t("backbone"),n=t("../dashboardSettings"),i=t("jquery"),l=t("underscore");r.exports=a.Model.extend({idAttribute:"reportUri",defaults:{all:!1},initialize:function(t,e){var r=this;this.stateDfds={},e&&(e.knownIds&&l.each(e.knownIds,function(t){r.stateDfds[t]=new i.Deferred}),e.full?(this.allControlsDfd=new i.Deferred,this.fetch({full:!0,data:e.data&&l.without(l.values(e.data),void 0).length?e.data:void 0}).fail(l.bind(this.allControlsDfd.reject,this.allControlsDfd))):e.knownIds&&e.knownIds.length&&this.fetch({preload:e.knownIds,data:e.data&&l.without(l.values(e.data),void 0).length?e.data:void 0}).fail(function(){var t=arguments;l.each(e.knownIds,function(e){r.stateDfds[e].reject.apply(r.stateDfds[e],t)})})),this.on("change:all",function(){r.allControlsDfd.resolve(r.get("inputControl"))}),this.on("change:parameters",function(){r.allParametersDfd.resolve(r.get("parameters"),r.get("outputParameters"))})},url:function(){return n.CONTEXT_PATH+"/rest_v2/reports"+encodeURI(this.get("reportUri"))+"/inputControls"},parse:function(t){var e=this;if(t)if(t.inputControl){var r=!0;l.each(t.inputControl,function(t){"repo:"===t.uri.substr(0,5)&&(t.uri=t.uri.substr(5)),t.state&&(e.stateDfds[t.id]||(e.stateDfds[t.id]=new i.Deferred),e.stateDfds[t.id].resolve(t),r=!1)}),t={inputControl:s(this.get("inputControl"),t.inputControl),parameters:this.get("parameters"),outputParameters:this.get("outputParameters"),all:r||this.get("full")||this.get("all")}}else t={inputControl:this.get("inputControl"),parameters:t.parameters,outputParameters:t.outputParameters,all:this.get("all")};else t={inputControl:[],parameters:this.get("parameters"),outputParameters:this.get("outputParameters"),all:!0};return t},sync:function(t,e,r){return"read"==t&&(r.full?e.set("full",!0,{silent:!0}):r.preload&&(r.url=this.url()+"/"+r.preload.join(";")),r.data&&(l.isObject(r.data)&&(r.data=JSON.stringify(r.data)),r.type="POST",r.processData=!1,r.headers={"Content-Type":"application/json"})),a.Model.prototype.sync.call(this,t,e,r)},getReportControls:function(t){return(!this.allControlsDfd||t&&t.force)&&(this.allControlsDfd=new i.Deferred,this.stateDfds={},this.unset("inputControl",{silent:!0}),this.set("all",!1,{silent:!0}),this.fetch({url:this.url()+"?exclude=state"}).fail(l.bind(this.allControlsDfd.reject,this.allControlsDfd))),this.allControlsDfd.promise()},getReportParameters:function(t){return(!this.allParametersDfd||t&&t.force)&&(this.allParametersDfd=new i.Deferred,this.unset("parameters",{silent:!0}),this.unset("outputParameters",{silent:!0}),this.fetch({url:n.CONTEXT_PATH+"/rest_v2/discovery"+encodeURI(this.get("reportUri"))}).fail(l.bind(this.allParametersDfd.reject,this.allParametersDfd))),this.allParametersDfd.promise()},getInputControlAsParameter:function(t,e){var r=this.stateDfds[t];return(!r||e&&e.force)&&(r=this.stateDfds[t]=new i.Deferred,this.fetch({preload:[t],data:e&&e.params,full:e&&e.full}).fail(l.bind(this.stateDfds[t].reject,this.stateDfds[t]))),r.promise()}})});