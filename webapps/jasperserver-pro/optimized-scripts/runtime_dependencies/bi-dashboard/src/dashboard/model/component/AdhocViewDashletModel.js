/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","runtime_dependencies/js-sdk/src/common/logging/logger","request","bundle!DashboardBundle","./VisualizationDashletModel","../../dashboardSettings","../../enum/dashboardComponentTypes","runtime_dependencies/js-sdk/src/common/util/identityUtil","./extension/DashletHyperlinkComponentExtension","../../factory/sandboxFactory"],function(e,t,r){function o(e){return c.EMBEDDED_ADHOC_VIEW_TEMP_LOCATION+"/"+e}var i=e("jquery"),n=e("underscore"),s=e("runtime_dependencies/js-sdk/src/common/logging/logger"),a=e("request"),u=e("bundle!DashboardBundle"),d=e("./VisualizationDashletModel"),c=e("../../dashboardSettings"),p=e("../../enum/dashboardComponentTypes"),h=e("runtime_dependencies/js-sdk/src/common/util/identityUtil"),l=e("./extension/DashletHyperlinkComponentExtension"),g=e("../../factory/sandboxFactory"),m=s.register("AdhocViewDashletModel");r.exports=d.extend(l.mixin).extend({componentName:u["dashboard.component.adHoc.view.component.name"],defaults:n.extend({},l.defaults,d.prototype.defaults,{exposeOutputsToFilterManager:!1,dashletHyperlinkTarget:"",dashletHyperlinkUrl:void 0,showExportButton:c.DASHLET_SHOW_EXPORT_BUTTON}),validation:n.extend({},l.validation,d.prototype.validation),initialize:function(){d.prototype.initialize.apply(this,arguments),this.get("type")===p.CHART&&this.set("isAdhocChart",!0),this.get("outputParameters")&&this.get("outputParameters").length&&this.set("isAdhocChart",!0),this.on("parameters:set",function(){this.get("outputParameters")&&this.get("outputParameters").length&&this.set("isAdhocChart",!0)},this)},toJSON:function(){var e=d.prototype.toJSON.apply(this,arguments);return delete e.dashletHyperlinkUrlVisible,e},acceptWiringVisitor:function(e){var t=this;this.on("parameters:set",n.bind(d.prototype.acceptWiringVisitor,this,e)),this._getWiringMetadata().done(function(r,o){e.register(r,o),t.has("outputParameters")&&t.notify(n.reduce(t.get("outputParameters"),function(e,t){return t.hasOwnProperty("value")&&(e[t.id]=t.value,delete t.value),e},{}))})},getReportResourceUri:function(){var e=g.get(this.dashboardId).get("generatedReports")||{},t=e[this.resource.resource.get("uri")];if(n.isUndefined(t)){if(!this.componentInitializedDfd._running){this.componentInitializedDfd._running=!0,m.debug("Started checking of report existence for "+this.resource.resource.get("uri"));var r=this;a({type:"POST",headers:{Accept:"application/json"},processData:!1,contentType:"application/json; charset=UTF-8",dataType:"json",data:JSON.stringify({dataSourceUri:this.resource.resource.get("uri"),label:"dashboardReport"}),url:c.CONTEXT_PATH+"/rest_v2/reportGenerators/custom-template"}).fail(function(e){r.componentInitializedDfd.resolve(!1,e.responseJSON)}).done(function(t){m.debug("Report for "+r.resource.resource.get("uri")+" is generated successfully"),e[r.resource.resource.get("uri")]=t.uri,g.get(r.dashboardId).set("generatedReports",e),r.componentInitializedDfd.resolve(t.uri,r.resource.resource.get("uri"))})}}else this.componentInitializedDfd.resolve(t,this.resource.resource.get("uri"));return this.componentInitializedDfd.promise()},resetCaching:function(){this.componentInitializedDfd=new i.Deferred},getDesignerUri:function(){var e=this.isNew()?o(h.generateUniqueName("tmpAdv_")):encodeURIComponent(this.resource.resource.get("uri")),t={_flowId:"adhocFlow",decorate:"no",embeddedDesigner:"true",saveAsUri:e,saveAsOverwrite:!0,reportType:this.get("type")};return this.isNew()||(t.embeddedName=encodeURIComponent(this.get("name"))),this.resource&&(t.resource=encodeURIComponent(this.resource.resource.get("uri"))),c.CONTEXT_PATH+"/flow.html?"+i.param(t)},isNew:function(){return void 0===this.resource},toDashboardComponentObject:function(){var e=d.prototype.toDashboardComponentObject.apply(this,arguments);return e.resource=this.resource.resource.get("uri"),e},_getDataSourceUri:function(){var e=[p.CROSSTAB,p.CHART,p.TABLE];return n.indexOf(e,this.get("type"))>=0?this.resource&&this.resource.resource.get("dataSourceUri")||this.get("dataSourceUri"):d.prototype._getDataSourceUri.call(this)}})});