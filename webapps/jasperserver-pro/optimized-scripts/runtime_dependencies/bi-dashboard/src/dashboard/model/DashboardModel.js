/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","../collection/DashboardFoundationCollection","../collection/DashboardResourceCollection","./DashboardResourceModel","./DashboardWiringModel","../factory/dashboardComponentModelFactory","./component/PropertiesDashboardComponentModel","../collection/DashboardComponentCollection","../collection/ReportsParametersCollection","../enum/dashboardResourceTypes","../enum/dashboardComponentTypes","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","runtime_dependencies/js-sdk/src/common/enum/errorCodes","../enum/dashboardResourceReferenceTypes","../enum/dashboardWiringStandardIds","bundle!DashboardBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","jquery","underscore"],function(e,o,t){function n(e,o){var t=D.where(e,{type:f.INPUT_CONTROL}),n=D.reduce(t,function(e,o){return(e[o.ownerResourceId]||(e[o.ownerResourceId]=[])).push(o),e},{});D.each(D.keys(n),function(e){F.add({reportUri:o[e]},{full:!!D.findWhere(n[e],{fullCollectionRequired:!0}),knownIds:D.pluck(n[e],"ownerResourceParameterName"),data:D.reduce(n[e],function(e,o){return e[o.ownerResourceParameterName]=o.value,e},{})})})}function r(e,o){try{var t=o.components.getDashboardPropertiesComponent().get("id");D.find(e,function(e){return e.component===t&&e.name===b.APPLY_SIGNAL})||e.push({component:t,consumers:[],name:b.APPLY_SIGNAL,producer:t+":"+b.APPLY_SIGNAL})}catch(e){}return e}var s=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),i=e("../collection/DashboardFoundationCollection"),c=e("../collection/DashboardResourceCollection"),u=e("./DashboardResourceModel"),a=e("./DashboardWiringModel"),d=e("../factory/dashboardComponentModelFactory"),h=e("./component/PropertiesDashboardComponentModel"),l=e("../collection/DashboardComponentCollection"),p=e("../collection/ReportsParametersCollection"),m=e("../enum/dashboardResourceTypes"),f=e("../enum/dashboardComponentTypes"),g=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),C=e("runtime_dependencies/js-sdk/src/common/enum/errorCodes"),y=e("../enum/dashboardResourceReferenceTypes"),b=e("../enum/dashboardWiringStandardIds"),R=e("bundle!DashboardBundle"),v=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),_=e("jquery"),D=e("underscore"),F=p.instance,w=v.extend({bundle:R});t.exports=s.extend({type:g.DASHBOARD,defaults:D.extend({},s.prototype.defaults,{label:R["dashboard.new.dashboard"],defaultFoundation:void 0,resources:void 0,foundations:void 0}),validation:D.extend({},s.prototype.validation,{label:[{required:!0,msg:new w("dashboard.error.label.required")},{maxLength:s.settings.LABEL_MAX_LENGTH,msg:new w("dashboard.error.label.maxLength",s.settings.LABEL_MAX_LENGTH)}],description:[{required:!1},{maxLength:s.settings.DESCRIPTION_MAX_LENGTH,msg:new w("dashboard.error.description.maxLength",s.settings.DESCRIPTION_MAX_LENGTH)}],parentFolderUri:[{required:!0,msg:new w("dashboard.error.parentFolderUri.required")}]}),initialize:function(e,o){s.prototype.initialize.apply(this,arguments),o||(o={}),o.dashboardId&&(this.dashboardId=o.dashboardId),this.isDesigner=!!o.isDesigner,this.resources=new c,this.foundations=new i,this.listenTo(this.foundations,"add",this._onFoundationAdd),this.listenTo(this.foundations,"addComponent",this._onComponentAdd),this.listenTo(this.foundations,"removeComponent",this._onComponentRemove),this.listenTo(this.foundations,"addComponent removeComponent moveComponent resizeComponent",this._onLayoutChange),this.listenTo(this.foundations,"changeProperties changedControlProperties",this._onComponentChange),this.listenTo(this.foundations,"changeWiring",this._onWiringChange),this.on("resourcesDataFetched",function(){this.listenTo(this.currentFoundation,"addComponent",this.addResourceReference),this.listenTo(this.currentFoundation.components,"change:url",this.updateResourceReference),this.listenTo(this.currentFoundation,"removeComponent",this.removeResourceReference)},this),this.on("change:defaultFoundation",this._onDefaultFoundationChange),this._initDefaultFoundation()},resetToInitialCondition:function(){var e=this.currentFoundation;this.set(D.omit(this.defaults,"defaultFoundation")),e.wiring.set([]),e.wiring.handlers={},e.components.set([]),e.components.add(new h({},{dashboardId:this.dashboardId||this.cid})),this.resources.set([this.resources.get(e.get("wiring")),this.resources.get(e.get("layout")),this.resources.get(e.get("components"))])},fetch:function(e){e||(e={});var o=s.prototype.fetch.call(this,e),t=new _.Deferred,n=this;return o.done(function(){var e=!1;if(n.type!==g.DASHBOARD&&(e={status:400,responseText:JSON.stringify({message:"Resource '"+n.get("uri")+"' is not of type '"+g.DASHBOARD+"'",errorCode:C.INVALID_RESOURCE_TYPE,parameters:[n.type]})}),!n.isDesigner||1===n.get("permissionMask")||4&n.get("permissionMask")||(e={status:403,responseText:JSON.stringify({message:"Access denied",errorCode:C.ACCESS_DENIED})}),e)n.set(D.omit(n.defaults,"defaultFoundation","foundations","resources")),n.trigger("error",n,e),t.reject(e);else{n.trigger("rawDataFetched",n),n.updateResourceCollection();var o=n.resources.chain().filter(function(e){return e.resource&&e.resource.fetchContent}).map(function(e){return e.resource instanceof s&&D.isUndefined(e.resource.contextPath)&&(e.resource.contextPath=n.contextPath),e.resource.fetchContent()}).value();_.when.apply(_,o).done(function(){n.trigger("resourcesDataFetched",n),n.updateFoundationCollection(),n.currentFoundation.startLoadingSequence(),n.trigger("propertiesAvailable",n.currentFoundation.components.getDashboardPropertiesComponent()),t.resolve()})}}).fail(t.reject),t},parse:function(e){if(e.resources)for(var o=0;o<e.resources.length;o++)!e.resources[o].resource.resourceReference||"layout"!==e.resources[o].type&&"wiring"!==e.resources[o].type&&"components"!==e.resources[o].type||(e.resources[o].resource={file:{label:e.resources[o].name,uri:e.resources[o].resource.resourceReference.uri}},delete e.resources[o].resource.resourceReference);return e},toJSON:function(e){this.foundations.map(D.bind(this._onWiringChange,this,null));var o=s.prototype.toJSON.apply(this,arguments);return o.foundations=this.foundations.toJSON(),o.resources=this.resources.toJSON(e),o},_initDefaultFoundation:function(){this.foundations.addDefaultFoundation().components.add(new h({},{dashboardId:this.dashboardId||this.cid})),this.set("defaultFoundation",this.foundations.getDefaultFoundation().get("id"))},_onDefaultFoundationChange:function(){this.currentFoundation!==this.foundations.get(this.get("defaultFoundation"))&&(this.currentFoundation=this.foundations.get(this.get("defaultFoundation")))},_onComponentAdd:function(e,o){this.resources.get(o.get("components")).resource.setContent(o.components.toJSON());var t=e.resource;t&&!this.resources.get(t.id)&&this.resources.add(t)},_onComponentChange:function(e,o){this.resources.get(o.get("components")).resource.setContent(o.components.toJSON())},_onComponentRemove:function(e,o){this.resources.get(o.get("components")).resource.setContent(o.components.toJSON());var t=e.resource,n=!1;t&&(this.foundations.forEach(function(o){o.components.forEach(function(o){o!==e&&o.resource===t&&(n=!0)})}),n||this.resources.remove(t))},_onLayoutChange:function(e,o){this.resources.get(o.get("layout")).resource.setContent(o.components.toHTML())},_onWiringChange:function(e,o){this.resources.get(o.get("wiring")).resource.setContent(o.wiring.toJSON())},_onFoundationAdd:function(e){var o={};o[y.FILE]={label:e.get("components")};var t={};t[y.FILE]={label:e.get("layout")};var n={};n[y.FILE]={label:e.get("wiring")},this.resources.add(new u({name:e.get("components"),type:m.COMPONENTS,resource:o},{contextPath:this.contextPath})).resource.setContent(e.components.toJSON()),this.resources.add(new u({name:e.get("layout"),type:m.LAYOUT,resource:t},{contextPath:this.contextPath})).resource.setContent(e.components.toHTML()),this.resources.add(new u({name:e.get("wiring"),type:m.WIRING,resource:n},{contextPath:this.contextPath})).resource.setContent(e.wiring.toJSON())},addResourceReference:function(e){e.get("type")===f.IMAGE&&/^repo:/.test(e.get("url"))&&this.resources.add({name:e.get("id"),type:e.get("type"),resource:{resourceReference:{uri:e.get("url").replace(/^repo:/,"")}}})},updateResourceReference:function(e){this.removeResourceReference(e),this.addResourceReference(e)},removeResourceReference:function(e){e.get("type")===f.IMAGE&&this.resources.remove(e.get("id"))},updateResourceCollection:function(){this.resources.set(this.get("resources"),{merge:!0,remove:!0,add:!0})},updateFoundationCollection:function(){var e=this;this.foundations.set(this.get("foundations"),{merge:!0,remove:!0,add:!0}),this.foundations.forEach(function(o){var t,s=e.resources.get(o.get("components")),i=e.resources.get(o.get("layout")),c=e.resources.get(o.get("wiring")),u=new l;if(c&&c.resource&&c.resource.content&&D.isArray(c.resource.content)&&(t=D.clone(c.resource.content)),s&&s.resource&&s.resource.content&&D.isArray(s.resource.content)){n(s.resource.content,e.resources.reduce(function(e,o){return e[o.id]=o.resource.get("uri"),e},{}));var h,p=s.resource.content,m=[],g=D.reject(p,function(e){return e.type===f.FILTER_GROUP?(h=e,!0):e.type===f.INPUT_CONTROL&&(m.push(e),!0)});h&&m.length&&(m=D.sortBy(m,"position"),p=g.concat(h,m)),D.forEach(p,function(t){u.add(d(t,{resource:e.resources.get(t.resource),collection:o.components,dashboardId:e.dashboardId||e.cid}))}),i&&i.resource&&u.setPositionFromHtml(i.resource.content),o.components.set(u.models,{merge:!0,remove:!0,add:!0})}t&&(o.wiring.set(D.map(r(t,o),function(e){return new a(D.omit(e,"consumers"),{component:o.components.get(e.component),consumers:e.consumers})})),D.each(t,function(e){o.wiring.get(e.producer).consumers.set(e.consumers)}))})},clone:function(e){var o=new this.constructor({},{dashboardId:e});return o.applyJsonState(this.toJSON(!0)),o},applyJsonState:function(e){var o={};D.each(e.resources,function(e){"file"in e.resource&&(o[e.name]=e.resource.file.content,delete e.resource.file.content)}),this.set(e),D.each(e.resources,function(e){e.name in o&&(e.resource.file.content=o[e.name])}),this.updateResourceCollection(),this.resources.forEach(function(e){e.get("name")in o&&e.resource.set("content",o[e.get("name")])}),this.updateFoundationCollection()}})});