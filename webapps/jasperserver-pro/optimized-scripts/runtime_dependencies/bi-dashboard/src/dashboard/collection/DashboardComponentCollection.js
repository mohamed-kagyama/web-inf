/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","jquery","../dashboardSettings","../model/component/DashletModel","../enum/dashboardComponentTypes","../factory/dashboardComponentModelFactory","runtime_dependencies/js-sdk/src/common/logging/logger"],function(e,t,n){function a(e){if(e.isVisualization()&&e.get("type")!==u.WEB_PAGE_VIEW&&e.get("type")!==u.IMAGE){var t=e.get("resource"),n=this.where({ownerResourceId:t}),a=this.where({resource:t,type:e.get("type")});s.each(n,function(e){a.length||this.remove(e)},this)}}function r(){this.find(function(e){return e.isValueDeferred&&e.isValueDeferred()})||this.trigger("parametersState:operationFinished",this)}var i=e("backbone"),s=e("underscore"),o=e("jquery"),c=e("../dashboardSettings"),h=e("../model/component/DashletModel"),u=e("../enum/dashboardComponentTypes"),d=e("../factory/dashboardComponentModelFactory"),m=e("runtime_dependencies/js-sdk/src/common/logging/logger"),l=m.register("DashboardComponentCollection");n.exports=i.Collection.extend({model:d,initialize:function(){this.enableParametersStateStack(),this.on("remove",s.bind(a,this)),this.on("change:maximized",function(e){e.get("maximized")&&this.each(function(t){t!==e&&t.has("maximized")&&t.set("maximized",!1)})}),this.on("parametersState:deferredValueApplied",r,this),this.on("parametersState:operationFinished",function(){this.enableParametersStateStack(),this.trigger("parametersState:canUndo",this.canPopParametersState(-1)),this.trigger("parametersState:canRedo",this.canPopParametersState(1))},this)},pushParametersState:function(){this.isEnabledParametersStateStack()&&(this.invoke("pushParametersState"),this.trigger("parametersState:canUndo",!0),this.trigger("parametersState:canRedo",!1))},popParametersState:function(e){this.disableParametersStateStack(),this.invoke("popParametersState",e),r.call(this)},resetParametersState:function(){this.disableParametersStateStack(),this.invoke("resetParametersState"),r.call(this)},setCurrentParametersStateAsDefault:function(){this.invoke("setCurrentParametersStateAsDefault")},canPopParametersState:function(e){return this.reduce(function(t,n){return t||n.paramsModel.canPopState(e)},!1)},disableParametersStateStack:function(){this._enablePush=!1},enableParametersStateStack:function(){this._enablePush=!0},isEnabledParametersStateStack:function(){return this._enablePush},getValueProducers:function(){return this.filter(function(e){return e.isValueProducer()})},setMuteFilterPanels:function(e){this.each(function(t){t.get("type")==u.FILTER_GROUP&&(t.isMute=e)})},setEnabledCascading:function(e){this.each(function(t){t.get("type")==u.INPUT_CONTROL&&(t.isCascadeEnabled=e)})},getSelectedComponent:function(){return this.findWhere({selected:!0})},selectComponent:function(e){var t=this.get(e);this.forEach(function(e){e!==t&&e.set("selected",!1)}),t&&t.set("selected",!0)},setPositionFromHtml:function(e){try{var t=o("<div></div>").html(e),n=s.map(t.find("["+c.COMPONENT_ID_ATTRIBUTE+"]"),h.htmlToPositionObject);this.forEach(function(e){var t=s.findWhere(n,{id:e.id});t&&e.set(t,{silent:!0})})}catch(e){l.error(e)}},toHTML:function(e){var t="";return this.forEach(function(n){n instanceof h&&(t+=n.toHTML(e))}),t},getComponents:function(){return this.reduce(function(e,t){return t.toDashboardComponentObject&&t.get("type")!==u.DASHBOARD_PROPERTIES&&e.push(t.toDashboardComponentObject()),e},[])},getDashboardPropertiesComponent:function(){return this.findWhere({type:u.DASHBOARD_PROPERTIES})},isOutOfCanvasBounds:function(e){return e.x<0||e.y<0||e.x+e.width>c.GRID_WIDTH||e.y+e.height>c.GRID_HEIGHT},overlaps:function(e,t){return this.some(function(n){return n instanceof h&&(t!==n.get("id")&&(!n.get("floating")&&!(n.get("x")>=e.x+e.width||n.get("x")+n.get("width")<=e.x||n.get("y")>=e.y+e.height||n.get("y")+n.get("height")<=e.y)))})}})});