/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","request","runtime_dependencies/js-sdk/src/common/util/browserDetection","runtime_dependencies/js-sdk/src/common/component/dialog/LoadingDialog","runtime_dependencies/js-sdk/src/common/component/notification/Notification","./view/viewer/ViewerToolbarView","./view/base/DashboardHeaderView","./view/base/DashboardMessageView","./model/DashboardModel","../bi/dashboard/Dashboard","./util/DashboardExportUtils","./dashboardSettings","bundle!DashboardBundle","text!./template/viewerDashboardContainerTemplate.htm","runtime_dependencies/bi-adhoc/src/adhoc/api/chart/HyperlinkChartHelper","runtime_dependencies/js-sdk/src/common/util/domUtil","text!./template/toggleMenuTemplate.htm"],function(e,t,o){function i(){r.filter(this.$(".dashboardVisualization"),function(e){return!(n(e).hasClass("rendered")&&0===n(e).find(".fusionRendering").length)}).length?setTimeout(r.bind(i,this),1e3):(this.toolbar&&this.toolbar.setEnabled({export:!0}),this.previewToolbar&&this.previewToolbar.setEnabled({export:!0}),this.toolbar||this._referenceSize&&g.prepareForExport(this),n(document.body).addClass("rendered"))}var n=e("jquery"),r=e("underscore"),a=e("backbone"),s=e("request"),d=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),h=e("runtime_dependencies/js-sdk/src/common/component/dialog/LoadingDialog"),l=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),c=e("./view/viewer/ViewerToolbarView"),u=e("./view/base/DashboardHeaderView"),p=e("./view/base/DashboardMessageView"),b=e("./model/DashboardModel"),m=e("../bi/dashboard/Dashboard"),g=e("./util/DashboardExportUtils"),f=e("./dashboardSettings"),w=e("bundle!DashboardBundle"),v=e("text!./template/viewerDashboardContainerTemplate.htm"),x=e("runtime_dependencies/bi-adhoc/src/adhoc/api/chart/HyperlinkChartHelper"),y=e("runtime_dependencies/js-sdk/src/common/util/domUtil"),D=e("text!./template/toggleMenuTemplate.htm"),_=x.prototype.getHyperlink,E=function(e){return{getHyperlink:function(){return{parameters:e.apply(this,arguments),type:"AdHocExecution"}}}}(_);r.extend(x.prototype,E);var T=a.View.extend({constructor:function(e){if(e||(e={}),!e.el||!n(e.el)[0]||!n(e.el)[0].tagName)throw new Error("Container for Dashboard is not specified");a.View.apply(this,arguments)},initialize:function(e){this.params=e.params||{},e.referenceWidth&&e.referenceHeight&&(this._referenceSize={width:e.referenceWidth,height:e.referenceHeight}),this.contextPath=e.contextPath||f.CONTEXT_PATH,(r.isUndefined(e.toolbar)||!0===e.toolbar)&&(this.toolbar=new c),this.toolbar&&(this.listenTo(this.toolbar,"button:undo",this.undoParameters,this),this.listenTo(this.toolbar,"button:undoAll",this.undoAllParameters,this),this.listenTo(this.toolbar,"button:redo",this.redoParameters,this),this.listenTo(this.toolbar,"button:export",this.exportDashboard,this),this.listenTo(this.toolbar,"button:back",this.goBack,this)),this.message=new p,this._initAdditionalVisualComponents(),this.header=new u({model:this.model}),this.header.setTextButton(w["dashboard.toggle.menu.viewingText"]),this.header.$(".pageHeader-title-controls.pageHeader-title-controlsRight").addClass("hidden"),this.render(),this.$el.parents("#dashboard").append(r.template(D,{i18n:w})),n(window).on(window.onpagehide||null===window.onpagehide?"pagehide":"unload",r.bind(this._stopHistory,this)),this._startHistory(),this._initPreventTextSelection("#banner","#frame"),this.initEventHandlers(),y.disableBackForwordCache()},render:function(){return this.$el.empty(),this.toolbar&&(this.$el.html(this.header.$el),this.header.$(".pageHeader-title-controls:not(.pageHeader-title-controlsRight)").append(this.toolbar.render().el),this.toolbar.$el.removeClass("column decorated primary")),this.$el.append(v),this.$(".dashboardContainer").append(this.message.$el),this.showInitialMessage(),this},showInitialMessage:function(){this.message.show(w["dashboard.canvas.error.not.found"])},initEventHandlers:function(){var e=this,t=this.header.$el.find(".jr-mButton.jr-mButtonDropdown.jr-mButtonMedium.jr"),o=n(".menu.toggleView"),i=n(".menu.toggleView").find("#menuList > .leaf > .wrap"),r=["content","leaf","toggle","toggleView"],a=["jr-mButton","dashboardToolbar","jr-mButton-label"];t.on("click",function(){e.showMenuList()}).on("mouseleave",function(t){e.hideMenuList(t,r)}),i.on("click",function(t){t.target.classList.contains("down")||(n(".menu.toggleView").addClass("hidden"),e.openInDesignerMode())}),o.on("mouseleave",function(t){e.hideMenuList(t,a)})},showMenuList:function(){var e=n(".menu.toggleView"),t=n(".menu.toggleView p");e.hasClass("hidden")&&e.removeClass("hidden"),t.last().addClass("down")},hideMenuList:function(e,t){var o=n(e.relatedTarget);t.some(function(e){return o.hasClass(e)})||n(".menu.toggleView").addClass("hidden")},_initAdditionalVisualComponents:function(){this.exportLoading=new h({cancellable:!0}),this.initialLoading=new h({cancellable:!0}),this.exportLoading.on("button:cancel",this.cancelExportDashboard,this),this.initialLoading.on("button:cancel",function(){window.history.back()},this)},_handleDashboardError:function(e){var t=w["dashboard.canvas.error."+e.errorCode]||w[e.xmlHttpRequest&&404===e.xmlHttpRequest.status?"dashboard.canvas.error.not.found":"dashboard.canvas.error.unexpected.error"];this.message.show(t),this.initialLoading&&this.initialLoading.close()},_startHistory:function(){this.history=new a.History,this.history.route(/.*/,r.bind(this._onLocationHashChange,this)),this.history.start()},_stopHistory:function(){this.history&&this.history.stop(),this.toolbar&&(this.toolbar.backBtn&&this.toolbar.backBtn.visible||this.dashboard&&this.dashboard.destroy(),this.toolbar.backBtn={visible:!1})},_initDashboard:function(e,t){var o=this;this.message.hide(),this.model&&this.stopListening(this.model,"change:label");var n=b.prototype.initialize;b.prototype.initialize=function(){return o.model=this,n.apply(this,arguments)},this.dashboard=new m({server:this.contextPath,container:this.$(".dashboardContainer > .content > .body"),resource:e,params:t||this.params,report:{chart:{animation:!this._referenceSize}}}).events({canUndo:function(e){o.toolbar&&o.toolbar.setEnabled({undo:e,undoAll:e})},canRedo:function(e){o.toolbar&&o.toolbar.setEnabled({redo:e})},__canvasReady__:function(){o.initialLoading.close()}}),b.prototype.initialize=n,o.toolbar&&(this.listenTo(this.model,"change:label",function(){o.header.setTitle(o.model.get("label"))}),this.listenTo(o.toolbar,"button:filterPopup",function(){this.model.currentFoundation.trigger("toggle:filterDialog")}),this.listenTo(this.model.currentFoundation,"close:filterDialog",function(){o.toolbar.closeFilterPopupDialog()})),this.initialLoading.open(),this.dashboard.run().done(function(){if(o.header.setTitle(o.model.get("label")),o._showopenInDesignerButton(o.model.get("permissionMask"))&&o.header.$el.find(".pageHeader-title-controls.pageHeader-title-controlsRight").removeClass("hidden"),o.toolbar){var e=o.model.currentFoundation.components.getDashboardPropertiesComponent(),t=o.model.currentFoundation.wiring.hasUserWiring()&&o.model.currentFoundation.components.getValueProducers().length;o.toolbar.setVisibility({export:e.get("showExportButton"),filterPopup:e.get("dashletFilterShowPopup"),undo:t,undoAll:t,redo:t})}else o._referenceSize&&g.applyReferenceSize(o,o._referenceSize);i.call(o)}).fail(r.bind(this._handleDashboardError,this))},_initPreventTextSelection:function(){var e=Array.prototype.slice.call(arguments,0).join(",");(d.isIE8()||d.isIE9())&&n(e).on("selectstart",function(e){var t=e.target.tagName;if("INPUT"!=t&&"TEXTAREA"!=t)return!1})},_onLocationHashChange:function(e){if(e){var t=r.extend({},this.params,T.parseDashboardParamsFromString(e)),o=e.split("&")[0];try{o=decodeURIComponent(o)}catch(e){o=void 0}o&&(0!==o.indexOf("/")&&(o="/"+o),this.dashboard?this.model.get("uri")!==o?this.dashboard.destroy().always(r.bind(this._initDashboard,this,o,t)):this.dashboard.params(t).run().fail(r.bind(this._handleDashboardError,this)):this._initDashboard(o,t))}},_showopenInDesignerButton:function(e){return 2!==e&&18!==e},remove:function(){n(window).off("pagehide unload"),this.history&&this.history.stop(),this.dashboard&&this.dashboard.destroy(),this.message&&this.message.remove(),this.toolbar&&this.toolbar.remove(),this.header&&this.header.remove(),a.View.prototype.remove.apply(this,arguments)},goBack:function(){this.toolbar.backBtn={visible:!0},window.history.back()},openInDesignerMode:function(){var e=this.model&&r.extend({},this.model.attributes);e&&(window.location.href="designer.html#"+encodeURIComponent(e.uri))},undoParameters:function(){this.dashboard.undoParams()},undoAllParameters:function(){this.dashboard.undoAllParams()},redoParameters:function(){this.dashboard.redoParams()},exportDashboard:function(e){var t=this,o=new n.Deferred;this.exportLoading.open(),g.requestDashboardExport(this,e).done(function(e){t.currentExportId=e.id,g.wait.call(t,t.currentExportId,o).done(function(e){t.exportLoading.close(),"ready"===e.status?t.currentExportId&&t._download(e.href):l.show({message:w["dashboard.export.unexpected.error"],delay:5e3})})}).fail(function(){t.exportLoading.close(),l.show({message:w["dashboard.export.renderer.fail"],delay:5e3})})},cancelExportDashboard:function(){var e=this;return this.currentExportId?s({url:this.contextPath+"/rest_v2/dashboardExecutions/"+this.currentExportId,method:"DELETE"}).done(function(){e.currentExportId=void 0}).fail(function(){e.currentExportId=void 0}):(new n.Deferred).resolve()},_checkReadyness:i,_download:function(e){window.location.href=e}},{parseDashboardParamsFromString:function(e){var t,o=e,i=o.split("&");t={};for(var n=0;n<i.length;n++){var a=decodeURIComponent(i[n].split("=")[0]),s=decodeURIComponent(i[n].split("=")[1]);t.hasOwnProperty(a)?t[a].push(s):t[a]=[r.isUndefined(s)?"":s]}return t},readSpecifiedDashboardParameters:function(){var e={};return window.dashboardParams?e=JSON.parse(window.dashboardParams):window.location.search&&(e=T.parseDashboardParamsFromString(window.location.search.toString().substring(1))),e}});o.exports=T});