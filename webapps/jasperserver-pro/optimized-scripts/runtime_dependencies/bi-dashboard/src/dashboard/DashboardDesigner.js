/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","./view/designer/SidebarView","./DashboardViewer","./view/base/DashboardHeaderView","./view/designer/DesignerCanvasView","./view/designer/DesignerToolbarView","./view/base/CanvasView","./model/DashboardModel","./collection/DashboardStateCollection","./layout/GridLayoutStrategy","./dashboardMessageBus","./enum/dashboardMessageBusEvents","./factory/sandboxFactory","text!./template/welcomeTextTemplate.htm","./dashboardSettings","bundle!DashboardBundle","text!./template/toggleMenuTemplate.htm"],function(e,t,i){var s=e("jquery"),o=e("underscore"),a=e("./view/designer/SidebarView"),n=e("./DashboardViewer"),r=e("./view/base/DashboardHeaderView"),d=e("./view/designer/DesignerCanvasView"),h=e("./view/designer/DesignerToolbarView"),l=e("./view/base/CanvasView"),u=e("./model/DashboardModel"),g=e("./collection/DashboardStateCollection"),c=e("./layout/GridLayoutStrategy"),m=e("./dashboardMessageBus"),v=e("./enum/dashboardMessageBusEvents"),b=e("./factory/sandboxFactory"),p=e("text!./template/welcomeTextTemplate.htm"),w=e("./dashboardSettings"),f=e("bundle!DashboardBundle"),C=e("text!./template/toggleMenuTemplate.htm");i.exports=n.extend({initialize:function(e){o.bindAll(this,"_onPageLeave","_onSessionExpired","_onUnload"),s("#frame").off("touchend mouseup",".minimize"),this.contextPath=e.contextPath||w.CONTEXT_PATH,this.model=new u({},{isDesigner:!0,contextPath:this.contextPath}),this.dashboardId=this._generateDashboardId(),b.get(this.dashboardId).set("dashboardModel",this.model),this.state=new g([],{model:this.model}),this.strategy=new c(this.model),this.header=new r({model:this.model}),this.header.setTextButton(f["dashboard.toggle.menu.editingText"]),this.sidebar=new a({model:this.model,strategy:this.strategy,dashboardId:this.dashboardId}),this.designerCanvas=new d({model:this.model,strategy:this.strategy,state:this.state,dashboardId:this.dashboardId}),this.toolbar=new h({model:this.model,state:this.state,dashboardId:this.dashboardId}),this.canvas=new l({model:this.model,dashboardId:this.dashboardId}),this.$el.parents("#dashboard").append(o.template(C,{i18n:f})),this._initAdditionalVisualComponents(),this.canvas.stopListening(),this.canvas.$el.hide(),this.canvas.model=void 0,this.listenTo(this.toolbar,"preview:on",o.bind(function(){this.enterPreviewMode()},this)),this.listenTo(this.toolbar,"preview:off",o.bind(function(){this.exitPreviewMode()},this)),this.listenTo(this.toolbar,"grid:on",o.bind(function(){this.showLayoutGrid()},this)),this.listenTo(this.toolbar,"grid:off",o.bind(function(){this.hideLayoutGrid()},this)),this.listenTo(this.toolbar,"dashboard:save",this._onDashboardSave),this.listenTo(this.toolbar,"button:filterPopup",o.bind(function(){this.toggleFilterPopup()},this)),this.listenTo(this.toolbar,"button:undo",this.undoParameters,this),this.listenTo(this.toolbar,"button:undoAll",this.undoAllParameters,this),this.listenTo(this.toolbar,"button:redo",this.redoParameters,this),this.listenTo(this.model,"error:all",this._onAllModelErrors),this.listenTo(this.model,"propertiesAvailable",o.bind(this._onDashboardPropertiesAvailable,this)),this.listenTo(this.sidebar,"open",o.bind(this._onSidebarToggle,this,!1)),this.listenTo(this.sidebar,"close",o.bind(this._onSidebarToggle,this,!0)),this.listenTo(this.sidebar,"resize",o.bind(this._onSidebarResize,this)),this.listenTo(this.sidebar,"resizeStop",o.bind(this._resizeComponents,this)),this.listenTo(this.designerCanvas.model.currentFoundation,"open:filterDialog",this.openDesignerFilterDialog),this.listenTo(this.designerCanvas.model.currentFoundation,"close:filterDialog",this.closeFilterDialog),this.listenTo(m,v.SAVE_DASHBOARD_STATE,o.bind(this.state.saveState,this.state)),this.listenTo(m,v.SESSION_EXPIRED,this._onSessionExpired),this.listenTo(this.toolbar,"button:export",this.exportDashboard,this),this.render(),this.initEventHandlers(),this._startHistory(),this._initPreventTextSelection("#banner","#frame"),this._checkPreviewMode(),s(window).on(window.onpagehide||null===window.onpagehide?"pagehide":"unload",this._onUnload),s(window).on("beforeunload",this._onPageLeave),s(window).on(v.SESSION_EXPIRED,this._onSessionExpired)},showInitialMessage:function(){this.designerCanvas.message.show(o.template(p,{i18n:f}))},hideMessageBox:function(){this.designerCanvas.message.hide()},initEventHandlers:function(){var e=this,t=this.header.$el.find(".jr-mButton.jr-mButtonDropdown.jr-mButtonMedium.jr"),i=s(".menu.toggleView"),o=s(".menu.toggleView p.button"),a=["content","leaf","toggle","toggleView"],r=["jr-mButton","dashboardToolbar","jr-mButton-label"];t.on("click",function(){e.showMenuList()}).on("mouseleave",function(e){n.prototype.hideMenuList(e,a)}),o.on("click",function(t){t.target.classList.contains("down")||t.target.hasAttribute("disabled")||(s(".menu.toggleView").addClass("hidden"),e.toolbar.togglePreviewMode())}),t.attr("disabled","disabled"),s(".menu.toggleView p:last").attr("disabled","disabled"),i.on("mouseleave",function(e){n.prototype.hideMenuList(e,r)})},enterPreviewMode:function(){var e=this.model.currentFoundation.wiring.hasUserWiring()&&this.model.currentFoundation.components.getValueProducers().length;b.get(this.getDashboardId()).set("previewMode",!0),this.$el.removeClass("twoColumn").addClass("oneColumn"),this.header.setTextButton(f["dashboard.toggle.menu.viewingText"]),this.sidebar.$el.hide(),this.designerCanvas.filterDialog.close(),this.designerCanvas.hide(),this.canvas.$el.show(),this.canvas.model=this.model.clone(this.dashboardId),e&&(this.canvas.model.currentFoundation.components.on("parametersState:canUndo",o.bind(this.canUndo,this)),this.canvas.model.currentFoundation.components.on("parametersState:canRedo",o.bind(this.canRedo,this)),this.canRedo(!1),this.canUndo(!1)),this.toolbar.setVisibility({undo:e,redo:e,undoAll:e}),this.canvas.render(),this.canvas.applyCanvasSize(),this.canvas.applyCanvasColor(),this.toolbar.$el.detach().appendTo(this.header.$toolbarPlaceholder),this.designerCanvas.getRootElement().addClass("previewMode"),this.canvas.model.currentFoundation.startLoadingSequence(),this._checkReadyness(),this._modifyUri()},exitPreviewMode:function(){b.get(this.getDashboardId()).set("previewMode",!1),this.$el.removeClass("oneColumn").addClass("twoColumn"),this.header.setTextButton(f["dashboard.toggle.menu.editingText"]),this.designerCanvas.getRootElement().removeClass("previewMode"),this.model.currentFoundation.wiring.hasUserWiring()||this.toolbar.setVisibility({undo:!0,redo:!0,undoAll:!0}),this.canvas.$el.removeClass("previewMode"),this.canvas.$el.removeClass("maximizedDashlet"),this.history.navigate(this.history.getFragment().replace(/previewMode&/g,"")),this.canvas.filterDialog.close(),this.canvas.$el.hide(),this.canvas.disableAutoRefresh(),this.canvas.removeAllComponentViews(),this.toolbar.$el.detach().insertAfter(this.header.$el),this.sidebar.$el.show(),this.designerCanvas.show(),delete this.canvas.model,this._resizeComponents(),this.sidebar.accordion.fit()},showMenuList:function(){var e=s(".menu.toggleView"),t=s(".menu.toggleView p");e.hasClass("hidden")&&e.removeClass("hidden"),this.isPreviewMode()?(t.last().addClass("down"),t.first().removeClass("down")):(t.first().addClass("down"),t.last().removeClass("down"))},isPreviewMode:function(){return b.get(this.getDashboardId()).get("previewMode")},showLayoutGrid:function(){this.designerCanvas.getElement().find(".grid").show()},hideLayoutGrid:function(){this.designerCanvas.getElement().find(".grid").hide()},toggleFilterPopup:function(){this.isPreviewMode()?this.canvas.filterDialog.isVisible()?this.canvas.filterDialog.close():this.canvas.filterDialog.open():this.designerCanvas.filterDialog.isVisible()?this.designerCanvas.filterDialog.close():this.designerCanvas.filterDialog.open()},openDesignerFilterDialog:function(){this.designerCanvas.filterDialog.isVisible()||(this.designerCanvas.filterDialog.open(),this.toolbar.trigger("filterButtonStyle:open"))},closeFilterDialog:function(){this.isPreviewMode()?this.canvas.filterDialog.close():this.designerCanvas.filterDialog.close(),this.toolbar.trigger("filterButtonStyle:close")},canUndo:function(e){this.toolbar&&this.toolbar.setEnabled({undo:e,undoAll:e}),this.toolbar&&e?this.toolbar.$("#undo, #undoAll").removeAttr("disabled").removeClass("over disabledButton"):this.toolbar&&!e&&this.toolbar.$("#undo, #undoAll").attr("disabled","disabled").addClass("disabledButton").removeClass("over")},canRedo:function(e){this.toolbar&&this.toolbar.setEnabled({redo:e}),this.toolbar&&e?this.toolbar.$("#redo").removeAttr("disabled").removeClass("over disabledButton"):this.toolbar&&!e&&this.toolbar.$("#redo").attr("disabled","disabled").addClass("disabledButton").removeClass("over")},undoParameters:function(){this.isPreviewMode()?(this.canvas.model.currentFoundation.components.popParametersState(-1),this.canvas.model.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)):this.state.setPreviousState()},undoAllParameters:function(){this.isPreviewMode()?(this.canvas.model.currentFoundation.components.resetParametersState(),this.canvas.model.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)):this.state.setFirstState()},redoParameters:function(){this.isPreviewMode()?(this.canvas.model.currentFoundation.components.popParametersState(1),this.canvas.model.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)):this.state.setNextState()},_onPageLeave:function(e){if(!this.sessionExpired){if(this.downloading)return void(this.downloading=!1);if(!b.get(this.getDashboardId()).get("disablePageLeaveConfirmation"))return!this.model.isNew()&&this.state.hasPreviousState()||this.model.isNew()&&this.model.currentFoundation.hasVisualComponents()?((e||window.event).returnValue=f["dashboard.dialog.unsaved.changes"],f["dashboard.dialog.unsaved.changes"]):void 0}},_onDashboardPropertiesAvailable:function(e){this.toolbar.setVisibility({filterPopup:e.get("dashletFilterShowPopup")})},_generateDashboardId:function(){return this.model.cid},getDashboardId:function(){return this.dashboardId},_onDashboardSave:function(){this.state.init(),this._updateLocationHash()},_updateLocationHash:function(){if(this.model.has("uri")){var e=encodeURIComponent(this.model.get("uri"));this.isPreviewMode()?this.history.navigate("previewMode&"+e,{trigger:!1,replace:!1}):this.history.navigate(e,{trigger:!1,replace:!1})}},_loadModelByUri:function(e){var t=this;try{e=decodeURIComponent(e)}catch(t){e=void 0}e&&0!==e.indexOf("/")&&(e="/"+e),e!=this.model.get("uri")&&(this.model.resetToInitialCondition(),e?(this.hideMessageBox(),this.model.set({uri:e}),this.model.fetch().fail(function(){t.model.currentFoundation.startLoadingSequence()}).always(function(){t.state.init()})):(this.showInitialMessage(),this.model.currentFoundation.startLoadingSequence(),this.state.init()))},_onLocationHashChange:function(e){var e=e.replace(/previewMode&/g,"");!this.model.isNew()&&this.state.hasPreviousState()||this.model.isNew()&&this.model.currentFoundation.hasVisualComponents()?window.confirm(f["dashboard.dialog.unsaved.changes"])?this._loadModelByUri(e):this.history.navigate(this.model.get("uri"),{trigger:!1,replace:!0}):this._loadModelByUri(e)},_modifyUri:function(){this.history.getFragment()&&this.history.navigate("previewMode&"+this.history.getFragment().replace(/previewMode&/g,""))},_checkPreviewMode:function(){function e(){t.model.currentFoundation.hasVisualComponents()?t.enterPreviewMode():setTimeout(e,100)}var t=this;/previewMode&/.test(this.history.getFragment())&&(t.toolbar.togglePreviewMode(),e())},_onAllModelErrors:function(e,t,i){this.model.unset("uri");var s=f["dashboard.canvas.error."+t.errorCode]||f[404===i.status?"dashboard.canvas.error.not.found":"dashboard.canvas.error.unexpected.error"];this.designerCanvas.message.show(s)},_onSidebarToggle:function(e){var t=this.designerCanvas.getElement(),i=this.sidebar.$contentContainer[e?"outerWidth":"width"]()-(e?parseInt(t.css("marginLeft"))/2:0);this.designerCanvas.getRootElement().css({left:i}),this.toolbar.$el.css({left:i}),this._resizeComponents()},_onSidebarResize:function(e,t){var i=t.size.width;this.designerCanvas.getRootElement().css({left:i}),this.toolbar.$el.css({left:i})},_onSessionExpired:function(){this.sessionExpired=!0,window.location.reload()},_onUnload:function(){var e=o.pick(this,"sessionExpired");this.designerCanvas.remove(e)},_resizeComponents:function(){o.invoke(this.designerCanvas.componentViews,"resize")},_download:function(e){this.downloading=!0,n.prototype._download.call(this,e)},render:function(){return this.$el.empty(),this.$el.html(this.header.$el),this.designerCanvas.render(),this.designerCanvas.getRootElement().prepend(this.canvas.$el),this.toolbar.$el.insertAfter(this.header.$el),this.canvas.$el.addClass("column decorated primary"),this.$el.append(this.designerCanvas.getRootElement()),this.$el.append(this.sidebar.render().$el),this},remove:function(){this.toolbar.remove(),this.header.remove(),this.sidebar.remove(),this.canvas.remove(),this.strategy.remove(),this.designerCanvas.remove(),s(window).off(v.SESSION_EXPIRED,this._onSessionExpired),s(window).off("beforeunload",this._onPageLeave),s(window).off("pagehide unload"),n.prototype.remove.apply(this,arguments)}})});