/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","bundle!CommonBundle","runtime_dependencies/js-sdk/src/common/util/classUtil","./view/PropertiesDialogView","../../../factory/propertiesTitleFactory","runtime_dependencies/js-sdk/src/common/component/dialog/Dialog","../../../dashboardMessageBus","../../../enum/dashboardMessageBusEvents","../../../enum/dashboardComponentTypes"],function(t,e,o){var i=t("underscore"),n=t("bundle!CommonBundle"),a=t("runtime_dependencies/js-sdk/src/common/util/classUtil"),s=t("./view/PropertiesDialogView"),l=t("../../../factory/propertiesTitleFactory"),r=t("runtime_dependencies/js-sdk/src/common/component/dialog/Dialog"),d=t("../../../dashboardMessageBus"),c=t("../../../enum/dashboardMessageBusEvents"),g=t("../../../enum/dashboardComponentTypes"),p=r.extend({events:i.extend({"mousedown .header.mover, .subcontainer, .footer":"_onPropertiesDialogSelect"},r.prototype.events),open:function(){this.content.openTab("basic"),this.content.model.set(this.content.original.clone().attributes),this.content.originalState.set(this.content.original.clone().attributes),r.prototype.open.apply(this,arguments),this.content.model.validate()},_onPropertiesDialogSelect:function(){this.trigger("properties:dialog:select",this)}}),h=function(t){var e="dashboardLevelPropertiesDialog "+t.get("type")+"Dialog";return t.get("type")!==g.DASHBOARD_PROPERTIES&&(e+=" dashletLevelPropertiesDialog"),e};o.exports=a.extend({constructor:function(t){this.dialog=new p({model:t,additionalCssClasses:h(t),title:l(t),content:new s({model:t}),buttons:[{label:n["button.apply"],action:"apply",primary:!0},{label:n["button.ok"],action:"ok",primary:!1},{label:n["button.cancel"],action:"cancel",primary:!1}]}),this.initialize()},initialize:function(){this._initEvents(),this.dialogIsOpened=!1},onDialogApply:function(){var t=this;this.dialog.content.hyperlinkParametersSectionView&&this.dialog.content.hyperlinkParametersSectionView.isEditing?this.dialog.content.hyperlinkParametersSectionView.confirmAbort(function(){t.applyModel()}):this.applyModel()},onDialogOk:function(){var t=this;this.dialog.content.hyperlinkParametersSectionView&&this.dialog.content.hyperlinkParametersSectionView.isEditing?this.dialog.content.hyperlinkParametersSectionView.confirmAbort(function(){t.applyModel()&&(t.saveModel(),r.prototype.close.apply(t.dialog,arguments))}):this.applyModel()&&(this.saveModel(),r.prototype.close.apply(this.dialog,arguments))},onDialogCancel:function(){this.dialog.content.hyperlinkParametersSectionView&&this.dialog.content.hyperlinkParametersSectionView.resetState(),this.rollbackModel(),r.prototype.close.apply(this.dialog,arguments)},saveModel:function(){var t=this.dialog.content.originalState;i.isEqual(this.dialog.content.original.attributes,this.dialog.content.originalState.attributes)||(t.set(this.dialog.content.original.toJSON()),d.trigger(c.SAVE_DASHBOARD_STATE))},applyModel:function(){return!!this.dialog.content.model.isValid(!0)&&(this.dialog.content.original&&this.dialog.content.original.set(this.dialog.content.model.attributes),!0)},rollbackModel:function(t){var t=t||{},e=this.dialog.content.original,o=this.dialog.content.originalState,i=o.toJSON();t.silent?e.set(i,{silent:!0}):e.set(i)},toggleDialogStateProps:function(t){this[t]?this[t]=!1:this[t]=!0},_initEvents:function(){var t=this;this.dialog.on("open",function(){t.toggleDialogStateProps("dialogIsOpened")}),this.dialog.on("close",function(){t.toggleDialogStateProps("dialogIsOpened"),t.dialog.content.trigger("close")}),this.dialog.on("button:cancel",i.bind(this.onDialogCancel,this)),this.dialog.on("button:apply",i.bind(this.onDialogApply,this)),this.dialog.on("button:ok",i.bind(this.onDialogOk,this)),this.dialog.listenTo(this.dialog.content,"saveAndGoToFilterManager",function(){t.onDialogOk(),d.trigger(c.OPEN_FILTER_MANAGER)})},remove:function(){this.dialog.content.remove(),this.dialog.off("button:cancel"),this.dialog.off("button:apply"),this.dialog.off("button:ok"),this.dialog.off("open"),this.dialog.off("close"),this.dialog.remove()}})});