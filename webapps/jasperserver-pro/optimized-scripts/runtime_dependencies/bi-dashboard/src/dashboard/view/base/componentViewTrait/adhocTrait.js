/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/bi-report/src/bi/report/Report","runtime_dependencies/bi-adhoc/src/bi/adhoc/AdHocView","runtime_dependencies/js-sdk/src/common/component/menu/HoverMenu","runtime_dependencies/js-sdk/src/common/component/notification/Notification","runtime_dependencies/js-sdk/src/common/component/dialog/LoadingDialog","../../../enum/dashboardWiringStandardIds","../../../dashboardSettings","text!../../../template/menuContainerTemplate.htm","text!../../../template/menuOptionTemplate.htm","bundle!jasperserver_messages","../../../hyperlink/defaultLinkOptions","../../../factory/sandboxFactory","bundle!DashboardBundle"],function(e,t,n){function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},o.apply(this,arguments)}function i(e){return e.$("> .dashletContent > .content > .jr-mAdhocViewer > .jr-mAdhoc-visualization > .jr-mVisualization-canvas > .jr-mChartContainer").length>0}function r(e){e.name===j.REFRESH_SLOT?(this.paramsModel.paramsChanged&&(this.paramsModel.paramsChanged=!1,this.component.params(s(this))),this.refresh()):e.name===j.APPLY_SLOT&&this.paramsModel.paramsChanged&&(this.paramsModel.paramsChanged=!1,this.isAdhocRan=!1,this.component.params(s(this)),this.refresh())}function s(e){var t=f.reduce(e.model.get("parameters"),function(e,t){return t.parametrizeProperty&&e.push(t.id),e},[]);return f.omit(e.paramsModel.attributes,t)}function a(e,t){return new g({resource:e,params:t,server:A.CONTEXT_PATH})}function p(e){if(e){var t={events:{}},n=this;for(var o in O.events)t.events.hasOwnProperty(o)||(t.events[o]=function(e,t){var o="jr_hyperlink_interception"===e.eventType?"click":e.type.toLowerCase();O.events[o]&&O.events[o].call(n.component,e,t,n)});return t}}function c(e,t){return new v({resource:e,container:this.$content,params:t,autoresize:!0,server:A.CONTEXT_PATH})}function h(e){this.hideMessage(),d.call(this),u.call(this),!1!==e&&this.trigger("componentRendered",self)}function d(){var e,t=!1;void 0!==this.model.get("showVizSelectorIcon")&&this.$el&&this.$el.find(".jr-mAdhoc-visualization-launcher").length&&(t=!0,e=this.$("> .dashletContent > .content"),this.model.get("showVizSelectorIcon")?e.removeClass("hideVizLauncher"):e.addClass("hideVizLauncher")),this.model.set("showVizSelector",t)}function l(e){if(e.errorCode){var t=this.$content.find(".jr-mMessageError");t.length?t.parent().remove():this.$content.empty(),e.errorCode="adhoc."+e.errorCode,this.showMessage(e),this.trigger("componentRendered",this),this.ready.resolve()}}function m(e,t,n,o,i){e.reportComponent.export(t).done(function(e){window.open(e.href)}).fail(function(){n.show({message:o["dashboard.dashlet.error.report.export.failed"]})}).always(function(){i.close(),i.remove()})}function u(){this.$title=this.$(".jr-jAdhocVisualizationTitle"),this.$titleText=this.$(".jr-jAdhocVisualizationTitleText"),this.$title&&this.$titleText&&(this.$titleText.length>0&&this.$titleText.css({height:"auto"}),this.$title.length>0&&this.$title.css({height:this.$titleText.height()}))}var f=e("underscore"),x=e("jquery"),g=e("runtime_dependencies/bi-report/src/bi/report/Report"),v=e("runtime_dependencies/bi-adhoc/src/bi/adhoc/AdHocView"),b=e("runtime_dependencies/js-sdk/src/common/component/menu/HoverMenu"),w=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),C=e("runtime_dependencies/js-sdk/src/common/component/dialog/LoadingDialog"),j=e("../../../enum/dashboardWiringStandardIds"),A=e("../../../dashboardSettings"),y=e("text!../../../template/menuContainerTemplate.htm"),_=e("text!../../../template/menuOptionTemplate.htm"),T=e("bundle!jasperserver_messages"),O=e("../../../hyperlink/defaultLinkOptions"),R=e("../../../factory/sandboxFactory"),k=e("bundle!DashboardBundle"),$=o({},T,k),z=[{label:$["jasper.report.view.hint.export.pdf"],action:"pdf",params:{outputFormat:"pdf"}},{label:$["jasper.report.view.hint.export.excel"],action:"excel",params:{outputFormat:"xls"}},{label:$["jasper.report.view.hint.export.excel.nopag"],action:"excel.nopag",params:{outputFormat:"xls",ignorePagination:!0}},{label:$["jasper.report.view.hint.export.rtf"],action:"rtf",params:{outputFormat:"rtf"}},{label:$["jasper.report.view.hint.export.csv"],action:"csv",params:{outputFormat:"csv"}},{label:$["jasper.report.view.hint.export.odt"],action:"odt",params:{outputFormat:"odt"}},{label:$["jasper.report.view.hint.export.ods"],action:"ods",params:{outputFormat:"ods"}},{label:$["jasper.report.view.hint.export.docx"],action:"docx",params:{outputFormat:"docx"}},{label:$["jasper.report.view.hint.export.xlsx"],action:"xlsx",params:{outputFormat:"xlsx"}},{label:$["jasper.report.view.hint.export.xlsx.nopag"],action:"xlsx.nopag",params:{outputFormat:"xlsx",ignorePagination:!0}},{label:$["jasper.report.view.hint.export.pptx"],action:"pptx",params:{outputFormat:"pptx"}}];n.exports={_onViewInitialize:function(){this.$el.addClass("dashboardVisualization"),this.listenTo(this.model,"signal",f.bind(r,this))},exportAs:function(e){var t,n,o=this,i=new C({cancellable:!1});i.open(),this.reportComponent=a.call(this,this.createReportUri,this.component.params()),this.reportComponent.run().then(function(){t=o.component.canvas()&&o.component.canvas().type,t?(n=o.reportComponent.data().components[0],n.chartType=t,o.reportComponent.updateComponent(n).done(function(){m(o,e,w,$,i)})):m(o,e,w,$,i)})},updateAdhocLinkOptions:function(){this.component&&this.component.linkOptions(p.call(this,this.component)||{})},_initComponent:function(){var e=this;if(f.bindAll(this,"updateAdhocLinkOptions"),this.dashboardId){R.get(this.dashboardId).on("linkOptions",this.updateAdhocLinkOptions())}this.model.getReportResourceUri().done(function(t,n,o){o?(e._broken=!0,l.call(e,o)):(e.createReportUri=t,n=f.isString(n)?n:e.model.resource.resource.attributes.uri,e.component=c.call(e,n,{}),e.updateAdhocLinkOptions())})},_removeComponent:function(e){var t=!!e&&e.sessionExpired;if(!t&&this.isAdhocRan&&this.component.destroy(),!t&&this.reportComponent&&this.reportComponent.destroy(),this.component=null,this.reportComponent=null,this.isAdhocRan=!1,this.exportMenu&&this.exportMenu.remove(),this.dashboardId){R.get(this.dashboardId).off("linkOptions",this.updateAdhocLinkOptions)}},_renderComponent:function(){if(this.toolbar){var e=this;this.exportMenu=new b(z,this.toolbar.getOptionView("export").$el,null,{menuContainerTemplate:y,menuOptionTemplate:_}),f.each(z,function(t){e.listenTo(e.exportMenu,"option:"+t.action,function(){e.exportMenu.hide(),e.exportAs(t.params)})})}},_resizeComponent:function(){this.component&&this.isAdhocRan&&this.component.resize()},notify:function(e){var t=f.reduce(this.model.get("outputParameters"),function(t,n){var o=e[n.id];return o&&(t||(t={}),t[n.id]=f.isArray(o)?o:[o]),t},!1);t&&(this.model.notify(t),this.model.collection.getDashboardPropertiesComponent().applyParameters())},refresh:function(){this.toolbar&&this.toolbar.getOptionView("export").disable();var e=this,t=new x.Deferred;return this.cancel().always(function(){e.isAdhocRan?e.ready.done(function(){e.isAdhocRunning=!0,e.component.refresh().fail(t.reject).done(function(){h.call(e,!1),t.resolve()})}):(e.isAdhocRunning=!0,e.component?e.component.run().fail(t.reject).done(function(){e.isAdhocRan=!0,h.call(e),t.resolve()}):(e._broken||e.hideMessage(),t.resolve()))}),t.fail(f.bind(l,this)).always(f.bind(this._onAdhocRunFinished,this)),t},cancel:function(){return this.isAdhocRunning&&this.component?this.component.cancel():(new x.Deferred).resolve()},_onComponentRendered:function(){this.model.set("isAdhocChart",i(this))},_onAdhocRunFinished:function(){this.isAdhocRunning=!1,this.$el.addClass("rendered"),this.isAdhocRan&&this.toolbar&&this.toolbar.getOptionView("export").enable()}}});