/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","../../model/parameters/ParameterParser","text!../../template/parameterMenuOptionTemplate.htm","bundle!DashboardBundle","../../enum/dashboardWiringStandardIds","runtime_dependencies/js-sdk/src/common/component/menu/AttachableMenu"],function(e,t,o){function n(e,t,o){return r.map(e,function(e){if(e.component){var n=t.get(e.component);e.consumer=o.id+":"+e.substitution,e.consumerApply=o.id+":"+h.APPLY_SLOT,n.getParent()&&(e.label=s(n.get("name")),n=n.getParent()),e.componentLabel=s(d["dashboard.context.menu.option.from"].replace("{0}",n.get("name")))}else e.componentLabel="";return e})}function s(e){return e.length>60&&(e=e.substring(e,57)+"..."),e}function i(e){var t=m.dashboardModel.currentFoundation.wiring,o=t.get(e.producer);o&&!o.consumers.get(e.consumer)&&(o.consumers.add({consumer:e.consumer}),o.component.get("parentId")?t.get(o.component.get("parentId")+":"+h.REFRESH_SIGNAL).consumers.add({consumer:e.consumerApply}):o.consumers.add({consumer:e.consumerApply}))}var r=e("underscore"),a=e("jquery"),l=e("../../model/parameters/ParameterParser"),c=e("text!../../template/parameterMenuOptionTemplate.htm"),d=e("bundle!DashboardBundle"),h=e("../../enum/dashboardWiringStandardIds"),u=e("runtime_dependencies/js-sdk/src/common/component/menu/AttachableMenu"),m=u.extend({initialize:function(e,t){var o=this;e||(e={}),e.optionTemplate=c,u.prototype.initialize.call(this,e,t),r.bindAll(this,"onKey"),this.$attachTo.on("keydown",this.onKey),this.$el.on("scroll",function(){o.$attachTo.focus()}),this.on("all",function(e,t,n){if(0===e.indexOf("option")){var s=o.$attachTo.val(),r=n.get("newCursorPos");if(o.$attachTo.val(s.substring(0,n.get("begin"))+n.get("substitution")+s.substring(n.get("end"))),o.$attachTo[0].setSelectionRange)o.$attachTo[0].setSelectionRange(r,r);else if(o.$attachTo[0].createTextRange){var a=o.$attachTo[0].createTextRange();a.collapse(!0),a.moveEnd("character",r),a.moveStart("character",r),a.select()}n.has("consumer")&&n.has("producer")&&i(n.attributes),o.$attachTo.trigger("input",n.attributes)}}),this.on("mouseover",function(e){var t=this.collection.findWhere({over:!0});e.model!==t&&(t&&t.set({over:!1}),e.model.set({over:!0}))}),this.on("mouseout",function(e){e.model.set({over:!1})})},hide:function(){u.prototype.hide.apply(this,arguments),this.remove()},remove:function(){this.$attachTo.off("keydown",this.onKey),this.off("all"),u.prototype.remove.apply(this,arguments)},moveDown:function(){for(var e=!1,t=0;t<this.collection.models.length&&!e;t++)if(this.collection.models[t].get("over")&&(e=!0,t+1<this.collection.models.length&&(this.collection.models[t].set({over:!1}),this.collection.models[t+1].set({over:!0}),this.maxSize))){var o=this.options[0].$el.height();(t+1)*o>=this.el.scrollTop+this.maxSize*o&&(this.el.scrollTop+=o)}!e&&this.collection.models.length&&(this.collection.models[0].set({over:!0}),this.el.scrollTop=0)},moveUp:function(){for(var e=!1,t=0;t<this.collection.models.length&&!e;t++)if(this.collection.models[t].get("over")&&(e=!0,t-1>=0&&(this.collection.models[t].set({over:!1}),this.collection.models[t-1].set({over:!0}),this.maxSize))){var o=this.options[0].$el.height();(t-1)*o<=this.el.scrollTop&&(this.el.scrollTop=(t-1)*o)}!e&&this.collection.models.length&&(this.collection.models[this.collection.models.length-1].set({over:!0}),this.el.scrollTop=0)},onKey:function(e){27==e.keyCode?(this.hide(),e.stopPropagation()):40==e.keyCode?(this.moveDown(),e.preventDefault()):38==e.keyCode?(this.moveUp(),e.preventDefault()):13==e.keyCode&&(this._enter(),e.stopPropagation())},_enter:function(e){var t=r.find(this.options,function(e){return e.model.get("over")});t&&t.select(e)}},{open:function(e,t){m.close(),m.instance=new m(e,t,void 0,{menuOptionTemplate:c,maxSize:7}),m.instance.show()},close:function(){m.instance&&m.instance.hide()},useModel:function(e){m.dashboardModel=e},onInput:function(e,t){if(!t||t.hasOptions){var o,s=a(e.currentTarget).val(),i=+e.currentTarget.selectionStart,r=+e.currentTarget.selectionEnd,c=s.length-1;i>=0&&i===r&&(c=r),o=l.completionOptions(s,c,{wiring:m.dashboardModel.currentFoundation.wiring}),o.length?m.open(n(o,m.dashboardModel.currentFoundation.components,this.model),e.currentTarget):m.close()}else m.close()}});o.exports=m});