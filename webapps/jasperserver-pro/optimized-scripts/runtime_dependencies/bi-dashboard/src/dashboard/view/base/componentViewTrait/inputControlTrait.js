/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/bi-control/src/bi/control/collection/InputControlCollection","runtime_dependencies/bi-control/src/bi/control/view/InputControlCollectionView","../../../collection/ReportsParametersCollection","runtime_dependencies/bi-control/src/bi/control/model/InputControlPropertiesModel","text!../../../template/inputControlWrapperTemplate.htm","../../../dashboardSettings"],function(e,t,n){function o(e){return e.options?s.reduce(e.options,function(e,t){return t.selected&&e.push(t.value),e},[]):s.isArray(e.value)?e.value.length<=1?e.value[0]:[e.value]:e.value}function i(e,t){s.isUndefined(e.options)?e.value=t:(t=s.isArray(t)?t:[t],s.each(e.options,function(e){e.selected=s.contains(t,e.value)}))}function r(e,t){return!s.find(e,function(e){return-1===s.indexOf(t,e)})}var s=e("underscore"),l=e("jquery"),a=e("runtime_dependencies/bi-control/src/bi/control/collection/InputControlCollection"),d=e("runtime_dependencies/bi-control/src/bi/control/view/InputControlCollectionView"),c=e("../../../collection/ReportsParametersCollection"),u=e("runtime_dependencies/bi-control/src/bi/control/model/InputControlPropertiesModel"),h=e("text!../../../template/inputControlWrapperTemplate.htm"),p=e("../../../dashboardSettings"),m=c.instance;n.exports={template:s.template(h),_onViewInitialize:function(){this.$el.attr(p.COMPONENT_ID_ATTRIBUTE,this.model.get("id")),this.paramsModel=this.model.paramsModel,this.paramsModel.set(this.model.get("params"),{silent:!0}),s.bindAll(this,"notify"),this.listenTo(this.model,"change:value",function(){if(!this._skipUISync){var e=this.model.get("value"),t=this.inputControlCollection.at(0);t.changeState(t.state.isValue&&!s.isUndefined(e)?e[0]:e)}},this),this.listenTo(this.model,"signal",function(e){s.isUndefined(e.value)?this.paramsModel.unset(e.name,{trigger:!0}):(this.paramsModel.unset(e.name,{silent:!0}),this.paramsModel.set(e.name,e.value))}),this.listenTo(this.paramsModel,"change",function(e,t){this.model.isCascadeEnabled&&this._onInputParametersChange(e,t)})},_initComponent:function(){this.inputControlPropertiesModel=new u({resource:this.model.getOwnerUri(),server:p.CONTEXT_PATH}),this.inputControlCollection=new a([],{stateModel:this.inputControlPropertiesModel}),this.component=new d({collection:this.inputControlCollection,stateModel:this.inputControlPropertiesModel}),this.component.setContainer(this.$el),this.listenTo(this.inputControlCollection,"changeState change:state",this.notify);var e=this.model.getOwnerParameterName();this.inputControlCollection._parseState=function(t){if(t.id===e){var n=this.get(t.id);n&&(n.unset("state",{silent:!0}),n.set("state",t))}}},_onInputParametersChange:function(e,t){var n,o,i,l,a,d=this;if(this.model.set("params",this.paramsModel.attributes),t&&t.trigger&&this.model.collection.trigger("changedControlProperties",this.model),n=s.keys(e.changed),o=this.getDirectParameters(),r(n,o)){i=this.model.getOwnerParameterName(),l=this.paramsModel.toJSON(),a=this.model.getParent(),a&&this.model.getParent().trigger("beforeChildUpdate",this);var c={};c[i]=this.model.get("value"),l=s.extend({},l,c),this.inputControlCollection.updateState({params:l}).done(function(){d.model.applyDeferredValue()}).always(function(){d.model.getParent()&&d.model.getParent().trigger("afterChildUpdate",d)})}},_resizeComponent:function(){if(this.inputControlCollection.length>0){var e=this.inputControlCollection.at(0).id,t=this.component.controlViews[e]||{};t.resize&&t.resize()}},_renderComponent:function(){this.reset()},_removeComponent:function(){this.component.remove()},reset:function(){var e=this.inputControlCollection,t=this,n=this.model;m.getInputControlAsParameter(this.model.getOwnerUri(),this.model.getOwnerParameterName(),{full:this.model.get("fullCollectionRequired")}).done(function(r){var l=e.findWhere({id:r.id}),a=e.models&&e.models.length>0,d=l&&r.type===l.get("type");if(a&&d){var c=e.models[0];!(c.state.isValue=!r.state.options)&&c.state.options.models&&c.state.options.models.length!==r.state.options.length&&c.state.set("options",r.state.options);var u=o(r.state);c.changeState(u)}else{var h=s.extend({},r,{label:n.get("label")||r.label,slaveDependencies:[]});t.model.has("value")&&i(h.state,t.model.get("value")),e.reset([h])}t.ready.resolve()}).fail(function(){t.ready.resolve()})},getDirectParameters:function(){var e=[].concat(this.model.get("masterDependencies")),t=this.model.getOwnerUri(),n=this.model.collection.filter(function(e){return e.getOwnerUri&&!s.isUndefined(t)&&e.getOwnerUri()===t});return s.each(this.model.get("masterDependencies"),function(t){var o=s.find(n,function(e){return e.getOwnerParameterName()===t});o&&(e=s.difference(e,o.get("masterDependencies")))}),e},notify:function(){this._skipUISync=!0,this.model.acceptControlState(this.inputControlCollection.models[0].state),this._skipUISync=!1},addOverlay:function(){this.$overlay||(this.$overlay=l("<div></div>").addClass("overlay"),this.$el.prepend(this.$overlay))}}});