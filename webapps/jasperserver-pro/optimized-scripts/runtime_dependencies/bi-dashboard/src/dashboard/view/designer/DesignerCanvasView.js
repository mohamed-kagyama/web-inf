/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","bundle!CommonBundle","./DashboardOverlayDialog","../base/CanvasView","text!../../template/designerCanvasTemplate.htm","./AdhocDesignerIframeView","../base/DashboardMessageView","../../model/DashboardResourceModel","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","../../view/designer/ParameterMenu","../../factory/dashboardComponentModelFactory","../../view/designer/AddDashboardComponentDialogController","../../enum/dashboardComponentTypes","../../dashboardSettings","../../enum/dashboardResourceReferenceTypes","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","../../dashboardMessageBus","../../enum/dashboardMessageBusEvents","../../mapper/adHocToDashboardTypeMapper","runtime_dependencies/js-sdk/src/common/logging/logger","jquery-ui/ui/widgets/droppable"],function(e,o,t){function n(e){d.contains([v.ADHOC_VIEW,v.REPORT,v.CHART,v.TABLE,v.CROSSTAB],e.get("type"))&&void 0===e.get("showVizSelectorIcon")&&e.set("showVizSelectorIcon",T.DASHBOARD_SHOW_VISUALIZE_SELECTOR_ICON)}function i(e){function o(e){delete e.version,d.each(d.keys(e),function(t){d.isObject(e[t])&&o(e[t])})}e.unset("version"),o(e.attributes)}function r(e,o,t){if(!d.isObject(e))return e;var n=d.keys(e)[0],i=e[n];return n==t||s(i,o)||(i=e[t]=d.pick(i,"uri"),delete e[n]),i}function s(e,o){return 0===(e.uri||"").indexOf(o)}var a=e("jquery"),d=e("underscore"),l=e("bundle!CommonBundle"),h=e("./DashboardOverlayDialog"),c=e("../base/CanvasView"),p=e("text!../../template/designerCanvasTemplate.htm"),u=e("./AdhocDesignerIframeView"),g=e("../base/DashboardMessageView"),m=e("../../model/DashboardResourceModel"),f=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),C=e("../../view/designer/ParameterMenu"),y=e("../../factory/dashboardComponentModelFactory"),D=e("../../view/designer/AddDashboardComponentDialogController"),v=e("../../enum/dashboardComponentTypes"),T=e("../../dashboardSettings"),b=e("../../enum/dashboardResourceReferenceTypes"),_=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),w=e("../../dashboardMessageBus"),I=e("../../enum/dashboardMessageBusEvents"),R=e("../../mapper/adHocToDashboardTypeMapper"),A=e("runtime_dependencies/js-sdk/src/common/logging/logger");e("jquery-ui/ui/widgets/droppable");var O=A.register("DesignerCanvasView");t.exports=c.extend({isDesigner:!0,el:function(){return this.$rootEl=a(d.template(p,{i18n:l})),this.$rootEl.find(".dashboardCanvas")[0]},addComponentByTypeHandlerMap:function(){var e={};return e[v.WEB_PAGE_VIEW]=this._addWebPageView,e[v.FREE_TEXT]=this._addFreeText,e[v.IMAGE]=this._addImage,e[v.CHART]=this._addNewVisualization,e[v.CROSSTAB]=this._addNewVisualization,e[v.TABLE]=this._addNewVisualization,e[v.FILTER_GROUP]=this._addInputControl,e},initialize:function(e){d.bindAll(this,"_addWebPageView","_addFreeText","_addImage","_addNewVisualization","_addDefaultComponentType","_addInputControl"),c.prototype.initialize.apply(this,arguments),this.strategy=e.strategy,this.message=new g,this.$el.append(this.message.$el),this._initGrid(),this.strategy.initVisualHelpers(this.$el),this.$el.droppable({accept:".draggable",activeClass:"ui-dropping",tolerance:"pointer",drop:d.bind(this._onCanvasDrop,this)}),this.filterDialog.$el.droppable({accept:".draggable",activeClass:"ui-dropping",tolerance:"pointer"}),this.listenTo(this.model.currentFoundation,"addComponent",function(e){e.get("type")===v.DASHBOARD_PROPERTIES&&this.listenTo(e,"change:dashletFilterShowPopup",this.changeFloatingFilterGroup,this)},this),d.bindAll(this,"_onGlobalMousedown","_onGlobalKeydown"),a(document).on("mousedown",this._onGlobalMousedown),a(document).on("keydown",this._onGlobalKeydown),this.$overlay=new h({content:l["dialog.overlay.loading"]}),this.listenTo(this.model.currentFoundation,"addComponent",function(e){e.get("type")===v.DASHBOARD_PROPERTIES&&(this.listenTo(e,"change:useFixedSize change:fixedWidth change:fixedHeight",this.applyCanvasSize,this),this.listenTo(e,"change:canvasColor",this.applyCanvasColor,this))},this)},getElement:function(){return this.$el},getRootElement:function(){return this.$rootEl},show:function(){this.$el.css({top:"0px"})},hide:function(){this.$el.css({top:"-100000px"})},enableAutoRefresh:function(){},addComponentView:function(e){var o=c.prototype.addComponentView.call(this,e);return o&&this.listenTo(o,"delete",this.removeComponent),o},addFloatingGroupView:function(e){c.prototype.addFloatingGroupView.apply(this,arguments),this.listenTo(e.model,"change:floating",this.convertFloatingGroupView),this.listenTo(e.model,"change:name",this.updateFloatingGroupViewTitle),this.listenTo(e,"delete",this.removeComponent)},changeFloatingFilterGroup:function(e){!e.get("dashletFilterShowPopup")&&this.filterDialog.$el.is(":visible")&&this.filterDialog.close()},convertFloatingGroupView:function(e){e.get("floating")?this.dashletToPopup(e):this.popupToDashlet(e)},updateFloatingGroupViewTitle:function(e){this.filterDialog.updateTitle(e.get("name"))},popupToDashlet:function(e){if(e.get("type")===v.FILTER_GROUP){var o,t,n=this.getComponentViewByComponentId(e.id),i=a(".dashboardCanvas > div.content > div.body"),r=this.model.currentFoundation.components.get(e.id);if(o=this.model.currentFoundation.components.filter(function(o){return 0===o.get("x")&&0===o.get("y")&&o.get("type")!==e.get("type")}),o=1==o.length?o[0]:void 0,this.filterDialog.close(),o){var s=o.getPositionObject();t=d.clone(s),t.height>t.width?(t.height=parseInt(t.height/2),t.y+=t.height):(t.width=parseInt(t.width/2),t.x+=t.width),o.set(t)}else t=this.strategy.calculateEmptyArea({x:0,y:0,height:1,width:1},e.id);n&&this.filterDialog.$el.find(n.$el.parent()).length>0&&(i.append(n.$el.parent()),this.strategy.updateLayout(r.id,{x:0,y:0,height:t.height,width:t.width}),this.model.currentFoundation.trigger("moveComponent",r,this.model.currentFoundation),n._onComponentMove(),n.resizeContentContainer())}},dashletToPopup:function(e){if(e.get("type")===v.FILTER_GROUP){var o=this.getComponentViewByComponentId(e.id);o&&o.$el.parents().length>0&&(this.filterDialog.updateTitle(e.get("name")),this.filterDialog.$el.find(this.filterDialog.contentContainer).append(o.$el.parent()),this.listenTo(o.model,"change:name",this.updateFloatingGroupViewTitle))}},_onCanvasDrop:function(e,o){var t=a(e.originalEvent.target);if(t.hasClass("dashboardCanvas")||t.parents(".dashboardCanvas").length||t.hasClass(".filterGroup.dialog.open")||t.parents(".filterGroup.dialog.open").length||t.is(".helper.filter-dialog-drop")){var n=this,i=o.helper.data("data");if(i.componentId){var r=this.model.currentFoundation.components.get(i.componentId),s=r.getPositionObject();this.strategy.onDashletDrop(r,e,o,this.$el),d.isEqual(r.getPositionObject(),s)||w.trigger(I.SAVE_DASHBOARD_STATE)}else{if(i.resourceType===_.INPUT_CONTROL&&(this.model.currentFoundation.components.findWhere({resource:i.uri})||this.model.currentFoundation.components.find(function(e){return e.get("type")===_.INPUT_CONTROL&&e.getOwnerUri()===i.ownerResourceId&&e.getOwnerParameterName()===i.id})))return;this.$overlay.open(),this.addComponent(i).done(function(t){t.get("type")===v.FILTER_GROUP&&t.getChildren().length>=2||i.resourceType==v.INPUT_CONTROL&&n.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletFilterShowPopup")||n.strategy.onDashletDrop(t,e,o,n.$el),a.when(t.paramsDfd||{}).always(function(){n.$overlay.close()}).done(function(){w.trigger(I.SAVE_DASHBOARD_STATE)})})}}},_onGlobalMousedown:function(e){var o,t=this.model.currentFoundation.components,n=t.getSelectedComponent();if(n&&(o=n.get("id"))&&n.isVisible()){var i=this.getComponentViewByComponentId(o).$el,r=i.offset(),s=e.pageX-r.left,d=e.pageY-r.top;s>0&&s<i.width()&&d>0&&d<i.height()||a(e.target).closest("."+T.DASHLET_PROPERTIES_DIALOG_CLASS).length||a(e.target).closest("."+T.DELETE_CONFIRMATION_DIALOG_CLASS).length||a(e.target).closest("."+T.CONTEXT_MENU_CLASS).length||t.selectComponent(void 0)}},_onGlobalKeydown:function(e){46!==e.which||a(e.target).closest("."+T.DASHLET_PROPERTIES_DIALOG_CLASS).length||a(e.target).closest("."+T.SAVE_AS_DIALOG_CLASS).length||a(e.target).find("."+T.SAVE_AS_DIALOG_CLASS+":visible").length||this.removeComponent(this.model.currentFoundation.components.getSelectedComponent())},_initAddComponentDialogEvents:function(e,o,t){var n=this;this.listenTo(this.addComponentDialogController.dialog,"button:ok",function(){t&&t.call(n,e),n.closeAddComponentDialog(),n.model.currentFoundation.components.add(e),n.model.currentFoundation.components.selectComponent(e),o.resolve(e)}),this.listenTo(this.addComponentDialogController.dialog,"button:cancel",function(){n.closeAddComponentDialog(),o.reject(e)})},addComponent:function(e){var o,t,n=this.model.contextPath,i=this.model.currentFoundation.components,r=a.Deferred();if(e.resourceType===_.INPUT_CONTROL){t=i.findWhere({type:v.FILTER_GROUP})||y({type:v.FILTER_GROUP,name:l["dashboard.component.filter.group.component.name"]||"Filter Group"},{collection:i,dashboardId:this.dashboardId})}else e.uri&&e.resourceType&&((o=this.model.resources.get(e.uri))||(o=m.createDashboardResource(e,n))),t=y(e,{resource:o,collection:i,dashboardId:this.dashboardId},{createComponentObj:!0});return(this.addComponentByTypeHandlerMap()[t.get("type")]||this._addDefaultComponentType)(t,r,e),r.promise()},addInputControlToFilterGroup:function(e,o){var t=this.model.currentFoundation.components;if(!t.findWhere({resource:e.uri})){var n;e.uri&&e.resourceType&&(this.model.resources.get(e.ownerResourceId)||this.model.resources.each(function(o){o.resource.get("uri")===e.ownerResourceId&&(e.ownerResourceId=o.get("name"))}),(n=this.model.resources.get(e.uri))||(n=m.createDashboardResource(e,this.model.contextPath)));var i=t.get(o),r=i.getChildren(),s=r.length?Math.max.apply(null,d.map(r,function(e){return e.get("position")}))||0:0,a=y(e,{resource:n,collection:t,dashboardId:this.dashboardId},{createComponentObj:!0});return a.set({ownerResourceId:e.ownerResourceId,ownerResourceParameterName:e.ownerResourceParameterName,masterDependencies:e.masterDependencies,fullCollectionRequired:e.mandatory&&!!e.masterDependencies.length,parentId:o,position:s+1}),t.add(a)}},openAddComponentDialog:function(e){this.$overlay.close(),C.useModel(this.model),this.addComponentDialogController=new D(e),this.addComponentDialogController.dialog.open()},closeAddComponentDialog:function(){this.stopListening(this.addComponentDialogController.dialog),this.addComponentDialogController.dialog.close(),this.addComponentDialogController.remove()},openAdhocDesignerIframe:function(e){this.adhocDesigner&&this.removeAdhocDesignerIframe(),this.adhocDesigner=new u({model:e}),this.adhocDesigner.render()},removeAdhocDesignerIframe:function(){this.stopListening(this.adhocDesigner),this.adhocDesigner.remove()},hideAdhocDesignerIframe:function(){this.stopListening(this.adhocDesigner),this.adhocDesigner.hide(),this.adhocDesigner.removeSubComponents(),this.adhocDesigner.detachEvents()},remove:function(){try{this.$el.droppable("destroy")}catch(e){O.debug(e)}this.addComponentDialogController&&this.addComponentDialogController.remove(),this.adhocDesigner&&this.adhocDesigner.remove(),this.$overlay.remove(),this.message.remove(),a(document).off("mousedown",this._onGlobalMousedown),a(document).off("keydown",this._onGlobalKeydown),c.prototype.remove.apply(this,arguments)},removeComponent:function(e){if(e&&(this.model.currentFoundation.components.selectComponent(void 0),this.model.currentFoundation.components.remove(e),w.trigger(I.SAVE_DASHBOARD_STATE),e.get("type")===v.INPUT_CONTROL)){var o=this.getComponentViewByComponentId(e.get("parentId"));o&&o.refreshFilterGroup();var t=this.model.currentFoundation.components.findWhere({resource:e.get("ownerResourceId")});this.getComponentViewByComponentId(t.id).render()}},applyCanvasSize:function(){c.prototype.applyCanvasSize.apply(this,arguments),d.each(this.componentViews,function(e){var o=e.model.getParent();!o||o.get("floating")||e.render()})},_initGrid:function(){var e,o,t=a("<div>").addClass("grid").hide();for(e=1;e<T.GRID_WIDTH;e++)o=this.strategy.cellToCoord(e,0),a("<div>").appendTo(t).css({width:"1px",height:"100%",left:o.x+"%"});for(e=1;e<T.GRID_HEIGHT;e++)o=this.strategy.cellToCoord(0,e),a("<div>").appendTo(t).css({width:"100%",height:"1px",top:o.y+"%"});this.$el.append(t)},_addWebPageView:function(e,o){this.openAddComponentDialog(e),this.addComponentDialogController.dialog.disableButton("ok"),this._initAddComponentDialogEvents(e,o,function(e){e.set("name",e.generateName(e.get("url")))})},_addFreeText:function(e,o){this.openAddComponentDialog(e),this._initAddComponentDialogEvents(e,o)},_addImage:function(e,o){this.openAddComponentDialog(e),this.addComponentDialogController.dialog.disableButton("ok"),this._initAddComponentDialogEvents(e,o)},_addNewVisualization:function(e,o){var t=this,i=this.model.contextPath,r=this.model.currentFoundation.components;this.$overlay.close(),this.openAdhocDesignerIframe(e),this.listenTo(this.adhocDesigner,"close",function(){t.removeAdhocDesignerIframe(),o.reject(e)}),this.listenTo(this.adhocDesigner,"save",function(e,s){t.hideAdhocDesignerIframe(),s.type=R(s.type),s.resourceType=_.ADHOC_DATA_VIEW;var a=m.createDashboardResource(s,i),d=y(s,{resource:a,collection:r,dashboardId:t.dashboardId},{createComponentObj:!0});n(d),r.add(d),r.selectComponent(d),o.resolve(d)})},_addInputControl:function(e,o,t){var n=this,s=this.model.currentFoundation.components,a=function(){var i=n.addInputControlToFilterGroup(t,e.get("id"));i&&s.selectComponent(i),i&&i.set("label",i.get("name")),o.resolve(e)};if(-1===s.indexOf(e)&&s.add(e),t.ownerResourceId+"_files/"+t.ownerResourceParameterName==t.uri){var l=new f({uri:t.uri},{contextPath:n.model.contextPath});l.fetch({expanded:!0}).done(function(){var e=new m({},{contextPath:n.model.contextPath}),o={},s=l.get("uri");l.unset("uri"),l.set("label",n._generateControlId(t.id)),r(l.get("dataType"),s,"dataTypeReference"),r(l.get("listOfValues"),s,"listOfValuesReference");var d=r(l.get("query"),s,"queryReference");d&&r(d.dataSource,s,"dataSourceReference"),i(l),o[b.INPUT_CONTROL]=l.attributes,e.set({name:s,type:v.INPUT_CONTROL,resource:o}),e.resource.resource=l,n.model.resources.add(e),a()}).fail(d.bind(o.reject,o))}else a()},_addDefaultComponentType:function(e,o,t){var i=this.model.currentFoundation.components;n(e),-1===i.indexOf(e)&&i.add(e),i.selectComponent(e),o.resolve(e)},_generateControlId:function(e){function o(e){return!i.model.currentFoundation.components.find(function(o){return o.resource&&o.resource.resource.get("label")===e})}function t(e,n){var i=e+"_"+n;return o(i)?i:t(e,n+1)}var n=2,i=this;if(o(e))return e;if(/.*_\d+$/.match(e)){var r=e.lastIndexOf("_");n=+e.substring(r+1)+1,e=e.substring(0,r)}return t(e,n)}})});