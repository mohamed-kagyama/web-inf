/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","./designerAdhocViewTrait","../../../view/designer/AdhocDesignerIframeView","../../../mapper/adHocToDashboardTypeMapper","../../../collection/ReportsParametersCollection","../../../enum/dashboardComponentTypes","../../../enum/dashletTechnicalOutputs","bundle!DashboardBundle"],function(e,o,n){function t(e){return i.map(e||[],function(e){return{id:e.id,uri:e.uri,label:e.label}})}function r(e){return i.filter(e||[],function(e){return-1===i.indexOf(h,e.id)})}var i=e("underscore"),d=e("./designerAdhocViewTrait"),s=e("../../../view/designer/AdhocDesignerIframeView"),a=e("../../../mapper/adHocToDashboardTypeMapper"),c=e("../../../collection/ReportsParametersCollection"),u=e("../../../enum/dashboardComponentTypes"),l=e("../../../enum/dashletTechnicalOutputs"),p=e("bundle!DashboardBundle"),m=c.instance,h=i.values(l);n.exports=i.extend({},d,{additionalContextMenuOptions:[{label:p["dashboard.context.menu.option.edit"],action:"edit"}],_initComponentSpecificContextMenuEvents:function(){this.listenTo(this.contextMenu,"option:edit",this._editComponent)},_reInitDashlet:function(){this._removeComponent(),this.model.resetCaching(),this._initComponent()},_editComponent:function(){function e(){o.stopListening(n),n.remove()}var o=this,n=new s({model:this.model});o.listenTo(n,"close",function(){e()}),o.listenTo(n,"save",function(n,d){e(),o.model.changeType(a(d.type)),o._reInitDashlet(),o.listenTo(m,"change:inputControl",function(e){o.model.resource.resource.get("uri")===e.id&&(o.stopListening(m,"change:inputControl"),m.getReportParameters(o.model.resource.resource.get("uri"),{force:!0}).done(function(e,n){o.model.set({outputParameters:t(r(n)),parameters:t(e)}),o.model.getReportResourceUri().done(function(){o.paramsModel.paramsChanged||o.refresh(),i.invoke(o.model.collection.where({type:u.FILTER_GROUP}),"notify",!0)})}))}),m.getReportControls(o.model.resource.resource.get("uri"),{force:!0}).done(function(e){var n=i.pluck(o.model.get("parameters"),"id"),t=i.pluck(e,"id"),r=i.difference(n,t),d=o.model.collection.where({type:u.INPUT_CONTROL,ownerResourceId:o.model.resource.id});o.model.collection.remove(i.reduce(d,function(e,o){return i.indexOf(r,o.getOwnerParameterName())>=0&&e.push(o),e},[]))}),o.model.trigger("edit",o.model)}),n.render()}})});