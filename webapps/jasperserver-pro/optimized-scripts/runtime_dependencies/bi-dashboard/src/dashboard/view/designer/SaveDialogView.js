/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","bundle!DashboardBundle","bundle!CommonBundle","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","runtime_dependencies/js-sdk/src/common/component/dialog/DialogWithModelInputValidation","runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog","../../factory/repositoryFolderTreeFactory","../../dashboardSettings","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","text!../../template/saveDialogContentTemplate.htm","text!../../template/saveDialogTemplate.htm","text!../../template/tooltip/saveDialogTooltipTemplate.htm","runtime_dependencies/js-sdk/src/common/component/notification/Notification","settings!treeComponent"],function(e,t,i){function o(e){var t=e.toJSON();delete t.uri,delete t.permissionMask,delete t.updateDate,delete t.creationDate,delete t.version;var i=new r(t,{contextPath:e.contextPath,type:h.DASHBOARD});return i.validation=e.validation,i}var s=e("underscore"),a=e("bundle!DashboardBundle"),n=e("bundle!CommonBundle"),r=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),l=e("runtime_dependencies/js-sdk/src/common/component/dialog/DialogWithModelInputValidation"),c=e("runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog"),d=e("../../factory/repositoryFolderTreeFactory"),m=e("../../dashboardSettings"),h=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),p=e("text!../../template/saveDialogContentTemplate.htm"),u=e("text!../../template/saveDialogTemplate.htm"),b=e("text!../../template/tooltip/saveDialogTooltipTemplate.htm"),v=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),g=e("settings!treeComponent");i.exports=l.extend({constructor:function(e){e||(e={}),l.prototype.constructor.call(this,{modal:!0,resizable:!0,minWidth:m.SAVE_AS_DIALOG_MIN_WIDTH,minHeight:m.SAVE_AS_DIALOG_MIN_HEIGHT,alsoResize:".treeBox",model:e.model,additionalCssClasses:"saveAs",title:a["dashboard.dialog.save.title"],template:u,content:s.template(p)({i18n:a}),buttons:[{label:n["button.save"],action:"save",primary:!0},{label:n["button.cancel"],action:"cancel",primary:!1}]}),this.on("button:save",s.bind(this._onSaveDialogSaveButtonClick,this)),this.on("button:cancel",s.bind(this._onSaveDialogCancelButtonClick,this))},initialize:function(e){var t=this;l.prototype.initialize.apply(this,arguments),this.disableButton("save"),this.foldersTree=d({contextPath:this.model.contextPath,treeBufferSize:parseInt(g.treeLevelLimit,10),tooltipContentTemplate:b}),this.notification=new v,this.listenTo(this.foldersTree,"selection:change",function(e){var i;e&&s.isArray(e)&&e[0]&&e[0].uri&&(i=e[0].uri),t.model.set("parentFolderUri",i),t.enableButton("save")}),this.$contentContainer.find(".control.groupBox .body").append(this.foldersTree.render().el),this.confirmationDialog=new c({title:a["dashboard.confirm.dialog.save.title"],text:a["dashboard.save.conflict"]}),this.listenTo(this.confirmationDialog,"button:yes",this._onSaveFromDialogConfirm)},open:function(){var e=this;this.enableButton("cancel"),this.original=this.model,this.model=o(this.model),this.bindValidation(),this.model&&s.each(this.model.attributes,function(t,i){e.$("[name="+i+"]").val(t)}),l.prototype.open.apply(this,arguments)},close:function(){this.foldersTree&&(this.foldersTree.collapse("@fakeRoot",{silent:!0}),this.foldersTree.collapse("/public",{silent:!0}),this.foldersTree.resetSelection()),this.original&&(this.model=this.original,this.original=void 0),this.unbindValidation(),this.clearValidationErrors(),this.disableButton("save"),l.prototype.close.apply(this,arguments)},save:function(){this.model.isNew()?this.saveAs():this.model.save({},{createFolders:!1,expanded:!0,success:s.bind(function(e,t){this._saveAjaxSuccessCallback(e,t)},this),error:s.bind(function(e,t,i){this._saveAjaxErrorCallback(e,t,i)},this)})},remove:function(){this.notification.remove(),this.foldersTree.remove(),this.confirmationDialog.remove(),l.prototype.remove.apply(this,arguments)},saveAs:function(){this.open()},_onSaveDialogCancelButtonClick:function(){this.close()},_onSaveDialogSaveButtonClick:function(){var e=this,t=this.model;t.isValid(!0)&&(t.set("name",r.generateResourceName(t.get("label"))),e.buttons.getOptionView("save").disable(),t.save({},{createFolders:!1,expanded:!0,success:s.bind(this._saveFromDialogAjaxSuccessCallback,this),error:function(t,i,o){409===i.status||400===i.status&&i.responseJSON&&"resource.already.exists"===i.responseJSON.errorCode?e.confirmationDialog.open():e._saveFromDialogAjaxErrorCallback(t,i,o),e.buttons.getOptionView("save").enable()}}))},_setMinSize:function(){this.dialogOptions.minWidth&&this.$el.css({minWidth:this.dialogOptions.minWidth}),this.dialogOptions.minHeight&&this.$el.css({minHeight:this.dialogOptions.minHeight})},_saveFromDialogAjaxErrorCallback:function(e,t,i){this._saveAjaxErrorCallback(e,t,i)},_saveAjaxErrorCallback:function(e,t,i){var o;switch(t.status){case 404:o=a["dashboard.notification.message.not.found"];break;case 403:o=a["dashboard.notification.message.access.denied"];break;case 401:o=a["dashboard.notification.message.not.authenticated"];break;default:o=a["dashboard.notification.message.unknown.error"]}this.notification.show({message:o})},_saveAjaxSuccessCallback:function(e,t){this.model.updateResourceCollection(),this.trigger("save",this),this.notification.show({message:a["dashboard.notification.message.saved"],type:"success"})},_saveFromDialogAjaxSuccessCallback:function(e,t){this.close(),this.model.set(this.model.parse(t)),this._saveAjaxSuccessCallback(e,t)},_onSaveFromDialogConfirm:function(){this.disableButton("save"),this.disableButton("cancel"),this.model.save({},{createFolders:!1,overwrite:!0,expanded:!0,success:s.bind(this._saveFromDialogAjaxSuccessCallback,this),error:s.bind(this._saveFromDialogAjaxErrorCallback,this)})}})});