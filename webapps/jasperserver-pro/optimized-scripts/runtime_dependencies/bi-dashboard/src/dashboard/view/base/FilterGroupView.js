/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","bundle!CommonBundle","../../dashboardSettings","text!../../template/filterGroupButtonsTemplate.htm"],function(t,e,i){var s=t("jquery"),o=t("underscore"),n=t("backbone"),r=t("bundle!CommonBundle"),h=t("../../dashboardSettings"),l=t("text!../../template/filterGroupButtonsTemplate.htm"),a={APPLY:"applyButton",RESET:"resetButton",FILTERS_PER_ROW:"filtersPerRow",BUTTONS_POSITION:"buttonsPosition",FLOATING:"floating"};i.exports=n.View.extend({initialize:function(){o.bindAll(this,"_onWindowResize"),this.listenTo(this.model,"change",this._onPropertiesChange),s(window).on("resize",this._onWindowResize)},render:function(){this.$footer=this.$el.parent().append(o.template(l,{i18n:r})).find(".filterGroupButtons"),this.$applyButton=this.$footer.find("[data-target='"+a.APPLY+"']"),this.$resetButton=this.$footer.find("[data-target='"+a.RESET+"']"),this.$applyButton.on("click",o.bind(this.model.notify,this.model,!0)),this.$resetButton.on("click",o.bind(this._onResetClick,this)),this._setButtonsVisibility()},remove:function(){return this.$applyButton&&this.$applyButton.off("click"),this.$resetButton&&this.$resetButton.off("click"),s(window).off("resize",this._onWindowResize),n.View.prototype.remove.apply(this,arguments)},resizeInputControlsWidth:function(t){if(0!==this.$el.width()){var e=this.$el.width()/this.$el.outerWidth()*100,i=Math.floor(e/(t||this.model.get(a.FILTERS_PER_ROW)))+"%";this.$el.find(".inputControlWrapper").css({width:i})}},wrapInputControls:function(){var t=this.model.get(a.FILTERS_PER_ROW),e=this.$el.find(".inputControlWrapper"),i=e.length;this.removeEmptyRows(),this.unwrapInputControls(e);for(var o=0;o<i;o+=t){var n=s("<div></div>",{class:"filterRow"});e.filter(function(e){return e>=o&&e<o+t}).wrapAll(n)}},refresh:function(){this.wrapInputControls(),this.refreshFilterGroupLayout(this.model.get(a.BUTTONS_POSITION))},unwrapInputControls:function(t){t=t||this.$el.find(".inputControlWrapper"),o.each(t,function(t){s(t).parent().hasClass("filterRow")&&s(t).unwrap()})},removeEmptyRows:function(){var t=this.$el.find(".filterRow");o.each(t,function(t){!s(t).children().length&&s(t).remove()})},refreshFilterGroupLayout:function(t){var e=this.$el.find(".filterRow"),i=this.$el.parent().height(),s=this.$el.css("padding"),n=this;"right"===t&&(this.model.get("resetButton")||this.model.get("applyButton"))?(e.addClass("fluid"),this.$footer.addClass("fixed"),this.$el.css({float:"left",height:this.isFloating()?"auto":i-2*s+"px"}),this.model.get(a.APPLY)&&this.model.get(a.RESET)?(this.$footer.removeClass("oneButton"),e.removeClass("oneButton")):(this.$footer.addClass("oneButton"),e.addClass("oneButton"))):(e.length&&e.removeClass("fluid").removeClass("oneButton"),this.$footer&&this.$footer.removeClass("oneButton").removeClass("fixed"),this.$el.css({float:"none",height:this.isFloating()?"auto":this.$footer.is(":visible")?i-this.$footer.outerHeight(!0)+"px":i})),this.isFloating()&&o.defer(o.bind(this.setFloatingStyle,n))},enableButtons:function(){this.$applyButton&&this.$applyButton.removeAttr("disabled"),this.$resetButton&&this.$resetButton.removeAttr("disabled")},disableButtons:function(){this.$applyButton&&this.$applyButton.attr("disabled","disabled"),this.$resetButton&&this.$resetButton.attr("disabled","disabled")},isFloating:function(){return this.model.get("floating")},setFloatingStyle:function(){var t=this.$el.parents("["+h.COMPONENT_ID_ATTRIBUTE+"='"+this.model.id+"']");t.css({height:"auto",width:"auto",position:""}),t.find(".dashletContent > .content").css({height:"100%",width:"100%"}),t.hasClass("ui-resizable")&&t.resizable("destroy")},_onResetClick:function(){this.model.isMute=!0;var t=this.model.id;o.each(this.componentViews,function(e){var i=e.model.getParent();i&&i.id===t&&e.reset()}),this.model.isMute=!1,this.model.notify(!0)},_onWindowResize:function(t){if(this.isFloating()){this.$el.parents("["+h.COMPONENT_ID_ATTRIBUTE+"='"+this.model.id+"']").css({maxHeight:s(".dashboardContainer").height()})}},_onPropertiesChange:function(){var t=this.model.changedAttributes();t&&((a.APPLY in t||a.RESET in t)&&(this._setButtonsVisibility(),this.refreshFilterGroupLayout(this.model.get(a.BUTTONS_POSITION))),a.FILTERS_PER_ROW in t&&(this.resizeInputControlsWidth(),this.refresh()),a.BUTTONS_POSITION in t&&this.refreshFilterGroupLayout(t[a.BUTTONS_POSITION]),a.FLOATING in t&&(t[a.FLOATING]?(this.resizeInputControlsWidth(1),this.refresh(),this.refreshFilterGroupLayout("bottom"),this.setFloatingStyle()):(this.resizeInputControlsWidth(),this.refresh())))},_setButtonsVisibility:function(){o.each(a,function(t){this["$"+t]&&this._setButtonVisibility(t)},this),this.model.get(a.APPLY)||this.model.get(a.RESET)?this.$footer.show():this.$footer.hide()},_setButtonVisibility:function(t){var e=this["$"+t];this.model.get(t)?e.show():e.hide()}})});