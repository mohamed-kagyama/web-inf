/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","bundle!DashboardBundle","runtime_dependencies/js-sdk/src/common/logging/logger","text!../../../template/dashletTemplate.htm","../../../enum/dashboardWiringStandardIds","../../../enum/dashboardComponentTypes","runtime_dependencies/js-sdk/src/common/component/base/OptionContainer","text!../../../template/dashletToolbarButtonTemplate.htm","text!../../../template/dashletToolbarTemplate.htm"],function(e,t,o){function s(e){e.name===d.APPLY_SLOT?this.updateTitle():a.indexOf(a.values(d),e.name)<0&&(a.isUndefined(e.value)?this.paramsModel.unset(e.name):this.paramsModel.set(e.name,e.value))}function i(e,t){return t&&"string"==typeof t?e.replace("{0}",t):(t&&a.each(t,function(t,o){e=e.replace("{"+o+"}",t)}),e)}var a=e("underscore"),n=e("jquery"),r=e("bundle!DashboardBundle"),h=e("runtime_dependencies/js-sdk/src/common/logging/logger"),l=e("text!../../../template/dashletTemplate.htm"),d=e("../../../enum/dashboardWiringStandardIds"),c=e("../../../enum/dashboardComponentTypes"),m=e("runtime_dependencies/js-sdk/src/common/component/base/OptionContainer"),p=e("text!../../../template/dashletToolbarButtonTemplate.htm"),u=e("text!../../../template/dashletToolbarTemplate.htm"),b=h.register("dashletTrait");o.exports={template:a.template(l),_onViewInitialize:function(){var e=this.model.get("type");if(this.$dashlet=this.$("> .dashletContent"),this.$content=this.$("> .dashletContent > .content"),this.$content.addClass("hideVizLauncher"),this.on("componentRendered",a.bind(this._toggleDashletToolbarButtons,this)),this.on("componentRendered",function(){this.ready.resolve()},this),this.paramsModel=this.model.paramsModel,this.listenTo(this.model,"signal",s),this.model.lastPayload)for(var t in this.model.lastPayload)s.call(this,{name:t,value:this.model.lastPayload[t]},this.model.lastSender[t]);e!==c.FREE_TEXT&&e!==c.IMAGE||(this.listenTo(this.model,"change:showDashletBorders",this._setDashletVisualAppearance),this.listenTo(this.model,"change:borderColor",this._setDashletVisualAppearance))},_onViewRender:function(){this._setDashletVisualAppearance(),this.model.isVisualization()&&(void 0===this.model.get("showVizSelectorIcon")&&this.$content.removeClass("hideVizLauncher"),this._initToolbar(),this._setDashletToolbarVisualAppearance()),this.component&&this.component.isFloating&&this.component.isFloating()||a.defer(a.bind(this.resize,this))},_onViewResize:function(){this.component&&this.component.isFloating&&this.component.isFloating()||this.resizeContentContainer()},resizeContentContainer:function(){this.$content.height(this.$dashlet.height()-2*this.dashboardProperties.get("dashletPadding")-(this.toolbar&&this.toolbar.$el.is(":visible")?this.toolbar.$el.outerHeight(!0):0)-(this.paginationView&&this.paginationView.$el.is(":visible")?this.paginationView.$el.outerHeight(!0):0)-(this.component&&this.component.$footer&&this.component.$footer.is(":visible")?this.component.$footer.hasClass("fixed")?0:this.component.$footer.outerHeight(!0):0))},updateTitle:function(){this.toolbar&&this.toolbar.$(".innerLabel > p").text(this.model.getParametrizationResult("name",this.paramsModel.attributes,{tolerateMissing:!0}))},refresh:function(){return n.Deferred().resolve()},cancel:function(){return n.Deferred().resolve()},_initToolbar:function(){this.toolbar&&this.toolbar.remove(),this.toolbar=new m({options:[{cssClass:"maximizeDashletButton",action:"maximize",title:r["dashlet.toolbar.button.maximize"],text:"",disabled:!0,hidden:!1},{cssClass:"text cancelDashletButton",action:"cancel",title:r["dashlet.toolbar.button.cancel"],text:r["dashlet.toolbar.button.cancel"],hidden:!0},{cssClass:"refreshDashletButton",action:"refresh",title:r["dashlet.toolbar.button.refresh"],text:"",disabled:!0,hidden:!1},{cssClass:"exportDashletButton",action:"export",title:r["dashlet.toolbar.button.export"],text:"",disabled:!0,hidden:!1}],contextName:"button",contentContainer:".buttons",mainTemplate:u,optionTemplate:p}),this.updateTitle(),this.listenTo(this.toolbar,"button:refresh",this._onRefreshClick),this.listenTo(this.toolbar,"button:maximize",this._onMaximizeClick),this.listenTo(this.toolbar,"button:cancel",this._onCancelClick),this.listenTo(this.model,"change:name",this.updateTitle),this.$dashlet.prepend(this.toolbar.$el)},_setDashletToolbarVisualAppearance:function(e){this.toolbar&&(this.toolbar[this.model.get("showTitleBar")?"show":"hide"](),this.toolbar.getOptionView("refresh")[this.model.get("showRefreshButton")?"show":"hide"](),this.toolbar.getOptionView("maximize")[this.model.get("showMaximizeButton")?"show":"hide"](),this.toolbar.getOptionView("export")[this.model.get("showExportButton")?"show":"hide"](),e&&"showTitleBar"in e&&this.resize(),e&&"showVizSelectorIcon"in e&&(this.model.get("showVizSelectorIcon")?this.$content.removeClass("hideVizLauncher"):this.$content.addClass("hideVizLauncher")))},_setDashletVisualAppearance:function(){this._setColors(),this._setBorders()},_setBorders:function(){var e,t=this.model.get("type");switch(t){case c.FREE_TEXT:case c.IMAGE:e=this.model.get("showDashletBorders"),e&&this.$dashlet.css("border","1px solid "+this.model.get("borderColor"));break;default:e=this.dashboardProperties.get("showDashletBorders")}e?this.$dashlet.css("border-width","1px"):this.$dashlet.css("border-width","0");var o=this.dashboardProperties.get("dashletMargin");if(!e)try{var s=parseInt(this.$dashlet.css("border-width"),10);o-=isNaN(s)?0:s}catch(e){}this.$el.css("padding",o+"px"),this.$content.css("padding",this.dashboardProperties.get("dashletPadding")+"px")},_setColors:function(){var e=this.model.get("type"),t=this,o=(this.dashboardProperties.get("canvasColor"),this.dashboardProperties.get("titleBarColor")),s=this.dashboardProperties.get("titleTextColor");setTimeout(function(){switch(e){case c.REPORT:case c.ADHOC_VIEW:case c.WEB_PAGE_VIEW:case c.CHART:case c.TABLE:case c.IMAGE:case c.CROSSTAB:t.$dashlet.find(".dashletToolbar").css("background-color",o),t.$dashlet.find(".dashletToolbar p").css("color",s)}},0)},_onMaximizeClick:function(){this.model.isVisualization()&&this.model.set("maximized",!this.model.get("maximized"))},_toggleDashletToolbarButtons:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").enable(),this.toolbar.getOptionView("maximize").enable(),this.toolbar.getOptionView("export").enable())},_onRefreshClick:function(e){this._hideRefreshButton(),this.refresh().always(a.bind(this._showRefreshButton,this))},_onCancelClick:function(){var e=this;this.cancel().done(function(){b.debug("canceled dashlet refresh"),e._showRefreshButton()})},_enableRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").enable(),this.toolbar.getOptionView("cancel").hide())},_disableRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").disable(),this.toolbar.getOptionView("cancel").show())},_hideRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").hide(),this.toolbar.getOptionView("cancel").show())},_showRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").show(),this.toolbar.getOptionView("cancel").hide())},_errorMessageFactory:function(e){var t="adhocDataView"===this.model.attributes.type?r["dashboard.dashlet.error.adhoc.unexpected.error"]:r["dashboard.dashlet.error.unexpected.error"];return r["dashboard.dashlet.error."+e.errorCode]?i(r["dashboard.dashlet.error."+e.errorCode],e.parameters):t},_onPropertiesChange:function(){var e=this.model.changedAttributes();e&&("showTitleBar"in e||"showRefreshButton"in e||"showExportButton"in e||"showMaximizeButton"in e||"showVizSelectorIcon"in e)&&this._setDashletToolbarVisualAppearance(e),this._onComponentPropertiesChange&&this._onComponentPropertiesChange(e)},showMessage:function(e){if(e&&e.errorCode){var t=this._errorMessageFactory(e);t?this.$(".nothingToDisplay").removeClass("hidden").show().find(".message").text(t):b.warn("Unhandled message: "+e.toString())}},hideMessage:function(){this.$(".nothingToDisplay").addClass("hidden").hide()},_onViewRemove:function(){this.toolbar&&this.toolbar.remove()},addOverlay:function(){this.$overlay||(this.$overlay=n("<div></div>").addClass("overlay"),this.$dashlet.prepend(this.$overlay),this.$content.on("mousedown",function(e){e.stopPropagation()}))}}});