/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","bundle!DashboardBundle","bundle!CommonBundle","backbone","../../collection/ReportsParametersCollection","runtime_dependencies/js-sdk/src/common/component/tree/Tree","runtime_dependencies/js-sdk/src/common/component/tree/TreeDataLayer","runtime_dependencies/js-sdk/src/common/component/tree/plugin/TooltipPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/InfiniteScrollPlugin","runtime_dependencies/js-sdk/src/common/component/menu/ContextMenu","runtime_dependencies/js-sdk/src/common/component/tree/plugin/ContextMenuTreePlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/DragAndDropPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/SearchPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/HideEmptyNodesPlugin","runtime_dependencies/js-sdk/src/common/component/panel/Panel","runtime_dependencies/js-sdk/src/common/component/panel/trait/collapsiblePanelTrait","runtime_dependencies/js-sdk/src/common/component/panel/trait/tabbedPanelTrait","runtime_dependencies/js-sdk/src/common/component/panel/trait/menuPanelTrait","runtime_dependencies/js-sdk/src/common/component/panel/trait/resizablePanelTrait","../../factory/dashboardComponentModelFactory","../../model/DashboardResourceModel","runtime_dependencies/js-sdk/src/common/component/accordion/Accordion","../../enum/dashboardComponentTypes","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","../../dashboardSettings","text!../../template/sidebarTemplate.htm","text!../../template/sidebarTreeLeafTemplate.htm","text!../../template/tooltip/sideBarTreeLeafTooltipTemplate.htm","runtime_dependencies/bi-repository/src/bi/repository/util/resourcesTreeGetDataUriFnUtil","runtime_dependencies/bi-repository/src/bi/repository/util/extractRootLevelDataFromHtmlResponse","settings!treeComponent"],function(e,t,n){function r(e){return e.i18n=h,e}function i(e){switch(e.cssClass="dashboard-existingContent-",e.value.resourceType){case A.REPORT_UNIT:e.cssClass+="report";break;case A.ADHOC_DATA_VIEW:e.cssClass+="adhoc";break;case A.INPUT_CONTROL:e.cssClass+="filter"}return e}function o(){var e=this.libraryPanel,t=e.$("> .subcontainer").height(),n=e.$(".searchLockup").filter(":visible").outerHeight(!0);e.$("> .subcontainer").css("overflow","hidden");var r=e.$(".j-view-port-chunk").closest(".hideRoot"),i=e.$(".j-view-port-chunk").parent();if(e.selectedTab===W.FOLDERS)i.css({"max-height":""}),r.css({"max-height":t-n+"px",overflow:"auto"});else{r.css({"max-height":""}),i.css({"max-height":t-n+"px",overflow:"auto"});var o=this;d.defer(function(){o.libraryView.recalcConstraints(),o.libraryView.getLevel("/").fetch({force:!0,keepPosition:!0})})}}function s(e){if(d.contains([E.ADHOC_VIEW,E.REPORT,E.CROSSTAB,E.CHART,E.TABLE],e.get("type"))&&-1===d.indexOf(this.addedParameterContainers,e.resource.resource.get("uri"))){this.reportParametersContentPanel.content.addItem("/",{id:e.resource.resource.get("uri"),i18n:m,cssClass:"dashboard-existingContent-"+(e.get("type")===E.ADHOC_VIEW?"adhoc":"report"),value:{label:e.get("name"),uri:e.resource.resource.get("uri")},_node:!0});var t=this.reportParametersTree.getLevel(e.resource.resource.get("uri"));t.hasItems()&&this.accordion.expand(this.reportParametersContentPanel),this.listenToOnce(t,"ready",function(e){e.hasItems()&&this.accordion.expand(this.reportParametersContentPanel)},this),this.addedParameterContainers.push(e.resource.resource.get("uri"))}}function a(e){var t=this.reportParametersContentPanel.content.getLevel(e.resource.resource.get("uri"));t||(t=this.reportParametersContentPanel.content.getLevel(e.resource.id)),this.listenToOnce(t,"ready",function(){var e=!1,t=this.reportParametersContentPanel.content.getLevel("/").items;for(var n in t)e|=t[n].hasItems();e?this.accordion.expand(this.reportParametersContentPanel):this.accordion.collapse(this.reportParametersContentPanel)},this),t.refresh()}function l(e){if(e.resource){var t=d.indexOf(this.addedParameterContainers,e.resource.resource.get("uri")),n=this;if(-1===t&&(t=d.indexOf(this.addedParameterContainers,e.get("resource"))),t>-1){var r=this.model.currentFoundation.components.findWhere({resource:e.resource.resource.get("uri")});if(r||(r=this.model.currentFoundation.components.findWhere({resource:e.get("resource")})),!r){this.addedParameterContainers.splice(t,1),this.addedParameterContainers.length&&!d.all(this.addedParameterContainers,function(e){return!n.reportParametersTree.getLevel(e).hasItems()})||this.accordion.collapse(this.reportParametersContentPanel);var i=this.reportParametersContentPanel.content.getLevel(e.resource.resource.get("uri"));i&&i.remove()}}}}function c(e){var t=new u.Deferred,n=this;return this.predefinedData&&this.predefinedData[e.id]?t.resolve({total:this.predefinedData[e.id].length,data:this.predefinedData[e.id]}):N.getReportControls(e.id).done(function(){t.resolve({total:n.getDataSize.apply(n,arguments),data:n._process.call(n,n.getDataArray.apply(n,arguments),e)})}).fail(d.bind(t.reject,t)),t}var d=e("underscore"),u=e("jquery"),m=e("bundle!DashboardBundle"),h=e("bundle!CommonBundle"),p=e("backbone"),b=e("../../collection/ReportsParametersCollection"),g=e("runtime_dependencies/js-sdk/src/common/component/tree/Tree"),f=e("runtime_dependencies/js-sdk/src/common/component/tree/TreeDataLayer"),P=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/TooltipPlugin"),T=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/InfiniteScrollPlugin"),y=e("runtime_dependencies/js-sdk/src/common/component/menu/ContextMenu"),C=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/ContextMenuTreePlugin"),D=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/DragAndDropPlugin"),v=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/SearchPlugin"),I=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/HideEmptyNodesPlugin"),_=e("runtime_dependencies/js-sdk/src/common/component/panel/Panel"),w=e("runtime_dependencies/js-sdk/src/common/component/panel/trait/collapsiblePanelTrait"),R=e("runtime_dependencies/js-sdk/src/common/component/panel/trait/tabbedPanelTrait"),x=e("runtime_dependencies/js-sdk/src/common/component/panel/trait/menuPanelTrait"),S=e("runtime_dependencies/js-sdk/src/common/component/panel/trait/resizablePanelTrait"),O=e("../../factory/dashboardComponentModelFactory"),L=e("../../model/DashboardResourceModel"),k=e("runtime_dependencies/js-sdk/src/common/component/accordion/Accordion"),E=e("../../enum/dashboardComponentTypes"),A=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),F=e("../../dashboardSettings"),H=e("text!../../template/sidebarTemplate.htm"),z=e("text!../../template/sidebarTreeLeafTemplate.htm"),j=e("text!../../template/tooltip/sideBarTreeLeafTooltipTemplate.htm"),V=e("runtime_dependencies/bi-repository/src/bi/repository/util/resourcesTreeGetDataUriFnUtil"),U=e("runtime_dependencies/bi-repository/src/bi/repository/util/extractRootLevelDataFromHtmlResponse"),M=e("settings!treeComponent"),N=b.instance,W={FOLDERS:"folders",LIST:"list"},B={VIEW:"view",VISUALIZATION:"visualization"},$={folders:{bufferSize:parseInt(M.treeLevelLimit,10)},list:{bufferSize:100,cache:{searchKey:"searchString",pageSize:100}}};n.exports=_.extend({constructor:function(e){_.call(this,d.extend({title:m["dashboard.sidebar.title"],collapserSelector:"> .button.minimize, > .icon.minimize",template:H,traits:[w,S],collapsed:!1,additionalCssClasses:"jr",contentContainer:".content",closedClass:"minimized",handles:"e",minWidth:F.SIDEBAR_MIN_WIDTH,maxWidth:F.SIDEBAR_MAX_WIDTH},e))},initialize:function(e){function t(){N&&M&&this.accordion.fit()}var n=this;_.prototype.initialize.apply(this,arguments),e||(e={}),e.strategy||(e.strategy={onDashletDragStart:function(){},onDashletDrag:function(){},onDashletDragStop:function(){}});var p={i18n:h,attachTo:this.$el,contentTemplate:j};this.dashboardId=e.dashboardId,this.addedParameterContainers=[],this.filterContextMenu=new y([{label:m["dashboard.context.menu.option.add.to.filter.manager"],action:"add"},{label:m["dashboard.context.menu.option.remove.from.filter.manager"],action:"remove",default:!0}],{toggle:!0}),this.listenTo(this.filterContextMenu,"option:add",function(e,t){var r=this.filterContextMenu.treeItem.value,i=L.createDashboardResource(r),o=this.model.currentFoundation.components,s=O(r,{resource:i,collection:o,dashboardId:n.dashboardId},{createComponentObj:!0});s.set({ownerResourceId:r.ownerResourceId,ownerResourceParameterName:r.ownerResourceParameterName,masterDependencies:r.masterDependencies,fullCollectionRequired:r.mandatory&&!!r.masterDependencies.length}),!o.findWhere({resource:r.uri})&&o.add(s)}),this.listenTo(this.filterContextMenu,"option:remove",function(e,t){var n=this.filterContextMenu.treeItem.value,r=this.model.currentFoundation.components,i=r.findWhere({resource:n.uri});i&&r.remove(i)});var b=g.use(P,p).use(C,{contextMenu:this.filterContextMenu,defaultSelectedItems:function(e,t){if(d.find(n.model.currentFoundation.wiring.models,function(t){return t.component.get("resource")===e.value.uri}))return t[0]},showContextMenuCondition:function(e){if("dashboard-existingContent-filter-invisible"===e.cssClass)return this.contextMenu}}).use(I).use(D,{onDragStart:d.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:d.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:d.bind(e.strategy.onDashletDragStop,e.strategy)}).create(),E=g.use(P,p).use(T).use(v,{additionalParams:{type:[A.REPORT_UNIT,A.ADHOC_DATA_VIEW]}}).use(D,{onDragStart:d.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:d.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:d.bind(e.strategy.onDashletDragStop,e.strategy)}).create(),n=this;this.reportParametersTree=b.instance({itemsTemplate:z,listItemHeight:27,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!1,predefinedData:{"/":[]},processors:[{processItem:function(e,t){return e.value.ownerResourceId=t.id,e.value.ownerResourceParameterName=e.value.id,e.value.resourceType=A.INPUT_CONTROL,e}},{processItem:i},{processItem:r},{processItem:function(e,t){return e.value.visible||(e.dragDisabled=e.cssClass+="-invisible"),e}}],getDataArray:function(e,t,n){return d.clone(e)}}),this.reportParametersTree.defaultDataLayer.obtainData=c,this.newContentTree=b.instance({itemsTemplate:z,dataUriTemplate:this.model.contextPath+"/rest_v2/settings/dashboardSettings",selection:{allowed:!0,multiple:!1},listItemHeight:27,lazyLoad:!1,rootless:!0,processors:[{processItem:r},{processItem:function(e){return e.cssClass="dashboard-newContent-"+e.value.id,e}}],getDataArray:function(e){return d.map(e.newItemsRegistry,function(e){return e.label=m[e.label]?m[e.label]:e.label,e.description=m[e.description]?m[e.description]:e.description,e})}});var H=[{processItem:function(e){return e._node=e.value.resourceType===A.FOLDER,e}},{processItem:function(e){if("folder"!==e.value.resourceType||""!==e.value._links.content)return delete e.value._links,e}},{processItem:i},{processItem:r}];this.existingContentTreeView=g.use(P,p).use(T).use(D,{onDragStart:d.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:d.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:d.bind(e.strategy.onDashletDragStop,e.strategy)}).use(v,{additionalParams:{type:[A.REPORT_UNIT,A.ADHOC_DATA_VIEW]}}).create().instance(d.extend({},$[W.FOLDERS],{itemsTemplate:z,listItemHeight:27,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,additionalCssClasses:"folders",getDataUri:V({getFolderUri:function(e){return"@fakeRoot"===e?"":e},forceFullPage:!0,contextPath:e.model.contextPath,containerType:A.FOLDER,exclude:"/temp"}),levelDataId:"uri",customDataLayers:{"/":d.extend(new f({dataUriTemplate:e.contextPath+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:H,getDataArray:function(e){e=U(e);var t=d.find(e.children,function(e){return"/public"===e.uri}),n=[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}}];return t&&n.push({id:"/public",label:t.label,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}),n}}),{accept:"text/html",dataType:"text"})},processors:[{processItem:function(e){if("/public"!==e.value.uri)return e}}].concat(H),getDataArray:function(e,t,n){return e&&e[A.RESOURCE_LOOKUP]?e[A.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,n){return+n.getResponseHeader("Total-Count")}})),this.libraryView=E.instance(d.extend({},$[W.LIST],{itemsTemplate:z,listItemHeight:27,selection:{allowed:!0,multiple:!1},rootless:!0,dataUriTemplate:e.model.contextPath+"/rest_v2/resources?offset={{- offset }}&limit={{- limit }}&forceTotalCount=true&excludeFolder=/temp&forceFullPage=true",levelDataId:"uri",processors:[{processItem:i},{processItem:r}],getDataArray:function(e,t,n){return e&&e[A.RESOURCE_LOOKUP]?e[A.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,n){return+n.getResponseHeader("Total-Count")}})),this.libraryPanel=new _({title:m["dashboard.sidebar.existing.content.library"],traits:[w,x,R,S],collapsed:!1,handles:"s",additionalCssClasses:"libraryPanel",resizableEl:".subcontainer",overflow:"hidden",tabs:[{action:W.LIST,content:this.libraryView,primary:!0,label:W.LIST,hidden:!0},{action:W.FOLDERS,content:this.existingContentTreeView,label:W.FOLDERS,hidden:!0}],menuOptionSelectable:!0,menuPadding:{top:-11,left:6},menuToggleMode:!0,menuOptions:[{label:m["dashboard.sidebar.existing.content.list.view"],groupId:B.VIEW,action:W.LIST,default:!0},{label:m["dashboard.sidebar.existing.content.folder.view"],groupId:B.VIEW,action:W.FOLDERS},{label:m["dashboard.sidebar.existing.content.all"],groupId:B.VISUALIZATION,action:"all",default:!0},{label:m["dashboard.sidebar.existing.content.reports"],groupId:B.VISUALIZATION,action:"report"},{label:m["dashboard.sidebar.existing.content.adhoc.views"],groupId:B.VISUALIZATION,action:"adhoc"}],onCollapseControlPressed:function(e){n._resetHeights(),n.accordion.toggle(n.libraryPanel)}}),this.newContentPanel=new _({title:m["dashboard.sidebar.new.content"],traits:[w,S],collapsed:!1,fixedHeight:!0,content:this.newContentTree,handles:"s",additionalCssClasses:"newContentPanel",resizableEl:".subcontainer",minHeight:F.PANELS_MIN_HEIGHT,onCollapseControlPressed:function(e){n._resetHeights(),n.accordion.toggle(n.newContentPanel)}}),this.reportParametersContentPanel=new _({title:m["dashboard.sidebar.report.parameters"],traits:[w],collapsed:!0,additionalCssClasses:"reportParametersContentPanel",silent:!1,content:this.reportParametersTree,onCollapseControlPressed:function(e){n._resetHeights(),n.accordion.toggle(n.reportParametersContentPanel)}}),this.accordion=new k({container:this.$("> .content > .body"),panels:[this.newContentPanel,this.libraryPanel,this.reportParametersContentPanel],allowMultiplePanelsOpen:!0}),this.windowHeight=u(window).height();var M=!1,N=!1;this.listenToOnce(this.newContentTree.getLevel("/"),"ready",function(){M=!0,t.call(this),this.newContentPanelDefaultHeight=this.newContentPanel.$el.outerHeight(!0)},this),this.listenToOnce(this.libraryView.getLevel("/"),"ready",function(){N=!0,t.call(this)},this),this.listenTo(this.accordion,"fit",d.bind(o,this)),this.listenTo(this.model.foundations,"addComponent",function(e,t){t===n.model.currentFoundation&&s.call(n,e)}),this.listenTo(this.model.foundations,"removeComponent",function(e,t){t===n.model.currentFoundation&&l.call(n,e)}),this.listenTo(this.model.foundations,"editComponent",function(e,t){t===n.model.currentFoundation&&a.call(n,e)}),this.listenTo(this.libraryPanel,"option:all",d.bind(function(e,t){this.libraryView.clearCache(),this._filterByResource()},this)),this.listenTo(this.libraryPanel,"option:report",d.bind(function(e,t){this.libraryView.clearCache(),this._filterByResource({type:[A.REPORT_UNIT]},"report")},this)),this.listenTo(this.libraryPanel,"option:adhoc",d.bind(function(e,t){this.libraryView.clearCache(),this._filterByResource({type:[A.ADHOC_DATA_VIEW]},"adhoc")},this)),this.listenTo(this.libraryPanel,"option:folders",d.bind(function(e,t){this.libraryPanel.openTab(W.FOLDERS),this._filterByResource(this.activeResourceFilterOptions),this.accordion.fit()},this)),this.listenTo(this.libraryPanel,"option:list",d.bind(function(e,t){this.libraryPanel.openTab(W.LIST),this._filterByResource(this.activeResourceFilterOptions),this.accordion.fit()},this)),this.listenTo(this.libraryPanel.tabs[W.FOLDERS].searchForm,"search",d.bind(function(e){var t=this.libraryPanel.tabs[W.LIST].searchForm,n=[{action:W.LIST,groupId:B.VIEW}];this.activeVisualization&&n.push({action:this.activeVisualization,groupId:"visualization"}),t.setSearchString(e.searchString),t.search(e),this.libraryPanel.filterMenu.resetSelection(n,!0)},this)),this.listenTo(this.libraryPanel.tabs[W.LIST].searchForm,"clear",d.bind(function(){this.libraryPanel.tabs[W.FOLDERS].searchForm.clear()},this)),this.listenTo(this.newContentPanel,"resize",d.bind(this._onPanelResize,this,this.newContentPanel)),this.listenTo(this.libraryPanel,"resize",d.bind(this._onPanelResize,this,this.libraryPanel)),d.bindAll(this,"_onWindowResize"),u(window).on("resize",this._onWindowResize)},_onPanelResize:function(e){var t=d.isEqual(e,this.libraryPanel);this.reportParametersContentPanel.fixedHeight=!t,this.libraryPanel.fixedHeight=t,this.accordion.fit()},_filterByResource:function(e,t){t&&this._setActiveVisualization(t),d.isEqual(e,this.activeResourceFilterOptions)&&this.selectedTabId===this.libraryPanel.selectedTab||(this.selectedTabId=this.libraryPanel.selectedTab,this.selectedTab=this.libraryPanel.tabs[this.selectedTabId],this.activeResourceFilterOptions=e||{},this.selectedTab.searchForm.search(this.activeResourceFilterOptions))},_setActiveVisualization:function(e){this.activeVisualization=e},_resetHeights:function(){this.libraryPanel.fixedHeight=!1,this.reportParametersContentPanel.fixedHeight=!1,this.newContentPanel.setHeight(this.newContentPanelDefaultHeight)},_onWindowResize:function(e){var t=u(window).height();e.target.tagName||this.windowHeight===t||(this.windowHeight=t,this._resetHeights(),this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(d.bind(function(){this.accordion.fit()},this),100))},render:function(){return this.$("> .content > .body").append(this.newContentPanel.$el).append(this.libraryPanel.$el).append(this.reportParametersContentPanel.$el),this.reportParametersContentPanel.content.expand("/",{depth:0,silent:!0}),this},remove:function(){u(window).off("resize",this._onWindowResize),this.newContentPanel.remove(),this.libraryPanel.remove(),this.reportParametersContentPanel.remove(),this.filterContextMenu.remove(),p.View.prototype.remove.apply(this,arguments)}})});