/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","jquery","underscore","../../view/base/FloatingDashletDialogView","../../factory/dashboardComponentViewFactory","../../dashboardSettings","../../enum/dashboardComponentTypes","text!../../template/canvasTemplate.htm","runtime_dependencies/js-sdk/src/common/logging/logger","bundle!DashboardBundle"],function(e,t,o){function n(e){s.contains(window.document,e.el)&&e.trigger("componentAttached",e)}var i=e("backbone"),s=e("jquery"),r=e("underscore"),a=e("../../view/base/FloatingDashletDialogView"),d=e("../../factory/dashboardComponentViewFactory"),l=e("../../dashboardSettings"),h=e("../../enum/dashboardComponentTypes"),c=e("text!../../template/canvasTemplate.htm"),p=e("runtime_dependencies/js-sdk/src/common/logging/logger"),m=e("bundle!DashboardBundle"),u=p.register("CanvasView");o.exports=i.View.extend({el:r.template(c,{i18n:m}),initialize:function(e){e||(e={});var t=this;this.ready=new s.Deferred,this.componentViews=[],this.dashboardId=e.dashboardId,this.filterDialog=new a({modal:!1,title:m["dashboard.component.filter.group.component.name"],resizable:!1,foundation:this.model.currentFoundation}),this.$canvasBody=this.$(" > .content > .body"),this.listenTo(this.model.currentFoundation,"toggle:filterDialog",this.toggleFilterDialog),this.listenTo(this.model.currentFoundation,"close:filterDialog",this.closeFilterDialog),this.listenTo(this.model.foundations,"addComponent",function(e,o){o===t.model.currentFoundation&&t.addComponentView(e)}),this.listenTo(this.model.foundations,"removeComponent",function(e,o){o===t.model.currentFoundation&&t.removeComponentView(e)}),this.listenTo(this.model,"propertiesAvailable",function(e){t.listenTo(e,"change:useFixedSize change:fixedWidth change:fixedHeight",this.applyCanvasSize,this),this.applyCanvasSize(),this.applyCanvasColor()}),this.listenTo(this.model,"resourcesDataFetched",this.render),this.isDesigner||this.ready.done(function(){t.model.currentFoundation.components.each(function(e){e.getLinkUrl&&e.getLinkUrl()})})},toggleFilterDialog:function(){this.filterDialog.isVisible()?this.filterDialog.close():this.filterDialog.open()},closeFilterDialog:function(){this.filterDialog.close()},render:function(){if(this.model.currentFoundation){var e=l.STRICT_LAYOUT?this.model.currentFoundation.components.toHTML(!0):this.model.resources.get(this.model.currentFoundation.get("layout")).resource.content,t=this;this.removeAllComponentViews(),this.disableAutoRefresh(),this.$canvasBody.html(e),s("body#dashboard").append(this.filterDialog.$el),e&&(this.message&&this.message.hide(),this.model.currentFoundation.components.forEach(r.bind(this.addComponentView,this)),this.componentViews.length&&s.when.apply(s,r.pluck(this.componentViews,"ready")).then(function(){t.ready.resolve()}),this.enableAutoRefresh())}return this},removeComponentView:function(e){var t,o=this.getComponentViewByComponentId(e.id),n=r.indexOf(this.componentViews,o);o&&o.remove(),n>-1&&this.componentViews.splice(n,1),t=this.$canvasBody.find("["+l.COMPONENT_ID_ATTRIBUTE+"='"+e.id+"']"),t.length?t.remove():(t=s("["+l.COMPONENT_ID_ATTRIBUTE+"='"+e.id+"']"))&&t.remove(),u.debug("removed dashlet "+e.id)},addComponentView:function(e){var t;if(e.isVisible()&&!this.getComponentViewByComponentId(e.id))if(t=d({model:e,dashboardProperties:this.model.currentFoundation.components.getDashboardPropertiesComponent(),dashboardId:this.dashboardId},this.isDesigner),(e.get("floating")||t.dashboardProperties.get("dashletFilterShowPopup"))&&e.get("type")===h.FILTER_GROUP)this.addFloatingGroupView(t);else if(e.get("type")!==h.INPUT_CONTROL){var o=this.$canvasBody.find("["+l.COMPONENT_ID_ATTRIBUTE+"='"+e.id+"']");this.message&&this.message.hide(),o.length?o.css(e.getCssPosition()):(o=s(e.toHTML(!0)),this.$canvasBody.append(o)),this.componentViews.push(t),o.html(t.render().$el),n(t),e.get("type")===h.FILTER_GROUP&&this.listenTo(e,"change:floating",this.convertFloatingGroupView),this.listenTo(e,"change:maximized",this.toggleDashletMaximizedState),u.debug("added dashlet "+e.id)}else{var i=e.getParent(),a=this.getComponentViewByComponentId(i.id);a||(t.dashboardProperties.get("dashletFilterShowPopup")?this.addFloatingGroupView(i):this.addComponentView(i),a=this.getComponentViewByComponentId(i.id)),a.component.componentViews=this.componentViews,this.componentViews.push(t);var c,p=e.get("position"),m=i.getChildren(),g=9999999;r.each(m,function(e){p>e.get("position")&&g>p-e.get("position")&&(g=p-e.get("position"),c=e)}),c?this.getComponentViewByComponentId(c.get("id")).$el.after(t.render().$el):a.$content.prepend(t.render().$el),n(t),a._resizeComponent(),a.refreshFilterGroup(),u.debug("added input control "+e.id)}return t},addFloatingGroupView:function(e){var t=e.model,o=s(t.toHTML(!1));this.filterDialog.$el.find(this.filterDialog.contentContainer).append(o),this.componentViews.push(e),e.setFloatingStyle&&r.defer(e.setFloatingStyle()),o.html(e.render().$el),this.filterDialog.updateTitle(t.get("name"))},convertFloatingGroupView:function(){},removeAllComponentViews:function(e){r.invoke(this.componentViews,"remove",e),this.componentViews=[]},refresh:function(){var e=this.componentViews.filter(function(e){return r.isFunction(e.refresh)}),t=new s.Deferred;return this.ready.then(function(){s.when.apply(s,r.invoke(e||[],"refresh")).then(t.resolve,t.reject)},t.reject),t},cancel:function(){var e=this.componentViews.filter(function(e){return r.isFunction(e.refresh)&&r.isFunction(e.cancel)}),t=new s.Deferred;return this.ready.then(function(){s.when.apply(s,r.invoke(e||[],"cancel")).then(t.resolve,t.reject)},t.reject),t},remove:function(e){this.disableAutoRefresh(),this.removeAllComponentViews(e),i.View.prototype.remove.apply(this,arguments)},getComponentViewByComponentId:function(e){return r.find(this.componentViews,function(t){return t.model.id===e})},toggleDashletMaximizedState:function(e){var t=this.getComponentViewByComponentId(e.get("id"));e.get("maximized")?(t.$el.parent().addClass("canvasOverlay"),this.$el.addClass("maximizedDashlet"),t.toolbar&&t.toolbar.getOptionView("maximize").$el.addClass(l.DASHLET_TOOLBAR_MINIMIZE_BUTTON_CLASS).prop("title",m["dashboard.canvas.dashlet.minimize"])):(t.$el.parent().removeClass("canvasOverlay"),this.$el.removeClass("maximizedDashlet"),t.toolbar&&t.toolbar.getOptionView("maximize").$el.removeClass(l.DASHLET_TOOLBAR_MINIMIZE_BUTTON_CLASS).prop("title",m["dashboard.canvas.dashlet.maximize"])),t.resize()},enableAutoRefresh:function(){function e(e,t){var o=1e3;return"minute"===t&&(o*=60),e*o}function t(n,i,a){return a=a||new s.Deferred,n.ready.done(function(){o._autoRefreshEnabled&&r.isFunction(n.refresh)&&i.get("autoRefresh")?setTimeout(function(){o._autoRefreshEnabled&&r.isFunction(n.refresh)&&i.get("autoRefresh")?n.refresh().always(function(){t.call(o,n,i,a)}):a.resolve()},e(i.get("refreshInterval"),i.get("refreshIntervalUnit"))):a.resolve()}),a}var o=this,n=[];return this.model.currentFoundation.components.forEach(function(e){if(e.isAutoRefreshable()&&e.get("autoRefresh")){o._autoRefreshEnabled=!0;var i=e.get("type")===h.DASHBOARD_PROPERTIES?o:o.getComponentViewByComponentId(e.id);r.isFunction(i.refresh)&&n.push(t.call(o,i,e))}}),s.when.apply(s,n)},disableAutoRefresh:function(){this._autoRefreshEnabled=!1},applyCanvasColor:function(){var e=this.model.currentFoundation.components.getDashboardPropertiesComponent(),t=e.get("canvasColor");this.$canvasBody.css("background-color",t)},applyCanvasSize:function(){var e=this.model.currentFoundation.components.getDashboardPropertiesComponent();e.get("useFixedSize")?this.$el.css({width:e.get("fixedWidth")+"px",height:e.get("fixedHeight")+"px"}):this.$el.attr("style",null)}})});