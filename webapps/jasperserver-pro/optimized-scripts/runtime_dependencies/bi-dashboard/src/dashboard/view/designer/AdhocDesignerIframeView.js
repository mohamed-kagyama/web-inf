/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","jquery","../../dashboardSettings","../../model/component/DashboardComponentModel","text!../../template/adhocDesignerIframeTemplate.htm","../../enum/dashboardComponentTypes","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","../../view/designer/AddDashboardComponentDialogController","../../dashboardMessageBus","../../enum/dashboardMessageBusEvents","runtime_dependencies/js-sdk/src/common/component/notification/Notification"],function(e,i,o){var t=e("underscore"),n=e("backbone"),s=e("jquery"),r=e("../../dashboardSettings"),a=e("../../model/component/DashboardComponentModel"),d=e("text!../../template/adhocDesignerIframeTemplate.htm"),h=e("../../enum/dashboardComponentTypes"),l=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),c=e("../../view/designer/AddDashboardComponentDialogController"),m=e("../../dashboardMessageBus"),g=e("../../enum/dashboardMessageBusEvents"),p=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),u=l.extend({initialize:function(e,i){i||(i={}),this.constructor.__super__.initialize.apply(this,arguments),this.set("label",""),"ichart"===this.get("type")||"olap_ichart"===this.get("type")?this.set("type",h.CHART):"olap_crosstab"===this.get("type")&&this.set("type",h.CROSSTAB),this.collection=i.dashletCollection,this.validation.label=a.prototype.validation.name}});o.exports=n.View.extend({el:t.template(d),events:{load:"_onIframeLoad"},initialize:function(){t.bindAll(this,"_onWindowResize","_onDesignerCancel","_onDesignerSave"),s(window).on("resize",this._onWindowResize)},render:function(){var e=s("body"),i=this._getBannerSize();return this._addDimmer(),e.append(this.$el),this.$el.attr("src",this.model.getDesignerUri()).css({top:i+"px",height:e.find("> #frame").height()-i+"px",width:e.width()-2*r.DASHBOARD_ADHOC_IFRAME_MARGIN,"background-color":e.css("background-color"),"z-index":r.DASHBOARD_ADHOC_IFRAME_Z_INDEX}).show(),this},_onIframeLoad:function(){var e=this._getFrame();if(e.location.href.indexOf("login.html")>-1)m.trigger(g.SESSION_EXPIRED);else{var i=this;if(e&&e.jQuery)this._attachEventHandlers(e);else var o=setInterval(function(){e&&e.jQuery&&(clearInterval(o),i._attachEventHandlers(e))},500)}},_attachEventHandlers:function(e){var i=e.jQuery(e.document);i.off("adhocDesigner:cancel errorPage:close").on("adhocDesigner:cancel errorPage:close",this._onDesignerCancel),i.off("adhocDesigner:save").on("adhocDesigner:save",s.proxy(this._onConfirmDesignerSave,this)),i.off("adhocDesigner:saved").on("adhocDesigner:saved",s.proxy(this._onDesignerSave,this)),i.off("adhocDesigner:notification").on("adhocDesigner:notification",s.proxy(this._onDesignerNotification,this))},_onDesignerCancel:function(e,i){this.trigger("close",this),this._hideDimmer()},_onDesignerNotification:function(e,i,o){this.notification=this.notification?this.notification:new p,this.notification.show({message:i,delay:o,type:"success"})},_hideDimmer:function(){this.$dimmer.addClass("hidden").hide()},_addDimmer:function(){s(".dashboard.dimmer").length?!this.$dimmer&&(this.$dimmer=s(".dashboard.dimmer")):(this.$dimmer=s("<div class='dashboard dimmer hidden' style='z-index:"+r.DASHBOARD_DIMMER_Z_INDEX+"; display: none;'></div>"),s("body").append(this.$dimmer));var e=parseInt(this.$el.css("zIndex"));e>0&&this.$dimmer.css("zIndex",e-1),this.$dimmer.removeClass("hidden").show()},_onDesignerSave:function(e,i){i.label=this.model.get("name"),this.trigger("save",this,i)},_onConfirmDesignerSave:function(e,i){if(this.model.isNew()){var o=new u(i,{dashletCollection:this.model.collection});this.addComponentDialogController=new c(o,{okButtonLabel:"button.save",okButtonDisabled:!0,overElement:this.$el}),this.addComponentDialogController.dialog.open(),this.listenTo(this.addComponentDialogController.dialog,"button:ok",function(){o.isValid()&&(this.model.set("name",o.get("label")),this._postMessageToDesigner("adhocDesigner:save"),this.addComponentDialogController.closeAndRemove())},this),this.listenTo(this.addComponentDialogController.dialog,"button:cancel",function(){this.addComponentDialogController.dialog.close(),this._addDimmer()},this)}else this._postMessageToDesigner("adhocDesigner:save")},_postMessageToDesigner:function(e){this.$el[0].contentWindow.postMessage(e,window.location.origin)},_onWindowResize:function(){var e=s("body"),i=this._getBannerSize();this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(t.bind(function(){this.$el.height(e.find("> #frame").height()-i),this.$el.width(e.width()-2*r.DASHBOARD_ADHOC_IFRAME_MARGIN)},this),100)},_getBannerSize:function(){return s("body").find("> #banner").outerHeight(!0)||0},_getFrame:function(){return s(this.$el)[0].contentWindow},detachEvents:function(){var e=this._getFrame();if(s(window).off("resize",this._onWindowResize),e&&e.jQuery){e.jQuery(e.document).off("adhocDesigner:cancel errorPage:close").off("adhocDesigner:save")}},hide:function(){this.$el.hide()},removeSubComponents:function(){this.addComponentDialogController&&this.addComponentDialogController.remove(),this.$dimmer&&this.$dimmer.remove()},remove:function(){this.detachEvents(),this.removeSubComponents(),n.View.prototype.remove.apply(this,arguments)}})});