/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","request"],function(e,t,r){function a(e){e.$(".jrPage").each(function(e,t){var r=c(t),a=r.attr("style")||"",n=r.css("transform"),s=r.css("transform-origin");a.indexOf("transform")>=0&&-1==a.indexOf("-webkit-transform")&&r.attr("style",[a,"-webkit-transform:",n,"; -webkit-transform-origin:",s,";"].join(""))})}function n(){try{var e=document.createElement("canvas"),t=new c.Deferred;if(e&&e.getContext)return c.when.apply(c,c("img").map(function(t,r){var a=new c.Deferred;if("data"!==r.src.substring(0,4)){e||(e=document.createElement("canvas"));try{e.width=r.naturalWidth,e.height=r.naturalHeight,e.getContext("2d").drawImage(r,0,0),r.src=e.toDataURL("image/png"),a.resolve()}catch(t){var n=r.src;if(n.indexOf("/rest_v2/")>=0){var s=new Image;s.crossOrigin="use-credentials",s.addEventListener("load",function(){e=document.createElement("canvas"),e.width=s.width,e.height=s.height,e.getContext("2d").drawImage(s,0,0);try{r.src=e.toDataURL("image/png"),a.resolve()}catch(e){a.resolve()}},!1),s.src=n}else a.resolve()}e=null}else a.resolve();return a.promise()}));t.resolve()}catch(e){}return t.promise()}function s(){c("input").each(function(e,t){var r=c(t),a=r.attr("type");"text"==a?r.attr("value",r.val()):"radio"!=a&&"checkbox"!=a||r.attr("checked",t.checked?"checked":null)})}function i(){return h.reduce(document.styleSheets,function(e,t){var r="/reportresource?",a=t.href?t.href.indexOf(r):-1;return a>=0&&e.push(t.href.substring(a+r.length)),e},[])}function o(){var e=c("#jive_overlay").css("display"),t=c("#jive_marker").css("display"),r=c("#jive_marker").css("display");return c("#jive_overlay").css("display","none"),c("#jive_marker").css("display","none"),c("#jive_foobar").css("display","none"),function(){c("#jive_overlay").css("display",e),c("#jive_marker").css("display",t),c("#jive_foobar").css("display",r)}}var d,c=e("jquery"),h=e("underscore"),u=e("request");r.exports={prepareForExport:function(e){a(e)},applyReferenceSize:function(e,t){var r,a=0==e.$(".dashboardCanvas:first").length?e.$el:e.$(".dashboardCanvas:first");d=d||a.attr("style")||!1,r=Math.min(3508/t.width,2480/t.height),a.attr("style","-webkit-transform: scale("+r+"); transform-origin: left top; transform: scale("+r+"); -webkit-transform-origin: left top; width: "+t.width+"px; height: "+t.height+"px;")},removeReferenceSize:function(e){var t=0==e.$(".dashboardCanvas:first").length?e.$el:e.$(".dashboardCanvas:first");h.isUndefined(d)||(t.attr("style",d||null),d=void 0)},requestDashboardExport:function(e,t){var r=e.contextPath,a=new c.Deferred;return this.createExportDto(e,t).then(function(e){u({url:r+"/rest_v2/dashboardExecutions",method:"POST",headers:{Accept:"application/json"},contentType:"application/json",processData:!1,dataType:"json",data:JSON.stringify(e)}).done(function(e,t,r){a.resolve(e,t,r)}).fail(function(e,t,r){a.reject(e,t,r)})}),a},createExportDto:function(e,t){var r,a,d,h,u=this,f=o(),l=e.dashboardCanvas?e.dashboardCanvas.$el:e.$(".dashboardCanvas:first"),v=new c.Deferred;return n().then(function(){s(),u.prepareForExport(e.dashboardCanvas?e.dashboardCanvas:e),"pdf"==t?(h=l.children(".content"),u.applyReferenceSize(e.dashboardCanvas?e.dashboardCanvas:e,{width:h.width(),height:h.height()}),a=3508,d=2480):(a=l.width(),d=l.height()),r=l.parent().html(),f(),u.removeReferenceSize(e.dashboardCanvas?e.dashboardCanvas:e),v.resolve({uri:e.model.get("uri"),width:a,height:d,format:t,markup:r,jrStyle:i()})}),v.promise()},wait:function e(t,r){var a=this;return t&&u({url:this.contextPath+"/rest_v2/dashboardExecutions/"+t+"/status",headers:{Accept:"application/json"},dataType:"json"}).done(function(n){"execution"===n.status?(r.notifyWith(a,[n.progress]),setTimeout(h.bind(e,a,t,r),1e3)):r.resolve({status:n.status,href:a.contextPath+"/rest_v2/dashboardExecutions/"+n.id+"/outputResource",id:n.id})}).fail(h.bind(r.reject,r)),r}}});