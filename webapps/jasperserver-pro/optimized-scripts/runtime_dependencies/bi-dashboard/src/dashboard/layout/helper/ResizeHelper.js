/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../dashboardSettings","../../dashboardMessageBus","../../enum/dashboardMessageBusEvents","./BasicHelper","jquery-ui/ui/widgets/resizable"],function(e,i,t){var s=e("jquery"),n=e("underscore"),a=e("../../dashboardSettings"),o=e("../../dashboardMessageBus"),r=e("../../enum/dashboardMessageBusEvents"),h=e("./BasicHelper");e("jquery-ui/ui/widgets/resizable"),t.exports=h.extend({init:function(e){var i=this;this.container=e,n.bindAll(this,"_onWindowResize"),s(window).on("resize",this._onWindowResize),this.listenTo(this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent(),"change:dashletMargin",function(){i.container.find("["+a.COMPONENT_ID_ATTRIBUTE+"]").each(function(){i._fixResizeHandlePositions(s(this))})}),this.listenTo(this.strategy.model.foundations,"addComponent moveComponent",function(e,t){n.defer(function(){var t=i.container.find("["+a.COMPONENT_ID_ATTRIBUTE+"="+e.id+"]");t.length&&i._initResizable(t)})}),this.listenTo(this.strategy.model.foundations,"removeComponent",function(e,t){i._destroyResizable(i.container.find("["+a.COMPONENT_ID_ATTRIBUTE+"="+e.id+"]"))}),this.container.find("["+a.COMPONENT_ID_ATTRIBUTE+"]").each(function(){i._initResizable(s(this))})},deinit:function(){var e=this;this.container.find("["+a.COMPONENT_ID_ATTRIBUTE+"]").each(function(){e._destroyResizable(s(this))}),s(window).off("resize",this._onWindowResize)},_onWindowResize:function(e){if(!e.target.tagName){var i=this;this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(function(){var e=i.strategy.gridSize(i.container);i.container.find("["+a.COMPONENT_ID_ATTRIBUTE+"]").each(function(){s(this).is(".ui-resizable")&&s(this).resizable("option",{minWidth:Math.floor(e.x),minHeight:Math.floor(e.y),grid:[Math.floor(e.x),Math.floor(e.y)]})})},300)}},_onDashletResizeStart:function(e,i){var t=s(e.target),n=t.attr(a.COMPONENT_ID_ATTRIBUTE),o=this.strategy.model.currentFoundation.components.get(n).getPositionObject(),r=this.strategy.gridSize(this.container),h=this.strategy.calculateEmptyArea(o,n),l=o.height,d=o.width,u=s(e.toElement||e.originalEvent.target);this.strategy.model.currentFoundation.components.selectComponent(n),(u.hasClass("ui-resizable-w")||u.hasClass("ui-resizable-nw")||u.hasClass("ui-resizable-sw"))&&(d=o.x+o.width-h.x),(u.hasClass("ui-resizable-e")||u.hasClass("ui-resizable-ne")||u.hasClass("ui-resizable-se"))&&(d=h.x+h.width-o.x),(u.hasClass("ui-resizable-n")||u.hasClass("ui-resizable-ne")||u.hasClass("ui-resizable-nw"))&&(l=o.y+o.height-h.y),(u.hasClass("ui-resizable-s")||u.hasClass("ui-resizable-se")||u.hasClass("ui-resizable-sw"))&&(l=h.y+h.height-o.y),t.resizable("option",{maxHeight:Math.ceil(l*r.y),maxWidth:Math.ceil(d*r.x)})},_onDashletResizeStop:function(e,i){var t=s(e.target).attr(a.COMPONENT_ID_ATTRIBUTE),n=this.strategy.model.currentFoundation.components.get(t),h=this.strategy.gridSize(this.container),l={x:Math.round(i.position.left/h.x),y:Math.round(i.position.top/h.y),width:Math.round(i.size.width/h.x),height:Math.round(i.size.height/h.y)};this.strategy.updateLayout(t,l),(n.hasChanged("width")||n.hasChanged("height"))&&o.trigger(r.SAVE_DASHBOARD_STATE),i.element.css(n.getCssPosition())},_initResizable:function(e){if(!e.hasClass("inputControlWrapper")){var i=this.strategy.gridSize(this.container);this._destroyResizable(e),e.resizable({handles:"all",containment:"parent",minWidth:Math.floor(i.x),minHeight:Math.floor(i.y),grid:[Math.floor(i.x),Math.floor(i.y)],start:n.bind(this._onDashletResizeStart,this),stop:n.bind(this._onDashletResizeStop,this)}).on("resize",function(e){e.stopPropagation()}),this._fixResizeHandlePositions(e)}},_destroyResizable:function(e){try{e.resizable("destroy")}catch(e){}},_fixResizeHandlePositions:function(e){var i=this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletMargin")-3;e.find(".ui-resizable-n, .ui-resizable-ne, .ui-resizable-nw").css({top:i+"px"}),e.find(".ui-resizable-e, .ui-resizable-se, .ui-resizable-ne").css({right:i+"px"}),e.find(".ui-resizable-s, .ui-resizable-se, .ui-resizable-sw").css({bottom:i+"px"}),e.find(".ui-resizable-w, .ui-resizable-sw, .ui-resizable-nw").css({left:i+"px"})}})});