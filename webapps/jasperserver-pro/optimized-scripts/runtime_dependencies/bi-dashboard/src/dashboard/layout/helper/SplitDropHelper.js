/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../dashboardSettings","../../enum/dashboardComponentTypes","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","./BasicHelper"],function(t,e,i){var r=t("jquery"),n=t("underscore"),o=t("../../dashboardSettings"),s=t("../../enum/dashboardComponentTypes"),h=t("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),a=t("./BasicHelper");i.exports=a.extend({placement:["bottom","left","right","top"],init:function(t){this.container=t,this.helper=r("<div>").addClass("helper split-drop").appendTo(t).hide(),this.helper.position={}},drag:function(t,e){var i,n=r(t.toElement||t.originalEvent.target);if(n.hasClass("dragHelper")?n=this.lastTarget:this.lastTarget=n,!(n=n[0]===this.helper[0]?this.helper.element:n.parents("["+o.COMPONENT_ID_ATTRIBUTE+"]"))||!n.length)return void this.helper.hide();if(n.hasClass("dashboardLevelPropertiesDialog")||n.parents(".dashboardLevelPropertiesDialog").length)return void this.helper.hide();var a=n.attr(o.COMPONENT_ID_ATTRIBUTE),d=this.strategy.model.currentFoundation.components.get(a);if(d.get("type")===s.INPUT_CONTROL&&(d=d.getParent(),a=d.get("id"),n=this.container.find("["+o.COMPONENT_ID_ATTRIBUTE+'="'+a+'"]')),e.resourceType===s.INPUT_CONTROL&&this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletFilterShowPopup"))return void this.helper.hide();d.get("type")===s.FILTER_GROUP&&e.resourceType===h.INPUT_CONTROL?i=d.getPositionObject():e.resourceType===h.INPUT_CONTROL&&d.get("type")!==s.FILTER_GROUP&&this.strategy.model.currentFoundation.components.findWhere({type:s.FILTER_GROUP})?i=this.strategy.model.currentFoundation.components.findWhere({type:s.FILTER_GROUP}).getPositionObject():(i=this.detectPosition(t,n[0]),i=this.adjustPlacement(this.getPosition(n),this.detectPlacement(i))),this.helper.element=n,this.helper.css(this.strategy.cellCSS(i)).show()},stop:function(t){this.helper.hide()},drop:function(t,e,i){var n,a,d=r(t.toElement||t.originalEvent.target);if(d.hasClass("dragHelper")?d=this.lastTarget:this.lastTarget=d,(d=d[0]===this.helper[0]?this.helper.element:d.parents("["+o.COMPONENT_ID_ATTRIBUTE+"]"))&&d.length){var p=d.attr(o.COMPONENT_ID_ATTRIBUTE),l=this.strategy.model.currentFoundation.components.get(p),c=e.helper.data("data");if(l.get("type")===s.INPUT_CONTROL&&(l=l.getParent(),p=l.get("id"),d=this.container.find("["+o.COMPONENT_ID_ATTRIBUTE+'="'+p+'"]')),l.get("type")!==s.FILTER_GROUP||!c||c.resourceType!==h.INPUT_CONTROL){n=this.getPosition(d),a=this.detectPosition(t,d[0]),a=this.adjustPlacement(n,this.detectPlacement(a));for(var g in a)a.hasOwnProperty(g)&&(i[g]=a[g]);this.strategy.updateLayout(d.attr(o.COMPONENT_ID_ATTRIBUTE),n)}}},deinit:function(){this.helper.remove()},getPosition:function(t){return this.strategy.model.currentFoundation.components.get(t.attr(o.COMPONENT_ID_ATTRIBUTE)).getPositionObject()},detectPosition:function(t,e){var i=e.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top,width:i.width||i.right-i.left,height:i.height||i.bottom-i.top}},detectPlacement:function(t){var e;return e=2*(t.x/t.y>t.width/t.height),e|=(t.width-t.x)/t.y>t.width/t.height,this.placement[e]},adjustPlacement:function(t,e){var i=n.clone(t);return"left"!==e&&"right"!==e||(i.width=parseInt(i.width/2),t.width-=i.width),"top"!==e&&"bottom"!==e||(i.height=parseInt(i.height/2),t.height-=i.height),"left"===e&&(t.x+=i.width),"right"===e&&(i.x+=t.width),"top"===e&&(t.y+=i.height),"bottom"===e&&(i.y+=t.height),i}})});