/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","runtime_dependencies/js-sdk/src/common/bi/component/util/biComponentUtil","runtime_dependencies/js-sdk/src/common/bi/error/biComponentErrorFactory","runtime_dependencies/js-sdk/src/common/bi/error/SchemaValidationBiComponentError","runtime_dependencies/js-sdk/src/common/bi/component/BiComponent","./model/DashboardBiComponentStateModel","../../dashboard/dashboardSettings","../../dashboard/view/base/CanvasView","../../dashboard/enum/dashboardComponentTypes","../../dashboard/model/DashboardModel","../../dashboard/factory/sandboxFactory","runtime_dependencies/js-sdk/src/common/logging/logger","json!./schema/Dashboard.json","json!./schema/DashboardComponent.json","../../dashboard/util/DashboardExportUtils","json!./schema/DashboardExport.json"],function(e,n,r){function t(e,n){var r=w(n).first();if(!r.length||"1"!=r[0].nodeType){var t=F.containerNotFoundError(n);return B.error(t.toString()),e.reject(t),!1}return r}function o(e,n,r,o,a){var i=t(e,n.properties.container);if(i){var s=r.$el;s.addClass("jr"),i.empty(),!i.height()&&s.height(S.DASHBOARD_CONTAINER_HEIGHT),i.html(s);for(var d=0;d<r.componentViews.length;d++)r.componentViews[d].trigger("componentAttached",r.componentViews[d]);a.set("_rendered",!0),o&&e.resolve(o)}}function a(e,n){e.data.parameters=_.map(n.currentFoundation.wiring.filter(function(e){return e.component.isValueProducer()}),function(e){return{id:e.component.get("type")===P.INPUT_CONTROL||e.component.get("type")===P.VALUE?e.component.id:e.id,value:e.value}})}function i(e,n,r,i,d,c){var p,u=this.validate(),l=this,m=r.cid;if(u)return p=F.validationError(u),B.error(p.toString()),void e.reject(p);if(d.state.set(d.toJSON()),d.get("_fetched")){var f=d.state.changedAttributes(),h={setParams:new w.Deferred,runReports:new w.Deferred,render:new w.Deferred};if(f&&"params"in f){var v,b=n.data.parameters,y=[],D={};v=_.reduce(b,function(e,r){return r.id in n.properties.params&&(e[r.id]=n.properties.params[r.id]),e},{});for(var C in v){var E=r.currentFoundation.components.get(C);E&&E.prepareForAcquire(v)}r.currentFoundation.components.setMuteFilterPanels(!0);for(var C in v){var E=r.currentFoundation.components.get(C);if(E)y.push(E.acquireValue(v));else if(_.isString(C)&&C.indexOf(":")>-1){var A,R=C.split(":");E=r.currentFoundation.components.get(R[0]),E&&E.has("outputParameters")&&(A=_.findWhere(E.get("outputParameters"),{id:R[1]}))&&(D[E.id]||(D[E.id]={model:E,signals:{}}),D[E.id].signals[A.id]=v[C])}}_.forEach(_.values(D),function(e){e.model.notify(e.signals)}),h.runReports.done(function(){w.when.apply(w,y).done(function(){r.currentFoundation.components.setMuteFilterPanels(!1),r.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(),h.setParams.resolve()}).fail(function(){r.currentFoundation.components.setMuteFilterPanels(!1)})}).fail(function(){r.currentFoundation.components.setMuteFilterPanels(!1)})}else h.setParams.resolve();return f&&("linkOptions"in f||"report"in f)?("linkOptions"in f&&g(n.properties.linkOptions,m),"report"in f&&N.get(m).set("reportSettings",j.cloneDeep(n.properties.report)),w.when.apply(this,s(i,n)).done(h.runReports.resolve).fail(h.runReports.reject)):h.runReports.resolve(),f&&"container"in f?w.when(h.setParams,h.runReports).done(function(){o(h.render,n,i,!0,d)}):h.render.resolve(),w.when.apply(w,_.values(h)).done(function(){e.resolve(l.data())}).fail(e.reject),e}n.properties.container&&!t(e,n.properties.container)||(S.CONTEXT_PATH=n.properties.server,r.set("uri",n.properties.resource),r.contextPath=n.properties.server,j.createReadOnlyProperty(this,"server",n,!0,d),j.createReadOnlyProperty(this,"resource",n,!0,d),r.once("resourcesDataFetched",function(){var e=_.findWhere(r.get("foundations"),{id:r.get("defaultFoundation")}),t=r.resources.get(e.components).resource.content;for(var o in n.properties.params)if(n.properties.params.hasOwnProperty(o)){var a=_.findWhere(t,{id:o});if(a)a.value=n.properties.params[o];else if(_.isString(o)&&o.indexOf(":")>-1){var i,s=o.split(":");a=_.findWhere(t,{id:s[0]}),a&&a.outputParameters&&(i=_.findWhere(a.outputParameters,{id:s[1]}))&&(i.value=n.properties.params[o])}}}),r.fetch().done(function(){d.set("_fetched",!0),i.componentViews.length&&w.when.apply(w,_.pluck(i.componentViews,"ready")).then(function(){i.ready.resolve(),d.set("_canvasReady",!0)}),i.enableAutoRefresh(),a(n,r),n.data.components=r.currentFoundation.components.getComponents(),c.listenTo(r.currentFoundation.components,"change add reset remove paramsModelChanged",function(){n.data.components=r.currentFoundation.components.getComponents()}),n.properties.linkOptions&&g(n.properties.linkOptions,r.cid),N.get(m).set("reportSettings",j.cloneDeep(n.properties.report)),n.properties.container?o(e,n,i,l.data(),d):e.resolve(l.data())}).fail(function(n){p=F.requestError(n),B.error(p.toString()),e.reject(p)}))}function s(e,n){var r=e.componentViews.filter(function(e){return e.model.isVisualization()&&e.model.get("type")!==P.WEB_PAGE_VIEW});return _.map(r,function(e){return e.component.run()})}function d(e,n,r,t){o(e,n,r,r.$el[0],t)}function c(e,n,r,t,o){o.stopListening(),r.remove(),N.get(n).set("linkOptions",null),t.set("_destroyed",!0),e.resolve()}function p(e,n,r,t,o,a,s){if(_.isUndefined(e)){(r.get("_fetched")?t.refresh():i.call(this,n,o,a,t,r,s)).done(n.resolve).fail(n.reject)}else{if(!r.get("_fetched"))throw new Error("Cannot refresh dashboard component without running dashboard");var d,c=_.findWhere(a.currentFoundation.components.getComponents(),{id:e});if(!c)throw new Error("Component with id '"+e+"' was not found");d=t.getComponentViewByComponentId(e),d&&d.refresh?d.refresh().then(n.resolve,n.reject):n.resolve()}}function u(e,n,r,t,o,a,i){if(_.isUndefined(e))r.get("_fetched")?t.cancel().done(n.resolve).fail(n.reject):n.resolve();else if(r.get("_fetched")){var s,d=_.findWhere(a.currentFoundation.components.getComponents(),{id:e});if(!d)throw new Error("Component with id '"+e+"' was not found");s=t.getComponentViewByComponentId(e),s&&s.cancel?s.cancel().then(n.resolve,n.reject):n.resolve()}else n.resolve()}function l(e,n,r,t,o,a){return function(i){var s,d,c,p,u=new w.Deferred;if(r.get("_destroyed"))s=F.alreadyDestroyedError(),B.error(s.toString()),u.reject(s);else try{_.isString(arguments[0])?(d=arguments[1],c=arguments[2],p=arguments[3]):(d=arguments[0],c=arguments[1],p=arguments[2]),d&&_.isFunction(d)&&u.done(d),c&&_.isFunction(c)&&u.fail(c),p&&_.isFunction(p)&&u.always(p),e.call(this,i,u,r,n,t,o,a)}catch(e){s=F.javaScriptException(e),B.error(s.toString()),u.reject(s)}return u}}function m(e,n,r,t,o){return function(a,i,s,d){var c,p,u=new w.Deferred;if(r.get("_destroyed"))p=F.alreadyDestroyedError(),B.error(p.toString()),u.reject(p);else try{c=j.validateObject(I,a),c?(u=new w.Deferred,p=F.validationError(c),B.error(p.toString()),u.reject(p)):u=e.call(this,a,u,n,t,o)}catch(e){u=new w.Deferred,p=F.javaScriptException(e),B.error(p.toString()),u.reject(p)}return u.done(i).fail(s).always(d),u}}function f(e,n,r,t,o){var a,i=this,n=new w.Deferred;return this.dashboardCanvas=r,this.model=o,this.contextPath=t.properties.server,V.requestDashboardExport(this,e.outputFormat).done(function(e){i.currentExportId=e.id,n=V.wait.call(i,i.currentExportId,n)}).fail(function(e){a=F.javaScriptException(e),B.error(a.toString()),n.reject(a)}),n}function h(e,n){return function(){var r,t,o,a,i,s=new w.Deferred,d=!1;if(n.get("_destroyed"))r=F.alreadyDestroyedError(),B.error(r.toString()),s.reject(r);else if(n.get("_rendered"))try{if(_.isArray(arguments[0]))t=arguments[0],o=arguments[1],a=arguments[2],i=arguments[3];else if(_.isString(arguments[0]))d=!0,t=[_.extend({},arguments[1],{id:arguments[0]})],o=arguments[2],a=arguments[3],i=arguments[4];else{if(_.isFunction(arguments[0])||_.isUndefined(arguments[0]))throw new Error("Invalid arguments supplied. No component to update");d=!0,t=[arguments[0]],o=arguments[1],a=arguments[2],i=arguments[3]}o&&_.isFunction(o)&&s.done(o),a&&_.isFunction(a)&&s.fail(a),i&&_.isFunction(i)&&s.always(i);var c,p=_.map(t,function(n){return v(e,n)}),u=_.find(p,function(e){return e instanceof E});u?s.reject(u):(c=_.map(p,function(n){var r=e.currentFoundation.components.get(n.id);return r.updateFromDashboardComponentObject(n),r.toDashboardComponentObject()}),d&&(c=c[0]),s.resolve(c))}catch(e){r=F.javaScriptException(e),B.error(r.toString()),s.reject(r)}else r=F.notYetRenderedError(),B.error(r.toString()),s.reject(r);return s}}function v(e,n){var r=_.findWhere(e.currentFoundation.components.getComponents(),{id:n.id});if(!r)throw new Error("Component with such name or id '"+n.id+"' was not found");var t=_.omit(_.extend(r,n),"id","type","name","position"),o=j.validateObject(k,t);return o?F.validationError(o):_.extend(t,{id:n.id})}function g(e,n){e&&N.get(n).set("linkOptions",j.cloneDeep(e))}function b(e,n,r,t,o,a,i){return o.prevUndoRedoOp.always(function(){r.currentFoundation.components.once("parametersState:operationFinished",function(){e.resolve()}),i?r.currentFoundation.components.resetParametersState():r.currentFoundation.components.popParametersState(-1),r.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)}),o.prevUndoRedoOp=e,e.promise()}function y(e,n,r,t,o,a){return o.prevUndoRedoOp.always(function(){r.currentFoundation.components.once("parametersState:operationFinished",function(){e.resolve()}),r.currentFoundation.components.popParametersState(1),r.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)}),o.prevUndoRedoOp=e,e.promise()}function D(e,n,r,t){return function(r){if(t.get("_destroyed"))throw F.alreadyDestroyedError();var o=this;return r&&_.isObject(r)&&_.keys(r).length?(e.events||(e.events={}),_.each(e.events,function(e,r){_.isFunction(e)&&(r===q.CAN_REDO?n.stopListening(t,"change:_canRedo"):r===q.CAN_UNDO?n.stopListening(t,"change:_canRedo"):r===q.CANVAS_READY&&n.stopListening(t,"change:_canvasReady"))}),_.each(r,function(n,r){_.isFunction(n)&&(r===q.CAN_UNDO?e.events[r]=function(){n.call(o,t.get("_canUndo"))}:r===q.CAN_REDO?e.events[r]=function(){n.call(o,t.get("_canRedo"))}:r===q.CANVAS_READY&&(e.events[r]=function(){n.call(o,t.get("_canvasReady"))}))}),_.each(e.events,function(e,r){_.isFunction(e)&&(r===q.CAN_REDO?n.listenTo(t,"change:_canRedo",e):r===q.CAN_UNDO?n.listenTo(t,"change:_canUndo",e):r===q.CANVAS_READY&&n.listenTo(t,"change:_canvasReady",e))}),o):o}}var _=e("underscore"),w=e("jquery"),C=e("backbone"),j=e("runtime_dependencies/js-sdk/src/common/bi/component/util/biComponentUtil"),F=e("runtime_dependencies/js-sdk/src/common/bi/error/biComponentErrorFactory"),E=e("runtime_dependencies/js-sdk/src/common/bi/error/SchemaValidationBiComponentError"),A=e("runtime_dependencies/js-sdk/src/common/bi/component/BiComponent"),R=e("./model/DashboardBiComponentStateModel"),S=e("../../dashboard/dashboardSettings"),O=e("../../dashboard/view/base/CanvasView"),P=e("../../dashboard/enum/dashboardComponentTypes"),x=e("../../dashboard/model/DashboardModel"),N=e("../../dashboard/factory/sandboxFactory"),T=e("runtime_dependencies/js-sdk/src/common/logging/logger"),U=e("json!./schema/Dashboard.json"),k=e("json!./schema/DashboardComponent.json"),V=e("../../dashboard/util/DashboardExportUtils"),I=e("json!./schema/DashboardExport.json"),B=T.register("Dashboard"),W=_.keys(U.properties),M=["properties"],H=["data"],q={CAN_UNDO:"canUndo",CAN_REDO:"canRedo",CANVAS_READY:"__canvasReady__"},L=function(e){e||(e={});var n,r={properties:_.extend({report:{chart:{},loadingOverlay:!0}},e),data:{components:[],parameters:[]}},t=new R(j.cloneDeep(r.properties)),o=new x,s=_.extend({},C.Events),v=o.cid,g=new O({model:o,dashboardId:v});t.prevUndoRedoOp=(new w.Deferred).resolve(),j.createInstancePropertiesAndFields(this,r,W,M,H,t),s.listenTo(o.currentFoundation.components,"parametersState:canUndo",_.bind(t.set,t,"_canUndo")),s.listenTo(o.currentFoundation.components,"parametersState:canRedo",_.bind(t.set,t,"_canRedo")),n=this.data,_.extend(this,{validate:j.createValidateAction(r,U,t),run:j.createDeferredAction(i,t,r,o,g,t,s),render:j.createDeferredAction(d,t,r,g,t),refresh:l(p,g,t,r,o,s),cancel:l(u,g,t,r,o,s),destroy:j.createDeferredAction(c,t,v,g,t,s),updateComponent:h(o,t),undoParams:j.createDeferredAction(b,t,r,o,g,t,s),undoAllParams:j.createDeferredAction(b,t,r,o,g,t,s,!0),redoParams:j.createDeferredAction(y,t,r,o,g,t,s),events:D(r,s,o,t),export:m(f,g,t,r,o),data:function(){return a(r,o),n.apply(this,arguments)}})};L.prototype=new A,_.extend(L,{componentTypes:_.without(_.values(P),P.DASHBOARD_PROPERTIES),componentIdDomAttribute:S.COMPONENT_ID_ATTRIBUTE,canvas:{width:S.GRID_WIDTH,height:S.GRID_HEIGHT},exportFormats:["pdf","png","docx","pptx","odt"]}),r.exports=L});