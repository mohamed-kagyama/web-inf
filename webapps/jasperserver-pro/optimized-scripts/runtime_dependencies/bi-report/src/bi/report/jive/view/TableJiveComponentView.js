/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","./BaseJiveComponentView","underscore","bundle!jasperreports_messages","../factory/headerToolbarViewFactory","./overlay/JiveOverlayView","./overlay/ColumnResizeMarkerView","../jr/dialogs/TableFilterDialog","../jr/dialogs/TableFormatDialog","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","./predicate/showColumnOptionPredicate","./predicate/hideColumnOptionPredicate","../enum/jiveActions","jquery","text!./overlay/template/dragLabelTemplate.htm","runtime_dependencies/js-sdk/src/common/logging/logger","jquery-ui/ui/widgets/draggable","jquery-ui/ui/position"],function(e,t,o){function i(){this.overlay&&this.overlay.hide(),this.headerToolbar&&this.headerToolbar.hide(),this.resizeMarker&&this.resizeMarker.hide(),this.currentColumnData=null}function r(e,t,o){var i=t.get("message");p.isFunction(this[i])&&this[i](t,e)}function l(e){var t=P(e.currentTarget),o=this.getColumnData(t);this.currentColumnData=o;var i=this.model.columns,r=o.$header.data("coluuid");i.some(function(e){return e.get("id")===r})&&this.selectColumn(r,o)}function s(e,t){this.resizingColumn=!0}function n(e,t){this.overlay.$el.width(t.position.left-this.overlay.$el.position().left)}function a(e,t){var o=this.model.get("scaleFactor")||1,i=(t.position.left-this.overlay.$el.position().left)/o;this.currentColumn.resize({width:i<8?8:Math.floor(i)}),this.resizingColumn=!1}function h(){var e,t,o,i,r,l=[],s=this.model.get("id");this.visibleColumnsMoveData=[];var n,a=this.reportContainer.find("table.jrPage td.jrcolHeader[data-tableuuid='"+s+"']").first();a.parents("table").each(function(e,t){if(n=P(t),l=n.find("td.jrcolHeader[data-tableuuid='"+s+"']"),l.length>0)return!1}),this.$scrollContainer||(this.$scrollContainer=P(this.stateModel.get("container")));var h=this.$scrollContainer.scrollLeft(),d={};for(t=0;t<l.length;t++){var c,u,f,g,m,v=P(l.get(t)).data("coluuid");d[v]||(c=n.find("td.jrcolHeader[data-coluuid='"+v+"']"),u=c.eq(0),f=c.length>0?c.eq(c.length-1):u,g=u.outerWidth(),m=u.position().left,c.each(function(e,t){var o=P(t);o.position().left<m&&(g+=m-o.position().left,m=o.position().left),o.position().left+o.outerWidth()>m+g&&(g=o.position().left+o.outerWidth()-m)}),d[v]={width:g,height:f.position().top-u.position().top+f.height(),colidx:f.data("colidx"),uuid:u.data("coluuid"),cellid:u.data("cellid"),offsetLeft:u.offset().left+h})}l=[];for(r in d)d.hasOwnProperty(r)&&l.push(d[r]);for(l.sort(function(e,t){return e.colidx-t.colidx}),t=0;t<l.length;t++)e=l[t],o=e.offsetLeft,i=p.findWhere(this.model.config.allColumnsData,{uuid:e.uuid}),null!=i&&(i.visible=!0),this.visibleColumnsMoveData.push({left:o,right:o+e.width,width:e.width,index:null!=i?i.index:null,uuid:e.uuid})}function d(e,t){this.currentColMoveData=p.findWhere(this.visibleColumnsMoveData,{uuid:this.currentColumn.get("id")}),this.colToMoveToIndex=this.currentColMoveData.index,this.prevPageX=e.pageX+this.$scrollContainer.scrollLeft()}function c(e,t,o,i){var r=null;return{apply:function(){var l=arguments;i?e.apply(t,l):(clearTimeout(r),r=setTimeout(function(){r=null,e.apply(t,l)},o))},isRunning:function(){return null!=r},cancelAndExecute:function(){null!=r&&(clearTimeout(r),e.apply(t,arguments))}}}function u(e,t){var o,i,r,l,s,n=this.visibleColumnsMoveData.length,a=this.colToMoveToIndex,h=this.$scrollContainer,d=h.scrollLeft(),c=e.pageX+d;c>this.currentColMoveData.right?l=!0:c<this.currentColMoveData.left&&(l=!1);var u=null;for(o=0;o<n;o++)if(i=this.visibleColumnsMoveData[o],c<=i.right){a=parseInt(i.index),r=i.left+i.width/2,c<=r?(this.resizeMarker.$el.offset({left:i.left-d}),!0===l?u=a>0?a-1:0:!1===l&&(u=a)):(this.resizeMarker.$el.offset({left:i.right-d}),!0===l?u=a:!1===l&&(u=a+1));break}var f=parseInt(this.visibleColumnsMoveData[n-1].index);if((null===u&&c>i.right||u>f)&&(this.resizeMarker.$el.offset({left:i.right-d}),u=f),this.colToMoveToIndex=u,s=i,c>this.prevPageX){if(h.offset().left+h.width()+d-5<s.right&&!this.isScrollingRight){this.isScrollingRight=!0;var g=this;h.animate({scrollLeft:"+="+(s.width+10)},{duration:1e3,queue:!1}).promise().then(function(){g.isScrollingRight=!1})}}else if(s.left-d-5<=h.offset().left&&!this.isScrollingLeft){this.isScrollingLeft=!0;var g=this;h.animate({scrollLeft:"-="+(s.width-10)},{duration:1e3,queue:!1}).promise().then(function(){g.isScrollingLeft=!1})}this.prevPageX=c}function f(e,t){null!=this.colToMoveToIndex&&this.colToMoveToIndex!=this.currentColumn.get("columnIndex")&&this.currentColumn.move({index:this.colToMoveToIndex})}var g=e("./BaseJiveComponentView"),p=e("underscore"),m=e("bundle!jasperreports_messages"),v=e("../factory/headerToolbarViewFactory"),b=e("./overlay/JiveOverlayView"),C=e("./overlay/ColumnResizeMarkerView"),T=e("../jr/dialogs/TableFilterDialog"),y=e("../jr/dialogs/TableFormatDialog"),M=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),w=e("./predicate/showColumnOptionPredicate"),D=e("./predicate/hideColumnOptionPredicate"),j=e("../enum/jiveActions"),P=e("jquery"),x=e("text!./overlay/template/dragLabelTemplate.htm"),k=e("runtime_dependencies/js-sdk/src/common/logging/logger");e("jquery-ui/ui/widgets/draggable"),e("jquery-ui/ui/position");var _=k.register("TableJiveComponentView");o.exports=g.extend({init:function(){this.reportContainer=this.getReportContainer(this.getReportId()),this.setGenericProperties(this.model.config.genericProperties),this.initJiveComponents(this.reportContainer),this.initTableEvents()},initTableEvents:function(){var e=this.model.get("id");this.headerToolbar&&this.listenTo(this.headerToolbar,"select",p.bind(r,this)),this.overlay&&this.listenTo(this.overlay,"overlayClicked",p.bind(i,this)),this.tableElement=this.getReportContainer(this.getReportId()),this.tableElement.on("click touchend",".jrPage td.jrcolHeader.interactiveElement[data-tableuuid="+e+"]",p.bind(l,this)),this.tableElement.on("click touchend",".jrPage td.jrcel[data-tableuuid="+e+"]",p.bind(l,this)),this.resizeMarker&&(this.listenTo(this.resizeMarker,"marker:dragStart",p.bind(s,this)),this.listenTo(this.resizeMarker,"marker:drag",p.bind(n,this)),this.listenTo(this.resizeMarker,"marker:dragStop",p.bind(a,this))),this.stateModel.isFloatingTableHeaderEnabled()&&this.model.get("hasFloatingHeader")&&(this.$scrollContainer=P(this.stateModel.get("container")),this.$scrollContainer.on("scroll",p.throttle(p.bind(this._scrollHeader,this),100,{leading:!0,trailing:!0})),this.scrollData={bMoved:!1,reportContainerPositionAtMove:null})},initJiveComponents:function(e){var t=this;this.overlay=new b({parentElement:e}),this.filterDialog=new T({i18n:m}),this.formatDialog=new y({i18n:m}),this.headerToolbar=v(this.model.get("type"),{parentElement:e,children:this.getHoverMenuChildren(),hideColumnOptionTestFn:p.partial(D,this.model.config.allColumnsData),showColumnsOptionTestFn:p.partial(w,this.model.config.allColumnsData)}),this.headerToolbar.$el.addClass("jr_table"),this.resizeMarker=new C({parentElement:e});var o=c(u,t,50);this.overlay.$el.draggable({cursorAt:{top:40,left:-30},scroll:!1,start:function(e,o){d.call(t,e,o)},drag:function(e,t){o.apply(e,t)},stop:function(e,i){o.isRunning()&&o.cancelAndExecute(e,i),f.call(t,e,i)},helper:function(e){return P(p.template(x,{i18n:m})).show()}}),h.call(this)},sort:function(e){var t=e.get("order");t&&this.currentColumn.sort({order:t})},filter:function(e,t){this.filterDialog.open(this.currentColumn)},format:function(e,t){this.formatDialog.open(this.currentColumn)},hideColumn:function(e){this.currentColumn.hide()},showColumn:function(e){var t=e.get("index");this.currentColumn.unhide(p.isArray(t)?t:[t])},setGenericProperties:function(e){this.genericProperties=e},getGenericProperties:function(){return this.genericProperties},getHoverMenuChildren:function(){var e=[],t=this.model,o=p.reduce(t.config.allColumnsData,function(o,i){return i&&i.interactive&&(e.push(i.index),o.push({label:i.label,id:i.uuid,message:j.SHOW_COLUMN,action:"select",index:i.index,test:function(){return!p.find(t.columns,function(e){return e&&e.get("id")===i.uuid})}})),o},[]);return o.unshift({label:m["net.sf.jasperreports.components.headertoolbar.label.showcolumns.all"],action:"select",message:j.SHOW_COLUMN,index:e}),o},getColumnData:function(e){var t,o,i=e.hasClass("jrcolHeader")?e.data("cellid"):e.attr("class").split(" ")[1].substring(4),r=this.reportContainer.find("table.jrPage td.jrcolHeader[data-cellid='"+i+"']"),l=r.eq(0),s=null,n=l.offset().left,a=this.model.get("scaleFactor");return t=o=l.outerWidth(),r.each(function(e,i){var r=P(i);r.offset().left<n&&(o+=n-r.offset().left,n=r.offset().left),r.offset().left+r.outerWidth()>n+o&&(o=r.offset().left+r.outerWidth()-n,t+=r.outerWidth())}),i=(""+i).replace(/\./g,"\\."),l.parents().each(function(e,t){var o,r=P("td.cel_"+i+":last",t);if(r&&r.length>0)return o=r.css("height"),o=o.substring(0,o.indexOf("px")),s=r.offset().top+parseFloat(o)*a-l.offset().top,!1}),{$header:l,width:t*a,height:s||l.outerHeight()*a}},setCurrentColumn:function(e){this.currentColumn=p.find(this.model.columns,function(t){return t&&t.get("id")===e})},selectColumn:function(e,t){var o=t.$header;this.setCurrentColumn(e),this.overlay.css({width:t.width,height:t.height}).show().setPosition({my:"left top",at:"left top",of:o,collision:"none"}),this.scrollData&&this.scrollData.bMoved?(this.headerToolbar.show(!0),this._setToolbarPositionWhenFloating(this._getHeaderTable())):this.headerToolbar.show(!0).setPosition({my:"left bottom+1",at:"left top",of:o,collision:"none"}),this.currentColumn.get("canSort")?(this.headerToolbar.buttons.enable("sortAsc"),this.headerToolbar.buttons.enable("sortDesc")):(this.headerToolbar.buttons.disable("sortAsc"),this.headerToolbar.buttons.disable("sortDesc")),this.currentColumn.get("canFilter")?this.headerToolbar.buttons.enable("filter"):this.headerToolbar.buttons.disable("filter"),this.resizeMarker.css({height:t.height}).show().setPosition({my:"left top",at:"right top",of:this.overlay.$el,collision:"none"})},render:function(e){var t=new P.Deferred;return this.setDataReportId(e,this.getReportId()),this.errorDialog=new M({additionalCssClasses:"jive_dialog"}),this.listenTo(this.model,"serverError",this.showError),this.stateModel.isDefaultJiveUiEnabled()?(this.init(),this.overlay&&this.overlay.render(),this.headerToolbar&&this.headerToolbar.render(),this.resizeMarker&&this.resizeMarker.render(),_.debug("Apply table jive component: ",this.jiveColumn),t.resolve(),t):(t.resolve(),t)},showError:function(e){this.errorDialog.setMessage(e.devmsg),this.errorDialog.open()},detachEvents:function(){this.tableElement&&this.tableElement.off()},remove:function(){this.overlay&&this.overlay.remove(),this.filterDialog&&this.filterDialog.remove(),this.formatDialog&&this.formatDialog.remove(),this.resizeMarker&&this.resizeMarker.remove(),this.headerToolbar&&this.headerToolbar.remove(),this.$scrollContainer&&this.$scrollContainer.find("table.jr_floating_header").remove(),g.prototype.remove.call(this,arguments)},_scrollHeader:function(e){var t=this.$scrollContainer,o=!1,i=!1,r=this.scrollData;if(null!=r.scrollTop?t.scrollTop()!=r.scrollTop&&(r.scrollTop=t.scrollTop(),o=!0):0!==t.scrollTop()&&(r.scrollTop=t.scrollTop(),o=!0),null!=r.scrollLeft?t.scrollLeft()!=r.scrollLeft&&(r.scrollLeft=t.scrollLeft(),i=!0):0!==t.scrollLeft()&&(r.scrollLeft=t.scrollLeft(),i=!0),i||o||e){var l=t.find("td.jrcolHeader").first();if(l.length){var s=this._getHeaderTable(l),n=l.closest("table"),a=t.offset().top,h=l.closest("tr").offset().top,d=l.closest("table").find("td.jrcel").last(),c=d.length?d.offset().top-s.outerHeight()-a:-1,u=this.model.get("scaleFactor");!r.bMoved&&h-a<0&&c>0?(s.show(),u?(this._applyScaleTransform(s,u),s.offset({top:a,left:n.offset().left}),s.offset({top:a,left:n.offset().left})):s.offset({top:a,left:n.offset().left}),this._setToolbarPositionWhenFloating(s),r.bMoved=!0,r.reportContainerPositionAtMove||(r.reportContainerPositionAtMove=a)):r.bMoved&&h-a<0&&c>0?(s.show(),u?(this._applyScaleTransform(s,u),s.offset({top:a,left:n.offset().left})):s.offset({top:a,left:n.offset().left}),this._setToolbarPositionWhenFloating(s)):r.bMoved&&(s.hide(),r.bMoved=!1,this._setToolbarDefaultPosition())}}},_getHeaderTable:function(e){var t=this.$scrollContainer.find("table.jr_floating_header");if(0===t.length){t=P("<table class='jr_floating_header' style='display:none'></table>").appendTo(this.$scrollContainer),t.on("click touchend",".jrcolHeader",function(e){if(!P(e.target).parent().is("._jrHyperLink")){var o=P(this),i=o.data("coluuid"),r=t.parent().find("table.jrPage td.jrcolHeader[data-coluuid="+i+"]:first");return r.length&&r.trigger("click"),!1}});var o,i,r,l,s,n,a,h,d,c,u,f,g,p=e.closest("table"),m=p.find("td.jrcolHeader").last(),v=[],b=[];if(e.length>0){if(i=e.closest("tr"),l=m.closest("tr"),f=e.closest("table"),i===l)v.push(i);else for(g=p.find("tr"),h=g.index(i),d=g.index(l),c=h;c<=d;c++)v.push(g.get(c));P.each(v,function(e,i){for(r=P(i),a=r.find("td"),o=P("<tr></tr>"),r.attr("valign")&&o.attr("valign",r.attr("valign")),b[e]=0,h=0,u=a.length;h<u;h++)n=P(a.get(h)),s=n.clone(),b[e]=b[e]+n.outerWidth(),s.css("width",n.css("width")),s.css("height",n.css("height")),o.append(s);t.append(o)}),t.css({position:"relative",width:Math.max.apply(Math,b),"empty-cells":f.css("empty-cells"),"border-collapse":f.css("border-collapse"),"background-color":f.css("background-color")}),t.attr("cellpadding",f.attr("cellpadding")),t.attr("cellspacing",f.attr("cellspacing")),t.attr("border",f.attr("border"))}}return t},_setToolbarPositionWhenFloating:function(e){var t,o,i=this.headerToolbar;i.$el.is(":visible")&&(t=e.find("td.jrcolHeader[data-cellid='"+this.currentColumnData.$header.data("cellid")+"']").first(),t.offset().top>e.offset().top?(o=t.offset().top-e.offset().top-i.$el.outerHeight(),o<0?i.setPosition({my:"left bottom+"+Math.abs(o),at:"left top",of:t,collision:"none"}):i.setPosition({my:"left bottom",at:"left top",of:t,collision:"none"})):i.setPosition({my:"left top",at:"left top",of:t,collision:"none"}))},_setToolbarDefaultPosition:function(){this.headerToolbar.$el.is(":visible")&&this.headerToolbar.setPosition({my:"left bottom+1",at:"left top",of:this.currentColumnData.$header})}})});