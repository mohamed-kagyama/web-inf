/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","runtime_dependencies/js-sdk/src/common/model/BaseModel","./ReportExecutionModel","../collection/ReportExportCollection","underscore","backbone","jquery","./reportStatusTrait","../enum/reportOutputFormats"],function(t,e,r){var i=t("runtime_dependencies/js-sdk/src/common/model/BaseModel"),n=t("./ReportExecutionModel"),o=t("../collection/ReportExportCollection"),s=t("underscore"),u=t("backbone"),a=t("jquery"),c=t("./reportStatusTrait"),p=t("../enum/reportOutputFormats"),d=i.extend({idAttribute:"requestId",defaults:function(){return{exports:void 0,reportURI:void 0,requestId:void 0,executionId:void 0,status:void 0,totalPages:void 0}},initialize:function(t,e){i.prototype.initialize.apply(this,arguments),e||(e={}),this.contextPath=e.contextPath,this.execution=new n({},{report:this}),this.exports=new o(this.get("exports")||[],{report:this})},urlAction:function(){var t=this.contextPath;return"/"!==t[t.length-1]&&(t+="/"),t+="rest_v2/reportExecutions/"+this.get("requestId")+"/runAction"},execute:function(t){var e=this;this.unset("status",{silent:!0}),t||(t={}),this.execution.set(s.defaults(s.extend({},t),{reportUnitUri:this.get("reportURI"),baseUrl:this.contextPath}));var r=this.execution.run().then(function(t){return e.has("executionId")&&e.set("requestId",e.get("executionId")),!!e.set(e.parse(t))&&(e.trigger("sync",e,t),a.Deferred().resolve(t))},function(t){return e.trigger("error",e,t),a.Deferred().reject(t)});return this.trigger("request",this,r),r},updateStatus:function(){var t,e=this,r=this.getExport(p.HTML);return t=!r||r.get("outputFinal")||r.get("outputEmpty")?this.execution.status().done(function(t){if(!e.set({status:t.value,errorDescriptor:t.errorDescriptor}))return!1;e.trigger("sync",e,t)}).fail(function(t){e.trigger("error",e,t)}):this.execution.pageStatus(this.execution.get("pages")).done(function(t){if(!e.set({status:t.reportStatus,pageStatus:{pageFinal:"true"===t.pageFinal,timestamp:parseInt(t.pageTimestamp)},errorDescriptor:t.errorDescriptor}))return!1;e.trigger("sync",e,t)}).fail(function(t){e.trigger("error",e,t)}),this.trigger("request",this,t),t},update:function(){var t=this,e=this.execution.update().done(function(e){if(!t.set(t.parse(e)))return!1;t.trigger("sync",t,e)}).fail(function(e){t.trigger("error",t,e)});return this.trigger("request",this,e),e},waitForExecution:function(){null!=this.updateStatusTimer&&(clearTimeout(this.updateStatusTimer),this.updateStatusTimer=null);var t=this,e=new a.Deferred,r=function r(){t.isCompleted()?e.resolve():t.updateStatusTimer=setTimeout(function(){t.updateStatus().done(r).fail(e.reject)},1e3)};return this.updateStatus().done(r).fail(e.reject),e},runAction:function(t){if(!this.has("requestId"))throw new Error("You must execute report first before running any action.");this.unset("status",{silent:!0});var e=this,r=u.ajax({url:this.urlAction(),type:"POST",dataType:"json",headers:{Accept:"application/json"},data:{action:JSON.stringify(t)}}).done(function(t){if(!e.set("requestId",t.result.contextid))return!1;e.trigger("sync",e,t)}).fail(function(t){e.trigger("error",e,t)});return this.trigger("request",this,r),r},cancel:function(){if(this.isCompleted())return(new a.Deferred).resolve();var t=this,e=this.execution.cancel().done(function(e){if(e)return!!t.set("status",e.value)&&void t.trigger("sync",t,e)}).fail(function(e){t.trigger("error",t,e)});return this.trigger("request",this,e),e},removeExecution:function(){return this.exports.each(function(t){t.cancel()}),this.exports.reset([]),this.execution.removeExecution()},applyParameters:function(t){return this.unset("status",{silent:!0}),this.execution.applyParameters(t)},getExport:function(t){return this.exports.find(function(e){return e.get("options").outputFormat===t})},addExport:function(t){return this.exports.add(t)},_notify:function(){},eventManager:{registerEvent:function(){return{trigger:function(){}}}}});s.extend(d.prototype,c),r.exports=d});