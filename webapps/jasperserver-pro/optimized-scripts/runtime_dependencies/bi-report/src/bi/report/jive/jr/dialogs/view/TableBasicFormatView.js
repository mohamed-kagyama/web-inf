/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../util/jiveDataConverter","backbone.epoxy","backbone","./TableCommonFormatView","../util/FormatModelCache","text!../template/tableBasicFormatTemplate.htm","text!../template/basicOptionTemplate.htm","text!../template/groupOptionTemplate.htm","text!../template/currencyMenuTemplate.htm","text!../template/currencyOptionTemplate.htm","../model/TableFormatModel","runtime_dependencies/js-sdk/src/common/component/menu/ContextMenu","../util/NumberFormatPatternUtil"],function(e,t,n){function a(){var e,t,n,a=this.viewModel,o=this.cache,i=a.get("applyTo"),l=a.previous("applyTo"),r=this.columnComponentModel;null!=i&&(l&&(e="heading"===l||"detailrows"===l?o.createKey(l,r):o.createKey(l,r.parent.columnGroups.findWhere({id:l}),!0),o.set(e,this.model.toJSON())),"heading"===i?(e=o.createKey(i,r),null===o.get(e)&&(n=r.headingFormat.toJSON(),n.columnLabel=r.get("columnLabel"),o.set(e,n)),this.viewModel.set("dataType","text")):"detailrows"===i?(e=o.createKey(i,r),null===o.get(e)&&(n=r.detailsRowFormat.toJSON(),n.pattern=r.detailsRowFormat.toJiveFormat(),o.set(e,n)),this.viewModel.set("dataType",r.get("dataType").toLowerCase())):(t=r.parent.columnGroups.findWhere({id:i}),e=o.createKey(i,t,!0),null===o.get(e)&&(n=t.format.toJSON(),n.pattern=t.format.toJiveFormat(),o.set(e,n)),this.viewModel.set("dataType",t.get("dataType").toLowerCase())),this.model.reset().set(o.get(e)))}function o(){var e=this.columnComponentModel,t=this.viewModel.defaults(),n=this.viewModel.get("dataType");e&&(this.viewModel.set("patterns",e.parent.config.genericProperties.patterns[n]||[]),this.viewModel.set("hasPercentage",t.hasPercentage),this.viewModel.set("hasComma",t.hasComma),this.viewModel.set("currencySymbol",t.currencySymbol))}function i(){var e=this,t=this.columnComponentModel,n=t.get("columnIndex"),a=t.parent.columnGroups,o=[],i=[],l=[],s=[];t.get("canFormatHeading")&&o.push({value:"heading",label:this.i18n["net.sf.jasperreports.components.headertoolbar.applyto.option.headings"]}),a.each(function(t){-1!=r.indexOf(t.get("forColumns"),n)&&("groupheading"===t.get("groupType")?i.push({value:t.get("id"),label:t.get("groupName")+" "+e.i18n["net.sf.jasperreports.components.headertoolbar.groupheading.prefix"]}):"groupsubtotal"===t.get("groupType")?l.push({value:t.get("id"),label:t.get("groupName")+" "+e.i18n["net.sf.jasperreports.components.headertoolbar.groupsubtotal.prefix"]}):"tabletotal"===t.get("groupType")&&s.push({value:t.get("id"),label:e.i18n["net.sf.jasperreports.components.headertoolbar.applyto.option.tabletotal"]}))}),o.push.apply(o,i),o.push({value:"detailrows",label:this.i18n["net.sf.jasperreports.components.headertoolbar.applyto.option.detailrows"]}),o.push.apply(o,l),o.push.apply(o,s),this.viewModel.set("applyToOptions",o);var p=this.viewModel.previous("applyTo");p?(this.viewModel.set("applyTo",null,{silent:!0}),r.findWhere(o,{value:p})?this.viewModel.set("applyTo",p):this.viewModel.set("applyTo","heading"===o[0].value?"heading":"detailrows")):this.viewModel.set("applyTo","heading"===o[0].value?"heading":"detailrows")}function l(){var e,t=this.viewModel.get("applyTo");e="heading"===t||"detailrows"===t?this.cache.createKey(t,this.columnComponentModel):this.cache.createKey(t,this.columnComponentModel.parent.columnGroups.findWhere({id:t}),!0),this.cache.set(e,this.model.toJSON())}var r=e("underscore"),s=e("../../../util/jiveDataConverter"),p=e("backbone.epoxy"),c=e("backbone"),m=e("./TableCommonFormatView"),h=e("../util/FormatModelCache"),u=e("text!../template/tableBasicFormatTemplate.htm"),d=e("text!../template/basicOptionTemplate.htm"),g=e("text!../template/groupOptionTemplate.htm"),y=e("text!../template/currencyMenuTemplate.htm"),v=e("text!../template/currencyOptionTemplate.htm"),f=e("../model/TableFormatModel"),b=e("runtime_dependencies/js-sdk/src/common/component/menu/ContextMenu"),T=e("../util/NumberFormatPatternUtil"),w={LOCALE_SPECIFIC:"\xa4",USD:"$",GBP:"\xa3",EUR:"\u20ac",YEN:"\xa5"},C=p.Model.extend({defaults:function(){return{dataType:"text",fontSizes:[],fontNames:[],patterns:[],applyToOptions:[],applyTo:null,hasPercentage:!1,hasComma:!1,currencySymbol:"LOCALE_SPECIFIC"}},computeds:{hasPattern:function(){var e=this.get("dataType");return"numeric"===e||"date"===e||"time"===e},hasHeading:function(){return"heading"===this.get("applyTo")}},reset:function(){return this.clear({silent:!0}).set(this.defaults()),this},remove:function(){}});n.exports=m.extend({events:{"click .jive_inputbutton[name='increaseDecimalsBtn']":"_addDecimal","click .jive_inputbutton[name='decreaseDecimalsBtn']":"_removeDecimal","click .jive_inputbutton[name='currencyBtn']":"_showCurrencyMenu"},el:function(){return r.template(u,{i18n:this.i18n})},initialize:function(){this.model=new f,this.viewModel=new C,this.cache=new h,this.listenTo(this.viewModel,"change:applyTo",r.bind(a,this)),this.listenTo(this.viewModel,"change:hasPercentage",this._togglePercentageFormat),this.listenTo(this.viewModel,"change:hasComma",this._toggleCommaFormat),this.listenTo(this.viewModel,"change:dataType",r.bind(o,this)),this.on("tabSwitched",function(){l.call(this)}),p.View.prototype.initialize.apply(this,arguments),this._initCurrencyContextMenu()},bindingHandlers:r.extend({transformedPatterns:function(e,t){var n="";r.each(t,function(e){n+=r.template(d,{value:e.key,text:e.val})}),e.html(n)},groupedOptions:function(e,t){var n=this,a="";t.extension&&r.each(t.extension,function(e,t,o){a+=r.template(g,{start:0===t,end:t==o.length-1,label:n.view.i18n["net.sf.jasperreports.components.headertoolbar.label.extfonts"],value:e,text:e})}),t.system&&r.each(t.system,function(e,t,o){a+=r.template(g,{start:0===t,end:t==o.length-1,label:n.view.i18n["net.sf.jasperreports.components.headertoolbar.label.sysfonts"],value:e,text:e})}),e.html(a)},nonGroupedOptions:function(e,t){var n="";t&&r.each(t,function(e,t,a){n+=r.template(d,{value:e,text:e})}),e.html(n)}},m.prototype.bindingHandlers),bindingFilters:{customDecimal:{get:function(e){var t=parseFloat(e);return r.isNaN(t)?null:t},set:function(e){var t=parseFloat(e);return r.isNaN(t)?null:t}}},computeds:{isDuration:function(){return s.DURATION_PATTERN===this.getBinding("pattern")},getNumericTypeVisibility:function(){var e="numeric"===this.getBinding("dataType"),t=s.DURATION_PATTERN===this.getBinding("pattern");return e&&!t?"visible":"hidden"}},setColumnComponentModel:function(e,t){var n=this.viewModel;t?l.call(this):(this.cache.clear(),n.reset(),n.set("fontSizes",e.parent.config.genericProperties.fontSizes),n.set("fontNames",e.parent.config.genericProperties.fonts)),this.columnComponentModel=e,i.call(this),this.removeBindings(),this.applyBindings()},getActions:function(){var e,t=this.cache,n=[];return l.call(this),r.each(t.map,function(a,o){var i,l=new c.Model(a.original);l.set(a.current),l.hasChanged()&&(i=t.keyInfo[o],"heading"===i.applyTo?(i.model.updateFromReportComponentObject({label:a.current.columnLabel,headingFormat:a.current}),n.push(i.model.actions["change:headingFormat"].call(i.model))):"detailrows"===i.applyTo?(e=a.current,e.pattern=T.jivePatternToSchemaPattern(e.pattern,i.model.get("dataType").toLowerCase()),i.model.updateFromReportComponentObject({detailsRowFormat:e}),n.push(i.model.actions["change:detailsRowFormat"].call(i.model))):(e=a.current,e.pattern=T.jivePatternToSchemaPattern(e.pattern,i.model.get("dataType").toLowerCase()),i.model.updateFromReportComponentObject({format:e}),n.push(i.model.actions["change:format"].call(i.model))))}),n},_initCurrencyContextMenu:function(){var e=this,t=[{label:this.i18n["net.sf.jasperreports.components.headertoolbar.label.currency.none"],action:"none",symbol:null},{label:this.i18n["net.sf.jasperreports.components.headertoolbar.label.localespecific"],action:"localeSpecific",symbol:"LOCALE_SPECIFIC"},{label:w.USD+" - USD",action:"usd",symbol:"USD"},{label:w.EUR+" - EUR",action:"eur",symbol:"EUR"},{label:w.GBP+" - GBP",action:"gbp",symbol:"GBP"},{label:w.YEN+" - YEN",action:"yen",symbol:"YEN"}];this.currencyMenu=new b(t,{menuContainerTemplate:y,menuOptionTemplate:v}),r.each(t,function(t){e.listenTo(e.currencyMenu,"option:"+t.action,e._applyCurrencyFormat)})},_togglePercentageFormat:function(e){var t=this.getBinding("patterns"),n=this.getBinding("hasPercentage"),a=[];t.length&&(r.each(t,function(e){s.DURATION_PATTERN===e.key?a.push({key:e.key,val:e.val}):a.push({key:T.addRemovePercentage(e.key,n),val:T.addRemovePercentageForNumber(e.val,n)})}),this.setBinding("patterns",a))},_toggleCommaFormat:function(e){var t=this.getBinding("patterns"),n=this.getBinding("hasComma"),a=[];t.length&&(r.each(t,function(e){s.DURATION_PATTERN===e.key?a.push({key:e.key,val:e.val}):a.push({key:T.addRemoveThousandsSeparator(e.key,n),val:T.addRemoveThousandsSeparator(e.val,n)})}),this.setBinding("patterns",a))},_addDecimal:function(e){var t=this.getBinding("patterns"),n=[];t.length&&(r.each(t,function(e){s.DURATION_PATTERN===e.key?n.push({key:e.key,val:e.val}):n.push({key:T.addRemoveDecimalPlace(e.key,!0),val:T.addRemoveDecimalPlace(e.val,!0)})}),this.setBinding("patterns",n))},_removeDecimal:function(e){var t=this.getBinding("patterns"),n=[];t.length&&(r.each(t,function(e){s.DURATION_PATTERN===e.key?n.push({key:e.key,val:e.val}):n.push({key:T.addRemoveDecimalPlace(e.key,!1),val:T.addRemoveDecimalPlace(e.val,!1)})}),this.setBinding("patterns",n))},_applyCurrencyFormat:function(e,t){var n=this.getBinding("currencySymbol"),a=t.get("symbol"),o=this.getBinding("patterns"),i=[];o.length&&(r.each(o,function(e){s.DURATION_PATTERN===e.key?i.push({key:e.key,val:e.val}):(n&&(e.key=T.addRemoveCurrencySymbol(e.key,!1,w[n]),e.val=T.addRemoveCurrencySymbol(e.val,!1,w[n])),a?i.push({key:T.addRemoveCurrencySymbol(e.key,!0,w[a]),val:T.addRemoveCurrencySymbol(e.val,!0,w[a])}):n&&i.push(e))}),i.length&&(this.setBinding("patterns",[]),this.setBinding("patterns",i))),this.setBinding("currencySymbol",a)},_showCurrencyMenu:function(e){var t=this.$(e.currentTarget),n=t.offset();e.preventDefault(),e.stopPropagation(),this.currencyMenu.show({top:n.top+t.height(),left:n.left})},clear:function(){this.cache.clear()},remove:function(){p.View.prototype.remove.apply(this,arguments),this.model&&this.model.remove(),this.cache&&this.cache.remove(),this.viewModel&&this.viewModel.remove(),this.currencyMenu&&this.currencyMenu.remove()}})});