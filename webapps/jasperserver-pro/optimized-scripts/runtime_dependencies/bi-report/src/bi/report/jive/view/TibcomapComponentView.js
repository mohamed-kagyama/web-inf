/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","./BaseJiveComponentView","../jr/tibcoGeoanalitics","runtime_dependencies/js-sdk/src/common/util/xssUtil","csslink!../jr/theme/tibco-geoanalitics.csslink.css"],function(e,t,n){var o=e("./BaseJiveComponentView"),i=e("../jr/tibcoGeoanalitics"),r=e("runtime_dependencies/js-sdk/src/common/util/xssUtil");e("csslink!../jr/theme/tibco-geoanalitics.csslink.css"),n.exports=o.extend({render:function(e){this.$reportEl=e,this.infowindow={},this._init()},_init:function(){var e=this,t=e.model.get("instanceData");e._showMap(e.model.get("id"),t)},_showMap:function(e,t){var n,o,a=this,s=t.mapData,l=t.markerList,c=t.pathsList,u={},m={};a._getCoords(s,s.customerName,s.customerKey).then(function(t){if(u.center=new i.LatLng(t.latitude,t.longitude),u.zoom=s.zoom?s.zoom:5,u.urlLocation=!1,s.minZoom&&(u.minZoom=s.minZoom),s.maxZoom&&(u.maxZoom=s.maxZoom),s.repeatX&&(u.repeatX=a._isTrue(s.repeatX,!0)),o=new i.Map(a.$reportEl.find("#"+e)[0],u),s.layerName&&(m.name=s.layerName),s.opacity&&(m.opacity=s.opacity),n=new i.TibcoLayer(m),o.addLayer(n),c&&c.length>0){var d,f,g,y,h,p,k,w,_,v,L,C,b,x={};for(x.useCanvas=a._isTrue(s.useCanvas,!1),s.pathsLayerName&&(x.name=s.pathsLayerName),s.clipOffset&&(x.clipOffset=s.clipOffset),d=new i.VectorLayer(x),o.addLayer(d),f=0;f<c.length;f++){g=c[f],h={},p=[],k=!1;for(y in g)if("locations"===y&&g[y])for(w=g[y],_=0;_<w.length;_++)v=w[_],a._getCoords(v,s.customerName,s.customerKey).then(function(e){p.push([e.latitude,e.longitude])},function(e){});else"dashArray"===y||"lineCap"===y||"lineJoin"===y?d.options.defaultStyle[y]=g[y]:"isPolygon"===y?k=a._isTrue(g[y],!1):"clickable"===y?C=a._isTrue(g[y],!0):"reverseCoordinates"===y?b=a._isTrue(g[y],!1):h[y]="stroke"===y||"fill"===y?a._isTrue(g[y],!0):g[y];if(k){var T=[p];L=new i.Polygon(T)}else L=new i.Polyline(p);L.options.clickable=C,L.options.reverseCoordinates=b,L.setStyle(h),d.addGeometry(L)}}if(l&&l.length>0){var N,j,M,Z,z,P,U,E,G,J,K={};for(s.markersLayerName&&(K.name=s.markersLayerName),N=new i.MarkersLayer(K),o.addLayer(N),j=0;j<l.length;j++)M=l[j],function(e){a._getCoords(e,s.customerName,s.customerKey).then(function(t){if(Z=new i.LatLng(t.latitude,t.longitude),z=a._isTrue(e.draggable,!1),E=e.xoffset?e.xoffset:0,G=e.yoffset?e.yoffset:0,P={draggable:z,offset:new i.Point(E,G)},e.anchor&&(P.anchor=e.anchor),e["icon.url"]&&e["icon.url"].length>0){var n=r.softHtmlEscape(e["icon.url"]);U=new i.ImageMarker(Z,n,P),J=e.target&&e.target.length>0?e.target:"_blank",e.title&&e.title.length>0?e.hyperlink&&e.hyperlink.length>0&&(U.onImageClick=function(){window.open("'"+r.hardEscape(e.hyperlink)+"'",J)}):e.hyperlink&&e.hyperlink.length>0&&(U.myUrl=e.hyperlink,U.target=J)}else e.html&&e.html.length>0&&(U=new i.HtmlMarker(Z,e.html,P));U&&N.addMarker(U)},function(e){})}(M);N.events.on("marker-click",function(e){e&&e.myUrl&&window.open(e.myUrl,e.target)})}a._isTrue(s["layers.control"],!1)&&o.addControl(new i.LayersControl({}))},function(e){})},_getCoords:function(e,t,n){var o,r=new i.Promise;if(e.latitude||e.longitude)o={},o.latitude=e.latitude,o.longitude=e.longitude,r.resolve(o);else if(e.country){var a=new i.Geocoder(t,n),s={country:e.country,city:e.city,zip:e.zip,state:e.state,street:e.street};a.geocode(s).then(function(e){e[0]&&(o={},o.latitude=e[0].location.lat,o.longitude=e[0].location.lng,r.resolve(o))},function(e){r.reject(e)})}return r},_isTrue:function(e,t){return e?!0===e||"true"===e:!0===t||"true"===t}})});