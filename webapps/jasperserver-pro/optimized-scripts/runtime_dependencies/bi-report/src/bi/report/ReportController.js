/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","jquery","./view/ReportView","./model/ReportStateStack","./jive/collection/PageComponentMetaCollection","./jive/collection/ReportComponentMetaCollection","./jive/collection/ReportComponentCollection","./model/ReportModel","./model/ReportExportModel","./error/biComponentErrorFactoryReportProxy","./enum/reportEvents","./enum/reportStatuses","./enum/reportOutputFormats","request","runtime_dependencies/js-sdk/src/common/logging/logger"],function(e,t,o){function r(e){var t=new c.Deferred,o=this;return this.view.showOverlay(),this.model.runAction(e).then(function(e){o.view.hideOverlay(),t.resolve(e)},function(e){o.view.hideOverlay(),t.reject(e)}),t}function n(e){var t,o=new c.Deferred,r=this;return t=e.options&&e.options.showErrorDialog?a.omit(e,"options"):e,this.view.showOverlay(),this.model.runAction(t).then(a.bind(r.model.updateStatus,r.model),function(e){return o.reject(e)}).then(function(){r.model.isFailed()||r.model.isCancelled()?o.reject({source:"execution",status:r.model.get("status"),errorDescriptor:r.model.get("errorDescriptor")}):(e.silent||r.trigger(E.AFTER_REPORT_EXECUTION),r.fetchPageHtmlExportAndJiveComponents({silent:e.silent}).done(o.resolve).fail(o.reject))},function(e){o.reject(e)}),o.fail(function(t){e=a.isArray(e)?a.reduce(e):e;var o,n=e.actionName+"Data",i=e[n],s=e.options&&e.options.showErrorDialog;4===t.readyState&&500===t.status&&(s&&(o=i.chartComponentUuid?r.components.find(function(e){return e.get("chartUuid")==i.chartComponentUuid}):r.components.get(i[i.chartComponentUuid?"chartComponentUuid":"tableUuid"])),o&&o.handleServerError&&o.handleServerError(a.extend({},e,t.responseJSON.result))),"highchartsInternalError"===t.type&&(s&&(o=i.chartComponentUuid?r.components.find(function(e){return e.get("chartUuid")==i.chartComponentUuid}):r.components.get(i[i.chartComponentUuid?"chartComponentUuid":"tableUuid"])),o&&o.handleClientError&&o.handleClientError(t)),r.view.hideOverlay()}),o}function i(e){var t=this;this.model=new m,this.stateModel=e,this.pageComponentsMeta=new d([],{report:this.model}),this.reportComponentsMeta=new u([],{report:this.model}),this.components=new h([],{report:this.model,pageComponentsMeta:this.pageComponentsMeta,reportComponentsMeta:this.reportComponentsMeta,stateModel:e}),this.view=new l({model:this.model,collection:this.components,stateModel:e}),this.stateStack=new p,this.model.components=this.components,this.model.config={container:this.view.$el},this.model.getExport(R.HTML)||this.model.addExport({options:{outputFormat:R.HTML}}),this.listenTo(this.model.getExport(R.HTML),"change:outputFinal",function(){t.trigger(E.PAGE_FINAL,this.model.getExport(R.HTML).getHTMLOutput())}),this.listenTo(this.components,E.ACTION,this.runReportAction),this.listenTo(this.model,"change:status",function(){if(x.info("Report status changed to '"+t.model.get("status")+"'"),t.model.isReady())t.model.update().done(function(){t.exportDfd&&t.exportDfd.done(function(){x.info("Report total pages number is "+t.model.get("totalPages"));var e=t.model.getExport(R.HTML);e.get("outputFinal")?t.fetchReportJiveComponents().then(function(){t.trigger(E.REPORT_COMPLETED,t.model.get("status"))},function(){var e=Array.prototype.slice.call(arguments);e.unshift(v.FAILED),e.unshift(E.REPORT_COMPLETED),t.trigger.apply(t,e)}):e.get("outputEmpty")?t.trigger(E.REPORT_COMPLETED,t.model.get("status")):t.fetchPageHtmlExportAndJiveComponents().fail(function(){var e=Array.prototype.slice.call(arguments);e.unshift(v.FAILED),e.unshift(E.REPORT_COMPLETED),t.trigger.apply(t,e)})})});else if(t.model.isCancelled()||t.model.isFailed()){var e=t.model.get("errorDescriptor");t.model.isFailed()&&null!=e&&e.message&&x.error(e.message),t.trigger(E.REPORT_COMPLETED,t.model.get("status"),{source:"execution",status:t.model.get("status"),errorDescriptor:e})}}),this.listenTo(this.model,"change:pageStatus",function(){var e=t.model.getExport(R.HTML);t.model.isReady()||e.get("outputFinal")||!(t.model.get("pageStatus").pageFinal||t.model.get("pageStatus").timestamp>e.get("outputTimestamp"))||(x.info("page updated from "+e.get("outputTimestamp")+" to "+t.model.get("pageStatus").timestamp),t.fetchPageHtmlExportAndJiveComponents())}),x.debug("Attach first `REQUESTED_PAGES_READY` event listener to report"),this.once(E.REQUESTED_PAGES_READY,function(e,o){o.resolve(),t.model.isCompleted()||t.model.waitForExecution(),x.debug("Attach second `REQUESTED_PAGES_READY` event listener to report"),t.on(E.REQUESTED_PAGES_READY,function(e,o){t.model.isCompleted()||t.model.waitForExecution(),t._reportRenderFinished&&(t.view.renderReport(),t.view.renderJive().done(function(){o.resolve(),t.model.isReady()&&t.trigger(E.REPORT_COMPLETED,t.model.get("status"))}).fail(function(e){o.reject(e)}))})}),this.on(E.AFTER_REPORT_EXECUTION,function(){t.model.execution.set({pages:1,anchor:void 0}),a.extend(t.model.getExport(R.HTML).get("options"),{pages:1,anchor:void 0})})}var s=e("backbone"),a=e("underscore"),c=e("jquery"),l=e("./view/ReportView"),p=e("./model/ReportStateStack"),d=e("./jive/collection/PageComponentMetaCollection"),u=e("./jive/collection/ReportComponentMetaCollection"),h=e("./jive/collection/ReportComponentCollection"),m=e("./model/ReportModel"),g=e("./model/ReportExportModel"),f=e("./error/biComponentErrorFactoryReportProxy"),E=e("./enum/reportEvents"),v=e("./enum/reportStatuses"),R=e("./enum/reportOutputFormats"),C=e("request"),D=e("runtime_dependencies/js-sdk/src/common/logging/logger"),x=D.register("ReportController");a.extend(i.prototype,s.Events,{undoReportAction:function(){var e=this;return n.call(this,{actionName:"undo"}).done(function(){e.stateStack.previousState()})},undoAllReportAction:function(){var e=this;return n.call(this,{actionName:"undoAll"}).done(function(){e.stateStack.firstState()})},redoReportAction:function(){var e=this;return n.call(this,{actionName:"redo"}).done(function(){e.stateStack.nextState()})},runReportAction:function(e){var t=this;return n.call(this,e).done(function(){t.stateStack.newState()})},searchReportAction:function(e){var t={actionName:"search",searchData:{}};return"string"==typeof e?t.searchData.searchString=e:t.searchData={searchString:e.text,caseSensitive:e.caseSensitive,wholeWordsOnly:e.wholeWordsOnly},r.call(this,t)},save:function(e){var t=this;return n.call(this,a.extend(e||{},{actionName:"saveReport"})).done(function(){t.stateStack.newState()})},executeReport:function(e){var t=new c.Deferred,o=this;return this.model.execute({freshData:!!e}).then(function(){var e=a.bind(o.fetchPageHtmlExportAndJiveComponents,o);return o.exportDfd=e(arguments),o.exportDfd},t.reject).then(function(){o.stateStack.newState(),t.resolve.apply(t,arguments)},t.reject),t},cancelReportExecution:function(){return this.fetchExportDfd&&"pending"===this.fetchExportDfd.state()&&this.fetchExportDfd.reject({source:"execution",status:"cancelled"}),this.model.cancel()},removeReportExecution:function(){var e=new c.Deferred,t=this;return this.cancelReportExecution().done(function(){t.model.removeExecution().done(e.resolve.bind(e)).fail(e.reject.bind(e))}).fail(e.reject.bind(e)),e},applyReportParameters:function(e){var t=new c.Deferred,o=this;return this.fetchExportDfd&&"pending"===this.fetchExportDfd.state()&&this.fetchExportDfd.reject({source:"execution",status:"cancelled"}),this.model.applyParameters(e).then(function(){return o.trigger(E.AFTER_REPORT_EXECUTION),o.fetchExportDfd=o.fetchPageHtmlExportAndJiveComponents({silent:!0}),o.fetchExportDfd},t.reject).then(a.bind(o.model.updateStatus,o.model),t.reject).then(a.bind(o.model.waitForExecution,o.model),t.reject).then(t.resolve,t.reject),t},fetchPageHtmlExportAndJiveComponents:function(e){var t,o,r=new c.Deferred;if(x.debug("Start fetching of html and JIVE"),r.fail(function(e){t&&"pending"===t.state()&&(t.reject?t.reject(e):t.abort(e)),o&&"pending"===o.state()&&(o.reject?o.reject(e):o.abort(e))}),this.model.isFailed()||this.model.isCancelled())r.reject({source:"execution",status:this.model.get("status"),errorDescriptor:this.model.get("errorDescriptor")});else{var n=this,i=this.model.getExport(R.HTML);t=i.run(),t.then(function(){i.isFailed()||i.isCancelled()?r.reject({source:"export",format:R.HTML,status:i.get("status"),errorDescriptor:i.get("errorDescriptor")}):(o=i.waitForExport().then(a.bind(i.fetchOutput,i)),o.then(function(t,o,i){if(t){if(!e||!0!==e.silent)try{var s=parseInt(i.getResponseHeader("report-pages"),10),c=n.stateModel.get("pages");isNaN(s)||(n.model.execution.set("pages",s,{silent:!0}),c=parseInt(a.isObject(c)?c.pages:c,10),s!==c&&(x.debug("Fetching of html and JIVE: fires CURRENT_PAGE_CHANGED"),n.trigger(E.CURRENT_PAGE_CHANGED,s)))}catch(e){x.error("Failed to parse 'report-pages' response header from server",e)}n.pageComponentsMeta.fetch().then(a.bind(n.components.fetch,n.components),r.reject).then(function(){e&&!0===e.silent?(x.debug("Finish fetching of html and JIVE: silent"),r.resolve()):(x.debug("Finish fetching of html and JIVE: fires REQUESTED_PAGES_READY"),n.trigger(E.REQUESTED_PAGES_READY,n,r),r.resolve())},function(e){"pending"===r.state()&&r.reject(e)})}else x.debug("Report is empty! Nothing to do!"),e&&!0===e.silent||n.trigger(E.REQUESTED_PAGES_READY,n,r),r.resolve()},r.reject))},function(e){"pending"===r.state()&&r.reject(e)})}return r},renderReport:function(){return this.view.render().always(a.bind(function(){this._reportRenderFinished=!0},this))},fetchReportJiveComponents:function(){var e=new c.Deferred;return x.debug("Start fetching of report-level JIVE components"),this.model.isFailed()||this.model.isCancelled()?e.reject({source:"execution",status:this.model.get("status"),errorDescriptor:this.model.get("errorDescriptor")}):this.reportComponentsMeta.fetch().then(a.bind(this.components.fetchReportComponents,this.components),e.reject).then(function(){x.debug("Finish fetching of report-level JIVE components"),e.resolve()},function(t){"pending"===e.state()&&e.reject(t)}),e},exportReport:function(e){var t=new c.Deferred;if(this.model.isFailed()||this.model.isCancelled()){var o=f.reportStatus({source:"execution",status:this.model.get("status"),errorDescriptor:this.model.get("errorDescriptor")});t.reject(o)}else{e||(e={});var r=a.pick(e,"outputFormat","ignorePagination");a.isObject(e.pages)?(r.pages=e.pages.pages,r.anchor=e.pages.anchor):(r.pages=e.pages,r.anchor=void 0);var n=new g({options:r},{report:this.model}),i=a.bind(n.waitForExport,n);n.run().then(i,t.reject).then(function(){if(n.isFailed()||n.isCancelled()){var o=f.reportStatus({source:"export",format:e.outputFormat,status:n.get("status"),errorDescriptor:n.get("errorDescriptor")});t.reject(o)}else t.resolve({href:n.urlOutput()},function(e){return e=a.defaults(e||{},{url:n.urlOutput(),type:"GET",headers:{Accept:"text/plain, application/json"},dataType:"text",data:{suppressContentDisposition:!0}}),C(e)})})}return t},destroy:function(){return this.removeReportExecution().done(a.bind(this.view.remove,this.view))}}),o.exports=i});