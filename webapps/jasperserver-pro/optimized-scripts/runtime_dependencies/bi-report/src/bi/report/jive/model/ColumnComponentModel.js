/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","./BaseComponentModel","./FormatModel","../enum/jiveTypes","jquery","underscore","../collection/ConditionCollection","../enum/interactiveComponentTypes","../../enum/reportEvents","../util/jiveDataConverter","runtime_dependencies/js-sdk/src/common/logging/logger"],function(t,e,i){function o(){if(this.get("canSort"))return this.get("sortOrder")?{order:this.get("sortOrder")}:{}}function a(){if(this.get("canFilter")){var t=c.isArray(this.get("filterValue"))&&!c.every(this.get("filterValue"));if(c.isUndefined(this.get("filterValue"))||c.isNull(this.get("filterValue"))||t){var e=this.get("filtering")?this.get("filtering").filterData.fieldValueStart:void 0,i=this.get("filtering")?this.get("filtering").filterData.fieldValueEnd:void 0;"datetime"===f.dataTypeToSchemaFormat[this.get("dataType")]?"between"!==this.get("filterOperator")&&"not_between"!==this.get("filterOperator")||null==e||null==i?null!=e&&this.set("filterValue",f.jQueryUiTimestampToIsoTimestamp(e,this.parent&&this.parent.config?this.parent.config.genericProperties:void 0),{silent:!0}):this.set("filterValue",[f.jQueryUiTimestampToIsoTimestamp(e,this.parent&&this.parent.config?this.parent.config.genericProperties:void 0),f.jQueryUiTimestampToIsoTimestamp(i,this.parent&&this.parent.config?this.parent.config.genericProperties:void 0)],{silent:!0}):"time"===f.dataTypeToSchemaFormat[this.get("dataType")]&&("between"!==this.get("filterOperator")&&"not_between"!==this.get("filterOperator")||null==e||null==i?null!=e&&this.set("filterValue",f.jQueryUiTimeToIsoTime(e,this.parent&&this.parent.config?this.parent.config.genericProperties:void 0),{silent:!0}):this.set("filterValue",[f.jQueryUiTimeToIsoTime(e,this.parent&&this.parent.config?this.parent.config.genericProperties:void 0),f.jQueryUiTimeToIsoTime(i,this.parent&&this.parent.config?this.parent.config.genericProperties:void 0)],{silent:!0}))}return null!=this.get("filterOperator")&&null!=this.get("filterValue")?{operator:this.get("filterOperator"),value:this.get("filterValue")}:{}}}function n(){return{actionName:"editTextElement",editTextElementData:{applyTo:"heading",tableUuid:this.get("parentId"),columnIndex:this.get("columnIndex"),dataType:this.get("dataType"),headingName:this.get("columnLabel"),fontName:this.headingFormat.get("font").name,fontSize:this.headingFormat.get("font").size,fontBold:this.headingFormat.get("font").bold,fontItalic:this.headingFormat.get("font").italic,fontUnderline:this.headingFormat.get("font").underline,fontColor:this.headingFormat.get("font").color,fontHAlign:this.headingFormat.get("align").charAt(0).toUpperCase()+this.headingFormat.get("align").slice(1),fontBackColor:"transparent"===this.headingFormat.get("backgroundColor")?"000000":this.headingFormat.get("backgroundColor"),mode:"transparent"===this.headingFormat.get("backgroundColor")?"Transparent":"Opaque"}}}var r=t("./BaseComponentModel"),s=t("./FormatModel"),l=t("../enum/jiveTypes"),d=t("jquery"),c=t("underscore"),h=t("../collection/ConditionCollection"),g=t("../enum/interactiveComponentTypes"),m=t("../../enum/reportEvents"),f=t("../util/jiveDataConverter"),u=t("runtime_dependencies/js-sdk/src/common/logging/logger"),p=u.register("ColumnComponentModel");i.exports=r.extend({api:{sort:{},move:{},format:{},filter:{},hide:{},unhide:{},resize:{}},defaults:function(){return{canFilter:!1,canFormatConditionally:!1,canFormatHeading:!1,canSort:!1,clearData:{},columnIndex:0,columnLabel:"",conditionalFormattingData:{},dataType:void 0,filterData:{},filtering:{},headerToolbar:{},headingsTabContent:{},id:null,parentId:null,proxySelector:null,selector:null,module:"jive.interactive.column",type:l.COLUMN,valuesTabContent:{},sortOrder:void 0,filterOperator:void 0,filterValue:void 0}},constructor:function(){this.detailsRowFormat=new s,this.conditions=new h,r.prototype.constructor.apply(this,arguments)},initialize:function(t){this.config=t,this.events={ACTION_PERFORMED:"action",BEFORE_ACTION_PERFORMED:"beforeAction"},this.get("canFormatHeading")&&(this.headingFormat=new s(this.get("headingsTabContent"),{parse:!0,silent:!0})),this.attachEvents()},attachEvents:function(){this.headingFormat&&this.listenTo(this.headingFormat,"change",function(){this.trigger("change:headingFormat",this)},this),this.listenTo(this.detailsRowFormat,"change",function(){this.trigger("change:detailsRowFormat",this)},this),this.listenTo(this.conditions,"reset",function(){this.trigger("change:conditions",this)},this),this.on("change",function(){(this.hasChanged("filterValue")||this.hasChanged("filterOperator"))&&this.trigger("change:filter",this)},this),this.on("parentTableComponentAttached",function(){this.config.conditionalFormattingData&&(this.conditions.dataType=f.dataTypeToSchemaFormat[this.config.dataType],this.conditions.conditionPattern=this.config.conditionalFormattingData.conditionPattern,this.conditions.parent=this,this.conditions.reset(this.config.conditionalFormattingData.conditions,{silent:!0,parse:!0}))})},sort:function(t){var e=this,i={action:this.config.headerToolbar["sort"+t.order+"Btn"].sortData};i.action.sortData.tableUuid=e.config.parentId,e._notify({name:e.events.BEFORE_ACTION_PERFORMED}),e.trigger(m.ACTION,i.action)},move:function(t){var e=this,i={action:{actionName:"move",moveColumnData:{tableUuid:e.config.parentId,columnToMoveIndex:e.config.columnIndex,columnToMoveNewIndex:t.index}}};e._notify({name:e.events.BEFORE_ACTION_PERFORMED}),e.trigger(m.ACTION,i.action)},format:function(t){var e=this,i={action:t};e._notify({name:e.events.BEFORE_ACTION_PERFORMED}),e.trigger(m.ACTION,i.action)},filter:function(t){var e=this,i=d.extend({},e.config.filtering.filterData,t),o={action:{actionName:"filter",filterData:i,options:{showErrorDialog:!0}}};e._notify({name:e.events.BEFORE_ACTION_PERFORMED}),e.trigger(m.ACTION,o.action)},hide:function(){var t=this,e={action:{actionName:"hideUnhideColumns",columnData:{tableUuid:t.config.parentId,hide:!0,columnIndexes:[this.config.columnIndex]}}};t._notify({name:t.events.BEFORE_ACTION_PERFORMED}),t.trigger(m.ACTION,e.action)},unhide:function(t){var e=this,i={action:{actionName:"hideUnhideColumns",columnData:{tableUuid:e.config.parentId,hide:!1,columnIndexes:t||[this.config.columnIndex]}}};e._notify({name:e.events.BEFORE_ACTION_PERFORMED}),e.trigger(m.ACTION,i.action)},resize:function(t){var e=this,i={action:{actionName:"resize",resizeColumnData:{tableUuid:e.config.parentId,columnIndex:this.config.columnIndex,direction:"right",width:t.width}}};e._notify({name:e.events.BEFORE_ACTION_PERFORMED}),e.trigger(m.ACTION,i.action)},parse:function(t){if(t.headerToolbar&&t.headerToolbar.sortAscBtn&&t.headerToolbar.sortDescBtn){var e,i=t.headerToolbar.sortAscBtn.sortData.sortData.sortOrder,o=t.headerToolbar.sortDescBtn.sortData.sortData.sortOrder;"None"===i?e="asc":"None"===o&&(e="desc"),t.sortOrder=e}if(t.filtering&&t.filtering.filterData){var a=f.dataTypeToSchemaFormat[t.dataType],n=t.filtering.filterData.filterTypeOperator,r=t.filtering.filterData.fieldValueStart,s=t.filtering.filterData.fieldValueEnd,l=t.filtering.filterData.filterPattern;if(t.filtering.filterData.clearFilter||null==r&&null==n)t.filterOperator=void 0,t.filterValue=void 0;else{var d=f.operatorAndValueToSchemaFormat(n,a,r,s,l);t.filterOperator=d.operator,t.filterValue=d.value}}return t.headingsTabContent?t.canFormatHeading=!0:t.canFormatHeading=!1,t.valuesTabContent&&(this.detailsRowFormat.dataType=f.dataTypeToSchemaFormat[t.dataType],this.detailsRowFormat.set(this.detailsRowFormat.parse(t.valuesTabContent),{silent:!0})),t.columnLabel&&(t.columnLabel=c.unescape(t.columnLabel)),t},actions:{"change:sortOrder":function(){var t,e=this.get("headerToolbar").sortAscBtn.sortData.sortData.sortColumnName,i=this.get("headerToolbar").sortAscBtn.sortData.sortData.sortColumnType;switch(this.get("sortOrder")){case"asc":t="Asc";break;case"desc":t="Dsc";break;default:t="None"}return{actionName:"sort",sortData:{sortColumnName:e,sortColumnType:i,sortOrder:t,tableUuid:this.get("parentId")}}},"change:filter":function(){var t=this.get("filterOperator"),e=this.get("filterValue"),i=null==e&&null==t,o=this.get("filtering").filterData,a=this.get("dataType"),n=f.dataTypeToSchemaFormat[a],r=this.parent&&this.parent.config?this.parent.config.genericProperties:void 0;return{actionName:"filter",filterData:{fieldValueStart:f.filterStartValue(t,e,n,r),fieldValueEnd:f.filterEndValue(t,e,n,r),filterTypeOperator:f.schemaFormatOperatorToFilterOperator(t,e,n),clearFilter:i,filterPattern:o.filterPattern,fieldName:o.fieldName,localeCode:o.localeCode,timeZoneId:o.timeZoneId,isField:o.isField,tableUuid:this.get("parentId"),filterType:a}}},"change:headingFormat":n,"change:columnLabel":n,"change:detailsRowFormat":function(){return{actionName:"editTextElement",editTextElementData:{applyTo:"detailrows",tableUuid:this.get("parentId"),columnIndex:this.get("columnIndex"),dataType:this.get("dataType"),fontName:this.detailsRowFormat.get("font").name,fontSize:this.detailsRowFormat.get("font").size,fontBold:this.detailsRowFormat.get("font").bold,fontItalic:this.detailsRowFormat.get("font").italic,fontUnderline:this.detailsRowFormat.get("font").underline,fontColor:this.detailsRowFormat.get("font").color,formatPattern:this.detailsRowFormat.toJiveFormat(),fontHAlign:this.detailsRowFormat.get("align").charAt(0).toUpperCase()+this.detailsRowFormat.get("align").slice(1),fontBackColor:"transparent"===this.detailsRowFormat.get("backgroundColor")?"000000":this.detailsRowFormat.get("backgroundColor"),mode:"transparent"===this.detailsRowFormat.get("backgroundColor")?"Transparent":"Opaque"}}},"change:conditions":function(){var t=this.parent&&this.parent.config?this.parent.config.genericProperties:void 0;return{actionName:"conditionalFormatting",conditionalFormattingData:{applyTo:"detailrows",tableUuid:this.get("parentId"),columnIndex:this.get("columnIndex"),conditionPattern:this.get("conditionalFormattingData").conditionPattern,conditionType:this.get("conditionalFormattingData").conditionType,conditions:this.conditions.map(function(e){return e.toJiveFormat(t)})}}}},toReportComponentObject:function(){var t=this.parent.get("allColumnsData");if(t){var e=c.findWhere(t,{uuid:this.get("id")});if(e)return e.interactive?{id:this.get("id"),componentType:g.TABLE_COLUMN,dataType:f.dataTypeToSchemaFormat[this.get("dataType")],label:this.get("columnLabel"),name:this.get("name"),sort:o.call(this),filter:a.call(this),headingFormat:this.get("canFormatHeading")?this.headingFormat.toJSON():void 0,detailsRowFormat:this.detailsRowFormat.toJSON(),conditions:this.get("canFormatConditionally")?this.conditions.toJSON():void 0}:void 0}},updateFromReportComponentObject:function(t){var e={};t.sort&&(this.get("canSort")?"order"in t.sort?e.sortOrder=t.sort.order:0===c.keys(t.sort).length&&(e.sortOrder=void 0):p.warn("The column cannot be sorted!")),t.filter&&(this.get("canFilter")?0===c.keys(t.filter).length||null==t.filter.operator?(e.filterOperator=void 0,e.filterValue=void 0):(e.filterOperator=t.filter.operator,e.filterValue=t.filter.value):p.warn("The column cannot be filtered!")),null!=t.label&&(this.get("canFormatHeading")?e.columnLabel=t.label:p.warn("The column label cannot be modified!")),t.headingFormat&&(this.get("canFormatHeading")?(t.headingFormat.font=c.extend({},this.headingFormat.get("font"),t.headingFormat.font||{}),t.headingFormat.backgroundColor&&"transparent"!==t.headingFormat.backgroundColor&&(t.headingFormat.backgroundColor=t.headingFormat.backgroundColor.toUpperCase()),t.headingFormat.font&&t.headingFormat.font.color&&(t.headingFormat.font.color=t.headingFormat.font.color.toUpperCase()),this.headingFormat.set(t.headingFormat)):p.warn("The column heading cannot be modified!")),t.detailsRowFormat&&(t.detailsRowFormat.font=c.extend({},this.detailsRowFormat.get("font"),t.detailsRowFormat.font||{}),c.isObject(this.detailsRowFormat.get("pattern"))&&("Numeric"===this.get("dataType")&&f.DURATION_PATTERN===t.detailsRowFormat.pattern||(t.detailsRowFormat.pattern=c.extend({},this.detailsRowFormat.get("pattern"),t.detailsRowFormat.pattern||{}))),t.detailsRowFormat.backgroundColor&&"transparent"!==t.detailsRowFormat.backgroundColor&&(t.detailsRowFormat.backgroundColor=t.detailsRowFormat.backgroundColor.toUpperCase()),t.detailsRowFormat.font&&t.detailsRowFormat.font.color&&(t.detailsRowFormat.font.color=t.detailsRowFormat.font.color.toUpperCase()),this.detailsRowFormat.set(t.detailsRowFormat)),t.conditions&&(this.get("canFormatConditionally")?0===t.conditions.length&&0===this.conditions.length||this.conditions.reset(t.conditions):p.warn("The column cannot be formatted conditionally!")),this.set(e)}})});