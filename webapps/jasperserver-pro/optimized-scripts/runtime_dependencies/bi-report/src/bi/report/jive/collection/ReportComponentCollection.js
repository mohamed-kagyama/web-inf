/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","jquery","../enum/jiveTypes","runtime_dependencies/js-sdk/src/common/logging/logger"],function(e,t,o){function n(e,t){var o=i.clone(t);if(t.events){var n={};i.each(i.keys(t.events),function(o){n[o]=function(e,t){return function(o,n){e.call(this,n,i.isObject(o)?o:i.findWhere(t.getLinks(),{id:o}))}}(t.events[o],e)}),o.events=n}return o}var r=e("backbone"),i=e("underscore"),s=e("jquery"),a=e("../enum/jiveTypes"),p=e("runtime_dependencies/js-sdk/src/common/logging/logger"),c=p.register("ReportComponentCollection");o.exports=r.Collection.extend({initialize:function(e,t){var o=this;this._rootParts={},this.stateModel=t.stateModel,this.report=t.report,this.pageComponentsMeta=t.pageComponentsMeta,this.reportComponentsMeta=t.reportComponentsMeta,this.stateModel.get("linkOptions")&&(this.linkOptions=n(this,this.stateModel.get("linkOptions"))),this.listenTo(this.stateModel,"change:linkOptions",function(e,t){o.linkOptions=n(o,t)}),this.on("change add reset remove",function(){i.each(a,function(e){o[e]=[]}),o.forEach(function(e){o[e.get("type")]&&i.isArray(o[e.get("type")])&&o[e.get("type")].push(e)})}),this.on("reset add",function(){o.forEach(function(e){e&&e.get("type")&&("bookmarks"===e.get("type")&&o.trigger("bookmarksReady",e.get("bookmarks")),"reportparts"===e.get("type")&&o.trigger("reportPartsReady",e.get("reportParts")))})})},registerPart:function(e){if(e){var t=e.get("parentId");if(t){var o=this._rootParts[t];o&&o.registerPart?(c.debug("Registering ".concat(e.get("type"),"(").concat(e.get("id"),") to parent ").concat(o.get("type"),"(").concat(t,")!")),o.registerPart(e)):c.warn("Unable to register ".concat(e.get("type"),"(").concat(e.get("id"),") to parent ").concat(o.get("type"),"(").concat(t,")!"))}else e.has("id")&&(c.debug("Part ".concat(e.get("type"),"(").concat(e.get("id"),") has no parent!")),this._rootParts[e.get("id")]=e)}},fetch:function(){var t=this,o=[],n=[],r=[],a=new s.Deferred;return this.pageComponentsMeta.forEach(function(e){e.get("type")&&("table"===e.get("type")&&o.push("../model/TableComponentModel"),"column"===e.get("type")&&o.push("../model/ColumnComponentModel"),"chart"===e.get("type")&&o.push("runtime_dependencies/bi-chart/src/jr/jive/highcharts/model/ChartComponentModel"),("fusionChart"===e.get("type")||"fusionMap"===e.get("type")||"fusionWidget"===e.get("type"))&&o.push("../model/FusionComponentModel"),"googlemap"===e.get("type")&&o.push("../model/GooglemapComponentModel"),"tibco-maps"===e.get("type")&&o.push("../model/TibcomapComponentModel"),"crosstab"===e.get("type")&&o.push("../model/CrosstabComponentModel"),"webfonts"===e.get("type")&&o.push("../model/WebfontsComponentModel"),"hyperlinks"===e.get("type")&&o.push("../model/HyperlinksComponentModel"),"bookmarks"===e.get("type")&&o.push("../model/BookmarksComponentModel"),"reportparts"===e.get("type")&&o.push("../model/ReportPartsComponentModel"),"CVComponent"===e.get("type")&&o.push("../model/CustomComponentModel"),n.push(e.attributes))}),e(o,function(){var e=i.toArray(arguments),o={parent:t.report,linkOptions:t.linkOptions,collection:t,parse:!0};i.each(e,function(e,i){var s=new e(n[i],o);r.push(s),t.registerPart(s)}),t.reset(r),a.resolve()},a.reject),a},fetchReportComponents:function(){var t=this,o=[],n=[],r=[],a=new s.Deferred;return this.reportComponentsMeta.forEach(function(e){e.get("type")&&"bookmarks"===e.get("type")&&o.push("../model/BookmarksComponentModel"),e.get("type")&&"reportparts"===e.get("type")&&o.push("../model/ReportPartsComponentModel"),e.get("type")&&n.push(e.attributes)}),e(o,function(){var e=i.toArray(arguments),o={parent:t.report,linkOptions:t.linkOptions,collection:t,parse:!0};i.each(e,function(e,i){var s=new e(n[i],o);r.push(s),t.registerPart(s)}),t.add(r,{merge:!0}),a.resolve()},a.reject),a},add:function(e,t){var o=[];return this.stateModel.get("isolateDom")&&(i.each(e,function(e,t,n){!e.get("type")||-1===e.get("type").indexOf("fusion")&&-1===e.get("type").indexOf("tibco-maps")?o.push(n[t]):(-1!==e.get("type").indexOf("fusion")&&c.info("Fusion components usage deprecated when isolateDom option enabled for report"),-1!==e.get("type").indexOf("tibco-maps")&&c.info("Tibco maps components usage deprecated when isolateDom option enabled for report"))}),e=o),r.Collection.prototype.add.call(this,e,t)},getComponents:function(){var e=this.reduce(function(e,t){if(t.toReportComponentObject){var o=t.toReportComponentObject();if(!o)return e;i.isArray(o)?e=e.concat(o):e.push(o)}return e},[]);return i.forEach(e,function(e){void 0===e.name&&delete e.name}),e},getLinks:function(){return this.reduce(function(e,t){return e.concat(t.get("hyperlinks")||[])},[])},getBookmarks:function(){return this.reduce(function(e,t){return e.concat(t.get("bookmarks")||[])},[])},getReportParts:function(){return this.reduce(function(e,t){return e.concat(t.get("reportParts")||[])},[])},updateComponents:function(e){var t=this,o=[],n=new r.Collection(this.map(function(e){var t=new r.Model(e.attributes);return i.extend(t,{updateFromReportComponentObject:e.updateFromReportComponentObject,actions:e.actions,parent:e.parent,headingFormat:e.headingFormat,detailsRowFormat:e.detailsRowFormat,conditions:e.conditions}),e.attachEvents&&e.attachEvents.call(t),t}));return n.forEach(function(e){i.each(e.actions,function(n,r){t.listenToOnce(e,r,function(e,t,n){o.push(e.actions[r].call(e,n))})})}),i.each(e,function(e){var t=n.get(e.id.split("/")[0]);t&&t.updateFromReportComponentObject(e)}),o}})});