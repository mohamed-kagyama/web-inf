/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","bundle!CommonBundle","runtime_dependencies/js-sdk/src/common/util/domUtil","runtime_dependencies/js-sdk/src/common/logging/logger"],function(e,t,n){var o=e("underscore"),i=e("jquery"),r=e("backbone"),a=e("bundle!CommonBundle"),s=e("runtime_dependencies/js-sdk/src/common/util/domUtil"),l=e("runtime_dependencies/js-sdk/src/common/logging/logger"),d=l.register("LoadingOverlay");n.exports=r.View.extend({overlayDOMObject:[],$overlayHolder:!1,scaleFactor:1,savedExternalContainersOverflow:!1,initialize:function(e){this.propertiesModel=e.propertiesModel,this.setExternalContainer(e.externalContainer),this.setBiComponentContainer(e.biComponentContainer),this.setBiComponent(e.biComponent),this.setScaleFactor(e.scaleFactor)},setExternalContainer:function(e){this.$externalContainer=i(e)},setBiComponentContainer:function(e){this.$biComponentContainer=i(e)},setBiComponent:function(e){this.$biComponent=i(e)},setScaleFactor:function(e){o.isUndefined(e)||(this.scaleFactor=e)},applyScale:function(e){o.isUndefined(e)||(this.scaleFactor=e,this._applyScaleTransform())},show:function(){return this.$biComponentContainer.length<1?void d.debug("loading overlay: external container is absent"):0===this.$biComponentContainer.height()||0===this.$biComponentContainer.width()?void d.debug("loading overlay: component container has zero size"):this.propertiesModel.get("isolateDom")&&!this.$biComponent.height()?void d.debug("iframe mode: bi component hasn't any size"):(this._buildOverlay(),this._attachToContainer(),this.hideScrollBarOnContainer(),this._adjustOverlaySizeAndPosition(),this._applyScaleTransform(),void this.$overlayHolder.show())},hide:function(){this.$overlayHolder&&this.$overlayHolder.hide(),this.showScrollBarOnContainer()},showScrollBarOnContainer:function(){!0===this.savedExternalContainersOverflow&&(this.$externalContainer.css("overflow-x",this.savedExternalContainerOverflowValueX),this.$externalContainer.css("overflow-y",this.savedExternalContainerOverflowValueY),this.savedExternalContainersOverflow=!1)},hideScrollBarOnContainer:function(){if(!1===this.savedExternalContainersOverflow){(s.hasScrollBar(this.$externalContainer[0],"vertical")||s.hasScrollBar(this.$externalContainer[0],"horizontal"))&&(this.savedExternalContainerOverflowValueX=this.$externalContainer.css("overflow-x"),this.savedExternalContainerOverflowValueY=this.$externalContainer.css("overflow-y"),this.savedExternalContainersOverflow=!0,this.$externalContainer.css("overflow-x","hidden"),this.$externalContainer.css("overflow-y","hidden"))}},remove:function(){return this.hide(),r.View.prototype.remove.call(this)},_buildOverlay:function(){0===this.overlayDOMObject.length&&0===this.overlayDOMObject.length&&(this.overlayDOMObject=i("<div>"+a["dialog.overlay.loading"]+"</div>").css({position:"absolute",top:20,left:0,width:"100%",color:"#fff","text-align":"center"}))},_attachToContainer:function(){this.$overlayHolder&&this.$overlayHolder.remove(),this.$overlayHolder=i("<div></div>").append(i("<div></div>").css({width:"100%",height:"100%",filter:"alpha(opacity=40)",opacity:".4","background-color":"black"})),this.$overlayHolder.append(this.overlayDOMObject),this.$overlayHolder.prependTo(this.$biComponentContainer)},_adjustOverlaySizeAndPosition:function(){var e,t,n=0,i=0,r={padding:{left:0,top:0,right:0,bottom:0},innerHeight:this.$externalContainer.innerHeight(),innerWidth:this.$externalContainer.innerWidth(),outerHeight:this.$externalContainer.outerHeight(),outerWidth:this.$externalContainer.outerWidth(),scrollHeight:this.$externalContainer[0].scrollHeight,scrollWidth:this.$externalContainer[0].scrollWidth,scrollTop:this.$externalContainer.scrollTop(),scrollLeft:this.$externalContainer.scrollLeft()};r.padding.top=parseInt(this.$externalContainer.css("paddingTop"),10),o.isNaN(r.padding.top)&&(r.padding.top=0),r.padding.right=parseInt(this.$externalContainer.css("paddingRight"),10),o.isNaN(r.padding.right)&&(r.padding.right=0),r.padding.bottom=parseInt(this.$externalContainer.css("paddingBottom"),10),o.isNaN(r.padding.bottom)&&(r.padding.bottom=0),r.padding.left=parseInt(this.$externalContainer.css("paddingLeft"),10),o.isNaN(r.padding.left)&&(r.padding.left=0),r.scrollWidth<=r.outerWidth?(d.debug("width: biComponent is smaller than container or equal OR container doesn't have horizontal scroll bars"),e=r.innerWidth-(r.padding.left+r.padding.right),i=r.scrollLeft):(d.debug("width: biComponent is larger than container"),i=r.scrollLeft-(r.scrollLeft<r.padding.left?0:r.padding.left),e=r.innerWidth+r.padding.right,r.scrollLeft+r.outerWidth>=r.scrollWidth-r.padding.right&&(d.debug("width: scrolled to the end"),e=r.innerWidth)),r.scrollHeight<=r.outerHeight?(d.debug("height: biComponent is smaller than container or equal OR container doesn't have vertical scroll bars"),t=r.innerHeight-(r.padding.top+r.padding.bottom),n=r.scrollTop):(d.debug("height: biComponent is larger than container"),n=r.scrollTop-(r.scrollTop<r.padding.top?0:r.padding.top),t=r.innerHeight+r.padding.bottom,r.scrollTop+r.outerHeight>=r.scrollHeight-r.padding.bottom&&(d.debug("height: scrolled to the end"),t=r.innerHeight)),this.$overlayHolder.css({position:"absolute",top:n,left:i,"z-index":495,width:e/this.scaleFactor,height:t/this.scaleFactor,display:"none"})},_applyScaleTransform:function(){var e="scale("+this.scaleFactor+")",t="top left",n={"-webkit-transform":e,"-moz-transform":e,"-ms-transform":e,"-o-transform":e,filter:"progid:DXImageTransform.Microsoft.Matrix(M11="+this.scaleFactor+", M12=0, M21=0, M22="+this.scaleFactor+", SizingMethod='auto expand')",transform:e,"-webkit-transform-origin":t,"-moz-transform-origin":t,"-ms-transform-origin":t,"-o-transform-origin":t,"transform-origin":t};this.$overlayHolder&&this.$overlayHolder.css(n)}})});