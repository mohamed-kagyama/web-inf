/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","runtime_dependencies/js-sdk/src/common/model/BaseModel","backbone","underscore","jquery","./reportStatusTrait","../enum/reportOutputFormats","../enum/reportStatuses"],function(t,e,r){function i(t){var e=u.parseHTML(t,document);return e=s.filter(e,function(t){var e=u(t),r=e.prop("tagName");return r=r||"","table"===r.toLowerCase()}),0!==e.length&&e}var o=t("runtime_dependencies/js-sdk/src/common/model/BaseModel"),n=t("backbone"),s=t("underscore"),u=t("jquery"),a=t("./reportStatusTrait"),p=t("../enum/reportOutputFormats"),c=t("../enum/reportStatuses"),d=o.extend({defaults:function(){return{attachments:void 0,id:void 0,options:void 0,outputResource:void 0,outputFinal:!1,outputEmpty:!1,ignorePagination:void 0,status:void 0}},initialize:function(t,e){e||(e={}),this.report=e.report,this.isFirstRun=!0,o.prototype.initialize.apply(this,arguments)},url:function(){if(s.isUndefined(this.report.get("requestId")))throw new Error("You must execute report before fetching export.");var t=this.report.contextPath;return"/"!==t[t.length-1]&&(t+="/"),t+="rest_v2/reportExecutions/"+this.report.get("requestId")+"/exports",t},urlStatus:function(){if(s.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/status"},urlOutput:function(){if(s.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/outputResource"},urlAttachments:function(){if(s.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/attachments/"},run:function(t){t||(t={});var e=s.extend(this.report.execution.pick("outputFormat","pages","anchor","attachmentsPrefix","allowInlineScripts","markupType","baseUrl","ignorePagination"),this.get("options")?s.pick(this.get("options"),"outputFormat","pages","anchor","attachmentsPrefix","allowInlineScripts","markupType","baseUrl","ignorePagination"):{},t);return this.isFirstRun&&(e.clearContextCache=!0,this.isFirstRun=!1),o.prototype.fetch.call(this,{url:this.url(),type:"POST",contentType:"application/json",headers:{Accept:"application/json"},data:JSON.stringify(e)})},fetchOutput:function(){var t=this;return n.ajax({url:this.urlOutput(),type:"GET",headers:{Accept:"text/html, application/json"},dataType:this.get("options").outputFormat}).done(function(e,r,i){var o=e;t.get("options").outputFormat===p.HTML&&(t.set({outputEmpty:!e}),o=e&&e.markup?e.markup:s.isUndefined(e)?"":e),t.set({output:o,outputFinal:"true"===i.getResponseHeader("output-final"),outputTimestamp:parseInt(i.getResponseHeader("output-timestamp"))})})},getHTMLOutput:function(){return i(this.get("output"))},updateStatus:function(){var t=this,e=n.ajax({type:"GET",url:this.urlStatus(),dataType:"json",contentType:"application/json",headers:{Accept:"application/status+json"}}).done(function(e){if(!t.set({status:e.value,errorDescriptor:e.errorDescriptor}))return!1;t.trigger("sync",t,e)}).fail(function(e){t.trigger("error",t,e)});return this.trigger("request",this,e),e},waitForExport:function(){var t=this,e=new u.Deferred,r=function r(){t.isCompleted()?e.resolve():this.timeout=setTimeout(function(){t.updateStatus().done(r).fail(e.reject)},1e3)};return this.updateStatus().done(r).fail(e.reject),e},cancel:function(){this.timeout&&clearTimeout(this.timeout),this.set({status:c.CANCELLED})}});s.extend(d.prototype,a),r.exports=d});