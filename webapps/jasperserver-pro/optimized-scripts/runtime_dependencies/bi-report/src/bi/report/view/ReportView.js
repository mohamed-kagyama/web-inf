/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../jive/enum/jiveTypes","../enum/reportCreators","../jive/view/JiveComponentCollectionView","../enum/reportOutputFormats","jquery","runtime_dependencies/js-sdk/src/common/util/browserDetection","../enum/reportEvents","../enum/scaleStrategies","runtime_dependencies/js-sdk/src/common/util/domUtil","requirejs-domready","./LoadingOverlay","./LocalFrameView","../utils/DialogStates","runtime_dependencies/js-sdk/src/common/logging/logger","jquery-ui/ui/scroll-parent"],function(e,t,i){function r(e,t,i,r,o){var s;if(e===p.WIDTH)s=r/t;else if(e===p.HEIGHT)s=o/i;else{var n=r/t,a=o/i;s=n*i<o?n:a}return s}function o(e,t){var i=e.model.components.getLinks(),r=e.linkOptions();r.beforeRender&&i.length&&r.beforeRender(n.map(i,function(e){return{element:t.find("[data-id='"+e.id+"']")[0],data:e}})),r.events&&i.length&&(e.events=n.reduce(n.keys(r.events),function(t,r){return t[r+" ._jrHyperLink"]=s(i,e.stateModel.get("linkOptions").events[r]),t},{}),e.delegateEvents())}function s(e,t){return function(i){t.call(this,i,n.findWhere(e,{id:i.currentTarget.getAttribute("data-id")}))}}var n=e("underscore"),a=e("backbone"),l=e("../jive/enum/jiveTypes"),c=e("../enum/reportCreators"),h=e("../jive/view/JiveComponentCollectionView"),d=e("../enum/reportOutputFormats"),u=e("jquery"),g=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),m=e("../enum/reportEvents"),p=e("../enum/scaleStrategies"),f=e("runtime_dependencies/js-sdk/src/common/util/domUtil"),v=e("requirejs-domready"),w=e("./LoadingOverlay"),$=e("./LocalFrameView"),C=e("../utils/DialogStates"),y=e("runtime_dependencies/js-sdk/src/common/logging/logger");e("jquery-ui/ui/scroll-parent");var T=y.register("ReportView");i.exports=a.View.extend({el:"<div style='height: 100%;'></div>",$reportContainer:!1,$jrTables:!1,savedContainersOverflow:!1,reportIsEmpty:!1,initialize:function(e){this.stateModel=e.stateModel,this.dialogStates=new C,this.jiveComponentCollectionView=new h({collection:this.collection,dialogStates:this.dialogStates,stateModel:e.stateModel}),this.$el.css("position","relative"),this._afterResizeFunc=n.throttle(n.bind(this._afterResizeFunc,this),400),u(window).on("resize",this._afterResizeFunc)},_afterResizeFunc:function(e){e&&!e.target.tagName&&!1!==this.stateModel.get("autoresize")&&this.applyScale()},linkOptions:function(){return this.stateModel.get("linkOptions")},remove:function(){return u(window).off("resize",this._afterResizeFunc),this._setLocalFrameSize&&(u(window).off("resize",this._setLocalFrameSize),this._setLocalFrameSize=!1),this.jiveComponentCollectionView.remove(),this.localFrameView&&this.localFrameView.remove(),a.View.prototype.remove.call(this)},setContainer:function(e){var t=u(e),i=this;return!!t.length&&(!(t[0]!==this.$reportContainer[0]||!u.contains(t[0],this.el))||(t.empty(),this.$jrTables=!1,this.$reportContainer=t,this.containerAttachedToDOM=new u.Deferred,v(function(){i.stateModel.get("isolateDom")?(i.localFrameView=new $(i.$el),i.$reportContainer.html(i.localFrameView.$el)):(i.$reportContainer.html(i.$el),i.showOverlay()),i.containerAttachedToDOM.resolve()}),!0))},render:function(){var e=this,t=new u.Deferred;return this.containerAttachedToDOM.done(function(){if(e.stateModel.get("isolateDom"))e.renderIsolatedDom(t);else{if(e.renderReport(),e.reportIsEmpty)return void t.resolve();e.renderJive().then(t.resolve,t.reject)}}),t},renderIsolatedDom:function(e){var t=this;if(this.isElasticChart()&&(this._setLocalFrameSize=n.throttle(function(){var e=t.$reportContainer.height();t.localFrameView.$el.height(e||400)},100),this._setLocalFrameSize(),u(window).resize(this._setLocalFrameSize)),this.renderReport(),this.reportIsEmpty)return void e.resolve();this.renderJive().done(function(){e.resolve()})},renderReport:function(){var e=this.model.getExport(d.HTML).getHTMLOutput(),t=this.isElasticChart(),i=void 0===this.stateModel.get("scrollToTop")||this.stateModel.get("scrollToTop"),r=void 0===this.stateModel.get("showAdhocChartTitle")||this.stateModel.get("showAdhocChartTitle"),s=u(e),a=this.stateModel.get("defaultJiveUi");if(e){this.reportIsEmpty=!1,this.stateModel.get("linkOptions")&&o(this,s),t&&(r&&(this.highchartsReportTitle=u.trim(s.find("tbody tr td span").text())),s=s.find(".highcharts_parent_container").clone().css({margin:"0 auto",height:"100%"}),s=u("<div></div>").append(s).append("<table cellpadding='0' cellspacing='0' class='jrPage'></table>").html()),this.$el.html(s),a&&!a.enabled&&this.$el.addClass("jiveDisabled"),this.trigger(m.BEFORE_RENDER,this.$el[0]);var l=this.$reportContainer;if(this.loadingOverlay&&this.loadingOverlay.showScrollBarOnContainer(),this.stateModel.get("isolateDom")&&(l=this.localFrameView.$frameBody),this.$jrTables=l.find(t?"._jr_report_container_":"._jr_report_container_ > table"),this.applyScale(),this.stateModel.has("pages")&&n.isObject(this.stateModel.get("pages"))){var c=this.stateModel.get("pages").anchor;if(!n.isUndefined(c)&&""!==c){var h=this.$el.find("[name='"+c+"']"),g=this.calculateScaleFactor();h.length||(h=this.$el.find("#"+c)),h.length&&!n.isUndefined(g)?this.$el.scrollParent().scrollTop((f.getElementOffset(h[0]).top-f.getElementOffset(this.$el.scrollParent()[0]).top)*g):i&&this.$el.scrollParent().scrollTop(0)}}else i&&this.$el.scrollParent().scrollTop(0)}else this.reportIsEmpty=!0,this.$el.empty();return this},renderJive:function(){var e=this;T.debug("Start JIVE Rendering");var t=setTimeout(function(){e.showOverlay()},1e3),i=this.jiveComponentCollectionView.render(this.$el,{highchartsReportTitle:this.highchartsReportTitle});return i.always(function(){clearTimeout(t),e.hideOverlay(),T.debug("Finish JIVE Rendering")}),i},showOverlay:function(){var e=this,t=function(){if(!1!==e.stateModel.get("loadingOverlay")&&e.$reportContainer){var t=e.$el;e.stateModel.get("isolateDom")&&(t=e.localFrameView.$frameBody),e.loadingOverlay?(e.loadingOverlay.setExternalContainer(e.$reportContainer),e.loadingOverlay.setBiComponentContainer(t),e.loadingOverlay.setBiComponent(e.$jrTables),e.loadingOverlay.setScaleFactor(e.scaleFactor)):e.loadingOverlay=new w({propertiesModel:e.stateModel,scaleFactor:e.scaleFactor,externalContainer:e.$reportContainer,biComponentContainer:t,biComponent:e.$jrTables}),e.loadingOverlay.show()}};this.stateModel.get("isolateDom")?this.localFrameView.frameLoaded.done(t):t()},hideOverlay:function(){this.loadingOverlay&&this.loadingOverlay.hide()},applyScale:function(){var e=this;if(this.$jrTables){var t=this.calculateScaleFactor();if(!n.isUndefined(t)&&(this._applyScaleTransform(t),this.isElasticChart())){this._autoScaleFontsEnabled()&&this._setAutoScaleFonts();var i=u(this.$jrTables.parents()[0]),r=this.$reportContainer.find(".adhoc_chart_report_title");i.css("overflow","hidden"),this.jiveComponentCollectionView.getSizableSubviews().then(function(t){r.height(0),n.invoke(t,"setSize",i.width(),i.height(),e.stateModel.get("chart").animation),setTimeout(function(){r.height("auto")},0)}),i.css("overflow","visible")}}},calculateScaleFactor:function(){var e,t=this.stateModel.get("scale");if(n.isUndefined(t))e=1;else if(n.contains(n.values(p),t)){var i=this.$jrTables.width(),o=this.$jrTables.height(),s=this.$reportContainer.width(),a=this.$reportContainer.height()||400;if(e=r(t,i,o,s,a),f.isScrollable(this.$reportContainer[0])){var l=f.getScrollbarWidth();t!==p.CONTAINER&&t!==p.WIDTH||e*o>a&&(s-=l+1,e=r(t,i,o,s,a)),t!==p.CONTAINER&&t!==p.HEIGHT||e*i>s&&(a-=l+1,e=r(t,i,o,s,a))}}else{var c=/^\d+%$/.test(t);e=parseFloat(t.toString().replace(",",".")),n.isNaN(e)&&(e=void 0),c&&(e/=100)}return e},_applyScaleTransform:function(e){var t=this;this.scaleFactor=e,this.loadingOverlay&&this.loadingOverlay.applyScale(e);var i=this._getCssRulesForScalingFactor(e);this.$jrTables.length>1?this.$jrTables.parent().css(i):this.$jrTables.css(i),this.isGoogleMap()&&this._setScaleForGooglemap(e),this.jiveComponentCollectionView.getScalableSubviews().then(function(t){n.invoke(t,"scale",e)}),this.stateModel.get("isolateDom")&&(this.localFrameView.$el.width()<this.$jrTables.width()*e&&this.localFrameView.$el.width(this.$jrTables.width()*e),setTimeout(function(){t.localFrameView.$el.height(t.$jrTables.height()*t.$jrTables.length*e)},50))},_getCssRulesForScalingFactor:function(e){var t="scale("+e+")",i="top left",r={"-webkit-transform":t,"-moz-transform":t,"-ms-transform":t,"-o-transform":t,transform:t,"-webkit-transform-origin":i,"-moz-transform-origin":i,"-ms-transform-origin":i,"-o-transform-origin":i,"transform-origin":i};return g.isIE8()&&(r.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+e+", M12=0, M21=0, M22="+e+", SizingMethod='auto expand')"),r},isElasticChart:function(){return this.collection.some(function(e){return c.AD_HOC_DESIGNER===e.get("creator")&&l.CHART===e.get("type")})},isGoogleMap:function(){return this.collection.some(function(e){return l.GOOGLEMAP===e.get("type")})},_setScaleForGooglemap:function(e){this.collection.each(function(t){if(l.GOOGLEMAP===t.get("type")){var i=this.$el.find("#"+t.get("id")),r=i.parent();i.width(r.width()*e),i.height(r.height()*e),i.css(this._getCssRulesForScalingFactor(1/e))}},this)},_autoScaleFontsEnabled:function(){return this.collection.some(function(e){return e.get("hcinstancedata").services[0].data.chartState.autoScaleFonts})},_setAutoScaleFonts:function(){var e=parseInt(this.$jrTables.css("font-size")),t=this.$jrTables.width(),i=t>600?1:(Math.floor(t/100)+4)/10,r=Math.round(e*i);this.$jrTables.find(".highcharts_parent_container").css("font-size",r)}})});