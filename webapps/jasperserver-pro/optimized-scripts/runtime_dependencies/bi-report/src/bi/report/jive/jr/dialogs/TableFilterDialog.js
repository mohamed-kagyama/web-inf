/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","runtime_dependencies/js-sdk/src/common/component/dialog/Dialog","text!./template/tableFilterDialogTemplate.htm","./view/TableFilterView","../../util/jiveDataConverter","runtime_dependencies/bi-chart/src/jr/jive/highcharts/dialogs/trait/adjustDialogPositionWithinViewportTrait","bundle!CommonBundle"],function(e,t,o){function i(e,t){var o,i,a={};return e.operator&&(a.operator=s.schemaFormatOperatorToFilterOperator(e.operator,e.value,t),o=this.columnComponentModel.parent.config.genericProperties,i=-1!==e.operator.indexOf("null"),"datetime"!==t||i?"time"!==t||i?a.value=e.value:l.isArray(e.value)?(a.value=[],a.value[0]=s.isoTimeTojQueryUiTime(e.value[0],o),a.value[1]=s.isoTimeTojQueryUiTime(e.value[1],o)):a.value=s.isoTimeTojQueryUiTime(e.value,o):l.isArray(e.value)?(a.value=[],a.value[0]=s.isoTimestampTojQueryUiTimestamp(e.value[0],o),a.value[1]=s.isoTimestampTojQueryUiTimestamp(e.value[1],o)):a.value=s.isoTimestampTojQueryUiTimestamp(e.value,o)),a}var l=e("underscore"),a=e("runtime_dependencies/js-sdk/src/common/component/dialog/Dialog"),n=e("text!./template/tableFilterDialogTemplate.htm"),r=e("./view/TableFilterView"),s=e("../../util/jiveDataConverter"),m=e("runtime_dependencies/bi-chart/src/jr/jive/highcharts/dialogs/trait/adjustDialogPositionWithinViewportTrait"),u=e("bundle!CommonBundle");o.exports=a.extend({defaultTemplate:n,constructor:function(e){this.tableFilterView=new r({i18n:e.i18n}),a.prototype.constructor.call(this,{buttons:[{label:u["button.cancel"],action:"cancel",primary:!1,float:"right"},{label:u["button.ok"],action:"ok",primary:!0,float:"right"}],traits:[m],additionalCssClasses:"tableFilterDialog",modal:!0,resizable:!1,contentContainer:".dialogContent",content:this.tableFilterView}),this.on("button:ok",this._applyFilter),this.on("button:cancel",this.close)},open:function(e){this.columnComponentModel=e;var t=this.columnComponentModel.toReportComponentObject();this.tableFilterView.viewModel.set({columnLabel:t.label?t.label:"#"+(this.columnComponentModel.get("columnIndex")+1),clearFilter:null==t.filter.operator?"true":"false",filterOptions:this.columnComponentModel.parent.config.genericProperties.operators[this.columnComponentModel.get("dataType").toLowerCase()],dataType:this.columnComponentModel.get("dataType").toLowerCase(),calendarPatterns:this.columnComponentModel.parent.config.genericProperties.calendarPatterns}),this.tableFilterView.model.reset().set(i.call(this,t.filter,t.dataType)),a.prototype.open.apply(this,arguments)},_applyFilter:function(e){var t=this.tableFilterView.model.toJSON();if(t.operator){var o=this.columnComponentModel.toReportComponentObject(),i=l.isArray(t.value)?t.value[0]:t.value,a=l.isArray(t.value)?t.value[1]:void 0;o.filter=s.operatorAndValueToSchemaFormat.call(this.columnComponentModel,t.operator,o.dataType,i,a,o.detailsRowFormat.pattern),this.columnComponentModel.updateFromReportComponentObject(o)}else this.columnComponentModel.set({filterValue:null,filterOperator:null},{silent:!0});var n=this.columnComponentModel.actions["change:filter"].call(this.columnComponentModel);this.columnComponentModel.filter(n.filterData),this.close()},remove:function(){a.prototype.remove.call(this),this.tableFilterView&&this.tableFilterView.remove()}})});