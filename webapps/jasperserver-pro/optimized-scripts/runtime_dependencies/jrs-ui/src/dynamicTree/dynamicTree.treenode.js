/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","./dynamicTree.tree","../util/utils.common","../core/core.layout","runtime_dependencies/js-sdk/src/common/util/xssUtil"],function(e,t,i){var d=e("prototype"),s=d.$,r=e("./dynamicTree.tree"),n=e("../util/utils.common"),o=n.isArray,h=n.isIPad,a=n.cancelEventBubbling,l=e("../core/core.layout"),N=e("runtime_dependencies/js-sdk/src/common/util/xssUtil");r.TreeNode=function(e){this.id=r.getNextId(),this.treeId=null,this.name=null!=e.name?e.name:this.DEFAULT_NAME,this.param=null!=e.param?e.param:{},this.orderNumber=null!=e.orderNumber?e.orderNumber:null,this.childs=[],this.parent=null,this.Types={Folder:new r.TreeNode.Type(this.FOLDER_TYPE_NAME)},this.isloaded=!1,this.delayedRendering=!0,this.haschilds=!1,this.editable=!1,this.isWaiting=!1,this.hidden=!1,this.isDropTarget=!1,r.nodes[this.id]=this},r.TreeNode.Type=function(e,t){this.name=e,t&&(this.cssClassName=t.cssClassName,this.templateDomId=t.templateDomId)},r.TreeNode.State={OPEN:"open",CLOSED:"closed"},r.TreeNode.addVar("FOLDER_TYPE_NAME","com.jaspersoft.jasperserver.api.metadata.common.domain.Folder"),r.TreeNode.addVar("DEFAULT_NAME","unset name"),r.TreeNode.addVar("NODE_ID_PREFIX","node"),r.TreeNode.addVar("SUB_NODE_ID_SUFFIX","sub"),r.TreeNode.addVar("HANDLER_ID_PREFIX","handler"),r.TreeNode.addVar("NODE_CLASS_NAME","node").addVar("LEAF_CLASS_NAME","leaf").addVar("OPEN_CLASS_NAME","open").addVar("CLOSED_CLASS_NAME","closed").addVar("SELECTED_CLASS_NAME","selected").addVar("LOADING_CLASS_NAME","loading").addVar("ROOTS_CLASS_NAME","roots"),r.TreeNode.addVar("nodeHeaderTemplateDomId","list_responsive_collapsible:leaf"),r.TreeNode.addVar("nodeFooterTemplateDomId","list_responsive_collapsible"),r.TreeNode.addVar("nodeInputTemplateDomId","list_responsive_collapsible:input"),r.TreeNode.addVar("isSelectable",!1),r.TreeNode.addMethod("getTreeId",function(){return this.treeId||this.parent&&this.parent.getTreeId()}),r.TreeNode.addMethod("getState",function(){return r.trees[this.getTreeId()].getState(this.id)}),r.TreeNode.addMethod("isParent",function(){return this.param.type==this.Types.Folder.name}),r.TreeNode.addMethod("addChild",function(e){if(this.isParent()){var t=this.childs[this.childs.length-1];t&&(t.nextSibling=e,e.prevSibling=t),this.childs.push(e),e.parent=this,this.resortChilds(),this.delayedRendering||(e.showNode(),e.render(this._getChildrenElement(),e.nextSibling))}}),r.TreeNode.addMethod("removeChild",function(e){for(var t=0;t<this.childs.length;t++)if(this.childs[t]==e){this.childs.splice(t,1);break}if(e.deselect(),!this.delayedRendering){var i=e._getElement();i&&i.remove()}}),r.TreeNode.addMethod("resortChilds",function(){var e=this.getTreeId(),t=r.trees[e];if(t&&t.sortNodes&&o(this.childs)){this.childs.sort(function(e,i){return t.comparer(e,i)});for(var i=this.childs.length;i--;){var d=this.childs[i];d.prevSibling=this.childs[i-1],d.nextSibling=this.childs[i+1]}}}),r.TreeNode.addMethod("resetChilds",function(){this.childs=[]}),r.TreeNode.addMethod("setHasChilds",function(e){this.haschilds=e}),r.TreeNode.addMethod("hasChilds",function(){return!!this.haschilds||this.getChildCount()>0}),r.TreeNode.addMethod("getChildCount",function(){return this.childs.length}),r.TreeNode.addMethod("getFirstChild",function(){return this.hasChilds()?this.childs[0]:null}),r.TreeNode.addMethod("getLastChild",function(){return this.hasChilds()?this.childs[this.childs.length-1]:null}),r.TreeNode.addMethod("_getElement",function(e){return this._element||(this._element=s(this.NODE_ID_PREFIX+this.id)),this._element}),r.TreeNode.addMethod("_getTitle",function(){var e=this._getElement().childElements()[0];e.cleanWhitespace();var t=e.childNodes[e.childNodes.length-1];return"#text"!==t.nodeName&&(t=document.createTextNode(""),e.appendChild(t)),t}),r.TreeNode.addMethod("_getTitleInputElement",function(){return s(this._getElement().getElementsByTagName("input")[0])}),r.TreeNode.addMethod("_getChildrenElement",function(){return this._childrenElement||(this._childrenElement=s(this.NODE_ID_PREFIX+this.id+this.SUB_NODE_ID_SUFFIX)),this._childrenElement}),r.TreeNode.addMethod("isOpen",function(){return this.getState()===r.TreeNode.State.OPEN}),r.TreeNode.addMethod("changeName",function(e){this.name=e,this._getTitle().data=this.name}),r.TreeNode.addMethod("getType",function(){for(var e in this.Types)if(this.param.type===this.Types[e].name)return this.Types[e]}),r.TreeNode.addMethod("refreshStyle",function(e){if(e=s(e)||this._getElement()){e.templateClassName&&(e.className=e.templateClassName),this.isParent()?(e.addClassName(this.NODE_CLASS_NAME).removeClassName(this.LEAF_CLASS_NAME),this.isWaiting||(this.isOpen()?e.addClassName(this.OPEN_CLASS_NAME).removeClassName(this.CLOSED_CLASS_NAME):e.addClassName(this.CLOSED_CLASS_NAME).removeClassName(this.OPEN_CLASS_NAME))):e.addClassName(this.LEAF_CLASS_NAME).removeClassName(this.NODE_CLASS_NAME),this.isWaiting?e.addClassName(this.LOADING_CLASS_NAME):e.removeClassName(this.LOADING_CLASS_NAME),this.isSelected()?e.addClassName(this.SELECTED_CLASS_NAME):e.removeClassName(this.SELECTED_CLASS_NAME),this.hidden?e.addClassName(l.HIDDEN_CLASS):e.removeClassName(l.HIDDEN_CLASS),this.param.cssClass&&e.addClassName(this.param.cssClass);var t=this.getType();t&&t.cssClassName&&e.addClassName(t.cssClassName);var i=e.down();this.isDropTarget&&i&&i.addClassName(l.DROP_TARGET_CLASS),!this.isDropTarget&&i&&i.removeClassName(l.DROP_TARGET_CLASS)}}),r.TreeNode.addMethod("_createNode",function(){var e=this.id,t=r.trees[this.getTreeId()],i=this._getHeaderTemplateElement();i.id=this.NODE_ID_PREFIX+e,i.tabIndex=-1,this.refreshStyle(i),this.treeId=t.id,i.treeNode=this;var d=i.childElements()[0];t.allowHyperlinks?d.insert(N.softHtmlEscape(this.name,{whiteList:["a"]})):d.insert(N.hardEscape(this.name)),null!=this.tooltip&&this.tooltip.length>0&&(d.title=this.tooltip),d.childElements().each(function(t,i){0===i&&(t.id=this.HANDLER_ID_PREFIX+e);var d=this.iconTooltip;d&&(t.title=o(d)?d[i]:d)}.bind(this)),this._element=i}),r.TreeNode.addMethod("_createNodeChildren",function(){var e=this._getFooterTemplateElement();e.id=this.NODE_ID_PREFIX+this.id+this.SUB_NODE_ID_SUFFIX,this._childrenElement=e}),r.TreeNode.addMethod("showNode",function(e){var t=r.trees[this.getTreeId()];if(this._createNode(),this.isParent()){if(this.isOpen()||t.showAllNodesOnStartup){this._createNodeChildren();for(var i=0;i<this.getChildCount();i++)this.childs[i].showNode(this._getChildrenElement());this.delayedRendering=!1,t.fireOpenEvent(this)}}this.render(e)}),r.TreeNode.addMethod("render",function(e,t){if(!Object.isUndefined(e)){var i=s(e);i&&(this._getChildrenElement()&&this._getElement().insert(this._getChildrenElement()),t?i.insert(this._getElement(),{before:t._getElement()}):i.insert(this._getElement()))}}),r.TreeNode.addMethod("_renderChildren",function(){var e=this._getElement();e&&this._getChildrenElement()&&e.insert(this._getChildrenElement())}),r.TreeNode.addMethod("refreshNode",function(){if(this.refreshStyle(),this.isParent()&&this.isOpen()&&this.isloaded){this.delayedRendering?(this._createNodeChildren(),this._renderChildren()):this._getChildrenElement().update("");for(var e=0;e<this.getChildCount();e++)this.childs[e].showNode(this._getChildrenElement());this.delayedRendering=!1}r.trees[this.getTreeId()].refreshScroll()}),r.TreeNode.addMethod("wait",function(){this.isWaiting=!0,this.refreshStyle()}),r.TreeNode.addMethod("stopWaiting",function(){this.isWaiting=!1,this.refreshStyle()}),r.TreeNode.addMethod("isHiddenRootNode",function(){var e=r.trees[this.getTreeId()];return e.rootNode==this&&!e.bShowRoot}),r.TreeNode.addMethod("deselect",function(e){var t=r.trees[this.getTreeId()];return!(!t||!this.isSelected())&&(t.removeNodeFromSelected(this),this.refreshStyle(),e&&t.fireUnSelectEvent(this,e),!0)}),r.TreeNode.addMethod("select",function(e,t,i){if(i=i||{},!t&&this.focus(),this.isSelected())return!1;var d=r.trees[this.getTreeId()];return d.addNodeToSelected(this),this.refreshStyle(),!i.silent&&d.fireSelectEvent(this,e),!0}),r.TreeNode.addMethod("focus",function(){var e=this;!h()&&this._getElement()&&setTimeout(function(){e._getElement().focus()},100)}),r.TreeNode.addMethod("isSelected",function(){var e=r.trees[this.getTreeId()];return e&&e.isNodeSelected(this)}),r.TreeNode.addMethod("_removeTitle",function(){var e=this._getTitle();e.data="",s(e.parentNode).cleanWhitespace()}),r.TreeNode.addMethod("edit",function(e){if(this.editable){if(r.treeNodeEdited==this)return;r.treeNodeEdited=this;var t=this.name,i=s(this._getTitle().parentNode),d=this._getInputTemplateElement();this._getTitle().data="",i.cleanWhitespace(),i.insert(d),d.value=N.unescape(this.name),d.focus(),d.select(e),d.onclick=function(e){a(e)},d.ondblclick=function(e){a(e)},d.onmousedown=function(e){a(e)},d.onmouseup=function(e){a(e)},d.onkeydown=function(e){var i=window.event?window.event:e;13==i.keyCode?(d.onblur=null,this.doEndEdit(i)):27==i.keyCode&&(d.onblur=null,d.value=t,this.doEndEdit(i))}.bindAsEventListener(this),d.onblur=function(e){this.doEndEdit(e)}.bindAsEventListener(this),r.trees[this.getTreeId()].fireStartEditEvent(this,d)}}),r.TreeNode.addMethod("doEndEdit",function(e){this.editEnded(),r.trees[this.getTreeId()].fireEndEditEvent(this)}),r.TreeNode.addMethod("editEnded",function(){var e=r.trees[this.getTreeId()];if(null!=r.treeNodeEdited){var t=this._getTitleInputElement(),i=(s(t.parentNode),t.value);if(i==r.treeNodeEdited.name)return t.remove(),this._getTitle().data=r.treeNodeEdited.name,void(r.treeNodeEdited=null);e.fireEditEvent(r.treeNodeEdited,i),r.editaborted||(r.treeNodeEdited.name=i,t.remove(),this._getTitle().data=i),r.treeNodeEdited=null}}),r.TreeNode.addMethod("scroll",function(e){var t=r.trees[this.getTreeId()].rootNode._getElement(),i=s(e?e:t.parentNode),d=this._getElement();if(i){var n=i.clientHeight,o=i.clientWidth,h=i.scrollTop,a=i.scrollLeft,l=d.cumulativeOffset().top-i.cumulativeOffset().top,N=d.offsetLeft,c=d.clientHeight,m=d.clientWidth;l>h+n?i.scrollTop=l-(n/2-c/2):l+c<h&&(i.scrollTop=l-(n/2-c/2)),N>a+o?i.scrollLeft=N-(o/2-m/2):N+m<a&&(i.scrollTop=N-(o/2-m/2))}}),r.TreeNode.addMethod("handleNode",function(e){if(this.isParent()){var t=r.trees[this.getTreeId()];this.isOpen()?t.writeStates(this.id,r.TreeNode.State.CLOSED):(t.writeStates(this.id,r.TreeNode.State.OPEN),t.fireOpenEvent(this,e)),this.refreshNode()}}),r.TreeNode.addMethod("openNode",function(e){if(this.isParent()){var t=r.trees[this.getTreeId()];this.isOpen()||(t.writeStates(this.id,r.TreeNode.State.OPEN),t.fireOpenEvent(this,e)),this.refreshNode()}}),r.TreeNode.addMethod("_getHeaderTemplateElement",function(){var e=this.getType(),t=e&&e.templateDomId?e.templateDomId:this.nodeHeaderTemplateDomId,i=s(t).cloneNode(!0);return i.templateId=t,i.templateClassName=i.className,i}),r.TreeNode.addMethod("_getFooterTemplateElement",function(){var e=this.nodeFooterTemplateDomId,t=s(e).cloneNode(!0);return t.templateId=e,t.update(""),t}),r.TreeNode.addMethod("_getInputTemplateElement",function(){var e=this.nodeInputTemplateDomId,t=s(e).cloneNode(!0);return t.templateId=e,t}),i.exports=r});