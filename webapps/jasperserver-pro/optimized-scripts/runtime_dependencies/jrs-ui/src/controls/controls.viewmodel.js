/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","../namespace/namespace","underscore","jquery","runtime_dependencies/js-sdk/src/common/util/browserDetection","./rest/enum/restParamsEnum","./predicate/isControlInCascade","./controls.core","./controls.basecontrol","jquery-ui/ui/widgets/sortable"],function(t,e,n){var o=t("../namespace/namespace"),r=o.JRS,i=t("underscore"),s=t("jquery"),a=t("runtime_dependencies/js-sdk/src/common/util/browserDetection"),l=(t("./rest/enum/restParamsEnum"),t("./predicate/isControlInCascade"));t("./controls.core"),t("./controls.basecontrol"),t("jquery-ui/ui/widgets/sortable"),r.Controls=function(t,e,n){var o=a.isIE(),r=function(){var e,n=(new Date).getTime();return function(){var o=(new Date).getTime(),r=this;o-n>400&&(n=o,t(this).trigger("scrollstart")),clearTimeout(e),e=setTimeout(function(){t(r).trigger("scrollstop")},300)}}(),i=n.Base.extend({constructor:function(t){this.containerSelector=t&&t.containerSelector||n.ViewModel.DEFAULT_CONTAINER,this.controls={},n.getViewModel=e.bind(function(){return this},this),e.bindAll(this,"registerEvents","onControlChange"),this.registerEvents()},registerEvents:function(){n.ignore("changed:control",this.onControlChange),n.listen({"changed:control":this.onControlChange})},onControlChange:function(e,o){var r=o.control,i=o.selection,s=l(r);t(document).trigger(n.ViewModel.CHANGE_SELECTION,[r.id,i,s]),s||t(document).trigger(n.ViewModel.CHANGE_VALUES,[this.state])}},{DEFAULT_CONTAINER:"#inputControlsContainer",CHANGE_VALUES:"viewmodel:values:changed",CHANGE_SELECTION:"viewmodel:selection:changed",CHANGE_ORDER:"viewmodel:order:changed",isSelectionChanged:function(t,n){var o=t?e(t).keys():[],r=n?e(n).keys():[];if(e.union(o,r).length===o.length){var i=t?e.flatten(e(t).values()):[],s=n?e.flatten(e(n).values()):[];return e.difference(i,s).length>0||e.difference(s,i).length>0}return!0}}),s={getControls:function(){return this.controls},instantiate:function(t,e){var n=this;this.controls={};var o=e.dataUri,r=e.inputControlsService,i=e.initialSelectedValues,s=e.paginatedValuesOptions;t.forEach(function(t){var e=t.id;n.createControl(t,{dataUri:o,inputControlsService:r,initialSelectedValues:i[e]||[],paginatedValuesOptions:s[e]||[]})})},createControl:function(t,e){var o=function(t){for(var e in n)if(t.toLowerCase()===e.toLowerCase())return n[e]}(t.type);if(!o)throw new Error("Can not find implementation of the control type: "+t.type);return this.controls[t.id]=new o(t,e),this.controls[t.id]},removeControl:function(t){delete this.controls[t]},reorderControl:function(e,o){if(1!=this.structure.length){for(var r,i=e<o?1:-1,s=e<o?Math.min(e,o):Math.max(e,o),a=e<o?Math.max(e,o):Math.min(e,o),l=s;l!=a;l+=i)r=this.structure[l],this.structure[l]=this.structure[l+i],this.structure[l+i]=r;t(document).trigger(n.ViewModel.CHANGE_ORDER,[this.structure])}},set:function(o,r){if(o){e.extend(this,o);var i=o.structure,s=o.controlsOptions||{},a=s.initialSelectedValues;i&&(this.instantiate(i,o.controlsOptions),this.draw(i)),a&&(this.update(a),!r&&t(document).trigger(n.ViewModel.CHANGE_VALUES,a))}},get:function(t){if(t){if("selection"===t){var n={};return e.each(this.getControls(),function(t){var o=t.get("selection");o instanceof Array?n[t.id]=o:e.isUndefined(o)||(n[t.id]=[o])}),n}return this[t]}},findControl:function(t){var n=e.keys(t)[0],o=e.values(t)[0];return e.find(this.getControls(),function(t){return t[n]===o})},pluck:function(t){return e.pluck(this.getControls(),t)}},c={draw:function(t){var e=this,n=this.getContainer();if(n.empty(),o&&(n.attr("js-stdnav","false"),n.attr("js-navtype","none")),t.forEach(function(t){if(t.visible){var o=e.findControl({id:t.id});o.render(),n.append(o.getElem())}}),window.Report&&window.Report.icReorderEnabled){var r=window.Controls.layouts.LAYOUT_TOP_OF_PAGE===Report.reportControlsLayout;/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)||this._initSortable({container:n,horizontalLayout:r})}},update:function(t){var n=this;e.each(t,function(t,e){n.findControl({id:e}).set({values:t.map(function(t){return t.value}),error:null})})},getContainer:function(){return this.container&&1==this.container.length?this.container:(this.container=t(this.containerSelector),this.container)},removeValidationMessages:function(){e.each(this.getControls(),function(t){t.set({error:null})})},areAllControlsValid:function(){return e.isEmpty(e.filter(this.getControls(),function(t){return!t.isValid()}))},setContainer:function(e){this.container=t(e)},reloadContainer:function(){return this.container=t(this.containerSelector),this.container},disable:function(){e.each(this.getControls(),function(t){t.set({disabled:!0})})},enable:function(){e.each(this.getControls(),function(t){t.set({disabled:!1})})},_initSortable:function(n){var i=n.container,s=n.horizontalLayout,a=!1,l=this,c=t(i).sortable({delay:200,placeholder:s?"verticalPlaceholder":"horizontalPlaceholder",axis:s?"x":"y",items:"> .leaf",cancel:"input,textarea,button,select,option,.list.inputSet,.jr-mSizer",start:function(t,e){e.item.data("oldIndex",e.item.index()),a=!0},stop:e.bind(function(t,e){var n=e.item.data("oldIndex"),o=e.item.index();n!=o&&this.reorderControl(n,o),a=!1},this)});if(o){var u=n.parent||c.parent();u.off("scroll",r),u.off("scrollstart"),u.off("scrollstop"),u.on("scroll",r),u.on("scrollstart",function(){if(!a)try{c.sortable("destroy")}catch(t){}}),u.on("scrollstop",function(){!a&&l._initSortable({parent:u,container:i,horizontalLayout:s})})}}};return e.extend(i.prototype,s,c),e.extend(n,{ViewModel:i})}(s,i,r.Controls),n.exports=r.Controls});