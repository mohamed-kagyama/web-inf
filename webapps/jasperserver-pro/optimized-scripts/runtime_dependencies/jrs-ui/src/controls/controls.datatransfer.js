/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","../namespace/namespace","runtime_dependencies/js-sdk/src/jrs.configs","../components/components.dialogs","underscore","jquery","./controls.core","./controls.dataconverter"],function(e,t,r){var s=e("../namespace/namespace"),n=s.JRS,o=e("runtime_dependencies/js-sdk/src/jrs.configs"),a=e("../components/components.dialogs"),i=e("underscore"),l=e("jquery");e("./controls.core"),e("./controls.dataconverter"),n.Controls=function(e,t,r,s){function n(t){var n;try{try{n=e.parse(t.responseText)}catch(e){}if(n&&n.error)r.each(n.error,function(e){var t=s.getViewModel(),r=e.inputControlUri.replace("repo:",""),n=t.find({uri:r});e.errorCode?n.set({error:e.errorCode}):e.defaultMessage&&n.set({error:e.defaultMessage})});else if(t.getResponseHeader("LoginRequested")||401===t.status)document.location=o.urlContext;else if([400,500].indexOf(t.status)>=0||t.getResponseHeader("JasperServerError")&&!t.getResponseHeader("SuppressError")){var i="";if(n){var l=n.message||"Unknown error";if(n.parameters&&n.parameters.length>0){var u=r.template("<div><b>{{-message}}</b></div><p>{{ if (parameters) for (var i = 0; i < parameters.length; i++) { }}<div>{{-parameters[i]}}</div>{{ } }}</p>");i=u({message:l,parameters:n.parameters})}else i=l}else i=window.statusText;a.errorPopup.show(i)}}catch(e){}}return r.extend(s,{DataTransfer:s.Base.extend({CONTROLS_STRUCTURE_TEMPLATE_URI:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}",INITIAL_CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/values",CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}/values",constructor:function(e){this.dataConverter=e.dataConverter,this.initialize(e)},initialize:function(e){},setReportUri:function(e){this.currentReportUri=e},buildUrl:function(e,t,n){return t=r.isArray(t)?t.join(";"):t||"",s.TemplateEngine.renderUrl(n,{reportUri:e,controlIds:t})},sendRequest:function(s,a,i){var l={url:s,type:"GET",dataType:"json",cache:!1};r.isEmpty(a)||r.extend(l,{type:"POST",processData:!1,data:e.stringify(a),contentType:"application/json"});var u=r.defaults(i||{},l);return u.headers||(u.headers={}),r.defaults(u.headers,{"X-Suppress-Basic":"true","Accept-Language":o.userLocale.replace(/_/g,"-")}),t.ajax(u).fail(n)},fetchControlsStructure:function(e,t){var n=this.buildUrl(this.currentReportUri,e,this.CONTROLS_STRUCTURE_TEMPLATE_URI),o=this.sendRequest(n,t).then(r.bind(this.dataConverter.structureFormater,this.dataConverter));return s.Utils.showLoadingDialogOn(o,null,!0),o},updateControlsStructure:function(e,t){var s=this.buildUrl(t||this.currentReportUri,null,this.CONTROLS_STRUCTURE_TEMPLATE_URI);return this.sendRequest(s,e,{type:"PUT"}).then(r.bind(this.dataConverter.structureFormater,this.dataConverter))},fetchInitialControlValues:function(e,t){var r=this.buildUrl(e,null,this.INITIAL_CONTROLS_VALUES_TEMPLATE_URL),n=this.sendRequest(r,t).then(this.dataConverter.convertResponseToControlsState);return s.Utils.showLoadingDialogOn(n,null,!0),n},fetchControlsUpdatedValues:function(e,n){var o=this.buildUrl(this.currentReportUri,e,this.CONTROLS_VALUES_TEMPLATE_URL),a=this.dataConverter;this.fullUpdateDeferred&&"pending"==this.fullUpdateDeferred.state()&&this.fullUpdateDeferred.reject();var i=new t.Deferred,l=s.Utils.wait(s.DataTransfer.FREQUENT_CHANGES_MIN_DELAY);return l.done(r.bind(function(){this.sendRequest(o,n).then(a.convertResponseToControlsState).done(function(e){"pending"==i.state()&&i.resolve(e)}).fail(function(){i.reject(this,arguments)})},this)),i.fail(function(){l.reject()}),s.Utils.showLoadingDialogOn(i,null,!0),this.fullUpdateDeferred=i,i}},{CONTROLS_STRUCTURE_TEMPLATE_URI:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}",INITIAL_CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/values",CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}/values",FREQUENT_CHANGES_MIN_DELAY:400})})}(JSON,l,i,n.Controls),r.exports=n.Controls});