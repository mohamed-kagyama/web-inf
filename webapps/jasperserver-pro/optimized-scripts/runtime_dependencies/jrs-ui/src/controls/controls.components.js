/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","../namespace/namespace","jquery","underscore","./controls.base","runtime_dependencies/js-sdk/src/components/singleSelect/view/SingleSelectNew","runtime_dependencies/js-sdk/src/components/multiSelect/view/MultiSelect","runtime_dependencies/js-sdk/src/components/singleSelect/dataprovider/SearcheableDataProvider","runtime_dependencies/js-sdk/src/components/dateAndTime/DateAndTimePicker","runtime_dependencies/js-sdk/src/components/multiSelect/dataprovider/selectedItemsDataProviderSorterFactory","runtime_dependencies/js-sdk/src/common/util/parse/date","./dataprovider/InputControlsDataProvider","./dataprovider/InputControlsDataProviderWithDataLabelHash","runtime_dependencies/js-sdk/src/common/component/tree/dataprovider/DataProviderWithSearchCache","./dataprovider/util/getInputControlsDataProviderNewPageOptions","../core/core.ajax.utils","./controls.core","./controls.basecontrol"],function(e,t,i){function n(){return n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},n.apply(this,arguments)}var a=e("../namespace/namespace"),s=a.JRS,r=e("jquery"),l=e("underscore"),o=e("./controls.base"),d=o.ControlsBase,u=e("runtime_dependencies/js-sdk/src/components/singleSelect/view/SingleSelectNew"),c=e("runtime_dependencies/js-sdk/src/components/multiSelect/view/MultiSelect"),h=(e("runtime_dependencies/js-sdk/src/components/singleSelect/dataprovider/SearcheableDataProvider"),e("runtime_dependencies/js-sdk/src/components/dateAndTime/DateAndTimePicker")),p=e("runtime_dependencies/js-sdk/src/components/multiSelect/dataprovider/selectedItemsDataProviderSorterFactory"),m=e("runtime_dependencies/js-sdk/src/common/util/parse/date"),g=e("./dataprovider/InputControlsDataProvider"),v=e("./dataprovider/InputControlsDataProviderWithDataLabelHash"),f=e("runtime_dependencies/js-sdk/src/common/component/tree/dataprovider/DataProviderWithSearchCache"),S=e("./dataprovider/util/getInputControlsDataProviderNewPageOptions"),C=e("../core/core.ajax.utils"),b=C.showErrorPopup;e("./controls.core"),e("./controls.basecontrol");var E=function(e){return e.reduce(function(e,t){return e[t.value]=t.label||t.value,e},{})};s.Controls=function(e,t,i){function a(e){var t=i.BaseControl.prototype.get.call(this,"selection");t&&t[0]===e||this.set({selection:[e]})}function r(e){return e.toUpperCase().replace(/([\s]+$|^[\s]+)/g,"").replace(/[\s]*(\+|\-)[\s]*/g,"$1")}return t.extend(i,{Bool:i.BaseControl.extend({setValue:function(e){var t=this.getElem(),i=t.find("input");"true"==e?i.prop("checked",!0):i.prop("checked",!1)},bindCustomEventListeners:function(){this.getElem()&&this.getElem().on("change","input",t.bind(function(e){var t=null==e.target.getValue()?"false":"true";this.set({selection:[t]})},this))}}),SingleValueText:i.BaseControl.extend({setValue:function(e){var t=e==d.NULL_SUBSTITUTION_VALUE?d.NULL_SUBSTITUTION_LABEL:e,i=this.getElem();i&&(i.find("input").attr("value",t),i.find("input").val(t))},bindCustomEventListeners:function(){this.getElem()&&this.getElem().on("change","input",t.bind(function(e){var t=e.target.value,i=t==d.NULL_SUBSTITUTION_LABEL?d.NULL_SUBSTITUTION_VALUE:t;this.set({selection:[i]})},this))}}),SingleValueNumber:i.BaseControl.extend({setValue:function(e){this.getElem().find("input").attr("value",e),this.getElem().find("input").val(e)},bindCustomEventListeners:function(){this.getElem()&&this.getElem().on("change","input",t.bind(function(e){this.set({selection:[e.target.value]})},this))}}),SingleValueDate:i.BaseControl.extend({initialize:function(e){this.baseRender(e),e.visible&&this.getElem()&&this.setupCalendar()},get:function(e){var t=i.BaseControl.prototype.get.call(this,e);return m.localizedDateToIsoDate(t)},set:function(e,t){e.values&&(e.values=m.isoDateToLocalizedDate(e.values)),i.BaseControl.prototype.set.call(this,e,t)},setupCalendar:function(){var i=this.getElem().find("input");this.picker=new h({el:i,showOn:"button",dateFormat:s.i18n.bundledCalendarFormat,disabled:i[0].disabled,onSelect:t.bind(a,this)}),i.change(t.bind(function(t){t.stopPropagation(),e(t.target).val(r(t.target.value)),a.call(this,e(t.target).val())},this)),i.after("&nbsp;"),this.getElem().find("button").wrap(d.CALENDAR_ICON_SPAN).empty()},setValue:function(e){var t=this.getElem();t.find("input").attr("value",e),t.find("input").val(e)}}),SingleValueDatetime:i.BaseControl.extend({initialize:function(e){this.baseRender(e),e.visible&&this.getElem()&&this.setupCalendar()},getInput:function(){var e=this.getElem();return e&&e.find("input")},destroyCalendar:function(){this.getInput().off(),this.picker&&this.picker.remove()},setupCalendar:function(){var i=this.getElem(),n=this.getInput();this.destroyCalendar(),this.picker=new h({el:n[0],showOn:"button",dateFormat:s.i18n.bundledCalendarFormat,timeFormat:s.i18n.bundledCalendarTimeFormat,disabled:n[0].disabled,onSelect:t.bind(a,this)}),n.change(t.bind(function(t){t.stopPropagation(),e(t.target).val(r(t.target.value)),a.call(this,e(t.target).val())},this)),n.after("&nbsp;"),i.find("button").wrap(d.CALENDAR_ICON_SPAN).empty()},get:function(e){var t=i.BaseControl.prototype.get.call(this,e);return m.localizedTimestampToIsoTimestamp(t)},set:function(e,t){e.values&&(e.values=m.isoTimestampToLocalizedTimestamp(e.values)),e.values||e.selection||!this.getInput()||this.setupCalendar(),i.BaseControl.prototype.set.call(this,e,t)},setValue:function(e){var t=this.getElem();t.find("input").attr("value",e),t.find("input").val(e)}}),SingleValueTime:i.BaseControl.extend({initialize:function(e){this.baseRender(e),e.visible&&this.getElem()&&this.setupCalendar()},getInput:function(){var e=this.getElem();return e&&e.find("input")},destroyCalendar:function(){this.getInput().off(),this.picker&&this.picker.remove()},setupCalendar:function(){var i=this.getElem(),n=this.getInput();this.destroyCalendar(),this.picker=new h({el:n[0],showOn:"button",timeFormat:s.i18n.bundledCalendarTimeFormat,disabled:n[0].disabled,onClose:t.bind(a,this)}),n.change(t.bind(function(t){t.stopPropagation(),e(t.target).val(r(t.target.value)),a.call(this,e(t.target).val())},this)),n.after("&nbsp;"),i.find("button").wrap(d.CALENDAR_ICON_SPAN).empty()},get:function(e){var t=i.BaseControl.prototype.get.call(this,e);return m.localizedTimeToIsoTime(t)},set:function(e,t){e.values&&(e.values=m.isoTimeToLocalizedTime(e.values)),e.values||e.selection||!this.getInput()||this.setupCalendar(),i.BaseControl.prototype.set.call(this,e,t)},setValue:function(e){var t=this.getElem();t.find("input").attr("value",e),t.find("input").val(e)}}),SingleSelect:i.BaseControl.extend({initialize:function(e){var a=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=s.initialSelectedValues;this.dataUri=s.dataUri,this.inputControlsService=s.inputControlsService,this.paginatedValuesOptions=s.paginatedValuesOptions,this.singleSelect||(this.inputControlsDataProviderWithDataLabelHash=new v({inputControlsDataProvider:new g({controlId:e.id,inputControlsService:this.inputControlsService})}),this.dataProviderWithCache=new f({pageSize:100,maxSearchCacheSize:1,request:function(e){e=S(n({name:a.id,paginatedValuesOptions:a.paginatedValuesOptions},e));var t=a.inputControlsDataProviderWithDataLabelHash.getData(a.dataUri,e);return i.Utils.showLoadingDialogOn(t,null,!0),t}}),this.initialSelectedValuesToLabelMap=E(r),this.singleSelect=new u({getData:this.dataProviderWithCache.getData,formatValue:function(e){return a.inputControlsDataProviderWithDataLabelHash.getLabelByValue(e)||a.initialSelectedValuesToLabelMap[e]}}).setDisabled(e.readOnly),e&&t.extend(this,e))},render:function(){var t=i.TemplateEngine.createTemplate(this.type);if(t){this.singleSelect.undelegateEvents();var n=e(t(this));this.singleSelect.render().renderData(),n.find(".ssPlaceholder").append(this.singleSelect.el),this.setElem(n),this.singleSelect.delegateEvents(),this.makeResizable&&this.makeResizable(),this.isVisible(this)&&this.bindCustomEventListeners()}},setValue:function(e){this.singleSelect.setValue(e,{silent:!0})},updateSelectionOnOptionChange:function(e){this.initialSelectedValuesToLabelMap=E(e)},fetch:function(t,i){var n=this;this.dataUri=t,this.paginatedValuesOptions=i;var a=e.Deferred();return this.singleSelect.off("listRenderError").once("listRenderError",function(e){b(e.responseJSON.message),a.reject(e),n.bindCustomEventListeners()}),this.dataProviderWithCache.clear(),this.singleSelect.fetch(function(){a.resolve.apply(a,arguments)}),a},bindCustomEventListeners:function(){this.singleSelect.off("selection:change").on("selection:change",function(e){this.fireControlSelectionChangeEvent([e])},this),this.singleSelect.off("listRenderError").on("listRenderError",function(e){b(e.responseJSON.message)})}}),MultiSelect:i.BaseControl.extend({initialize:function(e){var a=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=s.initialSelectedValues;this.dataUri=s.dataUri,this.inputControlsService=s.inputControlsService,this.paginatedValuesOptions=s.paginatedValuesOptions,this.multiSelect||(this.inputControlsDataProviderWithDataLabelHash=new v({inputControlsDataProvider:new g({controlId:e.id,inputControlsService:this.inputControlsService})}),this.dataProviderWithCache=new f({pageSize:100,maxSearchCacheSize:1,request:function(e){e=S(n({name:a.id,paginatedValuesOptions:a.paginatedValuesOptions},e));var t=a.inputControlsDataProviderWithDataLabelHash.getData(a.dataUri,e);return i.Utils.showLoadingDialogOn(t,null,!0),t}}),this.initialSelectedValuesToLabelMap=E(r),this.multiSelect=new c({getData:this.dataProviderWithCache.getData,selectedListOptions:{formatLabel:function(e){return a.inputControlsDataProviderWithDataLabelHash.getLabelByValue(e)||a.initialSelectedValuesToLabelMap[e]},sortFunc:p.create(d.NULL_SUBSTITUTION_LABEL)},resizable:!0}),this.multiSelect.setDisabled(e.readOnly),this._resize=t.debounce(t.bind(this.multiSelect.resize,this.multiSelect),500),e&&t.extend(this,e))},render:function(){var t=i.TemplateEngine.createTemplate(this.type);if(t){this.multiSelect.undelegateEvents();var n=e(t(this));this.multiSelect.render().renderData(),n.find(".msPlaceholder").append(this.multiSelect.el),this.setElem(n),this.multiSelect.delegateEvents(),this.makeResizable&&this.makeResizable(),this.isVisible(this)&&this.bindCustomEventListeners()}},setValue:function(e){this.multiSelect.setValue(e,{silent:!0}),this._resize()},updateSelectionOnOptionChange:function(e){this.initialSelectedValuesToLabelMap=E(e)},fetch:function(t,i){var n=this,a=e.Deferred();return this.dataUri=t,this.paginatedValuesOptions=i,this.dataProviderWithCache.clear(),this.multiSelect.off("listRenderError").once("listRenderError",function(e){b(e.responseJSON.message),a.reject(e),n.bindCustomEventListeners()}),this.multiSelect.fetch(function(){a.resolve.apply(a,arguments)}),a},bindCustomEventListeners:function(){this.multiSelect.off("selection:change").on("selection:change",function(e){this.fireControlSelectionChangeEvent(e)},this),this.multiSelect.off("listRenderError").on("listRenderError",function(e){b(e.responseJSON.message)})},get:function(e){var i=this[e];return"selection"===e&&t.isEmpty(i)?[]:i},makeResizable:function(){var e=this.multiSelect.$el.find(".jr-mSizer");e.length&&e.detach().insertAfter(this.getElem()&&this.getElem().find(".resizeOverlay"))}}),SingleSelectRadio:i.BaseControl.extend({initialize:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e&&t.extend(this,e),this.dataUri=i.dataUri,this.inputControlsService=i.inputControlsService,this.paginatedValuesOptions=i.paginatedValuesOptions,this.inputControlsDataProvider=new g({controlId:e.id,inputControlsService:this.inputControlsService})},render:function(){var t=i.TemplateEngine.createTemplate(this.type);if(t){var n=e(t(this));this.setElem(n),this.makeResizable&&this.makeResizable(),this.isVisible(this)&&this.bindCustomEventListeners()}return this.fetch(this.dataUri,this.paginatedValuesOptions)},fetch:function(e,t){var i=this;return this._fetchData(e,t).then(function(e){i._renderData(e.data)})},_fetchData:function(e,t){this.dataUri=e,this.paginatedValuesOptions=t;var i=S({name:this.id,paginatedValuesOptions:this.paginatedValuesOptions,offset:0});return this.inputControlsDataProvider.getData(this.dataUri,i)},_renderData:function(n){var a=this,s=this.getElem()&&this.getElem().find("ul")[0];if(s){var r=n.map(function(e){var i=t.clone(e);return i.readOnly=a.readOnly,i.name=a.getOptionName(),i.uuid=t.uniqueId(a.id),i}),l=this.getTemplateSection("data");i.Utils.setInnerHtml(s,l,{data:r}),s=e(s),s.html(s.html()+"&nbsp;"),s.find("li").length<5&&this.getElem()[0].clientHeight<125?(this.getElem().find(".jr-mSizer").addClass("hidden"),this.getElem().find(".inputSet").removeClass("sizable").attr("style",!1)):this.resizable&&(this.getElem().find(".jr-mSizer").removeClass("hidden"),this.getElem().find(".inputSet").addClass("sizable"))}},getOptionName:function(){return this.id+"_option"},bindCustomEventListeners:function(){var e=this;this.getElem().on("change","input",function(t){var i=t.target.value;setTimeout(function(){e.set({selection:[i]})})})},makeResizable:function(){this.resizable=!0;var e=this.getElem().find("ul"),t=this.getElem().find(".jr-mSizer").removeClass("hidden");t.addClass("ui-resizable-s"),e.resizable({handles:{s:t}})}}),MultiSelectCheckbox:i.BaseControl.extend({initialize:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e&&t.extend(this,e),this.dataUri=i.dataUri,this.inputControlsService=i.inputControlsService,this.paginatedValuesOptions=i.paginatedValuesOptions,this.inputControlsDataProvider=new g({controlId:e.id,inputControlsService:this.inputControlsService})},render:function(){var t=i.TemplateEngine.createTemplate(this.type);if(t){var n=e(t(this));this.setElem(n),this.makeResizable&&this.makeResizable(),this.isVisible(this)&&this.bindCustomEventListeners()}return this.fetch(this.dataUri,this.paginatedValuesOptions)},fetch:function(e,t){var i=this;return this._fetchData(e,t).then(function(e){i._renderData(e.data)})},_fetchData:function(e,t){this.dataUri=e,this.paginatedValuesOptions=t;var i=S({name:this.id,paginatedValuesOptions:this.paginatedValuesOptions,offset:0});return this.inputControlsDataProvider.getData(this.dataUri,i)},_renderData:function(n){var a=this,s=n.map(function(e){var i=t.clone(e);return i.readOnly=a.readOnly,i.uuid=t.uniqueId(a.id),i}),r=this.getElem()&&this.getElem().find("ul")[0];if(r){var l=this.getTemplateSection("data");i.Utils.setInnerHtml(r,l,{data:s}),e(r).find("li").length<5&&this.getElem()[0].clientHeight<125?(this.getElem().find(".jr-mSizer").addClass("hidden"),this.getElem().find(".inputSet").removeClass("sizable").attr("style",!1)):this.resizable&&(this.getElem().find(".jr-mSizer").removeClass("hidden"),this.getElem().find(".inputSet").addClass("sizable"))}},getSelection:function(){var i=this.getElem().find(":checkbox").filter(":checked");return t.map(i,function(t){return e(t).val()})},bindCustomEventListeners:function(){var i=this;this.getElem().on("change","input",function(e){var t=i.getSelection();setTimeout(function(){i.set({selection:t})})}),this.getElem().on("click","a",function(n){var a=i.getElem().find("input"),s=e(n.target)[0].name;"multiSelectAll"===s||"multiSelectNone"===s?t.each(a,function(e){e.checked="multiSelectAll"===s}):"multiSelectInverse"===s&&t.each(a,function(e){e.checked=!e.checked}),i.getElem().find("input").change()})},get:function(e){var i=this[e];return"selection"===e&&t.isEmpty(i)?[]:i},makeResizable:function(){this.resizable=!0;var e=this.getElem().find("ul"),t=this.getElem().find(".jr-mSizer").removeClass("hidden");t.addClass("ui-resizable-s"),e.resizable({handles:{s:t}})}})})}(r,l,s.Controls),i.exports=s.Controls});