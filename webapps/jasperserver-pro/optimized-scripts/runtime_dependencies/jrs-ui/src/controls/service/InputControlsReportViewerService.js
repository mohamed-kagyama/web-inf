/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../converter/inputControlsToViewModelConverter","../converter/getControlPaginationOptionsByControlIdAndType","../rest/enum/restParamsEnum","../predicate/isQueryControl","../converter/getControlsPaginationOptionsByControlId"],function(e,t,n){function r(e,t){return u(e)||i(e,t)||o()}function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function i(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,o=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return n}}function u(e){if(Array.isArray(e))return e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(n,!0).forEach(function(t){f(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=e("jquery"),v=e("underscore"),h=e("../converter/inputControlsToViewModelConverter"),y=e("../converter/getControlPaginationOptionsByControlIdAndType"),C=e("../rest/enum/restParamsEnum"),S=e("../predicate/isQueryControl"),m=e("../converter/getControlsPaginationOptionsByControlId"),g=function(e,t,n,r){return e.reduce(function(e,o){if(S(o)){var i=d({},e,f({},o.id,m({controlId:o.id,controls:t}).map(n)));return void 0!==r&&r(i[o.id]),i}return e},{})},O=function(e){var t=e.controlId,n=e.value,r=e.controls,o=e.selection,i=v.reduce(r,function(e,r){var i={};return i=r.id===t?{value:n.length>0?n:[C.NOTHING_SUBSTITUTION_VALUE]}:{value:o[r.id]||[],select:C.SELECTED_VALUES},d({},e,f({},r.id,d({masterDependencies:r.masterDependencies||[],slaveDependencies:r.slaveDependencies||[]},i)))},{});return m({controlId:t,controls:i})},P=function(){function e(t){a(this,e),f(this,"inputControlsService",void 0),f(this,"requestedSelectionParams",void 0),this.inputControlsService=t.inputControlsService,this.requestedSelectionParams={}}return c(e,[{key:"fetchInputControlsInitialState",value:function(e,t){var n=this;return this.inputControlsService.getInputControlsMetadata(e).then(function(r){if(r){var o=h.metadataToViewModelConverter(r);return n.fetchRequestParamsThroughURL(o,t),n.fetchInitialInputControlsValuesByUriAndStructure(e,o)}return p.Deferred().resolve(r)})}},{key:"fetchRequestParamsThroughURL",value:function(e,t){var n=this,r=v.pluck(e,"id"),o=v.keys(t),i=v.intersection(r,o);i.length>0&&i.forEach(function(e){n.requestedSelectionParams[e]=t[e]})}},{key:"fetchInitialInputControlsValuesByUri",value:function(e,t){return this.fetchInitialInputControlsValuesByUriAndStructure(e,t)}},{key:"fetchInputControlsOptionsBySelectionAndUri",value:function(e,t,n){var r=n.reduce(function(e,t){return d({},e,f({},t.id,t))},{}),o=v.map(e,function(t,n){return y(n,r[n].type,{value:t&&0===t.length?[C.NOTHING_SUBSTITUTION_VALUE]:e[n]||[]})}),i=g(n,r,function(t){return d({},t,{value:e[t.name]||[]})});return this.fetchInputControlsOptionsByPaginatedValuesOptionsAndUri({paginationOptions:o,paginationOptionsPerControl:i,uri:t}).then(function(e){return p.Deferred().resolve(e,o,i)})}},{key:"fetchInputControlsValuesOnControlSelectionChange",value:function(e){var t=e.controlId,n=e.value,r=e.uri,o=e.structure,i=e.selection,u=e.initialSelectedValues,a=n.reduce(function(e,t){return d({},e,f({},t,!0))},{}),l=o.reduce(function(e,t){return d({},e,f({},t.id,t))},{}),c=O({controlId:t,value:n,selection:i,controls:l}),s=u[t]&&u[t].every(function(e){return a[e.value]});return this.fetchInputControlsOptionsByPaginatedValuesOptionsAndUri({paginationOptions:c,uri:r}).then(function(e){var t=e.inputControlState,n=c.reduce(function(e,n){if(n.select===C.SELECTED_VALUES){var r=[];if(s&&u[n.name])r=u[n.name].map(function(e){return e.value});else{var o=t.find(function(e){return e.id===n.name});if(o){var i=o.options.find(function(e){return e.selected});r=i?[i.value]:[]}}return d({},e,f({},n.name,r))}return e},{});return p.Deferred().resolve(e,n,c)})}},{key:"fetchInitialInputControlsValuesByUriAndStructure",value:function(e,t){var n=this,o=t.map(function(e){return y(e.id,e.type,n.requestedSelectionParams[e.id]?{value:n.requestedSelectionParams[e.id]}:{select:C.SELECTED_VALUES})}),i=this.inputControlsService.getInputControlsPaginatedValues(e,o),u=this.inputControlsService.getInputControlsSelectedValues(e);return p.when(i,u).then(function(o,i){var u=r(i,1),a=u[0],l=o instanceof Array?o[0]:o,c={};c=v.isEmpty(n.requestedSelectionParams)?a?a.selectedValue.reduce(function(e,t){return d({},e,f({},t.id,t.options||[]))},{}):{}:l.inputControlState.reduce(function(e,t){var n=t.options?t.options.filter(function(e){return e.selected}).map(function(e){return v.omit(e,"selected")}):[{label:t.value,value:t.value}];return d({},e,f({},t.id,n||[]))},{});var s=t.reduce(function(e,t){return d({},e,f({},t.id,n.requestedSelectionParams[t.id]?d({},t,{value:n.requestedSelectionParams[t.id]}):d({},t,{select:C.SELECTED_VALUES})))},{}),h=g(t,s,function(e){return n.requestedSelectionParams[e.name]?d({},e,{value:n.requestedSelectionParams[e.name]}):d({},e,{select:C.SELECTED_VALUES})},function(t){n.inputControlsService.setCacheValueForControlPaginatedValues(e,t,l)});return p.Deferred().resolve({structure:t,selection:c,paginationOptionsPerControl:h,paginatedValuesResponse:l})})}},{key:"fetchInputControlsOptionsByPaginatedValuesOptionsAndUri",value:function(e){var t=this,n=e.paginationOptions,r=e.paginationOptionsPerControl,o=void 0===r?{}:r,i=e.uri;return this.inputControlsService.clearCache(),this.inputControlsService.getInputControlsPaginatedValues(i,n).then(function(e){return n.forEach(function(n){var r=n.name;o[r]&&t.inputControlsService.setCacheValueForControlPaginatedValues(i,o[r],e)}),e})}}]),e}();n.exports=P});