/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","../namespace/namespace","../core/core.layout","./controls.core","../util/utils.common","../components/components.dialogs","./controls.base","./controls.options","../namespace/namespace","../reportViewer/report.view.base","settings!inputControls","jquery","underscore","runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog","runtime_dependencies/js-sdk/src/components/overlay/Overlay","../core/core.ajax.utils","../reportViewer/report.view.base","./controls.controller"],function(e,o,t){var n=e("prototype"),r=n.$,i=n.$$,s=e("../namespace/namespace"),l=s.JRS,a=e("../core/core.layout"),c=e("./controls.core"),p=e("../util/utils.common"),u=p.centerElement,O=p.matchAny,d=p.triggerNativeEvent,h=p.isIPad,C=p.selectAndFocusOn,g=e("../components/components.dialogs"),f=e("./controls.base"),_=f.ControlsBase,v=f.OptionsDialog,m=f.ControlDialog,S=e("./controls.options"),T=e("../namespace/namespace"),A=T.isProVersion,N=e("../reportViewer/report.view.base"),L=(e("settings!inputControls"),e("jquery")),R=e("underscore"),w=e("runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog"),D=e("runtime_dependencies/js-sdk/src/components/overlay/Overlay"),U=e("../core/core.ajax.utils"),I=U.showErrorPopup;e("../reportViewer/report.view.base"),e("./controls.controller");var P=function(){var e=!R.isUndefined(R.find(N.parametersWithoutDefaultValues,function(e){return!R.contains(R.keys(N.getAllRequestParameters()),e)}));return N.hasInputControls&&(N.reportForceControls||e&&R.isEmpty(N.reportParameterValues))},E=function(e,o,t,n){return o.extend(t,{_messages:{},layouts:{LAYOUT_POPUP_SCREEN:1,LAYOUT_SEPARATE_PAGE:2,LAYOUT_TOP_OF_PAGE:3,LAYOUT_IN_PAGE:4},controlDialog:null,reportOptionsDialog:null,inputControlsLocation:null,toggleControlsOn:!1,controller:null,hideControls:null,selectionChanged:!0,initialInputControlsFetched:!1,initialize:function(){this.controller=new l.Controls.Controller({reportUri:n.reportUnitURI,reportOptionUri:n.reportOptionsURI}),this.viewModel=t.controller.getViewModel(),this.initializeOptions();var i=o.debounce(function(){t.applyInputValues(!0)},t.Utils.LOADING_DIALOG_DELAY,!0),s=o.debounce(function(){t.applyInputValues()},t.Utils.LOADING_DIALOG_DELAY,!0),c=o.debounce(function(){t.cancel()},t.Utils.LOADING_DIALOG_DELAY,!0),p=o.debounce(function(){t.resetToInitial()},t.Utils.LOADING_DIALOG_DELAY,!0);this.buttonActions={"button#ok":i,"button#apply":s,"button#cancel":c,"button#reset":p,"button#save":t.save,"button#remove":t.remove};var d={"button#ok":i,"button#cancel":c,"button#reset":p,"button#apply":s,"button#save":t.save,"button#remove":t.remove};r(_.INPUT_CONTROLS_DIALOG)&&(this.controlDialog=new m(d)),r(_.INPUT_CONTROLS_FORM)&&r(_.INPUT_CONTROLS_FORM).observe("click",function(e){var o=e.element();for(var t in this.buttonActions)if(O(o,[t],!0))return this.buttonActions[t](),void e.stop()}.bindAsEventListener(this)),this.inputControlsLocation=r(r(_.INPUT_CONTROLS_CONTAINER)?_.INPUT_CONTROLS_CONTAINER:_.INPUT_CONTROLS_FORM),r(_.TOOLBAR_CONTROLS_BUTTON)&&(this.toggleControlsOn=r(_.TOOLBAR_CONTROLS_BUTTON).hasClassName("down")),l.Controls.listen({"viewmodel:selection:changed":function(){t.selectionChanged=!0},"reportoptions:selection:changed":function(e,o){t.selectionChanged=!0}});var h=P();h||n.hasInputControls&&(t.layouts.LAYOUT_IN_PAGE,n.reportControlsLayout);if(n.hasInputControls){var C=this._fetchAndSetInputControlsStateOnce().then(function(){var o=t.controller.getViewModel(),n=o.areAllControlsValid();if(!h&&n)return t.refreshReport().catch(function(){return e.Deferred().resolve()});t.show(),t.controlDialog.show()}).catch(function(e){var o=t.refreshReport();t.Utils.showLoadingDialogOn(o,null,!0)}).always(function(){var o=t.controller.getViewModel(),r=o.areAllControlsValid();!h&&r||n&&n.nothingToDisplay&&(n.nothingToDisplay.removeClassName(a.HIDDEN_CLASS),u(n.nothingToDisplay,{horz:!0,vert:!0}),e("#"+n.DATA_REFRESH_BUTTON).attr(a.DISABLED_ATTR_NAME,a.DISABLED_ATTR_NAME))});t.Utils.showLoadingDialogOn(C,null,!0)}else{var g=t.refreshReport();t.Utils.showLoadingDialogOn(g,null,!0)}},initializeOptions:function(){function i(){var o;(o=e(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+_.INPUT_CONTROLS_DIALOG:"#"+_.INPUT_CONTROLS_FORM))&&o.length>0&&o.addClass("showingSubHeader")}function s(){var o;(o=e(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+_.INPUT_CONTROLS_DIALOG:"#"+_.INPUT_CONTROLS_FORM))&&o.length>0&&o.removeClass("showingSubHeader")}if(A()){var a;a=this.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+_.INPUT_CONTROLS_DIALOG+" .sub.header":(this.layouts.LAYOUT_TOP_OF_PAGE,n.reportControlsLayout,"#"+_.INPUT_CONTROLS_FORM+" .sub.header");var c=new S;c.fetch(n.reportUnitURI,n.reportOptionsURI).done(function(){e(a).append(c.getElem()),t.lastReportOptionsSelection=c.get("selection")}).fail(function(){e(a).addClass("hidden")}).always(function(){t.lastReportOptionsSelection||(t.lastReportOptionsSelection=c.get("defaultOption"))}),c.updateWarningMessage=function(){t.reportOptionsDialog.showWarning(this.error)},l.Controls.listen({"viewmodel:selection:changed":function(){var e=c.find({uri:n.reportUnitURI});c.set({selection:e},!0)},"viewmodel:order:changed":o.bind(function(e,t){n.newIcOrder=o.pluck(t,"id").join(";")},this)});var p={"button#saveAsBtnSave":function(){var o=t.reportOptionsDialog.input.getValue(),r=t.viewModel.get("selection"),s=o===t.reportOptionsDialog.optionNameToOverwrite;c.add(n.reportUnitURI,o,r,s).done(function(){t.reportOptionsDialog.hideWarning(),g.systemConfirm.show(_.getMessage("report.options.option.saved")),i();var o=c.getElem().parent();o.length>0?o.removeClass("hidden"):(e(a).removeClass("hidden"),e(a).append(c.getElem())),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&e("#"+_.INPUT_CONTROLS_FORM+" .header").removeClass("hidden"),t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}).fail(function(e){if(e)try{"report.options.dialog.confirm.message"===JSON.parse(e.responseText).errorCode&&!s&&(t.reportOptionsDialog.optionNameToOverwrite=o)}catch(e){}})},"button#saveAsBtnCancel":function(){t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}};r(_.SAVE_REPORT_OPTIONS_DIALOG)&&(this.reportOptionsDialog=new v(p)),this.remove=function(){var o=c.get("selection").label,r=new w({text:_.getMessage("report.options.option.confirm.remove",{option:o})});r.on("button:yes",function(){c.removeOption(n.reportUnitURI,c.get("selection").id).done(function(){if(!c.get("values")){s();var o=c.getElem().parent();o.length>0?o.addClass("hidden"):(e(a).addClass("hidden"),e(a).html("")),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&e("#"+_.INPUT_CONTROLS_FORM+" .header").addClass("hidden")}c.enableRemoveButton(!1),g.systemConfirm.show(_.getMessage("report.options.option.removed"))}),r.remove()}),r.on("button:no",function(){r.remove()}),r.open()},t.reportOptions=c}},cancel:function(){t.ViewModel.isSelectionChanged(t.lastSelection,t.viewModel.get("selection"));if(n.reportControlsLayout===t.layouts.LAYOUT_SEPARATE_PAGE&&t.separatePageICLayoutFirstShow)n.goBack();else{var e=this._refreshControlsToSelection(t.lastSelection);e.then(function(){}).catch(function(e){I(e.responseJSON.message)}).always(function(){n.reportControlsLayout===t.layouts.LAYOUT_POPUP_SCREEN?t.controlDialog.hide():n.reportControlsLayout===t.layouts.LAYOUT_SEPARATE_PAGE&&t.showReport(),t.reportOptions&&t.lastReportOptionsSelection&&t.reportOptions.set({selection:t.lastReportOptionsSelection},!0)}),t.Utils.showLoadingDialogOn(e,null,!0)}},_refreshControlsToSelection:function(e){return t.controller.resetControlsToSelection(e)},getLastSelection:function(){return this.lastSelection},save:function(){t.selectionChanged?t.controller.validate().then(t.showOptionDialog):t.showOptionDialog()},refreshReport:function(o){if(o){var n=new e.Deferred,r=n.promise(),i=t.viewModel.get("selection");if(!l.Controls.ViewModel.isSelectionChanged(t.lastSelection,i))return n.resolve(),r()}return this._refreshReportOnConfirm()},_refreshReportOnConfirm:function(){var r,i=t.viewModel.get("selection");try{return i&&!o.isEmpty(i)?(r=n.refreshReport(null,null,_.buildSelectedDataUri(i)),t.lastSelection=i):(r=n.refreshReport(),t.lastSelection={}),r}catch(o){return e.Deferred().reject(o)}},_refreshReportOnApply:function(){var r=e.Deferred(),i=t.viewModel.get("selection");return i&&!o.isEmpty(i)?n.refreshReport(null,null,_.buildSelectedDataUri(i)):r.resolve()},applyInputValues:function(i){var s=t.viewModel;t.selectionChanged?t.controller.validate().then(function(s){if(s){var l,a=t.lastSelection;t.reportOptions&&(l=t.lastReportOptionsSelection),window.viewer&&window.viewer.jive&&window.viewer.jive.hide();var c=t.refreshReport();c&&c.then(function(){t.selectionChanged=!1,i&&t.hide()},function(){var r=new D({zIndex:g.errorPopup.getZIndex()-1});e("body").append(r.$el),r.show(),t.lastSelection=a,t.lastReportOptionsSelection=l,g.errorPopup.onClose=function(){n.hasError=!0,t.lastSelection&&!o.isEmpty(t.lastSelection)?n.refreshReport(null,null,_.buildSelectedDataUri(t.lastSelection)):n.refreshReport(),r.remove()},i&&(t.cancel(),t.hide(),t.selectionChanged=!1)}),t.reportOptions&&(t.lastReportOptionsSelection=t.reportOptions.get("selection"),c||g.popup.hide(r("loading")))}}):s.areAllControlsValid()&&i&&t.hide()},resetToInitial:function(){var e=this._refreshControlsToSelection(t.initialSelection).then(function(){t.selectionChanged=!0;var e=t.reportOptions;if(e){var o=e.find({uri:n.reportOptionsURI?n.reportOptionsURI:n.reportUnitURI});if(o)return void e.set({selection:o})}},function(e){I(e.responseJSON.message)});t.Utils.showLoadingDialogOn(e,null,!0)},show:function(){switch(n.reportControlsLayout){case 2:t.showControls();break;case 3:t.toggleControls();break;case 4:break;default:t.showDialog()}},hide:function(){switch(n.reportControlsLayout){case 2:t.showReport();break;case 3:case 4:break;default:t.controlDialog.hide()}},toggleControls:function(){var o=function(){r(_.TOOLBAR_CONTROLS_BUTTON).removeClassName("up").addClassName("down"),i(".panel.pane.inputControls")[0].removeClassName(a.HIDDEN_CLASS)};t.toggleControlsOn?function(){r(_.TOOLBAR_CONTROLS_BUTTON).removeClassName("down").addClassName("up"),i(".panel.pane.inputControls")[0].addClassName(a.HIDDEN_CLASS),d("resize")}():this._fetchAndSetInputControlsStateOnce().then(function(){o()}).catch(function(e){I(e.responseJSON.message)}),t.toggleControlsOn=!t.toggleControlsOn,h()&&n.touchController.reset(),e("#"+_.INPUT_CONTROLS_FORM).show().height()},showDialog:function(){t.controlDialog&&this._fetchAndSetInputControlsStateOnce().then(function(){t.controlDialog.show()}).catch(function(e){I(e.responseJSON.message)})},showReport:function(){r(a.PAGE_BODY_ID).removeClassName(a.CONTROL_PAGE_CLASS).addClassName(a.ONE_COLUMN_CLASS)},showControls:function(){var o=function(){r(a.PAGE_BODY_ID).removeClassName(a.ONE_COLUMN_CLASS).addClassName(a.CONTROL_PAGE_CLASS),document.getElementById(_.INPUT_CONTROLS_FORM)&&e("#"+_.INPUT_CONTROLS_FORM).show()};this._fetchAndSetInputControlsStateOnce().then(function(){o()}).catch(function(e){I(e.responseJSON.message)})},showOptionDialog:function(){l.Controls.Utils.wait(200).then(function(){t.viewModel.areAllControlsValid()&&(t.reportOptionsDialog.show(),C(t.reportOptionsDialog.input))})},_fetchAndSetInputControlsStateOnce:function(){var r=this,i=e.Deferred();if(this.initialInputControlsFetched)i.resolve();else{var s=o.extend(n.getAllRequestParameters(),n.reportParameterValues);this.controller.fetchAndSetInputControlsState(s).then(function(){r.initialInputControlsFetched=!0;var e=t.controller.getViewModel(),o=e.get("selection");return t.lastSelection=o,t.initialSelection=o,i.resolve()},function(){i.reject.apply(i,arguments)}),t.Utils.showLoadingDialogOn(i,null,!0)}return i}})}(L,R,c,N);t.exports=E});