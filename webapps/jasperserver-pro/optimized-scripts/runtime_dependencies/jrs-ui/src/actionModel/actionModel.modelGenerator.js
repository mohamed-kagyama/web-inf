/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","underscore","../util/utils.common","../core/core.buttonManager","./actionModel.json.property","../core/core.layout","../namespace/namespace","jquery"],function(e,t,n){function o(e){var t=new RegExp("&nbsp;","g");return e.replace(t," ")}function i(e,t){var n=T(e);n&&n()}function u(e,t,n){var o,i=_(t);(i=i||(o=_("localContext."+t)))&&(e=p.isArray(e)?e:[e],i.apply(o?window.localContext:null,e))}function a(e,t,n,o,a){if(!e)return null;if(t){var s=r(t,n,o,a);return function(){u(s,e,a)}}return function(){i(e,a)}}function s(e,t,n,o,i,u){var a=null==u||u,s=T(e);return s&&(a=s.apply(this,r(t,n,o,null)),i&&(a=!a)),a}function r(e,t,n,o){return e?e.collect(function(e){return l(e,t,n,o)}):[]}function l(e,t,n,o){return e==C.RES_SELECTED?C.selObjects:e==C.RES_LABEL?t:e==C.RES_ID?n:e==C.EVENT?o:e}function d(){return"_"+Math.round(50*Math.random(10))}var c=e("prototype"),m=c.$,p=e("underscore"),f=e("../util/utils.common"),h=f.isIE,S=f.isNotNullORUndefined,b=f.isSupportsTouch,M=f.fitObjectIntoScreen,T=f.getAsFunction,v=f.getWindowHeight,E=f.getWindowWidth,_=f.toFunction,N=e("../core/core.buttonManager"),A=e("./actionModel.json.property"),I=e("../core/core.layout"),O=e("../namespace/namespace"),D=O.isProVersion,w=e("jquery"),C={};C.SIMPLE_ACTION="simpleAction",C.SELECT_ACTION="selectAction",C.INPUT_ACTION="inputAction",C.OPTION_ACTION="optionAction",C.SEPARATOR="separator",C.SINGLE_SELECT_CONSTRAINT="singleSelect",C.HIGH_Z_INDEX=99999,C.RES_LABEL="$label",C.RES_ID="$id",C.RES_SELECTED="$selected",C.EVENT="$event",C.selObjects=[],C.lastItemWasSeparator=!1,C.noItemsYet=!0,C.data=null,C.openedSubMenus=[],C.parentMenu="",C.menuDom=null,C.menuListDom=null,C.PARENT_MENU_CONTAINER="menuList",C.PARENT_MENU_STYLE="menu vertical context hidden",C.SIMPLE_ACTION_DOM_ID="menuList_simpleAction",C.SEPARATOR_DOM_ID="menuList_separator",C.FLYOUT_PARENT_DOM_ID="menuList_flyout",C.EXTRA_INPUT_DOM_ID="menuList_extraInput",C.LIST_ITEM_DOM_ID="menuList_listItem",C.DISPLAY_STYLE="inline",C.DROP_DOWN_MENU_CLASS="dropDown",C.MOUSE_OUT_PATTERNS=["#"+I.MENU_ID,"."+I.MENU_ROOT_CLASS,".toolbar .capsule",".header > .button.mutton","#"+I.MENU_ID+" *",I.MENU_ROOT_CLASS+" *"],C.showDynamicMenu=function(e,t,n,o,i,u){if(null==e){if(!D())return;var a=window.designerBase.getSelectedObject();if(!a||!a.menuLevel)return;e=a.menuLevel}C.resetMenu(e),C.updateCSSClass(n),C.initActionModelData(i),C.assembleMenuFromActionModel(e,t,C.menuListDom,u),C.setMenuPosition(C.menuDom,t,o),C.setMenuEventHandlers(C.menuDom,e),h()&&w("#"+C.menuDom.id).prepend('<div class="msshadow"></div>'),C.makeMenuVisible(C.menuDom),C.adjustMenuPosition(C.menuDom,e),t&&"click"!==t.type&&"folder_mutton"!==e&&w(C.MOUSE_OUT_PATTERNS.join(",")).on("mouseout",C.closeHandler)},C.closeHandler=function(e){var t=w(e.relatedTarget);(t.hasClass("mutton")||t.parents(".mutton").length)&&e.relatedTarget||"menu"===t.attr("id")||t.parents("#menu").length||(w("body").trigger("actionmodel-mouseout"),C.hideMenu())},C.resetMenu=function(e){var t=e.indexOf("toolbar")>-1?"toolbar":"actionmenu",n=m("menu");n.parentId=void 0,n.setAttribute("tabIndex",-1),n.setAttribute("js-navtype",t),n.childElements().each(function(e){Element.remove(e)}),w(n).html(w(m("commonMenu").cloneNode(!0)).html());var o=n.down("ul"),i=o.readAttribute("id");o.writeAttribute("id",C.updateTemplateId(i)),o.writeAttribute("js-navtype",n.getAttribute("js-navtype")),n.className=C.PARENT_MENU_STYLE,n.writeAttribute("style",""),C.menuDom=n,C.menuListDom=o,C.lastInputSrc="none"},C.updateTemplateId=function(e){var t=new RegExp("_template");return e.replace(t,"")},C.updateCSSClass=function(e){S(e)&&(m(C.menuDom).className=e+" hidden")},C.setMenuPosition=function(e,t,n){var o,i=t||window.event;o=i?b()&&i.changedTouches?{x:i.changedTouches[0].pageX+20,y:i.changedTouches[0].pageY}:Event.pointer(i):{x:0,y:0};var u,a;S(n)?(u=S(n.menuLeft)?n.menuLeft:o.x,a=S(n.menuTop)?n.menuTop:o.y):(u=o.x,a=o.y),e.setStyle({left:u+"px",top:a+"px"})},C.adjustMenuPosition=function(e,t,n,o,i){m(e).hasClassName(this.DROP_DOWN_MENU_CLASS)&&!m(e).hasClassName("fitable")||M(e,null,n,null,i)},C.assembleMenuFromActionModel=function(e,t,n,o){C.noItemsYet=!0;var i=C.data&&C.data[e];o&&(i=o(e,i)),i&&i.each(function(e){C.appendToMenu(e,t,n)}),C.removeTrailingSeparator()},C.initActionModelData=function(e){C.data="navigationActionModel"===e?A.JSON:p.isString(e)?w("#"+e).html().evalJSON():e},C.appendToMenu=function(e,t,n){if(C.passesClientTest(e)){var o=a(T(e.action),e.actionArgs,e.text,e.id,t);C.appendDesiredRowType(e,t,o,n)}},C.appendDesiredRowType=function(e,t,n,o){var i=function(){C.isMenuShowing()&&C.hideMenu(),n&&n()};e.type==C.SIMPLE_ACTION&&C.addSimpleActionRow(e,i,o),e.type!=C.SEPARATOR||C.lastItemWasSeparator||C.addSeparatorRows(e,o),e.type==C.SELECT_ACTION&&C.addSelector(e,o,t),e.type==C.OPTION_ACTION&&C.addOption(e,i,o)},C.addSimpleActionRow=function(e,t,n){var i=null;i=e.className&&"requiresInput"==e.className?m(C.EXTRA_INPUT_DOM_ID).cloneNode(!0):m(C.SIMPLE_ACTION_DOM_ID).cloneNode(!0),b()?i.ontouchend=t:i.onmouseup=t,i.onmouseup_saved=t;var u=m(i).down(".button"),a=document.createTextNode(e.text);a.nodeValue=o(a.nodeValue),u.appendChild(a);var s=i.readAttribute("id")+d();i.writeAttribute("id",s),C.insertMenuRow(n,i,!1,e.isDisabled,e.id,null)},C.addSeparatorRows=function(e,t){var n=null;if(!C.noItemsYet){var o=m(C.SEPARATOR_DOM_ID).cloneNode(!0),i=o.readAttribute("id")+d();o.writeAttribute("id",i),e.className&&(n=e.className),C.insertMenuRow(t,o,!0,e.isDisabled,null,n)}},C.addOption=function(e,t,n){if(C.passesClientTest(e)){var i=null,u=m(C.LIST_ITEM_DOM_ID).cloneNode(!0);e.button=!(!e.button||"true"!=String(e.button).toLowerCase()),b()?u.ontouchend=t:u.onmouseup=t,u.onmouseup_saved=t;var a=m(u).down(".button"),r=document.createTextNode(e.text);r.nodeValue=o(r.nodeValue),a.appendChild(r);var l=u.readAttribute("id")+d();u.writeAttribute("id",l),e.className&&(i=e.className),!e.button&&s(e.isSelectedTest,e.isSelectedTestArgs,e.text,e.id,!1,!1)&&a.addClassName("down"),C.insertMenuRow(n,u,!1,e.isDisabled,e.id,i)}},C.addSelector=function(e,t,n){var i;if("flyout"==e.className){if(e&&e.children.length>0){i=m(C.FLYOUT_PARENT_DOM_ID).cloneNode(!0);var u=m(i).down(".button"),s=document.createTextNode(e.text);s.nodeValue=o(s.nodeValue),u.appendChild(s);var r=i.readAttribute("id")+d();i.writeAttribute("id",r),C.insertMenuRow(t,i,!1,e.isDisabled,e.id,null);var l=C.menuDom.cloneNode(!1);l.writeAttribute("id",i.readAttribute("id")+"_subMenu"),w(l).html(w(m("commonMenu").cloneNode(!0)).html());var c=l.down("ul"),p=c.readAttribute("id");c.writeAttribute("id",C.updateTemplateId(p)),i.appendChild(l);var f=l.select("ul")[0],h=f.writeAttribute("id",f.readAttribute("id")+"_subMenu");C.buildSubMenu(e,h,n)}}else e.children.each(function(e){var o=a(T(e.action),e.actionArgs,e.text,e.id,n);C.appendDesiredRowType(e,n,o,t)})},C.getSubMenuLeft=function(e){return m(e).up(2).clientWidth+Math.abs(parseInt(m(e).up(1).offsetLeft))},C.getSubMenuTop=function(e){return Math.abs(parseInt(m(e).offsetTop))},C.showChildSubmenu=function(e){var t,n,o=e.parentNode.parentNode.parentNode.id,i=!1;for(t=0;t<C.openedSubMenus.length;t++)C.openedSubMenus[t]==o&&(n=t,i=!0,w("#"+o+">div.content>ul").children("li.node").each(function(){C.hideChildSubmenu(w(this).get(0))})),i&&w("#"+C.openedSubMenus[t]+">div.content>ul").children("li.node").each(function(){C.hideChildSubmenu(w(this).get(0))});C.openedSubMenus.splice(n,C.openedSubMenus.length-n);var u=null,a=null,s=null,r=e.childElements()[1];if(r){r.setStyle({display:C.DISPLAY_STYLE}),r.setStyle({position:"absolute"});var l=C.getSubMenuLeft(e),d=0;r.setStyle({left:l+"px",top:d+"px"}),h()&&w(r).prepend('<div class="msshadow"></div>'),C.makeMenuVisible(r),u=m(r).cumulativeOffset()[1],a=m(r).getHeight();var c=v(),p=u+a;c<p&&(d=c-p-20,r.setStyle({top:d+"px"}));var f=r.cumulativeOffset()[0];s=r.getWidth(),E()<f+s&&r.setStyle({left:"-"+s+"px"}),C.openedSubMenus.push(o)}},C.hideChildSubmenu=function(e){var t=e.childElements()[1];t.setStyle({display:"none"}),t.setStyle({position:"absolute"}),t.setStyle({left:0}),C.makeMenuInVisible(m(t))},C.makeMenuVisible=function(e){e.down("ul").childElements().length>0&&(e.setStyle({zIndex:C.HIGH_Z_INDEX}),m(e).removeClassName("hidden"))},C.makeMenuInVisible=function(e){e.addClassName("hidden")},C.buildSubMenu=function(e,t,n){e.children.each(function(e){C.appendToMenu(e,n,m(t))})},C.isMenuShowing=function(){return!("none"==m("menu").getStyle("display")||m("menu").hasClassName("hidden"))},C.updateRowDom=function(e,t){if(e){w(e).html(t);var n=e.readAttribute("id")+d();e.writeAttribute("id",n)}return e},C.launchNewMenu=function(){C.hideMenu(),alert("action not implemented...")},C.insertMenuRow=function(e,t,n,o,i,u){null==t.readAttribute("id")&&(i?t.setAttribute("id",i):t.identify()),o&&C.disableMenuOption(t),u&&t.addClassName(u),t.setAttribute("js-navtype",e.getAttribute("js-navtype")),e.appendChild(t),C.lastItemWasSeparator=n,C.noItemsYet=!1},C.disableMenuOption=function(e){N.disable(e),p.isEmpty(e.childNodes)&&N.disable(e.childNodes[0])},C.passesClientTest=function(e){var t,n=!0;if(e.clientTest){t=e.clientTest;var o=!1;t.startsWith("!")&&(t=e.clientTest.sub("!",""),o=!0),n=s(t,e.clientTestArgs,e.text,e.id,o,null)}var i=C.selObjects;return p.isEmpty(i)||n&&e.selectionConstraint&&(n=e.selectionConstraint==C.SINGLE_SELECT_CONSTRAINT?1==i.length:i.length>1),n},C.removeTrailingSeparator=function(){var e=C.menuListDom.lastChild;if(m(e)&&!C.noItemsYet){var t=e.identify();new RegExp("w*separatorw*").test(t)&&e.remove()}},C.getMenuParent=function(){return m(C.menuDom.parentId)},C.getFirstMenuButton=function(){return C.menuDom.down(I.BUTTON_PATTERN,0)},C.focusMenu=function(){var e=w("#"+C.menuDom.id);if(!w.contains(e,document.activeElement)){C.lastFocused=document.activeElement;var t=e.find(I.BUTTON_PATTERN);t.length>0&&m(t[0]).focus()}},C.showDropDownMenu=function(e,t,n,o,i){t=w(t);var u=t.offset(),a={menuLeft:u.left,menuTop:u.top+t.height()-1};C.showDynamicMenu(n,e,o,a,i)},C.setMenuEventHandlers=function(e,t){e.select("li").each(function(e){e.hasClassName("disabled")||(e.hasClassName("node")?b()?Event.observe(e,"touchstart",function(t){t.firstCall||C.showChildSubmenu(e),t.firstCall=!0}):(Event.observe(e,"mouseenter",function(t){C.showChildSubmenu(e)}),"folder_mutton"!==t&&Event.observe(e,"mouseleave",function(t){C.hideChildSubmenu(e)})):"folder_mutton"===t&&Event.observe(e,"mouseover",function(t){C.showChildSubmenu(e)}))})},C.initializeOneTimeMenuHandlers=function(){},C.hideMenu=function(){if(C.isMenuShowing()){var e=function(){var e=C.lastFocused;try{e&&e.focus()}catch(e){}};!b()&&setTimeout(e,0),C.makeMenuInVisible(m("menu")),w(C.MOUSE_OUT_PATTERNS.join(",")).off("mouseout",C.closeHandler)}},C.createMenuElement=function(e,t){if(!e)throw new Error("Can not construct actionModel object: type can not be empty");return Object.extend({type:e},t)},C.setSelected=function(e){C.selObjects=e},C.getMenuMouseupFunction=a,n.exports=C});