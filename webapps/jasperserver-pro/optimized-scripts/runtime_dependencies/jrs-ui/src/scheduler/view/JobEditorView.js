/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","bundle!all","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","../saveDialog/SaveDialogView","../../components/components.dialogs","./editor/ScheduleTabView","./editor/ParametersTabView","./editor/OutputTabView","./editor/NotificationsTabView","text!../template/jobEditorViewTemplate.htm"],function(e,t,i){var a=e("jquery"),r=e("underscore"),s=e("backbone"),o=e("bundle!all"),n=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),l=e("../saveDialog/SaveDialogView"),d=e("../../components/components.dialogs"),h=e("./editor/ScheduleTabView"),c=e("./editor/ParametersTabView"),u=e("./editor/OutputTabView"),p=e("./editor/NotificationsTabView"),m=e("text!../template/jobEditorViewTemplate.htm");i.exports=s.View.extend({editMode:!1,runNowMode:!1,events:{"mouseup [name=tabs] li":"tabChangeClickEvent","touchend [name=tabs] li":"tabChangeClickEvent","click [name=openSaveDialog]":"openSaveDialogClick","click [name=cancelJobCreation]":"cancelJobCreationClick"},initialize:function(e){this.options=r.extend({},e),this.tabs={},this.listenTo(this.model,"valid",this.validModelListener),this.listenTo(this.model,"invalid",this.invalidModelListener),this.listenTo(this.model,"clearAllErrors",this.clearAllValidationErrors),this.listenTo(this.model,"change:source",this.sourceKeyInModelChanged),this.listenTo(this.model,"failedToGet_IC",this.InputControlsNotLoaded),this._initializeTabs(e),this.listenTo(this.tabs.parametersTab,"IC_Displayed",this.InputControlsLoaded),this.listenTo(this.tabs.parametersTab,"failedToGet_IC",this.InputControlsNotLoaded)},_initializeTabs:function(e){var t={model:this.model,reportUri:e.reportUri,parentReportURI:e.parentReportURI};this.tabs.scheduleTab=new h(t),this.tabs.parametersTab=new c(t),this.tabs.outputTab=new u(t),this.tabs.notificationsTab=new p(t)},remove:function(){this.tabs.scheduleTab.remove(),this.tabs.parametersTab.remove(),this.tabs.outputTab.remove(),this.tabs.notificationsTab.remove(),s.View.prototype.remove.apply(this,arguments)},tabChangeClickEvent:function(e){var t=this,i=a(e.currentTarget),r=i.attr("data-tab");i.hasClass("disabled")||this.currentActiveTabName!==r&&this.model.validateAll(this.editMode).always(function(){t.$el.find("[name="+t.currentActiveTabName+"]").find(".error").length||(t.changeActiveTab(r),t.clearAllValidationErrors())})},openSaveDialogClick:function(){this.startSavingProcess()},cancelJobCreationClick:function(){this.trigger("cancelJobCreation")},renderCreateNewJobInterface:function(){this.editMode=!1,this._render(),this.options.runInBackgroundMode||this.runNowMode?this.changeActiveTab("outputTab"):this.changeActiveTab("scheduleTab"),this.prepareSaveOrSubmitButton()},prepareModelForCreatingNewJob:function(){this.model.clear({silent:!0}),this.model.unset("id"),this.dontReactOnModelChange=!0,this.model.createFromUri(this.options.reportUri),this.dontReactOnModelChange=!1,this.runNowMode&&this.model.set("label","Immediate Execution"),this.model.loadParameters(this.options.parentReportURI||!1)},editExistingJob:function(e){var t=this;this.editMode=!0,this.model.clear({silent:!0}),this._render(),this.changeActiveTab("scheduleTab"),this.model.set({id:e}),this.prepareSaveOrSubmitButton(),this.model._fetched?(this.model.set(this.model.parse(this.model._fetched)),this.setTitle(this.model.get("label")),this.model._fetched=void 0):this.model.fetch({success:function(){t.setTitle(t.model.get("label"))}})},prepareSaveOrSubmitButton:function(){var e=this.$el.find("[name=openSaveDialog]"),t=this.$el.find(".footer #cancel");e.attr("disabled","disabled").addClass("disabled"),t.attr("disabled",null).removeClass("disabled"),this.saveButtonReady=new a.Deferred,this.saveButtonReady.done(function(){e.attr("disabled",null).removeClass("disabled")})},InputControlsLoaded:function(){this.saveButtonReady.resolve()},InputControlsNotLoaded:function(){this.saveButtonReady.resolve(),this.toggleEnableTab("parametersTab",!1)},setRunNowMode:function(e){this.runNowMode=!!e},_render:function(){var e={i18n:o,reportUri:this.options.reportUri,runNowMode:this.runNowMode};this.setElement(a(r.template(m,r.extend({},e)))),this.runNowMode&&this.$el.find("li[data-tab=scheduleTab]").addClass("disabled"),this.tabs.outputTab.options.editMode=this.editMode,this.tabs.scheduleTab.render(),this.tabs.parametersTab.render(),this.tabs.outputTab.render(),this.tabs.notificationsTab.render(),this.$el.find("[name=scheduleTab]").append(this.tabs.scheduleTab.$el),this.$el.find("[name=parametersTab]").append(this.tabs.parametersTab.$el),this.$el.find("[name=outputTab]").append(this.tabs.outputTab.$el),this.$el.find("[name=notificationsTab]").append(this.tabs.notificationsTab.$el),this.currentActiveTabName=""},setTitle:function(e){this.$el.find(".pageHeader-title-text").text(e)},changeActiveTab:function(e){e&&("error"===e&&(e=this.$el.find("[name=tabHolder] > div").find(".error").first().parents(".tab").attr("name")),this.currentActiveTabName!==e&&(this.$el.find("[name=tabs] li").removeClass("selected").filter("[data-tab="+e+"]").addClass("selected"),this.$el.find("[name=tabHolder] > div").addClass("hidden").filter("[name="+e+"]").removeClass("hidden"),this.currentActiveTabName=e))},toggleEnableTab:function(e,t){var i=this.$el.find("[name=tabs] li").filter("[data-tab="+e+"]");i.attr("disabled",!t).toggleClass("disabled",!t),!t&&i.hasClass("selected")&&this.changeActiveTab(i.nextAll(":not(.disabled):first").data("tab"))},sourceKeyInModelChanged:function(e,t){var i;if(!0!==this.dontReactOnModelChange){t.parameters&&(i=1===r.keys(t.parameters.parameterValues).length,i&=!!t.parameters.parameterValues.REPORT_TIME_ZONE);var a=t.parameters&&!i;a||this.saveButtonReady.resolve(),this.toggleEnableTab("parametersTab",a),this.$el.find(".pageHeader-subtitle-path").find(".pageHeader-subtitle-path-text").text(t.reportUnitURI)}},_prepareSaveDialog:function(){var e=this;this.saveDialog&&this.saveDialog.remove(),this.saveDialog=new l(r.extend({},this.options,{model:this.model,isEditMode:this.editMode,onSaveDone:r.bind(this._onSaveDone,this),onSaveFail:r.bind(this._onSaveFail,this)})),this.listenTo(this.saveDialog,"saveValidationFailed",function(){e.saveDialog.closeDialog()})},startSavingProcess:function(){var e=this;this.model.validateAll(this.editMode).done(function(){e._prepareSaveDialog(),e.saveDialog.startSaveDialog()}).fail(function(){e.changeActiveTab("error")})},_onSaveDone:function(){this.trigger("jobHasBeenCreated")},_onSaveFail:function(e,t,i){var a=!1,s=!1,l=!1;this.saveDialog.closeDialog();try{a=JSON.parse(t.responseText)}catch(e){}if(a.error&&(a=a.error),r.isArray(a)||(a=[a]),r.each(a,function(e){var t=this,i="",a="";if("mandatory.parameter.error"===e.errorCode&&(i=o["report.scheduling.saveDialog.parameterIsMissing"],e.parameters&&e.parameters[0]&&(a=e.parameters[0].substr(e.parameters[0].indexOf(".")+1))),"error.duplicate.report.job.output.filename"===e.errorCode&&(a="baseOutputFilename",i=o["error.duplicate.report.job.output.filename"].replace("{0}",e.errorArguments[0]).replace("{1}",e.errorArguments[1])),e.message&&-1!==e.message.indexOf("will never fire")&&(a="triggerWillNeverFire",i=o["error.report.job.trigger.no.fire"]),"error.pattern"===e.errorCode&&("trigger.hours"===e.field&&(a="hours",i=o["error.pattern.trigger.hours"]),"trigger.minutes"===e.field&&(a="minutes",i=o["error.pattern.trigger.minutes"]),"trigger.monthDays"===e.field&&(a="datesInMonth",i=o["error.pattern.trigger.monthDays"]),"contentRepositoryDestination.timestampPattern"===e.field&&(a="timestampPattern",i=o["error.pattern.contentRepositoryDestination.timestampPattern"])),"resource.not.found"===e.errorCode){var r=new n({modal:!0,additionalCssClasses:"schedulerJobRemovedAlertDialog"});return r.setMessage(o["report.scheduling.editing.jobHasBeenRemoved"]),this.listenTo(r,"close",function(){t.trigger("errorEditingJob")}),r.open(),void(s=!0)}""!==i&&(this.showValidationMessage("error",{field:a,message:i}),l=!0)}),!0!==s&&(l&&this.changeActiveTab("error"),!1===l)){var h=o["report.scheduling.editing.failedToSave"]+".";a[0]&&a[0].errorCode?h+="<br/>The reason is: "+a[0].errorCode:a.message&&(h+="<br/>The reason is: "+a.message),h+="<br/><br/>The full response from the server is: "+t.responseText,d.errorPopup.show(h)}},clearAllValidationErrors:function(){this.$el.find(".error").removeClass("error")},validModelListener:function(e){var t=this;r.each(e,function(e){t.showValidationMessage("success",e)})},invalidModelListener:function(e,t){var i=this;r.each(e,function(e){i.showValidationMessage("error",e)}),t&&t.switchToErrors&&this.changeActiveTab("error")},showValidationMessage:function(e,t){if(t.field){"contentRepositoryDestination.folderURI"===t.field&&(t.field="contentRepositoryDestination.outputRepository"),t.field=t.field.replace("trigger.",""),t.field=t.field.replace("mailNotification.",""),t.field=t.field.replace("contentRepositoryDestination.","");var i=this.$el.find(".warning[data-field="+t.field+"]");i.parent().addClass("error"),i.removeClass("success").removeClass("error"),i.addClass(e);var a="";if(t.message)a=t.message;else if(t.errorCode){if(!(a=o[t.errorCode]))return;if(t.errorArguments)for(var r=0,s=t.errorArguments.length;r<s;r++)a=a.replace("{"+r+"}",t.errorArguments[r])}""!==a&&i.text(a)}}})});