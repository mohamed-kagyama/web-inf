/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","../model/ImportModel","../model/ImportStateModel","../enum/importPendingStatesEnum","../enum/brokenDependencyStrategyEnum","../../export/view/LoadingDialog","./MergeTenantDialogView","./ImportDependentResourcesDialogView","./ImportWarningsDialogView","../factory/warningsFactory","runtime_dependencies/js-sdk/src/common/component/notification/Notification","runtime_dependencies/js-sdk/src/common/view/mixin/epoxyViewMixin","text!../template/importTemplate.htm","bundle!ImportExportBundle","bundle!CommonBundle","text!../../templates/secretKeyTemplate.htm","../../model/CustomKeyModel","runtime_dependencies/bi-repository/src/bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory","settings!treeComponent","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","../enum/secureKeyTypeEnum","../enum/importRestErrorCodesEnum","../factory/importErrorMessageFactory"],function(e,t,i){function o(e,t){n(e,!1),e.applyEpoxyBindings(),e.notification.show({delay:!1,message:t&&t.responseJSON&&t.responseJSON.message}),e.trigger("error",e,t)}function n(e,t){c(m.template(_,{i18n:S,i18n2:I,model:m.extend(e.model.toJSON(),{secureKeyTypes:F}),showCustomKey:t,showKeyValue:!0,exportMode:!1})).insertAfter(e.$el.find("fieldset:first"))}function r(){var e=this.stateModel.get("warnings");return m.map(e,function(e){return D(e)})}function s(e,t){t=t||"warning";var i=r.call(this);"import.finished"!==e||m.isEmpty(i)||this.warningsDialogView.open({items:i}),this.notification.show({delay:!1,message:N.create(e),type:t}),this.trigger("import:finished",this.model.get("organization")),this.model.reset(this.type,{},this.customKeyElements)}function l(){var e=this.stateModel.get("error");e.errorCode===g.BROKEN_DEPS?this.dependentResourcesDialogView.open({items:e.parameters}):e.errorCode===g.TENANT_MISMATCH&&this.mergeTenantDialogView.open({fileTenantId:e.parameters[0],selectedTenantId:this.model.get("organization")})}function a(e,t){return function(i){e.model.set("brokenDependencies",t),e.doImport()}}function d(e){this.model.cancel(),this.stateModel.set("phase",e)}var c=e("jquery"),m=e("underscore"),u=e("backbone"),p=e("../model/ImportModel"),h=e("../model/ImportStateModel"),g=e("../enum/importPendingStatesEnum"),y=e("../enum/brokenDependencyStrategyEnum"),f=e("../../export/view/LoadingDialog"),E=e("./MergeTenantDialogView"),T=e("./ImportDependentResourcesDialogView"),v=e("./ImportWarningsDialogView"),D=e("../factory/warningsFactory"),C=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),w=e("runtime_dependencies/js-sdk/src/common/view/mixin/epoxyViewMixin"),K=e("text!../template/importTemplate.htm"),S=e("bundle!ImportExportBundle"),I=e("bundle!CommonBundle"),_=e("text!../../templates/secretKeyTemplate.htm"),b=e("../../model/CustomKeyModel"),k=e("runtime_dependencies/bi-repository/src/bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory"),M=e("settings!treeComponent"),V=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),F=e("../enum/secureKeyTypeEnum"),x=e("../enum/importRestErrorCodesEnum"),N=e("../factory/importErrorMessageFactory"),R=u.View.extend({tagName:"form",className:"import-view",id:"importDataFile",events:{"change input[type='file']":"validateFile","change input.jr-jDefaultKey, input.jr-jKeyValue, input.jr-jKeyFile , input.jr-juniversalKeyValue,  input.jr-jCustomKey":"_onKeyTypeChange","input input.jr-jSecretKey":"_onSecretKeyInput","input input.jr-jSecretUri":"_onSecretFileInput","click button.jr-jRepositoryBrowserButton":"_onRepositoryBrowserButtonClick","click .checkBox label":"_clickOnCheckbox","change .control.select.inline":"_onCustomKeyInput"},computeds:{isKeyUseUniversal:{deps:["keyType"],get:function(e){return e===F.UNIVERSALKEY}},isKeyUseCustom:{deps:["keyType"],get:function(e){return e===F.CUSTOMKEY}},isKeyUseValue:{deps:["keyType"],get:function(e){return e===F.VALUE}},isKeyUseFile:{deps:["keyType"],get:function(e){return e===F.FILE}}},initialize:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.model||(this.model=new p(null,{form:this.el})),this.stateModel=new h,this.customKeyStateModel=new b,this.loadingDialog=new f({content:I["dialog.overlay.loading"]});var i=k.getDialog("item");this.keyFileDialog=t.keyFileDialog||new i({disableListTab:!0,treeBufferSize:parseInt(M.treeLevelLimit,10),resourcesTypeToSelect:[V.SECURE_FILE]}),this.keyFileDialog.on("close",function(){if(e.keyFileDialog.selectedResource&&e.keyFileDialog.selectedResource.resourceUri){var t=e.keyFileDialog.selectedResource.resourceUri;e.model.set("secretUri",t),e._clearSecureKeyErrors()}}),this.mergeTenantDialogView=new E,this.dependentResourcesDialogView=new T,this.warningsDialogView=new v,this.notification=new C,this.listenTo(this.stateModel,"change:phase",this._handleImportPhase,this);var o={delay:!1,message:S["import.error.cancelled"]},n={delay:!1,message:S["import.error.unexpected"]};this.listenTo(this.model,"change",this._onModelChange),this.listenTo(this.model,"error:notFound",m.bind(this.notification.show,this.notification,o)),this.listenTo(this.stateModel,"error:notFound",m.bind(this.notification.show,this.notification,o)),this.listenTo(this.model,"error:internalServerError",m.bind(this.notification.show,this.notification,n)),this.listenTo(this.stateModel,"error:internalServerError",m.bind(this.notification.show,this.notification,n)),this.listenTo(this.model,"error",m.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.stateModel,"error",m.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.mergeTenantDialogView,"button:import",function(){this.model.set("mergeOrganization",!0),this.doImport()},this),this.listenTo(this.mergeTenantDialogView,"button:cancel",m.bind(d,this,h.STATE.CANCELLED)),this.listenTo(this.dependentResourcesDialogView,"button:skip",a(this,y.SKIP)),this.listenTo(this.dependentResourcesDialogView,"button:include",a(this,y.INCLUDE)),this.listenTo(this.dependentResourcesDialogView,"button:cancel",m.bind(d,this,h.STATE.CANCELLED)),this.epoxifyView()},render:function(e){var t=this;return this.type=e.type,this.model.reset(this.type,{organization:e.tenantId}),this.$el.html(m.template(K)({i18n:S,i18n2:I,model:m.extend(this.model.toJSON(),{secureKeyTypes:F})})),this.customKeyStateModel.getCustomKeys().done(function(e){if(e&&0===e.length)n(t,!1);else if(e&&e.responseJSON&&e.responseJSON.error)o(t,e);else{t.customKeyElements=e,t.model.set("keyAlias",e[0].alias),n(t,!0);for(var i=0;i<e.length;++i){var r=c("<option />").attr("value",e[i].alias);r.text(e[i].label?e[i].label:e[i].alias),t.$el.find("#importCustomKey").append(r)}}t.applyEpoxyBindings()}).fail(function(e){o(t,e)}),this},validateFile:function(e){this.model.set("fileName",c(e.target).val());var t=c(e.target),i=t.parent();this.model.isValid(!0)?i.removeClass("error"):i.addClass("error")},doImport:function(){var e=this,t=new c.Deferred,i=this;return this.loadingDialog.open(),this.model.isValid(!0)?t=this.model.save().fail(function(t){e._onImportFail(t)}).always(function(e){i.stateModel.set(e)}):t.reject(),t},_onImportFail:function(e){var t=e.errorCode;t===x.INVALID_SECRET_KEY?this.model.set("invalidKeyError",S["import.invalid.secretKey"]):t===x.INVALID_SECRET_FILE_CONTENT?this.model.set("invalidSecureFileContentError",S["import.invalid.secretUri.secretFile"]):t===x.INVALID_SECRET_FILE?this.model.set("invalidSecureFileContentError",S["import.invalid.secretUri"]):t===x.INVALID_SECRET_KEY_LENGTH&&this.model.set("invalidKeyError",S["import.invalid.secretKey.length"])},_handleImportPhase:function(){var e=this.stateModel.get("phase");e!==h.STATE.INPROGRESS&&this.loadingDialog.close(),e===h.STATE.READY?s.call(this,"import.finished","success"):e===h.STATE.FAILED?this.stateModel.get("error")&&this.stateModel.get("error").errorCode?s.call(this,this.stateModel.get("error").errorCode):this.stateModel.get("message")&&s.call(this,this.stateModel.get("message")):e===h.STATE.CANCELLED?s.call(this,"import.error.cancelled"):e===h.STATE.PENDING&&l.call(this)},_onRepositoryBrowserButtonClick:function(){this.keyFileDialog.open()},_clearSecureKeyErrors:function(){this.model.set({invalidKeyError:"",invalidSecureFileContentError:""})},_onKeyTypeChange:function(e){var t=e.target.value,i=this.$el.find('input[name ="key-alias"]')[0],o=this.$el.find("#importCustomKey")[0]&&this.$el.find("#importCustomKey")[0].selectedIndex;t==F.CUSTOMKEY?i.value=c(".control.select.inline").find("option")[o].value:t==F.UNIVERSALKEY?i.value=t:i.value=""==t?F.DEFAULTKEY:"",this.model.set("keyType",t),this._clearSecureKeyErrors()},_onSecretKeyInput:function(e){var t=e.target.value;this.model.set("secretKey",t,{silent:!0}),this._clearSecureKeyErrors()},_onSecretFileInput:function(e){var t=e.target.value;this.model.set("secretUri",t,{silent:!0}),this._clearSecureKeyErrors()},_clickOnCheckbox:function(e){var t=c(e.target).next();t[0].disabled||(t[0].checked=!t[0].checked,t.trigger("change"))},_onCustomKeyInput:function(e){var t=e.target.selectedIndex,i=c(".control.select.inline").find("option")[t];this.model.set("keyAlias",i.value,{silent:!0}),this.$el.find('input[name ="key-alias"]')[0].value=i.value},_onModelChange:function(){this.model.isValid(!0)}});m.extend(R.prototype,w),i.exports=R});