/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","../model/ExportModel","../model/ExportStateModel","../model/AuthorityPickerModel","./AuthorityPickerView","./LoadingDialog","./ExportDependentResourcesDialogView","runtime_dependencies/js-sdk/src/common/component/notification/Notification","runtime_dependencies/js-sdk/src/common/view/mixin/epoxyViewMixin","../factory/exportTemplateFactory","../enum/exportTypesEnum","bundle!ImportExportBundle","bundle!CommonBundle","settings!awsSettings","../../import/enum/secureKeyTypeEnum","../../model/CustomKeyModel"],function(e,s,t){function i(e,s,t,i,o,r){n(e,s,t,i,o,[]),e.notification.show({delay:!1,message:r&&r.responseJSON&&r.responseJSON.message}),e.trigger("error",e,r)}function o(e){this.rolesList=new p({model:g.instance("rest_v2/{{if (tenantId) { }}organizations/{{-tenantId}}/{{ } }}roles?q={{-searchString}}{{ if (excludeSubOrgs) { }}&includeSubOrgs=false{{ } }}",{tenantId:e.tenantId}),customClass:"selectedRoles",title:v["export.dialog.roles.users.roles.label"],selectLabel:v["export.dialog.roles.users.select.all.roles.label"]}),this.rolesList.on("change:selection",this.bindWithRoles),this.rolesList.render(),this.usersList=new p({model:g.instance("rest_v2/{{if (tenantId) { }}organizations/{{-tenantId}}/{{ } }}users?q={{-searchString}}{{ if (excludeSubOrgs) { }}&includeSubOrgs=false{{ } }}",{tenantId:e.tenantId}),customClass:"select selectedUsers",title:v["export.dialog.roles.users.users.label"],selectLabel:v["export.dialog.roles.users.select.all.users.label"]}),this.usersList.on("change:selection",this.bindWithUsers),this.usersList.render(),this.rolesToUsers=g.instance("rest_v2/users?hasAllRequiredRoles=false{{ if (roles) for (var i = 0; i < roles.length; i++) { }}&requiredRole={{-roles[i]}}{{ } }}"),this.rolesToUsers.on("change",this.onRolesToUsersChange),this.usersToRoles=g.instance("rest_v2/roles?hasAllUsers=false{{ if (users) for (var i = 0; i < users.length; i++) { }}&user={{-users[i]}}{{ } }}"),this.usersToRoles.on("change",this.onUsersToRolesChange),this.changeEnabledState(),this.listenTo(this.model,"change:everything",this.changeEnabledState),this.$el.find(".selectRolesUsers").append(this.rolesList.el).append(this.usersList.el),this.listenTo(this.model,"change:includeSubOrganizations",this.filterAuthoritiesBySubOrgs)}function n(e,s,t,i,n,r){e.template=h.template(T(s))({everything:!1,i18n:v,i18n2:x,encryptionHint:t,isServerOrRootType:i,isServerLevel:n,isServerCe:e.type===b.SERVER_CE,isRepository:e.type===b.REPOSITORY,isSubOrgLevel:s.isSubOrgLevel,model:h.extend(e.model.toJSON(),{secureKeyTypes:E}),showCustomKey:0!==r.length,showKeyValue:!1,exportMode:!0}),e.$el.html(e.template),e.$(".selectRolesUsers").length&&o.call(e,s),e.applyEpoxyBindings()}function r(){var e=document.createElement("iframe");e.src=this.model.url()+"/"+this.stateModel.id+"/"+this.model.get("fileName"),e.style.display="none",a("body").append(e)}function l(e){this.model.cancel(),this.stateModel.set("phase",e)}var a=e("jquery"),h=e("underscore"),d=e("backbone"),c=e("../model/ExportModel"),u=e("../model/ExportStateModel"),g=e("../model/AuthorityPickerModel"),p=e("./AuthorityPickerView"),m=e("./LoadingDialog"),y=e("./ExportDependentResourcesDialogView"),f=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),R=e("runtime_dependencies/js-sdk/src/common/view/mixin/epoxyViewMixin"),T=e("../factory/exportTemplateFactory"),b=e("../enum/exportTypesEnum"),v=e("bundle!ImportExportBundle"),x=e("bundle!CommonBundle"),S=e("settings!awsSettings"),E=e("../../import/enum/secureKeyTypeEnum"),w=e("../../model/CustomKeyModel"),C=d.View.extend({className:"export-view",events:{"change .usersWithSelectedRoles":"includeRolesByUsers","change .rolesWithSelectedUsers":"includeUsersWithRoles","change .selectedUsersRoles":"includeSelectedRolesUsersOnly","change input.jr-jDefaultKey, input.jr-jKeyValue, input.jr-jKeyFile , input.jr-juniversalKeyValue,  input.jr-jCustomKey":"_onKeyTypeChange","click .section .checkBox label":"_clickOnCheckbox","click button.jr-jRepositoryBrowserButton":"_onRepositoryBrowserButtonClick","change .control.select.inline":"_onCustomKeyInput"},computeds:{includeAccessEventsChecked:function(){return!!this.model.get("everything")&&this.model.get("includeAccessEvents")},enableAttributesValues:{deps:["everything","includeAttributes"],get:function(e,s){return!e&&s}},enableReportJobs:{deps:["everything","includeReports"],get:function(e,s){return!e&&s}},someResourceIsChecked:{deps:["everything","includeReports","includeAdHocViews","includeDashboards","includeDomains","includeDataSources","includeOtherResourceFiles"],get:function(e,s,t,i,o,n,r){return!e&&(s||t||i||o||n||r)}},isKeyDefaultValue:{deps:["keyType"],get:function(e){return e===E.DEFAULTKEY}},isKeyUniversalValue:{deps:["keyType"],get:function(e){return e===E.UNIVERSALKEY}},isKeyUseCustom:{deps:["keyType"],get:function(e){return e===E.CUSTOMKEY}}},initialize:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];h.bindAll(this,"render","doExport","handleExportPhase","filterAuthoritiesBySubOrgs","bindWithRoles","bindWithUsers","changeEnabledState","includeRolesByUsers","includeUsersWithRoles","includeSelectedRolesUsersOnly","sendParameters","onRolesToUsersChange","onUsersToRolesChange","_isServerLevel","_includeUsersOrRoles","_showNotification","_getBrokenDependencies","_clickOnCheckbox","_onModelChange","_resetModel"),this.model||(this.model=new c),this.stateModel=new u,this.customKeyStateModel=new w,this.epoxifyView(),this.loadingDialog=new m({content:x["dialog.overlay.loading"]}),this.notification=new f,this.dependentResourcesDialogView=new y,this.listenTo(this.model,"change",this._onModelChange),this.listenTo(this.stateModel,"change:phase",this.handleExportPhase,this),this.listenTo(this.model,"error:unauthorized",window.location.reload),this.listenTo(this.stateModel,"error:unauthorized",window.location.reload);var e={delay:!1,message:v["export.error.cancelled"]},s={delay:!1,message:v["export.error.unexpected"]};this.listenTo(this.model,"error:notFound",h.bind(this.notification.show,this.notification,e)),this.listenTo(this.stateModel,"error:notFound",h.bind(this.notification.show,this.notification,e)),this.listenTo(this.model,"error:internalServerError",h.bind(this.notification.show,this.notification,s)),this.listenTo(this.stateModel,"error:internalServerError",h.bind(this.notification.show,this.notification,s)),this.listenTo(this.model,"error",h.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.stateModel,"error",h.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.dependentResourcesDialogView,"button:export",h.compose(h.bind(this.dependentResourcesDialogView.close,this.dependentResourcesDialogView),h.bind(function(){r.call(this),this._showNotification({message:v["export.finished"],type:"success"})},this))),this.listenTo(this.dependentResourcesDialogView,"button:cancel",h.bind(l,this,u.STATE.CANCELLED))},_onRepositoryBrowserButtonClick:function(){this.keyFileDialog.open()},_clearSecureKeyErrors:function(){this.model.set({invalidKeyError:"",invalidSecureFileContentError:""})},_onKeyTypeChange:function(e){var s=e.target.value;this.model.set("keyType",s),this._clearSecureKeyErrors()},_onCustomKeyInput:function(e){var s=e.target.selectedIndex,t=a(".control.select.inline").find("option")[s];this.model.set("keyAlias",t.value,{silent:!0})},render:function(e){e=e||{},this.type=e.type;var s=this._isServerLevel(this.type),t=s||this.type===b.ROOT_TENANT;t?this.$el.addClass("with-events"):this.$el.removeClass("with-events"),this.stopListening(this.model,"change:includeSubOrganizations",this.filterAuthoritiesBySubOrgs),this._resetModel(e);var o=v["export.dialog.file.properties.encryption.hint"];(S.productTypeIsJrsAmi||S.productTypeIsMpAmi)&&(o=v["export.dialog.file.properties.encryption.hint.aws"]);var r=this;return this.customKeyStateModel.getCustomKeys().done(function(l){if(l&&l.responseJSON&&l.responseJSON.error)i(r,e,o,t,s,l);else{l.length&&r.model.set("keyAlias",l[0].alias),n(r,e,o,t,s,l);for(var h=0;h<l.length;++h){var d=a("<option />").attr("value",l[h].alias);d.text(l[h].label?l[h].label:l[h].alias),r.$el.find("#importCustomKey").append(d)}}}).fail(function(n){i(r,e,o,t,s,n)}),this},doExport:function(){var e=this;this.model.isValid(!0)&&(this.loadingDialog.open(),this.model.save().done(function(s){e.stateModel.unset("warnings",{silent:!0}),e.stateModel.set(s),e.model.set("id",s.id)}))},handleExportPhase:function(){var e,s=this.stateModel.get("phase"),t=this._getBrokenDependencies();s==u.STATE.READY&&(this.loadingDialog.close(),h.isEmpty(t)?(r.call(this),e={message:v["export.finished"],type:"success"}):this.dependentResourcesDialogView.open({items:t})),s==u.STATE.FAILED&&(e={message:v["export.error.unexpected"]}),s==u.STATE.CANCELLED&&(e={message:v["export.error.cancelled"]}),e&&this._showNotification(e)},filterAuthoritiesBySubOrgs:function(){var e={excludeSubOrgs:!this.model.get("includeSubOrganizations")};this.rolesList.model.setContext(e),this.usersList.model.setContext(e)},bindWithRoles:function(e){this.model.set({roles:e}),this.onUsersToRolesChange(),e.length?this.rolesToUsers.setContext({roles:e}):this.rolesToUsers.set({items:[]})},bindWithUsers:function(e){this.model.set({users:e}),this.onRolesToUsersChange(),e.length?this.usersToRoles.setContext({users:e}):this.usersToRoles.set({items:[]})},changeEnabledState:function(){var e=this.model.get("everything");this.rolesList.setDisabled(e||this.model.get("rolesForUser")),this.usersList.setDisabled(e||this.model.get("userForRoles")),e&&(this.rolesList.selectNone(),this.usersList.selectNone())},includeRolesByUsers:function(e){var s=a(e.target).is(":checked");this.model.set({rolesForUser:!s,userForRoles:s}),this.onRolesToUsersChange(),this._includeUsersOrRoles(!s,s)},includeUsersWithRoles:function(e){var s=a(e.target).is(":checked");this.model.set({rolesForUser:s,userForRoles:!s}),this.onUsersToRolesChange(),this._includeUsersOrRoles(s,!s)},includeSelectedRolesUsersOnly:function(e){a(e.target).is(":checked")&&(this.model.set({userForRoles:!1,rolesForUser:!1}),this.onRolesToUsersChange(),this.onUsersToRolesChange(),this._includeUsersOrRoles(!1,!1))},sendParameters:function(e){this.model.isValid(!0)&&this.model.save()},onRolesToUsersChange:function(){this.model.get("userForRoles")?(this.usersList.highlightSet(h.map(this.rolesToUsers.get("items"),function(e){return e.username+(e.tenantId?"|"+e.tenantId:"")})),this.rolesList.highlightSet([])):this.usersList.highlightSet([])},onUsersToRolesChange:function(){this.model.get("rolesForUser")?(this.rolesList.highlightSet(h.map(this.usersToRoles.get("items"),function(e){return e.name+(e.tenantId?"|"+e.tenantId:"")})),this.usersList.highlightSet([])):this.rolesList.highlightSet([])},_isServerLevel:function(e){return e===b.SERVER_CE||e===b.SERVER_PRO},_includeUsersOrRoles:function(e,s){this.rolesList.setDisabled(e),this.usersList.setDisabled(s),this.rolesList.selectNone(),this.usersList.selectNone()},_showNotification:function(e){e=h.defaults(e,{type:"warning"}),this.loadingDialog.isVisible()&&this.loadingDialog.close(),this.notification.show({delay:!1,message:e.message,type:e.type})},_getBrokenDependencies:function(){var e=this.stateModel.get("warnings"),s=[];return h.each(e,function(e){"export.broken.dependency"===e.code&&s.push(e.parameters)}),h.flatten(h.sortBy(s,function(e){return e}))},_clickOnCheckbox:function(e){var s=a(e.target).next();s[0].disabled||this.model.set(s[0].name,!s[0].checked)},_onModelChange:function(){this.model.isValid(!0)},_resetModel:function(e){var s={organization:this.type==b.REPOSITORY?null:e.tenantId};if(this.type===b.ROOT_TENANT||this.type===b.TENANT){var t=this.type===b.ROOT_TENANT?"root_export.zip":e.tenantId+"_export.zip";h.extend(s,{fileName:t})}this.model.reset(s,this.type)}});h.extend(C.prototype,R),t.exports=C});