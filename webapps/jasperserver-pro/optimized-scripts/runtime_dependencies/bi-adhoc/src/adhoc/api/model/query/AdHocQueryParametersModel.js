/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../enum/QueryVariableTypes"],function(e,t,n){function r(e,t){var n=t;return""===t&&"string"!==e?n=null:"~NULL~"===t&&(n=null),n}function i(e,t){return u.reduce(e,function(e,t){if(!e[t.name]){var n=t.expression.object.list?t.expression.object.list.items[0]:t.expression.object;e[t.name]=n?u.keys(n)[0]:"string"}return e},t||{})}function s(e,t){var n={};return null===t?n.NULL={}:e!==o.DATE&&e!==o.TIMESTAMP||!l.test(t)?e===o.TIMESTAMP?n[e]={value:t.replace("T"," ")}:n[e]={value:t}:e===o.DATE?n.relativeDateRange={value:t}:n.relativeTimestampRange={value:t},n}var u=e("underscore"),a=e("backbone"),o=e("../enum/QueryVariableTypes"),l=/^(DAY|WEEK|MONTH|QUARTER|SEMI|YEAR)([\+|-][\d]{1,9})?$/,c=a.Model.extend({initialize:function(e,t){this._types={},this._singular={}},toJSON:function(){var e=this;return u.map(this.attributes,function(t,n){var r={name:n};return e._singular[n]?r.expression={object:s(e._types[n],t)}:r.expression={object:{list:{items:u.map(t,u.bind(s,e,e._types[n]))}}},r})},acquire:function(e,t){var n=this,r={},s=u.reduce(t,function(e,t){return u.reduce(t.variables,function(e,t){return e[t.name]=t.type,e},e)},{});this._types=i(e,s),this._singular=u.reduce(e,function(e,t){return e[t.name]=!t.expression.object.list,e},{}),u.each(e,function(e){r[e.name]=n._determinateParameterValue(e)}),this.set(r)},set:function(){var e,t,n=this;return arguments.length>1&&u.isString(arguments[0])?(e={},e[arguments[0]]=arguments[1],t=arguments[2]):(e=arguments[0],t=arguments[1]),e=u.reduce(u.keys(e),function(t,i){return n._singular[i]?u.isArray(e[i])?e[i].length?t[i]=r(n._types[i],e[i][0]):t[i]=null:t[i]=r(n._types[i],e[i]):t[i]=u.map(e[i],u.bind(r,n,n._types[i])),t},{}),a.Model.prototype.set.call(this,e,t)},toDataComponent:function(){var e=this._types;return u.map(u.keys(this.attributes),function(t){return{id:t,type:e[t]}})},_determinateParameterValue:function(e){return e.expression.object.list?e.expression.object.list.items.length?u.map(e.expression.object.list.items,function(e){return u.values(e)[0].value}):[]:u.values(e.expression.object)[0].value}});n.exports=c});