/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","runtime_dependencies/js-sdk/src/common/util/xssUtil","./enum/dataStyle"],function(e,a,n){var r=e("underscore"),t=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),o=e("./enum/dataStyle"),s={debug:!1,fn:{getMessage:function(e){return this.messages?this.messages[e]:e},load:function(e){var a=s;a.data=e.data,a.metadata=e.metadata,a.treeNodeAxes=e.treeNodes,a.fn.load_common(),s.debug&&(console.info("Data Processor State:"),console.info(a))},load_common:function(){var e=s;if(e.measureAxis=e.metadata.measureAxis,e.nonMeasureAxis=0===e.measureAxis?1:0,e.metadata.axes.length&&(e.measureLevelNumber=e.fn.getMeasureLevelNumber.call(e),e.metadata.isOLAP&&(e.measureDimensionNumber=0,e.dimensionMappings=[],e.dimensionAllMappings=new Array(2),e.dimensionLevels=new Array(2),e.rowDimensionMapping=e.fn.dimensionMapping(0),e.dimensionMappings.push(e.rowDimensionMapping),e.colDimensionMapping=e.fn.dimensionMapping(1),e.dimensionMappings.push(e.colDimensionMapping)),e.lastRowNonMeasureLevel=0,e.lastColumnNonMeasureLevel=0,e.rowSliderLevelCount=e.metadata.axes[0].length+1-(0===e.metadata.measureAxis?1:0),e.colSliderLevelCount=e.metadata.axes[1].length+1-(1===e.metadata.measureAxis?1:0),e.rowGroupMapping=e.fn.groupMapping.call(e,0),e.colGroupMapping=e.fn.groupMapping.call(e,1)),e.treeNodeAxes.length&&(e.fn.createTreeNodeStructure.call(e,e.treeNodeAxes[0]),e.fn.createTreeNodeStructure.call(e,e.treeNodeAxes[1])),e.data.length){if(void 0===e.measureAxis)throw"AdhocDataProcessor.load_common  missing measureAxis metadata !";if(e.measureAxis>1)throw"AdhocDataProcessor.load_common  measureAxis > 1 !";if(e.measureAxis<0)throw"AdhocDataProcessor.load_common  measureAxis < 0 !";if(void 0===e.measureLevelNumber)throw"AdhocDataProcessor.load_common  measureLevelNumber undetermined !";if(e.measureLevelNumber<=0)throw"AdhocDataProcessor.load_common  measureLevelNumber <= 0 !"}},getOLAPDimensionInfo:function(){for(var e=s,a=new Array(2),n=0;n<2;n++){var r=[],t=e.dimensionMappings[n],o=e.measureAxis===n;if(t.length<=0);else for(var l=e.dimensionAllMappings[n],i=0;i<t.length;i++){var u=t[i];if(!(o&&u.length>0&&"Measures"===u[0].dimension)){var d=!1;!0===l[i]&&(d=!0);var m={};m.levels=[];var v=0;d&&m.levels.push({label:"(All)",levelName:"(All)",levelNumber:v}),v=1;for(var g=0;g<u.length;g++){var f=u[g];m.dimension=f.dimension,f.name&&"(All)"===f.name||(m.levels.push({label:f.label,levelName:f.name,levelNumber:v}),v++)}r.push(m)}}a[n]=r}return s.debug&&(console.log("AdhocDataProcessor.getOLAPDimensionInfo: 4098h  olapAxes"),console.log(a)),a},getMeasureLevelNumber:function(e){e||(e=this.metadata);for(var a=e.axes[e.measureAxis],n=0;n<a.length;n++)if("Measures"==a[n].dimension)return n+1},groupMapping:function(e){var a,n=s,r=[0],t=1,o=n.metadata.axes[e];for(a=0;a<o.length;a++)"Measures"!=o[a].dimension&&(r[t++]=a+1);return r},dimensionMapping:function(e){var a=s;if(!a.metadata.isOLAP)return null;var n=a.metadata.axes[e],r=1,t=[],o=[];if(a.metadata.axes[e].length<=0)return t;var l=0,i=!1,u=n[0].dimension,d=u;u||alert("dataprocessor.js  ERROR ! 0983jhrn   null dimension in axis "+e);for(var m=[],v=[],g=[],f=r,c=0;c<n.length;c++)if(d=n[c].dimension,"Measures"===d&&(a.measureDimensionNumber=l,a.measureLevelNumber=r),d!==u&&(i?o.push(!0):o.push(!1),g.push({dimension:u,startLevel:f,endLevel:r-1}),t.push(m),l++,m=[],i=!1,u=d,f=r),"(All)"!==n[c].label&&"(ALL)"!==n[c].label||(i=!0,!(c<n.length-1&&d===n[c+1].dimension))){var L={dimension:n[c].dimension,label:n[c].label,name:n[c].name,levelNumber:r};m.push(L),v.push(L),r++}return i?o.push(!0):o.push(!1),t.push(m),g.push({dimension:d,startLevel:f,endLevel:r-1}),a.metadata.axes[e]=v,a.dimensionAllMappings[e]=o,a.dimensionLevels[e]=g,s.debug&&(console.log("AdhocDataProcessor.dimensionMapping:49e8h  dimensions for axis "+e),console.log(t)),t},createTreeNodeStructure:function(e){var a=e;a.parent=null,a.children?this.fn.connectParentNode.call(this,a,a.children):a.children=[]},connectParentNode:function(e,a){var n,r;for(n=0;n<a.length;n++)if(r=a[n],r.parent=e,r.children){var t=r.children;t.length&&this.fn.connectParentNode.call(this,r,t)}else r.children=[]},getDataStyle:function(){var e=s;return 0===e.metadata.axes[e.nonMeasureAxis].length?o.ON_SAME_AXIS_ONLY:e.metadata.axes[e.nonMeasureAxis].length>0&&e.metadata.axes[e.measureAxis].length>1?o.ON_BOTH_AXIS:o.ON_SEPARATE_AXIS},getNodeListForSliderLevel:function(e,a){var n=s,r=n.metadata.axes[e].length,t=[];t.push({startLevel:0,endLevel:a,leafLevel:r});var o=n.fn.getNodeListForDimLevels(e,t);return s.debug&&(console.log("AdhocDataProcessor.getNodeListForSliderLevel: 4088h  nodeList for axisIndex="+e+" sliderLevel="+a),console.log(o)),o},getNodeListForDimLevelRadio:function(e,a){var n=s;if(!n.metadata.isOLAP)throw"dataprocessor.getNodeListForDimLevelRadio called RadioButton method for non-OLAP query !";if(null===a)throw"dataprocessor.getNodeListForDimLevelRadio.js  y5g59i8y  NULL radioLevel input !";var r=n.dimensionMappings[e];if(!r)throw"dataprocessor.getNodeListForDimLevelRadio.js 0oi098  no dimensionMappings for axis "+e;if(r.length<=0)return n.fn.getEmptyAxisResult();if(a.length>r.length)throw"dataprocessor.getNodeListForDimLevelRadio.js  98hu for axis: "+e+", number of input dimensionss from radio buttons: "+a.length+", exceeds the number of dimensions in the chart data: "+r.length;if(a.length+(e==n.metadata.measureAxis?1:0)<r.length){s.debug&&console.log("AdhocDataProcessor.getNodeListForDimLevelRadio.js need to add  Radio Dimensions padding");for(var t=a.length,o=t;o<r.length;o++){var l=r[o];"Measures"!==l.dimension&&a.push({level:l.length})}}var i=[],u=(n.metadata.axes[e],r.length,0),d=0,m=!1,v=r[0],g="Measures"===v[0].dimension,f=0;if(g&&(f=1),g&&0===a.length)i.push({startLevel:0,endLevel:1,leafLevel:1});else for(var c=0;c<a.length;c++){var l=r[c+f];if(null===l)throw"dataprocessor.getNodeListForDimLevelRadio.js 98hn8 metadata  no dimension for number "+c;if(u++,n.metadata.measureAxis===e&&f<=0){if(c+2>r.length)throw"dataprocessor.getNodeListForDimLevelRadio.js  43098h  we were expecting dimensions to be at least "+(c+2)+" in length, instead it is "+r.length;var L=r[c+1];"Measures"===L[0].dimension&&(m=!0,f=1)}var h=l.length,p=d,A=d+a[c].level,N=d+h;(g||m)&&((A===N||g)&&A++,N++,g=!1,m=!1),i.push({startLevel:p,endLevel:A,leafLevel:N}),d=N}var x=n.fn.getNodeListForDimLevels(e,i);return s.debug&&(console.log("AdhocDataProcessor.getNodeListForDimLevelRadio: 39uh  nodeList for axis="+e+" radioDims, dimLevels "),console.log(a),console.log(i),console.log(x)),x},getNodeListForDimLevels:function(e,a){var n=s;if(0===n.metadata.axes[0].length&&0===n.metadata.axes[1].length)return null;if(n.metadata.axes[e].length>0)return n.fn.getNodeListForDimensionLevelsMeasure(e,a);return n.fn.getEmptyAxisResult()},getNodeListForSliderLevelGroupMeasure:function(e,a){var n=s,r=n.metadata.axes[e].length;if(r>0){var t=[];return t.push({startLevel:0,endLevel:a,leafLevel:r}),n.fn.getNodeListForDimensionLevelsMeasure(e,t)}return n.fn.getEmptyAxisResult()},getEmptyAxisResult:function(){var e=s;if(!e.emptyAxisResult){var a={isAll:!1,label:"(empty axis)",level:0,axisCoordinate:0};e.emptyAxisResult=[],e.emptyAxisResult.push(a)}return e.emptyAxisResult},getNodeListForDimensionLevelsMeasure:function(e,a){var n=s,r=!1;e===n.metadata.measureAxis&&(r=!0);var t=0===e?n.rowGroupMapping:n.colGroupMapping,o=n.treeNodeAxes[e],l=[];l.push(o);for(var i=0;i<a.length;i++){var u=a[i].startLevel,d=a[i].endLevel,m=a[i].leafLevel;s.debug&&console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure: 93287h  begin qualifying nodes for dim="+i+" startlevel="+u+", endLevel="+d+"localLeafLevel="+m);var v=!1;n.metadata.isOLAP?d===m&&(v=!0):i>=a.length-1&&(0===e?d>=n.rowSliderLevelCount-1&&(v=!0):d>=n.colSliderLevelCount-1&&(v=!0));var g=[];if(v){var f=m;n.metadata.isOLAP||i===a.length-1&&(f=n.metadata.axes[e].length),n.fn.getNodeListForActualLevel(e,l,f,g),s.debug&&(console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure: we9iuhf  LeafLevel nodeList for targetLevel="+f),console.log(g));var c=[],L=0;n.metadata.isOLAP&&(L=u);for(var h=0;h<g.length;h++){var p=g[h];if(!0!==p.isAll)for(var A=p.parent;null!=A;){if(A.level<=L){c.push(p);break}if(!0===A.isAll)break;A=A.parent}}l=c,s.debug&&(console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure:  er83   qualifiedChildren"),console.log(l))}else{var f=t[d+1];n.metadata.isOLAP&&(f=d+1),1===a.length&&0===f?g.push(o):l&&n.fn.getNodeListForActualLevel(e,l,f,g);for(var N=[],h=0;h<g.length;h++){var p=g[h],x=!1;if(p.level<=0)throw"dataprocessor.getNodeListForDimensionLevelsMeasure  leaf  node.level is unexpectedly less or equal to zero !";if(0!==p.level&&!0===p.isAll&&(x=!0),x){if(!p.parent)throw"AdhocDataProcessor.getNodeListForDimensionLevelsMeasure Unexpected missing node.parent in axis "+e;var b=p.parent;if(r&&p.parent.level==n.measureLevelNumber&&n.measureLevelNumber>1){if(!p.parent.parent)throw"AdhocDataProcessor.getNodeListForDimensionLevelsMeasure Unexpected missing node.parent.parent in axis "+e;b=p.parent.parent}b.level>u&&!0===b.isAll&&(x=!1)}x&&(p.level===m?N.push(p):n.fn.chaseAllNodesToLeafToList(p.parent,p,m,N))}l=N,s.debug&&(console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure: 3w948h  non-LeafLevel qualified children    X"),console.log(l))}}return l},getNodeListForActualLevel:function(e,a,n,r){for(var t=s,o=0;o<a.length;o++){var l=a[o];l.level==n?r.push(l):l.children&&t.fn.getNodeListForActualLevel(e,l.children,n,r)}},chaseAllNodesToLeafToList:function(e,a,n,r){var t=s;if(a.level<n&&"children"in a&&a.children.length>0)for(var o=0;o<a.children.length;o++){var l=a.children[o],i=!1;if(!1===l.isAll?l.level==t.measureLevelNumber&&(i=!0):i=!0,i){var u=t.fn.chaseAllNodesToLeafToList(e,l,n,r);u.level===n&&r.push(u)}}return a},recurseLeafArrayFromSimpleNode:function(e,a){var n=s;if(e.children.length>0)for(var r=e.children,t=0;t<r.length;t++)n.fn.recurseLeafArrayFromSimpleNode(r[t],a);else a.push(e)},getDataFromRowColumn:function(e,a){if(!e)throw"dataprocessor.getDataFromRowColumn   NULL row object !";if(e.axisCoordinate<0)throw"dataprocessor.getDataFromRowColumn   row Coordinate < 0 !";if(!a)throw"dataprocessor.getDataFromRowColumn   NULL column object !";if(a.axisCoordinate<0)throw"dataprocessor.getDataFromRowColumn   column Coordinate < 0 !";var n=s.data[e.axisCoordinate][a.axisCoordinate];return"string"==typeof n&&(n=""===n?null:parseFloat(n)),n},getLabelNameArray:function(e,a){var n=s,t=[];if(null===a||r.isUndefined(a))return t;var o=a;if(n.metadata.isOLAP){var l=(a.level,n.dimensionLevels[e]),i=0;if(l)for(var u=0;u<l.length;u++)if(i=u,o.level>=l[u].startLevel&&o.level<=l[u].endLevel){for(;o.parent;){if(!o.isAll){t.push(o.label);break}if(!o.parent)break;if(o=o.parent,o.level<l[u].startLevel)break}break}for(var u=i-1;u>=0;u--){var d=l[u].startLevel,m=l[u].endLevel;for(o=a;o.parent;)if(o=o.parent,o.level<=m&&o.level>=d&&o.level>0&&!o.isAll){t.push(o.label);break}}}else{for(;null!=o.parent;)!0!==o.isAll&&t.push(o.label),o=o.parent;o.level>0&&t.push(o.label)}return t.length<=0&&t.push(this.getMessage("totalsLabelForChart")),t},isOLAP:function(){return s.metadata.isOLAP},isMeasuresLastOnAxis:function(e){var a=s;if(e!==a.measureAxis)return!1;if(a.fn.isOLAP()){var n=a.dimensionMappings[e];if(n.length<=0)return!1;return"Measures"===n[n.length-1][0].dimension}var r=a.metadata.axes[e];return"Measures"===r[r.length-1].label},doPathsMatch:function(e,a){for(;e.parent;){if(0===e.parent.level)return 0===a.parent.level;if(!a.parent)return!1;if(e=e.parent,a=a.parent,e.level!==a.level)return!1;if(e.label!==a.label)return!1}return!a.parent},getLevelsWithoutMeasures:function(e){return r.chain(e).filter(function(e){return"Measures"!=e.dimension}).map(function(e){return e.name=t.unescape(e.name),e.label=t.unescape(e.label),e}).value()},getLevelIndex:function(e,a){for(var n=0;n<e.length;n++)if(e[n].name===a.name)return n;throw"Specified level was not found."},levelsToLevelNumbers:function(e,a){var n=s.fn,r=[];if(n.isOLAP()){var t=n.getOLAPDimensionInfo();r=n._getOlapLevelNumbers(e,t[a])}else r=n._getNonOlapDataProcessorLevelNumber(e,s.metadata.axes[a]);return r},_getOlapLevelNumbers:function(e,a){var n=s.fn;return r.map(e,function(e){var t=r.find(a,function(a){return a.dimension===e.dimension});return{level:n._getOlapDataProcessorLevelNumber(e,t)}})},_getOlapDataProcessorLevelNumber:function(e,a){for(var n=0;n<a.levels.length;n++)if(a.levels[n].levelName===e.name)return a.levels[n].levelNumber;throw"No olap info found for specified level = "+e.name},_getNonOlapDataProcessorLevelNumber:function(e,a){var n=s.fn;if(0===e.length)return 0;var r=n.getLevelsWithoutMeasures(a);return n.getLevelIndex(r,e[0])+1}}};n.exports={messages:{},getMessage:s.fn.getMessage,load:s.fn.load,levelsToLevelNumbers:s.fn.levelsToLevelNumbers,getLevelIndex:s.fn.getLevelIndex,getLevelsWithoutMeasures:s.fn.getLevelsWithoutMeasures,getOLAPDimensionInfo:s.fn.getOLAPDimensionInfo,getDataFromRowColumn:s.fn.getDataFromRowColumn,getLabelNameArray:s.fn.getLabelNameArray,isMeasuresLastOnAxis:s.fn.isMeasuresLastOnAxis,getDataStyle:s.fn.getDataStyle,getNodeListForDimLevelRadio:s.fn.getNodeListForDimLevelRadio,getNodeListForSliderLevel:s.fn.getNodeListForSliderLevel,getColumnSliderLevelCount:function(){return s.colSliderLevelCount},getRowSliderLevelCount:function(){return s.rowSliderLevelCount},getMeasureLevelNumber:s.fn.getMeasureLevelNumber}});