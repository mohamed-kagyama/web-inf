/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","./visitors/MultiAxisModelLevelExpansionVisitor","./visitors/MultiAxisModelMemberExpansionVisitor"],function(e,i,t){function h(e,i,t,h,n){this.isTotal=e,this.isMeasure=i,this.isExpandable=n,this.isExpanded=void 0,this.value=t,this.label=t,this.children=h,this.index=void 0,this.pixels=void 0}var n=e("underscore"),r=e("./visitors/MultiAxisModelLevelExpansionVisitor"),l=e("./visitors/MultiAxisModelMemberExpansionVisitor");h.prototype.addTree=function(e){var i=!1;if(this.value===e.value)if(e.childFirst&&(this.childFirst=!0),e.childLast&&(this.childLast=!0),this.isExpanded=e.isExpanded,e.children.length)if(1===this.children.length&&this.children[0].isTotal)i=!0,e.children[e.children.length-1].isTotal?(i=this.children[0].addTree(e.children[e.children.length-1]),this.children=this.children.concat(e.children.reverse().slice(1,e.children.length)).reverse()):(this.ignoredTotal=this.children[0],this.children=[].concat(e.children));else if(1===e.children.length&&e.children[0].isTotal)this.children[this.children.length-1].isTotal?i=this.children[this.children.length-1].addTree(e.children[0]):this.ignoredTotal?i=this.ignoredTotal.addTree(e.children[0]):(this.ignoredTotal=e.children[0],i=!0);else{for(var t=-1,h=0,n=!1;!n&&++t<this.children.length;)if(e.children[0].value===this.children[t].value||e.children[0].isTotal&&this.children[t].isTotal){n=!0;for(var r=1;r+t<this.children.length&&r<e.children.length;r++)n&=e.children[r].value===this.children[t+r].value||e.children[r].isTotal&&this.children[t+r].isTotal}if(n){for(i=!0;t<this.children.length&&h<e.children.length;t++,h++)if(!this.children[t].addTree(e.children[h]))throw new Error("Merge did not happened, while was expected");for(;h<e.children.length;h++)this.children.push(e.children[h])}else if(this.children[this.children.length-1].childLast&&!this.children[0].childFirst&&e.children[e.children.length-1].childLast){i=!0;for(var l=e.children.length-this.children.length,r=e.children.length-1;r>=0;r--)if(r-l>=0){if(!this.children[r-l].addTree(e.children[r]))throw new Error("Merge did not happened, while was expected")}else this.children.unshift(e.children[r])}if(this.ignoredTotal&&this.children[this.children.length-1].isTotal){if(!this.ignoredTotal.addTree(this.children.pop()))throw new Error("Merge did not happened, while was expected");this.children.push(this.ignoredTotal),this.ignoredTotal=void 0}}else i=!0;return i},h.prototype.applyExpansion=function(e,i,t){if(e.level)for(var h=1;h<i.length+1;h++)(e.level.aggregation&&i[h-1].aggregations||i[h-1].level&&e.level.fieldRef===i[h-1].level.id)&&this.visit(new r(e.level.expanded,h));else if(e.member){for(var n,s=[],h=0;h<e.member.path.length-1;h++){if(s.push(e.member.path[h]),!(n=this.getItemByPath(s)))return;n.isExpandable&&e.member.expanded&&(n.isExpanded=!0)}n=this.getItemByPath(e.member.path),n&&n.visit(new l(e.member.expanded,e.member.path.length-1,i,t))}},h.prototype.applyExpansions=function(e,i){for(var t=i.axis.toQueryMultiaxisAxisItems(),h=n.filter(e,function(e){return e.level}),r=n.filter(e,function(e){return e.member&&e.member.expanded}).sort(function(e,i){return e.member.path.length-i.member.path.length}),l=n.filter(e,function(e){return e.member&&!e.member.expanded}).sort(function(e,i){return i.member.path.length-e.member.path.length}),s=0;s<h.length;s++)this.applyExpansion(h[s],t);if(r.length||l.length){for(var d=n.map(t,function(e){var t=i.expansions.getByGroupByItem(e);return t&&t.get("level").expanded}),s=0;s<l.length;s++)this.applyExpansion(l[s],t,d);for(var s=0;s<r.length;s++)this.applyExpansion(r[s],t,d)}},h.prototype.getItemByPath=function(e){if(!e.length)return this;for(var i="empty_node"===e[0]?null:e[0],t=0;t<this.children.length;t++)if(this.children[t].value===i||this.children[t].isTotal&&"All"===i||!i&&!this.children[t].value)return this.children[t].getItemByPath(e.slice(1));return null},h.prototype.visit=function(e,i){if(!e.terminated&&(e.preVisit(this,i||0),!e.terminated)){if(this.isExpanded||void 0===this.isExpanded)for(var t=0;t<this.children.length;t++)this.children[t].visit(e,(i||0)+1);else if(this.ignoredTotal)this.ignoredTotal.visit(e,(i||0)+1);else for(var t=0;t<this.children.length;t++)(this.children[t].isTotal||this.children[t].isMeasure)&&this.children[t].visit(e,(i||0)+1);e.terminated||e.postVisit(this,i||0)}},t.exports=h});