/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","jquery","bundle!AdHocBundle","../../model/factory/formattersFactory","text!../template/crosstabRowsTemplate.htm","text!../template/crosstabColumnsTemplate.htm"],function(t,e,o){function a(t,e,o,a,i,s){var f=a?r(e,o):n(e,o),m=t.components.findComponentDeep("measure");if(h(f,e,i),p(f,e,m),d(f,e,i),u(f,e,i,o,s),o){var c={isSpacer:!0,label:""},g=[];if(f=l(f),f[0]){for(var v=0,b=f[0].length;v<b;v++)g.push(c);f.push(g)}}return f}function n(t,e){for(var o,a=[],n=!1,r=0;r<t.length;r++){o=[];for(var l=0;l<t[r].length;l++)o.push(i(t[r][l],r,l));a.push(o)}if(t.length)for(var s=0;s<t[0].length-1;s++)for(var h=0;h<t.length;h++)t[h][s].isExpandable&&t[h][s+1].isTotal&&(n===t[h][s]?(a[h][s].isCollapsed=!1,a[h][s].isExpanded=!1):n=t[h][s]);return a}function r(t,e){var o,a=c.map(t,function(){return[]}),n=!1,r=e?"colspan":"rowspan";if(t.length)for(var l=0;l<t[0].length;l++)for(var s=0;s<t.length;s++)t[s][l]===n?(o[r]?o[r]++:o[r]=2,a[s].push(null)):(n=t[s][l],o=i(n,s,l),!e&&t[s][l].isExpandable&&t[s][l].isExpanded&&t[s][l+1]&&!t[s][l+1].childFirst&&(o.label=""),a[s].push(o));return a}function l(t){for(var e=t[0]?t[0].length:0,o=t.length,a=new Array(e),n=0;n<e;n++){a[n]=new Array(o);for(var r=0;r<o;r++)a[n][r]=t[r][n]}return a}function i(t,e,o){return{isExpanded:t.isExpandable&&t.isExpanded,isCollapsed:t.isExpandable&&!t.isExpanded,isMeasure:t.isMeasure,isTotal:t.isTotal||t.istotalCol,label:s(t.label,t),expId:t.isExpandable?e+"-"+o:void 0}}function s(t,e){var o=t;return"other_node"===t?o=v["adhoc.node.other.node"]:e.isTotal&&(o=v["adhoc.node.total.node"]),o}function h(t,e,o){var a,n;if(t.length){for(var r=t[0].length-1;r>0;r--)if(o.components.models[r]&&o.components.models[r].get("includeAll"))for(var l=0;l<t.length;l++)if((e[l][r].isTotal||e[l][r].isMeasure)&&(n=t[l][r])){for(var i=l;i>=0&&!a;i--)a=t[i][r-1];n.isExpanded=a.isExpanded,n.isCollapsed=a.isCollapsed,n.expId=a.expId,a=void 0}for(var s=0;s<e.length;s++)for(var h=0;h<e[s].length;h++)(a=t[s][h])&&a.expId&&!e[s][h].isTotal&&(a.isExpanded=void 0,a.isCollapsed=void 0,a.expId=void 0)}}function p(t,e,o){var a,n;if(e.length)for(var r=0;r<e[0].length;r++)if(e[0][r].isMeasure){a=c.reduce(o,function(t,e){return t[e.get("reference")]=e.label(!0),t},{});for(var l=0;l<e.length;l++)(n=t[l][r])&&(n.label=a[n.label])}}function d(t,e,o){for(var a=o.components.map(function(t){if(t.level())return b(t.level().get("type"))}),n=o.components.map(function(t){return{format:t.get("format"),categorizer:t.level()&&t.level().get("categorizer"),ignoreTimezone:!0}}),r=0;r<t.length;r++)for(var l=0;l<t[r].length;l++)t[r][l]&&a[l]&&!e[r][l].isTotal&&(t[r][l].label=a[l].format(t[r][l].label,n[l].format,n[l]))}function u(t,e,o,a,n){o.components.length||t[0]&&(t[0][0]={label:a?"":v["adhoc.node.rowgroup.node"]});for(var r=0;r<t.length;r++)for(var l=0;l<t[r].length;l++)!t[r].totalRow&&(t[r].totalRow|=e[r][l].isTotal),l+1===t[r].length&&l-1>=0&&e[r][l-1].isTotal&&(t[r][l].isTotal=!0);if(!a){for(var i=-1,r=0;r<t.length;r++){for(var s=!1,l=0;l<t[r].length;l++)if(null!==t[r][l]){if(void 0!==t[r][l].rowspan&&(s=!0),1===t[r].totalRow&&l-1>-1&&null!==t[r][l-1]&&!0===t[r][l-1].isTotal&&(t[r][l].isTotal=!0)&&-1===i&&(i=r)||null===t[r][l-1]&&-1!==i&&t[i][l-1]&&t[i][l-1].isTotal&&r-1>0&&t[r-1][l]&&t[r-1][l].isTotal&&(t[r][l].isTotal=!0),t[r][l].isTotal&&s&&null!==t[r]&&1===t[r].totalRow)for(var h=r+1;h<r+t[r][l].rowspan;h++)for(var p=l+1;p<t[r].length;p++)null!==t[r]&&1===t[r].totalRow&&null!==t[h][p]&&(t[h][p].isTotal=!0);t[r][l].rowspan>0?(t[r+t[r][l].rowspan-1].rowMemberLast=!0,null!==n&&(n.rows.range[r+t[r][l].rowspan-1].rowMemberLast=!0),t[r].rowMember||(t[r].rowGroup=!0)):t[r].rowGroup||(t[r].rowMember=!0)}!s&&r-1>0&&!0===t[r-1].rowMemberLast&&1!==t[r].totalRow&&(t[r].rowMemberLast=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0)),r+1<t.length&&1!==t[r].totalRow&&1===t[r+1].totalRow&&(t[r].rowMemberLast=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0))}for(var r=0;r<t.length;r++){for(var d=0,u=0,l=0;l<t[r].length;l++)null!==t[r][0]&&void 0===t[r][0].rowspan&&l+1===t[r].length&&r+1<t.length&&!t[r].rowGroup&&l>0&&null!==t[r+1][l-1]&&null!==t[r][l-1]&&t[r+1][l-1].label!==t[r][l-1].label&&(null!==n&&(n.rows.range[r].rowMemberLast=!0),t[r].rowMemberLast=!0),null===t[r][l]||t[r][l]&&t[r][l].rowspan>0?d++:u++;if(t[r]&&!t[r].isTotal&&d>=1&&u>=2&&(t[r].rowGroup||t[r-1][t[r].length-2]&&t[r][t[r].length-2]&&t[r-1][t[r].length-2].label!==t[r][t[r].length-2].label)&&(t[r].rowSingleMember=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0)),t[r]&&0===d&&1!==t[r].isTotal&&t[r].length>1&&r+1!==t[r].length&&t[r+1]&&t[r][0].label!==t[r+1][0].label&&(t[r].rowMemberLast=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0)),1===d&&t[r][0]&&t[r][0].rowspan>0&&t[r].length>2)for(var p=r+1;p<=r+t[r][0].rowspan-1;p++){for(var f=0,h=0;h<t[p].length;h++)null===t[p][h]&&f++,t[p][h]&&t[p][h].rowspan>0&&f++;t[p]&&!t[p].rowGroup&&1===f&&(t[p].rowMemberLast=!0,null!==n&&(n.rows.range[p].rowMemberLast=!0))}}}}function f(t,e,o){for(var a=0;a<t.length;a++)if(t[a].children.length>0&&!t[a].isTotal)return o.push(t[a].isExpanded),t[a].children.indexOf(e)>-1&&o.indexOf(!1)>-1||f(t[a].children,e,o)}var m=t("backbone"),c=t("underscore"),g=t("jquery"),v=t("bundle!AdHocBundle"),b=t("../../model/factory/formattersFactory"),w=t("text!../template/crosstabRowsTemplate.htm"),x=t("text!../template/crosstabColumnsTemplate.htm"),T=m.View.extend({events:{"click .jr-isExpanded":"onClick","click .jr-isCollapsed":"onClick"},initialize:function(t){this.orientation=t.orientation||T.Orientation.HORIZONTAL,this.options=t,this.hyperlinkEnabledFor=[],this.orientation===T.Orientation.VERTICAL?(this.templateFn=c.template(w),this.itemsCollection=this.model.dataSet.query.rows.axis):this.orientation===T.Orientation.HORIZONTAL&&(this.templateFn=c.template(x),this.itemsCollection=this.model.dataSet.query.cols.axis),this.items=this.itemsCollection.toQueryMultiaxisAxisItems(),this.$viewport=this.$("table"),this.listenTo(this.model.dataSet.query,"query:componentsDataChange",function(){this.items=this.itemsCollection.toQueryMultiaxisAxisItems()},this)},render:function(){return this.renderData&&this.$viewport.html(this.templateFn({data:this.renderData,hyperlinks:this.hyperlinks})),this},acquireData:function(t){var e=this.model.component.getCrosstabComponent(),o=e.get("mergeCrosstabCells"),n=this.orientation===T.Orientation.HORIZONTAL,r=n?e.getColumnsComponent():e.getRowsComponent();n?(this.data=t.columns,this.renderData=a(this.model.component.getCrosstabComponent(),t.columns.range,n,o,r,null)):(this.data=t.rows,this.renderData=a(this.model.component.getCrosstabComponent(),t.rows.range,n,o,r,t))},onClick:function(t){t.stopPropagation();for(var e=t.target.getAttribute("data-expansion-id").split("-"),o=this.data.range[+e[0]],a={member:{expanded:!1,path:[]}},n=0;n<=+e[1];n++)a.member.path.push(o[n].isTotal?"All":o[n].value||"empty_node");if(a.member.expanded=!o[+e[1]].isExpanded,!a.member.expanded){this._collapseIndex=+e[1],this._collapseItem=o[this._collapseIndex];var r=g(t.target).parents(".jr-mDatatable-cell:first").position();this.orientation===T.Orientation.VERTICAL?this._collapseOffset=this.data.top-this.$el.scrollTop()+r.top:this._collapseOffset=this.data.top-this.$el.scrollLeft()+r.left}this.trigger("expansion",a)},validateViewport:function(t,e,o){var a,n=-1;if(this._collapseItem){for(var r=0;r<t.range.length&&!a;r++)(a=t.range[r][this._collapseIndex]===this._collapseItem)||(a=f(t.range[r],this._collapseItem,[]));a||(n=Math.max(0,e-Math.floor(o/2)))}return n},getRequiredScrollPosition:function(){var t,e=-1;if(this._collapseItem){for(var o=0;o<this.data.range.length&&!t;o++)t=this.data.range[o][this._collapseIndex]===this._collapseItem;if(t){for(var a=0,n=this.data.top;a<o-1;n+=this.data.resultPixels[a],a++);e=Math.max(0,n-this._collapseOffset)}}return e},onDone:function(){this._collapseIndex=void 0,this._collapseItem=void 0,this._collapseOffset=void 0},scrollTo:function(t){var e;return this.orientation===T.Orientation.VERTICAL?e=this.$el.scrollTop:this.orientation===T.Orientation.HORIZONTAL&&(e=this.$el.scrollLeft),e.call(this.$el,t)},enableHyperlinks:function(t){if(this.hyperlinks=!0,t.events){var e=this;for(var o in t.events)this.hyperlinkEnabledFor.push(o),this.$el.on(o,".jr-jHyperLink",function(t){var o=+t.currentTarget.getAttribute("data-local-index"),a=+t.currentTarget.getAttribute("data-local-depth");e.trigger("hyperlink",{context:this,event:t,data:e.getHyperlinkData(o,a)})})}},disableHyperlinks:function(){this.hyperlinks=!1;for(var t=0;t<this.hyperlinkEnabledFor;t++)this.$el.off(this.hyperlinkEnabledFor[t],".jr-jHyperLink")},getHyperlinkData:function(){var t,e=arguments[0],o=this.items,a={};t=arguments.length>1?Math.min(arguments[1],this.items.length-1):this.items.length-1;for(var n=0;n<=t;n++)o[n].aggregations?a.Measures=[this.data.range[e][n].isTotal?"total_node":this.data.range[e][n].label]:a[o[n].level.id||o[n].level.field]=this.data.range[e][n].isTotal?"total_node":this.data.range[e][n].label;return a},getHyperlinks:function(){var t,e,o,a,n,r={all:[],bottomDataRow:[]},l=this.items.length;if(0===l)r.bottomDataRow.push({});else{a=l-1,n=this.$(".jr-jHyperLink");for(var i=0,s=n.length;i<s;i++)e=+n[i].getAttribute("data-local-index"),(o=+n[i].getAttribute("data-local-depth"))<l&&(t=this.getHyperlinkData(e,o),r.all.push({element:n[i],data:t}),o===a&&r.bottomDataRow.push(t))}return r}},{Orientation:{VERTICAL:"rows",HORIZONTAL:"columns"}});o.exports=T});