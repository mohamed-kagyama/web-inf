/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","highcharts","./supportedLayoutsEnum","runtime_dependencies/js-sdk/src/common/util/fontUtils","runtime_dependencies/js-sdk/src/common/util/parse/NumberUtils"],function(t,e,a){var o=t("underscore"),r=t("highcharts"),n=t("./supportedLayoutsEnum"),i=t("runtime_dependencies/js-sdk/src/common/util/fontUtils"),l=t("runtime_dependencies/js-sdk/src/common/util/parse/NumberUtils"),s=new l,f=function(t,e){return e[t%e.length]},u=function(t){var e={},a=t.metadata.axes[1].length;return o.each(t.metadata.axes[1],function(t,o){"Measures"===t.dimension?e[a-(o+1)]="measure":e[a-(o+1)]="field"}),e},h=function(t){var e=t.columnAxisLeafNode,a=t.rowAxisLeafArray,o=t.columnSlider,r=t.extraOptions,n=t.chartUserSettings,i=u(r),l=this.getDataValue(a[0],e),f=s.formatNumber(l,{decimalSeparator:".",groupingSeparator:","});if(""!==n.decimalPlaces){var h=Math.min(parseInt(n.decimalPlaces),20);f=s.formatNumber(l,{decimalSeparator:".",groupingSeparator:",",decimalPlacesAmount:h})}var m=this.createOutputParameters(e,1,r),c="",d=[],p=0,S=e;do{S.parent&&("measure"===i[p]?c=S.label:d.push(S.label)),S=S.parent,p+=1}while(S);return d.reverse(),0===o&&d.length>0&&(d=[d[0]]),{value:l,valueAsString:f,outputParameters:m,fieldsName:d,measureName:c}},m=function(t,e,a,o,r){for(var n=[],i=0;i<e.length;i++){var l=e[i],s=h.call(this,{columnAxisLeafNode:l,rowAxisLeafArray:t,columnSlider:a,extraOptions:o,chartUserSettings:r});n.push(s)}return n},c=function(t,e,a,o,r){for(var n={},i=0;i<e.length;i++){var l=e[i],s=h.call(this,{columnAxisLeafNode:l,rowAxisLeafArray:t,columnSlider:a,extraOptions:o,chartUserSettings:r}),f=s.fieldsName.join("_");n[f]||(n[f]={fieldsName:s.fieldsName,measures:[]}),n[f].measures.push({value:s.value,valueAsString:s.valueAsString,outputParameters:s.outputParameters,name:s.measureName})}return n},d=function(t){var e=t.amountOfCharts,a=t.chartUserSettings,r=t.aspectRation,i=t.containerWidth,l=t.containerHeight;if(i-=a.plotOffsets.left+a.plotOffsets.right,l-=a.plotOffsets.top+a.plotOffsets.bottom,o.isUndefined(r)&&(r=1),i*l<e)return 0;var s=n.BEST_FIT,f=o.values(n);a.layout&&-1!==f.indexOf(a.layout)&&(s=a.layout);var u=0,h=0,m=0;if(s===n.BEST_FIT){l*=r;var c=l/i,d=Math.sqrt(e/c),p=d*c,S=Math.max(1,Math.floor(d)),g=Math.max(1,Math.floor(p)),v=Math.floor(i/S),z=Math.floor(l/g);if(m=Math.min(v,z),S=Math.floor(i/m),g=Math.floor(l/m),S*g<e)if((S+1)*g<e&&S*(g+1)<e)v=Math.floor(i/(S+1)),z=Math.floor(l/(g+1)),m=Math.min(v,z);else{var M=Math.ceil(e/g),x=Math.ceil(e/S);v=Math.min(Math.floor(i/M),Math.floor(l/g)),z=Math.min(Math.floor(i/S),Math.floor(l/x)),m=Math.max(v,z)}h=m,u=Math.floor(m/r)}return s===n.HORIZONTAL&&(h=Math.floor(i/e),l*r<h&&(h=Math.floor(l*r)),u=Math.floor(h/r)),s===n.VERTICAL&&(u=Math.floor(l/e),i/r<u&&(u=Math.floor(i/r)),h=Math.floor(u*r)),{byVertical:u,byHorizontal:h}},p=function(t){var e=t.amountOfCharts,a=t.chartAreaSize,r=t.containerWidth,i=t.containerHeight,l=t.sizes,s=t.chartUserSettings,f=r-(s.plotOffsets.left+s.plotOffsets.right),u=i-(s.plotOffsets.top+s.plotOffsets.bottom),h=n.BEST_FIT,m=o.values(n);s.layout&&-1!==m.indexOf(s.layout)&&(h=s.layout);var c,d;h===n.HORIZONTAL?(c=Math.floor(f/a.byHorizontal),d=1):h===n.VERTICAL?(c=1,d=Math.floor(u/a.byVertical)):(c=Math.floor(f/a.byHorizontal),d=Math.ceil(e/c)),c=Math.min(c,e),d=Math.min(d,e);for(var p=(f-a.byHorizontal*c)/(c+1),S=(u-a.byVertical*d)/(d+1),g=[],v=0;v<e;v++){var z=v+1,M=z%c==0?c:z%c,x=Math.floor(z/c)+(z%c==0?0:1),b=a.byHorizontal*(M-1)+a.byHorizontal/2+p*M,y=a.byVertical*(x-1)+a.byVertical/2+S*x;b+=s.plotOffsets.left,y+=s.plotOffsets.top+l.verticalCenterOffset,g.push({xCenter:Math.round(b),yCenter:Math.round(y),left:Math.round(b-a.byHorizontal/2),top:Math.round(y-(a.byVertical/2+l.verticalCenterOffset)),xCenterInPercent:b/r*100,yCenterInPercent:y/i*100})}return g},S=function(t){var e=t.texts,a=t.extraOptions,n=t.autoScaleStrategy,l=t.fonts,s=t.constrains,f=l.minimalFontSize,u=l.fieldFontSize,h=r.theme&&r.theme.contrastTextColor||"black",m=l.valueFontSize,c=r.theme&&r.theme.contrastTextColor||"black",d=l.measureFontSize,p=r.theme&&r.theme.contrastTextColor||"black",S=[];if(!a||!a.chartState.autoScaleFonts)return o.each(e,function(){S.push({field:{fontSize:u,color:h},value:{fontSize:m,color:c},measure:{fontSize:d,color:p}})}),S;var g=[],v=[],z=[];return o.each(e,function(t){if(t.field){var e=i.findFontSize({text:t.field,sizeUnits:"px",fontWeight:"normal",lineHeight:"normal",minimalFontSize:f,fontCheckingStrategy:"basedOnFontHeight",widthAvailable:s.field.width,heightAvailable:s.field.height});g.push(e)}if(t.value){var a=i.findFontSize({text:t.value,sizeUnits:"px",fontWeight:"bold",lineHeight:"normal",minimalFontSize:f,fontCheckingStrategy:"basedOnFontHeight",widthAvailable:s.value.width,heightAvailable:s.value.height});v.push(a)}if(t.measure){var o=i.findFontSize({text:t.measure,sizeUnits:"px",fontWeight:"normal",lineHeight:"normal",minimalFontSize:f,fontCheckingStrategy:"basedOnFontHeight",widthAvailable:s.measure.width,heightAvailable:s.measure.height});z.push(o)}}),0===g.length&&g.push({fontSize:u}),0===v.length&&v.push({fontSize:m}),0===z.length&&z.push({fontSize:d}),"minimalFontForAll"===n?(u=o.min(g,function(t){return t.fontSize}).fontSize,m=o.min(v,function(t){return t.fontSize}).fontSize,d=o.min(z,function(t){return t.fontSize}).fontSize):"maximalFontForAll"===n&&(u=o.max(g,function(t){return t.fontSize}).fontSize,m=o.max(v,function(t){return t.fontSize}).fontSize,d=o.max(z,function(t){return t.fontSize}).fontSize),o.each(e,function(){S.push({field:{fontSize:u,color:h},value:{fontSize:m,color:c},measure:{fontSize:d,color:p}})}),S};a.exports={getColorFromArray:f,collectDataForCharts:m,groupDataByCharts:c,getChartAreaSize:d,getGaugeChartPositions:p,getMultiLevelGaugeChartPositions:p,calculateFontData:S}});