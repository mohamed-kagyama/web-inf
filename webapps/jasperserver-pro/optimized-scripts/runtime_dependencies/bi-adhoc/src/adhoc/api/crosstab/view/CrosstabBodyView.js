/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","../../model/factory/formattersFactory","../../model/factory/cellTypesFactory","text!../template/crosstabBodyTemplate.htm"],function(t,e,r){function a(t,e,r,a,o){var l=-1;if(t.resultPixels){var l=e,n=a,i=n+o,h=s.reduce(t.resultPixels,function(t,e){return t+e},0),c=t.top,u=c+h;if(h<o)return-1;for(;u<i;)c=u,u+=h,l+=r;for(;c>n;)c=Math.max(0,c-h),l=Math.max(0,l-r),u=c+h;if(u<i)for(var g=0;g<t.resultPixels.length&&u<i;g++)u+=t.resultPixels[g],c+=t.resultPixels[g],l++;c<=n&&u>=i?l===e&&(l=-1):l=-1}return l}var o=t("backbone"),s=t("underscore"),l=t("../../model/factory/formattersFactory"),n=t("../../model/factory/cellTypesFactory"),i=t("text!../template/crosstabBodyTemplate.htm"),h=s.template(i),c=o.View.extend({events:{scroll:"onScroll"},initialize:function(t){this._initElements(),this.options=t,this.$container=this.$("table"),this.hyperlinkEnabledFor=[],this.on("scroll",this.scrollTo,this)},render:function(){return this.data&&(this.hasData()?this.$emptyMessage.hide():this.$emptyMessage.show(),this.$container.html(h({data:this.data,cellTypesFactory:n,hyperlinks:this.hyperlinks}))),this},acquireData:function(t){this.data=[],this.columnTotalsInx={},this.rowTotalsInx={};var e=this.model.dataSet.query.groupByJSON();e.columns.items.length&&s.each(t.columns.range,function(t,e){s.each(t,function(t){t.isTotal&&(this.columnTotalsInx[e]=!0)},this)},this),e.rows.items.length&&s.each(t.rows.range,function(t,e){s.each(t,function(t){t.isTotal&&(this.rowTotalsInx[e]=!0)},this)},this);var r,a,o,n,i=this.model.component.getCrosstabComponent(),h=i.getRowsComponent().hasMeasures(),c=i.getMeasuresComponent().components,u=(c.last().get("reference"),this.model.dataSet.query[h?"rows":"cols"].axis),g=[],d=h?t.rows.range:t.columns.range,f=c.reduce(function(t,e){return t[e.get("reference")]=e.level()&&e.level().get("aggregationType"),t},{}),m=c.reduce(function(t,e){return t[e.get("reference")]={format:e.get("format"),categorizer:e.level()&&e.level().get("categorizer"),ignoreTimezone:!0},t},{}),p=u.reduce(function(t,e){return"measure"===e.get("kind")&&(t[e.get("id")]=l(e.get("aggregationType"))),t},{});if(d.length){for(var y=0;y<d[0].length&&!d[0][y].isMeasure;y++);for(var v=0;v<d.length;v++)g.push(d[v][y].value);for(var w=0;w<t.data.length;w++){r=[],r.totalRow=this.rowTotalsInx[w],t.data[w].rowMemberLast&&!r.totalRow&&(r.rowMemberLast=!0);for(var T=0;T<t.data[w].length;T++)n={label:"",totalCell:r.totalRow||this.columnTotalsInx[T]},o=t.data[w][T],o.label&&(a=h?w:T,n.aggregationType=f[g[a]],n.label=p[g[a]].format(o.label,m[g[a]].format,m[g[a]])),n.totalCell&&(n.isTotal=!0),r.push(n);t.rows.range[w].rowMemberLast&&void 0===r.totalRow&&(r.lastRowValue=!0),this.data.push(r),!0===r.totalRow&&this.data.length>1&&void 0===this.data[this.data.length-2].totalRow&&(this.data[this.data.length-2].lastRowValue=!0)}for(var b=0;b<t.columns.range.length;b++)for(var x=0;x<t.columns.range[b].length;x++)x-1>-1&&(t.columns.range[b][x-1].isTotal||t.columns.range[b][x-1].istotalCol)&&(t.columns.range[b][x].istotalCol=!0)}},onScroll:function(t){var e={left:this.$el.scrollLeft(),top:this.$el.scrollTop()};this.trigger("scroll:x",e.left),this.trigger("scroll:y",e.top),this.trigger("scroll",e)},scrollToLeft:function(t){this.$el.scrollLeft(t)},scrollToTop:function(t){this.$el.scrollTop(t)},enableHyperlinks:function(t){if(this.hyperlinks=!0,t.events){var e=this;for(var r in t.events)this.hyperlinkEnabledFor.push(r),this.$el.on(r,".jr-jHyperLink",function(t){e.trigger("hyperlink",{context:this,event:t,row:+t.currentTarget.getAttribute("data-row-index"),column:+t.currentTarget.getAttribute("data-column-index")})})}},disableHyperlinks:function(){this.hyperlinks=!0;for(var t=0;t<this.hyperlinkEnabledFor;t++)this.$el.off(this.hyperlinkEnabledFor[t],".jr-jHyperLink")},validateViewportHeight:function(t,e,r){return a(t,e,r,this.$el.scrollTop(),this.$el.height())},validateViewportWidth:function(t,e,r){return a(t,e,r,this.$el.scrollLeft(),this.$el.width())},_initElements:function(){this.$emptyMessage=this.$(".jr-jEmptyMessage"),this.$emptyMessage.hide()},hasData:function(){var t=!0,e=function(t){return"measure"===t.get("kind")},r=this.model.dataSet.query.rows.axis.filter(e).length,a=this.model.dataSet.query.cols.axis.filter(e).length;return(!this.data.length||this.data.length===r&&1===this.data[0].length||1===this.data.length&&this.data[0].length===a)&&(t=!1,s.each(this.data,function(e){s.each(e,function(e){s.isUndefined(e.label)||""===e.label||(t=!0)})})),t},isEmptyCrosstab:function(){return!!s.isEmpty(this.model.dataSet.query.get("select"))}});r.exports=c});