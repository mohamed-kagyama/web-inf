/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","runtime_dependencies/js-sdk/src/jrs.configs","../enum/QueryExecutorHttpHeaders","../../visualChooser/VisualizationTypesController","./AdHocQueryParametersModel","./AdHocQueryExpressionModel","./AdHocQueryExpansionsCollection","./AdHocQueryLevelCollection","./AdHocQueryOrderByCollection"],function(e,t,i){function r(e,t){(t.get("member")||t.get("level")).expanded=!1,n.call(this,e,t)}function n(e,t){var i=a.call(this,e,t);this._triggerChanged(),e.expansions.trigger("expansions:change",i,e)}function a(e,t){var i=[t.attributes];return i=t.has("level")?i.concat(s.apply(this,arguments)):i.concat(o.apply(this,arguments))}function s(e,t){for(var i,r,n=this.groupByJSON()[e.id].items,a=t.get("level"),s=!0,o=-1,l=0;l<n.length;l++)a.aggregation&&n[l].aggregations||a.fieldRef&&n[l].level&&a.fieldRef===n[l].level.id?(s=!1,o=l):(r=e.expansions.getByGroupByItem(n[l]),r.attributes.level.expanded=s);return i=b.reduce(e.expansions.getMemberExpansions(),function(e,t){return t.get("member").path.length-1>o?t.get("member").expanded?e.toApply.push(t):e.toRemove.push(t):t.get("member").path.length-1===o?e.toRemove.push(t):t.get("member").expanded?e.toRemove.push(t):e.toApply.push(t),e},{toRemove:[],toApply:[]}),e.expansions.remove(i.toRemove,{silent:!0}),b.map(i.toApply,function(e){return e.toJSON()})}function o(e,t){var i=e.expansions.filter(function(e){return e.has("member")&&l(t.get("member").path,e.get("member").path)}),r=b.map(i,function(e){return{member:{expanded:!1,path:e.attributes.member.path}}});return e.expansions.remove(i,{silent:!0}),c(e,t),r}function l(e,t){if(e.length<t.length){for(var i=0;i<e.length;i++)if(t[i]!==e[i])return!1;return!0}return!1}function c(e,t){var i,r=t.get("member");if(r&&e.axis.hasMeasures()&&!e.axis.models[e.axis.length-1].isMeasure()){i=e.axis.toQueryMultiaxisAxisItems();var n=b.reduce(i,function(e,t,i){return t.aggregations?i:e});if(r.expanded&&r.path.length>=n){for(var a=r.path.slice(0,n),s=0;s<a.length;s++){var o=e.expansions.getByPath(a.slice(0,s));o&&e.expansions.remove(o,{silent:!0})}e.expansions.add({member:{expanded:!0,path:r.path.slice(0,n)}},{silent:!0})}if(!r.expanded&&r.path.length<n){for(var l=[].concat(r.path),c=e.axis.reduce(function(e,t){return t.isMeasure()&&e.push(t.has("id")?t.get("id"):t.get("hierarchicalName")),e},[]),s=l.length;s<n;s++)l.push("All");for(var s=0;s<c.length;s++){var o=e.expansions.getByPath(l.concat([c[s]]));o?o.get("member").expanded=!1:e.expansions.add({member:{expanded:!1,path:l.concat([c[s]])}},{silent:!0})}}}}function g(e,t){return e.components.reduce(function(e,i){return"Measures"===i.get("reference")?e=d(e,t):e[i.get("reference")]={format:i.get("format"),formatId:i.get("formatId"),aggregationFormat:i.get("aggregationFormat"),aggregationFormatId:i.get("aggregationFormatId")},e},{})}function d(e,t){return t.components.reduce(function(e,t){return e[t.get("reference")]={aggregationFormat:t.get("format"),aggregationFormatId:t.get("formatId")},e},e)}function h(e,t,i,r,n){var a=i.schema,s=g(r,n);return b.reduce(e,function(e,i){if(i.level){var r=a.getByReference(i.level.field);e.push(b.defaults(i.level,{id:r.hierarchicalName,kind:r.kind,field:r.name,dimension:r.hierarchicalName,hierarchicalName:r.hierarchicalName,functionName:r.aggregation,type:r.type,label:r.label,labelId:r.labelId,includeAll:!1,format:s[i.level.id||i.level.field].format,formatId:s[i.level.id||i.level.field].formatId,aggregationFormat:s[i.level.id||i.level.field].aggregationFormat,aggregationFormatId:s[i.level.id||i.level.field].aggregationFormatId}))}else{if(!i.aggregations)throw new Error('Unknown element in "GroupBy"');e=e.concat(p(t,a,s))}return e},[])}function u(e,t){var i=t.schema,r=b.reduce(t.component.getTableComponent().getGroups(),function(e,t){return e[t.get("reference")]={aggregationFormat:t.get("aggregationFormat"),format:t.get("format")},e},{});return b.map(b.compact(b.pluck(e,"group")),function(e){var t=i.getByReference(e.field);return b.defaults(e,{id:t.hierarchicalName,kind:t.kind,field:t.name,dimension:t.hierarchicalName,hierarchicalName:t.hierarchicalName,functionName:t.aggregation,type:t.type,label:t.label,labelId:t.labelId,aggregationFormat:r[e.id||e.field].aggregationFormat,aggregationFormatId:r[e.id||e.field].aggregationFormatId,format:r[e.id||e.field].format,formatId:r[e.id||e.field].formatId,includeAll:!0})})}function m(e,t){for(var i=t.schema,r=[],n=[].concat(e.aggregations||[]),a=e.fields||e.distinctFields||[],s=b.reduce(t.component.getTableComponent().getColumns(),function(e,t){return e[t.get("reference")]={aggregationFormat:t.get("aggregationFormat"),aggregationFormatId:t.get("aggregationFormatId"),format:t.get("format"),formatId:t.get("formatId")},e},{}),o=0;o<a.length;o++){for(var l=!1,c=0;c<n.length&&!l;c++)!n[c]||n[c].fieldRef!==a[o].id&&n[c].fieldRef!==a[o].field||(l=f(n[c],a[o].id||a[o].field,i.getByReference(a[o].field),s),n[c]=!1);l?r.push(l):r.push(y(a[o],i,s))}return r.concat(p(b.compact(n),i,s,a))}function p(e,t,i,r){return b.map(e,function(e){var n,a;return r?(n=b.find(r,function(t){return e.fieldRef===t.id||e.fieldRef===t.field}),n?(n=n.field,a=n.id||n.field):n=e.fieldRef):n=e.fieldRef,f(e,a,t.getByReference(n),i)})}function f(e,t,i,r){return b.defaults({field:e.fieldRef,functionName:e.functionName,aggregationType:e.type,aggregationFormat:r[e.id||e.fieldRef].aggregationFormat,aggregationFormatId:r[e.id||e.fieldRef].aggregationFormatId,format:r[e.id||e.fieldRef].format,formatId:r[e.id||e.fieldRef].formatId,id:t||e.id,firstLevelExpression:e.firstLevelExpression,timeBalanceFunctionName:e.timeBalanceFunctionName},{id:i.hierarchicalName,kind:i.kind,field:i.name,dimension:i.hierarchicalName,hierarchicalName:i.hierarchicalName,functionName:i.aggregation,type:i.type,label:i.label,labelId:i.labelId,includeAll:!0})}function y(e,t,i){var r=t.getByReference(e.field);return{id:e.id||e.field,kind:r.kind,field:r.name,dimension:r.hierarchicalName,hierarchicalName:r.hierarchicalName,functionName:r.aggregation,aggregationFormat:i[e.id||e.field].aggregationFormat,aggregationFormatId:i[e.id||e.field].aggregationFormatId,format:i[e.id||e.field].format,formatId:i[e.id||e.field].formatId,type:r.type,label:r.label,labelId:r.labelId,includeAll:!0}}function x(e,t){var i,r,n=t.get("showTotals");return e.type()===H.type.MULTIAXIS?i={aggregations:b.reduce(e.cols.axis.models.concat(e.rows.axis.models),function(e,t){return t.isMeasure()&&e.push({id:t.get("id"),type:t.get("aggregationType"),functionName:t.get("functionName"),fieldRef:t.get("hierarchicalName"),firstLevelExpression:t.get("firstLevelExpression"),timeBalanceFunctionName:t.get("timeBalanceFunctionName")}),e},[])}:(i={},r=b.reduce(t.getColumns(),function(e,t){if(n||t.hasSummary()){var i=t.level();i&&e.push({id:i.get("id")||i.get("type"),type:i.get("aggregationType"),functionName:i.get("functionName"),fieldRef:i.get("hierarchicalName"),firstLevelExpression:i.get("firstLevelExpression"),timeBalanceFunctionName:i.get("timeBalanceFunctionName")})}return e},[]),r.length&&(i.aggregations=r),t.get("showDetails")&&(i[t.get("showDistinct")?"distinctFields":"fields"]=e.cols.axis.map(function(e){return{id:e.get("id"),field:e.get("hierarchicalName")}}))),i}function v(e){return e.type()===H.type.MULTIAXIS?{rows:I(e.rows,e.get("_chartMode")),columns:I(e.cols,e.get("_chartMode"))}:[{allGroup:{}}].concat(e.rows.axis.map(function(e){return{group:{id:e.get("id"),field:e.get("hierarchicalName")}}}))}function I(e,t){var i={items:e.axis.toQueryMultiaxisAxisItems()};return e.expansions.length&&(i.expansions=e.expansions.toJSON({isChartMode:t})),i}function T(e){var t=e.aggregations||[],i=e.fields||e.distinctFields||[];b.each(t,function(e){e.id===e.fieldRef&&delete e.id}),b.each(i,function(e){e.id===e.field&&delete e.id});for(var r=0;r<t.length;r++)for(var n=0;n<i.length;n++)t[r].id&&t[r].id==i[n].id&&(t[r].fieldRef=i[n].id,delete t[r].id);return e}function w(e){return b.each(e.rows&&e.columns?e.rows.items.concat(e.columns.items):e,function(e){var t=e.level||e.group;t&&t.id&&t.id===t.field&&delete t.id}),e}function M(e,t){return{componentType:"axis",components:t.axis.multiAxisMap(function(e){var t;if(e.isMeasure())t={componentType:"level",components:[],properties:{reference:"Measures",dimension:"Measures",label:"Measures"}};else{if(!e.isLevel())throw new Error("Unknown kind: "+e.get("kind"));t={componentType:"level",components:[],properties:{reference:e.has("id")?e.get("id"):e.get("hierarchicalName"),dimension:e.get("dimension"),includeAll:e.get("includeAll"),format:e.get("format"),formatId:e.get("formatId"),aggregationFormat:e.get("aggregationFormat")}}}return t}),properties:{name:t.id}}}function N(e){var t=function(e){return e.isMeasure()},i=e.rows.axis.filter(t).concat(e.cols.axis.filter(t));return{componentType:"measures",components:b.map(i,function(e){return{componentType:"measure",components:[],properties:{format:e.get("aggregationFormat"),formatId:e.get("aggregationFormatId"),reference:e.get("id")||e.get("hierarchicalName")}}}),properties:{}}}function A(e){return e.cols.axis.map(function(e){return{componentType:"column",components:[],properties:{id:e.has("id")?e.get("id"):e.get("hierarchicalName"),reference:e.has("id")?e.get("id"):e.get("field"),detailFieldReference:e.get("hierarchicalName"),aggregatedFieldReferences:[e.get("hierarchicalName")],aggregationFormat:e.get("aggregationFormat"),aggregationFormatId:e.get("aggregationFormatId"),format:e.get("format"),formatId:e.get("formatId")}}})}function L(e){return e.rows.axis.map(function(e){return{componentType:"group",components:[],properties:{reference:e.get("hierarchicalName"),format:e.get("format"),formatId:e.get("formatId")}}})}function E(e){if(e.isLevel())return{id:e.get("id")||e.get("hierarchicalName"),type:e.get("type")}}var b=e("underscore"),C=e("backbone"),F=e("runtime_dependencies/js-sdk/src/jrs.configs"),_=e("../enum/QueryExecutorHttpHeaders"),B=e("../../visualChooser/VisualizationTypesController"),R=e("./AdHocQueryParametersModel"),O=e("./AdHocQueryExpressionModel"),S=e("./AdHocQueryExpansionsCollection"),U=e("./AdHocQueryLevelCollection"),D=e("./AdHocQueryOrderByCollection"),H=C.Model.extend({initialize:function(e,t){this.contextPath=t&&t.server,this.adHocModel=t.adHocModel,this.visualizationTypesManager=new B,this.where=new O({},t),this.rows={id:"rows"},this.cols={id:"columns"},this._initializeAxes(t),this._initializeParameters(t),this._initializeExpansions(t),this._initializeOrderBy(t),this.listenTo(this.adHocModel,"change:visualizationType",function(e,t){var i="Table"===t?H.type.MULTILEVEL:H.type.MULTIAXIS;this.set({_type:i,_chartMode:i===H.type.MULTIAXIS&&"Crosstab"!==t})}),this.on("change:_type",this._triggerChanged,this),this.on("change:_chartMode",this._triggerChanged,this)},toJSON:function(e){var t,i,r={},n=this.type();return n!==H.type.PROVIDED&&(i=this.selectJSON(),i&&(r.select=T(i)),i=this.whereJSON(),i&&(r.where=i),i=this.groupByJSON(),i&&(r.groupBy=w(i)),i=this.orderByJSON(),i&&(r.orderBy=i),e?t=r:(t={},t[n]=r)),t},selectJSON:function(){return x(this,this.adHocModel.component.getTableComponent())},whereJSON:function(){return b.cloneDeep(this.get("where"))},groupByJSON:function(){return v(this)},orderByJSON:function(){return this.orderBy.toJSON(this.type()===H.type.MULTILEVEL)},acquire:function(e){var t;if(e[H.type.MULTILEVEL]?(t=e[H.type.MULTILEVEL],t._type=H.type.MULTILEVEL):e[H.type.MULTIAXIS]?(t=e[H.type.MULTIAXIS],t._type=H.type.MULTIAXIS):this.clear(),t){if(this.set(t),t.where&&(this.where.acquire(t.where.filterExpression),this.parameters.acquire(t.where.parameters,this.where.readFilterInformation())),t.groupBy)if(t.groupBy.rows&&t.groupBy.columns){var i=this.adHocModel.component.getMultiAxisComponent(),r=i.getMeasuresComponent();this.rows.axis.reset(h(t.groupBy.rows.items,t.select.aggregations,this.adHocModel,i.getRowsComponent(),r),{silent:!0}),this.cols.axis.reset(h(t.groupBy.columns.items,t.select.aggregations,this.adHocModel,i.getColumnsComponent(),r),{silent:!0}),this.rows.expansions.reset(t.groupBy.rows.expansions||[],{silent:!0}),this.cols.expansions.reset(t.groupBy.columns.expansions||[],{silent:!0}),this.rows.expansions.forEach(b.bind(c,this,this.rows)),this.cols.expansions.forEach(b.bind(c,this,this.cols))}else this.rows.axis.reset(u(t.groupBy,this.adHocModel),{silent:!0}),this.cols.axis.reset(m(t.select,this.adHocModel),{silent:!0}),this.rows.expansions.reset([],{silent:!0}),this.cols.expansions.reset([],{silent:!0});else this.cols.axis.reset(m(t.select,this.adHocModel.schema),{silent:!0}),this.rows.expansions.reset([],{silent:!0}),this.cols.expansions.reset([],{silent:!0});t.orderBy&&this.orderBy.reset(t.orderBy,{silent:!0}),this.trigger("query:componentsDataChange",this)}},type:function(e){if(!arguments.length){var t=this.has("select")&&!b.isEmpty(this.get("select"))?this.get("_type"):H.type.PROVIDED;return t||(t=this.has("select")&&!b.isEmpty(this.get("select"))?H.type.MULTILEVEL:H.type.PROVIDED,this.has("groupBy")&&this.get("groupBy").rows&&this.get("groupBy").columns&&(t=H.type.MULTIAXIS)),t}this.set({_type:e})},headers:function(){var e;return e=this.type()===H.type.MULTILEVEL?{Accept:_.ACCEPT_MULTI_LEVEL_DATA,"Content-Type":_.CONTENT_TYPE_MULTI_LEVEL_QUERY}:this.type()===H.type.MULTIAXIS?{Accept:_.ACCEPT_MULTI_AXIS_DATA,"Content-Type":_.CONTENT_TYPE_MULTI_AXIS_QUERY}:{Accept:_.ACCEPT_NO_FLAT,"Content-Type":_.CONTENT_TYPE_PROVIDED_QUERY},e["Accept-Timezone"]=F.userTimezone,e},_initializeAxes:function(e){this.cols.axis=new U([],e),this.rows.axis=new U([],b.extend({master:this.cols.axis},e));var t=b.bind(function(){this.trigger("query:componentsDataChange",this),this._triggerChanged()},this);this.listenTo(this.cols.axis,"add change remove reset",t),this.listenTo(this.rows.axis,"add change remove reset",t)},_initializeParameters:function(e){this.parameters=new R({},e),this.listenTo(this.parameters,"change",function(){if(this.has("where")){var e=b.omit(this.get("where"),"parameters");e.parameters=b.defaults(this.parameters.toJSON(),this.get("where").parameters),this.set("where",e)}this._triggerChanged()},this)},_initializeExpansions:function(e){this.rows.expansions=new S([],b.extend({query:this,axis:this.rows},e)),this.cols.expansions=new S([],b.extend({query:this,axis:this.cols},e)),this.listenTo(this.rows.expansions,"add change",b.bind(n,this,this.rows)),this.listenTo(this.cols.expansions,"add change",b.bind(n,this,this.cols)),this.listenTo(this.rows.expansions,"remove",b.bind(r,this,this.rows)),this.listenTo(this.cols.expansions,"remove",b.bind(r,this,this.cols))},_initializeOrderBy:function(){this.orderBy=new D,this.on("query:componentsDataChange",function(){this.orderBy.measures=b.reduce(this.rows.axis.models.concat(this.cols.axis.models),function(e,t){return t.isMeasure()&&(e[t.get("hierarchicalName")]=!0),e},{}),this.orderBy.multiAxisItems=b.reduce(this.rows.axis.toQueryMultiaxisAxisItems().concat(this.cols.axis.toQueryMultiaxisAxisItems()),function(e,t){return t.level&&(e[t.level.id||t.level.field]=!0),e},{})},this),this.listenTo(this.orderBy,"add change remove",this._triggerChanged,this)},_triggerChanged:function(){this.trigger("query:changed",this)},_outputParameters:function(){var e=this.rows.axis.hasMeasures()||this.cols.axis.hasMeasures()?[{id:"Measures"}]:[];return e=this.type()===H.type.MULTIAXIS?e.concat(this.rows.axis.multiAxisMap(E).concat(this.cols.axis.multiAxisMap(E))):e.concat(this.rows.axis.map(E).concat(this.cols.axis.map(E))),b.compact(e)},toDataComponent:function(){return{metadata:{availableVisualizationTypes:this.getAllowedTypesList(),inputParameters:this.parameters.toDataComponent(),outputParameters:this._outputParameters()}}},getTableComponents:function(){return A(this).concat(L(this))},getCrosstabComponents:function(){return[M(this,this.cols),M(this,this.rows),N(this)]},getChartComponents:function(){return this.getCrosstabComponents()},getDisabledTypesList:function(){return this.visualizationTypesManager.getDisabledTypesList(this.cols.axis,this.rows.axis)},getAllowedTypesList:function(){return this.visualizationTypesManager.getAllowedTypesList(this.cols.axis,this.rows.axis)}},{type:{PROVIDED:"provided",FLAT:"flat",MULTILEVEL:"multiLevel",MULTIAXIS:"multiAxis"}});H.prototype.defaults={_type:H.type.PROVIDED},i.exports=H});