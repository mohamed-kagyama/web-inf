/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","bundle!AdHocBundle","text!./template/generalTableLayout.htm","text!./template/tableHeaderTemplate.htm","text!./template/tableBodyTemplate.htm","text!./template/tableFooterTemplate.htm","text!../template/empty.htm","./model/tableDataConverter","../model/factory/cellTypesFactory","perfect-scrollbar"],function(t,e,i){function a(t){var e=s.cloneDeep(t);try{t.column&&(e.column=o(t.column)),t.group&&(e.group=s.map(t.group,o)),t.row&&t.row.cells&&(e.row.cells=s.map(t.row.cells,o))}catch(t){return{}}return e}function o(t){return s.pick(t||{},"index","label","labelId","value")}var s=t("underscore"),n=t("jquery"),r=t("backbone"),h=t("bundle!AdHocBundle"),l=t("text!./template/generalTableLayout.htm"),d=t("text!./template/tableHeaderTemplate.htm"),c=t("text!./template/tableBodyTemplate.htm"),p=t("text!./template/tableFooterTemplate.htm"),b=t("text!../template/empty.htm"),g=t("./model/tableDataConverter"),m=t("../model/factory/cellTypesFactory");t("perfect-scrollbar");var u=s.template(d),$=s.template(c),y=s.template(p),f=r.View.extend({el:function(){return s.template(l)({i18n:h})},initialize:function(t){s.bindAll(this,"onScroll","onBottomScroll");var e=this;if(this._initElements(),this.options=t,!s.isObject(t.dataModel))throw Error("Missing required init option adhocModel");this.adHocModel=t.dataModel,this.tableModel=this.adHocModel.component.getTableComponent(),this.dataConverter=new g,this.rows=[],this.rowHeights=[],this.activeRowsStart=0,this.activeRowsEnd=0,this.currentLoadedOffset=0,this.defaultPageSize=50,this.emptyMessageHeight=0,this.cellPadding=0,this.on("scroll:loading",function(){e.isDataLoading||(e.isDataLoading=!0,e._loadNewPortion().done(function(){e._loadNewActiveRows(!0),e.isDataLoading=!1,e._setOverlay(!1)}))}),this.on("scroll:scroll",this._loadNewActiveRows,this),this.on("scroll:scroll scroll:loading",function(){e._scrollTimer&&clearTimeout(e._scrollTimer),e._scrollTimer=setTimeout(function(){var t=+e.$tableBodyContainer.css("top").replace("px",""),i=e.$tableBodyContainer.height(),a=e.$bodyDataContainer.scrollTop(),o=e.$el.height();(a<t||t+i<a+o)&&e._loadNewActiveRows(!0)},100)}),this.on("scroll:bottom",function(){e.isDataLoading&&e._setOverlay(!0)}),this.$bodyDataContainer.on("scroll",this.onScroll),this.$bottomDataContainer.on("scroll",this.onBottomScroll)},isAcceptable:function(t){return"Table"===t},render:function(t){this._setOverlay(!0),this._clear();var e=this,i=n.Deferred(),a=this.adHocModel.dataSet.data().fail(s.bind(i.reject,i)),o=this.adHocModel.bundles.bundle().fail(s.bind(i.reject,i));return n.when(a,o).done(function(a,o){e.rows=[],e.rowHeights=[],e._acquireDataSet(a),t&&t.append(e.$el),e.$tableHeaderContainer.html(u({header:e.headerRow=e._getHeaderRow(),widths:e.columnWidths,cellTypesFactory:m})),e.$tableBottomContainer.html(y({footer:e.dataConverter.grandTotalRow,widths:e.columnWidths,cellTypesFactory:m}));var s=e.$(".jr-mDatatable-cell.jr");e.cellPadding=s.innerWidth()-s.width(),s.each(function(t,i){n(i).find("div.jr-mDatatable-cell-wrapper").width(i.offsetWidth-e.cellPadding)}),e.renderData=e.rows,e.$tableBodyContainer.html($({data:e.rows,widths:e.columnWidths,padding:e.cellPadding,cellTypesFactory:m})),e.activeRowsStart=0,e.activeRowsEnd=e.rows.length,e._processLinks(),e.$el.css({maxWidth:n(e.options.options.container).width()}),e._checkData(),e._calculateSizes(),e._checkloadActiveRows(!1),e._updateTableSize(),e._initPerfectScrollbar(),e._setOverlay(!1),i.resolve()}),i.promise()},_setOverlay:function(t){this.adHocModel.trigger("component:busy",t)},_clear:function(){this.dataConverter.reset(),this.currentLoadedOffset=0,this.adHocModel.dataSet.set({params:{offset:[0],pageSize:[this.defaultPageSize]}})},_checkData:function(){this.rows.length||this.dataConverter.grandTotalRow.length?this.$emptyMessage.addClass("jr-isHidden"):this.headerRow.length?(this.$emptyMessage.removeClass("jr-isHidden"),this.emptyMessageHeight=this.$emptyMessage[0].clientHeight):this.$el.parent().html(s.template(b,{i18n:h}))},_calculateSizes:function(){var t,e,i=this,a=0,o=this.$el.height()-this.$(".jr-mDatatable-headerContainer").height(),s=this.$(".jr-mDatatable-bodyContainer table tr").length;for(this.rowHeight=this.$(".jr-mDatatable-bodyContainer table").height()/s,this.$(".jr-mDatatable-bodyContainer table tr").each(function(t,e){i.rowHeights[t+i.activeRowsStart]||(i.rowHeights[t+i.activeRowsStart]=n(e).height())}),e=0;e<this.activeRowsStart;e++)a+=this.rowHeights[e];for(t=a,e=this.activeRowsStart,this.rowHeights.length;e<this.rowHeights.length;e++)t+=this.rowHeights[e];this.$bodyBackground.height(t+1),this.$tableBodyContainer.css({top:a+"px"}),this.$tableBodyContainer.height()+this.$bodyCompensator.height()<o?this.$bodyDataContainer.css({height:"initial"}):this.$bodyDataContainer.height()>this.$el.parent().height()&&this.$bodyDataContainer.css({height:o}),this.$tableBodyContainer.width()-this.$emptyMessage.find(".jr-mMessage").width()<5&&this.$emptyMessage.find(".jr-mMessage").addClass("jr-uWidth-95pc"),this.$bottomDataContainer.css({bottom:this.$bottomDataContainer.height()+"px"}),this.$bodyCompensator.height(this.$bottomDataContainer.find("div").height())},_initElements:function(){this.$tableHeaderContainer=this.$(".jr-mDatatable-headerContainer table:first"),this.$tableBodyContainer=this.$(".jr-mDatatable-bodyContainer table:first"),this.$tableBottomContainer=this.$(".jr-mDatatable-bottomContainer table:first"),this.$bodyBackground=this.$(".jr-jBodyBackground"),this.$headerDataContainer=this.$(".jr-mDatatable-headerContainer table:first"),this.$bodyDataContainer=this.$(".jr-mDatatable-bodyContainer"),this.$bottomDataContainer=this.$(".jr-mDatatable-bottomContainer"),this.$emptyMessage=this.$(".jr-jEmptyMessage"),this.$bodyCompensator=this.$(".jr-mDatatable-bodyContainer .jr-uCompensator"),this.$emptyMessageWidth=0},_initPerfectScrollbar:function(){this._hasPs?0===this.$tableBodyContainer.width()?this.$bottomDataContainer.perfectScrollbar("update"):this.$bodyDataContainer.perfectScrollbar("update"):(0===this.$tableBodyContainer.width()?this.$bottomDataContainer.perfectScrollbar():this.$bodyDataContainer.perfectScrollbar(),this._hasPs=!0)},_loadNewPortion:function(){var t,e=this.currentLoadedOffset+this.defaultPageSize,i=this.adHocModel.dataSet.get("totalCounts");return i<=e?t=(new n.Deferred).resolve(this.adHocModel.dataSet).promise():(this.currentLoadedOffset=e,t=this.adHocModel.dataSet.set({params:{offset:[e],pageSize:[this.defaultPageSize]}}).data().done(s.bind(this._acquireDataSet,this)).fail(s.bind(this.adHocModel.trigger,this.adHocModel,"component:error"))),t},_acquireDataSet:function(t){t||(t=this.adHocModel.dataSet.get("dataset")),this.rows=this.rows.concat(this.dataConverter.convert(this.adHocModel,t)),this.columnWidths||(this.columnWidths=this._getColumnWidths())},_getColumnWidths:function(){return this.tableModel.components.findComponentDeep("column").map(function(t){return t.attributes.width})},_getHeaderRow:function(){var t=this.dataConverter.getColumns();return s.map(this.tableModel.components.findComponentDeep("column"),function(e,i){return{label:e.label(),hyperlink:{id:"h_"+i,type:g.linkTypes.HEADER,value:e.label(),column:t[i],row:{relativeIndex:-1}}}})},_loadNewActiveRows:function(t){for(var e=Math.ceil(this.$bodyDataContainer.height()/this.rowHeight),i=this.$bodyDataContainer.scrollTop(),a=0,o=0,s=this;o<i;)o+=this.rowHeights[a++];(t||this.activeRowsStart>=a&&0!==a||a+e>=this.activeRowsEnd)&&(this.activeRowsEnd=Math.min(a+2*e,this.rows.length),this.activeRowsEnd>this.rowHeights.length?(this.activeRowsStart=Math.max(0,a-1),this.activeRowsEnd=Math.min(a+3*e,this.rows.length)):this.activeRowsStart=Math.max(0,a-e),this.renderData=this.rows.slice(this.activeRowsStart,this.activeRowsEnd),s.$tableBodyContainer.html($({data:this.renderData,widths:this.columnWidths,padding:this.cellPadding,cellTypesFactory:m})),this._processLinks(),this._updateTableSize(),this._calculateSizes())},_processLinks:function(){function t(t,i){var a={},o=e(t,i);return o.column&&"measure"===o.column.kind&&(a.Measures=[o.column.id]),s.each(o.column&&o.row&&o.row.cells,function(t){"level"===t.kind&&(o.linkType===g.linkTypes.GROUP_TOTAL||o.linkType===g.linkTypes.GRAND_TOTAL?a[t.id]="total_node":o.linkType===g.linkTypes.DATA&&(a[t.id]=t.initialValue))}),s.each(o.group,function(t){o.linkType===g.linkTypes.GRAND_TOTAL?a[t.id]="total_node":a[t.id]=t.value}),a}function e(t,e){var a=e.getAttribute("data-hyperlink-id"),o=i(t);return s.findWhere(o,{id:a})}function i(t){var e=[];return s.each(t.renderData||t.rows,function(t){s.each(t,function(t){e.push(t.hyperlink)})}),s.each(t.dataConverter.grandTotalRow,function(t){e.push(t.hyperlink)}),s.each(t.headerRow,function(t){e.push(t.hyperlink)}),e}var o,n,r=this,h=r.options.options.linkOptions;h&&h.beforeRender&&h.beforeRender(r.$el.find(".jr-jHyperLink").map(function(i,s){return o=e(r,s),n=t(r,s),{element:s,data:n||a(o)}}).toArray()),h&&h.events&&(r.events=s.reduce(h.events,function(i,s,h){return i[h+" .jr-jHyperLink"]=function(i){o=e(r,i.currentTarget),n=t(r,i.currentTarget),s.call(this,i,n,null,a(o))},i},{}),r.delegateEvents())},_setTableResizeValue:function(t){this.$bodyDataContainer.width(t),this.$headerDataContainer.width(t),this.$bottomDataContainer.width(t),this.$el.css({maxWidth:t})},_checkloadActiveRows:function(t){var e=+this.$tableBodyContainer.css("top").replace("px",""),i=this.$tableBodyContainer.height(),a=this.$bodyDataContainer.scrollTop(),o=this.$el.height();if(a<e||e+i<a+o){t&&this._loadNewActiveRows(!0);var s=this.$emptyMessage[0].clientHeight,n=this.$headerDataContainer.outerHeight();this.$emptyMessage.hasClass("jr-isHidden")?this.$el.height(this.$bodyDataContainer[0].clientHeight+n):this.$el.height()<this.$(".jr-jEmptyMessage > div").height()+n&&s<=this.$el.height()?(this.$el.height(s+n),this.$emptyMessage.css("top",n/2)):this.$el.height(s)}},_updateTableSize:function(){var t=this.$el.parent().height()-(this.$el.parent().outerHeight(!0)-this.$el.parent().outerHeight());this.$emptyMessage.hasClass("jr-isHidden")?t-this.$tableHeaderContainer[0].offsetHeight<this.$tableBodyContainer[0].offsetHeight+this.$bodyCompensator.height()?(this.$bodyDataContainer.height(t-this.$tableHeaderContainer[0].offsetHeight),this.$el.css({height:""})):this.$bodyDataContainer.height()>this.$bodyBackground.height()+this.$bodyCompensator.height()?(this.$bodyDataContainer.height(this.$bodyBackground.height()+this.$bodyCompensator.height()),this.$el.css({height:this.$bodyBackground.height()+this.$bodyCompensator.height()})):this.$bodyDataContainer.height()<this.$bodyBackground.height()+this.$bodyCompensator.height()&&this.$tableBodyContainer[0].offsetHeight+this.$bodyCompensator.height()<=t&&(this.$bodyDataContainer.height(this.$bodyBackground.height()+this.$bodyCompensator.height()),this.$el.css({height:this.$bodyBackground.height()+this.$bodyCompensator.height()})):t<this.emptyMessageHeight&&this.$emptyMessage.height(t);var e=0==this.$tableBodyContainer[0].offsetWidth?0==this.$tableHeaderContainer[0].offsetWidth?this.$tableBottomContainer[0].offsetWidth:this.$tableHeaderContainer[0].offsetWidth:this.$tableBodyContainer[0].offsetWidth;this.$emptyMessage.hasClass("jr-isHidden")?n(this.options.options.container).width()>e&&this.$bodyDataContainer[0].offsetWidth!==e?this._setTableResizeValue(e):n(this.options.options.container).width()<=e&&this._setTableResizeValue(this.$el.parent().outerWidth()-(this.$el.parent().outerWidth(!0)-this.$el.parent().outerWidth())):(this.$emptyMessageWidth=Math.max(this.$emptyMessageWidth,e),e<this.$el.parent().width()?this._setTableResizeValue(this.$emptyMessageWidth):this._setTableResizeValue(this.$el.parent().width()))},onScroll:function(){var t=this.$bodyBackground.height(),e=this.$bodyDataContainer.scrollTop(),i=this.$bodyDataContainer.scrollLeft();e+this.$el.height()>=t-10*this.rowHeight&&this.trigger("scroll:loading"),this.trigger("scroll:scroll"),e+this.$el.height()>=t&&this.trigger("scroll:bottom"),this.$(".jr-mDatatable-headerContainer").scrollLeft(i),this.$(".jr-mDatatable-bottomContainer").scrollLeft(i)},onBottomScroll:function(){var t=this.$bottomDataContainer.scrollLeft();this.$(".jr-mDatatable-headerContainer").scrollLeft(t),this.$(".jr-mDatatable-bodyContainer").scrollLeft(t)},refresh:function(t){var e=this;this.adHocModel.dataSet.resetDataset(),this.render().done(function(){e.$bodyDataContainer.scrollTop(0),t.resolve.apply(t,arguments)}).fail(s.bind(t.reject,t))},resize:function(){this._checkloadActiveRows(!0),this._updateTableSize(),this._initPerfectScrollbar()},remove:function(){return this.$bodyDataContainer.off("scroll",this.onScroll),this.$bottomDataContainer.off("scroll",this.onBottomScroll),r.View.prototype.remove.apply(this,arguments)}});i.exports=f});