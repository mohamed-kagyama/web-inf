/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/js-sdk/src/jrs.configs","momentExtension","backbone","highcharts","../../../bi/adhoc/error/biComponentErrorFactoryAdHocViewProxy","bundle!AdHocBundle","./model/chartDataConverter","./adhocToHighchartsAdapter","text!./template/chart.htm","text!./template/timeSeriesTooltipFormatter.htm","./HyperlinkChartHelper","./adhocToHighchartsAdapter/adhocDataProcessor"],function(e,t,r){function i(e){if("DualLevelPie"===e.component.get("visualizationType")){var t=e.dataSet.query;if(t.rows.axis.multiAxisMap(function(e){return e})[0].isMeasure()){var r=t.rows.expansions.find(function(e){return e.get("level")&&e.get("level").aggregation&&!e.get("level").expanded});if(r){var i=a.clone(r.get("level"));i.expanded=!0,r.set({level:i})}}}}var a=e("underscore"),s=e("jquery"),o=e("runtime_dependencies/js-sdk/src/jrs.configs"),n=e("momentExtension"),h=e("backbone"),c=e("highcharts"),d=e("../../../bi/adhoc/error/biComponentErrorFactoryAdHocViewProxy"),l=e("bundle!AdHocBundle"),m=e("./model/chartDataConverter"),g=e("./adhocToHighchartsAdapter"),p=e("text!./template/chart.htm"),u=e("text!./template/timeSeriesTooltipFormatter.htm"),f=e("./HyperlinkChartHelper"),C=e("./adhocToHighchartsAdapter/adhocDataProcessor");r.exports=h.View.extend({initialize:function(e){this.$el=s(a.template(p)({i18n:l})),this._initElements(),this.adHocModel=e.dataModel,this.options=e.options,this.hyperlinkService=new f},render:function(e){var t=s.Deferred(),r=this;e&&e.append(this.$el),this.adHocModel.trigger("component:busy",!0),this.adHocModel.dataSet.set({params:{offset:[0,0],pageSize:[2147483647,2147483647]}}),i(this.adHocModel);var o=this.adHocModel.dataSet.data().fail(a.bind(t.reject,t)),n=this.adHocModel.bundles.bundle().fail(a.bind(t.reject,t));return s.when(o,n).done(function(){try{r._checkData()&&r._renderChart(t),r.adHocModel.trigger("component:busy",!1),t.resolve()}catch(e){return t.reject(d.adHocViewRender(e))}}),t},_initElements:function(){this.$emptyMessage=this.$(".jr-jEmptyMessage"),this.$canvas=this.$(".jr-mChart")},_renderChart:function(e){var t=JSON.parse(JSON.stringify(this.adHocModel.toJSON())),r=JSON.parse(JSON.stringify(this.adHocModel.dataSet.toJSON())),i=this.options.linkOptions,a=this.adHocModel.component.getChartComponent(),s=m(t,r,this.adHocModel,this.hyperlinkService),o={totalsLabelForChart:l["adhoc.node.total.node"],allLabelForChart:l["adhoc.node.total.node"]},n=JSON.parse(JSON.stringify(s.queryData)),h=JSON.parse(JSON.stringify(s.chartState));C.load(n),C.messages=o,this._savedChartData={messages:o,chartComponent:a,oldState:s,clonedQueryData:n,clonedChartState:h,linkOptions:i},this._prepareConfigForHighcharts(),this._callHighchartsToRenderChart()},_prepareConfigForHighcharts:function(){var e=this._savedChartData,t=e.messages,r=e.chartComponent,i=e.oldState,a=e.clonedQueryData,s=e.clonedChartState,o=e.linkOptions,n={width:this._getContainerWidth()||400,height:this._getContainerHeight()||300,messages:t,isTimeSeries:r.isTimeSeries()},h=g.generateOptions(a,s,n);this.hyperlinkService.perform(this,h),this._correctOptionsForVisualize(h,r,i),h.chart.renderTo=this.$(".jr-mChart")[0],h.chart.height||(h.chart.height=this._getContainerHeight()),h.chart.width||(h.chart.width=this._getContainerWidth()),o&&o.beforeRender&&o.beforeRender(this.hyperlinkService.getHyperlinks(h,this)),this._highchartsOptions=h},_callHighchartsToRenderChart:function(){this._destroyExistingCharts();try{this.highchartsInstance=new c.Chart(this._highchartsOptions)}catch(t){this._destroyExistingCharts();var e;throw e=/\#19/.test(t)?l["adhoc.error.highcharts.19"]:/\#13/.test(t)?l["adhoc.error.highcharts.13"]:l["adhoc.error.highcharts.default"],{name:"error",type:"highchartsInternalError",data:{error:t,message:e}}}},_destroyExistingCharts:function(){var e=this;a.each(c.charts,function(t){t&&e.$el===t.renderTo&&t.destroy()}),this.highchartsInstance&&this.highchartsInstance.destroy&&(this.highchartsInstance.destroy(),this.highchartsInstance=void 0)},_getContainerWidth:function(){return this.$el.parent().width()},_getContainerHeight:function(){return this.$el.parent().height()},_checkData:function(){var e=!this.adHocModel.dataSet.get("dataset").empty;return e?(this.$emptyMessage.addClass("jr-isHidden"),this.$canvas.removeClass("jr-isHidden")):(this.$emptyMessage.removeClass("jr-isHidden"),this.$canvas.addClass("jr-isHidden")),e},_correctOptionsForVisualize:function(e,t,r){var i;t.isTimeSeries()&&a.contains(["hour","minute","second","millisecond"],r.chartState.timeSeriesCategorizerName)&&("hour"===r.chartState.timeSeriesCategorizerName?i="HH:mm":"minute"===r.chartState.timeSeriesCategorizerName?i="HH:mm":"second"===r.chartState.timeSeriesCategorizerName?i="HH:mm:ss":"millisecond"===r.chartState.timeSeriesCategorizerName&&(i="HH:mm:ss.SSS"),e.tooltip.formatter=function(){var e;return e={pointX:n(this.point.x,"x").tz(o.userTimezone).format(i),color:this.series.color,seriesName:this.series.name,value:c.numberFormat(this.point.y,2)},a.template(u)(e)})},refresh:function(e){return this.adHocModel.dataSet.resetDataset(),this.render().done(a.bind(e.resolve,e)).fail(a.bind(e.reject,e)),e},resize:function(){this._resizeTimer&&clearTimeout(this._resizeTimer),this._resizeTimer=this._savedChartData&&setTimeout(this._reactOnResize.bind(this),250)},_reactOnResize:function(){this._resizeTimer=null,C.load(this._savedChartData.clonedQueryData),this._prepareConfigForHighcharts(),this._callHighchartsToRenderChart()},isAcceptable:function(e){return"Table"!==e&&"Crosstab"!==e}})});