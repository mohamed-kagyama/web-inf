/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","./CrosstabAuxModelNodeBuilder","./visitors/MultiAxisModelRangeVisitor","./visitors/MultiAxisModelIndexVisitor","runtime_dependencies/js-sdk/src/common/logging/logger"],function(e,t,s){var o=e("backbone"),i=e("underscore"),a=e("./CrosstabAuxModelNodeBuilder"),r=e("./visitors/MultiAxisModelRangeVisitor"),n=e("./visitors/MultiAxisModelIndexVisitor"),h=e("runtime_dependencies/js-sdk/src/common/logging/logger"),d=h.register("CrosstabAuxModel"),l=o.Model.extend({initialize:function(e,t){i.bindAll(this,"_checkAvailability","_onExpansionsChange","_onError","_onSuccess"),this.EMPTY_CELL={label:""},this.adHocModel=t.dataModel,this._clear(),this.listenTo(this.adHocModel.dataSet.query.cols.expansions,"expansions:change",this._onExpansionsChange),this.listenTo(this.adHocModel.dataSet.query.rows.expansions,"expansions:change",this._onExpansionsChange),this.on("change",this._checkAvailability)},dispose:function(){this.stopListening()},reset:function(){this._clear(),this.set({colsOffset:0,colsPageSize:50,rowsOffset:0,rowsPageSize:50},{silent:!0}),this._checkAvailability()},keepAxis:function(e){"rows"===e?(this.colIndex=new n,this.colsAuxModel=null):(this.rowIndex=new n,this.rowsAuxModel=null),this.dataModel=[]},_clear:function(){this.watchDog=0,this.colsAuxModel=null,this.rowsAuxModel=null,this.rowIndex=new n,this.colIndex=new n,this.dataModel=[]},_checkAvailability:function(){var e=this._readHeader(1),t=this._readHeader(0),s=!1;if(e.range?this.trigger("data:rows",e.range):(s=this._toParameters(),s.offset[1]=e.missingIndex),t.range?this.trigger("data:columns",t.range):(s=s||this._toParameters(),s.offset[0]=t.missingIndex),s){if(e.loaded){for(;s.offset[1]>=e.loaded;)s.offset[1]-=s.pageSize[1];s.offset[1]=Math.max(s.offset[1],0)}if(t.loaded){for(;s.offset[0]>=t.loaded;)s.offset[0]-=s.pageSize[0];s.offset[0]=Math.max(s.offset[0],0)}}else{var o=this._readData(e,t);o.data?(this.watchDog=0,this.trigger("data:data",{data:o.data,columns:t,rows:e}),this.trigger("data:loading",!1)):s=this._toParameters(o)}s&&(this.watchDog++,this.adHocModel.dataSet.set("params",s),this.trigger("data:loading",!0),this.adHocModel.dataSet.data().fail(this._onError).done(this._onSuccess))},_toParameters:function(e){var t,s,o={offset:[this.get("colsOffset"),this.get("rowsOffset")],pageSize:[Math.max(this.get("colsPageSize"),100),Math.max(this.get("rowsPageSize"),100)]};return e&&(t=e.bottom-e.top+1,s=e.right-e.left+1,t!==this.get("rowsPageSize")&&s===this.get("colsPageSize")?0===e.top?o.offset[1]=Math.max(0,this.get("rowsOffset")-o.pageSize[1]+t):e.bottom+1===this.get("rowsPageSize")?o.offset[1]=this.get("rowsOffset")+this.get("rowsPageSize")-t:(o.offset[1]+=e.top,o.pageSize[1]=t):t===this.get("rowsPageSize")&&s!==this.get("colsPageSize")?0===e.left?o.offset[0]=Math.max(0,this.get("colsOffset")-o.pageSize[1]+s):e.right+1===this.get("colsPageSize")?o.offset[0]=this.get("colsOffset")+this.get("colsPageSize")-s:(o.offset[0]+=e.left,o.pageSize[0]=s):t!==this.get("rowsPageSize")&&s!==this.get("colsPageSize")&&(o.offset[0]+=e.left,o.pageSize[0]=s,o.offset[1]+=e.top,o.pageSize[1]=t)),o},_readHeader:function(e){var t=e?this.rowsAuxModel:this.colsAuxModel,s=e?this.get("rowsOffset"):this.get("colsOffset"),o=e?this.get("rowsPageSize"):this.get("colsPageSize"),i=new r(s,s+o);return t&&t.visit(i),i.getResult()},_readData:function(e,t){var s={top:-1,bottom:-1,left:-1,right:-1};if(e.range.length&&t.range.length){for(var o,i,a,r=[],n=e.range,h=e.range[0].length-1,d=t.range,l=t.range[0].length-1,g=0;g<e.range.length;g++)if(o=[],a=this.dataModel[n[g][h].index]){for(var f=0;f<t.range.length;f++)i=d[f][l].index,a[i]?o.push(a[i]):(s.left=s.left<0?f:Math.min(s.left,f),s.right=Math.max(s.right,f),s.top=s.top<0?g:Math.min(s.top,g),s.bottom=Math.max(s.bottom,g));r.push(o)}else s.left=0,s.right=d.length,s.top=s.top<0?g:Math.min(s.top,g),s.bottom=Math.max(s.bottom,g);-1==s.top&&-1==s.bottom&&-1==s.left&&-1==s.right&&(s.data=r)}else s.data=[];return s},_writeData:function(){var e,t,s,o,i,a,r=this.adHocModel.dataSet.get("dataset").data,n=this.adHocModel.dataSet.get("params");this.colsAuxModel.visit(this.colIndex.range(n.offset[0],n.offset[0]+n.pageSize[0])),this.rowsAuxModel.visit(this.rowIndex.range(n.offset[1],n.offset[1]+n.pageSize[1])),e=this.rowIndex.getResult(),t=this.colIndex.getResult();for(var h=0;h<e.length;h++){s=e[h];for(var d=0;d<t.length;d++)o=t[d],i=this.dataModel[s],i?i=i[o]:this.dataModel[s]=[],i||(a=r[d][h],this.dataModel[s][o]=""===a?this.EMPTY_CELL:{label:a})}},_onExpansionsChange:function(e,t){var s="rows"===t.id?this.rowsAuxModel:this.colsAuxModel;s&&(s.applyExpansions(e,t),this._ignoreExpansionsChange||this._checkAvailability())},_onSuccess:function(){var e,t,s,o=this.adHocModel.dataSet.query.groupByJSON();try{if(e=a.buildFromDataSet(this.adHocModel.dataSet,this.adHocModel.dataSet.query.cols),this.colsAuxModel){if(!this.colsAuxModel.addTree(e.rootNode))throw new Error("Cannot merge cols")}else this.colsAuxModel=e.rootNode;s=e.requiredExpansions}catch(t){return d.error(t,this.colsAuxModel,e),void this._onError()}try{if(e=a.buildFromDataSet(this.adHocModel.dataSet,this.adHocModel.dataSet.query.rows),this.rowsAuxModel){if(!this.rowsAuxModel.addTree(e.rootNode))throw new Error("Cannot merge rows")}else this.rowsAuxModel=e.rootNode;t=e.requiredExpansions}catch(t){return d.error(t,this.rowsAuxModel,e),void this._onError()}if(this._writeData(),this.watchDog<7){if(s.length||t.length)try{this._ignoreExpansionsChange=!0,this.adHocModel.dataSet.query.cols.expansions.add(s),this.adHocModel.dataSet.query.rows.expansions.add(t),this._ignoreExpansionsChange=!1}catch(e){this._ignoreExpansionsChange=!1,d.error(e,this.rowsAuxModel,s,t),this._onError()}this._checkAvailability()}else d.error("Endless recursion",this.attributes,o),this._onError()},_onError:function(e){this.trigger("data:error",e),this.trigger("data:loading",!1)}});s.exports=l});