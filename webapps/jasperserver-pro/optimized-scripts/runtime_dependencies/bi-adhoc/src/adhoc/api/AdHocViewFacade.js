/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","bundle!AdHocBundle","backbone","./model/AdHocModel","./model/validators/Validation","./chart/ChartView","./table/TableView","./crosstab/CrosstabView","runtime_dependencies/js-sdk/src/components/overlay/Overlay","runtime_dependencies/js-sdk/src/components/message/Message","runtime_dependencies/js-sdk/src/components/message/enums/messageTypes","./visualChooser/VisualChooserDialog","text!./template/generalLayout.htm"],function(e,t,i){function s(e,t){return t&&a.each(t,function(t,i){e=e.replace("{"+i+"}",t)}),e}function o(e){var t;return e||(e=this.options.canvas&&this.options.canvas.type),t=e?T[e.toLowerCase()]||c:this.model.component.components.reduce(function(e,t){return e||t.componentType&&T[t.componentType]},!1),new t({dataModel:this.model,options:this.options})}var n=e("jquery"),a=e("underscore"),r=e("bundle!AdHocBundle"),l=e("backbone"),h=e("./model/AdHocModel"),d=e("./model/validators/Validation"),c=e("./chart/ChartView"),u=e("./table/TableView"),p=e("./crosstab/CrosstabView"),m=e("runtime_dependencies/js-sdk/src/components/overlay/Overlay"),v=e("runtime_dependencies/js-sdk/src/components/message/Message"),g=e("runtime_dependencies/js-sdk/src/components/message/enums/messageTypes"),y=e("./visualChooser/VisualChooserDialog"),_=e("text!./template/generalLayout.htm"),T={table:u,chart:c,crosstab:p},f=l.View.extend({el:function(){return n(_)[0]},events:{"click .jr-jAdhocLauncher":"_onVisualizationSwitcherClick","mouseenter .jr-jAdhocLauncherButton":"_onMouseEnterVisualizationButton","mouseleave .jr-jAdhocLauncherButton":"_onMouseLeaveVisualizationButton"},initialize:function(e,t){a.bindAll(this,"resize"),this.instanceData=e,this.options=e.properties,this.stateModel=t.stateModel,this.container=this.options.container,this.$container=n(this.container),this.dataComponents={},this.$container.empty(),this.$el.height(this.$container.height()?"100%":400),this.$el.children(".jr-jAdhocVizualization").height(this.$container.height()?"100%":400),this.$container[0]&&this.$container.append(this.el),this.model=new h({uri:this.options.resource},{server:this.options.server}),this._initalizeMainOverlay(),this._initializeMessage(),this.optionsValidators=d(this.model),this.$canvas=this.$(".jr-jAdhocVisualizationContainer"),this.$title=this.$(".jr-jAdhocVisualizationTitle"),this.$titleText=this.$(".jr-jAdhocVisualizationTitleText"),this.$visualizationLauncher=this.$(".jr-jAdhocLauncher"),this.$visualizationLauncherIcon=this.$(".jr-jAdhocLauncherIcon"),this.$el.css({position:"relative"}),this.listenTo(this.model.dataSet,"change:dataset",this._updateDisabledVisualizationTypes,this),this.listenTo(this.model.dataSet,"error:dataset",this._showError,this),this.listenTo(this.model,"data:available",function(e,t){this.dataComponents[e]=t,this.instanceData.data=a.extend(this.instanceData.data,t.toDataComponent())},this),this.listenTo(this.model,"component:error",this._showError,this)},visualChooserDialog:function(){return this._visualChooserDialog||(this._visualChooserDialog=new y,this._visualChooserDialog.on("visualizationTypeChange",this._onVisalizationTypeChange,this)),this._visualChooserDialog},_initalizeMainOverlay:function(){this.loadingOverlay=new m({el:this.$(".jr-jOverlay")}),this.listenTo(this.stateModel,"change:loadingOverlay",function(){this.stateModel.get("loadingOverlay")?this.loadingOverlay.show():this.loadingOverlay.hide()},this),this.listenTo(this.model,"component:busy",function(e){e?this.loadingOverlay.show(200):this.loadingOverlay.hide()}),this.stateModel.trigger("change:loadingOverlay")},_initializeMessage:function(){this.message=new v({title:null,text:null,type:g.Type.Error,visible:!1}),this.$(".jr-jAdhocMessage").append(this.message.el)},_onMouseEnterVisualizationButton:function(e){this.$(e.currentTarget).addClass("jr-isHovered")},_onMouseLeaveVisualizationButton:function(e){this.$(e.currentTarget).removeClass("jr-isHovered")},_initComponentListeners:function(){var e=this.model.component;this.listenTo(e,"change:showTitle",this._updateTitleVisibility,this),this.listenTo(e,"change:title",this._updateTitleText,this),this.listenTo(e,"change:visualizationType",this._onVisualizationTypeChanged,this)},_onVisualizationSwitcherClick:function(){this.visualChooserDialog().open()},_onVisalizationTypeChange:function(e){this.stateModel.set({loadingOverlay:!0}),this._hideError(),this._manageComponentType(e.type),this.options.canvas={type:e.type},this.component.render(this.$canvas).always(a.bind(this.stateModel.set,this.stateModel,{loadingOverlay:!1}))},_updateTitleVisibility:function(){this.model.component.get("showTitle")?(this.$title.removeClass("jr-isHidden"),this.$visualizationLauncher.removeClass("jr-isMinimized"),this.$visualizationLauncherIcon.removeClass("jr-meatball"),this.$visualizationLauncherIcon.addClass("jr-chartColumn")):(this.$title.addClass("jr-isHidden"),this.$visualizationLauncher.addClass("jr-isMinimized"),this.$visualizationLauncherIcon.addClass("jr-meatball"),this.$visualizationLauncherIcon.removeClass("jr-chartColumn")),this._updateCanvasHeight()},_updateTitleText:function(){this.$titleText.text(this.model.component.has("title")?this.model.component.get("title"):""),this._updateCanvasHeight()},_updateCanvasHeight:function(){var e=(this.$container.height()||400)-parseFloat(this.$canvas.css("marginBottom"));this.model.component&&this.model.component.get("showTitle")&&(e-=this.$title.height()+parseFloat(this.$title.css("marginTop"))+parseFloat(this.$title.css("marginBottom"))),this.$canvas.height(e)},_applyProperties:function(){this.visualChooserDialog().setSelectedType(this.model.component.get("visualizationType")),this._updateDisabledVisualizationTypes(),this.options.hasOwnProperty("showTitle")&&this.model.component.set("showTitle",this.options.showTitle)},_onVisualizationTypeChanged:function(){this.visualChooserDialog().setSelectedType(this.model.component.get("visualizationType"))},_updateDisabledVisualizationTypes:function(){var e=this.model.dataSet.query.getDisabledTypesList();this.visualChooserDialog().setDisabledTypes(e)},_showError:function(e){var t=e&&e.errorCode&&r["adhoc.error."+e.errorCode]?s(r["adhoc.error."+e.errorCode],e.parameters):r["adhoc.error.unexpected.error"];this.$(".jr-jAdhocVizualization").addClass("jr-isHidden"),this.$visualizationLauncher.addClass("jr-isHidden"),this.message.model.set({text:t,visible:!0}),this.stateModel.set({loadingOverlay:!1})},_hideError:function(){this.$(".jr-jAdhocVizualization").removeClass("jr-isHidden"),this.$visualizationLauncher.removeClass("jr-isHidden"),this.message.model.set({visible:!1})},_fetchModels:function(e,t){var i=this,s=n.Deferred(),o=a.bind(s.resolve,s),r=a.bind(s.reject,s);return t.metadata().fail(function(e){i._showError(e),r.apply(this,arguments)}).done(function(){var s=i.optionsValidators.validate(e);s?(i.component||i._showError(s),r(s)):(e.params&&t.dataSet.query.parameters.set(e.params),o())}),s.promise()},_manageComponentType:function(e){var t;this.component?this.component.isAcceptable(e)?this.model.component.set({visualizationType:e}):(t=o.call(this,e),this.component.remove(),this.component=t,this.model.component.set({visualizationType:e})):(this.component=o.call(this),this.model.component.set({visualizationType:e}))},_checkAutoresize:function(){var e=this.stateModel.get("autoresize")?"on":"off";n(window)[e]("resize",this.resize)},run:function(e){var t=this,i=e||new n.Deferred;return i.fail(function(){t.stateModel.set("loadingOverlay",!1)}),this.stateModel.set("loadingOverlay",!0),this._hideError(),this._checkAutoresize(),this._fetchModels(this.options,this.model).done(function(){t.render().done(function(){i.resolve({metadata:t.instanceData.data.metadata,_dataset_internal_:t.model.dataSet.toDataComponent()._dataset_internal_})}).fail(a.bind(i.reject,i))}).fail(a.bind(i.reject,i)),i.promise()},render:function(e){var t=this;return e||(e=new n.Deferred),this._initComponentListeners(),this._updateTitleText(),this._updateTitleVisibility(),this.model.metadata().done(function(){t.options.container?(t.model.bundles.bundle().fail(a.bind(e.reject,e)),t.options.canvas&&t.options.canvas.type&&t._manageComponentType(t.options.canvas.type),t.component||(t.component=o.call(t)),t.component.render(t.$canvas).done(a.bind(e.resolve,e)).fail(a.bind(e.reject,e)),t._applyProperties()):(t.component&&(t.component.remove(),delete t.component),t.model.dataSet.data().done(a.bind(e.resolve,e)).fail(a.bind(e.reject,e)))}),e.promise()},destroy:function(e){this.remove(),this.model.dataSet.isNew()?e.resolve():this.model.dataSet.destroy({success:a.bind(e.resolve,e),error:a.bind(e.reject,e)})},refresh:function(e){var t=e||new n.Deferred;return this.component&&!this.component.options.params?(this._hideError(),this.component.refresh(t)):this.run(t),t.promise()},resize:function(){this._updateCanvasHeight(),this.component&&this.component.resize()},remove:function(){return this.loadingOverlay.remove(),this.component||this.component.remove(),l.View.prototype.remove.apply(this,arguments)}});i.exports=f});