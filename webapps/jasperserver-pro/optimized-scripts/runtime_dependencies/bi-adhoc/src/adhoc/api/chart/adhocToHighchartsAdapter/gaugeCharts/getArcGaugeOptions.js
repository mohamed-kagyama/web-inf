/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","./utilities","./getUserSettings","../palette/defaultPalette","runtime_dependencies/js-sdk/src/common/util/fontUtils","runtime_dependencies/js-sdk/src/common/util/browserDetection"],function(e,t,a){function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(a,!0).forEach(function(t){n(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(a).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var o=e("underscore"),s=e("./utilities"),l=e("./getUserSettings"),c=e("../palette/defaultPalette"),u=e("runtime_dependencies/js-sdk/src/common/util/fontUtils"),h=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),f=function(e){var t=e.chartAreaSize,a=e.containerWidth,r=e.containerHeight,i=Math.min(a,r),n=.9*t.byHorizontal,o=t.byVertical/7*2,s=o/2+n/4,l=i/2-n/2,c=100*n/i;return{arcDiameter:n,heightAvailableForFields:o,verticalCenterOffset:s,fieldVerticalOffset:l,outerRadius:c,innerRadius:.7*c}},d=function(e){var t=e.sizes,a=e.chartsData,r=e.extraOptions,i=e.chartUserSettings,n=Math.floor(t.arcDiameter),l=Math.floor(t.arcDiameter*(.7-.3)),c=Math.floor(.3*t.arcDiameter),f=Math.floor(t.arcDiameter*(.7-.2)),d=Math.floor(.15*t.arcDiameter),m=[],g=[];o.each(a,function(e){var t="";o.each(e.fieldsName,function(e){e.length>t.length&&(t=e)}),g.push(e.fieldsName.length),m.push({field:t,value:e.valueAsString+i.valueSuffix,measure:e.measureName})});var p=Math.max.apply(Math,g),S=Math.floor(t.heightAvailableForFields/p),v=s.calculateFontData({texts:m,extraOptions:r,autoScaleStrategy:"minimalFontForAll",fonts:{fieldFontSize:14,valueFontSize:16,measureFontSize:14,minimalFontSize:2},constrains:{field:{width:n,height:S},value:{width:l,height:c},measure:{width:f,height:d}}});return o.each(a,function(e,t){var a=v[t],r=m[t],i=r.value,n=r.measure,s=u.getFontBaseline(a.value.fontSize);(h.isFirefox()||h.isIE11()||h.isEdge())&&(s=12);var l=[{text:i,fontSize:a.value.fontSize,sizeUnits:"px",fontWeight:"bold",lineHeight:"normal",y:s}];e.measureName&&l.push({text:n,fontSize:a.measure.fontSize,sizeUnits:"px",fontWeight:"normal",lineHeight:"normal",y:u.getFontHeight(a.measure.fontSize)});var c=0;o.each(l,function(e){c+=e.y}),c=Math.round(c);var f=u.getSVGTextRect(l);a.measureAndValueYOffset=-1*(c-f.height)}),v},m=function(e){var t=e.sizes,a=e.chartsData,r=e.fontData,n=e.chartPositions,l=e.extraOptions,h=e.chartUserSettings,f=this.getGeneralOptions(l),d=l.chartState.seriesColors||[],m=i({},f,{chart:i({},f.chart,{margin:[0,0,0,0],spacing:[0,0,0,0]}),plotOptions:{solidgauge:{stickyTracking:!1}},tooltip:{enabled:!1},pane:[],xAxis:[],yAxis:[],series:[],resizeThreshold:20});return o.each(a,function(e,a){var i=n[a].xCenterInPercent,o=n[a].yCenterInPercent,l=r[a];m.pane.push({size:"100%",startAngle:-90,endAngle:90,background:{backgroundColor:"#eeeeee",borderWidth:0,shape:"arc",innerRadius:t.innerRadius+"%",outerRadius:t.outerRadius+"%"},center:[i+"%",o+"%"]}),m.xAxis.push({pane:a});var f=t.fieldVerticalOffset+u.getFontBaseline(l.field.fontSize);f-=u.getFontHeight(l.field.fontSize)*e.fieldsName.length,f=Math.round(f),m.yAxis.push({min:h.minValue,max:h.maxValue,stops:h.colorStops,lineWidth:0,minorTickInterval:0,tickPositions:[h.minValue,h.maxValue],tickLength:0,tickWidth:0,labels:{enabled:!1},pane:a,title:{useHTML:!1,align:"high",textAlign:"center",y:f,text:e.fieldsName.join("<br>"),style:{color:l.field.color,"text-align":"center","font-size":l.field.fontSize+"px"}}});var g=s.getColorFromArray(a,c.colors),p=d[a]||g,S='<span style="font-size:'.concat(l.value.fontSize,"px;color:'").concat(l.value.color,"'\">").concat(e.valueAsString).concat(h.valueSuffix,"</span>");e.measureName&&(S+='\n                <br/>\n                <span style="font-weight:normal;font-size:'.concat(l.measure.fontSize,"px;color:'").concat(l.measure.color,"'\">").concat(e.measureName,"</span>\n            ")),S=S.trim().replace(new RegExp(">[\\s]+<","g"),"><"),m.series.push({yAxis:a,xAxis:a,color:p,innerRadius:t.innerRadius+"%",radius:t.outerRadius+"%",name:e.measureName,data:[e.value],columnsOutputParams:e.outputParameters,dataLabels:{useHTML:!1,allowOverlap:!0,overflow:"allow",verticalAlign:"bottom",style:{fontSize:l.value.fontSize,"text-anchor":"middle"},align:"left",x:0,y:l.measureAndValueYOffset,padding:0,borderWidth:0,formatter:function(){return S}}})}),m},g=function(e,t,a,r,i){var n=i.width,c=i.height,u=l(i),h=s.collectDataForCharts.call(this,e,t,r,i,u);!1===i.chartState.showSingleMeasuresLabels&&1===i.metadata.measures.length&&o.each(h,function(e){e.measureName=""});var g=h.length,p=s.getChartAreaSize({aspectRation:10/7,amountOfCharts:g,containerWidth:n,containerHeight:c,chartUserSettings:u}),S=f({chartAreaSize:p,containerWidth:n,containerHeight:c}),v=d({sizes:S,chartsData:h,extraOptions:i,chartUserSettings:u}),x=s.getGaugeChartPositions({sizes:S,amountOfCharts:g,chartAreaSize:p,containerWidth:n,containerHeight:c,chartUserSettings:u});return m.call(this,{sizes:S,chartsData:h,fontData:v,chartPositions:x,extraOptions:i,chartUserSettings:u})};a.exports=g});