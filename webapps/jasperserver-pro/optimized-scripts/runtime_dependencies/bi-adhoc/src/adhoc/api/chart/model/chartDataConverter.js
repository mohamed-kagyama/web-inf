/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/js-sdk/src/jrs.configs","momentExtension","../../model/factory/formattersFactory","bundle!AdHocBundle"],function(e,t,a){var r=e("underscore"),n=e("jquery"),o=e("runtime_dependencies/js-sdk/src/jrs.configs"),l=e("momentExtension"),s=e("../../model/factory/formattersFactory"),i=e("bundle!AdHocBundle");a.exports=function(e,t,a,c){function u(e){return!e||"-"!==e[e.length-5]&&"+"!==e[e.length-5]?e:e.slice(0,e.length-2).concat(":",e.slice(-2))}function d(e,t,a,n){return r.map(t.children,function(t){var r=f(e,n,a-1,t),o=v(e,n,a-1,t);return r!==o&&c.saveInitialValue(r,o),{label:r,rawLabel:o,level:a,type:m(e,n,a-1),axisCoordinate:p(t),children:d(e,t,a+1,n),isAll:t.all}})}function m(e,t,a){var r=e[t].levels[a];if(r&&r.hasOwnProperty("level"))return r.level.type}function p(e){return e.hasOwnProperty("dataIdx")?e.dataIdx:-1}function f(e,t,r,n){if(!n.hasOwnProperty("memberIdx"))return i["adhoc.node.total.node"];var o=e[t].levels[r];return o.hasOwnProperty("level")?g(o.level.referenceObject.name,o.level.type,o.level.members[n.memberIdx]):o.hasOwnProperty("aggregation")?a.component.getMeasureLabelByReference(o.aggregation.fields[n.memberIdx].reference):""}function v(e,t,r,n){if(!n.hasOwnProperty("memberIdx"))return i["adhoc.node.total.node"];var o=e[t].levels[r];return o.hasOwnProperty("level")?o.level.members[n.memberIdx]:o.hasOwnProperty("aggregation")?a.component.getMeasureLabelByReference(o.aggregation.fields[n.memberIdx].reference):""}function g(e,t,a){var n=r.find(b,function(t){return t.get("reference")===e}),o=n.level(),l={format:n.get("format"),categorizer:o&&o.get("categorizer"),ignoreTimezone:!0};return"other_node"===a&&(a=i["adhoc.node.other.node"]),s(t).format(a,l.format,l)}function h(e){return{label:e.label(!0),dimension:e.get("dimension"),name:e.get("id")||e.get("dimension")}}function y(e,t){var a=function(e){return t===e.get("id")};return e.dataSet.query.cols.axis.find(a)||e.dataSet.query.rows.axis.find(a)}var x=a.component.getChartComponent(),S=x.components.findComponentDeep("level"),w=x.components.findComponentDeep("measure"),b=S.concat(w),L=r.extend(x.getProperties(),{chartType:x.getLegacyAdhocChartType(),columnsSelectedLevels:[],rowsSelectedLevels:[],decimalPoint:".",shortMonths:function(){return r.map(["01","02","03","04","05","06","07","08","09","10","11","12"],function(e){return r.capitalize(l("1970-".concat(e,"-01")).locale(o.userLocale).format("MMMM")).slice(0,3)})}(),showXAxisLabels:!0,showYAxisLabels:!0,thousandSeparator:"None"});t.dataset.data=function(e){return r.map(e,function(e){return r.map(e,function(e){return n.isNumeric(e)?parseFloat(e):null})})}(t.dataset.data),delete L.type,delete L.title;var q={title:e.label,chartState:L,queryData:{metadata:{axes:[],measureAxis:0,measures:[],canRender:!0,isFullDataQuery:!1,isOLAP:!1},treeNodes:[],data:r.zip.apply(null,t.dataset.data)},viewType:"ichart"};if(function(e,t){var a=t.components.findComponentDeep("axis").reverse(),n=t.components.findComponentDeep("measures");r.each(a,function(t,a){var r=t.components.map(function(t){var r;return"Measures"===t.get("reference")?(e.queryData.metadata.measureAxis=a,r=i["adhoc.node.measures.node"]):r=t.label(!0),{label:r,dimension:t.get("dimension"),name:t.get("reference")}});e.queryData.metadata.axes.push(r)}),r.each(n,function(t){e.queryData.metadata.measures=t.components.map(function(e){return e.label(!0)})})}(q,x),function(e,t){for(var a=t.dataset.axes.reverse(),r=0;r<a.length;r++)e.queryData.treeNodes.push({label:i["adhoc.node.total.node"],level:0,axisCoordinate:p(a[r].axisNode),children:d(a,a[r].axisNode,1,r),isAll:a[r].axisNode.all})}(q,t),function(e,t,a){var n;t.groupBy.columns.hasOwnProperty("expansions")&&r.each(t.groupBy.columns.expansions,function(t){t.level&&t.level.expanded&&!t.level.aggregation&&(n=y(a,t.level.fieldRef),e.chartState.columnsSelectedLevels=[h(n)])}),"dual_measure_tree_map"===e.chartState.chartType?(n=a.dataSet.query.rows.axis.first(),e.chartState.rowsSelectedLevels=[h(n)]):"dual_level_pie"===e.chartState.chartType?(r.each(t.groupBy.rows.expansions,function(r,o){if(r.level&&r.level.expanded&&!r.level.aggregation){var l=t.groupBy.rows.expansions[o+1];l&&l.level&&!l.level.aggregation&&(n=y(a,l.level.fieldRef),e.chartState.rowsSelectedLevels=[h(n)])}}),e.chartState.rowsSelectedLevels.length||(n=a.dataSet.query.rows.axis.find(function(e){return e.isLevel()}),e.chartState.rowsSelectedLevels=[h(n)])):t.groupBy.rows.hasOwnProperty("expansions")&&r.each(t.groupBy.rows.expansions,function(t){t.level&&t.level.expanded&&!t.level.aggregation&&(n=y(a,t.level.fieldRef),e.chartState.rowsSelectedLevels=[h(n)])})}(q,e.query.multiAxis,a),x.isTimeSeries()){if(q.chartState.timeSeriesCategorizerName=e.query.multiAxis.groupBy.rows.items[0].level.categorizer,!q.chartState.rowsSelectedLevels.length){var D=y(a,e.query.multiAxis.groupBy.rows.expansions[0].level.fieldRef);q.chartState.rowsSelectedLevels.push({label:D.label(!0),dimension:D.get("dimension"),name:D.get("id")})}var A,N;q.queryData.data=r.map(q.queryData.data,function(e,t){return r.map(e,function(e){var a,n,s,i=q.queryData.treeNodes[0].children[t];return i&&i.rawLabel&&(a=u(i.rawLabel),n=null,r.contains(["hour","minute","second","millisecond"],q.chartState.timeSeriesCategorizerName)?n="1970-01-01T"+a:r.contains(["day"],q.chartState.timeSeriesCategorizerName)&&(n=a+"T00:00:00.000"),null!==n&&(A=l(n,"YYYY-MM-DDTHH:mm:ss.SSS"),A.isValid()&&(N=A.tz(o.userTimezone).format("Z"),a=n+N)),s=new Date(a).getTime(),!isNaN(s))?(c.saveInitialValue(s,i.rawLabel),{timestamp:s,value:parseFloat(e)}):{timestamp:null,value:null}})})}return q}});