/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","backbone","underscore","bundle!AdHocBundle","text!../template/crosstabHeaderTemplate.htm"],function(e,n,t){function a(e){var n=e.dataSet.query.groupByJSON(),t=[],a=e.component.getCrosstabComponent(),i=a.getColumnsComponent(),d=a.getRowsComponent(),s=a.getMeasuresComponent();return t.push(l(n.columns,[0],i,s)),t.push(l(n.rows,[1],d,s)),o(t,e),t}function l(e,n,t,a){for(var l,o,s,r,p=[],u=0;u<e.items.length;u++)l=e.items[u].level,s={isExpandable:i(e.items,u)},l?(r=l.id||l.field,o=t.findWhere({reference:r})||a.findWhere({reference:r}),s.name=r,s.label=o.label(),s.fieldRef=l.field):(s.label=c["adhoc.node.measures.node"],s.isMeasure=!0),s.isExpandable&&(s.expId=s.collapseId=n.concat([u]),s.isExpanded=d(e.expansions,l)),p.push(s);return p}function i(e,n){return e[n+1]&&!(e[n].level&&e[n+1].aggregations)}function d(e,n){if(e)for(var t=0,a=e.length;t<a;t++)if(e[t].level&&(!n&&u.isUndefined(e[t].level.fieldRef)||n&&e[t].level.fieldRef===n.id))return e[t].level.expanded;return!1}function o(e,n){for(var t={includeAll:!1},a=n.component.getColumnsComponent().where(t),l=n.component.getRowsComponent().where(t),i=u.reduce([].concat(a).concat(l),function(e,n){return e[n.get("dimension")]=!0,e},{}),d=0;d<e.length;d++){for(var o=e[d].length-1;o>0;o--)e[d][o].isExpandable=!i[e[d][o].name]&&e[d][o-1].isExpandable,e[d][o].isExpanded=e[d][o-1].isExpanded,e[d][o].expId=e[d][o-1].expId,e[d][o].collapseId=e[d][o-1].collapseId;e[d].length&&(e[d][0].isExpandable=!1,e[d][0].expId=void 0,e[d][0].collapseId=void 0)}for(var d=0;d<e.length;d++)for(var o=0;o<e[d].length;o++)if(e[d][o].isExpandable){for(var s=o+1,r=e[d][e[d].length-1].isMeasure?e[d].length-1:e[d].length;s<r&&(e[d][s].isMeasure||i[e[d][s].name]);)s++;e[d][s-1].expId&&(e[d][o].expId=e[d][s-1].expId,e[d][o].isExpanded=e[d][s-1].isExpanded)}}function s(e,n){var t=e[0],a=e[1],l=u.reduce(t,function(e,t){return e.push([r(n,t,a.length)]),e},[]);return l.push(u.reduce(a,function(e,t){return e.push(r(n,t)),e},[])),l}function r(e,n,t){var a={label:n.label,isExpanded:n.isExpandable&&n.isExpanded,isCollapsed:n.isExpandable&&!n.isExpanded,isMeasure:n.isMeasure};return n.isExpandable&&(a.expId=n.expId.join("-")),n.isExpandable&&(a.colId=n.collapseId.join("-")),t&&(a.colspan=t),a}var p=e("backbone"),u=e("underscore"),c=e("bundle!AdHocBundle"),x=e("text!../template/crosstabHeaderTemplate.htm"),f=u.template(x),h=p.View.extend({events:{"click .jr-isExpanded":"onExpandClick","click .jr-isCollapsed":"onCollapseClick"},render:function(){return this.auxModel=a(this.model),this.$("table").html(f({data:s(this.auxModel,this.model)})),this},onCollapseClick:function(e){this._expand(e.target.getAttribute("data-expansion-id").split("-"),!0)},onExpandClick:function(e){this._expand(e.target.getAttribute("data-expansion-id").split("-"),!1)},_expand:function(e,n){for(var t=this.auxModel,a={level:{}},l=0;l<e.length;l++)t=t[e[l]];a.level.expanded=n,a.level.fieldRef=t.name,a.level.aggregation=!t.fieldRef,this.trigger(+e[0]?"expansion:row":"expansion:column",a),this.trigger("expansion",a)}});t.exports=h});