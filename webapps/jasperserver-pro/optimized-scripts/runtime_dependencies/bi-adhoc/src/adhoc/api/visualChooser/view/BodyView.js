/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","../VisualizationTypesController","text!../template/bodyTemplate.htm","bundle!AdHocBundle","text!../template/chartSelectorRules.htm","../enum/messageMapping"],function(e,s,t){var i=e("jquery"),a=e("underscore"),r=e("backbone"),l=e("../VisualizationTypesController"),n=e("text!../template/bodyTemplate.htm"),o=e("bundle!AdHocBundle"),h=e("text!../template/chartSelectorRules.htm"),d=e("../enum/messageMapping");t.exports=r.View.extend({className:"jr-mVisualchooser-body jr",template:a.template(n),events:{"click li.jr-mVisualchooser-menu-item":"_onClickItem","mouseover .jr-mVisualchooser-menu-item-wrapper":"_hoverOnItem","mouseleave .jr-mVisualchooser-menu-item-wrapper":"_leaveOnItem"},constructor:function(e){this.options=a.defaults(e||{},this.defaults),this.typesManager=this.options.typesManager,this.typesManager||(this.typesManager=new l),r.View.apply(this,arguments)},initialize:function(){this.i18n=o,this.isDesignView=window.isDesignView,this._selectedType=null,this.disabledTypes=[],this.showDisabledIcons=!0,this.on("change:groupSelected",a.bind(this._onTabChange,this))},render:function(){var e;return this.$el.html(this.template({types:this.typesManager.getAllTypes(),designView:this.isDesignView,i18n:this.i18n})),this.$typeElements=this.$("li.jr-mVisualchooser-menu-item"),e=this.getChartType(this.$typeElements),this.isDesignView&&e&&this.showMessages(e,!0),this},getChartType:function(e){var s=e.data("chartType");return this.typesManager.getTypeByName(s)},_onClickItem:function(e){var s=this.$(e.currentTarget),t=i(".jr-mVisualchooser-rule");if(!s.hasClass("jr-isDisabled")&&!s.hasClass("jr-isSelected")){var a=s.data("chartType"),r=this.getChartType(s);this.isDesignView&&(this.showMessages(r,!1),t.addClass("jr-isSelected"),t.removeClass("jr-isHovered")),this.setSelectedType(a),this.trigger("change:visualizationType",{type:a,legacyAdhocType:r.legacyAdhoc})}},_hoverOnItem:function(e){if(this.isDesignView){var s=this.$(e.currentTarget),t=s.hasClass("jr-isSelected")||s.parent().hasClass("jr-isSelected"),a=i(".jr-mVisualchooser-rule");a.removeClass("jr-isSelected"),t?a.addClass("jr-isSelected"):a.addClass("jr-isHovered");var r=this.getChartType(s.parent());this.showMessages(r,!1)}},_leaveOnItem:function(e){!this.$(e.currentTarget).hasClass("jr-isSelected")&&i(".jr-mVisualchooser-rule").removeClass("jr-isHovered")},setSelectedType:function(e){this._selectedType=e,this.$typeElements.filter(".jr-isSelected").removeClass("jr-isSelected"),this.$typeElements.filter(function(s,t){return i(t).data("chartType")===e}).addClass("jr-isSelected")},getSelectedType:function(){return this._selectedType},setDisabledTypes:function(e){this.disabledTypes=e,this._setDisabledTypes()},getScrollPosition:function(){return this.$el.find("ul").first().scrollTop()},setScrollPosition:function(e){this.$el.find("ul").first().scrollTop(e)},_setDisabledTypes:function(){var e=this;this.$typeElements&&this.$typeElements.each(function(){var s=i(this);e.showDisabledIcons&&a.contains(e.disabledTypes,s.data("chartType"))?s.addClass("jr-isDisabled"):s.removeClass("jr-isDisabled")})},setShowDisabledIcons:function(e){this.showDisabledIcons=e,this._setDisabledTypes()},_onTabChange:function(e){if("all"===e)this.$typeElements.removeClass("jr-isHidden");else{var s=a.pluck(this.typesManager.getAllTypesInGroup(e),"name");this.$typeElements.each(function(){var e=i(this);a.contains(s,e.data("chartType"))?e.removeClass("jr-isHidden"):e.addClass("jr-isHidden")})}},showMessages:function(e,s){var t,r,l,n,o,c,u,p,m=e.legacyAdhoc,y=d[m],f=y.cssClass,g=Object.keys(y);i(".jr-mVisualchooser-rule").find(".jr-mList-item").not(":first").remove();for(var j=this,C=0;C<g.length-1;C++){var T=y[g[C]];c="",t=T.first,r=T.second&&T.second.msg?T.second.msg:T.second,l=T.third,n=T.fourth&&T.fourth.msg?T.fourth.msg:T.fourth,o=T.fifth?T.fifth:"",p=!(!T.type||"twospan"!==T.type),c=a.template(h,{firstM:t,secondM:r,thirdM:l,fourthM:n,fifthM:o,twoSpanRule:p}),c=i(c),this.setFieldMeasureClass(T,c),s?j.$el.find(".jr-mList").append(c):i(".jr-mVisualchooser-rule").find(".jr-mList").append(c)}u=s?this.$el.find(".jr-mVisualchooser-rule-text-label"):i(".jr-mVisualchooser-rule-text-label"),this.addChartIconClass(u,f),this.addtextToRuleSpan(u[0],e)},addtextToRuleSpan:function(e,s){var t=e.nextSibling;t&&t.parentNode.removeChild(t),e.insertAdjacentText("afterend",o[s.bundleName])},addChartIconClass:function(e,s){var t=e.parents().find(".jr-mVisualchooser-rule #ruleIcon");t[0].className="",t[0].className="jr-mVisualchooser-rule-icon "+s+" jr"},setFieldMeasureClass:function(e,s){var t=s.find(".jr-uSemibold");e.second&&e.second["typeF/M"]&&("field"===e.second["typeF/M"]?t.first().addClass("jr-uColorField").removeClass("jr-uColorMeasure"):t.first().addClass("jr-uColorMeasure").removeClass("jr-uColorField"))}})});