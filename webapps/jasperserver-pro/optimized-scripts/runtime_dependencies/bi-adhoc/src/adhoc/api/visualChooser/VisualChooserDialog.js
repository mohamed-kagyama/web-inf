/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","runtime_dependencies/js-sdk/src/components/dialog/Dialog","./VisualChooserView","./VisualizationTypesController","bundle!AdHocBundle","runtime_dependencies/js-sdk/src/components/utils/Event","../visualChooser/view/TabView"],function(i,e,o){var s=i("jquery"),t=i("underscore"),n=i("backbone"),a=i("runtime_dependencies/js-sdk/src/components/dialog/Dialog"),l=i("./VisualChooserView"),r=i("./VisualizationTypesController"),h=i("bundle!AdHocBundle"),d=i("runtime_dependencies/js-sdk/src/components/utils/Event"),c=i("../visualChooser/view/TabView");o.exports=n.View.extend({events:{change:"triggerChangeValue"},initialize:function(i){this.isDesignView=window.isDesignView,this.options=t.defaults(i||{},this.defaults),this.typesManager=new r,this.options.typesToExclude&&this.typesManager.setTypesToExclude(this.options.typesToExclude),this.tabView=new c({}),this.visualChooserView=new l(t.extend({},{title:h["visualization.chooser.title"],okBtn:h["visualization.chooser.ok.button"],applyCancelBtn:h["visualization.chooser.applyAndClose.button"],closeBtn:h["visualization.chooser.cancel.button"],minimized:!1,typesManager:this.typesManager},this.options)),this.dialog=new a({el:this.visualChooserView.render().el,modal:!1}),this.listenTo(this.dialog,"dialog:close",this._onDialogCloseEvent),this.listenTo(this.dialog,"dialog:cancel",this._oncancelDialog);var e=this;this.dialog.$el.find(".jr-mButtonPrimary").on("click",function(){e._onClose("dialog:close")}),this.dialog.$el.find(".jr-mButtonSecondary").on("click",function(){e._onClose("dialog:cancel")}),this._isOpen=!1,this.resize(),this.visualChooserView.on("tabMinimizedEvent",this._onTabMinimizedEvent,this),this.visualChooserView.on("change:visualizationType",this._onVisualizationTypeChange,this)},render:function(){},resize:function(){var i=this,e=this.dialog.$el.find(".jr-mDialog-footer-sizer"),o=s(".jr-mVisualchooser"),t=s(".jr-mVisualchooser-body");e&&this.dialog.$el.resizable({handles:{se:this.dialog.$(".jr-mDialog-footer-sizer")},start:function(e,o){var t=s(e.target).find(".jr-mVisualchooser-panel.jr").outerWidth()+270+2;i.dialog.$el.resizable({minWidth:t})},resize:function(e,s){i.isDesignView&&(270===t.width()?o.addClass("jr-mVisualchooserNarrow"):o.removeClass("jr-mVisualchooserNarrow"))},stop:function(e,o){270===t.width()&&i.isDesignView&&s(".jr-mVisualchooser-rules.jr").first().addClass("jr-mVisualchooserNarrow")},minHeight:475})},open:function(i){this.tabView.setDialogMinWidth(this.dialog.$el),this.dialog.open(t.extend({topPoint:.5,leftPoint:.5},i)),this._isOpen=!0,this.trigger("open")},getDialogState:function(){return{viewState:this.visualChooserView.getState(),isDialogOpen:this._isOpen,dialogPosition:this.dialog.getPosition()}},applyDialogState:function(i){i.isDialogOpen&&this.open(),!i.dialogPosition||t.isUndefined(i.dialogPosition.top)||t.isUndefined(i.dialogPosition.left)||this.dialog.setPosition(i.dialogPosition),i.viewState&&this.visualChooserView.applyState(i.viewState)},close:function(){this.dialog.close(),this._isOpen=!1,this.trigger("close")},remove:function(){this.close(),this.stopListening(this.dialog),this.dialog.remove(),this.dialog=null,this.visualChooserView.remove(),this.visualChooserView=null},_onDialogCloseEvent:function(){this.trigger("close")},_oncancelDialog:function(){var i=this.prevChartType,e=this.typesManager.getTypeByName(i);i&&this.visualChooserView.trigger("change:visualizationType",{type:i,legacyAdhocType:e.legacyAdhoc}),this.trigger("close")},_onTabMinimizedEvent:function(i,e){var o=this.dialog.getPosition();o.left=i?o.left+e:o.left-e,o.left<0&&(o.left=0),this.dialog.setPosition(o)},_onVisualizationTypeChange:function(i){this.trigger("visualizationTypeChange",i)},setSelectedType:function(i){this.visualChooserView.setSelectedType(i)},getSelectedType:function(){return this.visualChooserView.getState()},setDisabledTypes:function(i){this.visualChooserView.setDisabledTypes(i)},_onClose:function(i){var e=new d({name:i});this.dialog.trigger(e.name,e),e.isDefaultPrevented()||this.dialog.close()}})});