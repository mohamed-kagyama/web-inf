/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","../BaseInputControlView","runtime_dependencies/js-sdk/src/components/sizer/Sizer","jquery","underscore","bundle!ScalableInputControlsBundle","runtime_dependencies/js-sdk/src/common/util/browserDetection","../../util/inputControlHelpers","text!../../template/checkboxInputItemTemplate.htm","text!../../template/multiSelectCheckboxTemplate.htm","runtime_dependencies/js-sdk/src/components/scalableList/util/domAndCssUtil"],function(e,t,i){var n=e("../BaseInputControlView"),s=e("runtime_dependencies/js-sdk/src/components/sizer/Sizer"),o=e("jquery"),c=e("underscore"),l=e("bundle!ScalableInputControlsBundle"),h=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),r=e("../../util/inputControlHelpers"),a=e("text!../../template/checkboxInputItemTemplate.htm"),d=e("text!../../template/multiSelectCheckboxTemplate.htm"),u=e("runtime_dependencies/js-sdk/src/components/scalableList/util/domAndCssUtil"),m=u.doCalcOnVisibleNodeClone,p=[{selector:".jr-jSelectAll",strings:[l["sic.multiselect.selectAll"],l["sic.multiselect.all"],""]},{selector:".jr-jSelectNone",strings:[l["sic.multiselect.deselectAll"],l["sic.multiselect.none"],""]},{selector:".jr-jInvert",strings:[l["sic.multiselect.inverse"],""]}];i.exports=n.extend({events:{"click .jr-jSelectAll":"onSelectAll","click .jr-jSelectNone":"onSelectNone","click .jr-jInvert":"onInvertSelection"},template:d,initialize:function(){this._debouncedOnResize=c.debounce(c.bind(this.onResize,this),500),n.prototype.initialize.call(this)},renderStructure:function(){var e=c.extend({selectAllMsg:l["sic.multiselect.selectAll"],selectNoneMsg:l["sic.multiselect.deselectAll"],selectInverseMsg:l["sic.multiselect.inverse"]},this._renderData());return this.setElement(o(c.template(this.template||"")(e))),this.$checkboxContainer=this.$el.find(".jr-mInput-set"),this.updateOptionsSelection(),this.once("attached",this._checkForRealAttachedToDOM,this),this},updateOptionsSelection:function(){var e=c.map(this.model.state.options.toJSON(),function(e){var t=c.clone(e);return t.readOnly=this.model.get("readOnly"),t.uuid="jr-label-id-"+c.uniqueId(this.model.get("id")),t},this),t=this.$checkboxContainer.find("ul")[0];r.setInnerHtml(t,function(e){return c.template(a)(e)},{data:e}),this._handleHeight()},_checkForRealAttachedToDOM:function(){this.$checkboxContainer.find("li").height()>0?(this.attached=!0,this.$checkboxContainer.height(this._calcHeightByItemsCount(5)),this._initSizer(),this.setBulkSelectionText()):c.delay(c.bind(this._checkForRealAttachedToDOM,this),500)},_initSizer:function(){this.sizer=new s({container:this.$checkboxContainer}),this.$el.append(this.sizer.$el),this._handleHeight()},_handleHeight:function(){var e=this.model.state.options.length,t=this.$checkboxContainer.height(),i=t;if(this.attached&&e){var n=this._calcHeightByItemsCount(3),s=this._calcHeightByItemsCount(e)+2;e<=5?n=s=i=this._calcHeightByItemsCount(Math.max(3,e)):t>s&&(i=this._calcHeightByItemsCount(e)),this.$checkboxContainer.height(i),this.sizer.updateMinMax({minHeight:n,maxHeight:s}),n===s?(this.sizer.hide(),this.$checkboxContainer.css("overflow-y","auto")):(this.sizer.show(),this.$checkboxContainer.css("overflow-y","scroll"))}},_calcHeightByItemsCount:function(e){return e*this.$checkboxContainer.find("li").outerHeight()+Math.round(parseFloat(this.$checkboxContainer.find("ul").css("margin-top"))||0)},getSelection:function(){var e=this.$el.find(":checkbox").filter(":checked");return c.map(e,function(e){return o(e).val()})},bindCustomEventListeners:function(){var e=this;this.model.get("readOnly")||this.$el.on("change","input",c.bind(function(t){var i=this.getSelection();setTimeout(function(){e.model.changeState(i)})},this)),this.model.state.options.on("reset",this.updateOptionsSelection,this),this.model.state.options.on("change:selected",this.updateOptionsSelection,this),o(window).on("resize",this._debouncedOnResize)},onSelectAll:function(){if(!this.model.get("readOnly")){var e=this.$checkboxContainer.find("input");c.each(e,function(e){e.checked=!0}),e.change()}},onSelectNone:function(){if(!this.model.get("readOnly")){var e=this.$checkboxContainer.find("input");c.each(e,function(e){e.checked=!1}),e.change()}},onInvertSelection:function(){if(!this.model.get("readOnly")){var e=this.$checkboxContainer.find("input");c.each(e,function(e){e.checked=!e.checked}),e.change()}},setBulkSelectionText:function(){if(this.$el.is(":visible")){var e=this.$el.outerWidth();if(e!==this._componentWidth){this._componentWidth=e;var t=this.$el.find(".jr-mInput-buttonContainer"),i=t.outerWidth();m({el:t,css:{left:0-2*i+"px",width:i+"px"},classes:"jr "+(h.isIPad()?"ipad":""),alwaysClone:!0,callback:function(e){c.each(p,function(i){var n=!1;c.each(i.strings,function(s){if(!n){var o=e.find(i.selector),c=o.find(".jr-mItemselector-button-label span").text(s);(o[0].getBoundingClientRect().right-c[0].getBoundingClientRect().right>=3||""===s)&&(n=!0,t.find(i.selector+" .jr-mItemselector-button-label span").text(s))}})})}})}}},onResize:function(){this.setBulkSelectionText()},remove:function(){this.$el.off("change","input"),this.$el.off("click","a"),this.multiSelect&&this.multiSelect.remove(),this.sizer&&this.sizer.remove(),this.model.state.options.off("reset",this.updateOptionsSelection,this),this.model.state.options.off("change:selected",this.updateOptionsSelection,this),n.prototype.remove.call(this)}})});