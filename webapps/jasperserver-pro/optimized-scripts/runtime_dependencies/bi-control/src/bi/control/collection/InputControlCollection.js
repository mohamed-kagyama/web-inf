/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../model/InputControlModel","runtime_dependencies/js-sdk/src/common/logging/logger"],function(t,e,n){var s=t("underscore"),r=t("backbone"),a=t("../model/InputControlModel"),i=t("runtime_dependencies/js-sdk/src/common/logging/logger"),o=i.register("InputControlCollection");n.exports=r.Collection.extend({model:a,_slaveICs:[],url:function(){var t=this.stateModel.get("resource"),e=this.stateModel.get("server");if(!t)throw new Error("Resource URI is not specified.");var n=e?"/"===e[e.length-1]?e:e+"/":"";return n+="rest_v2/reports",n+="/"===t[0]?t:"/"+t,n+="/"===t[t.length-1]?"inputControls":"/inputControls",n},initialize:function(t,e){e||(e={}),this.stateModel=e.stateModel,this.on("all",o.debug,o),this.on("changeState",this.onControlChange,this)},onControlChange:function(t){var e={params:{}};if(!t.get("slaveDependencies").length)this.callCustomerChangeCallback();else{var n=this._getAllSlaveControlIds(t.get("id"));this._slaveICs=n,this._disableSlaveICs();var r=this._getParentControlIds(n),a=s.union(n,r);this.each(function(t){s.contains(a,t.get("id"))&&t.changed&&(e.params[t.get("id")]=t.getData())}),n=s.union(n,t.get("id")),this.updateState(e,n)}},callCustomerChangeCallback:function(){var t=this.stateModel.get("events");!s.isUndefined(t)&&s.isFunction(t.change)&&t.change(this.getState(),this.validate())},_getAllSlaveControlIds:function(t){var e=[],n=this.get(t);return s.each(n.get("slaveDependencies"),function(t){e.push(t),e.push.apply(e,this._getAllSlaveControlIds(t))},this),s.uniq(e)},_getParentControlIds:function(t){var e=[];return s.each(t,function(t){var n=this.get(t);e.push.apply(e,n.get("masterDependencies"))},this),s.uniq(e)},parse:function(t){if(!t)return[];if(t.inputControl&&s.isArray(t.inputControl))return t.inputControl;throw new Error("Unable to parse response from server.")},fetch:function(t){return t||(t={}),s.extend(t,{url:this.url(),reset:!0}),t.excludeState&&(t.url+="?exclude=state"),r.Collection.prototype.fetch.call(this,t)},update:function(t){if(t||(t={}),s.isEmpty(t.params))throw new Error("Cannot update input controls without passed params");return s.extend(t,{type:"POST",contentType:"application/json",data:JSON.stringify(t.params),reset:!0}),r.Collection.prototype.fetch.call(this,t)},updateState:function(t,e){return t||(t={}),e=e||s.keys(t.params),t.url=this.url()+"/"+e.join(";")+"/values",s.extend(t,{type:"POST",contentType:"application/json",data:JSON.stringify(t.params),reset:!1,success:s.bind(this.parseUpdateState,this),error:s.bind(this._enableSlaveICs,this)}),r.sync.call(this,"read",this,t)},parseUpdateState:function(t){if(!t||!t.inputControlState||!s.isArray(t.inputControlState))throw new Error("Unable to parse response from server.");s.each(t.inputControlState,this._parseState,this),this._enableSlaveICs(),this.callCustomerChangeCallback()},getState:function(){var t={};return this.forEach(function(e){t[e.get("id")]=e.getData()}),t},validate:function(){var t={};return this.forEach(function(e){e.state.get("error")&&(t[e.get("id")]=e.state.get("error"))}),!!s.size(t)&&t},_disableSlaveICs:function(){this.trigger("disableICs",this._slaveICs)},_enableSlaveICs:function(){this.trigger("enableICs",this._slaveICs)},_parseState:function(t){var e=this.get(t.id);e&&e.set("state",t)}})});