/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","../BaseInputControlView","jquery","underscore","runtime_dependencies/js-sdk/src/components/dateAndTime/DateAndTimePicker","text!../../template/singleValueDatetimeTemplate.htm","settings!dateTimeSettings","runtime_dependencies/js-sdk/src/common/util/parse/date"],function(e,t,i){function n(e){return e.toUpperCase().replace(/([\s]+$|^[\s]+)/g,"").replace(/[\s]*(\+|\-)[\s]*/g,"$1")}var s=e("../BaseInputControlView"),a=e("jquery"),r=e("underscore"),o=e("runtime_dependencies/js-sdk/src/components/dateAndTime/DateAndTimePicker"),d=e("text!../../template/singleValueDatetimeTemplate.htm"),c=e("settings!dateTimeSettings"),m=e("runtime_dependencies/js-sdk/src/common/util/parse/date");i.exports=s.extend({template:d,initialize:function(){this.renderStructure(),this.renderState(),this.model.get("visible")&&(this.setupCalendar(),this.bindCustomEventListeners()),this.model.get("readOnly")&&this.disable(),this.updateWarningMessage()},setupCalendar:function(){var e=this,t=this.$el.find("input"),i=this.model.get("dataType"),s=i&&m.iso8601TimestampToDateObject(i.minValue)||null,d=i&&m.iso8601TimestampToDateObject(i.maxValue)||null;i&&i.strictMin&&s&&s.setSeconds(s.getSeconds()+1),i&&i.strictMax&&d&&d.setSeconds(d.getSeconds()-1),this.picker=new o({el:t,currentText:c.timepicker.currentText,dateFormat:c.datepicker.dateFormat,timeFormat:c.timepicker.timeFormat,disabled:t[0].disabled,onSelect:r.bind(this.updateState,this),minDateTime:s,maxDateTime:d,showOn:"button"}),this.$el.find(".ui-datepicker-trigger").hide(),t.change(r.bind(function(e){e.stopPropagation();var t=a(e.target),i=n(t.val());t.val(i),this.updateState(i)},this)),t.click(r.bind(function(e){e.stopPropagation(),this.picker.hide()},this)),t.select(r.bind(function(e){e.target.selectionEnd!==e.target.selectionStart&&(e.stopPropagation(),this.picker.hide())},this)),this.$el.find(".jr-mInput-datetrigger").on("click",function(){e.picker.show(),e.$el.find("input")[0].setSelectionRange(0,0)})},updateValue:function(e){var t=m.isoTimestampToLocalizedTimestamp(e);this.$el.find("input").val(t)},updateState:function(e){this.model.changeState(m.localizedTimestampToIsoTimestamp(e))},bindCustomEventListeners:function(){this.listenTo(this.model.state,"change:value",function(e,t){this.updateValue(t)},this),this.listenTo(this.model.state,"reset change",this.updateWarningMessage,this)},remove:function(){this.picker.remove(),s.prototype.remove.call(this)}})});