/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","runtime_dependencies/jrs-ui/src/controls/controls.base","jquery","runtime_dependencies/jrs-ui/src/controls/controls.base","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/core/core.ajax","../base/designer.base","../core/core.ajax.utils","runtime_dependencies/jrs-ui/src/namespace/namespace","runtime_dependencies/jrs-ui/src/reportViewer/report.view.base","runtime_dependencies/jrs-ui/src/reportViewer/report.view.base","runtime_dependencies/jrs-ui/src/controls/controls.controller"],function(e,t,o){var r=e("prototype"),n=r.$,s=e("runtime_dependencies/jrs-ui/src/controls/controls.base"),l=s.ControlsBase,i=e("jquery"),a=e("runtime_dependencies/jrs-ui/src/controls/controls.base"),c=a.ControlDialog,u=e("runtime_dependencies/jrs-ui/src/util/utils.common"),d=u.enableSelection,f=u.buildActionUrl,C=e("runtime_dependencies/jrs-ui/src/core/core.ajax"),p=C.AjaxRequester,h=C.ajaxTargettedUpdate,S=e("../base/designer.base"),v=e("../core/core.ajax.utils"),D=v.baseErrorHandler,b=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),g=b.JRS,w=e("runtime_dependencies/jrs-ui/src/reportViewer/report.view.base");e("runtime_dependencies/jrs-ui/src/reportViewer/report.view.base"),e("runtime_dependencies/jrs-ui/src/controls/controls.controller");var A={CONTROLS_LOCATION:"filtersMainTableICCell",filterSaveAsCheckbox:null,controlsController:null,hideDialog:null,initialControlsData:null,lastSelection:{controlsData:null,saveAsDefault:null},initialize:function(e){if("true"===window.hasVisibleInputControls&&n(l.INPUT_CONTROLS_DIALOG)){this.controlsController=new g.Controls.Controller({reportUri:w.reportUnitURI});l.INPUT_CONTROLS_FORM;if(i("#"+l.INPUT_CONTROLS_DIALOG).length>0&&"#"+l.INPUT_CONTROLS_DIALOG+" .sub.header",this.viewModel=this.controlsController.getViewModel(),this.viewModel.reloadContainer(),this.controlsController.fetchAndSetInputControlsState().always(function(){var e=A.viewModel;A.initialControlsData=e.get("selection"),e.areAllControlsValid()&&"true"!==window.reportForceControlsOnStart?A.forceFiltersFromControls():A.launchDialog()}),this.filterSaveAsCheckbox=i("#filterssaveasdefault"),0===this.filterSaveAsCheckbox.length)throw Error("Can't find filter save as default");A.setSaveAsDefaultCheckbox(e.isSaveParametersAsDefault);var t={"button#ok":this.applyFilters.curry(!0),"button#cancel":this.cancel,"button#reset":this.reset,"button#apply":this.applyFilters.curry(!1)};this._dialog=new c(t)}},launchDialog:function(){"true"===window.hasVisibleInputControls&&(A._dialog.show(),d(A._dialog._dom),A.setFocusOnFirstInputControl())},applyFilters:function(e){A.hideDialog=e,A.isSelectionChanged()?A.controlsController.validate().then(function(t){t&&(A.forceFiltersFromControls(),e&&A.closeDialog())}):A.viewModel.areAllControlsValid()&&e&&A.closeDialog()},reset:function(){A.controlsController.resetControlsToSelection(A.initialControlsData),A.setSaveAsDefaultCheckbox(!0)},cancel:function(){A.closeDialog(),A.isSelectionChanged()&&A.restoreDialogLastSelection()},forceFiltersFromControls:function(){var e,t=A.getControlsSelection(),o=A.isSaveAsDefaultCheckbox();o&&(e={filterssaveasdefault:"on"}),A.forceFilterAction(l.buildSelectedDataUri(t,e)),A.saveDialogLastSelection(t,o)},closeDialog:function(){A._dialog.hide()},leaveAdhoc:function(){document.location=f({_flowId:"homeFlow"})},refreshAdhocDesigner:function(){var e=function(e){window.localContext.standardOpCallback(e),window.adhocDesigner.filtersController.setFilters(e,{reset:!0})};S.sendRequest("co_loadState",[],e)},requestFilterAction:function(e,t,o,r){var n={_flowId:"adhocAjaxFilterDialogFlow",clientKey:window.clientKey,decorate:"no"};n[t]="true";var s=f(n),l=Object.extend({postData:r,callback:e,mode:p.prototype.EVAL_JSON,errorHandler:D},o);h(s,l)},setFilters:function(e){A.requestFilterAction(e,"setFilters")},forceFilterAction:function(e){A.requestFilterAction(function(e){"success"===e&&(A.refreshAdhocDesigner(),A.hideDialog&&A.closeDialog())},"setFilters",null,e)},setFocusOnFirstInputControl:function(){if(void 0!==window.firstInputControlName&&window.firstInputControlName){var e=n(window.firstInputControlName);e&&e.focus()}},isSelectionChanged:function(){return g.Controls.ViewModel.isSelectionChanged(A.getControlsLastSelection(),A.getControlsSelection())||A.getSaveAsDefaultCheckboxLastValue()!=A.isSaveAsDefaultCheckbox()},setSaveAsDefaultCheckbox:function(e){e?A.filterSaveAsCheckbox.prop("checked",!0):A.filterSaveAsCheckbox.removeAttr("checked")},isSaveAsDefaultCheckbox:function(){return A.filterSaveAsCheckbox.is(":checked")},getControlsSelection:function(){return A.viewModel.get("selection")},restoreDialogLastSelection:function(){A.controlsController.resetControlsToSelection(A.lastSelection.controlsData),A.setSaveAsDefaultCheckbox(A.lastSelection.saveAsDefault)},saveDialogLastSelection:function(e,t){A.lastSelection.controlsData=e,A.lastSelection.saveAsDefault=t},getControlsLastSelection:function(){return A.lastSelection.controlsData},getSaveAsDefaultCheckboxLastValue:function(){return A.lastSelection.saveAsDefault}};o.exports=A});