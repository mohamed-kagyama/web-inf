/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","jquery","underscore","runtime_dependencies/js-sdk/src/jrs.configs","runtime_dependencies/jrs-ui/src/namespace/namespace","runtime_dependencies/jrs-ui/src/controls/controls.base","runtime_dependencies/jrs-ui/src/reportViewer/report.view.base","settings!inputControls","../core/core.ajax.utils","runtime_dependencies/jrs-ui/src/controls/controls.basecontrol"],function(e,t,n){var r=e("prototype"),s=(r.$,e("jquery")),i=e("underscore"),o=e("runtime_dependencies/js-sdk/src/jrs.configs"),a=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),c=a.JRS,u=e("runtime_dependencies/jrs-ui/src/controls/controls.base"),l=u.ControlsBase,p=e("runtime_dependencies/jrs-ui/src/reportViewer/report.view.base"),d=e("settings!inputControls"),h=e("../core/core.ajax.utils"),f=h.showErrorPopup;e("runtime_dependencies/jrs-ui/src/controls/controls.basecontrol"),function(e,t,n,r){function i(e){if(e.status>=500)return void f(e.responseText);e.getResponseHeader("JasperServerError")&&(e.getResponseHeader("SuppressError")||f(e.responseText))}function a(t,r,s){var i=n.TemplateEngine.renderUrl(v,{reportUnitURI:t});return e.ajax({type:"GET",url:i,success:function(e){r(e.reportOptionsSummary)},error:s,dataType:"json",cache:!1})}function c(t,r,s,i,o,a){var c=n.TemplateEngine.renderUrl(m,{reportUnitURI:t,label:r,overwrite:i});return e.ajax({type:"POST",url:c,processData:!1,data:JSON.stringify(s),success:function(e){o(e)},error:a,contentType:"application/json",dataType:"json"})}function u(t,r,s,i){var o=n.TemplateEngine.renderUrl(T,{reportUnitURI:t,optionId:r});return e.ajax({type:"DELETE",url:o,success:function(e){s(e)},error:i,contentType:"application/json",dataType:"text"})}function l(e){return{id:"",uri:e,label:r.CONTROL_DEFAULT_OPTION_TEXT}}function h(e,n){return void 0!==t.find(n,function(e){return!0===e.selected})||(e.selected=!0),t.union([e],n)}var v=o.contextPath+"/rest_v2/reports{{=reportUnitURI}}/options",m=o.contextPath+"/rest_v2/reports{{=reportUnitURI}}/options?label={{=label}}&overwrite={{=overwrite}}",T=o.contextPath+"/rest_v2/reports{{=reportUnitURI}}/options/{{=optionId}}";t.extend(n,{ReportOptions:n.BaseControl.extend({title:"",label:r.CONTROL_OPTIONS_TEXT,type:"reportOptions",setValue:function(e){var t=this.getElem().find("select"),r=this.getTemplateSection("data");t.empty(),n.Utils.setInnerHtml(t[0],r,{data:e})},bindCustomEventListeners:function(){var e=this.getElem();e&&e.on("change","select",t.bind(function(e){var t=s(e.target).val(),n=this.find({id:t});this.set({selection:n})},this))},fireControlSelectionChangeEvent:function(e,r){var i=null;"true"===d.useUrlParametersOnReset&&(i=t.extend(p.getAllRequestParameters(),p.reportParameterValues)),s(document).trigger(n.REPORT_OPTIONS_SELECTION_CHANGE,{reportOption:e,previousReportOption:r,selectedData:i})},set:function(e,r){if(void 0!==e.selection){var s=this.get("selection"),i=e.selection.id;this.selection=this.find({id:i}),this.enableRemoveButton(""!==i),this.setValue(t.map(this.values,function(e){return i===e.id?e.selected=!0:delete e.selected,e})),!r&&this.fireControlSelectionChangeEvent(this.get("selection"),s)}else n.ReportOptions.__super__.set.apply(this,arguments)},fetch:function(e,n){var r=l(e);return this.set({defaultOption:r}),a(e,t.bind(function(e){var s=t.map(e,function(e){return n&&n==e.uri&&(e.selected=!0),e});s=h(r,s),this.set({values:s})},this),i)},reset:function(e){this.set({selection:this.get("defaultOption")},e)},add:function(e,r,s,o){var a=t.bind(function(e){var n;e.selected=!0;var r=this.get("values"),s=t.find(r,function(e){return e.selected});s&&delete s.selected,n=r?t.union(r,[e]):[e],r&&!t.isEmpty(r)||(n=h(this.get("defaultOption"),n)),o||this.set({values:n}),this.set({selection:e},!0),this.enableRemoveButton(!0)},this);return c(e,r,s,o,a,i).fail(t.bind(function(e){try{var t=JSON.parse(e.responseText),r=n.TemplateEngine.render(t.message,t.parameters,n.TemplateEngine.STD_PLACEHOLDERS);this.set({error:r})}catch(e){}},this))},removeOption:function(e,r){return u(e,r,t.bind(function(){var e=this.get("selection"),t=this.get("values"),n=t.without(e);this.set({values:n}),this.values.size()<2&&delete this.values},this),i).fail(t.bind(function(e){try{var t=JSON.parse(e.responseText),r=n.TemplateEngine.render(t.message,t.parameters,n.TemplateEngine.STD_PLACEHOLDERS);this.set({error:r})}catch(e){}},this))},enableRemoveButton:function(t){var n=e("#"+(t?r._BUTTON_REMOVE:r._BUTTON_SAVE))[0],i=e("#"+(t?r._BUTTON_SAVE:r._BUTTON_REMOVE))[0];n&&i&&(s(n).removeClass("hidden"),s(i).addClass("hidden"))}}),REPORT_OPTIONS_SELECTION_CHANGE:"reportoptions:selection:changed"})}(s,i,c.Controls,l,window.Report),n.exports=c.Controls.ReportOptions});