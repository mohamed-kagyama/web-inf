/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","runtime_dependencies/js-sdk/src/common/bi/component/ComponentEngine","runtime_dependencies/js-sdk/src/common/bi/component/BiComponent","request","runtime_dependencies/js-sdk/src/common/bi/error/enum/biComponentErrorCodes","runtime_dependencies/js-sdk/src/common/bi/error/biComponentErrorFactory","json!./Authentication.json","settings!auth"],function(e,n,o){function r(e){return e.token?(e.tokenName||f.ticketParameterName||l)+"="+e.token:"j_username="+e.name+"&j_password="+e.password+"&orgId="+(e.organization?e.organization:"null")+(e.locale?"&userLocale="+e.locale:"")+(e.timezone?"&userTimezone="+e.timezone:"")}var t=e("jquery"),i=e("underscore"),s=e("runtime_dependencies/js-sdk/src/common/bi/component/ComponentEngine"),c=e("runtime_dependencies/js-sdk/src/common/bi/component/BiComponent"),u=e("request"),p=e("runtime_dependencies/js-sdk/src/common/bi/error/enum/biComponentErrorCodes"),m=e("runtime_dependencies/js-sdk/src/common/bi/error/biComponentErrorFactory"),a=e("json!./Authentication.json"),d=e("settings!auth"),l="ticket",f=d||{ticketParameterName:l},g={login:function(e,n){var o=t.Deferred();return n({url:e.url+(e.preAuth?"/":"/j_spring_security_check")+"?"+r(e),headers:{Accept:"application/json"}}).done(function(e,n,r){var t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){o.reject(e)}!0===t.success?o.resolve(t):o.reject(r)}).fail(function(e){o.reject(e)}),o},logout:function(e,n){return n({url:e.url+"/logout.html"})}},j=function(e){var n=s.newInstance(a,e),o=this;n.decorateComponent(this,function(e,n){var o;o=e.properties&&e.properties.loginFn&&i.isFunction(e.properties.loginFn)?e.properties.loginFn:g.login,o(e.properties,u).done(function(o){e.data=!0,n.resolve(o)}).fail(function(e){n.reject(m.requestError(e,p.AUTHENTICATION_ERROR))})}),this.logout=function(e,o,r){var t,s=n.instanceData;return t=s.properties&&s.properties.logoutFn&&i.isFunction(s.properties.logoutFn)?s.properties.logoutFn:g.logout,t(s.properties,u).done(function(n){s.data=!1,e&&i.isFunction(e)&&e(n)}).fail(function(e){o&&i.isFunction(o)&&o(e)}).always(function(){r&&i.isFunction(r)&&r()})},this.login=function(e,n,r,t){return o.properties(e),o.run(n,r,t)}};j.prototype=new c,o.exports=j});