/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","../base/designer.base","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/core/core.ajax","runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils","runtime_dependencies/jrs-ui/src/components/components.dialogs","../dataChooser/domain.components"],function(e,s,i){var o=e("prototype"),t=o.$,n=o.$H,d=o.$$,l=e("../base/designer.base"),r=e("runtime_dependencies/jrs-ui/src/util/utils.common"),c=r.encodeText,a=r.doNothing,u=r.matchAny,p=r.deepClone,h=e("runtime_dependencies/jrs-ui/src/core/core.ajax"),T=h.AjaxRequester,_=e("runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils"),f=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),m=e("../dataChooser/domain.components"),E={TEMPLATE_ID:"selectFields",TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_sets",OK_PATTERN:"#selectFieldsOk",CANCEL_PATTERN:"#selectFieldsCancel",ajaxBuffer:"ajaxbuffer",callbackCalled:!1,initialize:function(){this._dialog=t(this.TEMPLATE_ID),this.actionHash={"#selectFieldsOk":function(e){m.chooser.fields.fillForm(),E.callbackCalled=!0;var s=function(e){window.adhocDesigner.generalDesignerCallback(),window.adhocDesigner.filtersController.setFilters(e)};l.sendRequest("co_setAdhocFields",["selectedModel="+c(t("selectedModel").value)],s,{bPost:!0}),this.close()},"#selectFieldsCancel":function(e){this.close()}},this.getAction=function(e){for(var s in this.actionHash)if(e.match(s))return this.actionHash[s];return a},this._dialog.observe("click",function(e){var s=e.element(),i=u(s,[this.OK_PATTERN,this.CANCEL_PATTERN],!0);i&&this.getAction(i).bind(this)(e),e.stop()}.bindAsEventListener(this))},launchDialog:function(){l.sendRequest("co_loadSchemaPos",[],E.init,{target:E.ajaxBuffer,bpost:!0,mode:T.prototype.EVAL_JSON})},init:function(e){e=e[0],m.chooser.fields.mode=m.chooser.fields.RE_ENTRANCE_MODE,m.chooser.fields.TREE_TEMPLATE_DOM_ID=E.TREE_TEMPLATE_DOM_ID,m.chooser.fields.NODE_CLASS=E.ReentranceNode,m.setMessage("disabledFolderTooltip",window.disabledFolderTooltip),m.chooser.fields.disableNodesInAdhocReEntrance=function(){E.disableNode(_.trees[m.chooser.fields.DESTINATION_FIELDS_DOM_ID].rootNode,e.disabledNodes)},m.chooser.fields.updateReEntrantControls=function(e){var s=d(E.OK_PATTERN);s.size()&&void 0!==e.destTreeHasVisibleNodes&&m.enableButton(s[0],e.destTreeHasVisibleNodes)},delete m._bodyClickEventHandlers,m.chooser.fields.init(),f.popup.show(t("selectFields")),l.updateMainOverlay("hidden")},disableNode:function(e,s){var i=n(s).keys().detect(function(s){return e.param.id==s});i&&e.disable(s[i]),e.childs.each(function(e){E.disableNode(e,s)});for(var o=e.parent;o&&o!=_.trees[e.getTreeId()].rootNode;){var t=o.childs.findAll(function(e){return e.disabled});o.childs.length>0&&o.childs.length==t.length&&o.disable(window.disabledFolderTooltip),o=o.parent}},close:function(){f.popup.hide(t("selectFields")),E.callbackCalled||window.adhocDesigner.generalDesignerCallback(),E.callbackCalled=!1}};E.ReentranceNode=function(e){m.ItemNode.call(this,e),this.Types={Folder:new _.TreeNode.Type("ItemGroupType"),Leaf:new _.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_sets:sets"},E.ReentranceNode.prototype=p(m.ItemNode.prototype),i.exports=E});