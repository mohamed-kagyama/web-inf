/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","./crosstab","../base/designer.base","runtime_dependencies/jrs-ui/src/components/components.dialogs","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","./crosstab.multiselect","runtime_dependencies/jrs-ui/src/util/utils.common","underscore"],function(e,t,n){var i=e("dragdropextra"),r=i.Draggables,o=e("prototype"),a=o.$,s=e("./crosstab"),d=e("../base/designer.base"),l=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),u=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"),c=e("./crosstab.multiselect"),m=e("runtime_dependencies/jrs-ui/src/util/utils.common"),E=m.matchAny,_=m.isRightClick,M=e("underscore");s.mouseDownHandler=function(e){},s.mouseUpHandler=function(e){var t,n,i,o,l=e.element(),u=(new RegExp("\\d+$"),null);if(r.dragging!=d.AVAILABLE_FIELDS_AREA){if(E(l,[window.localContext.GROUP_LEVEL_DISCLOSURE_PATTERN],!1)){if(o=l.up()){var m=o.readAttribute("data-dimension"),M=o.readAttribute("data-level"),w=l.hasClassName("closed");i=o.identify().startsWith("rowGroup"),w?s.expandLevel(m,M,i):s.collapseLevel(m,M,i)}return}if(E(l,[window.localContext.GROUP_MEMBER_DISCLOSURE_PATTERN],!1)){if(o=l.up(),a(o)){t=o.identify(),i=t.startsWith("rowGroup_");n=new RegExp(/\B\d+\B/).exec(t)[0];var p=a(o).readAttribute("data-path");i?window.localContext.toggleExpandCollapseForRow(p,n):window.localContext.toggleExpandCollapseForColumn(p,n)}return}if(u=E(l,[window.localContext.COLUMN_GROUP_MEMBER_PATTERN,window.localContext.ROW_GROUP_MEMBER_PATTERN],!0),u&&!_(e)&&(s.deselectAllSelectedOverlays(),c.selectXtabGroupMember(u,e)),u=E(l,[window.localContext.ROW_GROUP_OVERFLOW_PATTERN,window.localContext.COLGROUP_GROUP_OVERFLOW_PATTERN],!0))if(a(u).hasClassName("colOverflow")){var R=a(u).readAttribute("data-canShowMore");"true"===R&&s.retrieveOverflowColumnGroups()}else s.retrieveOverflowRowGroups()}},s.mouseOverHandler=function(e){},s.mouseOutHandler=function(e){},s.mouseClickHandler=function(e){var t=null,n=e.element(),i=new RegExp("\\d+","g");if(n.match(s.DRILL_THROUGH_PATTERN)&&(c.deselectAllGroupMembers(),n=n.parentNode,a(n)&&(t=n.identify(),window.localContext.state.inDesignView))){if(t.startsWith("measureBucketDrill_")){var r=i.exec(t)[0],o=i.exec(t)[0];return void(s.isOlapMode()?s.drillOLAP(r,o):s.drill(r,o))}if(t.startsWith("measureBucketNoDrillParentChild_")&&l.systemConfirm.show(window.adhocDesigner.getMessage("ADH_1213_DRILLTHROUGH_NOT_SUPPORTED_PARENT_CHILD",15e3)),t.startsWith("measureBucketInvalidDrill_"))return}},s.contextMenuHandler=function(e){var t,n,i,r=e.element(),o=r.identify();if(E(r,[s.COLUMN_GROUP_MEMBER_PATTERN,s.ROW_GROUP_MEMBER_PATTERN],!0)){if(r){if(0===o.indexOf("anonymous"))return;d.isObjectInSelection({id:o},"id")||c.selectXtabGroupMember(r,e),window.adhocDesigner.showDynamicMenu(e,d.MEMBER_GROUP_MENU_LEVEL)}}else if(E(r,[s.GROUP_LEVEL_PATTERN],!1)){for(;a(r).hasClassName("dummy");)r=r.nextSiblings()[0];o=r.identify(),i=o.startsWith("rowGroup"),t=parseInt(s.ENDS_WITH_A_NUMBER_REGEX.exec(o)[0]);var l=window.localContext.state,u=i?"row":"column",m=r.readAttribute("data-dimension"),_=M.indexOf(l.getDimensions(u),l.getDimension(m,u));a(r)&&(n={id:(i?"rowGroup_":"colGroup_")+t,name:r.readAttribute("data-level"),level:r.readAttribute("data-level"),dimensionId:m,expandable:"true"===r.readAttribute("data-expanable"),axis:u,isMeasure:m===window.adhocDesigner.MEASURES,groupIndex:s.isOlapMode()?_:t,index:t,sorting:r.readAttribute("data-sorting")},n.dimensionId!==s.NULL_DIMENSION&&(c.selectXtabGroupLabel(n),n.isMeasure?s.showCrosstabMenu(e,window.localContext[i?"MEASURES_DIMENSION_ROW_MENU_CONTEXT":"MEASURES_DIMENSION_COLUMN_MENU_CONTEXT"]):s.showCrosstabMenu(e,d[i?"ROW_GROUP_MENU_LEVEL":"COLUMN_GROUP_MENU_LEVEL"])))}else if(E(r,[s.MEASURE_PATTERN],!1)){for(;a(r).hasClassName("dummy");)r=r.nextSiblings()[0];t=parseInt(s.ENDS_WITH_A_NUMBER_REGEX.exec(o)[0]),i=o.startsWith("rowGroup");var w=s.getRefinedMeasuresFromState(),p=w.length,R=t%p,O=w[R].fieldName,N=r.readAttribute("data-path"),h=s.getTopBottomFilter();a(r)&&(n={id:(i?"rowGroup_":"colGroup_")+t,name:O,level:O,dimensionId:window.adhocDesigner.MEASURES,expandable:"true"===r.readAttribute("data-expanable"),axis:i?"row":"column",isMeasure:!0,index:R,path:r.readAttribute("data-path"),isInner:r.hasClassName("inner"),sorting:r.readAttribute("data-sorting"),topBottomFilter:h&&h.path===N?h.type:"none"},c.selectXtabGroupLabel(n),s.showCrosstabMenu(e,window.localContext[i?"MEASURE_ROW_MENU_CONTEXT":"MEASURE_COLUMN_MENU_CONTEXT"]))}},s.lmHandlersMap={addItems:function(e,t,n){var i=M.uniq(M.map(e,function(e){var t=e.param?e.param.extra.dimensionId:e.extra&&e.extra.dimensionId;return e.dimensionId?e.dimensionId:t})),r=M.map(e,function(e){var t=e.extra?e.extra.id:e.param&&e.param.extra.id;return t||e.id}),o=e[0].extra&&"isMeasure"in e[0].extra?e[0].extra.isMeasure:null,a=e[0].param&&"isMeasure"in e[0].param.extra?e[0].param.extra.isMeasure:null,d="isMeasure"in e[0]?e[0].isMeasure:o||a,l=s.isOlapMode();s.insertDimensionInAxisWithChild({dim:d?i.slice(0,1):i,axis:n,pos:t,child:l||d?r:null,hierarchyName:e[0].extra?e[0].extra.hierarchyName:e[0].hierarchyName})},measureReorder:function(e,t){s.moveMeasure(e,t)},column:{addItem:function(e,t,n,i,r,o,a){s.insertDimensionInAxisWithChild({dim:e,axis:"column",pos:t,child:s.isOlapMode()||r?n:null,measure_pos:i,isMeasure:r,uri:o,hierarchyName:a})},removeItem:function(e,t){e.isMeasure?s.removeMeasure(t):s.hideColumnLevel(e.dimensionId,e.level)},moveItem:function(e,t,n){s.moveDimension(e,"column","column",t,n)},switchItem:function(e,t,n){s.moveDimension(e,"row","column",t,n)},contextMenu:function(e,t){s.selectFromDisplayManager(t.targetEvent,t.extra,d.COLUMN_GROUP_MENU_LEVEL),s.showCrosstabMenu(t.targetEvent,window.localContext.DISPLAY_MANAGER_COLUMN_CONTEXT)}},row:{addItem:function(e,t,n,i,r,o,a){s.insertDimensionInAxisWithChild({dim:e,axis:"row",pos:t,child:s.isOlapMode()||r?n:null,measure_pos:i,isMeasure:r,uri:o,hierarchyName:a})},removeItem:function(e,t){e.isMeasure?s.removeMeasure(t):s.hideRowLevel(e.dimensionId,e.level)},moveItem:function(e,t,n){s.moveDimension(e,"row","row",t,n)},switchItem:function(e,t,n){s.moveDimension(e,"column","row",t,n)},contextMenu:function(e,t){s.selectFromDisplayManager(t.targetEvent,t.extra,d.ROW_GROUP_MENU_LEVEL),s.showCrosstabMenu(t.targetEvent,window.localContext.DISPLAY_MANAGER_ROW_CONTEXT)}}},s.treeMenuHandler=function(e){var t,n=e.memo.node;"dimensionsTree"===n.treeId?t=n.isParent()?window.adhocDesigner.DIMENSION_TREE_DIMENSION_CONTEXT:window.adhocDesigner.DIMENSION_TREE_LEVEL_CONTEXT:"measuresTree"===n.treeId&&(t=n.isParent()?window.adhocDesigner.MEASURE_TREE_GROUP_CONTEXT:window.adhocDesigner.MEASURE_TREE_CONTEXT),window.adhocDesigner.showDynamicMenu(e.memo.targetEvent,t,null)},s.selectFromDisplayManager=function(e,t,n){d.unSelectAll();var i=window.adhocDesigner.isMultiSelect(e,n);window.selectionCategory.area=n;var r=window.adhocDesigner.isAlreadySelected(t);u.setSelected([t]),window.adhocDesigner.addSelectedObject(e,t,i,r),Event.stop(e)},n.exports=s});