/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","runtime_dependencies/js-sdk/src/common/util/xssUtil","bundle!all","highcharts","runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter","runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter/adhocDataProcessor","runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter/highchartsDataMapper","./formattingDialog/model/FormattingDialogModel","./formattingDialog/view/FormattingDialogView","../../base/designer.base","runtime_dependencies/jrs-ui/src/components/components.dialogs","runtime_dependencies/js-sdk/src/common/logging/logger","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","../crosstab.helpers","runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils","resize-observer-polyfill","runtime_dependencies/jrs-ui/src/util/utils.common","jquery-ui/ui/position"],function(e,t,i){function n(e,t){return a.template(e)(t)}var r=e("jquery"),a=e("underscore"),s=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),o=e("bundle!all"),l=e("highcharts"),d=e("runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter"),c=e("runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter/adhocDataProcessor"),u=e("runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter/highchartsDataMapper"),h=e("./formattingDialog/model/FormattingDialogModel"),m=e("./formattingDialog/view/FormattingDialogView"),p=e("../../base/designer.base"),g=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),v=e("runtime_dependencies/js-sdk/src/common/logging/logger"),w=e("runtime_dependencies/jrs-ui/src/util/utils.common"),f=w.isIPad,_=w.encodeText,A=w.isNotNullORUndefined,D=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"),C=e("../crosstab.helpers"),S=e("runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils"),T=e("resize-observer-polyfill");e("runtime_dependencies/jrs-ui/src/util/utils.common"),e("jquery-ui/ui/position");var R=v.register("AdhocIntelligentChart"),O={},M=O;a.extend(M,{debug:!1,mode:null,controller:"ich",state:{},cache:[],chart:null,_chartOptionsMenuHasBeenInitialized:!1,hasAllData:!1,groupLevel:{column:0,row:0},firstRendering:!0,$chartContainer:null,chartContainerSelector:"#chartContainer",_containerResizeObserver:null,_highchartsOptions:null,reset:function(){M.isDesignerInitialized=!1},setMode:function(e){this.mode=e},getMode:function(){return this.mode},flush:function(){this.hasAllData=!1,this.cache=[]},setUp:function(){},isOLAP:function(){return this.getMode()===p.OLAP_ICHART},isOlapMode:function(){return this.getMode()===p.OLAP_ICHART},isNonOlapMode:function(){return this.getMode()===p.ICHART},update:function(e){try{M.setUp(),a.extend(this.state,e)}catch(e){M.debug&&console.log("AIC.update:   caught error "+e+" restore state to previous"),window.adhocDesigner.undo(),g.systemConfirm.show("The previous request encountered an error '"+e+"' restoring chart to previous state")}return this},checkIfChartCanBeRendered:function(){if(M.state.queryData.metadata.canRender){if(0===M.state.queryData.data.length)return void(M.state.queryData.metadata.canRender=!1);var e=M.state.chartState.chartType,t=M.state.queryData.metadata,i=t.measures.length,n=1===t.measureAxis?0:1,r=1===t.measureAxis?1:0,a=0===t.measureAxis?"row":"column",s=(t.measureAxis,t.axes[r].length),o=t.axes[n].length,l=!0,d="olap_ichart"===M.state.viewType;"dual_measure_tree_map"===e?(l="column"===a&&2===i&&1===o&&!d,l=l&&1===s):"tree_map"===e?(l="column"===a&&1===i&&o>=1&&!d,l=l&&1===s):"one_parent_tree_map"===e?(l="column"===a&&1===i&&o>=2&&!d,l=l&&1===s):"gauge"===e?l="column"===a&&i>=1&&0===o&&!d:"multi_level_gauge"===e?l="column"===a&&i>=2&&0===o&&!d:"arc_gauge"===e&&(l="column"===a&&i>=1&&0===o&&!d),l||(M.state.queryData.metadata.canRender=l)}},render:function(){var e=M.state.queryData.data.length>0,t=M.state.unresolvedReferences&&M.state.unresolvedReferences.length>0,i=window.adhocDesigner.getMessage("ADH_264_XTAB_STATUS_MISSING_MEASURE_DIMENSION");t&&(i=window.adhocDesigner.getMissingFieldsCanvasMessage(M.state)),this.$nothingToDisplayMessage.html(i),window.adhocDesigner.setNothingToDisplayVisibility(!e||t),M.ui.update(M.state),M.ui.render();var n=M.renderChart(e);return r("[action='chart-format']").removeClass("disabled"),M.isDesignerInitialized=!0,n},renderChart:function(e){if(this._destroyChart(),M.firstRendering)return e;if(M.debug&&console.info(M.state),this.checkIfChartCanBeRendered(),!1===M.state.queryData.metadata.canRender){var t=M.state.chartState.chartType,i="";return M._isTimeSeries()&&!u.isHeatMapTimeSeriesChart(t)?i=window.adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_TIME_SERIES_DATA"):u.isDualOrMultiAxisChart(t)||u.isScatterChart(t)||u.isBubbleChart(t)?i=window.adhocDesigner.messages["ADH_1214_ICHARTS_NO_DATA_"+t.toUpperCase()]:u.isDualLevelPieChart(t)?i=window.adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_DUAL_LEVEL_PIE:u.isHeatMapChart(t)&&!window.adhocDesigner.isOlapMode()?i=window.adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_HEAT_MAP_NON_OLAP:u.isHeatMapChart(t)&&window.adhocDesigner.isOlapMode()?i=window.adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_HEAT_MAP_OLAP:u.isHeatMapTimeSeriesChart(t)?i=window.adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_TIME_SERIES_HEAT_MAP:u.isDualMeasureTreeMapChart(t)?i=o.ADH_1214_ICHARTS_NO_DATA_DUAL_MEASURE_TREE_MAP:u.isTreeMapChart(t)?i=o.ADH_1214_ICHARTS_NO_DATA_TREE_MAP:u.isOneParentTreeMapChart(t)?i=o.ADH_1214_ICHARTS_NO_DATA_ONE_PARENT_TREE_MAP:u.isGaugeChart(t)?i=o.ADH_1214_ICHARTS_NO_DATA_GAUGE:u.isMultiLevelGaugeChart(t)?i=o.ADH_1214_ICHARTS_NO_DATA_MULTI_LEVEL_GAUGE:u.isArcGaugeChart(t)&&(i=o.ADH_1214_ICHARTS_NO_DATA_ARC_GAUGE),i&&(this.$nothingToDisplayMessage.text(i),window.adhocDesigner.setNothingToDisplayVisibility(!0)),e}var n=JSON.parse(JSON.stringify(M.state.queryData)),r=JSON.parse(JSON.stringify(M.state.chartState));if(c.load(n),c.messages=window.adhocDesigner.messages,M.isOLAP()&&(M.state.olapDimensionInfo=c.getOLAPDimensionInfo()),window.isDesignView&&M._renderDataLevelSelector(),this.ichWidth=this.$chartContainer.width(),this.ichHeight=this.$chartContainer.height(),this.ichWidth<50||this.ichHeight<50)return this.$nothingToDisplayMessage.text(o.ADH_1214_ICHARTS_NO_CONTAINER_SPACE),window.adhocDesigner.setNothingToDisplayVisibility(!0),this._containerResizeObserver.observe(this.$chartContainer[0]),!1;if(this._highchartsOptions=d.generateOptions(n,r,{width:M.ichWidth,height:M.ichHeight,messages:window.adhocDesigner.messages}),!M._checkHasData(this._highchartsOptions))return this.$nothingToDisplayMessage.html(window.adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_CHART_DATA")),window.adhocDesigner.setNothingToDisplayVisibility(!0),!1;if(!0!==M.state.isRedrawRequired&&M.chart)return!0;this._changeFontSize(),window.adhocDesigner.setNothingToDisplayVisibility(!1);try{M.chart=new l.Chart(this._highchartsOptions)}catch(e){R.error(e),this._destroyChart(),M.state.canSave=!1,window.adhocDesigner.enableRunAndSave(!1);var a="";return a=/Cannot read property '3' of undefined/.test(e)?o.ADH_1214_ICHARTS_ERROR_NOT_ENOUGH_SPACE:/\#12/.test(e)?o.ADH_1214_ICHARTS_ERROR_12:/\#13/.test(e)?o.ADH_1214_ICHARTS_ERROR_13:/\#14/.test(e)?o.ADH_1214_ICHARTS_ERROR_14:/\#15/.test(e)?o.ADH_1214_ICHARTS_ERROR_15:/\#16/.test(e)?o.ADH_1214_ICHARTS_ERROR_16:/\#17/.test(e)?o.ADH_1214_ICHARTS_ERROR_17:/\#18/.test(e)?o.ADH_1214_ICHARTS_ERROR_18:/\#19/.test(e)?window.adhocDesigner.messages.ADH_1214_ICHARTS_ERROR_TOO_MANY_VALUES:/\#20/.test(e)?o.ADH_1214_ICHARTS_ERROR_20:/\#21/.test(e)?o.ADH_1214_ICHARTS_ERROR_21:/\#22/.test(e)?o.ADH_1214_ICHARTS_ERROR_22:/\#23/.test(e)?o.ADH_1214_ICHARTS_ERROR_23:window.adhocDesigner.messages.ADH_1214_ICHARTS_ERROR_UNCAUGHT,this.$nothingToDisplayMessage.text(a),window.adhocDesigner.setNothingToDisplayVisibility(!0),!1}return this._containerResizeObserver.observe(this.$chartContainer[0]),!0},redraw:function(){},_doesChartSupportPlotResize:function(){return!("pie"===this.state.chartState.chartType||u.isGaugeBasedChart(this.state.chartState.chartType)||u.isHeatMapTimeSeriesChart(this.state.chartState.chartType))},_onContainerResizeEvent:function(){if(this.$chartContainer){var e=20;this._highchartsOptions&&!a.isUndefined(this._highchartsOptions.resizeThreshold)&&(e=this._highchartsOptions.resizeThreshold);var t=this.ichWidth,i=this.ichHeight,n=this.$chartContainer.width(),r=this.$chartContainer.height(),s=Math.abs(t-n),o=Math.abs(i-r);if(!(s<e&&o<e)){this._onContainerResizeEventTimeout&&clearTimeout(this._onContainerResizeEventTimeout);var l={oldWidth:t,oldHeight:i,newWidth:n,newHeight:r};this._onContainerResizeEventTimeout=setTimeout(this._onContainerResizeEventReaction.bind(this,l),500)}}},_onContainerResizeEventReaction:function(e){var t=e.oldHeight,i=e.newWidth,n=e.newHeight;if(this._onContainerResizeEventTimeout=null,this.ichWidth=i,this.ichHeight=n,!1===this._doesChartSupportPlotResize())return void this.renderChart();if(this._changeFontSize())return void this.renderChart();var r=t===n;this.chart.setSize(M.ichWidth,M.ichHeight,r)},_destroyChart:function(){this._containerResizeObserver&&(this._onContainerResizeEventTimeout&&(clearTimeout(this._onContainerResizeEventTimeout),this._onContainerResizeEventTimeout=null),this._containerResizeObserver.unobserve(this.$chartContainer[0])),this.chart&&(this.chart.destroy&&this.chart.destroy(),this.chart=null)},_changeFontSize:function(){if(!this.state.chartState.autoScaleFonts)return void 0!==this._initialFontSize&&this.$chartContainer.css("font-size",this._initialFontSize),!1;var e=parseInt(this.$chartContainer.css("font-size"));void 0===this._initialFontSize&&(this._initialFontSize=e);var t=1;this.ichWidth<=100?t=.4:this.ichWidth>100&&this.ichWidth<=200?t=.5:this.ichWidth>200&&this.ichWidth<=300?t=.6:this.ichWidth>300&&this.ichWidth<=400?t=.7:this.ichWidth>400&&this.ichWidth<=500?t=.8:this.ichWidth>500&&this.ichWidth<=600&&(t=.9);var i=this._initialFontSize*t;return e!==Math.round(i)&&(this.$chartContainer.css("font-size",i),!0)},_isTimeSeries:function(){return-1!=M.state.chartState.chartType.indexOf("time_series")},_isDualMeasureTreeMap:function(){return-1!=M.state.chartState.chartType.indexOf("dual_measure_tree_map")},_isTimeSeriesHeatMap:function(){return u.isHeatMapTimeSeriesChart(M.state.chartState.chartType)},cleanupOnSwitch:function(){this.ui.dialogs.groupSelector.hide(),this._destroyChart()},resize:function(){},fixFirstRendering:function(){M.firstRendering&&(M.firstRendering=!1,M.renderChart())},initAll:function(){},_checkHasData:function(e){if(!e)return!1;if(!e.series)return!1;if(e.series.length<=0)return!1;for(var t=!1,i=0;i<e.series.length;i++)if(null!=e.series[i].data&&e.series[i].data.length>0){t=!0;break}return t},_isPivotAllowed:function(){var e=M;return e.getDimensions("row").length>0||e.isOLAP()&&e.getDimensions("column").length>0},_renderDataLevelSelector:function(){var e=M.ui.controls.dataLevelSelector;e.render(),(M._isTimeSeries()||M._isDualMeasureTreeMap())&&e.hideRowsSlider()}}),a.extend(M,{serviceBus:{_listenersMap:{},_allEventsListeners:[],_incorrectEventTypeMsg:"Service bus supports only string events. Received event is not a string.",fireEvent:function(e){var t=M.serviceBus;if("string"!=typeof e)throw t._incorrectEventTypeMsg;var i=t._listenersMap,n=i[e];n&&a.each(n,function(t){t(e)}),a.each(t._allEventsListeners,function(t){t(e)})},registerListener:function(e,t){var i=M.serviceBus;if("string"!=typeof e)throw i._incorrectEventTypeMsg;var n=i._listenersMap,r=n[e];r||(r=[],n[e]=r),r.push(t)},registerAllEventsListener:function(e){M.serviceBus._allEventsListeners.push(e)}}}),a.extend(M,{mediator:{_isListenerRegistered:!1,eventToAction:{"chart:typeChanged":function(){},"chart:levelChanged":function(){M.state.chartState.columnsSelectedLevels=M.ui.controls.dataLevelSelector.getColumnSelectedLevels(),M.state.chartState.rowsSelectedLevels=M.ui.controls.dataLevelSelector.getRowsSelectedLevels(),M.updateChartState()}},listener:function(e){if("string"!=typeof e)throw"Mediator supports only string events. Received event is not a string.";var t=M.mediator.eventToAction[e];t&&t()},register:function(){M.serviceBus._isListenerRegistered||(M.serviceBus.registerAllEventsListener(M.mediator.listener),M.serviceBus._isListenerRegistered=!0)}}}),a.extend(M,{ui:{controls:{dataLevelSelector:{_container:null,_column:null,_row:null,init:function(){M.ui.controls.dataLevelSelector._container=r("#dataLevelSelector")},render:function(){if(u.isDualLevelPieChart(M.state.chartState.chartType))return void M.ui.controls.dataLevelSelector.hide();var e=M.ui.controls.dataLevelSelector;M.ui.selectorTables.column.show().find("td.select-header").parent().siblings().remove(),M.ui.selectorTables.row.show().find("td.select-header").parent().siblings().remove(),M.isOLAP()?e._renderOlapSlider():e._renderNonOlapSliders(),window.adhocDesigner.resetFilterPanelState()},_renderOlapSlider:function(){var e=M.ui.controls.dataLevelSelector;e._column=[],e._row=[],r.each(["row","column"],function(t,i){M.state.olapDimensionInfo[t].length?(r.each(M.state.olapDimensionInfo[t],function(t,n){var r=M.state.chartState[i+"sSelectedLevels"][t];e["_"+i].push(M.ui.create.slider(M.ui.selectorTables[i],n.levels,n.dimension,{max:n.levels.length-1,value:e._levelToLevelPosition(r,n),stop:function(e,t){M.serviceBus.fireEvent("chart:levelChanged")}}))}),M.ui.selectorTables[i].show()):M.ui.selectorTables[i].hide()})},_renderNonOlapSliders:function(){var e=M.ui.controls.dataLevelSelector;e._row=e._renderNonOlapSlider(0),e._column=e._renderNonOlapSlider(1)},_renderNonOlapSlider:function(e){var t=M.ui.controls.dataLevelSelector,i=[];r.each(M.state.queryData.metadata.axes[e],function(e,t){"Measures"!=t.name&&i.push(t.label)});var n=0===e?M.ui.selectorTables.row:M.ui.selectorTables.column,a=0===e?c.getRowSliderLevelCount():c.getColumnSliderLevelCount(),s=0===e?M.state.chartState.rowsSelectedLevels:M.state.chartState.columnsSelectedLevels;return n.find("td.select-header").parent().siblings().remove(),1===a?n.hide():n.show(),M.ui.create.slider(n,i,"",{max:a-1,value:t._getSliderPositionForNonOlap(s,e),stop:function(e,t){M.serviceBus.fireEvent("chart:levelChanged")}})},hide:function(){M.ui.selectorTables.column.hide(),M.ui.selectorTables.row.hide()},hideRowsSlider:function(){M.ui.selectorTables.row.hide()},hideColumnsSlider:function(){M.ui.selectorTables.column.hide()},_levelToLevelPosition:function(e,t){for(var i=0;i<t.levels.length;i++)if(t.levels[i].levelName===e.name)return i;throw"No OLAP level info found for specified level = "+e},getRowsSelectedLevels:function(){var e=M.ui.controls.dataLevelSelector;return e._getSelectedLevels(e._row,e._row,0)},getColumnSelectedLevels:function(){var e=M.ui.controls.dataLevelSelector;return e._getSelectedLevels(e._column,e._column,1)},_getSelectedLevels:function(e,t,i){var n=M.ui.controls.dataLevelSelector;return M.isOLAP()?n._extractOlapSelectedLevels(t,i):n._extractNonOlapSelectedLevels(e,i)},_extractOlapSelectedLevels:function(e,t){var i=M.ui.controls.dataLevelSelector,n=[];return r(e).each(function(e){var a=i._extractSliderPosition(r(this)),o=M.state.olapDimensionInfo[t][e],l=o.levels[a];n.push({name:s.unescape(l.levelName),label:s.unescape(l.label),dimension:o.dimension})}),n},_extractNonOlapSelectedLevels:function(e,t){var i=M.ui.controls.dataLevelSelector,n=i._extractSliderPosition(e);return 0===n?[]:[c.getLevelsWithoutMeasures(M.state.queryData.metadata.axes[t])[n-1]]},_getSliderPositionForNonOlap:function(e,t){if(0===e.length)return 0;var i=c.getLevelsWithoutMeasures(M.state.queryData.metadata.axes[t]);return c.getLevelIndex(i,e[0])+1},_extractSliderPosition:function(e){return e.slider("option","value")},dock:function(){var e=M.ui.controls.dataLevelSelector;e._container.find("div.pod-body").eq(0).appendTo(r("#level-container")),g.popup.hide(e._container[0])},undock:function(){var e=M.ui.controls.dataLevelSelector;r("#level-container").children("div.pod-body").eq(0).appendTo(e._container.find("div.body").eq(0)),g.popup.show(e._container[0])}}},update:function(e){},render:function(){var e=r("#titleCaption");M.state.titleBarShowing?e.show():e.hide(),e.text(M.state.title),window.adhocDesigner.enableXtabPivot(M._isPivotAllowed()),M.ui.dialogs.formatDialog.setState(M.state.chartState),M.ui.controls.dataLevelSelector.hide()},create:{sliderTable:function(e){var t=r("#level-container").show().children(".pod-body").eq(0),i=n(r("#levelSelectorTemplate").html(),{id:(e?"row":"column")+"LevelSelector",colspan:M.isOLAP()?2:1,name:e?window.layoutManagerLabels.row[M.mode]:window.layoutManagerLabels.column[M.mode]}),a=r(i).appendTo(t);return a.on("mouseover","div.tickOverlay",function(e){var t=r(this).parent();M.dataLevelTooltip.text(t.attr("level-name")),M.dataLevelTooltip.show().position({of:t,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==M.ui.selectorTables.column.css("display")&&M.ui.selectorTables.column.hide().show(),"block"==M.ui.selectorTables.row.css("display")&&M.ui.selectorTables.row.hide().show()}),a.on("mouseover","a.ui-slider-handle",function(e){var t=r(this).parent(),i=t.children("div.sliderTick").eq(t.slider("option","value"));M.dataLevelTooltip.text(i.attr("level-name")),M.dataLevelTooltip.show().position({of:i,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==M.ui.selectorTables.column.css("display")&&M.ui.selectorTables.column.hide().show(),"block"==M.ui.selectorTables.row.css("display")&&M.ui.selectorTables.row.hide().show()}),a.on("mouseout","a.ui-slider-handle, div.tickOverlay",function(e){M.dataLevelTooltip.hide(),"block"==M.ui.selectorTables.column.css("display")&&M.ui.selectorTables.column.hide().show(),"block"==M.ui.selectorTables.row.css("display")&&M.ui.selectorTables.row.hide().show()}),a},slider:function(e,t,i,a){var o={label:!!M.isOLAP()&&{name:i},marginLeft:M.isOLAP()?"24px":0};e.find("tbody").eq(0).append(n(r("#dataLevelSelectorTemplate").html(),o));var l=e.find("div.jrs-slider").last();l.slider({value:a.value,min:0,max:a.max,step:1,range:"min",stop:a.stop,slide:function(e,t){var i=r(t.handle).parent().children("div.sliderTick").eq(t.value);M.dataLevelTooltip.text(i.attr("level-name")),M.dataLevelTooltip.show().position({of:i,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==M.ui.selectorTables.column.css("display")&&M.ui.selectorTables.column.hide().show(),"block"==M.ui.selectorTables.row.css("display")&&M.ui.selectorTables.row.hide().show()}});var d=a.max>0?100/a.max:0;M.isOLAP()||(t.unshift("All"),a.max++);for(var c=0;c<a.max+1;c++)if(t[c]){var o={label:t[c].label||t[c],width:c*d};"All"==o.label&&(o.label="Total"),o.label=s.unescape(o.label);var u=n(r("#sliderTickTemplate").html(),o);l.append(u)}return l}}},init:function(e){M.mediator.register(),M.dataLevelTooltip=r("#dataLevelTooltip"),this.$chartContainer=r(this.chartContainerSelector),this.$nothingToDisplayMessage=r("#nothingToDisplayMessage span.message-text");var t=r("#chartMenu"),i=r("#chartOptions");if(this._containerResizeObserver=new T(this._onContainerResizeEvent.bind(this)),i.appendTo(window.adhocDesigner.ui.canvas).show(),t.appendTo(window.adhocDesigner.ui.canvas),r(n(r("#titleCaptionTemplate").html()),{}).appendTo(window.adhocDesigner.ui.canvas).show(),this.$chartContainer.appendTo(window.adhocDesigner.ui.canvas).show(),!M._chartOptionsMenuHasBeenInitialized){if(i.on("mouseenter",function(){r(this).addClass("over"),t.show().position({of:i,at:"left bottom",my:"left top",offset:"0 -1"})}),t.on("mouseleave",function(){var e=r(event.relatedTarget);i.removeClass("over"),e.is("ul#chartMenu")||t.hide()}),i.on("mouseleave",function(){var e=r(event.relatedTarget);i.removeClass("over"),e.is("ul#chartMenu")||t.hide()}),t.on("mouseenter","p.wrap",function(){r(this).addClass("over")}),t.on("mouseleave","p.wrap",function(){r(this).removeClass("over")}),t.on("click touchend","li",function(){if(r(this).is('[action="chart-format"]')){if(r(this).hasClass("disabled"))return;var e=M.ui.dialogs.formatDialog;e.setState(M.state.chartState),e.open(),window.adhocDesigner.initEnableBrowserSelection(r("#designer")[0])}}),r("#dataLevelSelector .closeIcon").on(f()?"touchstart":"click",function(){M.ui.dialogs.groupSelector.hide()}),M.ui.dialogs={groupSelector:r("#dataLevelSelector")},M.ui.selectorTables={column:M.ui.create.sliderTable(!1),row:M.ui.create.sliderTable(!0)},M.ui.controls.dataLevelSelector.init(),!M.ui.dialogs.formatDialog){var s=new h(M.state.chartState,{parse:!0,updateState:a.bind(M.updateChartState,M)});M.ui.dialogs.formatDialog=new m({model:s})}M._chartOptionsMenuHasBeenInitialized=!0}M.ui.dialogs.groupSelector.hide(),r("#level-container").show()},hide:function(){r("#chartOptions").appendTo("#highChartsRepo").hide(),r("#chartMenu").appendTo("#highChartsRepo").hide(),r("#titleCaption").remove(),this.$chartContainer.appendTo("#highChartsRepo").hide()}}),a.extend(M,{mouseUpHandler:function(e){},mouseDownHandler:function(e){},mouseOverHandler:function(e){},mouseOutHandler:function(e){},mouseClickHandler:function(e){},treeMenuHandler:function(e){var t,i=e.memo.node;"dimensionsTree"===i.treeId?t=i.isParent()?window.adhocDesigner.DIMENSION_TREE_DIMENSION_CONTEXT:window.adhocDesigner.DIMENSION_TREE_LEVEL_CONTEXT:"measuresTree"===i.treeId&&(t=i.isParent()?window.adhocDesigner.MEASURE_TREE_GROUP_CONTEXT:window.adhocDesigner.MEASURE_TREE_CONTEXT),window.adhocDesigner.showDynamicMenu(e.memo.targetEvent,t,null)},lmHandlersMap:{addItems:function(e,t,i){var n=a.uniq(a.map(e,function(e){var t=e.param?e.param.extra.dimensionId:e.extra&&e.extra.dimensionId;return e.dimensionId?e.dimensionId:t})),r=a.map(e,function(e){var t=e.extra?e.extra.id:e.param&&e.param.extra.id;return t||e.id}),s=e[0].extra&&"isMeasure"in e[0].extra?e[0].extra.isMeasure:null,o=e[0].param&&"isMeasure"in e[0].param.extra?e[0].param.extra.isMeasure:null,l="isMeasure"in e[0]?e[0].isMeasure:s||o,d=window.localContext.isOlapMode();M.insertDimensionInAxisWithChild({dim:l?n.slice(0,1):n,axis:i,pos:t,child:d||l?r:null,hierarchyName:e[0].hierarchyName})},measureReorder:function(e,t){M.moveMeasure(e,t)},column:{addItem:function(e,t,i,n,r,a,s){M.insertDimensionInAxisWithChild({dim:e,axis:"column",pos:t,child:window.localContext.isOlapMode()||r?i:null,measure_pos:n,isMeasure:r,uri:a,hierarchyName:s})},removeItem:function(e,t){e.isMeasure?M.removeMeasure(t):M.hideColumnLevel(e.dimensionId,e.level)},moveItem:function(e,t,i){M.moveDimension(e,"column","column",t,i)},switchItem:function(e,t,i){M.moveDimension(e,"row","column",t,i)},contextMenu:function(e,t){M.selectFromDisplayManager(t.targetEvent,t.extra,p.COLUMN_GROUP_MENU_LEVEL),D.setSelected([t.extra]),M.showMenu(t.targetEvent,"displayManagerColumn")}},row:{addItem:function(e,t,i,n,r,a,s){M.insertDimensionInAxisWithChild({dim:e,axis:"row",pos:t,child:window.localContext.isOlapMode()||r?i:null,measure_pos:n,isMeasure:r,uri:a,hierarchyName:s})},removeItem:function(e,t){e.isMeasure?M.removeMeasure(t):M.hideRowLevel(e.dimensionId,e.level)},moveItem:function(e,t,i){M.moveDimension(e,"row","row",t,i)},switchItem:function(e,t,i){M.moveDimension(e,"column","row",t,i)},contextMenu:function(e,t){M.selectFromDisplayManager(t.targetEvent,t.extra,p.ROW_GROUP_MENU_LEVEL),D.setSelected([t.extra]),M.showMenu(t.targetEvent,"displayManagerRow")}}}}),a.extend(M,{insertDimensionInAxisWithChild:function(e){e&&(e.dim&&(e.dim=p.encodeParam(e.dim)),e.child&&(e.child=p.encodeParam(e.child)),e.hierarchyName&&(e.hierarchyName=p.encodeParam(e.hierarchyName)),e.uri&&(e.uri=p.encodeParam(e.uri))),M.flush(),p.sendRequest("ich_insertDimensionInAxisWithChild",e,M.standardOpCallback,{bPost:!0})},removeMeasure:function(e){p.sendRequest("ich_removeMeasure",new Array("i="+e),M.standardOpCallback,null)},moveDimension:function(e,t,i,n,r){p.sendRequest("ich_moveDimension",{dim:encodeURIComponent(e),axisFrom:t,axisTo:i,f:n,t:r},M.standardOpCallback,null)},hideRowLevel:function(e,t){p.sendRequest("ich_hideRowLevel",new Array("f="+_(e),"level="+_(t)),M.standardOpCallback,null)},hideColumnLevel:function(e,t){var i=function(i){M.standardOpCallback(i);var n=M.getLevelObject(t,e,"column");n&&n.propertyMap&&"true"==n.propertyMap.lastFilteredLevel&&g.systemConfirm.show(window.adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3)};p.sendRequest("ich_hideColumnLevel",new Array("f="+_(e),"level="+_(t)),i,null)},expandAllLevels:function(){M.debug&&console.log("AIC.expandAllLevels:  sending expandAll query, this may take some time"),M.cache=[],M.hasAllData=!0,p.sendRequest("ich_expandAllLevels",null,M.standardOpCallback,null)},switchToColumnGroup:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup(),i=a.isNumber(e)?e:t.groupIndex;p.sendRequest("ich_switchToColumnGroup",new Array("i="+i),M.standardOpCallback,null)},switchToRowGroup:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup(),i=a.isNumber(e)?e:t.groupIndex;p.sendRequest("ich_switchToRowGroup",new Array("i="+i),M.standardOpCallback,null)},moveRowGroup:function(e,t,i){var n=function(e){M.standardOpCallback(e),i&&i()};p.sendRequest("ich_moveRowGroup",new Array("f="+e,"t="+t),n,null)},moveColumnGroup:function(e,t,i){var n=function(e){M.standardOpCallback(e),i&&i()};p.sendRequest("ich_moveColumnGroup",new Array("f="+e,"t="+t),n,null)},moveMeasure:function(e,t){p.sendRequest("ich_moveMeasureByName",["measure="+_(e),"to="+t],M.standardOpCallback,null)},updateChartState:function(e){r.extend(M.state.chartState,e);var t=function(e){if(!e)throw"No response received on save chart state request";M.standardOpCallback(e)};p.sendRequest("ich_updateChartState",["chartState="+encodeURIComponent(Object.toJSON(M.state.chartState))],t,null)},setCategoryForRowGroup:function(e,t){var i=function(e){M.standardOpCallback(e)};p.sendRequest("ich_setRowGroupCategorizer",new Array("cat="+_(e),"i="+t),i,null)},setCategoryForColumnGroup:function(e,t){var i=function(e){M.standardOpCallback(e)};p.sendRequest("ich_setColumnGroupCategorizer",new Array("cat="+_(e),"i="+t),i,null)},setSummaryFunction:function(e,t){p.sendRequest("ich_setSummaryFunction",new Array("f="+_(e),"i="+t),M.standardOpCallback,null)},setSummaryFunctionAndMask:function(e,t,i){p.sendRequest("cr_setSummaryFunctionAndDataMask",new Array("f="+_(e),"m="+_(t),"i="+i),M.standardOpCallback,null)},setSummaryTimeFunction:function(e,t){p.sendRequest("ich_setSummaryTimeFunction",new Array("f="+_(e),"i="+t),M.standardOpCallback,null)},setHideEmptyRows:function(){p.sendRequest("ich_setProperty",new Array("name=hideEmptyRows","value=true"),M.standardOpCallback,null)},setUnhideEmptyRows:function(){p.sendRequest("ich_setProperty",new Array("name=hideEmptyRows","value=false"),M.standardOpCallback,null)},updateViewCallback:function(e){M.standardOpCallback(e)}}),a.extend(M,{fieldsAtLevel:function(){var e=[],t=window.selObjects.first(),i=M.isOLAP()?[t.param.extra.dimensionId]:window.adhocDesigner.getAllLeaves(t).map(function(e){return e.param.extra.dimensionId}),n=i.inject([],function(e,t){return e.concat(M.getLevelsFromDimension(t,"column")||[])}),r=i.inject([],function(e,t){return e.concat(M.getLevelsFromDimension(t,"row")||[])});return e.push(n,r),e},canSaveReport:function(){return M.state.canSave},hideEmptyRowsEquals:function(e){return M.state.crosstabState.hideEmptyRows===e},canAddFilter:function(e,t){var i,n;if(window.localContext.isOlapMode()&&(i=A(e.isMeasure)?e.isMeasure:e.param.extra&&e.param.extra.isMeasure,n=window.localContext._isAddingFilterDuplicate(e)),i)return t&&t.push(window.addFilterErrorMessageMeasureAdd),!1;var r=e.param?e.param.extra&&e.param.extra.id:e.level;return r&&0===r.indexOf(window.localContext.ALL_LEVEL_NAME)?(t&&t.push(window.addFilterErrorMessageAllLevelAdd),!1):e.isParent&&e.isParent()?(t&&t.push(window.addFilterErrorMessageGroupAdd),!1):e.param&&window.localContext.fromSiblingHierarchy(e.param.extra.hierarchyName,e.param.extra.dimensionId)?(t&&t.push(window.addFilterErrorMessageAnotherHierarchy),!1):window.adhocDesigner.isSpacerSelected(e)?(t&&t.push(window.addFilterErrorMessageSpacerAdd),!1):window.adhocDesigner.isPercentOfParentCalcSelected(e)?(t&&t.push(window.addFilterErrorMessagePercentOfParentCalcFieldAdd),!1):window.adhocDesigner.isConstantSelected(e)?(t&&t.push(window.addFilterErrorMessageConstantAdd),!1):!n||(t&&t.push(window.addFilterErrorMessage),!1)},canAddSliceFilter:function(){var e=window.selObjects.find(function(e){return!e.isSliceable});return window.selObjects.first()&&!e},_isAddingFilterDuplicate:function(e){var t;return t=e.param?"["+e.param.extra.dimensionId+"].["+e.param.extra.id+"]":"["+e.dimensionId+"].["+e.level+"]",window.adhocDesigner.filtersController.hasFilterForField(t)},isDateType:function(){return M.isDateTimeType("date")},isTimestampType:function(){return M.isDateTimeType("timestamp")},isTimeType:function(){return M.isDateTimeType("time")},isDateTimeType:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup();if(t){var i=M.isGroupSelected(t),n=C.getSelectedGroup(t);if(n){var r=!0===n.canReBucket,a=n.type===e;return i&&r&&a}}return!1},isGroupSelected:function(e){return!e.isMeasure},isCurrentDateType:function(e){var t=C.getSelectedGroup(window.adhocDesigner.getSelectedColumnOrGroup());return!!t&&t.categorizerName==e},canMoveUpOrLeft:function(){var e=window.adhocDesigner.getSelectedColumnOrGroup();return M.getSelectedDimensionIndex(e)>0},canMoveDownOrRight:function(){var e=window.adhocDesigner.getSelectedColumnOrGroup();return M.getSelectedDimensionIndex(e)<M.getDimensions(e.axis).length-1},canAddSiblingLevels:function(){return!0},canSwitchToRow:function(){var e=window.adhocDesigner.getSelectedColumnOrGroup();return!M.isOLAP()||M.getDimensions(e.axis).length>1},canAddDimensionAsRowGroup:function(e){var t=window.selObjects.first();t.hasChilds()||(t=t.parent);var i=S.trees[t.getTreeId()],n=window.adhocDesigner.getAllLeaves(t,i),r=window.adhocDesigner.getAllLeaves(t,i).collect(function(e){return e.param.extra.id});if(M.isOLAP()){var s=a.pluck(M.getFilteredList(),"name"),o=e&&a.intersection([e[0].name],s).length;if(0===M.getDimensions("column").length||e&&e[0].isMeasure&&o)return!1;var l=t.param.id,d=t.param.extra&&t.param.extra.isHierarchy,c=t.param.extra&&t.param.extra.isHierarchy&&t.param.extra.id,u=M.getLevelsFromDimension(l,"column"),h=M.getLevelsFromDimension(l,"row"),m=window.localContext.fromSiblingHierarchy(c,l);return 0===u.length&&(d&&m||h.length<t.getChildCount())}if(n[0].param.extra.isMeasure){return 0===M.getFilteredMeasureList("column").length}var p=a.pluck(M.getFilteredList(),"name"),g=M.fieldsAtLevel();return g[0].length>0?a.difference(r,p).length>0||C.isDateField(e[0]):0===g[0].length&&(0===g[1].length||window.localContext.isNonOlapMode()&&e&&(e[0].isMeasure||C.isDateField(e[0]))||e&&!a.contains(g[1],e[0].name))},canAddDimensionAsColumnGroup:function(e){var t=window.selObjects.first(),i=S.trees[t.getTreeId()],n=window.adhocDesigner.getAllLeaves(t,i);if(t.hasChilds()||(t=t.parent),M.isOLAP()){var r=a.pluck(M.getFilteredList(),"name"),s=e&&a.intersection([e[0].name],r).length;if(e&&e[0].isMeasure&&s)return!1;var o=t.param.id,l=t.param.extra&&t.param.extra.isHierarchy,d=t.param.extra&&t.param.extra.isHierarchy&&t.param.extra.id,c=M.getLevelsFromDimension(o,"column"),u=M.getLevelsFromDimension(o,"row"),h=window.localContext.fromSiblingHierarchy(d,o);return 0===u.length&&(l&&h||c.length<t.getChildCount())}if(n[0].param.extra.isMeasure){return 0===M.getFilteredMeasureList("row").length}var m=M.fieldsAtLevel();return 0===m[1].length&&(0===m[0].length||window.localContext.isNonOlapMode()&&e&&(e[0].isMeasure||C.isDateField(e[0]))||e&&!a.contains(m[0],e[0].name))},canAddLevelAsColumnGroup:function(){var e=window.selObjects.first(),t=M.isOLAP()?[e.param.extra.dimensionId]:window.adhocDesigner.getAllLeaves(e).map(function(e){return e.param.extra.dimensionId
}),i=t.inject([],function(e,t){return e.concat(M.getLevelsFromDimension(t,"column")||[])});return 0===t.inject([],function(e,t){return e.concat(M.getLevelsFromDimension(t,"row")||[])}).length&&(0===i.length||!M.isOLAP()&&e&&e.param.extra&&(e.param.extra.isMeasure||M.isDateField(e.param.extra))||!i.find(function(e){return a.contains(a.map(p.getSelectedObjects(),function(e){return e.param.extra&&e.param.extra.id}),e)}))},canAddLevelAsRowGroup:function(){if(0===M.getDimensions("column").length&&M.isOLAP())return!1;var e=window.selObjects.first();if(!e)return!1;var t=M.isOLAP()?[e.param.extra.dimensionId]:window.adhocDesigner.getAllLeaves(e).map(function(e){return e.param.extra.dimensionId}),i=t.inject([],function(e,t){return e.concat(M.getLevelsFromDimension(t,"column")||[])}),n=t.inject([],function(e,t){return e.concat(M.getLevelsFromDimension(t,"row")||[])});return!!e.param.extra&&(0===i.length&&(0===n.length||!M.isOLAP()&&e&&e.param.extra&&(e.param.extra.isMeasure||M.isDateField(e.param.extra))||!n.find(function(t){return e.param.extra&&e.param.extra.id===t})))},isRowGroupSelected:function(e){return"row"===e.axis&&!e.isMeasure},isColumnGroupSelected:function(e){return"column"===e.axis&&!e.isMeasure},showAddHierarchyConfirm:function(e,t,i){return!!M.fromSiblingHierarchy(e,t)&&(window.adhocDesigner.addConfirmDialog.show({ok:function(){if(M.isFiltersApplied(t))return void g.systemConfirm.show(window.adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3);i()}}),!0)},isFiltersApplied:function(e,t){var i=a.pluck(M.getLevelObjectsFromDimension(e,t),"levelUniqueName"),n=a.pluck(M.state.existingFilters,"name");return!a.isEmpty(a.intersection(i,n))},isDateField:function(e){return"Timestamp"===e.type||"Date"===e.type||"Time"===e.type}}),a.extend(M,{removeLevelFromColumn:function(){var e=window.selObjects.first();r("#"+window.adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:removeItem",{axis:"column",index:e.index,item:{level:e.level,dimensionId:e.dimensionId,isMeasure:e.isMeasure}})},removeLevelFromRow:function(){var e=window.selObjects.first();r("#"+window.adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:removeItem",{axis:"row",index:e.index,item:{level:e.level,dimensionId:e.dimensionId,isMeasure:e.isMeasure}})},moveRowGroupLeft:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup(),i=M.getSelectedDimensionIndex(t),n=i-1;M.moveRowGroup(i,n,e)},moveRowGroupRight:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup(),i=M.getSelectedDimensionIndex(t),n=i+1;M.moveRowGroup(i,n,e)},moveColumnGroupLeft:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup(),i=M.getSelectedDimensionIndex(t),n=i-1;M.moveColumnGroup(i,n,e)},moveColumnGroupRight:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup(),i=M.getSelectedDimensionIndex(t),n=i+1;M.moveColumnGroup(i,n,e)},appendDimensionWithLevel:function(e,t,i){var n=e||M.getAvailableFieldsNodeBySelection();n.axis=i,M.showAddHierarchyConfirm(n.hierarchyName,n.dimensionId,function(){r("#"+window.adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItem",n)})||(e?window.localContext.lmHandlersMap.addItems(n,t,i):r("#"+window.adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItem",n))},appendDimensionToRowAxisWithLevel:function(e,t,i){M.appendDimensionWithLevel(t,i,"row")},appendDimensionToColumnAxisWithLevel:function(e,t,i){M.appendDimensionWithLevel(t,i,"column")},appendMeasureToRow:function(e){var t=e?M.getAvailableFieldsNodesBySelection(e):M.getAvailableFieldsNodesBySelection();r("#"+window.adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItems",{axis:"row",levels:t,index:t[0].index})},appendMeasureToColumn:function(e){var t=e?M.getAvailableFieldsNodesBySelection(e):M.getAvailableFieldsNodesBySelection();r("#"+window.adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItems",{axis:"column",levels:t,index:t[0].index})},showMenu:function(e,t){var i,n=null;switch(t){case"displayManagerRow":i="displayManagerRow",n=M.generateAvailableSummaryCalculationsMenu;break;case"displayManagerColumn":i="displayManagerColumn",n=M.generateAvailableSummaryCalculationsMenu;break;case"groupMember":i=p.MEMBER_GROUP_MENU_LEVEL,n=M.updateContextMenuWithSiblingLevels;break;case"measuresDimensionRow":i="measuresDimensionInRows";break;case"measuresDimensionColumn":i="measuresDimensionInColumns";break;case"rowGroup":i=p.ROW_GROUP_MENU_LEVEL;break;case"columnGroup":i=p.COLUMN_GROUP_MENU_LEVEL;break;case"measureRow":i="measureRow";break;case"measureColumn":i="measureColumn"}window.adhocDesigner.showDynamicMenu(e,i,null,n)},generateAvailableSummaryCalculationsMenu:function(e,t){if(!D.selObjects[0].isMeasure)return t;var i=a.find(t,function(e){return"AdHocCrosstab.selectedMeasureShowsSummaryOptions"===e.clientTest});if(i){var n=D.selObjects[0],r=a.findWhere(M.state.measures,{name:n.name});r&&window.adhocDesigner.generateAvailableSummaryCalculationsMenu(r.fieldName,i,{action:O.selectFunction,isSelectedTest:C.isSelectedSummaryFunction})}return t},setCatForColumnGroup:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup();t&&M.isColumnGroupSelected(t)&&M.setCategoryForColumnGroup(e,t.groupIndex)},setCatForRowGroup:function(e){var t=window.adhocDesigner.getSelectedColumnOrGroup();t&&M.isRowGroupSelected(t)&&M.setCategoryForRowGroup(e,t.groupIndex)},selectFunction:function(e){var t=C.getSelectedMeasure();if(t){var i=window.selObjects.first().index,n=window.adhocDesigner.getSuperType(t.type),r=C.getMeasureTypeByFunction(e);n!==r?M.setSummaryFunctionAndMask(e,window.defaultMasks[r],i):M.setSummaryFunction(e,i)}},selectTimeFunction:function(e){var t=C.getSelectedMeasure();if(t){var i=window.selObjects.first().index;window.adhocDesigner.getSuperType(t.type),C.getMeasureTypeByFunction(e);M.setSummaryTimeFunction(e,i)}}}),a.extend(M,{getDimensions:function(e){var t=M.state.crosstabState;return e?t[e+"Groups"]:a.chain(t).filter(function(e,t){return t.search(/Groups$/)>=0}).flatten().value()},getLevelsFromDimension:function(e,t){return a.pluck(this.getLevelObjectsFromDimension(e,t),"name")},getLevelObjectsFromDimension:function(e,t){var i=this.getDimensions(t);return e=a.find(i,function(t){return t.name===e}),e?a.chain(e.levels).filter(function(e){return e.visible}).map(function(e){return a.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return!e.isSpacer}).value():[]},getLevelObject:function(e,t,i){function n(e,t){return a.find(e,function(e){return e.name==t})}var r=this.getDimensions(i),s=n(r,t);return s?n(s.levels,e):null},getFilteredList:function(e,t){var i=e||null,n=t||{};return 1===arguments.length&&a.isObject(e)&&(n=e,i=null),n.visible=!0,a.chain(M.getDimensions(i)).pluck("levels").flatten().map(function(e){return a.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return a.all(n,function(t,i){return void 0===e[i]||e[i]===t})}).value()},getFilteredMeasureList:function(e,t){var i=e||null,n=t||{};return 1===arguments.length&&a.isObject(e)&&(n=e,i=null),M.getFilteredList(i,a.extend(n,{measure:!0,measuresLevel:!0}))},fromSiblingHierarchy:function(e,t,i){if(!e)return!1;var n=this.getLevelsFromDimension(t,i);return n.length>0&&-1===n[0].indexOf("["+e+"]")},getHierarchy:function(e){var t=e.param.extra;return e.hasChilds()?(e.getFirstChild().hasChilds()&&(t=e.getFirstChild().param.extra),t&&t.isHierarchy?t.id:void 0):t.hierarchyName},getAvailableFieldsNodeBySelection:function(e,t,i){var n={};if(i||(i=window.selObjects.first()),window.selectionCategory.area==p.AVAILABLE_FIELDS_AREA)i.hasChilds()?(n.isMeasure="measuresTree"===i.treeId,n.dimensionId=n.isMeasure?i.treeId:i.param.id,n.uri=window.localContext.isNonOlapMode()?i.param.uri:void 0,n.level=null):(n.isMeasure=!!i.param.extra.isMeasure,n.level=i.param.extra.dimensionId&&i.param.id,n.dimensionId=i.param.extra.dimensionId||i.param.extra.id),n.hierarchyName=this.getHierarchy(i),n.index=-1;else if(window.selectionCategory.area==p.ROW_GROUP_MENU_LEVEL||window.selectionCategory.area==p.COLUMN_GROUP_MENU_LEVEL)if(e||t){var r=/.*\[(.*)\]/.exec(e),a=r&&r[1];n.isMeasure=!t,n.level=e,n.dimensionId=n.isMeasure?window.adhocDesigner.MEASURES:t,n.index=-1,n.hierarchyName=a}else{if(!i.axis)return void alert("Need a way to get dimension name for clicked level from crosstab");n=i}return n},getAvailableFieldsNodesBySelection:function(e,t){for(var i=[],n=0;n<window.selObjects.length;n++)i.push(M.getAvailableFieldsNodeBySelection(e,t,window.selObjects[n])),i[n].extra=i[n],i[n].dimensionId=i[n].dimensionId,i[n].id=i[n].level;return i},updateContextMenuWithSiblingLevels:function(e,t){if(!window.adhocDesigner.ui.display_manager)return t;var i=t.find(function(e){return"AdHocCrosstab.canAddSiblingLevels"===e.clientTest});if(!i)return t;var n=null,r=null,s=null,o=window.selObjects[0],l=/.*\[(.*)\]/.exec(o.level),d=l&&l[1];if(window.selObjects.first().isMeasure)r=window.adhocDesigner.measuresTree.getRootNode(),s="row"===window.selObjects.first().axis?"AdHocCrosstab.appendMeasureToRow":"AdHocCrosstab.appendMeasureToColumn";else{if(!M.isOLAP())return window.selObjects.first().index=0,t;r=window.adhocDesigner.dimensionsTree.getRootNode().childs.find(function(e){return e.param.extra.id===window.selObjects.first().dimensionId}),r.childs[0].param.extra.isHierarchy&&(r=a.find(r.childs,function(e){return e.param.extra.id===d})),s="row"===window.selObjects.first().axis?"AdHocCrosstab.appendDimensionToRowAxisWithLevel":"AdHocCrosstab.appendDimensionToColumnAxisWithLevel"}if(void 0===window.selObjects.first().allLevels){var c=window.selObjects.first();c.allLevels=C.state.getLevelsFromDimension(window.selObjects.first().dimensionId,c.axis),c.index=c.allLevels.indexOf(c.level)}return window.selObjects.first().allLevels&&(n=M.isOLAP()?r.childs.findAll(function(e){return!window.selObjects.first().allLevels.include(e.param.extra.id)}):window.adhocDesigner.getAllLeaves(r,window.adhocDesigner.measuresTree).findAll(function(e){return!window.selObjects.first().allLevels.include(e.param.extra.id)})),n&&0!==n.length?(i.text=window.adhocDesigner.getMessage(window.selObjects.first().isMeasure?"addMeasures":"addLevels"),i.children=n.collect(function(e){return D.createMenuElement("optionAction",{text:e.name,action:s,actionArgs:window.selObjects.first().isMeasure?[e.param.extra.id]:[{id:e.param.extra.id,groupId:e.param.extra.dimensionId,isMeasure:!1}]})}),t):t},getSelectedDimensionIndex:function(e){var t;if(e){var i=e.isMeasure?window.adhocDesigner.MEASURES:e.dimensionId;t=-1,a.find(M.getDimensions(e.axis),function(e,n){if(e.name===i)return t=n,!0})}return t}}),a.extend(M,{selectFromDisplayManager:function(e,t,i){p.unSelectAll();var n=window.adhocDesigner.isMultiSelect(e,i);window.selectionCategory.area=i;var r=window.adhocDesigner.isAlreadySelected(t);window.adhocDesigner.addSelectedObject(e,t,n,r),Event.stop(e)},deselectAllSelectedOverlays:function(){}}),a.extend(M,{standardOpCallback:function(e){e?window.adhocDesigner.updateStateAndRender(e):window.console&&console.log("Internal server error occurred")}}),r(window).on("resizeEnd",function(){window.localContext.getMode()!==p.ICHART&&window.localContext.getMode()!==p.OLAP_ICHART||window.localContext.resize()}),r("#designer").bind({"rendering:done":function(){window.localContext.getMode()!==p.ICHART&&window.localContext.getMode()!==p.OLAP_ICHART||M.fixFirstRendering()}}),window.AdhocIntelligentChart=O,window.AIC=O,i.exports=O});