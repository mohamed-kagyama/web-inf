/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","bundle!adhoc_messages","../view/AdvancedPropertyView","../model/AdvancedPropertyModel","../view/EditAdvancedPropertyView","runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","../collection/AdvancedPropertiesCollection","text!../template/AdvancedSectionTemplate.htm","css!attributes.css"],function(e,t,i){var n=e("underscore"),o=e("jquery"),s=e("backbone"),r=e("bundle!adhoc_messages"),c=e("../view/AdvancedPropertyView"),d=e("../model/AdvancedPropertyModel"),l=e("../view/EditAdvancedPropertyView"),a=e("runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog"),h=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),u=e("../collection/AdvancedPropertiesCollection"),m=e("text!../template/AdvancedSectionTemplate.htm");e("css!attributes.css"),i.exports=s.View.extend({className:"advancedSection",template:n.template(m),initialize:function(){this._subviews=[],this.collection=new u,this.confirmationDialog=new a,this.listenTo(this.collection,"add",this.addAdvancedPropertyView),this.listenTo(this.collection,"reset",this.onCollectionReset),this.listenTo(this.collection,"validation:invalid",this.onCollectionValidationError),this.listenTo(this.collection,"validation:valid",this.onCollectionValid),this.listenTo(s,"advancedProperty:delete",this.onDelete),this.render()},events:{"click .addNewItem":"addNewItem"},render:function(){return this.$el.html(this.template({i18n:r})),this},calculateZIndexes:function(){setTimeout(function(){o("#chartFormatDialog").css("z-index",+o("#dialogDimmer").css("z-index")-1),o("#chartTypeSelector").css("z-index",+o("#dialogDimmer").css("z-index")-2)},0)},reset:function(e){this.collection.reset(e)},toJSON:function(){return this.collection.toJSON()},resetState:function(){this.isEditing=!1,this.showAddBtn(),this._currentPropertyView&&this._currentPropertyView.$el.show(),this._currentPropertyView=null,this._currentEditPropertyView&&this._currentEditPropertyView.remove(),this._currentEditPropertyView=null},renderAdvancedProperty:function(e){var t=new c({model:e});return this.$("tbody").append(t.$el),this.listenTo(t,"edit",this.onEdit),t},addAdvancedPropertyView:function(e){var t=this.renderAdvancedProperty(e);this._subviews.push(t)},showAddBtn:function(){this.$(".addNewItem").show()},hideAddBtn:function(){this.$(".addNewItem").hide()},onEdit:function(e){var t=this;this.isEditing?(this.confirmationDialog.setContent(r.ADH_1214_ICHARTS_CHART_FORMAT_DIALOG_STOP_EDITING),this.confirmationDialog.open(),this.calculateZIndexes(),this.listenToOnce(this.confirmationDialog,"button:yes",function(){t.showEditAdvancedPropertyView(e)})):this.showEditAdvancedPropertyView(e)},onCancel:function(e,t,i){t.set(i),this.removeEditAdvancedPropertyView()},onCollectionReset:function(){n.invoke(this._subviews,"remove"),this.collection.each(this.addAdvancedPropertyView,this)},onCollectionValid:function(){this.removeEditAdvancedPropertyView()},onCollectionValidationError:function(e,t,i){var n,o=this;i.message===e.validationMessages.DUPLICATE_MODEL_EDIT?(n=new h({message:r.ADH_1214_ICHARTS_CHART_FORMAT_DIALOG_PROPERTY_ALREADY_EXISTS_NO_OVERRIDE.replace("{0}",t.get("name"))}),this.listenToOnce(n,"button:close",function(){n.remove()}),n.open(),this.calculateZIndexes()):i.message===e.validationMessages.DUPLICATE_MODEL_ADD&&(this.confirmationDialog.setContent(r.ADH_1214_ICHARTS_CHART_FORMAT_DIALOG_PROPERTY_ALREADY_EXISTS.replace("{0}",t.get("name"))),this.confirmationDialog.open(),this.calculateZIndexes(),this.listenToOnce(this.confirmationDialog,"button:yes",function(){e.get(t).set({value:t.get("value")}),o.removeEditAdvancedPropertyView()}).listenToOnce(this.confirmationDialog,"button:no",function(){o.stopListening(o.confirmationDialog)}))},onSaveItem:function(e,t){this.collection.add(t)},onDelete:function(e,t){var i=this;this.confirmationDialog.setContent(r.ADH_1214_ICHARTS_CHART_FORMAT_DIALOG_CONFIRM_DELETE_PROPERTY.replace("{0}",t.get("name"))),this.confirmationDialog.open(),this.calculateZIndexes(),this.listenToOnce(this.confirmationDialog,"button:yes",function(){t.trigger("destroy",t),i._subviews=n.reject(i._subviews,function(t){return e===t})}),this.listenToOnce(this.confirmationDialog,"button:no",function(){i.stopListening(i.confirmationDialog)})},addNewItem:function(){this.showEditAdvancedPropertyView()},scrollTo:function(e){var t=o(".table-container");t.animate({scrollTop:e.position().top+t.scrollTop()-29},1e3),e.find("input:first").focus()},showEditAdvancedPropertyView:function(e){var t=e?new l({model:e.model},{editMode:!0}):new l({model:new d});this.listenTo(t,"add edit",this.onSaveItem).listenTo(t,"cancel",this.onCancel),this._currentEditPropertyView&&this._currentEditPropertyView.remove(),this.isEditing=!0,this.hideAddBtn(),this._currentEditPropertyView=t,e?(this._currentPropertyView&&this._currentPropertyView.$el.show(),this._currentPropertyView=e,t.$el.insertAfter(e.$el),e.$el.hide()):this.$("tbody").append(t.$el),this.scrollTo(t.$el)},removeEditAdvancedPropertyView:function(){this._currentEditPropertyView&&(this.stopListening(this._currentEditPropertyView),this._currentEditPropertyView.remove(),this._currentEditPropertyView=null),this.showAddBtn(),this.isEditing=!1,this._currentPropertyView&&(this._currentPropertyView&&this._currentPropertyView.$el.show(),this._currentPropertyView=null)},remove:function(){n.invoke(this._subviews,"remove"),s.View.prototype.remove.call(this)}})});