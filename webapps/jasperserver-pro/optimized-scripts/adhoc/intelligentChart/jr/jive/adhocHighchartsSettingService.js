/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter","runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter/adhocDataProcessor"],function(e,a,t){function r(e,a,t,r){a.events[e.toLowerCase()]&&(t.point.events[e]=function(s){var c=u.getHyperlink(t,this,r.queryData.metadata.isOLAP,r.queryData.metadata);n(c,e,t.chartType,r)&&a.events[e.toLowerCase()].call(this,c,s)})}function n(e,a,t,r){var n=!0;return"treemap"===t&&"click"===a.toLowerCase()&&(n=c.reduce(r.chartState.rowsSelectedLevels,function(a,t){return!c.isUndefined(e.parameters[t.name])&&a},!0)),n}var s=e("jquery"),c=e("underscore"),i=e("runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter"),o=e("runtime_dependencies/bi-adhoc/src/adhoc/api/chart/adhocToHighchartsAdapter/adhocDataProcessor"),u={perform:function(e,a,t){var n=a.chartState,h=a.extraOptions;if(a.chartType&&(n.chartType=a.chartType),h){var p=s("#"+a.chartContainerId);p.length&&(h.width=p.parent().width(),h.height=p.parent().height()||400)}var m=JSON.parse(JSON.stringify(a.queryData)),d=JSON.parse(JSON.stringify(n));o.load(m),o.messages=h.messages,s.extend(e,i.generateOptions(m,d,h)),t&&t.events&&t.events&&("timeseries_heatmap"===e.series[0].chartType&&(e.chart.events||(e.chart.events={}),t.events.click&&(e.chart.events.click=function(e){var r=this.hoverPoint,n=r.series.options;t.events.click.call(this,u.getHyperlink(n,r,a.queryData.metadata.isOLAP),e)})),c.forEach(e.series,function(e){e.cursor="pointer",e.point||(e.point={}),e.point.events={},"timeseries_heatmap"!==e.chartType&&r.call(this,"click",t,e,a),r.call(this,"mouseOver",t,e,a),r.call(this,"mouseOut",t,e,a)}))},getOutputParams:function(e,a,t){var r=[];if(e.columnsOutputParams&&(r=r.concat(e.columnsOutputParams)),a.rowsOutputParams&&(r=r.concat(a.rowsOutputParams)),"heatmap"===e.chartType&&e.heatmapXCategories&&(r[0].value=e.heatmapXCategories[a.x]),"treemap"===e.chartType&&t){var n=2===t.measures.length?a.name:a.id;r=c.map(c.compact(n.split("/@#/")),function(e,a){return{value:e,name:t.axes[0][a]}})}return r},getHyperlink:function(e,a,t,r){return{type:"AdHocExecution",parameters:c.reduce(u.getOutputParams(e,a,r),function(e,a){return t&&"Measures"!==a.name.dimension?e["["+a.name.dimension+"]"+a.name.name]=a.value:"Measures"===a.name.name||"MeasuresLevel"===a.name.name?e[a.name.name]=c.isArray(a.value)?a.value:[a.value]:e[a.name.name]=a.value,e},{})}}};t.exports=u});