/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","./designer","underscore","runtime_dependencies/js-sdk/src/common/util/xssUtil","runtime_dependencies/jrs-ui/src/core/core.layout","../base/designer.base","runtime_dependencies/jrs-ui/src/components/components.dialogs","./crosstab.root","./table.init","runtime_dependencies/jrs-ui/src/util/utils.common","./crosstab.multiselect","jquery","runtime_dependencies/jrs-ui/src/core/core.events.bis","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","./intelligentChart/adhocIntelligentChart"],function(e,n,o){var t=e("prototype"),i=t.$,s=e("./designer"),a=e("underscore"),l=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),d=e("runtime_dependencies/jrs-ui/src/core/core.layout"),r=e("../base/designer.base"),c=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),u=e("./crosstab.root"),m=(e("./table.init"),e("runtime_dependencies/jrs-ui/src/util/utils.common")),v=m.isSupportsTouch,h=m.matchAny,E=m.isRightClick,b=m.getBoxOffsets,w=e("./crosstab.multiselect"),p=e("jquery"),_=e("runtime_dependencies/jrs-ui/src/core/core.events.bis"),C=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"),T=e("./intelligentChart/adhocIntelligentChart"),A=T;s.observePointerEvents=function(){document.observe(d.ELEMENT_CONTEXTMENU,s.contextMenuHandler),p("#dataSizeSelector").change(function(){s.toggleAdhocDataSetSize(p(this).val())}).val(),p("#changeVisualizationButton").click(function(){s.ui.visualizationChooser.show()}),Event.observe(document.body,v()?"touchend":"click",function(e){var n=e.element();h(n,["li.node","li.leaf","ul#"+s.MEASURES_TREE_DOM_ID,"ul#"+s.DIMENSIONS_TREE_DOM_ID],!0)||(this.unSelectAvailableTreeNodes(),v()&&(window.localContext.clickid==n.identify()&&e.timeStamp-window.localContext.clicktime<700&&(e.isEmulatedRightClick=!0,document.fire(d.ELEMENT_CONTEXTMENU,{targetEvent:e,node:n})),window.localContext.clicktime=e.timeStamp,window.localContext.clickid=n.identify()));var o=h(n,[this.CANVAS_PATTERN,d.MENU_LIST_PATTERN,this.COLUMN_OVERLAY_PATTERN,this.SUMMARY_OVERLAY_PATTERN,this.ROW_GROUP_OVERLAY_PATTERN,this.COLUMN_GROUP_OVERLAY_PATTERN,this.ROW_GROUP_OVERLAY_PATTERN,this.COLUMN_GROUP_OVERLAY_PATTERN,this.XTAB_MEASURE_HEADER_OVERLAY_PATTERN,this.XTAB_MEASURE_OVERLAY_PATTERN,this.XTAB_GROUP_HEADER_PATTERN,this.ROW_GROUP_MEMBER_PATTERN,this.COLUMN_GROUP_MEMBER_PATTERN,this.XTAB_GROUP_HEADER_OVERLAY_PATTERN,this.GROUP_OVERLAY_PATTERN,this.MENU_PATTERN,this.FILTER_OPERATOR_MENU_PATTERN,this.FILTER_ITEM_MENU_PATTERN,this.FILTER_GENERAL_MENU_PATTERN],!0);o||(window.localContext.getMode()===r.CROSSTAB&&w&&w.deselectAllGroupMembers(),window.localContext.getMode()!==r.TABLE&&window.localContext.getMode()!==r.CROSSTAB&&window.localContext.getMode()!==r.CHART||window.localContext.deselectAllSelectedOverlays()),!E(e)&&!e.isEmulatedRightClick&&!o&&C.hideMenu()}.bind(s))},s.switchModeEventCheck=function(e){if(e.columnGroups&&e.columnGroups.length>0)for(var n=0;n<e.columnGroups.length;n++)if("NULL Dimension"!==e.columnGroups[n].dimensionName&&!1===e.columnGroups[n].isShowingSummary)return!1;if(e.rowGroups&&e.rowGroups.length>0)for(var n=0;n<e.rowGroups.length;n++)if("NULL Dimension"!==e.rowGroups[n].dimensionName&&!1===e.rowGroups[n].isShowingSummary)return!1;return!0},s.observeKeyEvents=function(){document.stopObserving("key:save").observe("key:save",function(e){C.hideMenu(),window.localContext.canSaveReport()&&r.handleSave(),Event.stop(e.memo.targetEvent)}.bind(this)),document.stopObserving("key:undo").observe("key:undo",function(e){C.hideMenu(),window.localContext.state.canUndo&&!_.isDisabled(i("undo"))&&this.undo(),Event.stop(e.memo.targetEvent)}.bind(this)),document.stopObserving("key:redo").observe("key:redo",function(e){C.hideMenu(),window.localContext.state.canRedo&&!_.isDisabled(i("redo"))&&this.redo(),Event.stop(e.memo.targetEvent)}.bind(this)),document.stopObserving("key:escape").observe("key:escape",function(){C.hideMenu(),Object.values(this.dialogESCFunctions).each(function(e){var n=i(e);n&&c.popup.hide(n)}.bind(this)),window.localContext.getMode()==r.CHART&&window.localContext.currentlyDragging&&(Event.stopObserving(document.body,"mousemove"),window.localContext.resizeChart(),window.localContext.currentlyDragging=!1)}.bind(this))},s.observeCustomEvents=function(){p("body").on({layout_update:function(e,n){var o=p("#adhocCanvasContainer"),t=o.prev(),i=parseInt(o.css("margin-top"))||0,s=t.height()-100,a=s-i;o.css("top",a+"px"),n&&n.elem&&"filters"==n.elem.id&&window.localContext.getMode().indexOf("ichart")>=0&&("panel-maximize"==n.type?A.ui.controls.dataLevelSelector.dock():A.ui.controls.dataLevelSelector.undock()),window.localContext.getMode().indexOf("ichart")>=0&&A.chart&&A.redraw()},report_name_update:function(e,n){s.ui.header_title.html(l.hardEscape(n))}}),p("body").on({"actionmodel-mouseout":function(){p("#tableOptions").removeClass("over").css("z-index",9)}}),p(window).resize(function(){var e=p("#adhocCanvasContainer");if(e.length){var n=e.prev(),o=parseInt(e.css("margin-top"))||0,t=n.height()-100,i=t-o;e.css("top",i+"px")}})},s.observeTableContainerEvents=function(){i("mainTableContainer").observe(v()?"touchstart":"mousedown",function(e){window.localContext.mouseDownHandler(e)}),i("mainTableContainer").observe(v()?"touchend":"mouseup",function(e){window.localContext.mouseUpHandler(e),s.adhocTitleEdit.call(this,e)}.bind(this)),i("mainTableContainer").observe("mouseover",function(e){window.localContext.mouseOverHandler(e)}),i("mainTableContainer").observe("mouseout",function(e){window.localContext.mouseOutHandler(e)}),i("mainTableContainer").observe("click",function(e){window.localContext.mouseClickHandler(e)}),Event.observe(i("mainTableContainer"),v()?"touchmove":"scroll",function(){window.localContext.getMode()===r.TABLE&&window.localContext.tableScrolled(),C.hideMenu()})},s.observeTreeEvents=function(e,n){e.observe("leaf:dblclick",function(n){if(this.isCrosstabMode){var o=window.localContext.getMode()==r.ICHART||window.localContext.getMode()==r.OLAP_ICHART?window.AdhocIntelligentChart:u;"dimension"==e.dragClasses?o.canAddLevelAsRowGroup()?o.appendDimensionToRowAxisWithLevel():o.canAddLevelAsColumnGroup()&&o.appendDimensionToColumnAxisWithLevel():o.canAddLevelAsColumnGroup()?o.appendMeasureToColumn():o.canAddLevelAsRowGroup()&&o.appendMeasureToRow()}else{var t=n.memo.targetEvent;this.addFieldToCanvas(t)}}.bind(this)),e.observe("leaf:selected",function(e){var o=e.memo.node,t=e.memo.targetEvent;n._deselectAllNodes(),this.selectFromAvailableFields(t,o)}.bind(this)),e.observe("node:selected",function(e){var o=e.memo.node,t=e.memo.targetEvent;n._deselectAllNodes(),this.selectFromAvailableFields(t,o)}.bind(this)),e.observe("leaf:unselected",function(e){var n=e.memo.node;this.isCrosstabMode&&this.removeSelectedObject(n),this.selectFromAvailableFields(e.memo.targetEvent,n)}.bind(this)),e.observe("node:unselected",function(e){var n=e.memo.node;this.isCrosstabMode&&this.removeSelectedObject(n),this.selectFromAvailableFields(e.memo.targetEvent,n)}.bind(this)),e.observe("items:unselected",function(){r.unSelectAll()}.bind(this)),e.observe("node:dblclick",function(e){this._availableTreeLastOpened=e.memo.node.param.uri,window.localStorage&&localStorage.setItem(this._cookieName,this._availableTreeLastOpened)}.bind(this)),e.observe("node:click",function(e){this._availableTreeLastOpened=e.memo.node.param.uri,window.localStorage&&localStorage.setItem(this._cookieName,this._availableTreeLastOpened)}.bind(this)),e.observe("tree:loaded",function(){e.openAndSelectNode(this._availableTreeLastOpened)}.bind(this)),e.observe("node:mouseup",function(e){window.localContext.treeMenuHandler(e)}),e.observe("leaf:mouseup",function(e){window.localContext.treeMenuHandler(e)}),e.observe("key:contextMenu",function(e){var n=e.memo.node,o=b(n,!0);s.showDynamicMenu(e,r.FIELD_MENU_LEVEL,{menuLeft:o[0]+100,menuTop:o[1]+20}),Event.stop(e)})},s.observeDisplayManagerEvents=function(){var e=p("#"+s.DISPLAY_MANAGER_ID);e.unbind("lm:addItem"),e.unbind("lm:addItems"),e.unbind("lm:removeItem"),e.unbind("lm:moveItem"),e.unbind("lm:measureReorder"),e.unbind("lm:switchItem"),e.unbind("lm:contextMenu"),e.bind("lm:addItem",function(e,n){n=a.extend({index:-1,levelIndex:-1},n),window.localContext.lmHandlersMap[n.axis].addItem(n.dimensionId,n.index,n.level,n.levelIndex,n.isMeasure,n.uri,n.hierarchyName)}),e.bind("lm:removeItem",function(e,n){window.localContext.lmHandlersMap[n.axis].removeItem(n.item,n.index)}),e.bind("lm:addItems",function(e,n){window.localContext.lmHandlersMap.addItems(n.levels,n.index,n.axis)}),e.bind("lm:moveItem",function(e,n){window.localContext.lmHandlersMap[n.axis].moveItem(n.item,n.from,n.to)}),e.bind("lm:switchItem",function(e,n){window.localContext.lmHandlersMap[n.axis].switchItem(n.item,n.from,n.to)}),e.bind("lm:measureReorder",function(e,n){window.localContext.lmHandlersMap.measureReorder(n.measure,n.to)}),e.bind("lm:contextMenu",function(e,n){window.localContext.lmHandlersMap[n.extra.axis].contextMenu(e,n)})},s.observeCrossDocumentMessages=function(){window.addEventListener?(removeEventListener("message",s.crossDocumentListener),addEventListener("message",s.crossDocumentListener,!1)):(window.detachEvent("onmessage",s.crossDocumentListener),window.attachEvent("onmessage",s.crossDocumentListener))},s.observeCloseDesignerEvent=function(){p("#closeDesigenr").on("mouseup",s.handleCancel)},window.addEventListener&&window.addEventListener("orientationchange",function(e){s.hideOnePanel()}),o.exports=s});