/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/js-sdk/src/common/util/featureDetection","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","backbone","../factory/filterOperatorLabelFactory","../factory/valueEditorFactory","../factory/possibleOperatorsFactory","bundle!AdHocFiltersBundle","text!./template/filterEditorTemplate.htm"],function(e,t,i){var r=e("underscore"),o=e("jquery"),n=(e("runtime_dependencies/js-sdk/src/common/util/featureDetection"),e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator")),l=e("backbone"),s=e("../factory/filterOperatorLabelFactory"),a=e("../factory/valueEditorFactory"),d=e("../factory/possibleOperatorsFactory"),h=e("bundle!AdHocFiltersBundle"),c=e("text!./template/filterEditorTemplate.htm");i.exports=l.View.extend({template:r.template(c),isOlap:!1,el:function(){var e=this.model.toJSON();return e.i18n=h,this.template(e)},events:function(){return{"click .header .operator":"showOperatorMenu","click .header .button.disclosure":"onToggleFilter","click .header .mutton":"showFilterMenu"}}(),operators:{},initialize:function(){var e=this;this.valueEditorUIChanged=!1,r.bindAll(this,"removeFilter","upFilter","downFilter","drawToggleFilter"),this.operationsMenuActionModel=this.createOperationsMenuActionModel(),this.filterMenuActionModel=this.createFilterMenuActionModel(),this.listenTo(this.model,"operationChange",this.render),this.listenTo(this.model,"ready",this.render),this.listenTo(this.model,"change:filterPodMinimized",this.drawToggleFilter),this.listenTo(this.model,"change:filterLetter",this.redrawFilterTitle),this.listenTo(this.model,"change:label",this.redrawFilterTitle),this.model.loadAdditionalServerData(!0).done(function(){e.model.trigger("ready",e.model)}),n.MOUSE_OUT_PATTERNS.push("#filter-container .header .mutton")},redrawFilterTitle:function(){this.$(".filterName span").text(this.model.get("filterLetter")+"."+this.model.get("label")),this.$(".filterName span").attr("title",this.model.get("filterLetter")+"."+this.model.get("label"))},resizeTitle:function(){var e=this.$(".header .button.disclosure").width()+this.$(".header .button.operator div").width()+this.$(".header .button.operator .icon").width()+this.$(".header .button.mutton").width()+15,t=this.$(".header .title").width(),i=this.$(".header .filterName");i.css({overflow:"visible",width:"auto"});var r=i.find("span").width()+this.$(".header .button.disclosure").width()+15;i.css("overflow","hidden"),i.width(Math.min(t-e,r))},render:function(){var e=(this.model.get("operatorName"),this.getValueEditorFactory());return this.renderOperator(),this.valueEditor&&this.valueEditor.constructor==e.constructor||(this.valueEditor?(this.stopListening(this.valueEditor,"rendered",this.uiChanged),this.valueEditor.remove()):(this.$(".filter.panel").addClass("minimized"),r.defer(r.bind(this.drawToggleFilter,this))),this.valueEditor=this.createValueEditor()),this.valueEditor.updateData(),this},uiChanged:function(){this.trigger("uiChange:filters",this)},createValueEditor:function(){var e=this.getValueEditorFactory(),t=e.createInstance(this.model);return this.listenTo(t,"rendered",this.uiChanged),this.$(".body").html(t.$el),t},renderOperator:function(){this.$(".operator div").text(s(this.model.get("operatorName"),this.model.get("filterDataType"))),this.resizeTitle()},showOperatorMenu:function(e){n.showDynamicMenu("filterOperation_"+this.cid,e.originalEvent,"menu vertical dropDown fitable",null,this.operationsMenuActionModel)},showFilterMenu:function(e){var t=o(e.target),i=t.closest("li.leaf.filter").index(),r=t.hasClass("button")?t:t.closest(".button");n.isMenuShowing()&&n.menuDom.hasClassName("openByFilter-"+i)?(n.hideMenu(),n.menuDom.removeClassName("openByFilter-"+i)):n.showDynamicMenu(this.cid,e.originalEvent,"menu vertical dropDown fitable openByFilter-"+i,null,this.filterMenuActionModel);var l=r.offset();o("#menu").offset({top:l.top+r.height(),left:l.left-o("#menu").width()+r.width()}),e.stopPropagation()},onToggleFilter:function(){this.model.set("filterPodMinimized",!this.model.get("filterPodMinimized")),this.model.trigger("toggle",this.model)},drawToggleFilter:function(){this.$(".filter.panel")[this.model.get("filterPodMinimized")?"addClass":"removeClass"]("minimized")},removeFilter:function(e){var t=e&&e.force;this.model.get("used")&&!t?this.model.trigger("destroyConfirm",this.model,this.model.collection):this.model.trigger("destroy",this.model,this.model.collection)},upFilter:function(){this.model.trigger("move",this.model,{direction:-1})},downFilter:function(){this.model.trigger("move",this.model,{direction:1})},getValueEditorFactory:function(){var e=a(this.model.get("filterDataType"),this.model.get("operatorName"),this.isOlap);if(!e)throw"Value editor for filter data type '"+this.model.get("filterDataType")+"' and operator '"+this.model.get("operatorName")+"' does not exist";return e},createOperationsMenuActionModel:function(){var e=this,t={};return t["filterOperation_"+this.cid]=r.map(d(this.model.get("filterDataType"),this.isOlap),function(t){return n.createMenuElement("optionAction",{text:s(t,e.model.get("filterDataType")),action:function(t){e.model.set("operatorName",t)},actionArgs:[t],isSelectedTest:function(t){return e.model.get("operatorName")===t},isSelectedTestArgs:[t]})}),t},createFilterMenuActionModel:function(){var e={};return e[this.cid]=[n.createMenuElement("simpleAction",{text:h.ADH_1217_DYNAMIC_FILTER_REMOVE_FILTER,action:this.removeFilter}),n.createMenuElement("separator"),n.createMenuElement("simpleAction",{text:h.ADH_084_MOVE_UP,action:this.upFilter}),n.createMenuElement("simpleAction",{text:h.ADH_085_MOVE_DOWN,action:this.downFilter})],e},remove:function(){return this.valueEditor&&this.valueEditor.remove(),l.View.prototype.remove.call(this),this}})});