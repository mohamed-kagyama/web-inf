/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","bundle!AdHocFiltersBundle","settings!decimalFormatSymbols","runtime_dependencies/js-sdk/src/common/util/parse/NumberUtils","./filterModelTrait/dateRangeFilterModelTrait","./filterModelTrait/listFilterModelTrait","./filterModelTrait/literalFilterModelTrait","./filterModelTrait/rangeFilterModelTrait","./filterModelTrait/readOnlyFilterModelTrait","./enum/filterDataTypes","./enum/filterExpressionTypes","./enum/filterOperators","./factory/filterModelValidationFactory","./factory/filterModelExpressionTypeFactory","./factory/filterModelDefaultValueFactory","./format/OlapFilterValueFormatter","runtime_dependencies/js-sdk/src/components/singleSelect/dataprovider/DataProviderNew","runtime_dependencies/js-sdk/src/components/singleSelect/dataprovider/ValueFormattingDataProvider","settings!adhocFilterSettings","momentExtension","./validation/backboneValidationExtensions"],function(e,t,i){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e){return e===v.DATE}function s(e){return e===v.TIMESTAMP}function n(e){return e===v.BOOLEAN}function l(e){return e===v.TIME}function o(e){return e===v.STRING}function u(e){return e===v.INTEGER||e===v.DECIMAL||e===v.LONG||e===v.NUMERIC}var d=e("underscore"),h=e("jquery"),p=e("backbone"),c=e("bundle!AdHocFiltersBundle"),f=e("settings!decimalFormatSymbols"),T=e("runtime_dependencies/js-sdk/src/common/util/parse/NumberUtils"),E=e("./filterModelTrait/dateRangeFilterModelTrait"),m=e("./filterModelTrait/listFilterModelTrait"),A=e("./filterModelTrait/literalFilterModelTrait"),y=e("./filterModelTrait/rangeFilterModelTrait"),_=e("./filterModelTrait/readOnlyFilterModelTrait"),v=e("./enum/filterDataTypes"),N=e("./enum/filterExpressionTypes"),g=e("./enum/filterOperators"),D=e("./factory/filterModelValidationFactory"),V=e("./factory/filterModelExpressionTypeFactory"),S=e("./factory/filterModelDefaultValueFactory"),M=e("./format/OlapFilterValueFormatter"),O=e("runtime_dependencies/js-sdk/src/components/singleSelect/dataprovider/DataProviderNew"),L=e("runtime_dependencies/js-sdk/src/components/singleSelect/dataprovider/ValueFormattingDataProvider"),R=e("settings!adhocFilterSettings"),x=e("momentExtension");e("./validation/backboneValidationExtensions");var I=new T(f),b={};b[N.LITERAL]=A,b[N.LIST]=m,b[N.DATE_RANGE]=E,b[N.RANGE]=y,b[N.READ_ONLY]=_;var F={DATA_CHOOSER_NO_PROMPT:"ADH_1215_DYNAMIC_FILTER_UNEDITABLE_TITLE",SLICE_COMPLEX_KEEPONLY:"ADH_1208_DYNAMIC_FILTER_KEEP",SLICE_COMPLEX_EXCLUDE:"ADH_1209_DYNAMIC_FILTER_EXCLUDE"},P=p.Model.extend({initialize:function(e,t){this.service=t.service,this.isOlap=t.isOlap;var i=d.defaults({},R||{},{availableItemsPageSizeOlap:"999",availableItemsPageSize:"999"});this.dataProvider=new O({pageSize:this.isOlap?+i.availableItemsPageSizeOlap:+i.availableItemsPageSize,request:new L({request:d.bind(this._requestValues,this),format:this.isOlap?new M(this.get("isFirstLevelInHierarchyAll")).format:null}).getData,controlGetTotal:!0,saveLastCriteria:!0}),this.removeAvailableData(),this.removeMinMaxValues(),this.on("change:operatorName",this._onOperatorNameChange),this.on("change:expressionType",this._onExpressionTypeChange),this._updateModelBehavior()},_requestValues:function(e){var t=this.get("showLoading");return this.service.fetchValues(this.get("name"),e,t)},setShowLoading:function(e){this.set("showLoading",e,{silent:!0})},removeAvailableData:function(){this.dataProvider.clear()},removeMinMaxValues:function(){this._minMaxValuesDeferred=null,this.minValue=null,this.maxValue=null},fetchDataForChangeFilterType:function(){return this.dataProvider.getData({offset:0,limit:1})},fetchMinMaxValues:function(){var e=this;return this._minMaxValuesDeferred||(this._minMaxValuesDeferred=this.service.getMaxMinValues(this.get("name")).done(function(t){var i=t.maxMin;e.isDate()&&(i[0]=x(i[0]).format("YYYY-MM-DD"),i[1]=x(i[1]).format("YYYY-MM-DD")),e.minValue=i[0],e.maxValue=i[1]})),this._minMaxValuesDeferred},loadAdditionalServerData:function(e){var t=this;return this.additionalServerDataDeferred(e).done(function(){t._setValue()})},additionalServerDataDeferred:function(e){var t=new h.Deferred;return t.resolve(),this.isString()&&d.include([g.IN,g.NOT_IN,g.EQUALS,g.NOT_EQUAL],this.get("operatorName"))?e||(t=h.when(this.fetchDataForChangeFilterType())):(this.isNumber()||this.isDate()||this.isDateTime()||this.isTime())&&(d.include([g.IN,g.NOT_IN],this.get("operatorName"))?e||(t=h.when(this.fetchDataForChangeFilterType())):d.include([g.LESS,g.LESS_OR_EQUAL,g.GREATER,g.GREATER_OR_EQUAL,g.BETWEEN,g.NOT_BETWEEN,g.BETWEEN_DATES,g.NOT_BETWEEN_DATES],this.get("operatorName"))&&(t=h.when(this.fetchMinMaxValues()))),t},_onOperatorNameChange:function(){var e=this.previousAttributes();void 0!==e.operatorName&&e.operatorName===g.IN&&this.get("operatorName")!==g.IS_ANY_VALUE&&this.get("isAnyValue")&&this.set("isAnyValue",!1,{silent:!0});var t=V(this.get("filterDataType"),this.get("operatorName"));this.set("expressionType",t,{silent:!0}),this.trigger("change:expressionType",this,this.get("expressionType"))},saveValue:function(){return this.service.update(this.get("id"),this.toExpression())},_onExpressionTypeChange:function(){var e=this;this._updateModelBehavior(),this.loadAdditionalServerData().done(function(){e.trigger("operationChange",e)})},_updateModelBehavior:function(){this._updateInstanceWithTrait(),this._updateInstanceWithValidation()},_setValue:function(){if(!this.isReadOnly()){var e=this.previousAttributes();if(!d.isEmpty(e)&&this._isDefaultValueSelected(e))this._setDefaultValue();else{var t=this.get("value"),i=[g.EQUALS,g.NOT_EQUAL],a=[g.CONTAINS,g.NOT_CONTAINS,g.STARTS_WITH,g.NOT_STARTS_WITH,g.ENDS_WITH,g.NOT_ENDS_WITH],r=[g.IN,g.NOT_IN];d.include(a,e.operatorName)&&d.include(i,this.get("operatorName"))?this._setDefaultValue():(this.isString()||this.isBoolean())&&d.include(i,e.operatorName)&&d.include(r,this.get("operatorName"))?this.set({value:[t]},{silent:!0,validate:!0}):e.expressionType===N.LIST&&this.get("expressionType")===N.LITERAL?this.set({value:d.isArray(t)?t[0]:t},{silent:!0,validate:!0}):e.expressionType===N.LIST&&d.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[t[0],t[t.length-1]]},{silent:!0,validate:!0}):d.include([g.EQUALS,g.NOT_EQUAL],e.operatorName)&&d.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[t,t]},{silent:!0,validate:!0}):d.include([g.GREATER,g.GREATER_OR_EQUAL],e.operatorName)&&d.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[t,this.maxValue]},{silent:!0,validate:!0}):d.include([g.LESS,g.LESS_OR_EQUAL],e.operatorName)&&d.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[this.minValue,t]},{silent:!0,validate:!0}):d.include([N.RANGE,N.DATE_RANGE],e.expressionType)&&this.get("expressionType")===N.LIST?this._setDefaultValue():d.include([N.RANGE,N.DATE_RANGE],e.expressionType)&&d.include([g.EQUALS,g.NOT_EQUAL,g.GREATER,g.GREATER_OR_EQUAL],this.get("operatorName"))?this.set({value:t[0]},{silent:!0,validate:!0}):d.include([N.RANGE,N.DATE_RANGE],e.expressionType)&&d.include([g.LESS,g.LESS_OR_EQUAL],this.get("operatorName"))&&this.set({value:t[t.length-1]},{silent:!0,validate:!0}),this.isValid(!0)||this._setDefaultValue()}}},_getDefaultValue:function(){return S(this.get("filterDataType"),this.get("operatorName"),this.isOlap,this.additionalModelDataForDefaultValue())},_setDefaultValue:function(){this.set(this._getDefaultValue(),{silent:!0}),this.isValid(!0)},_isDefaultValueSelected:function(e){var t=S(this.get("filterDataType"),e.operatorName,this.isOlap,this.additionalModelDataForDefaultValue()),i={value:e.value,isAnyValue:e.isAnyValue};return P.valueObjectsAreEqual(i,t)},additionalModelDataForDefaultValue:function(){var e=[];if(this.dataProvider.dataCacheTotal>0){var t=this.dataProvider.dataCache.slice(0,this.dataProvider.pageSize);e=d.map(t,function(e){return e.value})}return{min:this.minValue,max:this.maxValue,values:e,allValuesLoaded:this.dataProvider.dataCacheTotal<=this.dataProvider.pageSize}},set:function(e,t,i){var r;return null==e?this:("object"===a(e)?(r=e,i=t):(r={})[e]=t,i||(i={}),r=P.normalizeAttributes(r),p.Model.prototype.set.call(this,r,i))},_updateInstanceWithTrait:function(){return d.extend(this,b[this.get("expressionType")])},_updateInstanceWithValidation:function(){this.validation=D(this.get("filterDataType"),this.get("operatorName"))},toExpression:function(){var e=this.get("operatorName");(this.isTime()||this.isNumber())&&(e===g.BETWEEN?e=g.IN:e===g.NOT_BETWEEN&&(e=g.NOT_IN)),this.get("isAnyValue")&&(e=g.IS_ANY_VALUE);var t={type:this.get("operatorType"),name:e,operands:[{type:this.get("filterLabelType"),name:this.get("name")}]};return this.get("isAnyValue")||[].push.apply(t.operands,this._rValue()),[t]},_rValue:function(){var e=this._expressionRValue();return d.isArray(e)?e:[e]},isDate:function(){return r(this.get("filterDataType"))},isDateTime:function(){return s(this.get("filterDataType"))},isBoolean:function(){return n(this.get("filterDataType"))},isTime:function(){return l(this.get("filterDataType"))},isString:function(){return o(this.get("filterDataType"))},isNumber:function(){return u(this.get("filterDataType"))},isReadOnly:function(){return!this.get("editable")}},{normalizeAttributes:function(e){var t=d.clone(e);if(t.hasOwnProperty("expressionAsString")&&delete t.expressionAsString,t.hasOwnProperty("editable")&&(t.editable||(t.filterDataType=v.READ_ONLY,t.operatorName=g.READ_ONLY,t.label=c[F[e.source]||F.DATA_CHOOSER_NO_PROMPT],t.isComplex="complex"===e.name.toLowerCase())),d.isUndefined(t.isAnyValue)&&t.hasOwnProperty("operatorName")&&(t.operatorName===g.IS_ANY_VALUE?(t.isAnyValue=!0,t.operatorName=r(t.filterDataType)||s(t.filterDataType)?g.BETWEEN_DATES:g.IN):t.isAnyValue=!1),t.hasOwnProperty("operatorName")&&t.hasOwnProperty("filterDataType")){var i=V(t.filterDataType,t.operatorName);d.isUndefined(t.expressionType)&&(t.expressionType=i),i===N.LITERAL&&t.hasOwnProperty("value")&&d.isArray(t.value)&&1===t.value.length&&(t.value=t.value[0])}return t},_isArraysEquals:function(e,t){if(e.length!=t.length)return!1;var i,a={};for(i=0;i<e.length;i++)a[e[i]]=!0;for(i=0;i<t.length;i++)if(!a[t[i]])return!1;return!0},valueObjectsAreEqual:function(e,t){if(void 0===e.isAnyValue&&!0===t.isAnyValue||void 0===t.isAnyValue&&!0===e.isAnyValue||void 0!==e.isAnyValue&&void 0!==t.isAnyValue&&e.isAnyValue!==t.isAnyValue)return!1;var i=e.value,a=t.value;if(d.isArray(i)&&d.isArray(a))return this._isArraysEquals(i,a);if(d.isArray(i)||d.isArray(a))return!1;var r=I.parseNumber(i),s=I.parseNumber(a);return void 0===r&&void 0===s?i==a:r==s}});d.extend(P.prototype,p.Validation.mixin),i.exports=P});