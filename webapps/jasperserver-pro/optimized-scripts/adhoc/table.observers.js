/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","underscore","jquery","./table","runtime_dependencies/jrs-ui/src/util/touch.controller","../base/designer.base","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"],function(e,n,t){var o=e("dragdropextra"),a=(o.Draggable,o.Draggables),i=e("prototype"),l=i.$,d=e("underscore"),r=e("jquery"),c=e("./table"),u=e("runtime_dependencies/jrs-ui/src/util/touch.controller"),s=e("../base/designer.base"),m=e("runtime_dependencies/jrs-ui/src/util/utils.common"),g=m.isSupportsTouch,w=m.getTouchedElement,C=m.matchAny,v=m.isRightClick,E=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator");c.GRID_SELECTOR_MENU_CLASS="menu vertical dropDown",c.ACTION_MODEL_CONTEXT_SUFFIX="_mutton",c.mouseDownHandler=function(){},c.mouseUpHandler=function(e){if(a.dragging!=s.COLUMN_LEVEL&&a.dragging!=s.GROUP_LEVEL&&!u.element_scrolled){var n=g()?w(e):e.element(),t=null,o=null,i=null;if("dimensionsTree"!=a.dragging&&"measuresTree"!=a.dragging||(t=C(n,[window.adhocDesigner.COLUMN_OVERLAY_PATTERN],!0),t&&(i=n.identify(),o=o||c.digitRegex.exec(i)[0],g()||(c.hoverColumn=o),c.deactivateVisualDropCue(e,o),c.isHoverGreaterThan50Percent(e,o)&&c.hoverColumn++),(t=C(n,[window.adhocDesigner.COLUMN_SIZER_PATTERN],!0))&&(i=n.identify(),o=parseInt(c.digitRegex.exec(i)[0]),c.hoverColumn=o+1,c.deactivateVisualDropCue(e,o))),!g()||!u.element_scrolled){if((t=C(n,[window.adhocDesigner.COLUMN_OVERLAY_PATTERN],!0))&&!v(e)){i=n.identify(),o=c.digitRegex.exec(i)[0];var l=window.localContext._getTableHeaders()[o],d={};d.header=l,d.index=o,d.model=window.localContext.state.table.columns[o],window.localContext.selectTableColumn(e,d)}if(n.match(window.adhocDesigner.GROUP_OVERLAY_PATTERN)&&!v(e)&&n){var r={id:n.identify(),fieldName:n.readAttribute("data-fieldName"),mask:n.readAttribute("data-mask"),dataType:n.readAttribute("data-dataType"),index:n.readAttribute("data-index"),label:n.readAttribute("data-label")};window.localContext.selectGroup(e,r)}n.match(window.adhocDesigner.SUMMARY_OVERLAY_PATTERN)&&!v(e)&&(i=n.identify(),window.localContext.selectGrandRowCell(e,c.digitRegex.exec(i)[0]))}}},c.mouseOutHandler=function(e){var n,t,o=e.targetElement?e.targetElement:e.element(),i=C(o,[window.adhocDesigner.COLUMN_OVERLAY_PATTERN],!0);i&&(o.removeClassName("over"),a.dragging&&!a.activeDraggable.element.hasClassName("columnSizer")&&(n=o.identify(),t=parseInt(c.digitRegex.exec(n)[0]),c.deactivateVisualDropCue(e,t),c.deactivateVisualDropCue(e,t-1))),i=C(o,[window.adhocDesigner.SUMMARY_OVERLAY_PATTERN,window.adhocDesigner.GROUP_OVERLAY_PATTERN],!0),i&&o.removeClassName("over"),o.match("#designer .columnSizer")&&(document.body.style.cursor="default",window.adhocDesigner.overlayDraggedColumn&&window.adhocDesigner.overlayDraggedColumn.destroy())},c.mouseOverHandler=function(e){var n=e.targetElement?e.targetElement:e.element(),t=a.dragging==s.GROUP_LEVEL;if(c.updateColumnWhileDrag(e,n,function(n,t){c.deactivateVisualDropCue(e,t?n-1:n),c.activateVisualDropCue(e,t?n:n-1)}),a.dragging!=s.AVAILABLE_FIELDS_AREA&&!c.draggingColumnSizer){var o=C(n,[window.adhocDesigner.SUMMARY_OVERLAY_PATTERN,window.adhocDesigner.GROUP_OVERLAY_PATTERN,"th.label"],!0);if(o){var i=r(o),l=i.attr("data-index");"th"==i.get(0).tagName.toLowerCase()&&l?r("#columnOverlay_"+l).addClass("over"):o.addClassName("over")}t&&(c.draggingMoveOverGroupIndex=n.match(window.adhocDesigner.GROUP_OVERLAY_PATTERN)?n.getAttribute("data-index"):-1),c.resizeColumnWhenSizerDrag(n)}},c.mouseClickHandler=function(e){},c.contextMenuHandler=function(e){var n,t=e.element(),o=t.identify();if(C(t,[window.adhocDesigner.COLUMN_OVERLAY_PATTERN],!0)){n=c.digitRegex.exec(o)[0];var a=window.localContext._getTableHeaders()[n],i={};i.header=a,i.index=n,i.model=window.localContext.state.table.columns[n],s.isInSelection(i)||window.localContext.selectTableColumn(e,i);var r=d.chain(window.selObjects).pluck("model").pluck("name").value();E.setSelected(d.filter(window.localContext.state.columns,function(e){return d.contains(r,e.name)})),a.readAttribute("data-fieldname")!==s.ARTIFICIAL_NAME&&window.adhocDesigner.showDynamicMenu(e,s.COLUMN_LEVEL,null,c.generateAvailableSummaryCalculationsMenu)}if(t.match(window.adhocDesigner.SUMMARY_OVERLAY_PATTERN)){n=c.digitRegex.exec(o)[0];var u=l("grandSummaryRow").cells,m=u[n];s.isInSelection(m)||window.localContext.selectGrandRowCell(e,n),E.setSelected(d.map(window.selObjects,function(e){return e.model})),window.adhocDesigner.showDynamicMenu(e,s.SUMMARY_LEVEL,null,c.generateAvailableSummaryCalculationsMenu)}if(t.match(window.adhocDesigner.GROUP_OVERLAY_PATTERN)&&t){var g=t.readAttribute("data-index"),w={id:o,fieldName:t.readAttribute("data-fieldName"),mask:t.readAttribute("data-mask"),dataType:t.readAttribute("data-dataType"),index:g,label:t.readAttribute("data-label"),model:window.localContext.state.table.groups[g]};s.isInSelection(w)||window.localContext.selectGroup(e,w),E.setSelected(d.map(window.selObjects,function(e){return e.model})),window.adhocDesigner.showDynamicMenu(e,s.GROUP_LEVEL)}},c.treeMenuHandler=function(e){var n,t=e.memo.node;n=s[t.isParent()||!window.adhocDesigner.isOnlyFieldsSelected()?"FIELDSET_MENU_LEVEL":"FIELD_MENU_LEVEL"],window.adhocDesigner.showDynamicMenu(e.memo.targetEvent,n,null)},c.initKeyEvents=function(){function e(e){return null!=e.target.up(".dialog")}document.stopObserving("key:right"),document.observe("key:right",function(n){if(window.localContext.getMode()==s.TABLE&&!e(n)){var t=Object.clone(n.memo.targetEvent),o=window.adhocDesigner.getSelectedColumnOrGroup();o&&s.isInSelection(o)&&c.canMoveColumnsRight()&&c.moveColumnRight(function(){c.updateSelectedIndexes(1),window.localContext.selectTableColumn(t,o)})}}),document.stopObserving("key:left"),document.observe("key:left",function(n){if(window.localContext.getMode()==s.TABLE&&!e(n)){var t=Object.clone(n.memo.targetEvent),o=window.adhocDesigner.getSelectedColumnOrGroup();o&&s.isInSelection(o)&&c.canMoveColumnsLeft()&&c.moveColumnLeft(function(){c.updateSelectedIndexes(-1),window.localContext.selectTableColumn(t,o)})}})},c.generateAvailableSummaryCalculationsMenu=function(e,n){var t=d.find(n,function(e){return"AdHocTable.selectedColumnShowsSummaryOptions"===e.clientTest});if(t){var o=E.selObjects[0],a=d.findWhere(window.localContext.state.columns,{name:o.name});a&&window.adhocDesigner.generateAvailableSummaryCalculationsMenu(a.fieldName,t,{action:c.functionSelected,isSelectedTest:c.isSelectedSummaryFunction})}return n},c.lmHandlersMap={addItems:function(e,n,t){this[t].addItems(d.pluck(e,"id"),n)},group:{addItem:function(e,n,t){c.addFieldAsGroup(t,n)},addItems:function(e,n){c.addFieldAsGroup(e,n)},removeItem:function(e,n){c.removeGroup(n)},moveItem:function(e,n,t){c.moveGroup(n,t)},switchItem:function(e,n,t){c.switchToGroup(e,n,t)},contextMenu:function(e,n){var t=n.extra.name,o=d.find(window.localContext.state.groups,function(e){return e.name===t});window.localContext.selectGroup(n.targetEvent,{id:"group"+o.level+"HeaderRow0",fieldName:o.name,mask:o.mask,dataType:o.numericType,index:o.level,label:o.currentDisplayName}),E.setSelected([o]),window.adhocDesigner.showDynamicMenu(n.targetEvent,"displayManagerRow",null,null)}},column:{addItem:function(e,n,t){c.addFieldAsColumnAtPosition(t,n)},addItems:function(e,n){c.addFieldAsColumnAtPosition(e,n)},removeItem:function(e,n){c.removeColumn(n)},moveItem:function(e,n,t){c.moveColumn(n,t,null,!0)},switchItem:function(e,n,t){c.switchToColumn(e,n,t)},contextMenu:function(e,n){var t=n.extra,o=window.localContext._getTableHeaders()[t.index];window.localContext.selectTableColumn(n.targetEvent,{header:o,index:t.index,ftype:t.isMeasure?"measure":"dimension",model:window.localContext.state.table.columns[t.index]}),E.setSelected([window.localContext.state.columns[t.index]]),window.adhocDesigner.showDynamicMenu(n.targetEvent,"displayManagerColumn",null,null)}}},t.exports=c});