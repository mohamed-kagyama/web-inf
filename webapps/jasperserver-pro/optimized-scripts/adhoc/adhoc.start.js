/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","jquery","runtime_dependencies/jrs-ui/src/components/components.dialogs","runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/core/core.ajax","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/core/core.buttonManager","runtime_dependencies/js-sdk/src/jrs.configs"],function(e,t,o){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var s=e("prototype"),i=s.$,a=s.$$,r=e("jquery"),c=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),l=e("runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils"),d=e("runtime_dependencies/jrs-ui/src/util/utils.common"),p=d.isNotNullORUndefined,u=d.isSupportsTouch,m=d.matchAny,h=d.encodeText,T=d.deepClone,C=d.getEvent,b=e("runtime_dependencies/jrs-ui/src/core/core.ajax"),f=b.ajaxErrorHandler,_=e("runtime_dependencies/jrs-ui/src/core/core.layout"),N=e("runtime_dependencies/jrs-ui/src/core/core.buttonManager"),y=e("runtime_dependencies/js-sdk/src/jrs.configs"),D={TopicsTreeContainerId:"topicsTreeArea",DomainTreeContainerId:"domainsTreeArea",OlapConnectionsTreeContainerId:"olapConectionsTreeArea",DefaultTopicsPath:"",DefaultDomainsPath:"/Domains/Simple_Domain",DefaultOlapConnectionPath:"/analysis/connections/Foodmart/Sales",selectedRealmURI:"",selectedSubType:"",options:null,TOPIC:"topics",DOMAIN:"domains",OLAP_CONNECTION:"olapConnections",TOPIC_LAUNCH_TYPE:"ADH_045b_TOPIC",DOMAIN_LAUNCH_TYPE:"ADH_045a_DOMAIN",OLAP_CONNECTION_LAUNCH_TYPE:"ADH_108_DATA_CHOOSER_OLAP_CONNECTIONS",initialize:function(){c.popup.show(i("sourceDialog"),!0);if(window.defaultTopic?this.DefaultTopicsPath=window.defaultTopicDir+window.defaultTopic:this.DefaultTopicsPath=window.defaultTopicDir+"unspecifiedTopic",p(this.TopicsTreeContainerId)){switch(window.launchType){case this.DOMAIN_LAUNCH_TYPE:this.hideRealmTree(this.DOMAIN),this.getDomains();break;case this.OLAP_CONNECTION_LAUNCH_TYPE:this.hideRealmTree(this.OLAP_CONNECTION),this.getOlapConnections();break;default:this.getTopics()}this.initializeHandlers()}},initializeHandlers:function(){a("fieldset#reportTypes > .button").each(function(e){Event.observe(i(e),"click",function(t){var o=i(e).identify();"cancel"!==o&&("chart"==o&&(o="ichart"),this.startWithRealm(o),Event.stop(t))}.bind(this))}.bind(this)),i("dataChooserBtn").observe("click",function(e){this.startWithRealm("table"),Event.stop(e)}.bind(this)),i("olapChartBtn").observe("click",function(e){this.startWithRealm("olap_ichart"),Event.stop(e)}.bind(this)),i("olapCrosstabBtn").observe("click",function(e){this.startWithRealm("olap_crosstab"),Event.stop(e)}.bind(this)),i("dataChooserSource").observe("mouseup",function(e){var t=e.element(),o=m(t,["button.action.up"],!0);o&&"cancel"==o.identify()&&(this.cancelTopic(window.alreadyEditing),Event.stop(e))}.bind(this));var e=u()?"drag:touchstart":"mouseup";Event.observe(a("#sourceDialog > .content > .header")[0],e,function(e){this.getRealm(e.memo?e.memo.targetEvent:e)}.bind(this)),this._enableCancelButtons()},getRealm:function(e){var t=Event.extend(C(e)).element();if(t.hasClassName("tab")||(t=t.up("li")),t){var o=t.readAttribute("id");i(t).hasClassName(_.SELECTED_CLASS)||(this.hideRealmTree(o),o===this.TOPIC?this.getTopics():o===this.DOMAIN?this.getDomains():o===this.OLAP_CONNECTION&&this.getOlapConnections())}},_toggleEnableDisableReportBtns:function(e){var t=e.getSelectedNode(),o=!(t&&t.isParent()||!t);D._enableReportTypeButtons(o),D._enableDataChooserButtons(o),D._enableOlapCrosstabButtons(o)},_processTreeNodeIcon:function(e){if(e.isParent())for(var t=0;t<e.childs.length;t++)this._processTreeNodeIcon(e.childs[t]);else D._updateLeafIcons(e)},_updateLeafIcons:function(e){e&&null!=e.param.extra&&("SLDS"==e.param.extra.subType?e.param.cssClass="domain":"sl.no.ds"==e.param.extra.subType?e.param.cssClass="domain topic":"QueryBuilder"==e.param.extra.creator?e.param.cssClass="domain topic":"OLAPDS"==e.param.extra.subType||("olap.no.ds"==e.param.extra.subType?e.param.cssClass="olap":"Cube"==e.param.extra.subType?e.param.cssClass="olap":e.param.cssClass="topic"),e.refreshStyle())},getTopics:function(){var e;i(this.TopicsTreeContainerId).childElements().length<1?e=D.getTopicsTree():e=l.trees[D.TopicsTreeContainerId],this.setSelectedRealmDescription(""),e.observe("leaf:selected",function(e){var t=e.memo.node;this._enableReportTypeButtons(!0),this.setRealmProps(t.param)}.bind(this)),e.observe("leaf:dblclick",function(e){this.startWithRealm("table")}.bind(this)),e.observe("node:selected",function(e){this.setRealmProps(null),this._enableReportTypeButtons(!1)}.bind(this)),e.observe("nodeIcon:click",function(e){e.memo.node.childs>0&&(this.setRealmProps(null),this._enableReportTypeButtons(!1))}.bind(this)),e.observe("children:loaded",function(e){e.memo.nodes.each(function(e){D._processTreeNodeIcon(e)}.bind(this))});var t=function(e){function t(){var e=l.trees[D.TopicsTreeContainerId],t=e.getRootNode().childs;t&&0===t.length&&D.setSelectedRealmDescription(window.noTopicsMessage);var o=e.getSelectedNode();null==o||o.isParent()||D.setRealmProps(o.param),D._toggleEnableDisableReportBtns(e),D._processTreeNodeIcon(e.getRootNode()),D.hideRealmTree(D.getRealmType())}return function(){e.openAndSelectNode(this.DefaultTopicsPath,t,!0)}.bind(D)}(e);e.showTreePrefetchNodes(D.DefaultTopicsPath,t,f),this._markAdhocTypeAsSelected(this.TOPIC)},getDomains:function(){var e;i(this.DomainTreeContainerId).childElements().length<1?e=D.getDomainsTree():e=l.trees[D.DomainTreeContainerId],this.setSelectedRealmDescription(""),e.observe("leaf:selected",function(e){var t=e.memo.node;t.isSelected()&&this._enableDataChooserButtons(!0),this.setRealmProps(t.param)}.bind(D)),e.observe("node:selected",function(e){this._enableDataChooserButtons(!1),this.setRealmProps(null)}.bind(D)),e.observe("nodeIcon:click",function(e){e.memo.node.childs>0&&(this.setRealmProps(null),this._enableReportTypeButtons(!1))}.bind(D)),e.observe("children:loaded",function(e){e.memo.nodes.each(function(e){D._processTreeNodeIcon(e)}.bind(this))});var t=function(){var e=l.trees[D.DomainTreeContainerId],t=e.getRootNode().childs,o=[];o=function e(t){for(var o=[],n=0;n<t.length;n++)"com.jaspersoft.commons.semantic.datasource.SemanticLayerDataSource"==t[n].param.type?o.push(t[n]):o=o.concat(e(t[n].childs));return o}(t);for(var n=0;n<o.length;n++)e.openAndSelectNode(o[n].param.uri,null),this.setRealmProps(o[n].param),o[n].parent;o.length>0&&(e.openAndSelectNode(o[0].param.uri,null),this.setRealmProps(o[0].param)),D._toggleEnableDisableReportBtns(e),D._processTreeNodeIcon(e.getRootNode()),D.hideRealmTree(D.getRealmType())}.bind(D);e.showTreePrefetchNodes(D.DefaultDomainsPath,t,f),this._markAdhocTypeAsSelected(this.DOMAIN)},getOlapConnections:function(){var e;e=i(this.OlapConnectionsTreeContainerId).childElements().length<1?D.getOlapConnectionsTree():l.trees[D.OlapConnectionsTreeContainerId],this.setSelectedRealmDescription(""),e.observe("leaf:selected",function(e){var t=e.memo.node;t.isSelected()&&this._enableOlapCrosstabButtons(!0),this.setRealmProps(t.param)}.bind(D)),e.observe("node:selected",function(e){this._enableOlapCrosstabButtons(!1),this.setRealmProps(null)}.bind(D)),e.observe("nodeIcon:click",function(e){e.memo.node.childs>0&&(this.setRealmProps(null),this._enableReportTypeButtons(!1))}.bind(D)),e.observe("children:loaded",function(e){e.memo.nodes.each(function(e){D._processTreeNodeIcon(e)}.bind(this))});var t=function(){var e=l.trees[D.OlapConnectionsTreeContainerId],t=this._getAllLeaves(e.getRootNode()),o=t.find(function(e){return e.param.uri===D.DefaultOlapConnectionPath}.bind(D));o&&(e.openAndSelectNode(o.param.uri,null),this.setRealmProps(o.param)),D._toggleEnableDisableReportBtns(e),D._processTreeNodeIcon(e.getRootNode()),D.hideRealmTree(D.getRealmType())}.bind(D);e.showTreePrefetchNodes(D.DefaultOlapConnectionPath,t,f),this._markAdhocTypeAsSelected(this.OLAP_CONNECTION)},_getAllLeaves:function(e){var t=[];return e.isParent()?e.childs.each(function(e){t=t.concat(D._getAllLeaves(e))}):t.push(e),t},getTopicsTree:function(){return l.createRepositoryTree(D.TopicsTreeContainerId,{providerId:"topicTreeDataProvider",rootUri:"/",bShowRoot:!1,treeErrorHandlerFn:function(){}})},getDomainsTree:function(){return l.createRepositoryTree(D.DomainTreeContainerId,{providerId:"semanticTreeDataProvider",rootUri:"/",bShowRoot:!1,treeErrorHandlerFn:function(){}})},getOlapConnectionsTree:function(){return D.createOlapConnectionsTree(D.OlapConnectionsTreeContainerId,{providerId:"olapConnectionTreeDataProvider",rootUri:"/",bShowRoot:!1,treeErrorHandlerFn:function(){},hideLoader:!0})},startWithRealm:function(e){var t,o=this.getRealmSubType(),n=this.getRealmURI(),s="";"Topic"===o?t="startAdHocWithTopic":"SLDS"===o?t="startQueryBuilder":"Cube"===o&&(t="startAdhocForOlap",n=n.substring(0,n.lastIndexOf("/")),s="cube="+h(this.getRealmName())),p(t)&&p(e)&&p(n)&&(this._enableReportTypeButtons(!1),this._enableDataChooserButtons(!1),this._enableOlapCrosstabButtons(!1),document.location="flow.html?_flowId=adhocFlow&realm="+encodeURIComponent(encodeURIComponent(n))+"&_flowExecutionKey="+window.flowExecutionKey+"&reportType="+e+"&_eventId="+t+(s?"&"+s:"")+"&decorate="+(y.initAdditionalUIComponents?"yes":"no")+(window.isEmbeddedDesigner?"&embeddedDesigner=true":""))},getReportType:function(){var e=a("#reportTypes >.selected")[0];return e?i(e).readAttribute("id"):"table"},getRealmType:function(){var e=a("#sourceFilter >.selected");return e.length?e[0].readAttribute("id"):D.TOPIC},hideRealmTree:function(e){D._showTopicsTree(e===this.TOPIC),D._showDomainsTree(e===this.DOMAIN),D._showOlapConnectionsTree(e===this.OLAP_CONNECTION)},_markAdhocTypeAsSelected:function(e){[this.TOPIC,this.DOMAIN,this.OLAP_CONNECTION].each(function(e){i(e).removeClassName(_.SELECTED_CLASS)}),i(e).addClassName(_.SELECTED_CLASS)},_showTopicsTree:function(e){if(e)i("topicsTreeArea").removeClassName(_.HIDDEN_CLASS),i("reportTypes").removeClassName(_.HIDDEN_CLASS);else{var t=l.trees[D.TopicsTreeContainerId],o=t?t.getSelectedNode():null;o&&o.deselect(),i("topicsTreeArea").addClassName(_.HIDDEN_CLASS),i("reportTypes").addClassName(_.HIDDEN_CLASS)}},_showDomainsTree:function(e){if(e)i(D.DomainTreeContainerId).removeClassName(_.HIDDEN_CLASS),i("dataChooserBtn").removeClassName(_.HIDDEN_CLASS);else{var t=l.trees[D.DomainTreeContainerId],o=t?t.getSelectedNode():null;o&&o.deselect(),i(D.DomainTreeContainerId).addClassName(_.HIDDEN_CLASS),i("dataChooserBtn").addClassName(_.HIDDEN_CLASS)}},_showOlapConnectionsTree:function(e){if(e)i(D.OlapConnectionsTreeContainerId).removeClassName(_.HIDDEN_CLASS),i("olapTypes").removeClassName(_.HIDDEN_CLASS);else{var t=l.trees[D.OlapConnectionsTreeContainerId],o=t?t.getSelectedNode():null;o&&o.deselect(),i(D.OlapConnectionsTreeContainerId).addClassName(_.HIDDEN_CLASS),i("olapTypes").addClassName(_.HIDDEN_CLASS)}},cancelRealms:function(){history.back()},cancelTopic:function(e){e?history.back():this.redirectToHomePage()},redirectToHomePage:function(){r(document).trigger("adhocDesigner:cancel"),document.location="flow.html?_flowId=homeFlow"},getRealmURI:function(){return this.selectedRealmURI},getRealmSubType:function(){return this.selectedSubType},getRealmName:function(){return this.selectedRealmName},setSelectedRealmDescription:function(e){r("nodeDescription").html("object"==n(e)?"":e)},setRealmProps:function(e){p(e)&&p(e.extra)?(this.selectedRealmURI=e.uri,this.selectedRealmName=e.id,this.selectedSubType=e.extra.subType,this.setSelectedRealmDescription(e.extra.desc)):(this.selectedRealmURI="",this.selectedRealmName="",this.selectedSubType="",this.setSelectedRealmDescription(""))},_enableReportTypeButtons:function(e){a("fieldset#reportTypes > .button").each(function(t){e?i(t).writeAttribute("disabled",null):i(t).writeAttribute("disabled","disabled")})},_enableDataChooserButtons:function(e){if(e){var t=l.trees[D.DomainTreeContainerId],o=t&&t.getSelectedNode();o&&(e="sl.no.ds"!==o.param.id),!e&&o&&o.deselect()}i("dataChooserBtn").writeAttribute("disabled",e?null:"disabled")},_enableOlapCrosstabButtons:function(e){if(e){var t=l.trees[D.OlapConnectionsTreeContainerId],o=t&&t.getSelectedNode();o&&(e="olap.no.ds"!==o.param.id),!e&&o&&o.deselect()}N[e?"enable":"disable"](i("olapChartBtn")),N[e?"enable":"disable"](i("olapCrosstabBtn"))},_enableCancelButtons:function(){a("#cancel.button").each(function(e){i(e).writeAttribute("disabled",null)})}};D.createOlapConnectionsTree=function(e,t){return D.RepositoryFolder=function(e){l.TreeNode.call(this,e),this.Types={Folder:new l.TreeNode.Type("com.jaspersoft.jasperserver.api.metadata.common.domain.Folder"),MondrianConnection:new l.TreeNode.Type("com.jaspersoft.ji.ja.security.domain.MondrianConnection"),SecureMondrianConnection:new l.TreeNode.Type("com.jaspersoft.ji.ja.security.domain.SecureMondrianConnection"),XMLConnection:new l.TreeNode.Type("com.jaspersoft.jasperserver.api.metadata.olap.domain.XMLAConnection"),SuperRoot:new l.TreeNode.Type("superroot"),Root:new l.TreeNode.Type("root")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_folders:folders"},D.RepositoryFolder.prototype=T(l.RepositoryFolder.prototype),D.RepositoryFolder.addMethod("isParent",function(){return this.param.type==this.Types.Folder.name||this.param.type==this.Types.SuperRoot.name||this.param.type==this.Types.Root.name||this.param.type==this.Types.MondrianConnection.name||this.param.type==this.Types.SecureMondrianConnection.name||this.param.type==this.Types.XMLConnection.name}),l.createRepositoryTree(e,Object.extend({nodeClass:D.RepositoryFolder},t))},void 0===e&&document.observe("dom:loaded",D.initialize.bind(D)),o.exports=D});