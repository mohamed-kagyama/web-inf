/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","jquery","runtime_dependencies/jrs-ui/src/util/utils.common","../base/designer.base","runtime_dependencies/jrs-ui/src/util/touch.controller","runtime_dependencies/jrs-ui/src/core/core.events.bis","underscore","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/components/list.base","runtime_dependencies/jrs-ui/src/components/components.dialogs"],function(e,t,i){var s=e("dragdropextra"),o=s.Droppables,r=e("prototype"),n=r.$,l=r.$$,d=e("jquery"),h=e("runtime_dependencies/jrs-ui/src/util/utils.common"),a=h.doNothing,c=h.isSupportsTouch,u=h.matchAny,_=h.isIPad,T=e("../base/designer.base"),m=e("runtime_dependencies/jrs-ui/src/util/touch.controller"),g=e("runtime_dependencies/jrs-ui/src/core/core.events.bis"),f=e("underscore"),S=e("runtime_dependencies/jrs-ui/src/core/core.layout"),A=e("runtime_dependencies/jrs-ui/src/components/list.base"),E=A.dynamicList,v=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),D={TEMPLATE_ID:"sortDialog",SORT_FIELDS_LIST_TEMPLATE_ID:"list_fields_hideRoot_column_simple",SORT_FIELDS_ITEM_TEMPLATE_ID:"list_fields_hideRoot_column_simple:leaf",AVAILABLE_ID:"sortDialogAvailable",AVAILABLE_FIELDS_PROVIDER_ID:"availableFieldsTreeDataProvider",SORT_FIELDS_ID:"sortDialogSortFields",OK_PATTERN:"#sortDialogOk",CANCEL_PATTERN:"#sortDialogCancel",ADD_PATTERN:"#sortDialogAddToSort",TO_TOP_PATTERN:"#sortDialogToTop",TO_BOTTOM_PATTERN:"#sortDialogToBottom",UP_PATTERN:"#sortDialogUpward",DOWN_PATTERN:"#sortDialogDownward",REMOVE_PATTERN:"#sortDialogRemoveFromSort",BUTTON_PATTERN:"#sortDialogSortFields .icon.button",DROP_CLASS:"dragging",SORT_DRAG_CLASS:".draggable",EVENT:{SORT:"sort:sort"},initialize:function(){this.originalSortFields=[],this.preselectedFieldNames=null,this._dialog=n(this.TEMPLATE_ID),this._add=l(this.ADD_PATTERN)[0],this._remove=l(this.REMOVE_PATTERN)[0],this._ok=l(this.OK_PATTERN)[0],this._cancel=l(this.CANCEL_PATTERN)[0],this._toTop=l(this.TO_TOP_PATTERN)[0],this._toBottom=l(this.TO_BOTTOM_PATTERN)[0],this._up=l(this.UP_PATTERN)[0],this._down=l(this.DOWN_PATTERN)[0],this.tree=this.createAvailableFieldsTree(),this.list=this.createSortFieldsList(),this.actionHash={"#sortDialogOk":function(e){this.hideDialog()},"#sortDialogCancel":function(e){this.fire(this.EVENT.SORT,{fields:this.originalSortFields,hide:!0})},"#sortDialogAddToSort":function(e){this._addToSort()},"#sortDialogRemoveFromSort":function(e){this._removeFromSort()},"#sortDialogUpward":function(e){this._oneStepMoveTo(!0)},"#sortDialogDownward":function(e){this._oneStepMoveTo(!1)},"#sortDialogToTop":function(e){this._moveTo(!0)},"#sortDialogToBottom":function(e){this._moveTo(!1)},"li .icon.button":function(e){this._toggleSortOrder(this.list.getItemByEvent(e))}},this.actionHash.getAction=function(e){for(var t in this)if(e.match(t)&&"getAction"!=t)return this[t];return a},this.observe("sort:sort",function(e){window.adhocDesigner.setSorting(e.memo.fields,function(){e.memo.hide&&D.hideDialog()})}),this._dialog.observe(c()?"touchend":"mouseup",function(e){var t=e.element(),i=u(t,[this.ADD_PATTERN,this.REMOVE_PATTERN,this.OK_PATTERN,this.CANCEL_PATTERN,this.BUTTON_PATTERN,this.UP_PATTERN,this.DOWN_PATTERN,this.TO_TOP_PATTERN,this.TO_BOTTOM_PATTERN],!0);i&&this.actionHash.getAction(i).bind(this)(e)}.bindAsEventListener(this))},updateAndShowAvailableFieldsTree:function(e){var t=function(){this.tree=this.createAvailableFieldsTree(e),this.tree.showTree(20)}.bind(this);T.sendRequest(window.adhocDesigner.getControllerPrefix()+"_updateAvailableTree",[],t,{target:"ajaxbuffer",bPost:!0})},createAvailableFieldsTree:function(e){var t=window.adhocDesigner.getAvailableFieldsTree(this.AVAILABLE_ID,D.AVAILABLE_FIELDS_PROVIDER_ID);if(t.DEFAULT_TREE_CLASS_NAME="responsive fields",t.multiSelectEnabled=!0,_()){var i=n(this.AVAILABLE_ID);new m(i,i.up(1))}t.observe("tree:loaded",function(i){f.each(window.adhocDesigner.getAllLeaves(null,t),function(e){window.adhocDesigner.findFieldByName(e.param.id).aggregateField&&window.adhocDesigner.removeNodeFromTree(e)}),e&&e.length>0&&e.each(function(e){t.openAndSelectNode(e)}.bind(this)),this._addSortFieldsToList(),g.disable(this._add)}.bindAsEventListener(this)),t.observe("leaf:dblclick",function(e){this._addToSort(e.memo.node)}.bindAsEventListener(this));var s=this._refreshAddButton;return t.observe("leaf:selected",s.bindAsEventListener(this)),t.observe("node:selected",s.bindAsEventListener(this)),t.observe("leaf:unselected",s.bindAsEventListener(this)),t.observe("node:unselected",s.bindAsEventListener(this)),o.remove(t.getId()),o.add(t.getId(),{accept:[this.SORT_FIELDS_ID],hoverclass:S.DROP_TARGET_CLASS,onDrop:function(e,t,i){e.items&&this._removeFromSort()}.bind(this)}),t},createSortFieldsList:function(){var e=new E.List(this.SORT_FIELDS_ID,{listTemplateDomId:this.SORT_FIELDS_LIST_TEMPLATE_ID,itemTemplateDomId:this.SORT_FIELDS_ITEM_TEMPLATE_ID,excludeFromSelectionTriggers:[this.BUTTON_PATTERN],dragPattern:_()?void 0:this.SORT_DRAG_CLASS,multiSelect:!0,selectOnMousedown:!_(),comparator:function(e,t){var i=e.getValue().order,s=t.getValue().order;return i>s?1:i<s?-1:0}});return e.observe("item:selected",function(t){e.getSelectedItems().length>0&&g.enable(this._remove),this._refreshMoveButtons()}.bindAsEventListener(this)),e.observe("item:unselected",function(t){0===e.getSelectedItems().length&&g.disable(this._remove),this._refreshMoveButtons()}.bindAsEventListener(this)),e.observe("item:dblclick",function(e){this._removeFromSort(e.memo.item)}.bindAsEventListener(this)),o.add(n(this.SORT_FIELDS_ID),{accept:[this.AVAILABLE_ID],hoverclass:S.DROP_TARGET_CLASS,onDrop:function(e,t,i){e.node&&this._addToSort()}.bind(this)}),e},createSortFieldItem:function(e){var t=new E.ListItem({label:e.label,value:e});return t.refreshStyle=function(){E.ListItem.prototype.refreshStyle.call(this);var e=this.getValue().isAsc,t=this._getElement();t&&(e?(t.addClassName(S.ASCENDING_CLASS),t.removeClassName(S.DESCENDING_CLASS)):(t.addClassName(S.DESCENDING_CLASS),t.removeClassName(S.ASCENDING_CLASS)))},t},recreateSortFieldsScroll:function(){if(_()){var e=n(this.SORT_FIELDS_ID);return new m(e,e.up(1))}return null},getSortFields:function(){return this.list.getItems().collect(function(e){return e.getValue().toData()})},_isOriginalField:function(e){return this.originalSortFields.detect(function(t){return t.name==e}.bind(this))},_getMergedPreselectedWithOriginalFields:function(e){var t=this.originalSortFields?this.originalSortFields.slice(0):[],i=this;return d(e).each(function(){var e=this.toString();i._isOriginalField(e)||t.push({name:e,isAsc:!0})}),t},_addSortFieldsToList:function(){var e=this._getMergedPreselectedWithOriginalFields(this.preselectedFieldNames),t=[],i=[],s=[],o=this;d(e).each(function(e){var r=o.tree.findNodeById(this.name);if(r){var n=new D.Field(r,this.isAsc,e).item;t.push(r),o.preselectedFieldNames&&d.inArray(this.name,o.preselectedFieldNames)>-1&&i.push(n),s.push(n)}}),this.list.setItems(s),d(t).each(function(){this.refreshStyle()}),this.list.show(),this.recreateSortFieldsScroll(),d(i).each(function(){this.select()}),e&&e.length!==(this.originalSortFields?this.originalSortFields.length:0)&&this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1})},launchDialog:function(e){v.popup.show(this._dialog),this.list.setItems([]),this.list.show(),[this._add,this._remove,this._up,this._down,this._toTop,this._toBottom].each(function(e){g.disable(e)}),this.originalSortFields=window.localContext.state.sortFields||[];var t=this.originalSortFields.collect(function(e){return D.Util.fieldNameToUriList(e.name)}).flatten();if(d.isArray(e)){this.preselectedFieldNames=e;for(var i=0;i<e.length;i++)t=t.concat(D.Util.fieldNameToUriList(e[i]))}else this.preselectedFieldNames=e?[e]:null,e&&(t=t.concat(D.Util.fieldNameToUriList(e)));this.updateAndShowAvailableFieldsTree(t)},hideDialog:function(){v.popup.hide(this._dialog)},stopObserving:function(e,t){this._dialog.stopObserving(e,t)},observe:function(e,t){this._dialog.observe(e,t)},fire:function(e,t){this._dialog.fire(e,t)},_isOnlyFieldsSelected:function(){return this.tree.getSelectedNode()&&!this.tree.selectedNodes.detect(function(e){return e.isParent()||e.param.id===T.SPACER_NAME})},_getOnlyChildren:function(e){var t=[];return e.each(function(e){e.isParent()?t=t.concat(this._getOnlyChildren(e.childs)):t.push(e)}.bind(this)),t},_toggleSortOrder:function(e){e.getValue().isAsc=!e.getValue().isAsc,e.refresh(),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1})},_addToSort:function(e){if(this._isOnlyFieldsSelected()){var t=this._getOnlyChildren(e?[e]:this.tree.selectedNodes),i=this.list.getItems(),s=t.collect(function(e,t){return new D.Field(e,!0,i.length+t).item}.bind(this));this.list.addItems(s),t.invoke("refreshStyle"),t.invoke("deselect"),this.list.refresh(),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1}),this._refreshAddButton(),this._refreshMoveButtons()}},_removeFromSort:function(e){var t=e?[e]:this.list.getSelectedItems(),i=this.tree;this.list.removeItems(t),t.each(function(e){var t=e.getValue();i._deselectAllNodes(),t.node.hidden=!1,t.node.refreshStyle(),t.node.select()}),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1}),this._refreshMoveButtons()},_oneStepMoveTo:function(e){var t=this.list.getItems(),i=this.list.getSelectedItems();e||(t=t.clone().reverse());var s=e?-1:1,o=null;t.each(function(e){var t=i.detect(function(t){return t==e});t&&o?(o.getValue().order-=s,t.getValue().order+=s):o=e}),this._resort()},_moveTo:function(e){var t=this.list.getItems(),i=this.list.getSelectedItems(),s=t.findAll(function(e){return!i.include(e)});e||(i=i.clone().reverse(),s=s.clone().reverse());var o=e?1:-1,r=e?0:t.length,n=function(e){e.getValue().order=r,r+=o};i.each(n),s.each(n),this._resort()},_resort:function(){this.list.sort(),this.list.show(),this._refreshMoveButtons(),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1})},_refreshMoveButtons:function(){var e=this.list.getItems(),t=this.list.getSelectedItems(),i=e.length>1&&t.length>0,s=i&&!(1==t.length&&t[0].first),o=i&&!(1==t.length&&t[0].last);[this._toTop,this._up].each(function(e){(s?g.enable:g.disable)(e)}),[this._toBottom,this._down].each(function(e){(o?g.enable:g.disable)(e)})},_refreshAddButton:function(){(this._isOnlyFieldsSelected()?g.enable:g.disable)(this._add)}};D.Util={fieldNameToUri:function(e){return"/"+e},fieldNameToUriList:function(e){var t=e.split("."),i=t.slice(0,t.length-1).collect(function(e,i){return"/"+t.slice(0,i+1).join("/")});return i.length>0&&i.push(i.last()+"/"+e),i.push("/"+e),i},uriToFiledName:function(e){var t=e.split("/");return t[t.length-1]}},D.Field=function(e,t,i){this.name=D.Util.uriToFiledName(e.param.uri),this.label=e.name,this.isAsc=!!t,this.order=i||0,this.node=e,this.item=D.createSortFieldItem(this),this.node&&(this.node.hidden=!0)},D.Field.addMethod("toData",function(){return{name:this.name,isAsc:this.isAsc}}),D.Field.addMethod("toJSON",function(){return this.toData()}),i.exports=D});