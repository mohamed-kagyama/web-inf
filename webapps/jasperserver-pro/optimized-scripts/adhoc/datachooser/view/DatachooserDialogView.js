/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/js-sdk/src/common/component/dialog/Dialog","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","runtime_dependencies/js-sdk/src/common/component/tree/Tree","runtime_dependencies/js-sdk/src/common/component/tree/TreeDataLayer","runtime_dependencies/js-sdk/src/common/component/panel/trait/tabbedPanelTrait","runtime_dependencies/js-sdk/src/common/component/tree/plugin/TooltipPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/SearchPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/InfiniteScrollPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/NoSearchResultsMessagePlugin","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","bundle!adhoc_messages","bundle!CommonBundle","runtime_dependencies/js-sdk/src/common/util/browserDetection","text!../template/datachooserDialogTemplate.htm","text!../template/dataChooserTreeLeafTemplate.htm","text!../template/tooltip/sidebarTreeLeafTooltipTemplate.htm","text!../template/datachooserTabTemplate.htm","settings!treeComponent","runtime_dependencies/bi-repository/src/bi/repository/util/resourcesTreeGetDataUriFnUtil","runtime_dependencies/bi-repository/src/bi/repository/util/extractRootLevelDataFromHtmlResponse","runtime_dependencies/js-sdk/src/jrs.configs"],function(e,t,i){function r(e){switch(e.value.resourceType){case T.REPORT_UNIT:e.cssClass="topic";break;case T.DOMAIN_TOPIC:e.cssClass="domain topic";break;case T.SEMANTIC_LAYER_DATA_SOURCE:e.cssClass="domain";break;case T.OLAP_CUBE:e.cssClass="olap"}return e}var s=e("underscore"),o=e("jquery"),n=e("runtime_dependencies/js-sdk/src/common/component/dialog/Dialog"),a=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),c=e("runtime_dependencies/js-sdk/src/common/component/tree/Tree"),l=e("runtime_dependencies/js-sdk/src/common/component/tree/TreeDataLayer"),u=e("runtime_dependencies/js-sdk/src/common/component/panel/trait/tabbedPanelTrait"),p=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/TooltipPlugin"),d=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/SearchPlugin"),h=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/InfiniteScrollPlugin"),m=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/NoSearchResultsMessagePlugin"),T=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),_=e("bundle!adhoc_messages"),g=e("bundle!CommonBundle"),D=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),y=e("text!../template/datachooserDialogTemplate.htm"),C=e("text!../template/dataChooserTreeLeafTemplate.htm"),f=e("text!../template/tooltip/sidebarTreeLeafTooltipTemplate.htm"),b=e("text!../template/datachooserTabTemplate.htm"),O=e("settings!treeComponent"),E=e("runtime_dependencies/bi-repository/src/bi/repository/util/resourcesTreeGetDataUriFnUtil"),R=e("runtime_dependencies/bi-repository/src/bi/repository/util/extractRootLevelDataFromHtmlResponse"),A=e("runtime_dependencies/js-sdk/src/jrs.configs"),I=A.contextPath,S=parseInt(O.treeLevelLimit,10),L=[T.DOMAIN_TOPIC,T.TOPIC,T.SEMANTIC_LAYER_DATA_SOURCE],v=[T.SECURE_MONDRIAN_CONNECTION,T.MONDRIAN_CONNECTION,T.XMLA_CONNECTION],N=E({getFolderUri:function(e){return"@fakeRoot"===e?"":e},contextPath:I,recursive:!0,forceTotalCount:!0,forceFullPage:!0}),P=[T.MONDRIAN_CONNECTION,T.SECURE_MONDRIAN_CONNECTION,T.XMLA_CONNECTION];i.exports=n.extend({events:{resize:"onResizeHeight"},onResizeHeight:function(){this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.listTreeView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight-6),this.hierarhicalTreeView.rootLevel.list.$el.css("height","100%")},constructor:function(e){e||(e={}),this._dfdRenderSerachFormTo=o.Deferred();var t=this._getParameterByName("reportType");t=t||"crosstab",this.reportType="chart"===t?"ichart":t,this.decorate=this._getParameterByName("decorate")||"yes",this.isEmbeddedDesigner=this._getParameterByName("embeddedDesigner");var i,a=e.resourcesTypes;a||(a="table"===this.reportType?L:L.concat(v)),i=E({getFolderUri:function(e){return"@fakeRoot"===e?"":e},contextPath:I,recursive:!1,type:a,containerType:T.FOLDER,forceTotalCount:!0,forceFullPage:!0});var D={attachTo:this.$el,i18n:_,contentTemplate:f},O=c.use(p,D).use(h).create(),A=e.resourcesTypes;A||(A=s.union([T.TOPIC,T.DOMAIN_TOPIC,T.SEMANTIC_LAYER_DATA_SOURCE],P));var w=c.use(p,D).use(m).use(d,{additionalParams:{type:"table"===this.reportType?s.first(A,3):A},dfdRenderTo:this._dfdRenderSerachFormTo}).create(),k={treeNodeProcessor:{processItem:function(e){return e._node=s.contains(s.union([T.FOLDER],P),e.value.resourceType),e}},i18nItemProcessor:{processItem:function(e){return e.i18n=g,e}},filterPublicFolderProcessor:{processItem:function(e){if("/public"!==e.value.uri)return e}},filterTempFolderProcessor:{processItem:function(e){if(!e.value.uri.match(/\/temp\//)&&!e.value.uri.match(/\/temp$/))return e}},filterEmptyFoldersProcessor:{processItem:function(e){if("folder"!==e.value.resourceType||""!==e.value._links.content)return e}},cssClassItemProcessor:{processItem:r}},U=new l({requestType:"POST",dataUriTemplate:I+"/rest_v2/connections",processors:[k.i18nItemProcessor,k.cssClassItemProcessor],levelDataId:"uri",getDataArray:function(e,t,i){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]}}),x=function(e){if(s.contains(P,e.resource.resourceType)){var t=s.clone(this.customDataLayers.olapDataLayer);return s.extend(t,{accept:"application/repository."+e.resource.resourceType+".metadata+json",contentType:"application/repository."+e.resource.resourceType+"+json",data:JSON.stringify(e.resource)}),t}return this.customDataLayers&&this.customDataLayers[e.id]?this.customDataLayers[e.id]:this.defaultDataLayer};this.hierarhicalTreeView=O.instance({itemsTemplate:C,listItemHeight:26,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,bufferSize:S,additionalCssClasses:"folders",getDataUri:i,levelDataId:"uri",customDataLayers:{"/":s.extend(new l({dataUriTemplate:I+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:s.chain(k).omit("filterPublicFolderProcessor").values().value(),getDataArray:function(e){e=R(e);var t=s.find(e.children,function(e){return"/public"===e.uri}),i=[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}}];return t&&i.push({id:"/public",label:t.label,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}),i}}),{accept:"text/html",dataType:"text"}),olapDataLayer:U},processors:s.values(k),getDataArray:function(e,t,i){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,i){return+i.getResponseHeader("Total-Count")},getDataLayer:x}),this.listTreeView=w.instance({rootLevelHeight:s.bind(this.getContentHeight,this),itemsTemplate:C,listItemHeight:26,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,getDataUri:N,levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:[{processItem:function(e){return e._node=s.contains(P,e.value.resourceType),e}},k.i18nItemProcessor,k.cssClassItemProcessor,k.filterTempFolderProcessor],customDataLayers:{olapDataLayer:U},getDataLayer:x,getDataArray:function(e,t,i){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,i){return+i.getResponseHeader("Total-Count")}}),n.prototype.constructor.call(this,{template:y,modal:!0,resizable:!0,additionalCssClasses:"sourceDialogNew",title:_.ADH_108_DATA_CHOOSER_DIALOG_TITLE,traits:[u],tabHeaderContainerSelector:".tabHeaderContainer",tabContainerClass:"tabContainer control groupBox treeBox",optionTemplate:b,toggleClass:"down",tabs:[{label:_.ADH_108_DATA_CHOOSER_FOLDERS_TAB,action:"tree",content:this.hierarhicalTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:_},{label:_.ADH_108_DATA_CHOOSER_LIST_TAB,action:"list",content:this.listTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:_}],buttons:[{label:_.ADH_016_BUTTON_OK,action:"apply",primary:!0},{label:_.ADH_010_BUTTON_CANCEL,action:"cancel",primary:!1}]}),this.disableButton("apply"),this.on("button:apply",s.bind(this._onSelectDataDialogOkButtonClick,this)),this.on("button:cancel",s.bind(this._onSelectDataDialogCancelButtonClick,this))},initialize:function(e){var t=function(e){var t=s.find(this.buttons.options,function(e){return"apply"===e.model.attributes.action}).$el,i=e&&s.isArray(e)&&e[0],r=i?e[0].uri:void 0,o=i?e[0].resourceType:void 0;return i||r||o?(o!==T.FOLDER?this.$(".itemDescription").text(i.description||""):this.$(".itemDescription").empty(),o===T.SEMANTIC_LAYER_DATA_SOURCE?t.find(".wrap").text(_.ADH_108_DATA_CHOOSER_DOMAIN_LABEL):t.find(".wrap").text(_.ADH_016_BUTTON_OK),s.contains(s.union([T.FOLDER],P),o)?(delete this.resourceData,void this.disableButton("apply")):(this.resourceData={},o===T.OLAP_CUBE?(this.resourceData.resourceUri=r.substring(0,r.lastIndexOf("/")),this.resourceData.cube=r.substring(r.lastIndexOf("/")+1),this.resourceData.reportType="olap_"+this.reportType):(this.resourceData.resourceUri=r,this.resourceData.reportType=this.reportType),this.resourceData.event=this._getAdHocFlowEvent(o),this.resourceData.flowExecutionKey=window.flowExecutionKey,void this.enableButton("apply"))):(this.disableButton("apply"),void this.$(".itemDescription").empty())};this.errorDialog=new a,this.listenTo(this.hierarhicalTreeView,"selection:change",t),this.listenTo(this.listTreeView,"selection:change",t),this.listenTo(this.hierarhicalTreeView,"levelRenderError",s.bind(this._onLevelRenderError,this.errorDialog)),this.listenTo(this.listTreeView,"levelRenderError",s.bind(this._onLevelRenderError,this.errorDialog)),this.listenTo(this.hierarhicalTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.listTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.listTreeView.rootLevel,"ready",this.onResizeHeight,this),this.listenTo(this.hierarhicalTreeView.rootLevel,"ready",this.onResizeHeight,this),this.listenTo(this.listTreeView.searchForm,"search",this._onSearch),this.listenTo(this.listTreeView.searchForm,"clear",this._resetItemSelection),this.on("tab:tree tab:list",this._resetItemSelection,this),n.prototype.initialize.apply(this,arguments)},getContentHeight:function(){return this.$el.height()-this._resizableContainerShiftHeight},render:function(){return n.prototype.render.apply(this,arguments),this._dfdRenderSerachFormTo.resolve(this.$tabHeaderContainer),this.openTab("list"),this},open:function(){var e=this;e._resizableContainerShiftHeight=6,n.prototype.open.apply(this,arguments);var t=s.bind(function(){this.$contentContainer.find(".tabContainer").css({height:"inherit","overflow-y":"auto"})},this);D.isIE8()||D.isIE9()?setTimeout(t,1):t(),this.$el.children().not(".subcontainer").not(".ui-resizable-e").not(".ui-resizable-se").each(function(){e._resizableContainerShiftHeight+=e.$(this).outerHeight(!0)}),this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight)},close:function(){this.hierarhicalTreeView&&(this.hierarhicalTreeView.collapse("@fakeRoot",{silent:!0}),this.hierarhicalTreeView.collapse("/public",{silent:!0}),this.hierarhicalTreeView.resetSelection()),n.prototype.close.apply(this,arguments)},_onSearch:function(){this.openTab("list"),this.disableButton("apply")},_resetItemSelection:function(){this.hierarhicalTreeView.resetSelection(),this.listTreeView.resetSelection(),this.$(".itemDescription").empty()},_getAdHocFlowEvent:function(e){var t="";return e==T.REPORT_UNIT||e==T.DOMAIN_TOPIC?t="startAdHocWithTopic":e==T.SEMANTIC_LAYER_DATA_SOURCE?t="startQueryBuilder":e===T.OLAP_CUBE&&(t="startAdhocForOlap"),t},_onSelectDataDialogOkButtonClick:function(){this.resourceData&&(document.location="flow.html?_flowId=adhocFlow&realm="+encodeURIComponent(encodeURIComponent(this.resourceData.resourceUri))+"&_flowExecutionKey="+this.resourceData.flowExecutionKey+"&reportType="+this.resourceData.reportType+"&embeddedDesigner="+this.isEmbeddedDesigner+"&decorate="+this.decorate+"&_eventId="+this.resourceData.event+(this.resourceData.cube?"&cube="+this.resourceData.cube:""))},_onLevelRenderError:function(e,t,i){t=JSON.parse(t);var r=t.message;t.parameters&&(r=t.parameters[0].substring(t.parameters[0].indexOf(": ")+2,t.parameters[0].indexOf("\n"))),this.setMessage(r),this.open(),i.$el.removeClass(i.loadingClass).addClass(i.openClass)},_onSelectDataDialogCancelButtonClick:function(){this.close(),this.isEmbeddedDesigner&&-1===document.referrer.indexOf("login.html")&&o(document).trigger("adhocDesigner:cancel")},_getParameterByName:function(e){var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null==i?"":decodeURIComponent(i[1].replace(/\+/g," "))}})});