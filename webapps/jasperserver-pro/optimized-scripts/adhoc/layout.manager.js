/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","jquery","underscore","runtime_dependencies/js-sdk/src/common/util/classUtil","runtime_dependencies/js-sdk/src/common/util/xssUtil","bundle!adhoc_messages","runtime_dependencies/jrs-ui/src/components/components.dialogs","backbone","./designer/aggregateFieldLabelFactory","./designer/VisualizationType","text!./template/tableLayoutManagerTemplate.htm","text!./template/crosstabLayoutManagerTemplate.htm","runtime_dependencies/js-sdk/src/common/util/browserDetection","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/core/core.layout"],function(e,t,n){function i(e){return u.inject(e,function(e,t){return e.concat(s(t))},[])}function s(e,t){var n=t||[];if(!e.childs||0===e.childs.length)return n.push(e),n;for(var i=0;i<e.childs.length;i++)s(e.childs[i],n);return n}function a(e){return Draggable._dragging[e.jquery?e[0]:e]}function r(e){return e.map(function(e){return e.toPresentation()})}var o,l=e("prototype"),m=l.$,d=e("jquery"),u=e("underscore"),c=e("runtime_dependencies/js-sdk/src/common/util/classUtil"),h=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),p=e("bundle!adhoc_messages"),f=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),v=e("backbone"),x=e("./designer/aggregateFieldLabelFactory"),g=e("./designer/VisualizationType"),_=e("text!./template/tableLayoutManagerTemplate.htm"),b=e("text!./template/crosstabLayoutManagerTemplate.htm"),y=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),M=e("runtime_dependencies/jrs-ui/src/util/utils.common"),E=M.isSupportsTouch,A=e("runtime_dependencies/jrs-ui/src/core/core.layout"),N=y.isIE(),I=h.unescape,D=null,R=c.extend({axes:{},template:null,constructor:function(e){this.initProperties(e.common),this.initialized&&(this.initModeSpecificBehavior(this.mode),this.initAxes(e.axes),this.initEventListeners())},initProperties:function(e){e&&(this.measuresGroupId=e.measuresGroupId,this.isOlapMode=!!e.isOlapMode,this.mode=e.mode,this.element=d("#"+e.id),this.initialized=!!this.element[0])},initModeSpecificBehavior:function(e){u.extend(this,D[e]),this.AxisModel=e==g.table?T:L},initAxes:function(e){u.each(e,function(e){var t=u.clone(e);t.element=d("#"+t.elementId),this.axes[t.elementId]=t,this.setAxisModel(t,new this.AxisModel([],{parse:!0}))},this)},getTemplate:function(){if(null===this.template){var e=this.mode==g.table?_:b;this.template=u.template(e,null,{variable:"data"})}return this.template},render:function(e,t){this.initialized&&(u.each(this.axes,function(n){t||this.setAxisModel(n,new this.AxisModel(e[n.name],{parse:!0})),d(n.element).html(this.getTemplate()(n.model.toPresentation())),this.createSortable(n.element[0]),this.createMeasuresSortable(n.element[0])},this),Draggables.removeObserver(this.element[0]),Draggables.addObserver(new S(this.element[0],this.onMove)))},setAxisModel:function(e,t){e.model=t},initEventListeners:function(){u.bindAll(this,"onContextMenu","onRemove","onAdd","onMove","onMeasureReorder"),document.stopObserving(A.ELEMENT_CONTEXTMENU,o||d.noop),document.observe(A.ELEMENT_CONTEXTMENU,this.onContextMenu),o=this.onContextMenu;var e=E()?"touchend":"mouseup";d(this.element).undelegate("span.remove",e),d(this.element).delegate("span.remove",e,this.onRemove)},onContextMenu:function(e){var t=this,n=d(e.memo.node).closest("li.button"),i=n.hasClass("meazure")||n.hasClass("member"),s=n.closest(i?"li.measure":"li.dimension");if(n){var a=d(n).closest("ul.sortable").attr("id"),r=this.axes[a];if(r){Event.stop(e);var o=I(n.attr(this.nameAttr)),l=r.model.findQueryField({name:o});this.element.trigger("lm:contextMenu",u.extend(e.memo,{extra:{axis:r.name,axisId:a,name:o,fieldName:l.get("fieldName"),dimensionId:I(n.attr("data-dimension")),level:I(n.attr("data-level")),index:n.index(),groupIndex:s.index(),isMeasure:i,allLevels:n.siblings().addBack().map(function(){return I(d(this).attr(t.nameAttr))}).get()}}))}}},onRemove:function(e){var t=d(e.target).closest("li");if(!a(t)){var n=t.index(),i=this.axes[t.closest("ul.sortable").attr("id")],s=I(t.attr("data-dimension"));this.element.trigger("lm:removeItem",{axis:i.name,index:n,item:{level:I(t.attr("data-level")),dimensionId:s,isMeasure:this.measuresGroupId===s}})}},onAdd:function(e){var t=e.node;if(t){var n,i=d(e).index(),s=e.nodes||[t],a=this.axes[d(e).closest("ul").attr("id")],r=this[a.name].validateAdd,o=[];if(n=this.filter(s,a),r&&!r.call(this,n,i,a.name,o))return!u.isEmpty(o)&&f.systemConfirm.show(o,5e3),void this.render(this.axes,!0);this.add(n,i,a.name)}},add:function(e,t,n){var i;if(!u.isEmpty(e))if(1===e.length){i=e[0];var s=i.param.extra||i.param;this.element.trigger("lm:addItem",{axis:n,dimensionId:s.dimensionId,level:s.id,index:t,hierarchyName:s.hierarchyName,isMeasure:s.isMeasure})}else this.element.trigger("lm:addItems",{axis:n,levels:u.pluck(e,"param"),index:t})},onMove:function(e,t,n,i,s,a){var r=d(e.element),o=this.axes[n],l=this.axes[i],m=this[l.name].validateMove,c=[];if(!t||s!==a)return t||!m||m.call(this,o,l,r,c)?void this.element.trigger("lm:"+(t?"moveItem":"switchItem"),{axis:l.name,item:I(r.attr(this.moveAttr)),from:s,to:a}):(!u.isEmpty(c)&&f.systemConfirm.show(c.join("</br>"),5e3),void this.render(this.axes,!0))},onMeasureReorder:function(e,t){var n=d(t.element);y.isIE()&&(n.hasClass("dimension")||n.hasClass("dimenzion"))||this.element.trigger("lm:measureReorder",{measure:I(n.attr("data-level")),to:n.index()})},createSortable:function(e){Sortable.create(e,{delay:N?200:0,constraint:!1,overlap:"horizontal",containment:u(this.axes).keys(),dropOnEmpty:!0,accept:["measure","dimension","meazure","dimenzion"],onDrop:this.onAdd}),Draggables.removeObserver(e)},createMeasuresSortable:function(e){var t=d("li.measure > ul.members",e);if(0!==t.length)return 0===t.find("li.member").length?void Sortable.destroy(t[0]):void Sortable.create(t[0],{delay:N?200:0,constraint:!1,overlap:"horizontal",onUpdate:this.onMeasureReorder})}}),S=c.extend({constructor:function(e,t){this.element=m(e),this.observer=t,this.axes=["olap_rows","olap_columns"]},onStart:function(e,t){this.axis=this.getAxis(t),this.from=d(t.element).index(),N&&(this.changedElement=t.element,this.changedElement&&(this.changedElement.setStyle({display:"inline-block"}),this.changedElement.hasClassName("measure")&&this.changedElement.setStyle({padding:"0px"})))},onEnd:function(e,t){if(this.axis){var n=this.getAxis(t);if(n&&-1!==this.axes.indexOf(n.id)){Sortable.unmark();var i=this.axis.id===n.id,s=d(t.element).index();this.observer(t,i,this.axis.id,n.id,this.from,s),N&&this.changedElement&&this.changedElement.style&&this.changedElement.style.removeAttribute&&(this.changedElement.style.removeAttribute("display"),this.changedElement.style.removeAttribute("padding"))}}},getAxis:function(e){return e.element.up("ul")}});D={table:{nameAttr:"data-name",moveAttr:"data-name",filter:function(e,t){return e=i(e),"column"===t.name?e:u.reject(e,function(e){var n=e.param.extra;return"_spacer"!==n.name&&t.model.findWhere({fieldName:n.fieldName})})},group:{validateAdd:function(e,t,n,i){return 0===e.length?(i&&i.push(p.ADH_1001_ERROR_ALREADY_IN_USE),!1):!u.any(e,function(e){return e.param.extra.isMeasure||"_spacer"===e.param.extra.id})||(i&&i.push(p.ADH_1001_ERROR_ADD_TO_GROUPS),!1)},validateMove:function(e,t,n,i){if(n.hasClass("meazure"))return i&&i.push(p.ADH_1001_ERROR_ADD_TO_GROUPS),!1;var s=I(n.attr("data-fieldName"));return!t.model.findWhere({fieldName:s})||(i&&i.push(p.ADH_1001_ERROR_ALREADY_IN_GROUP),!1)}},column:{validateAdd:function(e,t,n,i){return 0!==e.length||(i&&i.push(p.ADH_1001_ERROR_ALREADY_IN_USE),!1)}}},crosstab:{nameAttr:"data-level",moveAttr:"data-dimension",filter:function(e){return e=i(this.isOlapMode?e.slice(0,1):e),!this.isOlapMode&&u.any(e,function(e){return e.param.extra&&e.param.extra.isMeasure})?e:u.reject(e,function(e){var t=e.param.extra,n={dimensionName:t.dimensionId};return n[this.isOlapMode?"name":"fieldName"]=t.id,!this.isDate(t)&&"_spacer"!==t.name&&u.any(this.axes,function(e){return e.model.findQueryField(n)})},this)},isDate:function(e){return"Timestamp"===e.type||"Date"===e.type||"Time"===e.type},row:{validateMove:function(e,t,n,i){return!(t.isDependent&&1==e.model.length)},validateAdd:function(e,t,n,i){if(u.isEmpty(e))return i&&i.push(p.ADH_1215_FIELD_IN_USE),!1;var s=this,a=e[0].param.extra,r=this.axes.olap_columns.model;return!(u.isEmpty(e)||this.axes.olap_rows.isDependent&&(r.isEmpty()||a.hierarchyName&&1===r.length&&r.at(0).name===a.dimensionId)||window.localContext.showAddHierarchyConfirm(a.hierarchyName,a.dimensionId,function(){s.add(e,t,n)}))}},column:{validateAdd:function(e,t,n,i){if(u.isEmpty(e))return i&&i.push(p.ADH_1215_FIELD_IN_USE),!1;var s=this,a=e[0].param.extra;return!window.localContext.showAddHierarchyConfirm(a.hierarchyName,a.dimensionId,function(){s.add(e,t,n)})}}}};var C=v.Model.extend({parse:function(e){var t=e.measure||!!e.isSpacer,n="_null"!==e.currentDisplayName?e.currentDisplayName:null;return{name:e.name,fieldName:e.fieldName,label:e.isSpacer?p.ADH_120_SPACER:n||e.name,isSpacer:!!e.isSpacer,isMeasure:t}},toPresentation:function(){var e=this.toJSON();return e.cid=u.uniqueId("field_"),e.itemClass=e.isMeasure?"meazure":"dimenzion",e}}),O=v.Model.extend({parse:function(e,t){return{name:e.name,fieldName:e.fieldName,label:e.display?e.display:e.name,isMeasure:!1,dimensionName:t.collection.name}},toPresentation:function(){var e=this.toJSON();return e.cid=u.uniqueId("level_"),e.levelClass="level",e}}),j=v.Model.extend({parse:function(e,t){return{name:e.name,fieldName:e.fieldName,label:x.getLabel(e),isMeasure:!0,dimensionName:t.collection.name}},toPresentation:function(){var e=this.toJSON();return e.cid=u.uniqueId("measure_"),e.levelClass="member",e}}),w=v.Collection.extend({model:function(e,t){return t=u.defaults(t,{parse:!0}),t.collection.isMeasure?new j(e,t):new O(e,t)},toPresentation:function(){return{levels:r(this),name:this.name,liClass:this.isMeasure?"measure":"dimension",ulClass:this.isMeasure?"members":"levels",measureHandle:this.isMeasure?"handle":""}},parse:function(e){var t=[];this.name=e.name;for(var n=0;n<e.levels.length;n++){var i=e.levels[n];if(i.visible&&!(i.recursiveLevelNumber>0))if(u.isEmpty(i.members))t.push(i);else{this.isMeasure=!0;for(var s=0;s<i.members.length;s++){var a=i.members[s];!0!==a.isSpacer&&t.push(a)}}}return t}}),T=v.Collection.extend({model:C,toPresentation:function(){return r(this)},findQueryField:function(e){return this.findWhere(e)}}),L=v.Collection.extend({model:w,toPresentation:function(){return r(this)},findQueryField:function(e){var t=null;return this.any(function(n){return t=n.findWhere(e)}),t}});n.exports=R});