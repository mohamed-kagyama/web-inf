/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","./chart.actions","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","../base/designer.base","runtime_dependencies/jrs-ui/src/core/core.events.bis","runtime_dependencies/jrs-ui/src/core/core.layout"],function(e,t,n){var a=e("dragdropextra"),d=a.Draggables,r=a.Draggable,i=e("prototype"),o=i.$,l=i.$$,s=e("./chart.actions"),c=e("runtime_dependencies/jrs-ui/src/util/utils.common"),u=c.isIPad,g=c.matchAny,m=c.isRightClick,w=c.isSupportsTouch,E=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"),v=e("../base/designer.base"),A=e("runtime_dependencies/jrs-ui/src/core/core.events.bis"),N=e("runtime_dependencies/jrs-ui/src/core/core.layout");s.mouseDownHandler=function(e){var t=e.element(),n=null;if(u()&&(n=g(t,["div#chartBorder"],!0),n&&o("dragger").removeClassName("hidden"),e.preventDefault()),"dragger"==t.identify()&&(this.containerMovePosition={x:e.pointerX(),y:e.pointerY()},Event.observe(document.body,w()?"touchmove":"mousemove",this.draggerListener)),(n=g(t,[window.adhocDesigner.LEGEND_OVERLAY_PATTERN],!0))&&!m(e)){var a=null;if(n.hasClassName("legend")){var d=n.readAttribute("data-legendName");"data-legendName"!==d&&(a={id:n.identify(),legendName:d,index:n.readAttribute("data-index"),defaultName:n.readAttribute("data-defaultName"),userName:n.readAttribute("data-userName")},window.selectionCategory.area=v.LEGEND_MENU_LEVEL,window.localContext.draggableLegend&&window.localContext.draggableLegend.destroy(),v.unSelectAll(),s.deselectAllSelectedOverlays(),v.addToSelected(a),A.select(n))}u()&&o("dragger").addClassName("hidden")}u()&&e.preventDefault()},s.mouseUpHandler=function(e){var t=e.element(),n=null,a=null;if(this.currentlyDragging)Event.stopObserving(document.body,w()?"touchmove":"mousemove",this.draggerListener),this.resizeChart(),this.currentlyDragging=!1;else{var r=o("dragger");u()&&r&&!g(t,["div#chartBorder"],!0)&&r.addClassName("hidden")}if(n=g(t,[window.adhocDesigner.LEGEND_OVERLAY_PATTERN],!0)){d.dragging==v.AVAILABLE_FIELDS_AREA?(a=n.readAttribute("data-index"),s.hoverLegendIndex=parseInt(a)):(s.deselectAllSelectedOverlays(),o(n).addClassName("selected"));var i=window.it;u()&&(i.clickid==t.identify()&&e.timeStamp-i.clicktime<700&&document.fire(N.ELEMENT_CONTEXTMENU,{targetEvent:e,node:t}),i.clicktime=e.timeStamp,i.clickid=t.identify())}else u()&&s.deselectAllSelectedOverlays()},s.mouseOverHandler=function(e){var t=e.element(),n=null;if(n=g(t,["div#chartBorder"],!0)){o("dragger").removeClassName("hidden")}if((n=g(t,[s.CHART_DRAGGER_PATTERN,window.adhocDesigner.LEGEND_OVERLAY_PATTERN],!0))&&(s.draggableChart&&s.draggableChart.destroy(),n.match(window.adhocDesigner.LEGEND_OVERLAY_PATTERN))){var a=o(n).readAttribute("data-index");window.localContext.currentlyDraggingLegend&&(window.localContext.currentLegendIndex=a),window.localContext.state.inDesignView&&(window.localContext.draggableLegend=new r(n.identify(),{ghosting:!0,onStart:function(e,t){d.dragging=v.CHART_LEGEND_AREA,window.localContext.currentlyDraggingLegend=!0,window.localContext.currentLegendIndex=o(e.element).readAttribute("data-index"),o(e.element).update(o(e.element).readAttribute("data-defaultname")),o(e.element).setStyle({color:"#000","white-space":"nowrap"}),s.draggableChart&&s.draggableChart.destroy()},onEnd:function(e,t){var n=null;n=o(e.element).readAttribute("data-index"),o(e.element).update(),window.localContext.currentlyDraggingLegend=!1,window.localContext.dragginInLegendArea?isNaN(n)||isNaN(window.localContext.currentLegendIndex)||null==n||null==window.localContext.currentLegendIndex||s.moveMeasure(n,window.localContext.currentLegendIndex):s.removeMeasure(n),window.localContext.currentLegendIndex=null,window.localContext.dragginInLegendArea=!1},onDrag:function(e,t){var n=Event.pointer(t);if(s.isInLegendArea(n.x,n.y)){window.localContext.dragginInLegendArea=!0;l("#chartBorder .overlay").each(function(t,a){if(t!==e.element){var d=Element.cumulativeOffset(t)[0],r=+t.style.width.replace("px","")+d;d<=n.x&&n.x<=r?(window.localContext.currentLegendIndex=t.readAttribute("data-index"),A.over(t)):A.out(t)}}),o(e.element).removeClassName("outside")}else window.localContext.dragginInLegendArea=!1,o(e.element).addClassName("outside")}}))}},s.mouseOutHandler=function(e){var t=e.element();if(g(t,["div#chartBorder"],!0)){o("dragger").addClassName("hidden")}s.draggableChart&&s.draggableChart.destroy()},s.mouseClickHandler=function(e){},s.contextMenuHandler=function(e){var t=e.element(),n=!0,a=g(t,[s.CHART_CANVAS_PATTERN,window.adhocDesigner.LEGEND_OVERLAY_PATTERN],!0);if(a){var d=null;if(a.hasClassName("legend")){var r=a.readAttribute("data-legendName");"data-legendName"!==r?(d={id:a.identify(),legendName:r,index:a.readAttribute("data-index"),defaultName:a.readAttribute("data-defaultName"),userName:a.readAttribute("data-userName")},window.selectionCategory.area=v.LEGEND_MENU_LEVEL):n=!1}else window.selectionCategory.area=v.CHART_LEVEL,d=a;n&&(window.localContext.draggableLegend&&window.localContext.draggableLegend.destroy(),v.unSelectAll(),s.deselectAllSelectedOverlays(),v.addToSelected(d),A.select(a),s.showChartMenu(e,window.selectionCategory.area)),Event.stop(e)}},s.lmHandlersMap={addItems:function(e,t,n){this[n].addItems(e,t)},group:{addItem:function(e,t,n){s.setGroup(n)},addItems:s.addFieldAsGroup,removeItem:function(e,t){s.removeGroup(t)},switchItem:function(e,t,n){s.switchToGroup(e,t)},contextMenu:function(e,t){var n=t.extra.name,a={legendName:n,index:0};v.unSelectAll(),window.localContext.deselectAllSelectedOverlays(),v.addToSelected(a),window.selectionCategory.area=v.LEGEND_MENU_LEVEL,E.setSelected(t.extra),window.adhocDesigner.showDynamicMenu(t.targetEvent,"displayManagerRow",null,null)}},measures:{addItem:function(e,t,n){s.addFieldAsMeasure(!0,t)},addItems:function(e,t){s.addFieldAsMeasure(!0,t)},removeItem:function(e,t){s.removeMeasure(t)},moveItem:function(e,t,n){s.moveMeasure(t,n)},switchItem:function(e,t,n){s.switchToMeasure(e,t,n)},contextMenu:function(e,t){var n=t.extra.index,a=t.extra.name,d=s.state.legendItems[n],r={id:"legendOverlay_"+n,legendName:a,index:n,defaultName:d?d.defaultName:"",userName:d?d.userName:"",chartMeasureId:a};v.unSelectAll(),s.deselectAllSelectedOverlays(),v.addToSelected(r),window.selectionCategory.area=v.LEGEND_MENU_LEVEL,E.setSelected(t.extra),window.adhocDesigner.showDynamicMenu(t.targetEvent,"displayManagerColumn")}}},n.exports=s});