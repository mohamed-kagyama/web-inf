/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","underscore","./calculatedFields/CalculatedFieldsController","./calculatedFields/CalculatedFieldsService","bundle!jasperserver_messages","bundle!adhoc_messages","runtime_dependencies/jrs-ui/src/components/components.dialogs","../base/designer.base"],function(e,o,t){var i,n=e("prototype"),d=n.$,a=e("underscore"),l=e("./calculatedFields/CalculatedFieldsController"),s=e("./calculatedFields/CalculatedFieldsService"),c=e("bundle!jasperserver_messages"),r=e("bundle!adhoc_messages"),u=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),D=e("../base/designer.base"),w=a.extend({},c,r),_={DIALOG_ID:"calcFieldMeasure",FIELDS_CONTAINER_ID:"#calculatedFields-container",calcFieldsService:new s({clientKey:window.clientKey}),showDialog:function(e){i=d(this.DIALOG_ID),i.down("button.doneButton").observe("click",e.applyField.bind(e)),i.down("button.cancelButton").observe("click",function(){e.stop(),this.closeDialog()}.bind(this)),setTimeout(function(){u.popup.show(i)})},closeDialog:function(){Event.stopObserving(i.down("button.doneButton")),Event.stopObserving(i.down("button.cancelButton")),u.popup.hide(i)},setDialogLabels:function(e,o){var t=e?{dialogHeader:o?"ADH_401_DIALOG_HEADER_EDIT_CUSTOM_MEASURE":"ADH_401_DIALOG_HEADER_NEW_CUSTOM_MEASURE",okButtonLabel:o?"button.save":"ADH_430_BUTTON_CREATE_MEASURE"}:{dialogHeader:o?"ADH_401_DIALOG_HEADER_EDIT_CUSTOM_FIELD":"ADH_401_DIALOG_HEADER_NEW_CUSTOM_FIELD",okButtonLabel:o?"button.save":"ADH_430_BUTTON_CREATE_FIELD"};d(i.down(".header.mover > .title")).update(w[t.dialogHeader]),d(i.down(".footer button.doneButton span.wrap")).update(w[t.okButtonLabel])},createField:function(e){var o=new l({element:this.FIELDS_CONTAINER_ID,service:this.calcFieldsService});o.listenTo(o,"field:loaded",this.setDialogLabels.bind(this)),o.listenTo(o,"field:applied",function(e){o.stop(),this.closeDialog(),this.createCustomFieldCallback(e)}.bind(this)),this.showDialog(o),o.start({editingMode:!1,kind:e})},updateField:function(){var e=D.getSelectedObject(),o=e.model?e.model.fieldName:window.adhocDesigner.getNameForSelected(e);if(null==o)throw'The field "'+o+'" is not found.';var t=new l({element:this.FIELDS_CONTAINER_ID,service:this.calcFieldsService});t.listenTo(t,"field:loaded",this.setDialogLabels.bind(this)),t.listenTo(t,"field:applied",function(e){t.stop(),this.closeDialog(),this.updateCustomFieldCallback(e)}.bind(this)),this.showDialog(t),t.start({editingMode:!0,selectedFieldName:o})},deleteField:function(){var e=D.getSelectedObject(),o=window.adhocDesigner.getNameForSelected(e);if(window.adhocDesigner.isInUse(o))throw"The field in use.";var t=function(t){this.deleteCustomFieldCallback(o,e,t),window.adhocDesigner.enableCanUndoRedo()}.bind(_);this.calcFieldsService.remove(o).done(a.bind(function(e,o,i){if(204===i.status)throw"Field not found.";_._updateState(t)},this))},createCustomFieldCallback:function(e){var o="MEASURE"===e.kind;u.systemConfirm.show(w[o?"ADH_435_CALCULATED_MEASURE_ADDED":"ADH_435_CALCULATED_FIELD_ADDED"],5e3),_._updateState(function(t){var i=window.localContext.state.allColumns.length;if(window.adhocDesigner.updateState(t),window.adhocDesigner.enableCanUndoRedo(),window.localContext.state.allColumns.length>i){var n=e.name,d=window.adhocDesigner.getFieldIndexByName(n),a=window.adhocDesigner.findFieldByName(n).type,l={id:n,label:e.display,type:"com.jaspersoft.jasperserver.api.metadata.common.domain.NewNode",uri:"/"+n,cssClass:"calculatedField",order:d,extra:{id:n,name:n,isMeasure:o,dimensionId:o?window.adhocDesigner.MEASURES:n,dataType:a}},s=o?"measuresTree":"dimensionsTree";window.adhocDesigner.addNodeToTree(l,window.adhocDesigner[s]),window.adhocDesigner.updateAllFieldLabels(),window.adhocDesigner[s+"Search"].setKeyword("")}})},updateCustomFieldCallback:function(e){var o="MEASURE"===e.kind;u.systemConfirm.show(w[o?"ADH_435_CALCULATED_MEASURE_UPDATED":"ADH_435_CALCULATED_FIELD_UPDATED"],5e3),_._updateState(function(o){window.adhocDesigner.updateState(o),window.adhocDesigner.enableCanUndoRedo(),window.adhocDesigner.isInUse(e.name)&&(window.localContext.updateViewCallback(o),window.adhocDesigner.filtersController.setFilters(o,{reset:!0})),window.adhocDesigner.updateAllFieldLabels()})},deleteCustomFieldCallback:function(e,o,t){var i=o.param.extra.isMeasure;u.systemConfirm.show(w[i?"ADH_435_CALCULATED_MEASURE_DELETED":"ADH_435_CALCULATED_FIELD_DELETED"],5e3);var n=window.localContext.state.allColumns.length;window.adhocDesigner.updateState(t),window.adhocDesigner.enableCanUndoRedo(),window.localContext.state.allColumns.length<n&&o&&(window.adhocDesigner.removeNodeFromTree(o),window.adhocDesigner.updateAllFieldLabels())},_updateState:function(e){D.sendRequest(window.adhocDesigner.getControllerPrefix()+"_recompileQueryAndLoadState",[],function(o){e(o)})}};window.adhocCalculatedFields=_,t.exports=window.adhocCalculatedFields});