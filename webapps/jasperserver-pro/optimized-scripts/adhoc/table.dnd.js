/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","dragdropextra","../base/designer.base","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/js-sdk/src/common/util/xssUtil","./table","runtime_dependencies/jrs-ui/src/util/utils.common"],function(e,n,r){var i=e("prototype"),a=i.$,t=e("dragdropextra"),o=t.Draggables,g=t.Draggable,d=e("../base/designer.base"),s=e("runtime_dependencies/jrs-ui/src/core/core.layout"),l=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),u=e("./table"),c=e("runtime_dependencies/jrs-ui/src/util/utils.common"),m=c.matchAny,v=c.isWebKitEngine;u.createDraggableColumn=function(e){return new g(e,{mouseOffset:!0,scroll:"mainTableContainer",onStart:function(e,n){if(window.selObjects.length){o.dragging=d.COLUMN_LEVEL,a(e.element).addClassName(s.DRAGGING_CLASS),u.draggingColumnOverlay=!0;var r=window.selObjects.length;a(e.element).update(r-1?r+" "+window.itemsSelectedSuffix:l.softHtmlEscape(window.selObjects[0].header.getAttribute("data-label"),{whiteList:["img"]}))}},onEnd:function(e,n){o.dragging=null,u.draggingColumnOverlay=!1;var r=a(e.element).identify(),i=u.digitRegex.exec(r)[0];if(-1==u.draggingMoveOverColumnIndex)window.isDesignView&&u.removeColumn();else if(i!=u.draggingMoveOverColumnIndex){var t=i<u.draggingMoveOverColumnIndex?[].max:[].min,g=t.call(window.selObjects,function(e){return e.index}),d=parseInt(u.draggingMoveOverColumnIndex);window.localContext.moveColumn(g,d.toString())}else u.initOverlays();u.draggingMoveOverColumnIndex=-1}})},u.createDraggableGroup=function(e){return new g(e,{constraint:"vertical",ghosting:!0,mouseOffset:!0,onStart:function(e,n){window.selObjects.length&&(o.dragging=d.GROUP_LEVEL,a(e.element).addClassName(s.DRAGGING_CLASS),u.draggingGroupOverlay=!0,a(e.element).update(window.selObjects[0].label))},onEnd:function(e,n){o.dragging=null,u.draggingGroupOverlay=!1;var r=window.selObjects[0].index;-1==u.draggingMoveOverGroupIndex?window.isDesignView&&u.removeGroup():r!=u.draggingMoveOverGroupIndex?window.localContext.moveGroup(r,u.draggingMoveOverGroupIndex):u.initOverlays(),u.draggingMoveOverGroupIndex=-1}})},u.updateColumnWhileDrag=function(e,n,r){var i,a,t="dimensionsTree"==o.dragging||"measuresTree"==o.dragging||o.dragging==d.COLUMN_LEVEL,g=m(n,[window.adhocDesigner.COLUMN_OVERLAY_PATTERN,window.adhocDesigner.COLUMN_SIZER_PATTERN]);if(g)if(t){i=n.identify(),a=u.digitRegex.exec(i)[0],u.draggingMoveOverColumnIndex=a;var s=!0;"dimensionsTree"!=o.dragging&&"measuresTree"!=o.dragging||(s=u.isHoverGreaterThan50Percent(e,a)),r(parseInt(a),s)}else!u.draggingColumnSizer&&n.match(window.adhocDesigner.COLUMN_OVERLAY_PATTERN)&&n.addClassName("over");!t||g||n.match(window.adhocDesigner.COLUMN_SIZER_PATTERN)||(u.draggingMoveOverColumnIndex=-1)},u.isHoverGreaterThan50Percent=function(e,n){var r=u.theCols[n];if(r){var i=0;if(v()){var t=window.localContext._getTableHeaders()[n];i=t.getWidth(),r=t}else i=r.getWidth();var o=a(r).cumulativeOffset(),g=r.cumulativeScrollOffset(),d=o[0]+g[0];return(e.pointerX()-d)/i*100>=50}return!1},u.activateVisualDropCue=function(e,n){var r=a("columnSizer_"+n);u.activateColumnSizer(r)},u.deactivateVisualDropCue=function(e,n){var r=a("columnSizer_"+n);u.deactivateColumnSizer(r)},u.activateColumnSizer=function(e){e&&a(e).addClassName("over")},u.deactivateColumnSizer=function(e){e&&a(e).removeClassName("over")},r.exports=u});