/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","./designer","./layout.manager","./enum/treeNodeClassEnum","underscore","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/namespace/namespace","../base/designer.base","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/js-sdk/src/common/util/xssUtil","runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils","runtime_dependencies/jrs-ui/src/components/components.dialogs","jquery","./designer.sort","./designer.reentrant","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","runtime_dependencies/jrs-ui/src/util/touch.controller","./filter/OlapFiltersController","./filter/FiltersController","./filter/FilterService","./table.init","./chart.observers","runtime_dependencies/jrs-ui/src/namespace/namespace","./crosstab"],function(e,n,t){function i(e,n){parseInt(p.getPanelWidth(e),10)||p.storePanelWidth(e,n)}function o(e){if(e[0])return e[0].childs&&e[0].childs.length>0?o(e[0].childs):e[0].param&&e[0].param.extra}var a=e("dragdropextra"),r=a.Droppables,s=e("prototype"),l=s.$,d=e("./designer"),c=e("./layout.manager"),u=e("./enum/treeNodeClassEnum"),m=e("underscore"),p=e("runtime_dependencies/jrs-ui/src/core/core.layout"),_=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),f=_.jaspersoft,g=e("../base/designer.base"),I=e("runtime_dependencies/jrs-ui/src/util/utils.common"),A=I.deepClone,D=I.isIPad,w=I.doNothing,T=I.enableSelection,E=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),h=e("runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils"),C=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),v=e("jquery"),M=e("./designer.sort"),N=e("./designer.reentrant"),b=e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"),L=e("runtime_dependencies/jrs-ui/src/util/touch.controller"),S=e("./filter/OlapFiltersController"),F=e("./filter/FiltersController"),y=e("./filter/FilterService"),O=e("./table.init"),R=e("./chart.observers"),x=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),P=x.JRS,H=e("./crosstab");d.getNodes=function(){var e=[],n=d.getSelectedTreeNodes(),t=o(n);return e.push(t),e},d.fieldsToBeAddedStructure=function(){for(var e=d.getSelectedTreeNodes(),n=window.localContext.state.getFilteredList&&window.localContext.state.getFilteredList(),t=n?window.localContext.state.getFilteredList():window.localContext.state.rowGroups,i=m.pluck(t,"name"),o=[],a=0;a<e.length;a++)if(e&&e[a]){var r=e[a]&&h.trees[e[a].getTreeId()],s=window.adhocDesigner.getAllLeaves(e[a],r).collect(function(e){return e.param&&e.param.extra}),l=window.adhocDesigner.getAllLeaves(e[a],r).collect(function(e){return e.param&&e.param.extra.id}),c=m.intersection(l,i),u=m.difference(l,i),p=s.filter(function(e){return e&&-1!==c.indexOf(e.name)}),_=s.filter(function(e){return e&&-1!==u.indexOf(e.name)}),f=p.filter(function(e){return H.isDateField(e)}),g=f.concat(_);g.forEach(function(e){o.push(e)})}return o},d.layoutManagerProperties={table:function(){return{axes:[{name:"column",elementId:"olap_columns"},{name:"group",elementId:"olap_rows"}],common:{mode:"table",id:d.DISPLAY_MANAGER_ID}}},crosstab:function(e){return{axes:[{name:"column",elementId:"olap_columns"},{name:"row",elementId:"olap_rows",isDependent:!!e}],common:{mode:"crosstab",id:d.DISPLAY_MANAGER_ID,measuresGroupId:"Measures",isOlapMode:!!e}}},olap_crosstab:function(){return d.layoutManagerProperties.crosstab(!0)},ichart:function(e){return{axes:[{name:"column",elementId:"olap_columns"},{name:"row",elementId:"olap_rows",isDependent:!!e}],common:{mode:"crosstab",id:d.DISPLAY_MANAGER_ID,measuresGroupId:"Measures",isOlapMode:!!e}}},olap_ichart:function(){return d.layoutManagerProperties.crosstab(!0)},chart:function(){return{axes:[{name:"measures",elementId:"olap_columns"},{name:"group",elementId:"olap_rows"}],common:{mode:"chart",id:d.DISPLAY_MANAGER_ID}}}},d.initTitle=function(){window.isEmbeddedDesigner&&!m.isBlank(window.embeddedName)&&d.ui.header_title.html(E.hardEscape(window.embeddedName))},d.initLayoutManager=function(e){var n=d.layoutManagerProperties[e]();d.ui.display_manager=new c(n),d.observeDisplayManagerEvents()},d.initDialogs=function(){window.isDesignView&&N.initialize(),M.initialize(),d.initViewQueryDialog(),d.initSaveConfirmationDialog(),d.initDeleteCalculatedFieldConfirmationDialog(),d.addConfirmDialog=new f.components.ConfirmDialog({messages:[d.messages.ADH_1216_DIMENSION_HIERARCHY_ADD_WARNING_1,d.messages.ADH_1216_DIMENSION_HIERARCHY_ADD_WARNING_2]})},d.initSaveConfirmationDialog=function(){var e=v("#standardConfirm").clone();e.attr("id",d.SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG.DIALOG_ID),e.find(".body").text(d.messages.ADH_1236_SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION),e.find(".button.action.up").attr("id",d.SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG.CANCEL_BUTTON_ID),e.find(".button.action.primary.up").attr("id",d.SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG.OK_BUTTON_ID),e.find(".button.action.primary.up .wrap").text(d.messages.ADH_1237_IGNORE),e.appendTo(v("#frame .content:eq(0)"))},d.initDeleteCalculatedFieldConfirmationDialog=function(){var e=v("#standardConfirm").clone();e.attr("id",d.DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG.DIALOG_ID),e.find(".body").text(d.messages.ADH_436_CALCULATED_FIELD_REMOVE_CONFIRM),e.find(".button.action.up").attr("id",d.DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG.CANCEL_BUTTON_ID),e.find(".button.action.primary.up").attr("id",d.DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG.OK_BUTTON_ID),e.appendTo(v("#frame .content:eq(0)"))},d.initViewQueryDialog=function(){d.viewQueryDialog=new P.ViewQueryDialog({id:"#queryViewer",content:"",selectionContainer:l("designer")})},d.initFieldsPanel=function(n){if(window.isDesignView){var t=d;n&&(Event.observe(l("topicMutton"),"click",function(e){b.isMenuShowing()&&b.menuDom.hasClassName("openByTopicMutton")?(b.hideMenu(),b.menuDom.removeClassName("openByTopicMutton")):b.showDynamicMenu("topicMenu",e,"menu vertical dropDown fitable openByTopicMutton",null,window.localContext.state.actionmodel),l("menu").clonePosition(l("topicMutton"),{setWidth:!1,setHeight:!1,offsetTop:30}),Event.stop(e)}.bind(d)),d.isOlapMode()||(Event.observe(l("availableFieldsMutton"),"click",function(e){b.isMenuShowing()&&b.menuDom.hasClassName("openByAvailableFieldsMutton")?(b.hideMenu(),b.menuDom.removeClassName("openByAvailableFieldsMutton")):b.showDynamicMenu("availableFieldsMenu",e,"menu vertical dropDown fitable openByAvailableFieldsMutton",null,window.localContext.state.actionmodel),l("menu").clonePosition(l("availableFieldsMutton"),{setWidth:!1,setHeight:!1,offsetTop:30}),Event.stop(e)}.bind(d)),Event.observe(l("availableMeasuresMutton"),"click",function(e){b.isMenuShowing()&&b.menuDom.hasClassName("openByAvailableMeasuresMutton")?(b.hideMenu(),b.menuDom.removeClassName("openByAvailableMeasuresMutton")):b.showDynamicMenu("availableMeasuresMenu",e,"menu vertical dropDown fitable openByAvailableMeasuresMutton",null,window.localContext.state.actionmodel),l("menu").clonePosition(l("availableMeasuresMutton"),{setWidth:!1,setHeight:!1,offsetTop:30}),Event.stop(e)}.bind(d))));var i,o={dimensions:{name:"dimensionsTree",className:"dimension",domId:t.DIMENSIONS_TREE_DOM_ID,providerId:t.DIMENSIONS_TREE_PROVIDER_ID},measures:{name:"measuresTree",className:"measure",domId:t.MEASURES_TREE_DOM_ID,providerId:t.MEASURES_TREE_PROVIDER_ID}};for(i in o){var a=l(o[i].domId);if(a){a.childElements().each(function(e){e.remove()})}t[o[i].name]=t.getAvailableFieldsTree(o[i].domId,o[i].providerId);var r=window.localStorage?localStorage.getItem(t._cookieName):void 0;t._availableTreeLastOpened=r&&r.length>0?r:"/",t[o[i].name].DEFAULT_TREE_CLASS_NAME="responsive fields",t[o[i].name].multiSelectEnabled=!d.isOlapMode(),t[o[i].name].dragClasses=o[i].className,t[o[i].name].setDragStartState=function(e){return function(n,t,i){d.setDragStartState(e,n,t,i),window.selectionCategory.area=g.AVAILABLE_FIELDS_AREA,window.localContext.canAddFilter&&window.localContext.canAddFilter(n)&&t.element.addClassName("supportsFilter")}}(t[o[i].name]),D()&&(a=document.getElementById(o[i].domId),new L(a,a.parentNode,{scrollbars:!0})),function(n){e(["./DynamicTreeSearch"],function(e){var i=new e({tree:t[n],depth:d._AVAILABLE_TREE_DEPTH,keyword:""});v(".j-"+n+"-search").append(i.el),t[n+"Search"]=i})}(o[i].name)}t.observeTreeEvents(t.dimensionsTree,t.measuresTree),t.observeTreeEvents(t.measuresTree,t.dimensionsTree)}},d.FILTERS_PANEL_DEFAULT_WIDTH=300,d.FILTERS_PANEL_MIN_WIDTH=250,d.initPanelsState=function(){p.panelStateWasManuallyChanged("filters",window.clientKey)||"false"===p.getPanelMinimizedState("filters")&&v("#filters").hasClass("minimized")&&p.storePanelMinimizedState("filters",!0),i("filters",d.FILTERS_PANEL_MIN_WIDTH);var e=d.CANVAS_PANEL_ID;l("fields")?p.resizeOnClient("fields",e,"filters"):p.resizeOnClient("filters",e),p.panelStateWasManuallyChanged("filters",window.clientKey)||"true"===p.getPanelMinimizedState("filters")&&parseInt(p.getPanelWidth("filters"),10)<d.FILTERS_PANEL_MIN_WIDTH&&p.storePanelWidth("filters",d.FILTERS_PANEL_DEFAULT_WIDTH)},d.initFiltersPanel=function(){var e=l("filters"),n=d.isOlapMode()?S:F,t=new y({clientKey:window.clientKey,mode:d.getMode});T(e),d.filtersController=new n({el:e,service:t,clientKey:window.clientKey,onApply:function(e){window.localContext.standardOpCallback(e)},onSlice:function(e){g.unSelectAll(),window.localContext.standardOpCallback(e)},onStateUpdate:function(e){window.localContext.state.update?window.localContext.state.update(e):window.localContext.update(e),window.isDesignView&&d.enableCanUndoRedo(),!d.isOlapMode()&&d.updateFieldsInUse(m.pluck(e.existingFilters,"name"))},onFilterAdd:function(e){!d.isOlapMode()&&d.applyFilterTitleColor(e)},onFilterRemove:function(e){d.removeFromFieldsInUse(m.pluck(e,"name"))},resetFilterPanelState:d.resetFilterPanelState}),document.observe("dragger:sizer",function(e){e.memo.element==d.filtersController.sizerEl&&d.filtersController.onPanelResize()})},d.initDroppables=function(){var e={filters:{accept:["draggable","wrap"],hoverclass:"dropTarget",onDrop:function(e){var n=[];if(d.canShowFilterOption(n)){var t=d.getListOfSelectedFields();d.filtersController.addFilter(t)}else C.systemConfirm.show(n.join(" "),5e3)}},mainTableContainer:{accept:["measure","dimension"],hoverclass:"dropTarget",onDrop:function(){switch(window.localContext.getMode()){case"table":O.addFieldAsColumn(!0);break;case"chart":R.addFieldAsMeasure(!0)}if(window.localContext.getMode().indexOf("crosstab")>=0||window.localContext.getMode().indexOf("ichart")>=0){var e=window.localContext.getMode()===g.OLAP_ICHART,n=window.localContext.getMode()===g.ICHART||e?window.AdhocIntelligentChart:H,t=(d.getSelectedTreeNodes(),d.fieldsToBeAddedStructure()),i=v("#olap_columns").children().length,o=v("#olap_rows").children().length,a=t&&t.length?t:d.getNodes(),r=a[0]&&a[0].isMeasure,s=d.getSelectedNodes();a&&(r?n.canAddDimensionAsColumnGroup(a)?n.appendDimensionToColumnAxisWithLevel(a,s,i):n.canAddDimensionAsRowGroup(a)&&n.appendDimensionToRowAxisWithLevel(a,s,o):t.length&&(n.canAddDimensionAsRowGroup(a)?n.appendDimensionToRowAxisWithLevel(a,t,o):n.canAddDimensionAsColumnGroup(a)&&n.appendDimensionToColumnAxisWithLevel(a,t,i)))}}},canvasTableFrame:{accept:["draggable","wrap"],hoverclass:"dropTarget",onDrop:function(){"table"==window.localContext.getMode()&&O.addFieldAsColumn(!0)}}};for(var n in e)r.remove(n),document.getElementById(n)&&r.add(n,e[n])},d.getSelectedNodes=function(){for(var e=d.getSelectedTreeNodes(),n=[],t=0;t<e.length;t++){var i=e[t]&&h.trees[e[t].getTreeId()];(e[t]&&window.adhocDesigner.getAllLeaves(e[t],i)).forEach(function(e){n.push(e)})}return n},d.getAvailableFieldsTree=function(e,n){function t(e){h.TreeNode.call(this,e),this.Types={Folder:new h.TreeNode.Type("ItemGroupType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_folders_adhocAvailableTrees:folders"}return t.prototype=A(h.TreeNode.prototype),t.addMethod("refreshStyle",function(e){if(e=e||this._getElement()){var n=d.findFieldByName(this.param.id);if(n&&n.isCustomField){this.name=this.param.label=n.defaultDisplayName.replace(/\\'/g,"'").escapeHTML();var t=["calculatedField"];if(d.isInUse(this.param.id)&&t.push("dependency"),d.isInError(this.param.id)){t.push("inError");var i=e.getElementsByClassName("icon error");1==i.length&&(i=i[0]),i.classList.remove("hidden")}else{var i=e.getElementsByClassName("icon error");1==i.length&&(i=i[0]),i.classList.add("hidden")}this.param.cssClass=t.join(" ")}else if(n){var t=[u[this.param.extra.type]];this.param.cssClass=t.join(" ")}h.TreeNode.prototype.refreshStyle.call(this,e)}}),new h.TreeSupport(e,{providerId:n,rootUri:"/",showRoot:!1,resetStatesOnShow:!1,nodeClass:t,templateDomId:"list_responsive_collapsible_folders_adhocAvailableTrees",dragPattern:D()?void 0:".draggable",treeErrorHandlerFn:w,selectOnMousedown:!D(),regionID:e||g.AVAILABLE_FIELDS_AREA})},t.exports=d});