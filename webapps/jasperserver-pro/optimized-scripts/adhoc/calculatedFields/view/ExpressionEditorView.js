/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","../factory/codeExampleFactory","../../designer/dataTypeIconFactory","../view/SimpleSelectListView","runtime_dependencies/js-sdk/src/common/util/featureDetection","text!../template/ExpressionEditorTemplate.htm","bundle!jasperserver_messages","bundle!adhoc_messages","runtime_dependencies/jrs-ui/src/util/utils.common","underscore.string","jquery.selection"],function(e,t,s){var i=e("underscore"),n=e("jquery"),r=e("backbone"),o=e("../factory/codeExampleFactory"),a=e("../../designer/dataTypeIconFactory"),l=e("../view/SimpleSelectListView"),c=e("runtime_dependencies/js-sdk/src/common/util/featureDetection"),d=e("text!../template/ExpressionEditorTemplate.htm"),u=e("bundle!jasperserver_messages"),p=e("bundle!adhoc_messages"),h=e("runtime_dependencies/jrs-ui/src/util/utils.common"),m=h.enableSelection;e("underscore.string"),e("jquery.selection");var g=i.extend({},u,p);s.exports=r.View.extend({template:i.template(d),events:{"keyup .control.textArea textarea":"onExpressionEdit","click .expressionEditorOperators li.button.math":"operatorClick","click .expressionEditorValidate .button":"validateButton"},initialize:function(e){this.assignedAttribute=e.assignedAttribute,this.title=e.title?e.title:"",this.lastSelectionPos={start:0,end:0},this.listenTo(this.model,"change:"+this.assignedAttribute,this.setExpression),this.listenTo(this.model,"change:availableFields",this.renderFields),this.listenTo(this.model,"change:availableFunctions",this.renderFunctions),this.listenTo(this.model,"invalid:"+this.assignedAttribute,this.setError)},render:function(){var e={i18n:g,title:this.title,operators:this.model.get("operators")};return this.$el.empty(),this.$el.html(this.template(e)),this.expressionInput=this.$(".control.textArea textarea"),m(this.expressionInput.parent()[0]),m(this.$(".inputRow .description p.text")[0]),this},renderFields:function(){var e=new l({el:this.$el.find(".expressionEditorFieldsList ul")});this.listenTo(e,"item:dblClick",this.fieldDblClick),!c.supportsModernSelection&&this.listenTo(e,"item:click",this.resetSelectionPos);var t=this.model.get("availableFields");t.length>0&&e.render(i.chain(t).map(function(e){return{name:e.id,label:e.label,tooltip:e.tooltip||e.description,nodeClass:e.expression?"calculated":"",kind:"DIMENSION"===e.kind?"field":"measure",type:a.getIconClassByType(e.type)}}).sortBy("label").value())},renderFunctions:function(){var e=new l({el:this.$el.find(".expressionEditorFunctionsList ul")});this.listenTo(e,"item:click",this.functionClick),this.listenTo(e,"item:dblClick",this.functionDblClick);var t=this.model.get("availableFunctions");t.length>0&&e.render(i.chain(t).map(function(e){return{name:e.name,label:e.name,type:"function"}}).sortBy(function(e){return e.name.toUpperCase()}).value())},successMessage:function(){this.clearMessages(),this.$(".expressionEditorValidate.group span.message.warning").text(g["adh.calculated.fields.validation.successful"]),this.$(".expressionEditorValidate.group span.message.warning").addClass("success"),this.$(".expressionEditorValidate.group").addClass("error")},errorMessage:function(e){var t=e||"";this.clearMessages(),this.$(".expressionEditorValidate.group span.message.warning").text(t),this.$(".control.textArea").addClass("error"),this.$(".expressionEditorValidate.group").addClass("error")},clearMessages:function(){this.$(".control.textArea").removeClass("error"),this.$(".expressionEditorValidate.group").removeClass("error"),this.$(".expressionEditorValidate.group span.message.warning").removeClass("success")},operatorClick:function(e){var t=n(e.target).hasClass("math")?e.target:n(e.target).parent("li.math")[0];if(t){var s=n(t).attr("value"),r=i.find(this.model.get("operators"),function(e){return e.id===s});this.insertText(r.value)}},fieldDblClick:function(e){var t=i.find(this.model.get("availableFields"),function(t){return t.id===e});this.updateSelectionPos(),this.insertText(t.alias)},updateSelectionPos:function(){var e=this;!c.supportsModernSelection&&this.expressionInput.selection("setPos",{start:e.lastSelectionPos.start,end:e.lastSelectionPos.end})},resetSelectionPos:function(){c.supportsModernSelection||(this.lastSelectionPos=this.expressionInput.selection("getPos"))},functionClick:function(e){var t=g["adh.calculated.fields.function.description."+e];this.resetSelectionPos(),this.$(".inputRow .description p.title").text(e),this.$(".inputRow .description p.text").text(t||""),this.$(".inputRow .description p.code").text(o(e,!0))},functionDblClick:function(e){var t=this.$(".control.checkBox input")[0].checked,s=o(e,t);this.updateSelectionPos(),this.insertText(s)},insertText:function(e){var t=e,s=this.expressionInput.val()[this.expressionInput.selection("getPos").start-1],n=this.expressionInput.val()[this.expressionInput.selection("getPos").end];'"'===s&&'"'===n?t=i.trim(t,'"'):(s&&!i.contains([" ","("],s)&&")"!==t&&(t=" "+t),n&&!i.contains([" ",")",","],n)&&"("!==t&&(t+=" ")),this.clearMessages(),this.expressionInput.selection("replace",{text:t});var r=this.expressionInput.selection("getPos").end;this.expressionInput.selection("setPos",{start:r,end:r}),this.model.set(this.assignedAttribute,this.expressionInput.val(),{silent:!0})},setExpression:function(){var e=this.model.get(this.assignedAttribute);this.clearMessages(),this.expressionInput.val(e)},setError:function(e){this.errorMessage(e.errorCode?g[e.errorCode]:e.errorMessage)},onExpressionEdit:function(e){this.clearMessages(),this.model.set(this.assignedAttribute,n(e.target).val(),{silent:!0}),this.model.isExpressionValid(this.assignedAttribute)},validateButton:function(){this.model.trigger("validate:"+this.assignedAttribute,i.bind(this.successMessage,this))}})});