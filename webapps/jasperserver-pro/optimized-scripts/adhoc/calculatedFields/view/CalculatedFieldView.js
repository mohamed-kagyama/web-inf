/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","bundle!adhoc_messages","../model/CalculatedFieldModel","text!../template/CalculatedFieldTemplate.htm","../factory/operatorsFactory","../view/SummaryCalculationView","../view/ExpressionEditorView","runtime_dependencies/jrs-ui/src/util/utils.common"],function(e,t,a){var i=e("jquery"),l=e("underscore"),s=e("backbone"),r=e("bundle!adhoc_messages"),o=e("../model/CalculatedFieldModel"),m=e("text!../template/CalculatedFieldTemplate.htm"),n=e("../factory/operatorsFactory"),d=e("../view/SummaryCalculationView"),u=e("../view/ExpressionEditorView"),h=e("runtime_dependencies/jrs-ui/src/util/utils.common"),c=h.enableSelection;a.exports=s.View.extend({template:l.template(m),events:{"click .formulaBuilderTab":"formulaTabClick","click .summaryCalcTab":"summaryTabClick","keyup .fieldLabelInput":"onFieldLabelChange"},initialize:function(){this.model=new o({operators:n}),this.formulaEditor=new u({assignedAttribute:"expression",title:r.ADH_421_FORMULA,model:this.model}),this.summaryTab=new d({model:this.model}),this.listenTo(this.model,"change:fieldLabel",this.updateFieldLabel),this.listenTo(this.model,"change:kind",this.setNameInputLabel),this.listenTo(this.model,"invalid:fieldLabel",this.showFieldLabelError),this.listenTo(this.model,"invalid:summaryExpression",this.showSummaryTab),this.listenTo(this.model,"invalid:summaryParameter",this.showSummaryTab)},render:function(){this.$el.empty(),this.$el.html(this.template({i18n:r})),this.formulaEditor.setElement(".formulaBuilderSection").render(),this.summaryTab.setElement(".summaryCalcSection").render();var e=this.$(".fieldLabelInput");return c(e.parent()[0]),setTimeout(function(){e.focus()},500),this},setNameInputLabel:function(){var e="MEASURE"===this.model.get("kind"),t=e?"ADH_402_MEASURE_NAME":"ADH_402_FIELD_NAME",a=e?"ADH_402_MEASURE_NAME_TIP":"ADH_402_FIELD_NAME_TIP";if(this.$(".measureNameSection label.control.input span.wrap").text(r[t]),this.$(".measureNameSection label.control.input").attr("title",r[a]),!this.isEdit){var i=e?r.ADH_403_NEW_MEASURE_DEFAULT_NAME:r.ADH_403_NEW_FIELD_DEFAULT_NAME;this.model.set("fieldLabel",i||"")}},updateFieldLabel:function(){var e=this.$(".fieldLabelInput");e.val(this.model.get("fieldLabel"));var t=e.val().length;e.selection("setPos",{start:t,end:t})},onFieldLabelChange:function(e){this.$(".measureNameSection label.control").removeClass("error"),this.model.set("fieldLabel",i(e.target).val(),{silent:!0}),this.model.isLabelValid()},showFieldLabelError:function(e){var t=this.$(".measureNameSection .message.warning"),a=e.errorCode?r[e.errorCode]:e.errorMessage;t.text(a||""),t.parent().addClass("error")},showFormulaTab:function(){this.$(".formulaBuilderTab").addClass("selected"),this.$(".formulaBuilderTab a").removeClass("over"),this.$(".summaryCalcTab").removeClass("selected"),this.$(".summaryCalcSection").addClass("hidden"),this.$(".formulaBuilderSection").removeClass("hidden")},showSummaryTab:function(){this.$(".summaryCalcTab").addClass("selected"),this.$(".summaryCalcTab a").removeClass("over"),this.$(".formulaBuilderTab").removeClass("selected"),this.$(".formulaBuilderSection").addClass("hidden"),this.$(".summaryCalcSection").removeClass("hidden")},formulaTabClick:function(){this.$(".formulaBuilderTab.selected")[0]||this.showFormulaTab()},summaryTabClick:function(){this.$(".summaryCalcTab.selected")[0]||this.model.trigger("validate:expression",l.bind(this.showSummaryTab,this))}})});