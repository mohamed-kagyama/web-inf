/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","../../designer/aggregateFieldLabelFactory","bundle!adhoc_messages","../../designer/dataTypeIconFactory","../view/ExpressionEditorView","../view/SimpleSelectListView","text!../template/SummaryTabTemplate.htm"],function(e,t,a){var i=e("underscore"),r=e("jquery"),s=e("backbone"),n=e("../../designer/aggregateFieldLabelFactory"),m=e("bundle!adhoc_messages"),l=e("../../designer/dataTypeIconFactory"),o=e("../view/ExpressionEditorView"),d=e("../view/SimpleSelectListView"),u=e("text!../template/SummaryTabTemplate.htm");a.exports=s.View.extend({template:i.template(u),events:{"change .availableSummaries":"summaryFunctionsChange"},initialize:function(){this.customSummaryEditor=new o({assignedAttribute:"summaryExpression",model:this.model}),this.listenTo(this.model,"change:availableFields",this.renderWeightedOnFields),this.listenTo(this.model,"change:availableSummaryFunctions",this.renderAvailableSummaries),this.listenTo(this.model,"change:summaryFunction",this.updateSummaryFunction),this.listenTo(this.model,"change:summaryParameter",this.updateSummaryParameter),this.listenTo(this.model,"change:availableFields",this.updateSummaryParameter),this.listenTo(this.model,"invalid:summaryParameter",this.showSummaryParameterError)},summaryFunctionsChange:function(e){this.model.set("summaryFunction",r(e.target).val()),this.updateLayout()},render:function(){return this.$el.empty(),this.$el.html(this.template({i18n:m})),this.customSummaryEditor.setElement(".customSummaryEditor").render(),this},renderWeightedOnFields:function(){var e=new d({el:this.$el.find(".weightedOnFieldsList ul")}),t=this;this.listenTo(e,"item:click",function(e){t.model.set("summaryParameter",e)});var a=this.model.get("availableFields");if(a.length>0){var r=i.filter(a,function(e){return i.contains(["java.lang.Double","java.math.BigDecimal","java.lang.Long","java.lang.Integer","java.lang.Short","java.lang.Byte"],e.type)});e.render(i.map(r,function(e){return{name:e.id,label:e.label,tooltip:e.tooltip,nodeClass:e.expression?"calculated":"",kind:"DIMENSION"===e.kind?"field":"measure",type:l.getIconClassByType(e.type)}}).sortBy(function(e){return e.label}))}},renderAvailableSummaries:function(){var e=i.sortBy(this.model.get("availableSummaryFunctions"),function(e){return"None"===e?"AAA":e}),t=this.$(".availableSummaries").empty();i.each(e,function(e){t.append("<option value='"+e+"'>"+n.localizeAggregation(e)+"</option>")}),t.val(this.model.get("summaryFunction")),this.updateLayout()},updateSummaryFunction:function(){this.renderAvailableSummaries()},updateSummaryParameter:function(){this.$("label.weightedOnInput.control").removeClass("error");var e=this.model.get("summaryParameter"),t=i.find(this.model.get("availableFields"),function(t){return t.id===e});t&&this.$(".weightedOnInput input").val(t.label)},showSummaryParameterError:function(e){var t=this.$(".weightedOnInput .message.warning"),a=e.errorCode?m[e.errorCode]:e.errorMessage;t.text(a||""),t.parent().addClass("error")},updateLayout:function(){var e=this.model.get("summaryFunction");"WeightedAverage"===e?(this.$(".weightedOnFieldsList").removeClass("hidden"),this.$(".customSummaryEditor").addClass("hidden")):"Custom"===e?(this.$(".weightedOnFieldsList").addClass("hidden"),this.$(".customSummaryEditor").removeClass("hidden")):(this.$(".weightedOnFieldsList").addClass("hidden"),this.$(".customSummaryEditor").addClass("hidden"))}})});