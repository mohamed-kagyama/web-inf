/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","underscore","runtime_dependencies/jrs-ui/src/core/core.ajax","../base/designer.base","runtime_dependencies/jrs-ui/src/components/components.toolbarButtons.events","./crosstab.root","./chart.observers","./table.init","./designer.sort","./designer.reentrant","runtime_dependencies/js-sdk/src/common/util/classUtil","runtime_dependencies/jrs-ui/src/namespace/namespace","../controls/controls.adhoc","runtime_dependencies/jrs-ui/src/components/components.webHelp","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/util/touch.controller","jquery","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/components/components.dialogs","./VisualizationChooser","./intelligentChart/adhocIntelligentChart","runtime_dependencies/js-sdk/src/jrs.configs","prototype","jquery","runtime_dependencies/jrs-ui/src/util/touch.controller","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/util/utils.common","./intelligentChart/adhocIntelligentChart","runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator","./designer.calculatedFields","./layout.manager","./filter/FiltersController","./filter/OlapFiltersController","./filter/FilterService","dragdropextra","runtime_dependencies/jrs-ui/src/org/org.rootObjectModifier","../controls/controls.adhoc","./crosstab.multiselect"],function(e,t,n){var i=e("prototype"),o=i.$,a=e("underscore"),r=e("runtime_dependencies/jrs-ui/src/core/core.ajax"),l=r.ajax,s=e("../base/designer.base"),d=e("runtime_dependencies/jrs-ui/src/components/components.toolbarButtons.events"),c=e("./crosstab.root"),u=e("./chart.observers"),_=e("./table.init"),T=e("./designer.sort"),E=e("./designer.reentrant"),A=e("runtime_dependencies/js-sdk/src/common/util/classUtil"),p=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),m=p.JRS,h=e("../controls/controls.adhoc"),C=e("runtime_dependencies/jrs-ui/src/components/components.webHelp"),g=e("runtime_dependencies/jrs-ui/src/util/utils.common"),D=g.isSupportsTouch,S=g.centerElement,w=g.isIPad,O=g.getBufferWidth,R=e("runtime_dependencies/jrs-ui/src/util/touch.controller"),v=e("jquery"),N=e("runtime_dependencies/jrs-ui/src/core/core.layout"),I=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),L=e("./VisualizationChooser"),P=e("./intelligentChart/adhocIntelligentChart");e("runtime_dependencies/js-sdk/src/jrs.configs"),e("prototype"),e("jquery"),e("runtime_dependencies/jrs-ui/src/util/touch.controller"),e("runtime_dependencies/jrs-ui/src/core/core.layout"),e("runtime_dependencies/jrs-ui/src/util/utils.common"),e("./intelligentChart/adhocIntelligentChart"),e("runtime_dependencies/jrs-ui/src/actionModel/actionModel.modelGenerator"),e("./designer.calculatedFields"),e("./layout.manager"),e("./filter/FiltersController"),e("./filter/OlapFiltersController"),e("./filter/FilterService"),e("dragdropextra"),e("runtime_dependencies/jrs-ui/src/org/org.rootObjectModifier"),e("../controls/controls.adhoc"),e("./crosstab.multiselect"),m.vars.current_flow="adhoc";window.theBody=document.body,window.requestLogEnabled=!1,window.TIMEOUT_INTERVAL=1e3*window.serverTimeoutInterval,window.ADHOC_SESSION_TIMEOUT_MESSAGE=window.adHocSessionExpireCode,window.ADHOC_EXIT_MESSAGE=window.adHocExitConfirmation;var M={ui:{header_title:null,display_manager:null,canvas:null,dataMode:null,visualizationChooser:L},_leafSelectedFired:!1,dimensionsTree:null,measuresTree:null,_availableTreeLastOpened:null,_AVAILABLE_TREE_DEPTH:10,_cookieName:"lastNodeUri",_cookieTime:3,FOLDER_TYPE:"ItemGroupType",multiSelect:!1,MEASURES:"Measures",DIMENSIONS_TREE_DOM_ID:"dimensionsTree",DIMENSIONS_TREE_PROVIDER_ID:"dimensionsTreeDataProvider",MEASURES_TREE_DOM_ID:"measuresTree",MEASURES_TREE_PROVIDER_ID:"measuresTreeDataProvider",TREE_CONTEXT_MENU_PATTERN:["ul#dimensionsTree li.leaf .button","ul#dimensionsTree li.node .button","ul#measuresTree li.leaf .button","ul#measuresTree li.node .button"],DIMENSION_TREE_DIMENSION_CONTEXT:"dimensionsTree_dimension",DIMENSION_TREE_LEVEL_CONTEXT:"dimensionsTree_level",MEASURE_TREE_GROUP_CONTEXT:"measuresTree_group",MEASURE_TREE_CONTEXT:"measuresTree",TREE_NODE_AND_LEAF_PATTERN:["ul#visibleFieldsTree li.leaf","ul#visibleFieldsTree li.node","ul#dimensionsTree li.leaf","ul#dimensionsTree li.node","ul#measuresTree li.node"],CANVAS_ID:"canvasTable",CANVAS_PARENT_ID:"mainTableContainer",CANVAS_PANEL_ID:"canvas",OLAP_MEASURES_TREE:"measuresTree",DISPLAY_MANAGER_ID:"displayManagerPanel",overlayParent:null,overlayDraggedColumn:null,initialDragXposition:null,NaN:"NaN",removeDroppables:null,addDroppables:null,DEFAULT_SUMMARY_NUM_FUNC:"Sum",DEFAULT_SUMMARY_NONNUM_FUNC:"DistinctCount",COLUMN_OVERLAY_PATTERN:"div.overlay.col",GROUP_OVERLAY_PATTERN:"div.overlay.group",SUMMARY_OVERLAY_PATTERN:"div.overlay.summary",GROUP_LABEL_SPAN_PATTERN:"span.labelOverlay.label",COLUMN_SIZER_PATTERN:"div.columnSizer",ROW_OVERLAY_PATTERN:"div.rowOverlay",ROW_GROUP_OVERLAY_PATTERN:"div.rowGroupOverlay",COLUMN_GROUP_OVERLAY_PATTERN:"div.columnGroupOverlay",MEASURE_OVERLAY_PATTERN:"div.measureOverlay",XTAB_GROUP_HEADER_PATTERN:"th.label.group",XTAB_GROUP_OVERLAY_PATTERN:"div.overlay.xtab.gr",XTAB_GROUP_HEADER_OVERLAY_PATTERN:"div.overlay.xtab.header",XTAB_MEASURE_OVERLAY_PATTERN:"div.overlay.xtab.m",XTAB_MEASURE_HEADER_OVERLAY_PATTERN:"div.overlay.xtab.measure",ROW_GROUP_MEMBER_PATTERN:"tbody#detailRows tr td.label.member",COLUMN_GROUP_MEMBER_PATTERN:"thead#headerAxis th.label.member",LEGEND_OVERLAY_PATTERN:"div.legend.overlay",AVAILABLE_FIELDS_PATTERN:["ul#visibleFieldsTree","ul#dimensionsTree","ul#measuresTree"],CANVAS_PATTERN:"table#canvasTable",MENU_PATTERN:"div#menu",CANVAS_PARENT_PATTERN:"div#mainTableContainer",EXPORT_FORM_PATTERN:"#exportActionForm",FILTER_OPERATOR_MENU_PATTERN:"#filter-container .button.operator",FILTER_GENERAL_MENU_PATTERN:"#filter-container #filterPanelMutton",FILTER_ITEM_MENU_PATTERN:"#filter-container .button.mutton",SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG:{DIALOG_ID:"saveWithoutFiltersApplyConfirmationDialog",OK_BUTTON_ID:"saveWithoutFiltersApplyConfirmationDialogOK",CANCEL_BUTTON_ID:"saveWithoutFiltersApplyConfirmationDialogCancel"},DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG:{DIALOG_ID:"deleteCalculatedFieldConfirmationDialog",OK_BUTTON_ID:"deleteCalculatedFieldConfirmationDialogOK",CANCEL_BUTTON_ID:"deleteCalculatedFieldConfirmationDialogCancel"},INTEGER_JAVA_TYPES:["java.lang.Byte","java.lang.Integer","java.lang.Short","java.lang.Long","java.math.BigInteger"],DECIMAL_JAVA_TYPES:["java.lang.Float","java.lang.Double","java.math.BigDecimal","java.lang.Number"],DATE_JAVA_TYPES:["java.sql.Timestamp","java.sql.Time","java.sql.Date","java.util.Date"],BOOLEAN_JAVA_TYPES:["java.lang.Boolean"],DATE_TYPE_DISPLAY:"date",INTEGER_TYPE_DISPLAY:"int",DECIMAL_TYPE_DISPLAY:"dec",BOOLEAN_TYPE_DISPLAY:"bool",NOT_A_NUMBER_TYPE_DISPLAY:"NaN",toolbarActionMap:{presentation:"adhocDesigner.goToPresentationView",explorer:"adhocDesigner.goToDesignView",execute:"adhocDesigner.saveAndRun",undo:"adhocDesigner.undo",redo:"adhocDesigner.redo",undoAll:"adhocDesigner.undoAll",pivot:"adhocDesigner.pivot",sort:"adhocDesigner.sort",controls:"adhocDesigner.launchDialogMenu",styles:"adhocDesigner.showAdhocThemePane",query:"adhocDesigner.showViewQueryDialog"},dialogESCFunctions:{save:"saveAs",saveDataViewAndReport:"saveDataViewAndReport",sort:"sortDialog",reentrant:"selectFields",editLabel:"editLabel"},contextMap:{table:_,crosstab:c,olap_crosstab:c,chart:u,ichart:window.AdhocIntelligentChart,olap_ichart:window.AdhocIntelligentChart},isIntegerType:function(e){return M.INTEGER_JAVA_TYPES.indexOf(e)>=0},isDecimalType:function(e){return M.DECIMAL_JAVA_TYPES.indexOf(e)>=0},isDateType:function(e){return M.DATE_JAVA_TYPES.indexOf(e)>=0},isBooleanType:function(e){return M.BOOLEAN_JAVA_TYPES.indexOf(e)>=0},getSuperType:function(e){return M.isIntegerType(e)?M.INTEGER_TYPE_DISPLAY:M.isDecimalType(e)?M.DECIMAL_TYPE_DISPLAY:M.isDateType(e)?M.DATE_TYPE_DISPLAY:M.NOT_A_NUMBER_TYPE_DISPLAY},getSelectedColumnOrGroup:function(){return window.selObjects[0]},generalDesignerCallback:function(){window.localContext.initAll(),M.updateTrees()},launchDialogMenu:function(){h.launchDialog()},showViewQueryDialog:function(){M.viewQueryDialog.show()},sort:function(){T.launchDialog()},selectFields:function(){E.launchDialog()},run:function(e){if(this.initialLoadingDialog(),C.setCurrentContext(e.indexOf("olap")>=0?"analysis":"ad_hoc"),this.ui.dataMode=v("#dataSizeSelector"),this.ui.canvas=v(D()?"#mainTableContainer > .scrollWrapper":"#mainTableContainer"),this.ui.header_title=v("#display > "+N.PAGE_HEADER_TITLE_PATTERN),this.observePointerEvents(),this.observeKeyEvents(),this.observeCustomEvents(),this.observeTableContainerEvents(),this.initDroppables(),this.initComponents(e),this.loadState(),window.isEmbeddedDesigner?(d.initialize(a.extend(this.toolbarActionMap,{presentation:"doNothing",export:"doNothing",save:"adhocDesigner.handleBack",closeDesigner:"adhocDesigner.handleCancel"}),o("adhocToolbar")),M.observeCloseDesignerEvent(),M.observeCrossDocumentMessages()):d.initialize(this.toolbarActionMap,o("adhocToolbar")),D()){var t=this.ui.canvas.get(0);this._touchController=new R(t,t.parentNode,{useParent:!0,absolute:!0,scrollbars:!0})}this.initTitle(),this.initFiltersPanel(),this.initPanelsState(),this.initDialogs(),void 0!==window.orientation&&0===window.orientation&&this.hideOnePanel(),o("errorPageContent")?M.initEnableBrowserSelection(o("designer")):M.initPreventBrowserSelection(o("designer"))},cancelAdhocExecution:function(){I.popup.hide(o(l.LOADING_ID)),window.history.back()},initialLoadingDialog:function(){var e=v("#"+l.LOADING_ID);e.length>0&&(e.addClass(N.CANCELLABLE_CLASS),e.addClass(N.ADHOC_COMPONENT),e.find("#cancel").click(function(){M.cancelAdhocExecution()}))},initLocalContext:function(e){window.localContext=this.contextMap[e],window.localContext.setMode(e),window.localContext.init&&window.localContext.init(e),M.resetState(),window.localContext.reset()},initComponents:function(e){this.isCrosstabMode=e.indexOf("ichart")>=0||e.indexOf("crosstab")>=0,this.ui.canvas.empty(),v("#level-container").hide(),this.initLocalContext(e),e.indexOf("ichart")<0&&M.registerTemplate(window.localContext,e+"Template"),this.initLayoutManager(e),e.indexOf("chart")>=0||e.indexOf("olap")>=0?this.ui.dataMode.hide():this.ui.dataMode.show(),v("#columns").children().eq(0).html(window.layoutManagerLabels.column[e]),v("#rows").children().eq(0).html(window.layoutManagerLabels.row[e]),M.ui.visualizationChooser.init()},render:function(){var e=window.localContext.state;if(d.setActionModel(e.actionmodel),window.localContext.getMode()!=s.ICHART&&window.localContext.getMode()!=s.OLAP_ICHART){var t=window.localContext.getMode()===s.OLAP_CROSSTAB?s.CROSSTAB:window.localContext.getMode();M.ui.canvas.empty(),M.ui.visualizationChooser.setSelectedType(t)}else M.ui.visualizationChooser.setSelectedType(P.state.chartState.chartType);M.updateCanvasClasses(M.isCrosstabMode);var n=window.localContext.render();window.isDesignView&&(M.enableCanUndoRedo(),M.enableRunAndSave(window.localContext.canSaveReport())),n&&(window.editor=null,s.initAdhocSpecificDesignerBaseVar(),s.setState(),s.updateSessionWarning(),s.updateFlowKey(),window.localContext.initAll&&window.localContext.initAll()),window.isDesignView&&M.isDisplayManagerVisible()&&v("#"+M.DISPLAY_MANAGER_ID).removeClass(N.HIDDEN_CLASS),M.updateModeLabelSelection(e.viewType),M.updateDataMode(e.dataSize),M.ui.display_manager.render(e.columns?{column:e.columns,group:e.groups}:e.chartItems?{measures:e.chartItems,group:e.group}:{column:e.crosstabState.columnGroups,row:e.crosstabState.rowGroups}),v("#designer").trigger("layout_update"),M.resetScroll(),window.isDesignView&&M.enableRunAndSave(window.localContext.canSaveReport()),M.enableSort("table"==e.viewType),M.viewQueryDialog.updateContent(e.query),v("#designer").trigger("rendering:done")},resetState:function(){window.localContext.state=new M.State({})},updateState:function(e){window.localContext.state.update(e)},updateModeLabelSelection:function(e){v("#dataModeSelector").val(e)},updateDataMode:function(e){v("#dataSizeSelector").val(e)},setNothingToDisplayVisibility:function(e){if(e){if(v("#titleCaption").css("min-width","400px"),v("#nothingToDisplay").removeClass(N.HIDDEN_CLASS),v("#nothingToDisplay").css("min-width","325px"),S(o("nothingToDisplay"),{horz:!0,vert:!0}),w()){var t=o("nothingToDisplay"),n=parseInt(t.getStyle("width")),i=(O(t,!0),v("#displayManager"));i?i.width():t.up(1).getWidth();t.style.marginLeft=n/2+"px",t.style.left="0%",t.style.position="relative",t.style.minWidth="300px"}}else v("#titleCaption").css("min-width",""),v("#nothingToDisplay").addClass(N.HIDDEN_CLASS)},updateCanvasClasses:function(e){v("#"+M.CANVAS_PANEL_ID)[(e?"add":"remove")+"Class"]("showingSubHeader OLAP")},showSaveConfirmationDialog:function(e){var t=v("#"+M.SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG.DIALOG_ID);I.popupConfirm.show(t[0],!1,{okButtonSelector:"#"+M.SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG.OK_BUTTON_ID,cancelButtonSelector:"#"+M.SAVE_WITHOUT_FILTERS_APPLY_CONFIRMATION_DIALOG.CANCEL_BUTTON_ID}).done(e)},resetScroll:function(){M._touchController&&(M._touchController.reset(),M._touchController.addPadding("canvasTable",{right:200}))},resetFilterPanelState:function(){N.panelStateWasManuallyChanged("filters",window.clientKey)?N["true"===N.getPanelMinimizedState("filters")?"minimize":"maximize"](o("filters"),!0):M.filtersController.collection.length>0||v("#level-container .sliderTick").length>0?N.maximize(o("filters"),!0):N.minimize(o("filters"),!0)},applyFilterTitleColor:function(e){a.each(e,function(e){var t=M.findFieldByName(e.model.get("name"));t&&t.kind&&e.$(".header .filterName").addClass(t.kind.toLowerCase())})},canShowFilterOption:function(e){for(var t=!0,n=0;n<window.selObjects.length;n++)if(!window.localContext.canAddFilter(window.selObjects[n],e)){t=!1;break}return t},getMode:function(){return window.localContext.getMode()},isOlapMode:function(){return window.localContext.getMode().indexOf("olap")>-1},onDataModeSelector:function(e,t){var n=window.localContext.getMode();if(n!==e){var i;if(!(n!==s.CROSSTAB&&n!==s.OLAP_CROSSTAB&&n!==s.TABLE||e!==s.ICHART&&e!==s.OLAP_ICHART)){var o=n===s.CROSSTAB||n===s.OLAP_CROSSTAB?c.state:_.state;if(!M.switchModeEventCheck(o))return M.updateModeLabelSelection(n),void I.systemConfirm.show(M.getMessage("ADH_1214_ICHARTS_NO_SWITCHMODE_DELETED_SUMMARIES"),5e3);i=t}window.localContext.hide&&window.localContext.hide(),M.switchMode(e,null,i)}else t&&P.state.chartState&&t!==P.state.chartState.chartType&&P.updateChartState({chartType:t})}};M.State=function(e){this.update(e),A.mixin(this,window.localContext.State)},M.State.prototype.update=function(e){a.extend(this,e)},window.adhocDesigner=M,window.adhocSessionButton=void 0,window.adhocSessionDialog=void 0,n.exports=M});