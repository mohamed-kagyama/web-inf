/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","./designer","runtime_dependencies/jrs-ui/src/util/utils.common","jquery","../base/designer.base","runtime_dependencies/js-sdk/src/common/util/xssUtil","runtime_dependencies/jrs-ui/src/core/core.events.bis","runtime_dependencies/jrs-ui/src/components/components.dialogs"],function(e,t,n){var i=e("prototype"),o=i.$,d=e("./designer"),l=e("runtime_dependencies/jrs-ui/src/util/utils.common"),r=l.InPlaceEditor,a=l.getInnerText,s=l.isIE8,u=l.isNotNullORUndefined,c=l.matchMeOrUp,p=e("jquery"),w=e("../base/designer.base"),m=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),b=e("runtime_dependencies/jrs-ui/src/core/core.events.bis"),v=e("runtime_dependencies/jrs-ui/src/components/components.dialogs");d.editDataHeader=function(e,t){var n=null,i=null,l=null,u=null,c=null,b=null,f=null,g=o("editLabel"),C=100,h=function(){d.initPreventBrowserSelection(o("designer"))};if(this.initEnableBrowserSelection(o("designer")),"title"===t)d.prevTitle=p("#titleCaption").html(),window.editor=new r(e),window.editor.oldTitle=window.editor.value,window.editor.makeEditable({onMouseup:d.returnToNormalReportTitle,onTab:d.returnToNormalReportTitle,onEnter:d.returnToNormalReportTitle,onEsc:d.returnToNormalReportTitle}),p("#mainTableContainer").scrollLeft(0);else if(g){if(c=g.down("button#cancelEditBtn"),u=g.down("button#editLabelBtn"),"legend"===t){var L=w.getSelectedObject();L&&(b=L.index,n=L.userName,(i=g.down("input#editLabelInput"))&&(i.value=n,l=function(){f=i.value,window.localContext.updateLegendLabel(f,b)}))}else if("column"===t){var T=d.getSelectedColumnOrGroup();if(T){var E=T.header.getElementsByTagName("span")[0],N=E?p(E).html().trim():a(T.header);n=m.unescape(N),C=o(T.header).getWidth(),b=T.index,i=g.down("input#editLabelInput"),i&&(i.value=n,l=function(){f=i.value,window.localContext.updateColumnHeaderRequest(f,b,C)})}}else if("tableGroup"===t){var j=d.getSelectedColumnOrGroup();if(j){var x=j.index;n=j.label,i=g.down("input#editLabelInput"),i&&(i.value=n,l=function(){f=i.value,window.localContext.updateGroupLabel(f,x)})}}if(i){o(c).observe("click",function(e){o(u).stopObserving("click"),h(),v.popup.hide(g),Event.stop(e)}),o(u).observe("click",function(e){l(),h(),o(u).stopObserving("click"),v.popup.hide(g),Event.stop(e)}),o(i).observe("key:enter",function(e){l(),h(),o(u).stopObserving("click"),o(i).stopObserving("key:enter"),v.popup.hide(g),Event.stop(e)}),o(i).observe("keypress",function(e){e=e||window.event,"legend"===t&&(62!=e.keyCode&&60!=e.keyCode&&38!=e.keyCode&&61!=e.keyCode&&62!=e.charCode&&60!=e.charCode&&38!=e.charCode&&61!=e.charCode||Event.stop(e))}),v.popup.show(g);var O=function(){i.focus(),i.select()};s()?setTimeout(O,500):O()}}},d.addColumnLabel=function(){if(1==window.selObjects.length){var e=w.getSelectedObject(),t=e.header;t.hasClassName("deletedHeader")&&d.editDataHeader(t,"column")}},d.deleteColumnLabel=function(){if(1==window.selObjects.length){var e=w.getSelectedObject(),t=e.header;t.hasClassName("deletedHeader")||(t.addClassName("deletedHeader"),p(t).html(t.readAttribute("data-fieldName"))),window.localContext.removeColumnHeaderRequest()}},d.selectAndEditLabel=function(e){var t=null,n=o("legendOverlay_"+e);n&&(t={id:n.identify(),legendName:n.readAttribute("data-legendName"),index:n.readAttribute("data-index"),defaultName:n.readAttribute("data-defaultName"),userName:n.readAttribute("data-userName")},w.unSelectAll(),window.localContext.deselectAllSelectedOverlays(),w.addToSelected(t),b.select(n),d.editLegendLabel())},d.editLegendLabel=function(){if(1==window.selObjects.length){var e=w.getSelectedObject(),t=o(e.id);t&&d.editDataHeader(t,"legend")}},d.editColumnLabel=function(){if(1==window.selObjects.length){var e=w.getSelectedObject(),t=e.header;d.editDataHeader(t,"column")}},d.adhocTitleEdit=function(e){var t=e.element();!u(window.editor)&&c(t,"#titleCaption")&&(this.editDataHeader(o("titleCaption"),"title"),Event.stop(e))},d.returnToNormalReportTitle=function(e){if(window.editor)if(e=e||window.event,e.keyCode==Event.KEY_ESC)window.editor.revertEdit(),window.editor=null,d.initPreventBrowserSelection(o("designer"));else{window.editor.makeNonEditable();var t=m.unescape(p(window.editor.elem).html());window.editor.oldTitle!=t?(d.updateReportTitle(t),d.initPreventBrowserSelection(o("designer"))):"table"==window.localContext.getMode()&&p("#titleCaption").html(d.prevTitle),window.editor=null}},d.addGroupLabel=function(){window.localContext.editGroupLabel()},d.deleteGroupLabel=function(){window.localContext.removeGroupLabel()},d.editGroupLabel=function(){window.localContext.editGroupLabel()},n.exports=d});