/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","prototype","underscore","jquery","../base/designer.base","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/util/tools.truncator"],function(e,n,t){var s=e("prototype"),i=(s.$,s.$$),r=e("underscore"),o=e("jquery"),a=e("../base/designer.base"),u=e("runtime_dependencies/jrs-ui/src/util/utils.common"),l=u.removeWhitespacesFromTable,E=u.isIE9,_=e("runtime_dependencies/jrs-ui/src/util/tools.truncator"),m={DRILL_THROUGH_PATTERN:"tbody#detailRows tr td.value span",ROW_GROUP_MEMBER_PATTERN:"tbody#detailRows tr td.member",COLUMN_GROUP_MEMBER_PATTERN:"thead#headerAxis th.member",GROUP_LEVEL_PATTERN:"thead#headerAxis tr th.level",MEASURE_PATTERN:"table#canvasTable .measure",GROUP_MEMBER_DISCLOSURE_PATTERN:".olap span.button.disclosure",GROUP_LEVEL_DISCLOSURE_PATTERN:"th.level span.button.disclosure",SORT_ICON_PATTERN:".olap .icon.sort",MEASURE_LABEL_PATTERN:"#measureLabel.label.measure UL.measures LI.leaf a span.xm",XTAB_LABEL_PATTERN:"th.label.group",ROW_GROUP_OVERFLOW_PATTERN:"td.rowOverflow",COLGROUP_GROUP_OVERFLOW_PATTERN:"th.colOverflow",COLGROUP_PLACEHOLDER:"th#columnGroupsPlaceHolder",ROW_GROUP_PLACEHOLDER:"td#rowGroupsPlaceHolder",MEASURES_PLACEHOLDER:"td#measuresPlaceHolder",TREE_CONTEXT_MENU_PATTERN:["ul#dimensionsTree li.leaf .button","ul#dimensionsTree li.node .button","ul#measuresTree li.leaf .button","ul#measuresTree li.node .button"],SHOWING_DISPLAY_MANAGER_CLASS:"showingDisplayManager",OLAP_COLUMNS_ID:"olap_columns",OLAP_ROWS_ID:"olap_rows",DM_AXIS_LIST_PATTERN:"ul.tokens.sortable",NULL_DIMENSION:"NULL Dimension",DIMENSION_TREE_DIMENSION_CONTEXT:"dimensionsTree_dimension",DIMENSION_TREE_LEVEL_CONTEXT:"dimensionsTree_level",MEASURE_TREE_GROUP_CONTEXT:"measuresTree_group",MEASURE_TREE_CONTEXT:"measuresTree",DISPLAY_MANAGER_ROW_CONTEXT:"displayManagerRow",DISPLAY_MANAGER_COLUMN_CONTEXT:"displayManagerColumn",MEASURES_DIMENSION_ROW_MENU_CONTEXT:"measuresDimensionInRows",MEASURES_DIMENSION_COLUMN_MENU_CONTEXT:"measuresDimensionInColumns",MEASURE_ROW_MENU_CONTEXT:"measureRow",MEASURE_COLUMN_MENU_CONTEXT:"measureColumn",ENDS_WITH_A_NUMBER_REGEX:new RegExp("\\d+$"),ALL_LEVEL_NAME:"(All)",MEASURE:"measure",ROW_GROUP_MEMBER:"rgMember",COLUMN_GROUP_MEMBER:"cgMember",ROW_GROUP_PREFIX:"rowGroup",HACK_PADDING:1,VISUAL_CUE_HACK_PADDING:2,TRUNCATED_LABEL_LEN:100,requestsInProgress:0,DROP_TARGET_CLASS:"dropTarget",draggingMoveOverIndex:-1,currentlyDraggingIndex:-1,getMode:function(){return this.mode},setMode:function(e){this.mode=e},reset:function(){},render:function(){var e=this.state,n=e.crosstab,t="OK"===n.queryStatus,s=this[this.getMode()+"Template"](e);if(E()&&(s=l(s)),window.adhocDesigner.ui.canvas.html(s),window.adhocDesigner.setNothingToDisplayVisibility(!t||e.isShowingNoData),window.adhocDesigner.enableXtabPivot(this.isPivotAllowed()),this.state.isShowingNoData)o("#nothingToDisplayMessage span.message-text").html(window.adhocDesigner.getMessage("noDataMode"));else if(e.unresolvedReferences&&e.unresolvedReferences.length>0){var i=window.adhocDesigner.getMissingFieldsCanvasMessage(e);o("#nothingToDisplayMessage span.message-text").html(i)}else o("#nothingToDisplayMessage span.message-text").html(window.adhocDesigner.getMessage(n.queryStatusMessagePrefix+n.queryStatus));return t},isPivotAllowed:function(){return this.state.getDimensionsCount("row")>0||!!window.localContext.isNonOlapMode()&&this.state.getDimensionsCount("column")>0},initAll:function(){new _(i(m.MEASURE_LABEL_PATTERN),m.TRUNCATED_LABEL_LEN),new _(i(m.XTAB_LABEL_PATTERN),m.TRUNCATED_LABEL_LEN)},isOlapMode:function(){return this.getMode()===a.OLAP_CROSSTAB},isNonOlapMode:function(){return this.getMode()===a.CROSSTAB},fromSiblingHierarchy:function(e,n,t){if(!e)return!1;var s=this.state.getLevelsFromDimension(n,t);return s.length>0&&-1===s[0].indexOf("["+e+"]")}};m.State={getDimensions:function(e){return e?this.crosstabState[e+"Groups"]:r.chain(this.crosstabState).filter(function(e,n){return n.search(/Groups$/)>=0}).flatten().value()},getDimension:function(e,n){return r.find(this.getDimensions(n),function(n){return n.name===e})},getDimensionsCount:function(e){return this.getDimensions(e).length},getLevelsFromDimension:function(e,n){return r.pluck(this.getLevelObjectsFromDimension(e,n),"name")},getLevelObjectsFromDimension:function(e,n){var t=this.getDimensions(n);return e=r.find(t,function(n){return n.name===e}),e?r.chain(e.levels).filter(function(e){return e.visible}).map(function(e){return r.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return!e.isSpacer}).value():[]},getLevelObject:function(e,n,t){function s(e,n){return r.find(e,function(e){return e.name==n})}var i=this.getDimensions(t),o=s(i,n);return o?s(o.levels,e):null},getFilteredList:function(e,n){var t=e||null,s=n||{};return 1===arguments.length&&r.isObject(e)&&(s=e,t=null),s.visible=!0,r.chain(this.getDimensions(t)).pluck("levels").flatten().map(function(e){return r.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return r.all(s,function(n,t){return void 0===e[t]||e[t]===n})}).value()},getFilteredMeasureList:function(e,n){var t=e||null,s=n||{};return 1===arguments.length&&r.isObject(e)&&(s=e,t=null),this.getFilteredList(t,r.extend(s,{measure:!0,measuresLevel:!0}))}},window.AdHocCrosstab=m,t.exports=m});