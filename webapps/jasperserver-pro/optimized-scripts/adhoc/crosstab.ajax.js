/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","../base/designer.base","./crosstab","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/components/components.dialogs","runtime_dependencies/jrs-ui/src/namespace/namespace"],function(e,n,o){var t=e("underscore"),l=e("jquery"),a=e("../base/designer.base"),r=e("./crosstab"),s=e("runtime_dependencies/jrs-ui/src/util/utils.common"),i=s.encodeText,d=s.removeTrailingPound,c=s.isIPad,u=e("runtime_dependencies/jrs-ui/src/components/components.dialogs"),w=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),C=w.JRS;r.insertDimensionInAxisWithChild=function(e){e&&(e.dim&&(e.dim=a.encodeParam(e.dim)),e.child&&(e.child=a.encodeParam(e.child)),e.hierarchyName&&(e.hierarchyName=a.encodeParam(e.hierarchyName)),e.uri&&(e.uri=a.encodeParam(e.uri))),a.sendRequest("cr_insertDimensionInAxisWithChild",e,window.localContext.standardCrosstabOpCallback,{bPost:!0})},r.insertDimensionInRowAxisWithLevel=function(e,n,o,t){r.insertDimensionInAxisWithChild({dim:e,axis:"row",pos:o,child:n,measure_pos:t})},r.insertDimensionInColumnAxisWithLevel=function(e,n,o,t){r.insertDimensionInAxisWithChild({dim:e,axis:"column",pos:o,child:n,measure_pos:t})},r.insertDimensionInRowAxisWithAllLevels=function(e,n){r.insertDimensionInAxisWithChild({dim:e,axis:"row",pos:n})},r.insertDimensionInColumnAxisWithAllLevels=function(e,n){r.insertDimensionInAxisWithChild({dim:e,axis:"column",pos:n})},r.moveDimension=function(e,n,o,t,l){var r=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_moveDimension",["dim="+i(e),"axisFrom="+n,"axisTo="+o,"f="+t,"t="+l],r,null)},r.removeDimension=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_removeDimension",new Array("axis="+e,"pos="+n),o,null)},r.showRowLevel=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_showRowLevel",new Array("f="+i(e),"level="+i(n)),o,null)},r.hideRowLevel=function(e,n){var o=function(o){window.localContext.standardCrosstabOpCallback(o);var t=window.localContext.state.getLevelObject(n,e,"row");t&&t.propertyMap&&"true"==t.propertyMap.lastFilteredLevel&&u.systemConfirm.show(window.adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3)};a.sendRequest("cr_hideRowLevel",new Array("f="+i(e),"level="+i(n)),o,null)},r.showColumnLevel=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_showColumnLevel",new Array("f="+i(e),"level="+i(n)),o,null)},r.hideColumnLevel=function(e,n){var o=function(o){window.localContext.standardCrosstabOpCallback(o);var t=window.localContext.state.getLevelObject(n,e,"column");t&&t.propertyMap&&"true"==t.propertyMap.lastFilteredLevel&&u.systemConfirm.show(window.adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3)};a.sendRequest("cr_hideColumnLevel",new Array("f="+i(e),"level="+i(n)),o,null)},r.pivot=function(){a.sendRequest("cr_pivot",[],window.localContext.standardCrosstabOpCallback,null)},r.insertMeasure=function(e,n,o){var t=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_insertMeasure",["measure="+i(e),"pos="+n,"axis="+o],t,null)},r.moveMeasure=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_moveMeasureByName",["measure="+i(e),"to="+n],o,null)},r.removeMeasure=function(e){if(!Object.isNumber(e)){e=window.adhocDesigner.getSelectedColumnOrGroup().index}var n=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_removeMeasure",new Array("i="+e),n,null)},r.expandLevel=function(e,n,o){if(!e||!n){var t=window.adhocDesigner.getSelectedColumnOrGroup();e=t.dimensionId,n=t.level}var l=new Array("f="+i(e),"level="+i(n),"isRow="+o);a.sendRequest("cr_expandLevel",l,window.localContext.standardCrosstabOpCallback,null)},r.collapseLevel=function(e,n,o){if(!e||!n){var t=window.adhocDesigner.getSelectedColumnOrGroup();e=t.dimensionId,n=t.level}var l=new Array("f="+i(e),"level="+i(n),"isRow="+o);a.sendRequest("cr_collapseLevel",l,window.localContext.standardCrosstabOpCallback,null)},r.insertColumnGroup=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};window.canAddAsGroup()&&a.sendRequest("cr_insertColumnGroup",new Array("f="+i(e),"i="+n),o,null)},r.insertRowGroup=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};window.canAddAsGroup()&&a.sendRequest("cr_insertRowGroup",new Array("f="+i(e),"i="+n),o,null)},r.removeColumnGroup=function(e){if(!e){var n=window.adhocDesigner.getSelectedColumnOrGroup();e=r.getSelectedDimensionIndex(n)}var o=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_removeColumnGroup",new Array("i="+e),o,null)},r.removeRowGroup=function(e){if(!e){var n=window.adhocDesigner.getSelectedColumnOrGroup();e=r.getSelectedDimensionIndex(n)}var o=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_removeRowGroup",new Array("i="+e),o,null)},r.moveRowGroup=function(e,n,o){var t=function(e){window.localContext.standardCrosstabOpCallback(e),o&&o(),a.unSelectAll()};a.sendRequest("cr_moveRowGroup",new Array("f="+e,"t="+n),t,null)},r.moveColumnGroup=function(e,n,o){var t=function(e){window.localContext.standardCrosstabOpCallback(e),o&&o(),a.unSelectAll()};a.sendRequest("cr_moveColumnGroup",new Array("f="+e,"t="+n),t,null)},r.toggleExpandCollapseForColumn=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_toggleExpandCollapseForColumn",new Array("nodePath="+i(e),"i="+n),o,null)},r.toggleExpandCollapseForRow=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_toggleExpandCollapseForRow",new Array("nodePath="+i(e),"i="+n),o,null)},r.switchToRowGroup=function(e){var n=window.adhocDesigner.getSelectedColumnOrGroup(),o=t.isNumber(e)?e:n.groupIndex;a.sendRequest("cr_switchToRowGroup",new Array("i="+o),window.localContext.standardCrosstabOpCallback,null)},r.switchToColumnGroup=function(e){var n=window.adhocDesigner.getSelectedColumnOrGroup(),o=t.isNumber(e)?e:n.groupIndex;a.sendRequest("cr_switchToColumnGroup",new Array("i="+o),window.localContext.standardCrosstabOpCallback,null)},r.deleteRowGroupSummary=function(){var e=window.adhocDesigner.getSelectedColumnOrGroup(),n=r.getSelectedDimensionIndex(e),o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setIncludeAllOnRows",new Array("pos="+n,"value=false"),o,null)},r.addRowGroupSummary=function(){var e=window.adhocDesigner.getSelectedColumnOrGroup(),n=r.getSelectedDimensionIndex(e),o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setIncludeAllOnRows",new Array("pos="+n,"value=true"),o,null)},r.deleteColumnGroupSummary=function(){var e=window.adhocDesigner.getSelectedColumnOrGroup(),n=r.getSelectedDimensionIndex(e),o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setIncludeAllOnColumns",new Array("pos="+n,"value=false"),o,null)},r.addColumnGroupSummary=function(){var e=window.adhocDesigner.getSelectedColumnOrGroup(),n=r.getSelectedDimensionIndex(e),o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setIncludeAllOnColumns",new Array("pos="+n,"value=true"),o,null)},r.sortControlClicked=function(e){if(r.requestsInProgress<1){r.requestsInProgress++;var n=function(e){r.requestsInProgress--,window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_sortControlClicked",new Array("i="+e),n,null)}},r.sortingChosen=function(e,n){var o=a.getSelectedObject();o.type=e;var t=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_"+n,["axis="+o.axis,"dimension="+i(o.dimensionId||""),"level="+i(o.level||""),"path="+i(o.path||""),"sortType="+e],t,null)},r.applyTopBottomNFiltering=function(e){var n=a.getSelectedObject(),o=function(e){window.localContext.standardCrosstabOpCallback(e),a.unSelectAll()};a.sendRequest("cr_groupSortControlClicked",["level="+i(n.level||""),"path="+i(n.path||""),"sortType="+e.type,"limit="+e.limit,"otherBucket="+e.aggregateUnranked,"limitAllLevels="+e.applyAcrossGroups],o,null)},r.updateViewCallback=function(e){window.localContext.standardCrosstabOpCallback(e)},r.setCategoryForRowGroup=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setRowGroupCategorizer",new Array("cat="+i(e),"i="+n),o,null)},r.setCategoryForColumnGroup=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setColumnGroupCategorizer",new Array("cat="+i(e),"i="+n),o,null)},r.setMask=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setDataMask",new Array("m="+i(e),"i="+n),o,null)},r.setSummaryFunction=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setSummaryFunction",new Array("f="+i(e),"i="+n),o,null)},r.setSummaryTimeFunction=function(e,n){var o=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setSummaryTimeFunction",new Array("f="+i(e),"i="+n),o,null)},r.setSummaryFunctionAndMask=function(e,n,o){var t=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setSummaryFunctionAndDataMask",new Array("f="+i(e),"m="+i(n),"i="+o),t,null)},r.getOverflowRowGroups=function(){var e=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_showInUnsafeRowMode",[],e,null)},r.getOverflowColumnGroups=function(){var e=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_showInUnsafeColumnMode",[],e,null)},r.getDrillUrl=function(){var e=d(document.location.href),n=e.toQueryParams();return n=t.pick(n,"realm","_flowExecutionKey","_eventId"),t.extend(n,{_flowId:"adhocFlow",reportType:"table",usePreparedState:"true",clientKey:Math.floor(9999999999999*Math.random())}),"flow.html?"+l.param(n)},r.createJSONDrillThrough=function(e,n){return encodeURIComponent(JSON.stringify({type:"path_expression",pathList:[e,n]}))},r.drill=function(e,n){if(!1!==r.allowDrill){r.allowDrill=!1,c()&&(C.vars.win=window.open());var o=function(e){if(r.allowDrill=!0,e.success){var n=function(){if(c())C.vars.win.location=r.getDrillUrl();else{var e="width=1000,left=200,top=100,height="+Math.round(.8*l(window).height())+",resizable=yes";window.name="",window.runPopup=window.open(r.getDrillUrl(),"drillTable",e),window.runPopup&&window.runPopup.focus()}};setTimeout(n,0)}},t=function(){r.allowDrill=!0},s=r.createJSONDrillThrough(window.localContext.state.rowNodeList[e],window.localContext.state.columnNodeList[n]);if(!c()||!C.vars.element_scrolled){var i=["drillThroughAdhocFilter="+s];window.isEmbeddedDesigner&&i.push("embeddedDesigner=true"),a.sendRequest("cr_prepareDrillTableState",i,o,{bPost:!0},t)}return!1}},r.getDrillOlapUrl=function(e){return"flow.html?_flowId=viewAdhocReportFlow&clientKey="+window.clientKey+"&reportUnit="+e+"&noReturn=true"},r.drillOLAP=function(e,n){if(!1!==r.allowDrill){r.allowDrill=!1;var o=function(e){if(r.allowDrill=!0,e.tempARUName)if(window.localContext.tempARUName=e.tempARUName,c());else{var n="width=1000,left=200,top=100,height="+Math.round(.8*l(window).height());window.windowPopUp=window.open("","jr",n),window.windowPopUp.location=window.localContext.getDrillOlapUrl(e.tempARUName)}},t=function(){r.allowDrill=!0},s=r.createJSONDrillThrough(window.localContext.state.rowNodeList[e],window.localContext.state.columnNodeList[n]);if(!c()||!C.vars.element_scrolled){var i=["drillThroughAdhocFilter="+s];window.isEmbeddedDesigner&&i.push("embeddedDesigner=true"),a.sendRequest("cr_prepareDrillTableStateOLAP",i,o,{bPost:!0},t)}return!1}},r.getIsHideEmptyRows=function(){return r.state.crosstabState.hideEmptyRows},r.hideEmptyRowsEquals=function(e){return window.localContext.getIsHideEmptyRows()===e},r.setHideEmptyRows=function(){var e=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setProperty",new Array("name=hideEmptyRows","value=true"),e,null)},r.setUnhideEmptyRows=function(){var e=function(e){window.localContext.standardCrosstabOpCallback(e)};a.sendRequest("cr_setProperty",new Array("name=hideEmptyRows","value=false"),e,null)},r.standardOpCallback=function(e){e?window.localContext.standardCrosstabOpCallback(e):window.console&&console.log("Internal server error occurred")},r.getCallbacksForPivot=function(){window.localContext.standardOpCallback()},r.undoAndRedoCallback=function(){window.adhocDesigner.undoAndRedoCallback(),window.localContext.standardCrosstabOpCallback()},r.updateCustomFieldCallback=function(){this.standardCrosstabOpCallback()},r.reInitOverlayCallback=function(){},r.standardCrosstabOpCallback=function(e){window.adhocDesigner.updateStateAndRender(e)},o.exports=r});