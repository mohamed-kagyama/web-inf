/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","runtime_dependencies/js-sdk/src/jrs.configs","./enum/mimeTypesEnum","./enum/endpointsEnum","../app/model/enum/profileAttributeErrorEnum","../model/util/profileAttributeUtil","./enum/profileAttributeLevelsEnum"],function(t,e,r){var i=t("underscore"),u=t("jquery"),n=t("runtime_dependencies/js-sdk/src/jrs.configs"),s=t("./enum/mimeTypesEnum"),a=t("./enum/endpointsEnum"),o=t("../app/model/enum/profileAttributeErrorEnum"),l=t("../model/util/profileAttributeUtil"),c=t("./enum/profileAttributeLevelsEnum"),h=i.template("holder=user:{{=organizationId}}{{=userId}}&includeInherited=true&{{=attributes}}"),f=i.template("holder=user:{{=organizationId}}{{=userId}}&includeInherited=false&{{=attributes}}"),d=i.template("holder=tenant:{{=organizationId}}&includeInherited=false&{{=attributes}}"),A=i.template("holder=tenant:/&includeInherited=false&{{=attributes}}"),p={};p.hierarchic="_getHierarchicAttributesUrlParams",p[c.USER]="_getUserLevelAttributesUrlParams",p[c.TENANT]="_getTenantLevelAttributesUrlParams",p[c.SERVER]="_getServerLevelAttributesUrlParams";var b=function(t){this.initialize(t)};i.extend(b.prototype,{initialize:function(t){this.jrsConfigs=t.jrsConfigs||n,this.request=t.request,this.cache=t.cache},getProfileAttributes:function(t,e){e=e||{refresh:!1},t=i.isArray(t)?t:[t];var r=this,n=i.groupBy(t,this._groupByLevel),s=this._compactGroupedProfileAttributes(n),a=s[c.USER]||[],o=s[c.TENANT]||[],l=s[c.SERVER]||[],h=s.hierarchic||[],f=this._getProfileAttributesOnUnsupportedLevels(s);if(i.size(f)>0){var d=r._createErrorForProfileAttributesOnUnsupportedLevels(f);return(new u.Deferred).reject(d)}var A=this._getAnyLevelProfileAttributes(a,c.USER,e),p=this._getAnyLevelProfileAttributes(o,c.TENANT,e),b=this._getAnyLevelProfileAttributes(l,c.SERVER,e),m=this._getAnyLevelProfileAttributes(h,"hierarchic",e);return u.when(A,p,b,m).then(function(t,e,n,s){var c=r._concatAllAttributesResult({userRequest:a,userResult:t,tenantRequest:o,tenantResult:e,serverRequest:l,serverResult:n,hierarchicRequest:h,hierarchicResult:s}),f=c.allNotFoundAttributes,d=c.allMappedAttributes;if(i.size(f)>0){var A=r._createErrorForNotFoundAttributes(f);return(new u.Deferred).reject(A,d)}return d})},_createErrorForProfileAttributesOnUnsupportedLevels:function(t){return{responseJSON:{message:"Profile attributes contain unsupported levels.",errorCode:o.PROFILE_ATTRIBUTE_UNSUPPORTED_LEVEL,parameters:i.map(t,function(t,e){var r={};return r[e]=t.map(function(t){return t.name}),r}),profileAttributesOnUnsupportedLevels:t},status:400}},_createErrorForNotFoundAttributes:function(t){return{responseJSON:{message:"Profile attributes not found.",errorCode:o.PROFILE_ATTRIBUTE_NOT_FOUND,parameters:t.map(function(t){return t.name+(t.level?":"+t.level:"")}),missingAttributes:t},status:404}},_getProfileAttributesOnUnsupportedLevels:function(t){return i.omit(t,[c.USER,c.TENANT,c.SERVER,"hierarchic"])},_groupByLevel:function(t){var e=t.level;return e?e.toLowerCase():"hierarchic"},_compactGroupedProfileAttributes:function(t){return i.reduce(t,function(t,e,r){return t[r]=i.reduce(e,function(t,e){if(t.addedAttributes[e.name])return t;var i={name:e.name};return this._isProfileAttributeHasLevel(e)&&(i.level=r),t.attributes.push(i),t.addedAttributes[e.name]=!0,t},{attributes:[],addedAttributes:{}},this).attributes,t},{},this)},_concatAllAttributesResult:function(t){var e=t.userRequest,r=t.userResult,i=t.tenantRequest,u=t.tenantResult,n=t.serverRequest,s=t.serverResult,a=t.hierarchicRequest,o=t.hierarchicResult,l=this._mapProfileAttributesResult(r,e),c=this._mapProfileAttributesResult(u,i),h=this._mapProfileAttributesResult(s,n),f=this._mapProfileAttributesResult(o,a);return{allNotFoundAttributes:l.notFoundAttributes.concat(c.notFoundAttributes).concat(h.notFoundAttributes).concat(f.notFoundAttributes),allMappedAttributes:l.mappedAttributes.concat(c.mappedAttributes).concat(h.mappedAttributes).concat(f.mappedAttributes)}},_getAnyLevelProfileAttributes:function(t,e,r){if(i.size(t)>0){var n=this,s=this._getAttributesToFetch(t,e,r),a=i.bind(this._getAttributesFromCache,this,t,e);if(i.size(s)>0){var o=u.param(this._mapProfileAttributesToUrlParams(s)),l=p[e],c=this[l](o);return this._getProfileAttributes(c).then(function(t){return n._putAttributesToCache(t,s,e),a()})}return(new u.Deferred).resolve(a())}return this._getEmptyAttributes()},_getProfileAttributeCacheKey:function(t,e){var r=[t.name];return this._isProfileAttributeHasLevel(t)&&r.push(e),l.createProfileAttributeFunctionWithArgs(r)},_getAttributesToFetch:function(t,e,r){return i.filter(t,function(t){var i=this._getProfileAttributeCacheKey(t,e);return!!r.refresh||!this.cache.get(i)},this)},_putAttributesToCache:function(t,e,r){var u=t?t.attribute:[],n=i.groupBy(u,"name");i.each(e,function(t){var e=n[t.name];if(e){var u=i.first(e),s=this._getProfileAttributeCacheKey(t,r);this.cache.add(s,i.extend({},t,{value:u.value,secure:u.secure}))}},this)},_getAttributesFromCache:function(t,e){return i.reduce(t,function(t,r){var i=this._getProfileAttributeCacheKey(r,e),u=this.cache.get(i);return u&&t.push(u),t},[],this)},_getEmptyAttributes:function(){return(new u.Deferred).resolve([])},_getProfileAttributes:function(t){return this.request({type:"GET",headers:{Accept:s.PROFILE_ATTRIBUTES_COLLECTION},url:a.PROFILE_ATTRIBUTES_SERVICE+"?"+t})},_getHierarchicAttributesUrlParams:function(t){var e=this.jrsConfigs.userId;return h({userId:e,organizationId:this._wrapOrganizationIdWithSlash(!0,!0),attributes:t})},_getUserLevelAttributesUrlParams:function(t){var e=this.jrsConfigs.userId;return f({userId:e,organizationId:this._wrapOrganizationIdWithSlash(!0,!0),attributes:t})},_getTenantLevelAttributesUrlParams:function(t){return d({organizationId:this._wrapOrganizationIdWithSlash(!0,!1),attributes:t})},_getServerLevelAttributesUrlParams:function(t){return A({attributes:t})},_getOrganizationId:function(){return this.jrsConfigs.organizationId?this.jrsConfigs.organizationId:""},_wrapOrganizationIdWithSlash:function(t,e){var r=this._getOrganizationId();return t&&(r="/"+r),e&&r&&"/"!==r&&(r+="/"),r},_mapProfileAttributesToUrlParams:function(t){return t=i.isArray(t)?t:[t],t.map(function(t){return{name:"name",value:t.name}})},_mapProfileAttributesResult:function(t,e){var r=i.groupBy(t,"name");return i.reduce(e,function(t,e){var i=r[e.name];return i?t.mappedAttributes.push(i[0]):t.notFoundAttributes.push(e),t},{mappedAttributes:[],notFoundAttributes:[]})},_isProfileAttributeHasLevel:function(t){return Boolean(t.level)}}),r.exports=b});