/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","./UseAttributeIdGenerationStrategy","../../app/util/pathUtil"],function(t,e,i){function r(t,e){this.initialize(t,e)}var n=t("underscore"),o=t("backbone"),h=t("./UseAttributeIdGenerationStrategy"),s=t("../../app/util/pathUtil");n.extend(r.prototype,o.Events,{initialize:function(t,e){e=e||{},this._idGenerationStrategy=e.idGenerationStrategy||r.idGenerationStrategy,this._nodeIdAttribute=e.nodeIdAttribute||r.nodeIdAttribute,this._nodeIdGenerator=e._nodeIdGenerator,this._childrenAttribute=e.childrenAttribute||r.childrenAttribute,this._pathSeparator=e.pathSeparator||r.pathSeparator,this._pathSeparatorEscapeSymbol=e.pathSeparatorEscapeSymbol||r.pathSeparatorEscapeSymbol,this.clear({silent:!0}),t&&(t=n.isArray(t)?t:[t],this.reset(t,{silent:!0}))},clear:function(t){t=t||{},this._root={},this._root[this._childrenAttribute]=[],this._root[this._nodeIdAttribute]="root",this._map={root:{ref:this._root,nodes:{}}},this._idGenerationStrategy.reset&&this._idGenerationStrategy.reset(),t.silent||this.trigger("change")},getNode:function(t){var e=this._getMapNode(t);if(e)return e.ref===this._root?e.ref[this._childrenAttribute]:e.ref},getChildren:function(t){return(t=this._getNode(t))&&t[this._childrenAttribute]},getParentNodePath:function(t){return t=n.clone(this._convertPathToArray(t)),t.length>0?(t.pop(),t):null},updateNode:function(t,e,i){if(i=i||{},t=this._normalizePath(t),!t.length)throw new Error("Cannot update root node. Use reset instead.");var r,o,h,s=this.getParentNodePath(t),a=this._getMapNode(s),d=this._getMapNode(t),u=e[this._nodeIdAttribute],l=this._getNode(t),_={};if(l&&(h=this._convertPathToInternal(t),o=l[this._nodeIdAttribute],i.updateProperties?(this._set(h,n.extend(l,n.omit(e,[this._childrenAttribute]))),u&&o!==u&&(delete a.nodes[o],a.nodes[u]=d)):(r=n.indexOf(this.getChildren(s),l),_[this._nodeIdAttribute]=o,this.removeNode(t,{silent:!0}),this.addNode(s,n.extend(_,e),n.extend({at:r},i,{silent:!0}))),!i.silent)){var c=this._join(t);l=a.nodes[u||o].ref,t.length&&this.trigger("update:"+c,l),this.trigger("update",c,l),this._bubbleTrigger(t,"change")}},reset:function(t,e){e=e||{},t=t||{},this._idGenerationStrategy.reset&&this._idGenerationStrategy.reset();var i=this._getMapNode([]),r=this._getNode([]);t=n.isArray(t)?t:[t],this._setChildren([],r,t),i.nodes={},this._buildChildrenMapNode(i,r[this._childrenAttribute]),e.silent||(this.trigger("reset"),this.trigger("change"))},removeNode:function(t,e){if(e=e||{},t=this._normalizePath(t),!t.length)throw new Error("Cannot remove root level.");var i,r=this._getNode(t),o=this.getParentNodePath(t),h=this.getChildren(o);if(r&&(i=n.indexOf(h,r))>=0){h.splice(i,1);if(delete this._getMapNode(o).nodes[r[this._nodeIdAttribute]],!e.silent){var s=this._join(t);this.trigger("remove:"+s,r),this.trigger("remove",s,r),this._bubbleTrigger(o,"change")}}},removeNodes:function(t,e,i){i=i||{},t=this._normalizePath(t);var r=[],o=[];if(-1!==n.indexOf(e,""))throw new Error("Cannot remove root level.");n.each(e,function(e){var i=t.concat([e]),n=this._getNode(i);n&&(o.push(n),r.push(this._join(i))),this.removeNode(i,{silent:!0})},this),!i.silent&&o.length&&(this.trigger("remove",r,o),this._bubbleTrigger(t,"change"))},addNode:function(t,e,i){i=i||{},t=this._normalizePath(t);var r,o,h,s=this._getNode(t),a=this._getNodeId(e,t),d={};if(s){if(r=this._getMapNode(t),!a)throw new Error("Id should be not a falsy value");if(r.nodes&&r.nodes[a])throw new Error("Node already exists: "+this._join(t.concat([a])));d[this._nodeIdAttribute]=a,e=n.extend({},d,e);var u=this._add(this._convertPathToInternal(t),e,i);o={ref:e},e[this._childrenAttribute]&&(this._setChildren(t.concat(a),e,e[this._childrenAttribute]),this._buildChildrenMapNode(o,e[this._childrenAttribute])),r.nodes||(r.nodes={}),r.nodes[a]=o,i.silent||(h=this._join(t),t.length&&this.trigger("add:"+h,e,u),this.trigger("add",h,e,u),this._bubbleTrigger(t,"change"))}},addNodes:function(t,e,i){i=i||{},t=this._normalizePath(t);var r,o,h,s=this._getNode(t);if(s&&(h=s[this._childrenAttribute]?s[this._childrenAttribute].length:0,o=n.isNumber(i.at)?i.at>h?h:i.at:h,r=this._getMapNode(t),n.each(e,function(e){var i=this._getNodeId(e,t);if(!i)throw new Error("Id should be not a falsy value");if(r.nodes&&r.nodes[i])throw new Error("Node already exists: "+this._join(t.concat([i])));e[this._nodeIdAttribute]=i},this),n.each(e,function(e,r){var o={silent:!0};n.isNumber(i.at)&&(o.at=i.at+r),this.addNode(t,e,o)},this),!i.silent)){var a=this._join(t);t.length&&this.trigger("add:"+a,e,o),this.trigger("add",a,e,o),this._bubbleTrigger(t,"change")}},visit:function(t,e,i){var r;return t=t||[],t=this._convertPathToArray(t),r=arguments[3]||this.getNode(t),r=n.isArray(r)?r:r[this._childrenAttribute],n.each(r,function(r){var n=t.concat([r[this._nodeIdAttribute]]),o=r[this._childrenAttribute];e.accept(r,n,i)&&(e.visit(r,n,i),o&&this.visit(n,e,i,o))},this),i},filter:function(t,e){var i=new r([],{idGenerationStrategy:this._idGenerationStrategy,nodeIdAttribute:this._nodeIdAttribute,nodeIdGenerator:this._nodeIdGenerator,childrenAttribute:this._childrenAttribute,pathSeparator:this._pathSeparator,pathSeparatorEscapeSymbol:this._pathSeparatorEscapeSymbol}),o=this,h={accept:function(t,i,r){return e(t,i)},visit:function(e,i,r){var h=i.slice(t.length,i.length-1);e=n.omit(e,o._childrenAttribute),r.addNode(h,e)}};return this.visit(t,h,i).toJSON()},traverse:function(t,e,i){var r={accept:function(){return!0},visit:e};return this.visit(t,r,i)},find:function(t,e,i){var r,o,h,a,d,u;for(t=t||[],t=n.isArray(t)?t:s.split(t,this._pathSeparatorEscapeSymbol,this._pathSeparator),i=i||this.getNode(t),i=n.isArray(i)?i:i[this._childrenAttribute],u=0;u<i.length;u++)if(h=i[u],r=t.concat([h[this._nodeIdAttribute]]),o=h[this._childrenAttribute],d=e&&e(h,r),d?a=h:o&&(a=this.find(r,e,o)),a)return a},_getNode:function(t){var e=this._getMapNode(t);return e&&e.ref},_getMapNode:function(t){return this._get(this._convertPathToInternal(t))},_add:function(t,e,i){i=i||{};var r,o,h=this._get(t),s=h&&h.ref;return s&&(o=s[this._childrenAttribute],o||(o=[],s[this._childrenAttribute]=o),n.isNumber(i.at)?(o.splice(i.at,0,e),r=i.at>o.length?o.length-1:i.at):(o.push(e),r=o.length-1)),r},_get:function(t){for(var e,i=this._map,r=0;r<t.length;r++){if(e=t[r],!i[e])return null;i=i[e]}return i},_set:function(t,e){var i=this._get(t),r=i&&i.ref;if(r){t.pop(),t.pop();var o=this._get(t).ref,h=n.indexOf(o[this._childrenAttribute],r);h>=0&&(o[this._childrenAttribute][h]=e)}},_setChildren:function(t,e,i){if(e)return i=n.map(i,function(e){e=n.clone(e);var i=this._getNodeId(e,t),r={};return r[this._nodeIdAttribute]=i,e[this._childrenAttribute]&&this._setChildren(t.concat([i]),e,e[this._childrenAttribute]),n.extend({},r,e)},this),e[this._childrenAttribute]=i,e},_bubbleTrigger:function(t,e){for(var i=n.clone(t),r=i.length,o=0;o<r;o++)this.trigger(e+":"+this._join(i)),i.pop();this.trigger(e,this._join(t))},_getNodeId:function(t,e){var i=t[this._nodeIdAttribute];return n.isUndefined(t[this._nodeIdAttribute])&&(i=this._idGenerationStrategy.getId(t,this._nodeIdAttribute,e)),i},_buildChildrenMapNode:function(t,e){t.nodes||(t.nodes={}),n.each(e,function(e){var i={ref:e};e[this._childrenAttribute]&&this._buildChildrenMapNode(i,e[this._childrenAttribute]),t.nodes[e[this._nodeIdAttribute]]=i},this)},_convertPathToInternal:function(t){t=n.clone(this._convertPathToArray(t));for(var e=t.length-1,i=1,r=0;r<e;r++)t.splice(i,0,"nodes"),i+=2;return t.length>0&&t.unshift("nodes"),t.unshift("root"),t},_join:function(t){return s.join(t,this._pathSeparatorEscapeSymbol,this._pathSeparator)},_normalizePath:function(t){return this._convertPathToArray(t)},_convertPathToArray:function(t){if(n.isArray(t))return t;if(n.isString(t))return 0===t.indexOf(this._pathSeparator)&&(t=t.substr(this._pathSeparator.length)),s.split(t,this._pathSeparatorEscapeSymbol,this._pathSeparator,!0);throw new Error("Path should be either a string or an array")},toJSON:function(){return n.cloneDeep(this.getChildren([]))}}),n.extend(r,{idGenerationStrategy:new h,nodeIdAttribute:"id",childrenAttribute:"elements",pathSeparator:".",pathSeparatorEscapeSymbol:"\\"}),i.exports=r});