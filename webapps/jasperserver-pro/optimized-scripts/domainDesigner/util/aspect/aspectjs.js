/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore"],function(t,n,r){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var o=t("underscore"),i=function(t){this.config={},this.buildCallback=t};o.extend(i.prototype,{before:function(t){return this.config.before||(this.config.before=[]),this.config.before.push(t),this},around:function(t){return this.config.around||(this.config.around=[]),this.config.around.push(t),this},afterReturning:function(t){return this.config.afterReturning||(this.config.afterReturning=[]),this.config.afterReturning.push(t),this},afterThrowing:function(t){return this.config.afterThrowing||(this.config.afterThrowing=[]),this.config.afterThrowing.push(t),this},after:function(t){return this.config.after||(this.config.after=[]),this.config.after.push(t),this},build:function(){return this.buildCallback(this.config)}});var f=function(){};o.extend(f.prototype,{wrap:function(t,n,r){return"object"===e(t)?this._wrapObject(t,n):"function"==typeof t?this._wrapFunction(t,n,r):t},_wrapFunction:function(t,n,r){var e=this;return n?o.bind(this._performAction,this,{config:n,context:r,func:t}):new i(function(n){return e._wrapFunction(t,n,r)})},_wrapObject:function(t,n){var r=this,e=this._getWrappedObject(t,n),i=this._getAllMethodsToWrap(t,n);return o.each(i,function(o){var i=r._getAspectConfigForMethod(o,n);e[o]=r._wrapFunction(t[o],i,e)}),e},_getWrappedObject:function(t,n){if((n["*"]||{}).modifyOriginal)return t;var r=function(){};return r.prototype=t,new r},_getAspectConfigForMethod:function(t,n){var r=n["*"]||{},e=n[t]||{},i=o.uniq(o.keys(r).concat(o.keys(e))),f={};return o.each(i,function(t){f[t]=o.uniq(e[t]||[]).concat(r[t]||[])}),f.name=t,f},_getAllMethodsToWrap:function(t,n){var r=[],e=n["*"],i=!1;if(e&&(i=this._isAnyAspectsInConfig(e)),i){var f=this._getAllMethodsFromObject(t,!1!==e.wrapInPrototype);r=r.concat(this._filterOutMethodsToExclude(f,e.exclude||[]))}return r=r.concat(o.chain(n).keys().filter(function(n){return"*"!==n&&"function"==typeof t[n]}).value())},_isAnyAspectsInConfig:function(t){return t.before||t.after||t.around||t.afterReturning||t.afterThrowing},_getAllMethodsFromObject:function(t,n){var r,e=[];if(!t)return e;if(n){for(r in t)"function"==typeof t[r]&&e.push(r);return e}return o.chain(t).keys().filter(function(n){return"function"==typeof t[n]}).value()},_filterOutMethodsToExclude:function(t,n){var r=n.reduce(function(t,n){return t[n]=!0,t},{});return t.filter(function(t){return!r[t]})},_performAction:function(){var t,n,r=arguments[0],e=r.config,o=Array.prototype.slice.call(arguments,1),i=(new Error).stack;if(this._performBeforeAspects(e.before,e.name,o))try{t=e.around?this._performAroundAspects(e.around,r.func,o,r.context,e.name):r.func.apply(r.context,o),t=this._performAfterReturningAspects(e.afterReturning,t,o,e.name)}catch(t){if(n=this._performAfterThrowingAspects(e.afterThrowing,t,i,o,e.name),void 0===n&&(n=t),n)throw n}finally{this._performAfterAspects(e.after,t,n,o,e.name)}return t},_performBeforeAspects:function(t,n,r){return!t||!o.find(t,function(t){if("function"==typeof t){var e=t(r,n);return!(e||void 0===e)}})},_performAroundAspects:function(t,n,r,e,i){var f=e?o.bind(n,e):n;return o.each(t,function(t){f=o.bind(t,null,i,f)}),f.apply(null,r)},_performAfterReturningAspects:function(t,n,r,e){return o.each(t,function(t){n=t(n,r,e)}),n},_performAfterThrowingAspects:function(t,n,r,e,i){return o.each(t,function(t){n=t(n,r,e,i)}),n},_performAfterAspects:function(t,n,r,e,i){o.each(t,function(t){t(n,r,e,i)})}});var c=new f;r.exports=o.bind(c.wrap,c)});