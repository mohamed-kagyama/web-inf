/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../model/schema/util/entityUtil","../../../util/getResourceSourceNameOrNameUtil","../../../../model/schema/enum/specialSchemaNamesEnum"],function(e,t,i){var r=e("underscore"),a=e("../../../../model/schema/util/entityUtil"),c=e("../../../util/getResourceSourceNameOrNameUtil"),o=e("../../../../model/schema/enum/specialSchemaNamesEnum"),n=o.SCHEMALESS_NAME_SUBSTITUTION,s=["permissionMask","updateDate","creationDate"],u=function(e){this.initialize(e)};r.extend(u.prototype,{initialize:function(e){this.dataStore=e.dataStore,this.clientDomainSchemaService=e.clientDomainSchemaService,this.viewStateModel=e.viewStateModel,this.clientResourcePropertiesService=e.clientResourcePropertiesService,this.schemaResourcesNamesAreEqualSpecification=e.schemaResourcesNamesAreEqualSpecification,this.designerViewStateByDomainProvider=e.designerViewStateByDomainProvider},isDataSourceSet:function(){var e=this.clientResourcePropertiesService.getDataSourceName(),t=e&&this.clientResourcePropertiesService.getDataSourceUri(e);return Boolean(t)},serializeToSaveSchema:function(e){var t=r.omit(this.clientResourcePropertiesService.serialize(e),s),i=this.clientDomainSchemaService.serializeWithDataAdapter();return r.extend({},t,i)},serializeToServerSchema:function(){var e=this.clientDomainSchemaService.serializeWithDataAdapter(),t=this.clientResourcePropertiesService.getDataSourceName(),i=this.clientResourcePropertiesService.getDataSourceUri(t);return r.extend(e,{label:this.clientResourcePropertiesService.getDomainLabel(),dataSource:{dataSourceReference:{uri:i}}}),e},serialize:function(){return this.clientDomainSchemaService.serialize()},getDesignerStateAfterValidation:function(e){e=e||{};var t=this.dataStore.getCollections(),i=this._getDataSourceType();return e=r.extend({dataSourceType:i},e),{schema:this.clientDomainSchemaService.serialize(),resourceProperties:this.clientResourcePropertiesService.serializeToClientModel(),viewState:this.designerViewStateByDomainProvider.getViewState(t,e)}},getDesignerStateAfterSave:function(){return{schema:this.clientDomainSchemaService.serialize(),resourceProperties:this.clientResourcePropertiesService.serializeToClientModel(),viewState:this.viewStateModel.toJSON()}},getDataSource:function(){return{name:this._getDataSourceName(),type:this._getDataSourceType(),uri:this._getDataSourceUri()}},isAllDataIslandsHaveSources:function(){return this.clientDomainSchemaService.isAllDataIslandsHaveSources()},getAllSchemasSourceNamesOrNames:function(){return this.dataStore.getCollection("dataSourceGroups").map(function(e){return e.sourceName||e.name})},getAllTablesWithPath:function(e){var t=this,i=e.isSchemaLessDataSourceWithEmptyResolvedSchemaAttribute;return this.dataStore.getCollection("tables").chain().filter(function(e){return a.isGenericTable(e)}).map(function(e){var r,a,c,o=e.dataSourceId!==e.parentId,n=null;return o&&!i&&(n=e.parentId,r=n&&t.dataStore.getCollection("dataSourceGroups").byId(n)),r?(a=r.sourceName||r.name,c=[a,e.name]):c=[e.name],{tableId:e.id,tablePath:c}}).toArray()},filterOnlyTablesWithNewFields:function(e,t){var i=this;return e=r.isArray(e)?e:[e],r.reduce(e,function(e,r,o){r=r.group;var n=t[o],s=this.dataStore.getCollection("tables").byId(n.tableId),u=s.getId(),l=r.elements||[],S=l.filter(function(e){return e=e.element,!s.getChildren().some(function(t){if(a.isField(t)){var r=c(t.toJSON()),o=c(e);return i.schemaResourcesNamesAreEqualSpecification.isSatisfiedBy(r,o)}})});return e.push({parentId:u,fields:S}),e},[],this)},tryAutoresolveSchemas:function(e){var t=e.existingSchemas||[],i=e.availableSchemas||[],r=1===t.length&&0===i.length,a=0===t.length&&1===i.length,c=1===t.length&&1===i.length&&t[0]===i[0];return r?[[t[0],n]]:a?[[n,i[0]]]:!!c&&[[t[0],i[0]]]},_getDataSourceName:function(){return this.clientResourcePropertiesService.getDataSourceName()},_getDataSourceUri:function(){var e=this._getDataSourceName();return this.clientResourcePropertiesService.getDataSourceUri(e)},_getDataSourceType:function(){var e=this._getDataSourceName(),t=this.viewStateModel.getDataSource(e);return t&&t.type}}),i.exports=u});