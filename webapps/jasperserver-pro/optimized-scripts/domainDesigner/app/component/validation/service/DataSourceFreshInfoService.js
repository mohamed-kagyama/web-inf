/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../../model/enum/dataSourceTypeEnum","../../../model/enum/dataSourceLevelEnum","../../../model/util/serverSchemaResourceTypeUtil"],function(e,t,r){var a=e("jquery"),n=e("underscore"),i=e("../../../model/enum/dataSourceTypeEnum"),o=e("../../../model/enum/dataSourceLevelEnum"),c=e("../../../model/util/serverSchemaResourceTypeUtil"),u=function(e){this.initialize(e)};n.extend(u.prototype,{initialize:function(e){this.encryptedProfileAttributeErrorSpecification=e.encryptedProfileAttributeErrorSpecification,this.domainValidationCacheRefresher=e.domainValidationCacheRefresher,this.dataSourceInfoService=e.dataSourceInfoService,this.metadataService=e.metadataService},refreshDataSource:function(e){var t=new a.Deferred;return this._fetchFreshDataSourceInfo(e).then(function(){t.resolve()},t.reject),t.promise()},fetchFreshDataSourceInfoWithAvailableSchemas:function(e){var t=this;return this._fetchFreshDataSourceInfo(e).then(function(r){return t.metadataService.getMetadata(e).then(function(e){var a=[];return r.type===i.DATA_SOURCE_WITH_SCHEMAS&&(a=t._getAvailableSchemas(e)),n.extend(r,{availableSchemas:a})})})},_getAvailableSchemas:function(e){return n.reduce(e,function(e,t){return c.getMetadataResourceType(t)===o.DATA_SOURCE_GROUP&&e.push(t.group.name),e},[])},_fetchFreshDataSourceInfo:function(e){var t=this,r=new a.Deferred;return this.domainValidationCacheRefresher.refresh().then(function(){t.dataSourceInfoService.getDataSourceInfo(e).then(r.resolve,r.reject)},function(a){t.encryptedProfileAttributeErrorSpecification.isSatisfiedBy(a)?r.reject(a):t.dataSourceInfoService.getDataSourceInfo(e).then(r.resolve,r.reject)}),r.promise()}}),r.exports=u});