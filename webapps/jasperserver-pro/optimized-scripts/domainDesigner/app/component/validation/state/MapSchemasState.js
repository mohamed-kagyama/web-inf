/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../../model/enum/dataSourceTypeEnum","../../../model/enum/defaultSchemaNameEnum","../../../../model/util/profileAttributeUtil","../../../../model/schema/enum/specialSchemaNamesEnum","../schemaMapping/enum/schemaMappingType","./enum/validationStateNameEnum"],function(e,i,a){var t=e("underscore"),n=e("backbone"),s=e("../../../model/enum/dataSourceTypeEnum"),c=e("../../../model/enum/defaultSchemaNameEnum"),o=e("../../../../model/util/profileAttributeUtil"),m=e("../../../../model/schema/enum/specialSchemaNamesEnum"),l=e("../schemaMapping/enum/schemaMappingType"),h=e("./enum/validationStateNameEnum"),p=m.SCHEMALESS_NAME_SUBSTITUTION,S=function(e){this.initialize(e)};t.extend(S.prototype,n.Events,{initialize:function(e){this.schemaMappingModel=e.schemaMappingModel,this.schemaMappingDialog=e.schemaMappingDialog,this.domainValidationEventBus=e.domainValidationEventBus,this.defaultSchemaExistsAndNotEmptySpecification=e.defaultSchemaExistsAndNotEmptySpecification,this.clientDomainSchemaService=e.clientDomainSchemaService,this.clientDomainValidationService=e.clientDomainValidationService,this.clientCurrentDesignerStateService=e.clientCurrentDesignerStateService},enter:function(e,i){var a=this.clientDomainSchemaService.getDataSourceGroups();e.existingSchemasToMap=this._getExistingSchemasToMap(a);var t=this.clientDomainValidationService.tryAutoresolveSchemas({existingSchemas:e.existingSchemasToMap,availableSchemas:e.availableSchemasToMap}),n=this._isEmptyDomainBasedOnDataSourceWithSchemas(),s=this._isSchemaLessDataSources(a);t||n||s?(e.schemaPairs=t,i.enter(h.DOMAIN_VALIDATION_STATE,e)):this._openSchemaMappingDialog(e,i)},_isEmptyDomainBasedOnDataSourceWithSchemas:function(){var e=this.clientCurrentDesignerStateService.getDataSourceType(),i=t.isEmpty(this.clientDomainValidationService.getAllSchemasSourceNamesOrNames());return e===s.DATA_SOURCE_WITH_SCHEMAS&&i},_isSchemaLessDataSources:function(e){var i,a=this.clientCurrentDesignerStateService.getDataSourceType(),t=this.clientDomainValidationService.getDataSource().type;i=a?a===s.DATA_SOURCE_WITHOUT_SCHEMAS:0===e.length;var n=t===s.DATA_SOURCE_WITHOUT_SCHEMAS;return i&&n},_getExistingSchemasToMap:function(e){var i=this.defaultSchemaExistsAndNotEmptySpecification.isSatisfied(),a=t.reduce(e,function(e,a){var t=a.sourceName||a.name,n=a.name===c.DEFAULT_SCHEMA,s=!o.containsProfileAttributeWithPlaceholders(t);return n?i&&e.push(t):s&&e.push(t),e},[]);return t.unique(a)},_getExistingAndAvailableSchemas:function(e){var i=e.existingSchemasToMap,a=e.availableSchemasToMap,n=t.isEmpty(i),s=t.isEmpty(a);return n&&i.push(p),s&&a.push(p),i=t.map(i,function(e){return{name:e,mappedWith:void 0,isSelected:!1,index:0,type:l.EXISTING}}),a=t.map(a,function(e){return{name:e,mappedWith:void 0,isSelected:!1,index:0,type:l.AVAILABLE}}),{existingSchemas:i,availableSchemas:a,isExistingSchemasEmpty:n,isAvailableSchemaEmpty:s}},_openSchemaMappingDialog:function(e,i){this._subscribeToSchemaMappingDialogEvents(e,i);var a=this._getExistingAndAvailableSchemas(e);this.schemaMappingModel.set({isSelectingAvailableSchema:a.isExistingSchemasEmpty,isSelectingExistingSchema:a.isAvailableSchemaEmpty,existingSchemas:a.existingSchemas,availableSchemas:a.availableSchemas,isVisible:!0}),this.schemaMappingModel.disableButtons(),this.schemaMappingDialog.open()},_onSchemaMappingConfirmed:function(e,i){this._unsubscribeToSchemaMappingDialogEventsAndCloseDialog(),e.schemaPairs=this.schemaMappingModel.getMappedResult(),i.enter(h.DOMAIN_VALIDATION_STATE,e)},_onSchemaItemClicked:function(e){this.schemaMappingModel.updateSelection(e)},_onLinkButtonClicked:function(){this.schemaMappingModel.linkSelectedSchemas()},_onUnlinkButtonClicked:function(){this.schemaMappingModel.unlinkSelectedSchemas()},_onCancel:function(e,i){this._unsubscribeToSchemaMappingDialogEventsAndCloseDialog(),i.enter(h.GOTO_PREVIOUS_LOCATION_OR_STAY_IN_DESIGNER_STATE,e)},_subscribeToSchemaMappingDialogEvents:function(e,i){this.listenTo(this.domainValidationEventBus,"schemaMappingDialog:confirm",t.bind(this._onSchemaMappingConfirmed,this,e,i)),this.listenTo(this.domainValidationEventBus,"schemaMappingDialog:reject",t.bind(this._onCancel,this,e,i)),this.listenTo(this.schemaMappingDialog,"dialog:close",t.bind(this._onCancel,this,e,i)),this.listenTo(this.domainValidationEventBus,"schemaMappingDialog:schemaItemClicked",this._onSchemaItemClicked),this.listenTo(this.domainValidationEventBus,"schemaMappingDialog:linkButtonClicked",this._onLinkButtonClicked),this.listenTo(this.domainValidationEventBus,"schemaMappingDialog:unlinkButtonClicked",this._onUnlinkButtonClicked)},_unsubscribeToSchemaMappingDialogEventsAndCloseDialog:function(){this.schemaMappingDialog.close(),this.schemaMappingModel.set("isVisible",!1),this.stopListening(this.schemaMappingDialog),this.stopListening(this.domainValidationEventBus)}}),a.exports=S});