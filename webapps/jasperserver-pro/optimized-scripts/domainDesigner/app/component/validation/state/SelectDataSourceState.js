/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../../rest/enum/requestCanceledEnum","../../../rest/errorHandling/errorHandlingUtil","./enum/validationStateNameEnum"],function(e,o,t){var r=e("underscore"),i=e("backbone"),s=e("../../../rest/enum/requestCanceledEnum"),a=e("../../../rest/errorHandling/errorHandlingUtil"),n=e("./enum/validationStateNameEnum"),c=function(e){this.initialize(e)};r.extend(c.prototype,i.Events,{initialize:function(e){this.selectDataSourceLoaderDialogEventBus=e.selectDataSourceLoaderDialogEventBus,this.dataSourceChooserDialog=e.dataSourceChooserDialog,this.dataSourceChooserDialogStore=e.dataSourceChooserDialogStore,this.clientResourcePropertiesService=e.clientResourcePropertiesService,this.dataSourceSelectionCheckService=e.dataSourceSelectionCheckService,this.dataSourceChooserPopoverErrorMessageConverter=e.dataSourceChooserPopoverErrorMessageConverter,this.repositoryResourceChooserStateMutations=e.repositoryResourceChooserStateMutations,this.repositoryResourceChooserActions=e.repositoryResourceChooserActions},enter:function(e,o){this.listenTo(this.dataSourceChooserDialog,"dialog:resource:confirm",r.bind(this._onDataSourceSelectionConfirmed,this,e,o)),this.listenTo(this.dataSourceChooserDialog,"dialog:resource:reject",r.bind(this._onDataSourceCheckRejected,this,e,o)),this.listenTo(this.selectDataSourceLoaderDialogEventBus,"show",this._onShowLoader),this.listenTo(this.selectDataSourceLoaderDialogEventBus,"hide",this._onHideLoader);var t={listSelection:{}},i=this.clientResourcePropertiesService.getDataSourceName();if(i){var s=this.clientResourcePropertiesService.getDataSourceUri(i);t.listSelection[s]=!0}this.dataSourceChooserDialog.open(t)},_onShowLoader:function(){this.dataSourceChooserDialogStore.set("isCheckInProgress",!0)},_onHideLoader:function(){this.dataSourceChooserDialogStore.set("isCheckInProgress",!1)},_onDataSourceSelectionConfirmed:function(e,o,t){var r=this;this.dataSourceSelectionCheckService.isValid({uri:t}).then(function(){r._onDataSourceCheckSuccess(e,o,t)}).fail(function(t){r._onDataSourceCheckFailed(e,o,t)})},_onDataSourceCheckRejected:function(e,o){var t=this.dataSourceChooserDialogStore.get("isCheckInProgress");this.selectDataSourceLoaderDialogEventBus.trigger("cancel"),t||this._closeDialogAndSwitchState(e,o)},_onDataSourceCheckFailed:function(e,o,t){if(t!==s.CANCELED){this._setPopoverErrorMessage(t);var r=this.repositoryResourceChooserActions.getCurrentModeSelection();this.repositoryResourceChooserStateMutations.markCurrentModeNodesInvalid(r)}},_setPopoverErrorMessage:function(e){var o=a.getErrors(e),t=this.dataSourceChooserPopoverErrorMessageConverter.convert(o),r=t[0].errorParameters[0];this.repositoryResourceChooserStateMutations.setPopoverErrorMessage(r)},_onDataSourceCheckSuccess:function(e,o,t){this._closeDialog(),e.dataSourceUri=t;var r=e.initialState===n.REPLACE_DATA_SOURCE_INITIAL_STATE,i=e.initialState===n.SAVE_DOMAIN_INITIAL_VALIDATION_STATE;e.initialState===n.INITIALIZE_DOMAIN_DESIGNER_STATE?o.enter(n.DOMAIN_DESIGNER_INITIAL_STATE_DATA_SOURCE_URI_SELECTED_STATE,e):r||i?o.enter(n.REPLACE_DATA_SOURCE_DATA_SOURCE_URI_SELECTED_STATE,e):e.initialState===n.UPLOAD_SCHEMA_INITIAL_STATE&&o.enter(n.UPLOAD_SCHEMA_DATA_SOURCE_URI_SELECTED_STATE,e)},_closeDialog:function(){this.stopListening(this.dataSourceChooserDialog),this.stopListening(this.selectDataSourceLoaderDialogEventBus),this.dataSourceChooserDialogStore.reset(),this.dataSourceChooserDialog.close()},_closeDialogAndSwitchState:function(e,o){this._closeDialog(),o.enter(n.GOTO_PREVIOUS_LOCATION_OR_STAY_IN_DESIGNER_STATE,e)}}),t.exports=c});