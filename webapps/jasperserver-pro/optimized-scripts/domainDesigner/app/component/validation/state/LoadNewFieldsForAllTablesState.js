/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","./enum/validationStateNameEnum"],function(e,t,a){var i=e("jquery"),n=e("underscore"),r=e("./enum/validationStateNameEnum"),o=function(e){this.initialize(e)};n.extend(o.prototype,{initialize:function(e){this.metadataService=e.metadataService,this.validationMetadataService=e.validationMetadataService,this.domainValidationMutations=e.domainValidationMutations,this.clientDomainValidationService=e.clientDomainValidationService,this.dataSourceMetadataToDTOConverter=e.dataSourceMetadataToDTOConverter,this.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec=e.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec},enter:function(e,t){var a=this;this._loadNewFieldsForAllTables(e).then(function(i){a.domainValidationMutations.addNewFields(i),e.initialState===r.SAVE_DOMAIN_INITIAL_VALIDATION_STATE?t.enter(r.SAVE_DOMAIN_AFTER_VALIDATION_ERROR_IS_RESOLVED_STATE,e):t.enter(r.SET_DOMAIN_DESIGNER_STATE_WITH_CURRENT_DESIGNER_STATE,e)})},_loadNewFieldsForAllTables:function(e){var t=this.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec.isSatisfied(),a=this.clientDomainValidationService.getDataSource().uri,i=this.clientDomainValidationService.getAllTablesWithPath({isSchemaLessDataSourceWithEmptyResolvedSchemaAttribute:t});return this._getMetadataAndFilterOnlyTablesWithNewFields(a,i,e)},_getMetadataAndFilterOnlyTablesWithNewFields:function(e,t,a){var o=this,l=(new i.Deferred).resolve([]),d=n.map(t,function(e){return e.tablePath});if(t.length>0){var s=this.metadataService;a.initialState===r.INITIALIZE_DOMAIN_DESIGNER_STATE&&(s=this.validationMetadataService),l=s.getMetadata(e,d).then(function(e){return o.clientDomainValidationService.filterOnlyTablesWithNewFields(e||[],t).map(function(e){return{parentId:e.parentId,fields:o.dataSourceMetadataToDTOConverter.toTableChildrenDTO(e.fields)}})})}return l}}),a.exports=o});