/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/enum/schemaEntitiesEnum"],function(e,t,n){function i(e){r.bindAll(this,"reduce"),this.clientDomainSchemaService=e.clientDomainSchemaService}var r=e("underscore"),E=e("../../../../../model/schema/enum/schemaEntitiesEnum"),a=[E.TABLE,E.DERIVED_TABLE];r.extend(i.prototype,{reduce:function(e){var t,n=e.collections,i=e.targetEntityOptions,a=e.reducedCollections,c={},s=n[E.TABLE_REFERENCE];return c[E.TABLE_REFERENCE]=n[E.TABLE_REFERENCE]||[],s&&(this._isAllowedTargetEntityType(i)&&(t=this._getTableNamesOfAffectedEntities(i),c[E.TABLE_REFERENCE]=this._omitTableReferencesByTableNames(n,t)),c[E.TABLE_REFERENCE]=this._omitDerivedTableBasedTableReferences(n,c)),r.extend({},a,c)},_isAllowedTargetEntityType:function(e){var t=e.targetEntityType;return t&&r.contains(a,t)},_omitTableReferencesByTableNames:function(e,t){return r.reduce(e[E.TABLE_REFERENCE],function(e,n){return t[n.name]||e.push(n),e},[])},_omitDerivedTableBasedTableReferences:function(e,t){var n=e[E.DERIVED_TABLE]||[],i=r.reduce(n,function(e,t){return e[t.name]=!0,e},{});return t[E.TABLE_REFERENCE].filter(function(e){return!i[e.name]})},_getTableNamesOfAffectedEntities:function(e){return r.map(e.targetEntitiesIds,function(e,t){return t=parseInt(t,10),this.clientDomainSchemaService.getTableById(t).name},this).reduce(function(e,t){return e[t]=!0,e},{})}}),n.exports=i});