/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","backbone","../util/selectedFieldsUtil","../../../../model/util/resourceNameSpecialCharactersUtil","../../../../dispatcher/enum/applicationStateEventsEnum","../enum/queryRunningSourceEnum","../enum/newDerivedTableNameEnum","../../../../../model/schema/enum/schemaEntitiesEnum"],function(e,i,t){var r=e("underscore"),s=e("jquery"),a=e("backbone"),n=e("../util/selectedFieldsUtil"),d=e("../../../../model/util/resourceNameSpecialCharactersUtil"),l=e("../../../../dispatcher/enum/applicationStateEventsEnum"),o=e("../enum/queryRunningSourceEnum"),u=e("../enum/newDerivedTableNameEnum"),h=e("../../../../../model/schema/enum/schemaEntitiesEnum"),g={CREATE:l.DERIVED_TABLES_DESIGNER_CREATE_DERIVED_TABLE,UPDATE:l.DERIVED_TABLES_DESIGNER_UPDATE_DERIVED_TABLE},v=function(e){this.dialog=e.dialog,this.derivedTablesDesignerStore=e.derivedTablesDesignerStore,this.derivedTableLoaderDialogEventBus=e.derivedTableLoaderDialogEventBus,this.applicationCrossComponentEventBus=e.applicationCrossComponentEventBus,this.derivedTablesDesignerEventBus=e.derivedTablesDesignerEventBus,this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.clientDomainSchemaService=e.clientDomainSchemaService,this.derivedTablesDesignerDerivedTableValidator=e.derivedTablesDesignerDerivedTableValidator,this.expressionBulkUpdateService=e.expressionBulkUpdateService,this.initialQueryResultSetHeight=e.initialQueryResultSetHeight,this.fieldNameGenerator=e.fieldNameGenerator,this.derivedTablesDesignerStoreQueryResultDataProvider=e.derivedTablesDesignerStoreQueryResultDataProvider,this.derivedTablesDesignerQueryRunController=e.derivedTablesDesignerQueryRunController,this._initEvents()};r.extend(v.prototype,a.Events,{_initEvents:function(){this.listenTo(this.applicationCrossComponentEventBus,"sidebar:createDerivedTable",this._onStartDerivedTableCreation),this.listenTo(this.applicationCrossComponentEventBus,"sidebarTreeMenu:editDerivedTable",this._onStartDerivedTableEditing),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:runQuery",r.bind(this._onRunQuery,this,o.RUN_QUERY)),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:cancelQuery",this._onCancelQuery),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:createDerivedTable",this._onCreateDerivedTable),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:updateDerivedTable",this._onUpdateDerivedTable),this.listenTo(this.derivedTableLoaderDialogEventBus,"show",this._showLoader),this.listenTo(this.derivedTableLoaderDialogEventBus,"hide",this._hideLoader),this.listenTo(this.dialog,"dialog:close",this._onDialogClose)},_onStartDerivedTableCreation:function(e){var i=this.derivedTablesDesignerStoreQueryResultDataProvider.getQueryResultStoreData({fields:[],selectedFields:[],queryResultSetHeight:this.initialQueryResultSetHeight}),t=r.extend(i,{dataSourceId:e,queryResultSetHeight:this.initialQueryResultSetHeight,name:this.clientDomainSchemaService.getNameForTableReferenceCopy(u.NAME)});this.derivedTablesDesignerStore.reset(t),this.dialog.open()},_onStartDerivedTableEditing:function(e){var i=this.clientDomainSchemaService.getDerivedTableJsonByIdWithFields(e),t=r.map(i.children,function(e){return e=r.extend({},e,{name:e.sourceName||e.name,originalName:e.name})}),s=this.derivedTablesDesignerStoreQueryResultDataProvider.getQueryResultStoreData({fields:t,selectedFields:t,queryResultSetHeight:this.initialQueryResultSetHeight}),a=r.extend(s,{id:i.id,name:i.name,originalName:i.name,query:i.query,queryAfterPreviousExecution:i.query,dataSourceId:i.dataSourceId,parentId:i.parentId,queryResultSetHeight:this.initialQueryResultSetHeight});this.derivedTablesDesignerStore.reset(a),this.dialog.open()},_onRunQuery:function(e){return this.derivedTablesDesignerStore.set("queryRunningSource",e),this.derivedTablesDesignerQueryRunController.runQuery()},_onCancelQuery:function(){this.derivedTableLoaderDialogEventBus.trigger("cancel")},_showLoader:function(){this.derivedTablesDesignerStore.set("isQueryRunning",!0)},_hideLoader:function(){this.derivedTablesDesignerStore.set({isQueryRunning:!1,queryRunningSource:""})},_onCreateDerivedTable:function(){var e=this;this._updateFieldsIfQueryWasChanged().done(function(){e._validateDerivedTable()&&(e.applicationDispatcherEventBus.trigger(g.CREATE,e._getDerivedTableDTO()),e.dialog.close())})},_onUpdateDerivedTable:function(){var e=this,i=this.derivedTablesDesignerStore.get("name"),t=this.derivedTablesDesignerStore.get("originalName"),r=this.clientDomainSchemaService.getTableReferenceByName(t),s=i!==t;this._updateFieldsIfQueryWasChanged().done(function(){e._validateDerivedTable()&&(s?e.expressionBulkUpdateService.getUpdatedExpressions({resourceId:r.id,resourceType:h.TABLE_REFERENCE,originalName:t,newName:i}).then(function(i){e._updateDerivedTable(i)}):e._updateDerivedTable([]))})},_updateDerivedTable:function(e){this.applicationDispatcherEventBus.trigger(g.UPDATE,{derivedTable:this._getDerivedTableDTO(),resources:e}),this.dialog.close()},_updateFieldsIfQueryWasChanged:function(){return this.derivedTablesDesignerStore.get("query")!==this.derivedTablesDesignerStore.get("queryAfterPreviousExecution")?this._onRunQuery(o.CREATE_OR_UPDATE_DERIVED_TABLE):s.Deferred().resolve().promise()},_onDialogClose:function(){this.derivedTableLoaderDialogEventBus.trigger("cancel")},_validateDerivedTable:function(){var e=this.derivedTablesDesignerDerivedTableValidator,i=this.derivedTablesDesignerStore,t={selection:e.validateSelectedFields(i.get("selection").fields),name:e.validateName(i.get("name"),i.get("id"),i.get("dataSourceId")),query:e.validateFieldTypes(i.get("id"),i.get("fields"))||e.validateQuery(i.get("query"))};return i.set({selectedFieldsErrorMessage:t.selection,tableNameErrorMessage:t.name,queryErrorMessage:t.query||i.get("queryErrorMessage")}),!r.some(t,function(e){return Boolean(e)})},_getDerivedTableDTO:function(){return{id:this.derivedTablesDesignerStore.get("id"),type:this.derivedTablesDesignerStore.get("type"),name:this.derivedTablesDesignerStore.get("name"),query:this.derivedTablesDesignerStore.get("query"),dataSourceId:this.derivedTablesDesignerStore.get("dataSourceId"),parentId:this.derivedTablesDesignerStore.get("parentId"),children:this._getDerivedTableChildren()}},_getDerivedTableChildren:function(){this.fieldNameGenerator.reset();var e=this.derivedTablesDesignerStore.get("fields"),i=this.derivedTablesDesignerStore.get("selection"),t=n.getSelectedFieldsAsArray({fields:e,selection:i});return r.map(t,function(e){return e=r.clone(e),e.originalName?(e.name=e.originalName,delete e.originalName):d.isResourceNameContainsSpecialCharacters(e.name)&&(e.sourceName=e.name,e.name=this._generateFieldName(e.sourceName)),e},this)},_generateFieldName:function(e){var i=this,t=d.replaceResourceNameSpecialCharacters(e);return this.fieldNameGenerator.generate(t,function(e){return i.clientDomainSchemaService.getFieldByName(e)})}}),t.exports=v});