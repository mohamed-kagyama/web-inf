/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone"],function(e,i,t){var s=e("underscore"),n=e("backbone"),r=function(e){this.initialize(e)};s.extend(r.prototype,n.Events,{initialize:function(e){this.dialog=e.dialog,this.derivedTablesDesignerStore=e.derivedTablesDesignerStore,this.derivedTablesDesignerEventBus=e.derivedTablesDesignerEventBus,this.derivedTablesDesignerQueryResultConverter=e.derivedTablesDesignerQueryResultConverter,this._initEvents()},_initEvents:function(){this.listenTo(this.derivedTablesDesignerEventBus,"canvas:scroll",this._onCanvasScroll),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:selectField",this._selectField),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:toggleFieldSelection",this._toggleFieldSelection),this.listenTo(this.derivedTablesDesignerEventBus,"derivedTablesDesignerView:addToRangeSelection",this._addToRangeSelection),this.listenTo(this.dialog,"dialog:resize:started",this._onDialogResizeStart),this.listenTo(this.dialog,"dialog:resize",this._onDialogResize)},_onCanvasScroll:function(e){this._updateStore({scrollPos:e})},_selectField:function(e){var i={};i[e.name]=e.index,this.derivedTablesDesignerStore.set("selection",{rangeStart:e.index,fields:i})},_toggleFieldSelection:function(e){var i=this.derivedTablesDesignerStore.get("selection"),t=i.rangeStart,n=s.clone(i.fields);s.isEmpty(i.fields)?this._selectField(e):s.isUndefined(i.fields[e.name])?(n[e.name]=e.index,i=s.extend({},i,{fields:n}),this.derivedTablesDesignerStore.set("selection",i)):(delete n[e.name],t===e.index&&(t=void 0),this.derivedTablesDesignerStore.set("selection",{rangeStart:t,fields:n}))},_addToRangeSelection:function(e){var i=this.derivedTablesDesignerStore.get("selection"),t=this.derivedTablesDesignerStore.get("fields"),n=i.rangeStart;s.isEmpty(i.fields)?this._selectField(e):(s.isUndefined(n)&&(n=Math.min.apply(Math,s.values(i.fields))),i=s.extend({},i,{rangeStart:n,fields:this._getFieldsRangeByRangeStartAndEnd(t,n,e.index)}),this.derivedTablesDesignerStore.set("selection",i))},_getFieldsRangeByRangeStartAndEnd:function(e,i,t){var n=s.sortBy([i,t]);return e.reduce(function(e,i,t){return t>=n[0]&&t<=n[1]&&(e[i.name]=t),e},{})},_onDialogResizeStart:function(){var e=this.derivedTablesDesignerStore.get("dialogInitialHeight"),i=this.derivedTablesDesignerStore.get("initialQueryResultSetHeight");e||i||(e=this.dialog.$el.outerHeight(),i=this.dialog.$el.find(".jr-jQueryResultSet").height(),this.derivedTablesDesignerStore.set({dialogInitialHeight:e,initialQueryResultSetHeight:i}))},_onDialogResize:function(e){var i=e.size,t=this.derivedTablesDesignerStore.get("dialogInitialHeight"),s=this.derivedTablesDesignerStore.get("initialQueryResultSetHeight"),n=i.height-t,r=s+n;this._updateStore({queryResultSetHeight:i.height>t?r:s})},_updateStore:function(e){e=s.defaults({},e,{fields:this.derivedTablesDesignerStore.get("fields"),scrollPos:this.derivedTablesDesignerStore.get("scrollPos"),queryResultSetHeight:this.derivedTablesDesignerStore.get("queryResultSetHeight")});var i=this.derivedTablesDesignerQueryResultConverter.convert(e);this.derivedTablesDesignerStore.set(i)}}),t.exports=r});