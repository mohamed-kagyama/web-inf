/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/util/entityUtil","../../../../../model/schema/enum/filterOperandTypesEnum","backbone","../../../../dispatcher/enum/applicationStateEventsEnum"],function(e,t,i){var r=e("underscore"),a=e("../../../../../model/schema/util/entityUtil"),s=e("../../../../../model/schema/enum/filterOperandTypesEnum"),n=e("backbone"),l=e("../../../../dispatcher/enum/applicationStateEventsEnum"),o=function(e){this.initialize(e)};r.extend(o.prototype,{initialize:function(e){this.isResourceDroppableIntoCanvasDroppableAreaSpecification=e.isResourceDroppableIntoCanvasDroppableAreaSpecification,this.filtersDesignerViewStateModelService=e.filtersDesignerViewStateModelService,this.filtersDesignerStore=e.filtersDesignerStore,this.filtersDesignerEventBus=e.filtersDesignerEventBus,this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.filtersDesignerDraftFilterFactory=e.filtersDesignerDraftFilterFactory,this.availableValuesCacheCleaner=e.availableValuesCacheCleaner,this._initEvents()},_initEvents:function(){this.listenTo(this.filtersDesignerEventBus,"canvasDroppableArea:drop sidebar:doubleClickItem sidebar:onVirtualData:drop",this._onAddDraftFilter)},_shouldUseFiledToFieldValueEditor:function(e){return a.isConstantGroup(e.sourceType)},_onAddDraftFilter:function(e){var t=this.filtersDesignerViewStateModelService.getDraftFilterState();if(r.isEmpty(t)&&e){var i=this;if(this.isResourceDroppableIntoCanvasDroppableAreaSpecification.isSatisfiedBy(e)){this.availableValuesCacheCleaner.clean();var a=this._createDraftFilterStateWithoutRightOperand(e),s=this._createNewFilterOptions(e);return this.filtersDesignerDraftFilterFactory.create(a,s).then(function(e){i.applicationDispatcherEventBus.trigger(l.FILTERS_DESIGNER_SET_DRAFT_FILTER,e)})}}},_createNewFilterOptions:function(e){return{rightOperandType:this._shouldUseFiledToFieldValueEditor(e)?s.VARIABLE:s.LITERAL}},_createDraftFilterStateWithoutRightOperand:function(e){return{expression:{left:{type:s.VARIABLE,fieldId:e.resourceId,fieldType:e.type,sourceId:e.sourceId,sourceType:e.sourceType}}}}},n.Events),i.exports=o});