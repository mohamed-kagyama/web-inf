/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/enum/clientExpressionsEnum","../../util/filterOperandTypeUtil","../enum/defaultNewFilterOptions","../enum/draftFilterStateEnum"],function(e,t,i){var r=e("underscore"),a=e("../../../../../model/enum/clientExpressionsEnum"),n=e("../../util/filterOperandTypeUtil"),l=e("../enum/defaultNewFilterOptions"),o=e("../enum/draftFilterStateEnum"),s=function(e){this.defaultDraftFilterFactory=e.defaultDraftFilterFactory,this.clientDomainSchemaService=e.clientDomainSchemaService,this.shouldCheckAvailableValuesLoadingForDraftFilterSpecification=e.shouldCheckAvailableValuesLoadingForDraftFilterSpecification,this.shouldUseRawValueEditorForDraftFilterSpecification=e.shouldUseRawValueEditorForDraftFilterSpecification};r.extend(s.prototype,{enter:function(e,t){var i=this._getDraftFilter(e.currentFilter),r=this._getNewFilterOptions(i,e.newFilterOptions);e.currentFilter=i,e.newFilterOptions=r,this.shouldCheckAvailableValuesLoadingForDraftFilterSpecification.isSatisfiedBy(e)?t.enter(o.CHECK_AVAILABLE_VALUES_STATE,e):t.enter(o.GET_RIGHT_OPERAND_STATE,e)},_getDraftFilter:function(e){e=this.defaultDraftFilterFactory.create(e);var t=this._getDraftFilterDataType(e);return r.extend({},e,{dataType:t})},_getDraftFilterDataType:function(e){var t=e.expression.left.fieldId||e.expression.right&&e.expression.right.fieldId;return t&&this.clientDomainSchemaService.getGenericFiledTypeById(t)},_getNewFilterOptions:function(e,t){var i=e.dataType,a=t&&n.isVariable(t.rightOperandType),o={operator:e.expression.operator,rightOperandType:e.expression.right&&e.expression.right.type};return t=i||a?r.defaults(t||o,l):l,t=r.extend({},t,{isRawValueEditor:this.shouldUseRawValueEditorForDraftFilterSpecification.isSatisfiedBy(e,t),operator:this._getAvailableOperator(e,t)})},_getAvailableOperator:function(e,t){var i=e.expression,r=t.operator;return this._isAtLeastOneFieldSetToOperand(i)?r:a.operators.equals.name},_isAtLeastOneFieldSetToOperand:function(e){return e.left&&e.left.fieldId||e.right&&e.right.fieldId}}),i.exports=s});