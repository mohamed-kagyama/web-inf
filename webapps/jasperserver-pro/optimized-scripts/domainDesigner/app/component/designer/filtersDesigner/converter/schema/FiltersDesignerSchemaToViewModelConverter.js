/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../enum/operandSideEnum","../../../../../common/util/byIdReducer","../../util/filterOperandTypeUtil","../../../../../../model/schema/util/entityUtil","../../util/filtersDesignerUtil","../../../../../common/util/numberUtil","../../../../../../model/schema/enum/schemaEntitiesEnum","../../../../../../model/schema/util/schemaModelUtil","../../../../../util/designer/collectionComponentsVisibilityUtil"],function(e,t,r){var i=e("underscore"),s=e("../../enum/operandSideEnum"),n=e("../../../../../common/util/byIdReducer"),o=e("../../util/filterOperandTypeUtil"),a=e("../../../../../../model/schema/util/entityUtil"),l=e("../../util/filtersDesignerUtil"),c=e("../../../../../common/util/numberUtil"),d=e("../../../../../../model/schema/enum/schemaEntitiesEnum"),u=e("../../../../../../model/schema/util/schemaModelUtil"),p=e("../../../../../util/designer/collectionComponentsVisibilityUtil"),h=function(e){this.settings=e.settings,this.filterExpressionSerializer=e.filterExpressionSerializer,this.filtersDesignerViewStateModelService=e.filtersDesignerViewStateModelService,this.shouldDropZoneBeActiveSpecification=e.shouldDropZoneBeActiveSpecification};i.extend(h.prototype,{convert:function(e){var t,r=e.dataStore,s=this.filtersDesignerViewStateModelService.getDraftFilterState(),o={tablesMap:r.tables.reduce(n,{}),fieldsMap:r.fields.reduce(n,{}),tableReferencesMap:r.tableReferences.reduce(n,{}),joinAliasesMap:r.joinAliases.reduce(n,{})},a={state:e,maps:o};i.isEmpty(s)||(s.id?a.draftFilterState=s:t=this._convertDraftFilter(e,s));var l=r.filters.reduce(i.bind(this._filterReducer,this,a),[]);return l=this._sortFilters(l),t&&(l=l.concat([t])),l},_sortFilters:function(e){var t=this.filtersDesignerViewStateModelService.getFiltersPositions();return i.sortBy(e,function(e){return t[e.id]})},_filterReducer:function(e,t,r){var i,s=e.state,n=e.draftFilterState;n&&r.getId()===n.id?i=this._convertDraftFilter(s,n):a.isFilterExpression(r)?i=this._convertFilterExpression(s,r):a.isComplexFilter(r)&&(i=this._convertComplexFilterExpression(s,r));var o=l.getSearchKeyword(s),c={filter:r,maps:e.maps,convertedFilter:i,searchKeyword:o};return this._isFilterMatchSearchKeyword(c)&&t.push(i),t},_isFilterMatchSearchKeyword:function(e){var t=e.convertedFilter,r=e.searchKeyword,s=e.filter,n=e.maps;if(i.isEmpty(r)||t.isDraft)return!0;var o;return a.isFilterExpression(t.type)?(o=[t.rightString,t.leftString,t.operatorString],(c.isInteger(t.rightString)||c.isDecimal(t.rightString))&&o.push(c.removeThousandsDelimiter(t.rightString))):o=[t.expression],o=s.fieldReferences.reduce(function(e,t){var r,i,s,l=n.fieldsMap[t.fieldId];return a.isTableReference(t.sourceType)?s=n.tableReferencesMap[t.sourceId]:a.isJoinAlias(t.sourceType)&&(i=n.joinAliasesMap[t.sourceId],s=n.tableReferencesMap[i.tableReferenceId]),s&&(r=n.tablesMap[s.tableId]),l.sourceName&&o.push(l.sourceName),r&&o.push(r.name),o},o),i.some(o,function(e){return p.matchSearchKeyword(e,r)})},_convertComplexFilterExpression:function(e,t){var r=d.COMPLEX_FILTER;return{id:t.getId(),type:r,sourceId:t.getSourceId(),sourceType:t.getSourceType(),height:this.settings.height[r],expression:t.expression.string}},_convertDraftFilter:function(e,t){var r=d.FILTER_EXPRESSION,n=t.expression,o=n.operator,a={state:e,filter:t},l=i.extend({which:s.LEFT},a),c=i.extend({which:s.RIGHT},a),u=this._convertDraftFilterOperand(n.right,c),p=this._convertDraftFilterOperand(n.left,l),h=this._getDraftFilterHeight({filterType:r,rightOperandType:u.type,isRawValueEditor:t.isRawValueEditor,errors:t.errors});return{id:t.id,isDraft:!0,dataType:t.dataType,errors:t.errors,isRawValueEditor:t.isRawValueEditor,type:r,sourceId:t.sourceId,sourceType:t.sourceType,height:h,leftOperand:p,operator:o,rightOperand:u}},_getDraftFilterHeight:function(e){var t=e.filterType,r=e.rightOperandType,i=e.isRawValueEditor,s=e.errors,n=this.settings.height[t].edit[r];return o.isLiteral(r)&&(n=i?n.rawValueEditor:n.singleSelectEditor),n[this._hasErrors(s,r)?"error":"normal"]},_hasErrors:function(e,t){var r=e&&e.right,s=!i.isEmpty(r);return s&&o.isRange(t)?s=r.startErrorMessage||r.endErrorMessage:s&&(s=r.errorMessage),s},_convertDraftFilterOperand:function(e,t){return o.isVariable(e.type)?this._convertDraftFilterVariable(e,t):o.isRange(e.type)?this._convertDraftFilterRange(e,t):o.isList(e.type)?this._convertDraftFilterList(e,t):o.isLiteral(e.type)?this._convertDraftFilterLiteral(e,t):void 0},_convertDraftFilterVariable:function(e,t){var r=t.filter,s=t.state,n=t.which,o={type:e.type};if(!i.isUndefined(e.fieldId)){var a=s.dataStore.fields.byId(e.fieldId),l=u.getResourceByIdAndType(e.sourceId,e.sourceType,s.dataStore);o=i.extend(o,{fieldName:a.getName(),sourceName:l.getName()},e)}return o=i.extend(o,{which:n}),this.shouldDropZoneBeActiveSpecification.isSatisfiedBy(r,n)&&(o=i.extend(o,{shouldDropZoneBeActive:!0})),o},_convertDraftFilterRange:function(e,t){return e},_convertDraftFilterList:function(e,t){return e},_convertDraftFilterLiteral:function(e,t){return e},_convertFilterExpression:function(e,t){var r=a.getEntityName(t),s=this.filterExpressionSerializer.serialize(t);return i.extend({id:t.getId(),sourceId:t.getSourceId(),sourceType:t.getSourceType(),height:this.settings.height[r].readOnly,type:r},s)}}),r.exports=h});