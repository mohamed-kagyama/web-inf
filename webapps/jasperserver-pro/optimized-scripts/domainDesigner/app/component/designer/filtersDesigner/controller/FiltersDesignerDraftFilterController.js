/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../../../../model/schema/util/entityUtil","../enum/operandSideEnum","../../../../../model/schema/enum/filterOperandTypesEnum","../util/filterOperandTypeUtil","../../../../dispatcher/enum/applicationStateEventsEnum"],function(e,t,i){var r=e("underscore"),s=e("backbone"),a=e("../../../../../model/schema/util/entityUtil"),n=e("../enum/operandSideEnum"),l=e("../../../../../model/schema/enum/filterOperandTypesEnum"),o=e("../util/filterOperandTypeUtil"),h=e("../../../../dispatcher/enum/applicationStateEventsEnum"),d=function(e){this.initialize(e)};r.extend(d.prototype,{initialize:function(e){this.store=e.store,this.filtersDesignerEventBus=e.filtersDesignerEventBus,this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.filtersDesignerViewStateModelService=e.filtersDesignerViewStateModelService,this.filtersDesignerDraftFilterValidator=e.filtersDesignerDraftFilterValidator,this.filtersDesignerOnSaveDraftFilterConverter=e.filtersDesignerOnSaveDraftFilterConverter,this.filtersDesignerDraftFilterFactory=e.filtersDesignerDraftFilterFactory,this.filterExpressionOperatorByRightOperandTypeFactory=e.filterExpressionOperatorByRightOperandTypeFactory,this.availableValuesCacheCleaner=e.availableValuesCacheCleaner,this.errorsCache=e.errorsCache,this.availableValuesRequestSuccessCache=e.availableValuesRequestSuccessCache,this.clientDomainSchemaService=e.clientDomainSchemaService,this._initEvents()},_initEvents:function(){this.listenTo(this.filtersDesignerEventBus,"draftFilter:left:over",this._onLeftSideOver),this.listenTo(this.filtersDesignerEventBus,"draftFilter:left:out",this._onLeftSideOut),this.listenTo(this.filtersDesignerEventBus,"draftFilter:right:over",this._onRightSideOver),this.listenTo(this.filtersDesignerEventBus,"draftFilter:right:out",this._onRightSideOut),this.listenTo(this.filtersDesignerEventBus,"draftFilter:left:removeField",this._onLeftFieldRemove),this.listenTo(this.filtersDesignerEventBus,"draftFilter:right:removeField",this._onRightFieldRemove),this.listenTo(this.filtersDesignerEventBus,"draftFilter:left:drop",this._onLeftSideDrop),this.listenTo(this.filtersDesignerEventBus,"draftFilter:right:drop",this._onRightSideDrop),this.listenTo(this.filtersDesignerEventBus,"draftFilter:cancel",this._onCancelFilter),this.listenTo(this.filtersDesignerEventBus,"draftFilter:edit",this._onEditFilter),this.listenTo(this.filtersDesignerEventBus,"draftFilter:changeValue",this._onChangeValue),this.listenTo(this.filtersDesignerEventBus,"draftFilter:operator:change",this._onOperatorChange),this.listenTo(this.filtersDesignerEventBus,"draftFilter:valueEditor:singleSelect",this._switchValueEditorToSingleSelect),this.listenTo(this.filtersDesignerEventBus,"draftFilter:valueEditor:input",this._switchValueEditorToInput),this.listenTo(this.filtersDesignerEventBus,"draftFilter:valueEditor:fieldToField",this._switchValueEditorToFieldToField),this.listenTo(this.filtersDesignerEventBus,"draftFilter:valueEditor:fieldToValue",this._switchValueEditorToFieldToValue),this.listenTo(this.filtersDesignerEventBus,"draftFilter:variables:swap",this._swapVariables)},_switchValueEditorToSingleSelect:function(){this._switchRawAndSingleSelectValueEditor(!1)},_switchValueEditorToInput:function(){this._switchRawAndSingleSelectValueEditor(!0)},_switchRawAndSingleSelectValueEditor:function(e){var t=this._getSwitchValueEditorOptions(l.LITERAL),i=this.filtersDesignerViewStateModelService.getDraftFilterState();t=r.extend({},t,{isRawValueEditor:e}),i=this._clearValidationErrors(i),this._createAndSetNewDraftFilter(i,t)},_swapVariables:function(){var e=this.filtersDesignerViewStateModelService.getDraftFilterState(),t=this._getDraftFilterWithSwappedVariables(e),i=this._getNewFilterOptionsFromExistingFilter(t);this.availableValuesCacheCleaner.clean(),this._createAndSetNewDraftFilter(t,i)},_getDraftFilterWithSwappedVariables:function(e){var t=e.expression.left,i=e.expression.right;return r.extend({},e,{expression:r.extend({},e.expression,{left:i,right:t})})},_switchValueEditorToFieldToField:function(){var e=this.filtersDesignerViewStateModelService.getDraftFilterState();if(!o.isVariable(e.expression.right.type)){var t=this._getSwitchValueEditorOptions(l.VARIABLE),i=this.filtersDesignerViewStateModelService.getDraftFilterState();i=this._clearValidationErrors(i),this._createAndSetNewDraftFilter(i,t)}},_switchValueEditorToFieldToValue:function(){var e=this.filtersDesignerViewStateModelService.getDraftFilterState();if(o.isVariable(e.expression.right.type)){var t=this._getSwitchValueEditorOptions(l.LITERAL),i=this.filtersDesignerViewStateModelService.getDraftFilterState();i=this._clearValidationErrors(i),this._createAndSetNewDraftFilter(i,t)}},_getSwitchValueEditorOptions:function(e){var t=this.filtersDesignerViewStateModelService.getDraftFilterState();return{operator:this.filterExpressionOperatorByRightOperandTypeFactory.create({operator:t.expression.operator,operandType:e,dataType:t.dataType}),rightOperandType:e}},_onCancelFilter:function(){this.applicationDispatcherEventBus.trigger(h.FILTERS_DESIGNER_CANCEL_DRAFT_FILTER)},_onEditFilter:function(){var e=this.filtersDesignerViewStateModelService.getDraftFilterState(),t=e&&this.filtersDesignerDraftFilterValidator.validate(e);t?(e=this._setValidationErrors(e,t),this.applicationDispatcherEventBus.trigger(h.FILTERS_DESIGNER_SET_DRAFT_FILTER,e)):(e=this.filtersDesignerOnSaveDraftFilterConverter.convert(e),e.id?this.applicationDispatcherEventBus.trigger(h.FILTERS_DESIGNER_UPDATE_FILTER,e):this.applicationDispatcherEventBus.trigger(h.FILTERS_DESIGNER_ADD_FILTER,e))},_onOperatorChange:function(e){this.availableValuesCacheCleaner.cleanAvailableValuesErrorsCache(),this.availableValuesCacheCleaner.cleanAvailableValuesFirstRequestSuccessCache();var t=this.filtersDesignerViewStateModelService.getDraftFilterState();t=this._clearValidationErrors(t),this._createAndSetNewDraftFilter(t,e)},_onChangeValue:function(e){var t=this.filtersDesignerViewStateModelService.getDraftFilterState();t.expression.right=r.extend({},t.expression.right,e),t=this._clearValidationErrors(t),this.applicationDispatcherEventBus.trigger(h.FILTERS_DESIGNER_SET_DRAFT_FILTER,t)},_onLeftSideOver:function(){this.store.get("runtime").left.over=!0},_onLeftSideOut:function(){this.store.get("runtime").left.over=!1},_onRightSideOver:function(){this.store.get("runtime").right.over=!0},_onRightSideOut:function(){this.store.get("runtime").right.over=!1},_onLeftFieldRemove:function(){var e=this.filtersDesignerViewStateModelService.getDraftFilterState(),t=e.expression,i=r.extend({},e,{expression:r.extend({},t,{left:{type:l.VARIABLE}})}),s=this._getNewFilterOptionsFromExistingFilter(i);return i=this._clearValidationErrors(i),this._createAndSetNewDraftFilter(i,s)},_onRightFieldRemove:function(){var e=this.filtersDesignerViewStateModelService.getDraftFilterState(),t={operator:e.expression.operator,rightOperandType:l.VARIABLE},i=r.extend({},e,{expression:r.omit(e.expression,"right")});return this._createAndSetNewDraftFilter(i,t)},_getNewFilterOptionsFromExistingFilter:function(e){var t=e.expression;return{rightOperandType:t.right.type,operator:t.operator}},_onLeftSideDrop:function(e){this.availableValuesCacheCleaner.clean(),this._onLeftSideOut();var t=this._getDraftFilterOnDrop(e,n.LEFT),i=this._getNewFilterOptionsFromExistingFilter(t);o.isLiteral(t.expression.right.type)&&(t.expression.right=r.omit(t.expression.right,"value")),this._createAndSetNewDraftFilter(t,i)},_onRightSideDrop:function(e){this._onRightSideOut();var t=this._getDraftFilterOnDrop(e,n.RIGHT),i=this._getNewFilterOptionsFromExistingFilter(t);this._createAndSetNewDraftFilter(t,i)},_getDraftFilterOnDrop:function(e,t){var i=this.filtersDesignerViewStateModelService.getDraftFilterState(),s=t===n.LEFT,a=i.expression[n.RIGHT],o=a.type===l.VARIABLE,h=this._shouldUseFiledToFieldValueEditor(e);return i.isRawValueEditor=!1,r.extend(i.expression[t],{type:l.VARIABLE,fieldId:e.resourceId,fieldType:e.type,sourceId:e.sourceId,sourceType:e.sourceType}),s&&!o&&h&&(i.expression[n.RIGHT]={type:l.VARIABLE}),i},_shouldUseFiledToFieldValueEditor:function(e){return a.isConstantGroup(e.sourceType)},_clearValidationErrors:function(e){return r.extend({},e,{errors:{}})},_setValidationErrors:function(e,t){return e.errors.left=t.left||{},e.errors.right=t.right||{},e},_createAndSetNewDraftFilter:function(e,t){var i=this;this.filtersDesignerDraftFilterFactory.create(e,t).then(function(e){i.applicationDispatcherEventBus.trigger(h.FILTERS_DESIGNER_SET_DRAFT_FILTER,e)})}},s.Events),i.exports=d});