/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../../../rest/enum/requestCanceledEnum"],function(e,r,t){var i=e("jquery"),a=e("underscore"),o=e("../../../../rest/enum/requestCanceledEnum"),c=function(e){this.initialize(e)};a.extend(c.prototype,{initialize:function(e){a.bindAll(this,"getData"),this.domainToInMemoryDomainForAvailableValuesConverter=e.domainToInMemoryDomainForAvailableValuesConverter,this.queryExecutionService=e.queryExecutionService,this.adhocQueryByFieldNameFactory=e.adhocQueryByFieldNameFactory,this.clientDomainSchemaService=e.clientDomainSchemaService,this.multilevelAdhocQueryToAvailableValuesConverter=e.multilevelAdhocQueryToAvailableValuesConverter,this.cache=e.cache,this.errorsCache=e.errorsCache,this.availableValuesFirstRequestSuccessCache=e.availableValuesFirstRequestSuccessCache},getData:function(e){e=e||{};var r=this,t=e.draftFilter,c=t.expression.left,s=this._getAdhocQuery(c,e.criteria),n=this._getInMemoryDomain(c),u=this._getErrorsCacheKey(n),l=this.errorsCache.get(u),d=l===o.CANCELED;if(d&&!this.availableValuesFirstRequestSuccessCache.get("atLeastOneRequestSuccessful"))return(new i.Deferred).resolve({data:[],total:0}).promise();if(l&&!d)return(new i.Deferred).reject(l).promise();var h={adhocQuery:s,domain:n,queryParams:a.pick(e,["offset","limit"])};return this.queryExecutionService.executeAdhocQuery(h).then(function(e){r.availableValuesFirstRequestSuccessCache.add("atLeastOneRequestSuccessful",!0);var a=r.multilevelAdhocQueryToAvailableValuesConverter.convert(e,t.dataType);return(new i.Deferred).resolve(a)}).fail(function(e){r.errorsCache.add(u,e)})},_getErrorsCacheKey:function(e){return JSON.stringify(e)},_getAdhocQuery:function(e,r){var t=this.clientDomainSchemaService.getEntityByIdAndType(e.fieldId,e.fieldType);return this.adhocQueryByFieldNameFactory.create({fieldName:t.name,fieldType:t.type,searchKeyword:r})},_getInMemoryDomain:function(e){if(!this.cache.get("domain")){var r={sourceId:e.sourceId,sourceType:e.sourceType,fieldId:e.fieldId,fieldType:e.fieldType},t=this.domainToInMemoryDomainForAvailableValuesConverter.convert(r);this.cache.add("domain",t)}return this.cache.get("domain")}}),t.exports=c});