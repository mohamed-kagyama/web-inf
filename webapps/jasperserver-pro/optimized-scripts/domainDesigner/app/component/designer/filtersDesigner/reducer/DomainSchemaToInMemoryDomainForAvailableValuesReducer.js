/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/util/entityUtil","../../../../../model/schema/enum/schemaEntitiesEnum","../../../../../model/schema/util/schemaModelUtil"],function(e,s,t){var n=e("underscore"),i=e("../../../../../model/schema/util/entityUtil"),l=e("../../../../../model/schema/enum/schemaEntitiesEnum"),c=e("../../../../../model/schema/util/schemaModelUtil"),a=function(e){this.clientDomainSchemaCalcFieldsService=e.clientDomainSchemaCalcFieldsService,this.schemaModelConverter=e.schemaModelConverter};n.extend(a.prototype,{reduce:function(e,s){var t=c.getResourceByIdAndType(e.fieldId,e.fieldType,s),n=c.getResourceByIdAndType(e.sourceId,e.sourceType,s),l={source:n,field:t,schema:s};return i.isJoinTree(n)?this._reduceCrossTableCalcField(l):this._reduceTableReferenceField(l),s},_reduceCrossTableCalcField:function(e){var s=e.source,t=e.field,n=e.schema,i={};i[t.getId()]=!0,i[s.getId()]=!0,i=this._addAllSlaveFieldsToUsedResources(i,t),i=this._addAllResourcesUsedInJoinTreeToUsedResources(s,i),i=this._addTableReferencesUsedInJoinTreeToUsedResources(s,n,i),i=this._addAllDataSourceMetadataToUsedResources(n,i),this._cleanUpAllDomainResources(n,i),this._createDataIsland(t,s,n)},_reduceTableReferenceField:function(e){var s,t=e.source,n=e.field,l=e.schema;i.isJoinAlias(t)?s=c.getTableReferenceByJoinAlias(t,l):i.isTableReference(t)&&(s=l.tableReferences.byId(t.getId()));var a={};a[n.getId()]=!0,a[s.getId()]=!0,a=this._addAllSlaveFieldsToUsedResources(a,n),a=this._addAllDataSourceMetadataToUsedResources(l,a),this._cleanUpAllDomainResources(l,a),this._createDataIsland(n,s,l)},_addAllSlaveFieldsToUsedResources:function(e,s){return n.extend({},e,this._getAllSlaveFields(s))},_addAllResourcesUsedInJoinTreeToUsedResources:function(e,s){var t={};return e.getJoins().each(function(e){i.isComplexJoin(e)?e.getFieldReferences().each(function(e){i.isJoinAlias(e.getSourceType())&&(t[e.getSourceId()]=!0),t[e.getFieldId()]=!0}):e.getJoinExpressions().each(function(e){if(i.isConstantJoinExpression(e))t[e.getJoinAliasId()]=!0,t[e.getFieldId()]=!0;else{if(!i.isJoinExpression(e))throw new Error("invalid join expression type");t[e.getLeftJoinAliasId()]=!0,t[e.getRightJoinAliasId()]=!0,t[e.getLeftFieldId()]=!0,t[e.getRightFieldId()]=!0}})}),n.extend(t,s)},_addTableReferencesUsedInJoinTreeToUsedResources:function(e,s,t){var i=e.getJoinAliases().reduce(function(e,s){return t[s.getId()]&&(e[s.getTableReferenceId()]=!0),e},{});return n.extend(i,t)},_addAllDataSourceMetadataToUsedResources:function(e,s){return e.tableReferences.each(function(t){if(s[t.getId()]){var n=c.getTableByTableReference(t,e);s=this._addAllParentResourcesToUsedResources({schema:e,resource:n,allUsedResources:s})}},this),s},_cleanUpCalcFieldsAndFiltersForSource:function(e,s){this._cleanCollectionByUsedResources(e.getCalcFields(),s),this._cleanUpFilters(e.getFilters(),{})},_getAllSlaveFields:function(e){return i.isCalcField(e)?this.clientDomainSchemaCalcFieldsService.getAllSlaveFields(e.getId()).reduce(function(e,s){return e[s]=!0,e},{}):{}},_addAllParentResourcesToUsedResources:function(e){var s,t=e.schema,n=e.resource,i=e.allUsedResources,l=n.getParentId();for(i[n.getId()]=!0;l;)s=c.getResourceParent(n,t),i[s.getId()]=!0,n=s,l=s.getParentId&&s.getParentId();return i},_cleanUpAllDomainResources:function(e,s){this._cleanUpConstantGroups(e.constantGroups,s),this._cleanUpTableReferences(e.tableReferences,s),this._cleanUpDataSources(e.dataSources,s),this._cleanCollectionByUsedResources(e.dataSourceGroups,s),this._cleanCollectionByUsedResources(e.tables,s),this._cleanCollectionByUsedResources(e.tableGroups,s),this._cleanCollectionByUsedResources(e.fields,s),this._cleanCollectionByUsedResources(e.joinAliases,s),this._cleanUpJoinTrees(e.joinTrees,s),this._cleanUpFilters(e.filters,s),this._cleanUpPresentationItems(e,s)},_cleanUpPresentationItems:function(e,s){e.dataIslands.fromArray([]),e.presentationFields.fromArray([]),e.presentationSets.fromArray([])},_cleanUpJoinTrees:function(e,s){var t=this;this._cleanCollectionByUsedResources(e,s),e.each(function(e){t._cleanUpCalcFieldsAndFiltersForSource(e,s)})},_cleanUpFilters:function(e,s){e.fromArray([])},_cleanUpDataSources:function(e,s){var t=this,n={};e.each(function(e){t._cleanUpResourceChildrenRecursive(s,e),e.getChildren().size()>0&&(n[e.getId()]=!0)},this),this._cleanCollectionByUsedResources(e,n)},_cleanUpTableReferences:function(e,s){var t=this;this._cleanCollectionByUsedResources(e,s),e.each(function(e){t._cleanUpCalcFieldsAndFiltersForSource(e,s)})},_cleanUpConstantGroups:function(e,s){var t=this,n={};e.each(function(e){var i=e.getCalcFields();t._cleanCollectionByUsedResources(e.getCalcFields(),s),i.size()>0&&(n[e.getId()]=!0)},[]),this._cleanCollectionByUsedResources(e,n)},_cleanCollectionByUsedResources:function(e,s){e.reduce(function(e,t){return s[t.getId()]||e.push(t.getId()),e},[]).forEach(function(s){e.removeById(s)})},_cleanUpResourceChildren:function(e,s){n.isFunction(s.getChildren)&&this._cleanCollectionByUsedResources(s.getChildren(),e)},_cleanUpResourceChildrenRecursive:function(e,s){var t=this;this._cleanUpResourceChildren(e,s),s.getChildren&&s.getChildren().each(function(s){t._cleanUpResourceChildrenRecursive(e,s)})},_createDataIsland:function(e,s,t){this.schemaModelConverter.parseDataIsland({dataIslandJson:{name:"DataIsland",label:"DataIsland",sourceId:s.getId(),sourceType:i.getEntityName(s),children:[{name:e.getName(),label:e.getName(),sourceId:s.getId(),sourceType:i.getEntityName(s),fieldId:e.getId(),fieldType:i.getEntityName(e),entityType:l.PRESENTATION_FIELD}]},collections:t})}}),t.exports=a});