/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../util/fileDownloader","../../../../../util/uuidGenerator","../../../../../rest/enum/mimeTypesEnum","../enum/tempSchemaResourceFileInfoEnum","../../../validation/state/enum/validationStateNameEnum","backbone"],function(e,t,a){var r=e("underscore"),n=e("../util/fileDownloader"),o=e("../../../../../util/uuidGenerator"),i=e("../../../../../rest/enum/mimeTypesEnum"),s=e("../enum/tempSchemaResourceFileInfoEnum"),m=e("../../../validation/state/enum/validationStateNameEnum"),c=e("backbone"),u=r.template(s.TEMP_SCHEMA_RESOURCE_NAME_TEMPLATE),l=function(e){this.clientDomainSchemaService=e.clientDomainSchemaService,this.applicationCrossComponentEventBus=e.applicationCrossComponentEventBus,this.resourcesService=e.resourcesService,this.serverSchemaModelSerializer=e.serverSchemaModelSerializer,this.validationStateFactory=e.validationStateFactory,this._initEvents()};r.extend(l.prototype,c.Events,{_initEvents:function(){this.listenTo(this.applicationCrossComponentEventBus,"schema:xml:download",this._onDownloadSchemaAsXml)},_onDownloadSchemaAsXml:function(){var e=this,t=this.clientDomainSchemaService.getDataStore(),a=this.serverSchemaModelSerializer.domainToJson(t).schema,r=this._generateTemporarySchemaResourceName();a.label=r,this._saveTemporarySchemaAsJson(a).then(function(){return e._getTemporarySchemaAsXml(r)}).then(function(t){e._downLoadSchema(t),e._removeTemporarySchema(r)}).fail(function(t){e.validationStateFactory.enter(m.DOWNLOAD_SCHEMA_VALIDATION_ERROR_STATE,{error:t})})},_generateTemporarySchemaResourceName:function(){return u({suffix:o.generate()})},_saveTemporarySchemaAsJson:function(e){return this.resourcesService.saveDomainSchemaAsJson(e,{uri:s.TEMP_FOLDER})},_getTemporarySchemaUrl:function(e){return s.TEMP_FOLDER+"/"+e},_getTemporarySchemaAsXml:function(e){var t=this._getTemporarySchemaUrl(e);return this.resourcesService.getResource(t,{dataType:"text",type:i.GENERIC_XML})},_downLoadSchema:function(e){n.download(e,"schema.xml")},_removeTemporarySchema:function(e){var t=this._getTemporarySchemaUrl(e);this.resourcesService.deleteResource(t)}}),a.exports=l});