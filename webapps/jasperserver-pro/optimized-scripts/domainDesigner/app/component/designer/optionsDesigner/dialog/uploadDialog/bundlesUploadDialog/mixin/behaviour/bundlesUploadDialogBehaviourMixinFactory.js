/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../../../../model/util/resourcePropertiesUtil"],function(e,r,o){function s(e){var r=e.store,o=e.resourcePropertiesChooserBehaviour,s=e.repositoryResourceChooserStateMutations,l=e.multipleFileUploadActions,a=e.multipleFileUploadStateMutations,n=e.localFileValidator,c=e.repositoryFileValidator;return{methods:{onPrimaryButtonClick:function(e){e.stopPropagation(),this.isRepositoryTab?this._addFilesFromRepositoryIfValid():this._addLocalFiles()},addFiles:function(e){var o=this,s=r.get("multipleFileUpload"),i=s.files;l.loadFilesWithContent(e).then(function(e){var s=o._validateFiles(e,i);s?(e=s.files,r.set("localFileLastErrorMessage",s.errorMessage),a.setPopoverErrorMessage(s.errorMessage)):r.set("localFileLastErrorMessage",""),a.addFiles(e)})},removeFile:function(e){var o=r.get("multipleFileUpload"),s=i.cloneDeep(o.files),t=r.get("localFileLastErrorMessage");s.splice(e,1),s=this._resetLocalFilesInvalidState(s);var l=this._validateFiles(s,[]);l?(s=l.files,r.set("localFileLastErrorMessage",l.errorMessage),this._showPopoverOnRemoveCurrentErrorIsDifferent(l.errorMessage,t)):(r.set("localFileLastErrorMessage",""),a.clearPopoverErrorMessage()),a.replaceFiles(s)},closerLocalFileErrorPopover:function(){a.clearPopoverErrorMessage()},closeResourceChooserErrorPopover:function(){o.methods.closeErrorPopover()},_validateFiles:function(e,r){var o=n.validate(e,r),s=[];if(o)return s=this._markLocalFilesInvalid(o.invalidFiles),{files:o.validFiles.concat(s),errorMessage:o.errorMessage}},_showPopoverOnRemoveCurrentErrorIsDifferent:function(e,r){e!==r?a.setPopoverErrorMessage(e):a.clearPopoverErrorMessage()},_addFilesFromRepositoryIfValid:function(){var e,o,t=r.get("repositoryResourceChooser"),l=t.repositoryTree,a=t.resourcesList,n=i.cloneDeep(l.selection),d=i.cloneDeep(a.selection);this.isRepositoryTreeMode?e=this._getSelectedNodesUri(n):this.isResourcesListMode&&(e=this._getSelectedNodesUri(d));var u=c.validate(e);u?(s.setPopoverErrorMessage(u.errorMessage),o=i.map(u.invalidFiles,function(e){return e.uri}),s.markCurrentModeNodesInvalid(o)):this.$emit("addFromRepository",e)},_addLocalFiles:function(){var e=r.get("multipleFileUpload"),o=i.cloneDeep(e.files);this.$emit("addLocalFiles",o)},_markLocalFilesInvalid:function(e){return i.map(e,function(e){return e.isInvalid=!0,e})},_resetLocalFilesInvalidState:function(e){return i.map(e,function(e){return delete e.isInvalid,e})},_getSelectedNodesUri:function(e){var r=i.map(e,function(e,r){return r});return i.sortBy(r,function(e){return t.parseFileNameFromUrl(e)})}}}}var i=e("underscore"),t=e("../../../../../../../../model/util/resourcePropertiesUtil");o.exports={create:s}});