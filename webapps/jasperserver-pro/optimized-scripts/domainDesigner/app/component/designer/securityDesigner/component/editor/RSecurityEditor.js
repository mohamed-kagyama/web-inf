/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","react","runtime_dependencies/js-sdk/src/common/util/base64","request","../../../../../dispatcher/enum/applicationStateEventsEnum","../../../../../model/enum/canvasViewDesignersEnum","../../../../../model/enum/subResourceTypesEnum","./react/RSecuritySourceEditor","./react/RModal","./securityXmlTemplate","bundle!CommonBundle","bundle!DomainDesignerBundle","../../../../../../rest/enum/endpointsEnum"],function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?c(e):t}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=e("react"),g=e("runtime_dependencies/js-sdk/src/common/util/base64"),y=e("request"),E=e("../../../../../dispatcher/enum/applicationStateEventsEnum"),f=e("../../../../../model/enum/canvasViewDesignersEnum"),j=e("../../../../../model/enum/subResourceTypesEnum"),b=e("./react/RSecuritySourceEditor"),S=e("./react/RModal"),R=e("./securityXmlTemplate"),h=e("bundle!CommonBundle"),F=e("bundle!DomainDesignerBundle"),C=e("../../../../../../rest/enum/endpointsEnum"),D=function(e){if(void 0!==F[e]){for(var t=F[e],n=0,r=arguments.length<=1?0:arguments.length-1;n<r;n+=1){var i=n+1<1||arguments.length<=n+1?void 0:arguments[n+1],o="\\{".concat(n,"\\}");t=t.replace(new RegExp(o,"g"),i)}return t}return e},I=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return n=l(this,(e=s(t)).call.apply(e,[this].concat(o))),p(c(n),"state",{secFile:null,referencedResourceContent:null,rulesDeleteWarningDialogVisible:!1,rulesReplaceWarningDialogVisible:!1,rulesImportWarningDialogVisible:!1,temporarySecurityFile:null}),p(c(n),"componentDidMount",function(){n.props.options.context.get("storeChangeEventBus").on("change",n.onSecurityFileChange),n.props.options.context.get("applicationDispatcherEventBus").on(E.SECURITY_DESIGNER_SHOW_REPLACE_FILE_CONFIRM_DIALOG,n.onImportSecurityFile)}),p(c(n),"onSecurityFileChange",function(e){var t=e.resourceProperties,r=t.securityFile;if(n.isSecurityDesignerVisible(e.viewState)){if(null!=r&&r.type===j.FILE_REFERENCE){r.uri.substring(0,r.uri.lastIndexOf("/"))==="".concat(t.uri,"_files")?r.type=j.FILE:y({url:C.RESOURCES_SERVICE+r.uri,type:"GET",dataType:"text"}).done(function(e){n.setState({referencedResourceContent:e})}).fail(function(){n.setState({referencedResourceContent:"An error has occurred while requesting the content of the referenced resource"})})}n.setState({secFile:r,referencedResourceContent:null})}else void 0!==r&&null!==r||n.setState({secFile:null,referencedResourceContent:null})}),p(c(n),"isSecurityDesignerVisible",function(e){return e.get("currentDesigner")===f.SECURITY_DESIGNER}),p(c(n),"onChange",function(e){if(!n.isReadOnly()){if(0===e.length)return void n.setState(function(e){if(void 0!==e.secFile&&null!==e.secFile){n.props.options.context.get("applicationDispatcherEventBus").trigger(E.OPTIONS_DESIGNER_REMOVE_SECURITY_FILE)}});var t=n.createBaseSecurityFileFromContent(e),r=E.OPTIONS_DESIGNER_ADD_SECURITY_FILE;n.setState(function(e){return void 0!==e.secFile&&null!==e.secFile&&(t.type=e.secFile.type,t.label=e.secFile.label,r=E.OPTIONS_DESIGNER_REPLACE_SECURITY_FILE),{secFile:t}},function(){n.props.options.context.get("applicationDispatcherEventBus").trigger(r,t)})}}),p(c(n),"onDownloadFile",function(){n.props.options.context.get("storeChangeEventBus").trigger("download:securityFile",n.state.secFile)}),p(c(n),"onClearSecurityFile",function(){n.setState({rulesDeleteWarningDialogVisible:!0})}),p(c(n),"onConfirmClearSecurityFile",function(){n.setState({rulesDeleteWarningDialogVisible:!1},function(){n.props.options.context.get("applicationDispatcherEventBus").trigger(E.OPTIONS_DESIGNER_REMOVE_SECURITY_FILE)})}),p(c(n),"onCancelClearSecurityFile",function(){n.setState({rulesDeleteWarningDialogVisible:!1})}),p(c(n),"onImportFile",function(){n.props.options.context.get("optionsDesignerEventBus").trigger("show:securityFileUploadDialog")}),p(c(n),"onInitSecurityFile",function(){n.isReadOnly()||n.getText().length>0?n.setState({rulesReplaceWarningDialogVisible:!0}):n.onConfirmReplaceSecurityFile()}),p(c(n),"onConfirmReplaceSecurityFile",function(){n.setState({rulesReplaceWarningDialogVisible:!1},function(){var e=n.createBaseSecurityFileFromContent(R);n.props.options.context.get("applicationDispatcherEventBus").trigger(E.OPTIONS_DESIGNER_REPLACE_SECURITY_FILE,e)})}),p(c(n),"onCancelReplaceSecurityFile",function(){n.setState({rulesReplaceWarningDialogVisible:!1})}),p(c(n),"onImportSecurityFile",function(e){if(n.isReferencedResource()||n.getText().length>0)n.setState({rulesImportWarningDialogVisible:!0,temporarySecurityFile:e});else{n.props.options.context.get("applicationDispatcherEventBus").trigger(E.OPTIONS_DESIGNER_ADD_SECURITY_FILE,e)}}),p(c(n),"onConfirmImportSecurityFile",function(){var e=n.state.temporarySecurityFile;n.setState({rulesImportWarningDialogVisible:!1,temporarySecurityFile:null},function(){n.props.options.context.get("applicationDispatcherEventBus").trigger(E.OPTIONS_DESIGNER_ADD_SECURITY_FILE,e)})}),p(c(n),"onCancelImportSecurityFile",function(){n.setState({rulesImportWarningDialogVisible:!1,temporarySecurityFile:null})}),p(c(n),"getTypeLabel",function(){var e=n.state.secFile;return void 0!==e&&null!==e&&e.type===j.FILE_REFERENCE?"Reference":"Local"}),p(c(n),"isReadOnly",function(){return n.isReferencedResource()}),p(c(n),"hasSecurityFile",function(){var e=n.state.secFile;return void 0!==e&&null!==e}),p(c(n),"isReferencedResource",function(){if(!n.hasSecurityFile())return!1;var e=n.state.secFile;return void 0!==e&&null!==e&&e.type===j.FILE_REFERENCE}),p(c(n),"getReferencedFileURI",function(){var e=n.state.secFile;return n.isReferencedResource()&&void 0!==e&&null!==e&&e.uri?e.uri:""}),p(c(n),"getText",function(){var e=n.state.secFile;if(void 0!==e&&null!==e){if(void 0!==e.content&&void 0!==e.content.raw)return e.content.raw;if(n.isReadOnly()&&null!==n.state.referencedResourceContent)return n.state.referencedResourceContent}return""}),p(c(n),"createBaseSecurityFileFromContent",function(e){return{content:{raw:e,base64:g.encode(e)},type:j.FILE,label:"security.xml"}}),p(c(n),"createModalContent",function(e,t,n,r,i,o){return d.createElement(d.Fragment,null,d.createElement("div",{className:"jr-mDialog-body jr-mDialog-bodyPadded jr"},d.createElement("div",{className:"jr-mValidation jr"},d.createElement("div",{className:"jr-mValidation-alert jr jr-mValidation-alertWarning"},d.createElement("span",{className:"jr-mValidation-alert-icon jr-mIcon jr-mIconSmall jr jr-cancelRound"}),d.createElement("span",{className:"jr-mValidation-alert-text jr"},e))),d.createElement("p",{className:"jr-mText jr-mTextMedium jr jr-uTop-double"},d.createElement("span",{className:"jr-mText-wrapper jr"},t))),d.createElement("div",{className:"jr-mDialog-footer jr"},d.createElement("button",{type:"button",className:"jr-mButton jr-mButtonText jr jr-mButtonPrimary jr-mButtonWarning",onClick:i},d.createElement("span",{className:"jr-mButton-label jr"},n)),d.createElement("button",{type:"button",className:"jr-mButton jr-mButtonText jr jr-mButtonSecondary",onClick:o},d.createElement("span",{className:"jr-mButton-label jr"},r))))}),n}return u(t,e),a(t,[{key:"render",value:function(){var e=this.getText();return d.createElement(d.Fragment,null,d.createElement("div",{className:"jr-mDomain-mode-title jr"},d.createElement("span",{className:"jr-mDomain-mode-title-text jr"},F["domain.designer.security.title"])),d.createElement("div",{className:"jr-mDomain-mode-subtitle jr-uBottom-doublehalf jr"},d.createElement("p",{className:"jr-mText jr-mTextParagraph jr-mTextGreyLight jr"},F["domain.designer.security.subtitle"])),d.createElement("div",{className:"jr-mGrid jr-mGrid2 jr"},d.createElement("div",{className:"jr-mGrid-column jr"},d.createElement("h2",{className:"jr-mText jr-mTextTitle jr-mTextSmall jr-uBottom-half jr"},d.createElement("span",{className:"jr-mText-wrapper jr"},this.isReferencedResource()?D("domain.designer.security.readonlyPath",this.getReferencedFileURI()):F["domain.designer.security.xmleditor"]))),d.createElement("div",{className:"jr-mGrid-column jr-uRightAlign jr","js-stdnav":"false"},d.createElement("button",{type:"button",className:"jr-mButton jr-mButtonAction jr jr-uLeft-quarter",title:F["domain.designer.security.button.insertCode.tooltip"],"aria-label":F["domain.designer.security.button.insertCode.tooltip"],onClick:this.onInitSecurityFile},d.createElement("span",{className:"jr-mButton-icon jr-mIcon jr-code jr"})),d.createElement("button",{type:"button",className:"jr-mButton jr-mButtonAction jr jr-uLeft-quarter",title:F["domain.designer.security.button.import.tooltip"],"aria-label":F["domain.designer.security.button.import.tooltip"],onClick:this.onImportFile},d.createElement("span",{className:"jr-mButton-icon jr-mIcon jr-import jr"})),d.createElement("button",{type:"button",disabled:0===this.getText().length&&!this.isReferencedResource(),className:"jr-mButton jr-mButtonAction jr jr-uLeft-quarter",title:F["domain.designer.security.button.download.tooltip"],"aria-label":F["domain.designer.security.button.download.tooltip"],onClick:this.onDownloadFile},d.createElement("span",{className:"jr-mButton-icon jr-mIcon jr-download jr"})),d.createElement("button",{id:"securityDesignerDeleteButton",type:"button",disabled:0===this.getText().length&&!this.isReadOnly(),className:"jr-mButton jr-mButtonAction jr jr-uLeft-quarter",title:F["domain.designer.security.button.delete.tooltip"],"aria-label":F["domain.designer.security.button.delete.tooltip"],onClick:this.onClearSecurityFile},d.createElement("span",{className:"jr-mButton-icon jr-mIcon jr-delete jr"})))),d.createElement("div",{className:"jr-mDomain-mode-editor jr",style:{opacity:this.isReadOnly()?.5:1}},d.createElement(b,{options:this.props.options,content:e,onChange:this.onChange,readOnly:this.isReadOnly()})),d.createElement(S,{open:this.state.rulesDeleteWarningDialogVisible},this.createModalContent(F["domain.designer.security.dialog.rulesDeleteWarning.message"],F["domain.designer.security.dialog.rulesDeleteWarning.description"],F["domain.designer.security.dialog.rulesDeleteWarning.button.deleteRules"],h["button.cancel"],this.onConfirmClearSecurityFile,this.onCancelClearSecurityFile)),d.createElement(S,{open:this.state.rulesReplaceWarningDialogVisible},this.createModalContent(F["domain.designer.security.dialog.rulesReplaceWarning.message"],F["domain.designer.security.dialog.rulesReplaceWarning.description"],F["domain.designer.security.dialog.rulesReplaceWarning.button.replaceRules"],h["button.cancel"],this.onConfirmReplaceSecurityFile,this.onCancelReplaceSecurityFile)),d.createElement(S,{open:this.state.rulesImportWarningDialogVisible},this.createModalContent(F["domain.designer.security.dialog.rulesReplaceWarning.message"],F["domain.designer.security.dialog.rulesImportWarning.description"],F["domain.designer.security.dialog.rulesReplaceWarning.button.replaceRules"],h["button.cancel"],this.onConfirmImportSecurityFile,this.onCancelImportSecurityFile)))}}]),t}(d.Component);n.exports=I});