/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","react","react-ace","underscore","ace-builds/src-min-noconflict/ace","ace-builds/src-min-noconflict/ext-language_tools","ace-builds/src-min-noconflict/theme-tomorrow","runtime_dependencies/js-sdk/src/common/util/xssUtil","ace-builds/src-min-noconflict/mode-xml"],function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?s(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=e("react"),d=e("react-ace"),h=d,g=e("underscore"),b=g.throttle,x=e("ace-builds/src-min-noconflict/ace");e("ace-builds/src-min-noconflict/ext-language_tools"),e("ace-builds/src-min-noconflict/theme-tomorrow");var A=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),E=x.require("ace/ext/language_tools"),y=function(e,t,n,r){e.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0});var o=x.require("ace/snippets"),i=o.snippetManager,c=i.parseSnippetFile(r,n);i.register(c,n)},G=function(e){return(Array.isArray(e)?e:[e]).map(function(e){var t=e.name,n=e.code;return["snippet ".concat(t),n.split("\n").map(function(e){return"\t".concat(e)}).join("\n")].join("\n")}).join("\n")},w=function(e){return A.softHtmlEscape(A.softHtmlEscape(e,{whiteList:["filterExpression","itemAccessGrant","itemAccessGrantList","itemAccessGrants","itemGroupAccessGrant","itemGroupAccessGrantList","itemGroupAccessGrants","itemGroupAccessGrants","principalExpression","principalExpression","resourceAccessGrant","resourceAccessGrantList","resourceAccessGrants","resourceAccessGrants","securityDefinition"]}))},v=function(t){function n(t){var r;return o(this,n),r=i(this,c(n).call(this,t)),f(s(r),"aceEditorRef",void 0),f(s(r),"isTestEnv",!1),f(s(r),"state",{content:"",committed:!0}),f(s(r),"componentDidMount",function(){var e={getCompletions:function(e,t,n,o,i){if(n.column>o.length){var c=e.getSession().getDocument().getLine(n.row),s=[];if(r.checkPreviousText("<",c,n,o)){s=["filterExpression","itemAccessGrant","itemAccessGrantList","itemAccessGrants","itemGroupAccessGrant","itemGroupAccessGrantList","itemGroupAccessGrants","itemGroupAccessGrants","principalExpression","principalExpression","resourceAccessGrant","resourceAccessGrantList","resourceAccessGrants","resourceAccessGrants","securityDefinition"].filter(function(e){return e.toLowerCase().startsWith(o.toLowerCase())}).map(function(e){return{name:e,value:e,score:1,meta:"tag"}})}else if(r.checkPreviousText('resourceId="',c,n,o)){var a=[];r.props.options.context._container.schemaDataStore.collections.joinTrees.each(function(e){return a.push(e.name)}),s=a.filter(function(e){return e.toLowerCase().startsWith(o.toLowerCase())}).map(function(e){return{name:e,value:e,score:1,meta:"join"}})}return void i(null,s)}i(null,[])}};E.setCompleters([e,E.snippetCompleter]),r.aceEditorRef.current&&(y(r.aceEditorRef.current.editor,r.aceEditorRef.current.editor.getSession(),"xml",G([{name:"Resource Access Grant",code:'\x3c!-- \naRuleId - A unique identifier\naPrincipalExpression - an conditional expression to check if the filter needs to be applied\naFilterExpression - a condition to filter your data\n--\x3e\n<resourceAccessGrant id="${1:aRuleId}">\n    <principalExpression>${2:aPrincipalExpression}</principalExpression>\n    <filterExpression>${0:aFilterExpression}</filterExpression>\n</resourceAccessGrant>'},{name:"Item Group Access Grant",code:'\x3c!-- \naRuleId - A unique identifier\naPrincipalExpression - an conditional expression to check if the specified access type will be applied to the column\n--\x3e\n<itemGroupAccessGrant id="${1:aRuleId}" access="granted">\n    <principalExpression>${0:aPrincipalExpression}</principalExpression>\n</itemGroupAccessGrant>'},{name:"PE: Test user role",code:"authentication.getPrincipal().getRoles().any{it.getRoleName() in ['${1:ROLE_A}','${0:ROLE_B}'] }"},{name:"PE: Test user attribute",code:"authentication.getPrincipal().getAttributes().any{ it.getAttrName() in ['${1:Attribute_A}','${0:Attribute_B}'] }"},{name:"PE: Test user organization",code:"authentication.principal.tenantId == '${1:Organization_1}'"}])),r.aceEditorRef.current.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}))}),f(s(r),"onChange",function(e,t){r.setState({content:e,committed:!1},function(){return r.onChangeThrottle()})}),f(s(r),"onChangeThrottle",b(function(){r.state.committed||(r.props.onChange&&r.props.onChange(r.state.content),r.setState({committed:!0}))},1e3,{leading:!1})),f(s(r),"checkPreviousText",function(e,t,n,r){if(e.length<=n.column-r.length){if(t.substring(n.column-e.length-r.length,n.column-r.length).toLowerCase()===e.toLowerCase())return!0}return!1}),f(s(r),"onBlur",function(){if(r.state.content!==r.props.content||!r.state.committed){var e=r.state.content,t=w(e);r.setState({committed:!0},function(){e===t&&t===r.props.content||!r.props.onChange||r.props.onChange(t)})}}),r.aceEditorRef=m.createRef(),void 0!==window.require&&void 0!==window.require.toUrl?(x.config.set("workerPath",window.require.toUrl("ace-builds/src-min-noconflict")),x.config.set("modePath",window.require.toUrl("ace-builds/src-min-noconflict")),x.config.set("themePath",window.require.toUrl("ace-builds/src-min-noconflict")),x.config.set("basePath",window.require.toUrl("ace-builds/src-min-noconflict")),x.config.setModuleUrl("ace/mode/xml",e("ace-builds/src-min-noconflict/mode-xml"))):r.isTestEnv=!0,r}return l(n,t),u(n,null,[{key:"getDerivedStateFromProps",value:function(e,t){return t.committed?{content:e.content,committed:!0}:{}}}]),u(n,[{key:"render",value:function(){return this.isTestEnv?m.createElement("div",null):m.createElement(h.default,{ref:this.aceEditorRef,mode:"xml",theme:"tomorrow",highlightActiveLine:!0,showPrintMargin:!1,width:"100%",height:"100%",value:this.state.content,onChange:this.onChange,onBlur:this.onBlur,readOnly:this.props.readOnly})}}]),n}(m.Component);n.exports=v});