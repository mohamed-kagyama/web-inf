/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","./util/unwrapMetadataUtil","../../../../../model/util/serverSchemaResourceTypeUtil","../../../../../../model/schema/util/getCollectionByEntityType"],function(e,t,r){var a=e("underscore"),i=e("jquery"),o=e("./util/unwrapMetadataUtil"),n=e("../../../../../model/util/serverSchemaResourceTypeUtil"),c=e("../../../../../../model/schema/util/getCollectionByEntityType"),u=function(e){this.initialize(e)};a.extend(u.prototype,{initialize:function(e){this.convertToTreeItem=e.convertToTreeItem,this.metadataService=e.metadataService,this.sort=e.sort||a.identity,this.match=e.match},getData:function(e){var t=this,r=e.dataSourceUri,a=e.metadataResourcePath,n=new i.Deferred,c=a.length>0?[a]:a;return this.metadataService.getMetadata(r,c).then(function(r){r=o.unwrap(r,e);var a=t._convertMetadataToTreeItems(r,e),i=t.sort(a),c=i.length;n.resolve({data:i,total:c})}).fail(function(){n.resolve({data:[],total:0})}),n.promise()},_convertMetadataToTreeItems:function(e,t){var r=t.selection,i=t.highlightInvalidResources,o=t.currentMetadataResourceId;if(a.isEmpty(e))return e;var n=this._getMetadataResourceType(e),c=this._getCollectionByResourceType(n,t);return a.chain(e).filter(function(e){return this.match(e.group,{collection:c,currentMetadataResourceId:o})},this).map(function(e){return this.convertToTreeItem(e,{selection:r,highlightInvalidResources:i})},this).value()},_getCollectionByResourceType:function(e,t){return c(t.dataStore,e)},_getMetadataResourceType:function(e){var t=a.first(e);return n.getMetadataResourceType(t)}}),r.exports=u});