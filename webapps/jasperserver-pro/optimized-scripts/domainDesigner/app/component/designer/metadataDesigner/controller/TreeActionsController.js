/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../../../model/enum/resourceTypeEnum","./predicate/resourcesWithChildrenPredicate","../../../../model/enum/defaultSchemaNameEnum","../../../../../model/schema/util/entityUtil"],function(e,t,r){var a=e("underscore"),s=e("backbone"),i=e("../../../../model/enum/resourceTypeEnum"),c=e("./predicate/resourcesWithChildrenPredicate"),o=e("../../../../model/enum/defaultSchemaNameEnum"),n=e("../../../../../model/schema/util/entityUtil"),u=function(e){this.sourceTree=e.sourceTree,this.sourceTreeDataProvider=e.sourceTreeDataProvider,this.resultTree=e.resultTree,this.resultTreeDataProvider=e.resultTreeDataProvider,this.metadataDesignerEventBus=e.metadataDesignerEventBus,this.storeChangeEventBus=e.storeChangeEventBus,this.model=e.model||new s.Model,this.clientResourcePropertiesService=e.clientResourcePropertiesService,this.clientDomainSchemaMetadataService=e.clientDomainSchemaMetadataService,this.metadataDesignerViewStateModelService=e.metadataDesignerViewStateModelService,this.metadataDesignerResourcesParentIdProvider=e.metadataDesignerResourcesParentIdProvider,this.addFetchedResourcesToSchemaStrategy=e.addFetchedResourcesToSchemaStrategy,this.metadataFetchStrategy=e.metadataFetchStrategy,this.metadataDesignerRemoveSelectedResourcesStrategy=e.metadataDesignerRemoveSelectedResourcesStrategy,this.metadataDesignerRemoveDefaultSchemaChildrenAndSelectedResourcesStrategy=e.metadataDesignerRemoveDefaultSchemaChildrenAndSelectedResourcesStrategy,this._initEvents()};a.extend(u.prototype,s.Events,{_initEvents:function(){this.listenTo(this.storeChangeEventBus,"change",this._setViewModelState),this.listenTo(this.metadataDesignerEventBus,"sourceList:drop",this._getTreeSelectionAndRemoveMetadataResourcesFromSchema),this.listenTo(this.metadataDesignerEventBus,"resultList:drop",this._getTreeSelectionAndAddMetadataResourcesToSchema),this.listenTo(this.sourceTree,"item:dblclick",this._getTreeSelectionAndAddMetadataResourcesToSchema),this.listenTo(this.resultTree,"item:dblclick",this._getTreeSelectionAndRemoveMetadataResourcesFromSchema),this.listenTo(this.metadataDesignerEventBus,"moveToSource",this._getTreeSelectionAndRemoveMetadataResourcesFromSchema),this.listenTo(this.metadataDesignerEventBus,"moveToResult",this._getTreeSelectionAndAddMetadataResourcesToSchema)},_setViewModelState:function(e){var t=this.metadataDesignerViewStateModelService.getCurrentSidebarResource(),r=this.clientDomainSchemaMetadataService.getDataSourceByChildResource(t.resourceId,t.type),a=this.clientDomainSchemaMetadataService.getResourcePath(t.resourceId,t.type),s=this.clientResourcePropertiesService.getDataSourceUri(r.name),i=e.viewState.getDataSource(r.name).type;this.model.set({currentMetadataResourceId:t.resourceId,currentDataSourceId:r.id,currentMetadataResourcePath:a,currentDataSourceUri:s,currentDataSourceType:i})},_getTreeSelectionAndAddMetadataResourcesToSchema:function(){var e=this;this.sourceTreeDataProvider.getSelectedResources().then(function(t){e._onAddMetadataResourcesToSchema(t)})},_getTreeSelectionAndRemoveMetadataResourcesFromSchema:function(){var e=this.resultTreeDataProvider.getSelectedResources();this._removeMetadataResourcesFromSchema(e)},_removeMetadataResourcesFromSchema:function(e){if(0!==a.size(e)){var t=this._getMetadataResourcesType(e);this._isDefaultSchemaBeingDeleted({type:t,resources:e})?this.metadataDesignerRemoveDefaultSchemaChildrenAndSelectedResourcesStrategy.execute(e):this.metadataDesignerRemoveSelectedResourcesStrategy.execute({type:t,resources:e})}},_onAddMetadataResourcesToSchema:function(e){if(0!==a.size(e)){var t=this._getMetadataResourcesType(e),r=this.metadataDesignerResourcesParentIdProvider.getParentId(),s=this;this._fetchSubResources(e,t).then(function(e){var a=s.model.toJSON();return{fetchedResources:e,metadataResourcesType:t,parentId:r,dataSourceId:a.currentDataSourceId,dataSourceType:a.currentDataSourceType}}).then(function(t){var r=s._getExistingResources(t,e),i=r.length!==e.length,c=s._getResourcesWithChildren({existingResources:r,metadataResourcesType:t.metadataResourcesType}),o=c.length!==r.length;i||o?s.metadataDesignerEventBus.trigger("fetchSubResource:invalidResources",a.extend({selectedResources:e},t,{resourcesWithChildren:c,someResourcesAreMissing:i,someResourcesAreChildLess:o})):s.addFetchedResourcesToSchemaStrategy.execute(t)}).fail(function(r){s.metadataDesignerEventBus.trigger("fetchSubResource:fail",{xhr:r,selectedResources:e,metadataResourcesType:t})})}},_getResourcesWithChildren:function(e){var t=e.existingResources,r=e.metadataResourcesType;return n.isDataSourceGroup(r)?t:a.filter(t,c)},_getExistingResources:function(e,t){var r=t.reduce(function(e,t){return e[t.name]=!0,e},{});return e.fetchedResources.filter(function(e){return r[e[i.resources.groups.GROUP].name]})},_fetchSubResources:function(e,t){return this.metadataFetchStrategy.fetch({resources:e,resourceType:t,parentId:this.model.get("currentMetadataResourceId"),parentPath:this.model.get("currentMetadataResourcePath"),dataSourceUri:this.model.get("currentDataSourceUri"),dataSourceId:this.model.get("currentDataSourceId")})},_getMetadataResourcesType:function(e){return a.first(e).type},_isDefaultSchemaBeingDeleted:function(e){var t=e.type,r=e.resources;return n.isDataSourceGroup(t)&&a.find(r,function(e){return e.name===o.DEFAULT_SCHEMA})}}),r.exports=u});