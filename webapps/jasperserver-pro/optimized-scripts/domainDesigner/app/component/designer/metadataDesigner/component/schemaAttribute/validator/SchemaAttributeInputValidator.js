/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","bundle!DomainDesignerBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../../../../../../../model/util/profileAttributeUtil"],function(e,t,r){var i=e("jquery"),n=e("underscore"),c=e("bundle!DomainDesignerBundle"),a=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),o=e("../../../../../../../model/util/profileAttributeUtil"),u=a.create(c),s=function(e){this.initialize(e)};n.extend(s.prototype,{initialize:function(e){this.domainSchemaSpecification=e.domainSchemaSpecification,this.metadataService=e.metadataService,this.profileAttributesService=e.profileAttributesService,this.clientResourcePropertiesService=e.clientResourcePropertiesService,this.metadataDesignerErrorByXhrFactory=e.metadataDesignerErrorByXhrFactory},validate:function(e){var t=this;return this._checkIfAttributeNotation(e).then(function(){return t._checkIfDuplicateExists(e)}).then(function(){return t._checkIfAttributeExists(e)}).then(function(r){return t._checkIfSchemaExists(e).then(function(){return r})}).then(null,function(e){return(new i.Deferred).reject(e||"")})},_checkIfAttributeNotation:function(e){var t=new i.Deferred;return o.containsProfileAttributeWithPlaceholdersOnly(e.attribute)?t.resolve():t.reject(u("domain.validation.schemaAttributeDoesNotMatchRegExp"))},_checkIfAttributeExists:function(e){var t=this,r=o.extractProfileAttributeArgs(e.attribute),n=r[0],c=r[1]||!1;return this.profileAttributesService.getProfileAttributes({name:n,level:c},{refresh:!0}).then(function(e){return e[0]},function(e){return(new i.Deferred).reject(t.metadataDesignerErrorByXhrFactory.create(e))})},_checkIfSchemaExists:function(e){var t=this,r=this.clientResourcePropertiesService.getDataSourceName(),c=this.clientResourcePropertiesService.getDataSourceUri(r);return this.metadataService.getMetadata(c,[[e.attribute]]).then(function(e){return n.isUndefined(e)?(new i.Deferred).reject(u("profile.attribute.exception.schema.does.not.exist")):e},function(e){return(new i.Deferred).reject(t.metadataDesignerErrorByXhrFactory.create(e))})},_checkIfDuplicateExists:function(e){var t=new i.Deferred,r=!0;return r=e.dataSourceGroupId?this.domainSchemaSpecification.canUpdateDataSourceGroup(e.dataSourceGroupId,e.attribute):this.domainSchemaSpecification.canCreateDataSourceGroup(e.attribute,e.parentId),r?t.resolve():t.reject(u("domain.validation.schemaAttributeAlreadyExists"))}}),r.exports=s});