/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../../../../../rest/enum/requestCanceledEnum","../../../../../../../model/util/profileAttributeUtil","../../../../../../model/util/resourceNameSpecialCharactersUtil","../../../../../../model/enum/dataSourceTypeEnum","../../../../../../../model/schema/util/entityUtil","../../../../../../dispatcher/enum/applicationStateEventsEnum"],function(t,e,i){var a=t("underscore"),r=t("backbone"),n=t("../../../../../../rest/enum/requestCanceledEnum"),u=t("../../../../../../../model/util/profileAttributeUtil"),s=t("../../../../../../model/util/resourceNameSpecialCharactersUtil"),o=t("../../../../../../model/enum/dataSourceTypeEnum"),c=t("../../../../../../../model/schema/util/entityUtil"),h=t("../../../../../../dispatcher/enum/applicationStateEventsEnum"),m=function(t){this.initialize(t)};a.extend(m.prototype,r.Events,{initialize:function(t){a.bindAll(this,"_handleValidationFailure"),this.schemaAttributeInputStore=t.metadataDesignerVueStore.get("schemaAttributeInput"),this.applicationDispatcherEventBus=t.applicationDispatcherEventBus,this.storeChangeEventBus=t.storeChangeEventBus,this.metadataDesignerEventBus=t.metadataDesignerEventBus,this.schemaAttributeInputValidator=t.schemaAttributeInputValidator,this.clientDomainSchemaService=t.clientDomainSchemaService,this.schemasNameGenerator=t.schemasNameGenerator,this.metadataDesignerViewStateModelService=t.metadataDesignerViewStateModelService,this._initEvents()},_initEvents:function(){this.listenTo(this.storeChangeEventBus,"change",this._renderFromState),this.listenTo(this.metadataDesignerEventBus,"input:attribute",this._onInputAttribute),this.listenTo(this.metadataDesignerEventBus,"add:attribute",this._onAddAttribute),this.listenTo(this.metadataDesignerEventBus,"update:attribute",this._onUpdateAttribute),this.listenTo(this.metadataDesignerEventBus,"cancel:attribute",this._onCancelUpdateAttribute)},_onInputAttribute:function(t){this.schemaAttributeInputStore.attribute=t.trim(),this.schemaAttributeInputStore.error=""},_onAddAttribute:function(){var t=this,e=a.clone(this.schemaAttributeInputStore);this.schemaAttributeInputValidator.validate(e).then(function(){t._addSchemaAttribute()},this._handleValidationFailure)},_onUpdateAttribute:function(){var t=this,e=a.clone(this.schemaAttributeInputStore);this.schemaAttributeInputValidator.validate(e).then(function(){t._updateSchemaAttribute()},this._handleValidationFailure)},_handleValidationFailure:function(t){t!==n.CANCELED&&(this.schemaAttributeInputStore.error=t)},_onCancelUpdateAttribute:function(){this.applicationDispatcherEventBus.trigger(h.METADATA_DESIGNER_CANCEL_SCHEMA_ATTRIBUTE)},_addSchemaAttribute:function(){var t=this.schemaAttributeInputStore.attribute,e=this.schemaAttributeInputStore.parentId,i=this._createDataSourceGroupDTO(t);this.applicationDispatcherEventBus.trigger(h.METADATA_DESIGNER_ADD_SCHEMA_ATTRIBUTE,{dataSourceGroup:i,parentId:e})},_updateSchemaAttribute:function(){var t=this.schemaAttributeInputStore.attribute,e=a.extend(this._createDataSourceGroupDTO(t),{id:this.schemaAttributeInputStore.dataSourceGroupId});this.applicationDispatcherEventBus.trigger(h.METADATA_DESIGNER_UPDATE_SCHEMA_ATTRIBUTE,e)},_createDataSourceGroupDTO:function(t){this.schemasNameGenerator.reset();var e=this,i=s.replaceResourceNameSpecialCharacters(t);return i=this.schemasNameGenerator.generate(i,function(t){return e.clientDomainSchemaService.getDataSourceGroupByName(t)}),{name:i,sourceName:t}},_getCurrentResourceId:function(){var t=this.metadataDesignerViewStateModelService.getCurrentSidebarResource();return t&&t.resourceId},_renderFromState:function(){if(this._resetSchemaAttributeModel(),this.schemaAttributeInputStore.isVisible=this._isSchemaAttributeInputVisible(),this.schemaAttributeInputStore.parentId=this._getCurrentResourceId(),this.schemaAttributeInputStore.isVisible){var t,e,i,a=this.metadataDesignerViewStateModelService.getResultTreeSelection();1===a.length&&(t=a[0],e=this.clientDomainSchemaService.getDataSourceGroupByName(t),i=e.sourceName&&u.containsProfileAttribute(e.sourceName)),i&&(this.schemaAttributeInputStore.dataSourceGroupId=e&&e.id,this.schemaAttributeInputStore.attribute=e.sourceName,this.schemaAttributeInputStore.error="")}},_isSchemaAttributeInputVisible:function(){var t,e,i,a,r=this.metadataDesignerViewStateModelService.getCurrentSidebarResource(),n=r&&r.type,u=c.isDataSource(n);return u&&(t=this.clientDomainSchemaService.getDataSourceById(r.resourceId),e=this.metadataDesignerViewStateModelService.getDataSourceByName(t.name),i=e&&e.type,a=i===o.DATA_SOURCE_WITH_SCHEMAS),u&&a},_resetSchemaAttributeModel:function(){this.schemaAttributeInputStore.attribute="",this.schemaAttributeInputStore.dataSourceGroupId="",this.schemaAttributeInputStore.error="",this.schemaAttributeInputStore.parentId=""}}),i.exports=m});