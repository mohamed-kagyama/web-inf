/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/enum/dataSourceMetadataTypesEnum","../../../../../model/schema/enum/schemaEntitiesEnum","../../../../model/util/resourceNameSpecialCharactersUtil"],function(e,a,n){var r=e("underscore"),t=e("../../../../../model/schema/enum/dataSourceMetadataTypesEnum"),s=e("../../../../../model/schema/enum/schemaEntitiesEnum"),i=e("../../../../model/util/resourceNameSpecialCharactersUtil"),c=r.values(t),m=function(e){this.initialize(e)};r.extend(m.prototype,{initialize:function(e){this.schemasNameGenerator=e.schemasNameGenerator,this.tableReferenceNameGenerator=e.tableReferenceNameGenerator,this.fieldsNameGenerator=e.fieldsNameGenerator,this.clientDomainSchemaService=e.clientDomainSchemaService},toSchemasDTO:function(e){this.schemasNameGenerator.reset();var a=this,n=e.parentId,t=e.dataSourceId,s=e.resources;return r.reduce(s,function(e,r){if(r){r=r.group;var s={name:r.name,parentId:n,dataSourceId:t};i.isResourceNameContainsSpecialCharacters(r.name)&&(s.sourceName=r.name,s.name=a._generateSchemaName(r.name,e.namesInUse),e.namesInUse.push(s.name)),e.schemas.push(s)}return e},{schemas:[],namesInUse:[]}).schemas},toTablesAndReferencesDTO:function(e){this.tableReferenceNameGenerator.reset();var a=e.resources;return r.reduce(a,function(a,n){if(n){n=n.group;var r=this._tableToDTO(n,e),t=this._getTableReferenceDTO(r.name,a.namesInUse);a.tablesAndReferences.push({table:r,reference:t}),a.namesInUse.push(t.name)}return a},{tablesAndReferences:[],namesInUse:[]},this).tablesAndReferences},toTableChildrenDTO:function(e){return r.reduce(e,function(e,a){var n;return a.group?n=this._toTableGroupDTO(a.group):a.element&&(n=this._toFieldDTO(a.element,e.namesInUse)),n&&(e.children.push(n),e.namesInUse.push(n.name)),e},{children:[],namesInUse:[]},this).children},_tableToDTO:function(e,a){return{parentId:a.parentId,dataSourceId:a.dataSourceId,name:e.name,children:this.toTableChildrenDTO(e.elements)}},_getTableReferenceDTO:function(e,a){var n=e,r={name:n};return r.name=this._generateTableReferenceName(n,a),r},_toTableGroupDTO:function(e){return{name:e.name,entityType:s.TABLE_GROUP,children:this.toTableChildrenDTO(e.elements)}},_toFieldDTO:function(e,a){if(this.fieldsNameGenerator.reset(),!(r.indexOf(c,e.type)<0)){var n={name:e.name,type:e.type,entityType:s.FIELD};return i.isResourceNameContainsSpecialCharacters(e.name)&&(n.sourceName=e.name,n.name=this._generateFieldName(e.name,a)),n}},_generateSchemaName:function(e,a){var n=this,t=i.replaceResourceNameSpecialCharacters(e);return this.schemasNameGenerator.generate(t,function(e){return r.indexOf(a,e)>-1||n.clientDomainSchemaService.getDataSourceGroupByName(e)})},_generateTableReferenceName:function(e,a){var n=this,t=i.replaceResourceNameSpecialCharacters(e);return this.tableReferenceNameGenerator.generate(t,function(e){return r.indexOf(a,e)>-1||n.clientDomainSchemaService.getTableReferenceByName(e)})},_generateFieldName:function(e,a){var n=this,t=i.replaceResourceNameSpecialCharacters(e);return this.fieldsNameGenerator.generate(t,function(e){return r.indexOf(a,e)>-1||n.clientDomainSchemaService.getFieldByName(e)})}}),n.exports=m});