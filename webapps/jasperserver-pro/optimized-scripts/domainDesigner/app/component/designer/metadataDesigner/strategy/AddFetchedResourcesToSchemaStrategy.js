/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/util/entityUtil"],function(e,t,r){var a=e("underscore"),o=e("../../../../../model/schema/util/entityUtil"),s=function(e){this.initialize(e)};a.extend(s.prototype,{initialize:function(e){a.bindAll(this,"execute"),this.metadataToDTOConverter=e.metadataToDTOConverter,this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.metadataDesignerDispatcherActionNameProvider=e.metadataDesignerDispatcherActionNameProvider},execute:function(e){var t=e.metadataResourcesType,r=e.parentId,a=this.metadataDesignerDispatcherActionNameProvider.getAddEventByResourceType(t),s=e.selectedResources||[],i=this._convertFetchedResourcesToDTO(e),n=o.isDataSourceGroup(t),c=o.isTable(t),d=this._getResultTreeSelection({areDataSourceGroupBeingAdded:n,areTablesBeingAdded:c,resourcesToAdd:i}),u=this._getSourceTreeSelection({areDataSourceGroupBeingAdded:n,areTablesBeingAdded:c,selectedResources:s,resourcesToAdd:i});this.applicationDispatcherEventBus.trigger(a,{resources:i,parentId:r,sourceTreeSelection:u||[],resultTreeSelection:d||[],addResourcesError:{popoverMessage:e.popoverMessage||"",highlightInvalidResources:e.highlightInvalidResources||!1}})},_convertFetchedResourcesToDTO:function(e){var t=e.metadataResourcesType,r={resources:e.fetchedResources,parentId:e.parentId,dataSourceId:e.dataSourceId};return o.isDataSourceGroup(t)?this.metadataToDTOConverter.toSchemasDTO(r):o.isTable(t)?this.metadataToDTOConverter.toTablesAndReferencesDTO(r):void 0},_getSourceTreeSelection:function(e){var t=e.selectedResources,r=e.resourcesToAdd,o=e.areTablesBeingAdded,s=e.areDataSourceGroupBeingAdded,i=[];return o&&(i=a.map(r,function(e){return e.table.sourceName||e.table.name})),s&&(i=a.map(r,function(e){return e.sourceName||e.name})),a.reduce(t,function(e,t){return-1===a.indexOf(i,t.name)&&e.push(t.name),e},[])},_getResultTreeSelection:function(e){var t=e.resourcesToAdd,r=e.areTablesBeingAdded,o=e.areDataSourceGroupBeingAdded,s=[];return r&&(s=a.map(t,function(e){return e.table.name})),o&&(s=a.map(t,function(e){return e.name})),s}}),r.exports=s});