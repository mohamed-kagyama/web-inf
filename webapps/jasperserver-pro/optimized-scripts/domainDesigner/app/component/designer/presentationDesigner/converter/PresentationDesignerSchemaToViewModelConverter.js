/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/util/entityUtil","../util/presentationDesignerDataIslandComponentsVisibilityUtil","../../../../model/enum/presentationFieldsAggregationsEnum","../../../../../model/schema/enum/fieldTypesToGenericTypesEnum","../../../../model/enum/genericTypeToMeasureOrDimensionEnum","../../../../model/enum/genericTypeToMasksEnum","../../../../../model/schema/enum/schemaEntitiesEnum"],function(e,t,n){var i=e("underscore"),s=e("../../../../../model/schema/util/entityUtil"),a=e("../util/presentationDesignerDataIslandComponentsVisibilityUtil"),r=e("../../../../model/enum/presentationFieldsAggregationsEnum"),d=e("../../../../../model/schema/enum/fieldTypesToGenericTypesEnum"),o=e("../../../../model/enum/genericTypeToMeasureOrDimensionEnum"),l=e("../../../../model/enum/genericTypeToMasksEnum"),c=e("../../../../../model/schema/enum/schemaEntitiesEnum"),h=function(e){this.settings=e.settings,this.clientDomainSchemaService=e.clientDomainSchemaService,this.presentationDesignerViewStateModelService=e.presentationDesignerViewStateModelService,this.presentationDesignerDropZoneActivatorFactory=e.presentationDesignerDropZoneActivatorFactory};i.extend(h.prototype,{convert:function(e){return this._convertDataIslands(e)},_convertDataIslands:function(e){var t,n,s=e.dataStore,a=s.dataIslands,r=this,d=this.presentationDesignerViewStateModelService.getPresentationDesignerCanvasSearchKeyword(),o=this.presentationDesignerViewStateModelService.getCellsWidth(),l=this.presentationDesignerViewStateModelService.getPresentationDesignerColumnSet(),c=a.reduce(function(e,t,i){var a=r._convertDataIsland({dataIsland:t,index:i,searchKeyword:d,cellsWidth:o,columnSet:l,collections:s});return e=e.concat(a),n=i,e},[]),h=i.last(c);return h&&(h.dropZoneActivators.bottom=null,t=this._getLastRow(h,n)),c.concat(t||[])},_getHeight:function(e){return e?this.settings.height.EXPANDED_ITEM:this.settings.height.COLLAPSED_ITEM},_convertDataIsland:function(e){var t=e.dataIsland,n=t.getId(),s=e.searchKeyword,r=e.cellsWidth,d=e.columnSet,o=e.collections,l=[],h=this.presentationDesignerViewStateModelService.isPresentationItemSelected({id:t.getId()}),p=this.presentationDesignerViewStateModelService.isDataIslandExpanded(t.getId()),g=this.presentationDesignerViewStateModelService.isDataIslandPropertiesEditorExpanded(t.getId()),I=i.extend({index:e.index,modelType:c.DATA_ISLAND,isExpanded:p,isPropertiesEditorExpanded:g,columnSet:d,nestingLevel:1,isSelected:h,parentId:"",dataIslandId:"",height:this._getHeight(g)},t.toJSON(),r),m=a.isDataIslandVisible(s,I);I.dropZoneActivators=this.presentationDesignerDropZoneActivatorFactory.create(I);var u=this._convertPresentationItemChildren({children:t.getChildren(),nestingLevel:2,searchKeyword:s,isParentVisible:m,parentId:n,isParentExpanded:I.isExpanded,dataIslandId:n,cellsWidth:r,columnSet:d,collections:o});return(m||i.size(u)>0)&&l.push(I),p&&(l=l.concat(u)),l},_convertPresentationItemChildren:function(e){var t=e.children,n=this,a={nestingLevel:e.nestingLevel,searchKeyword:e.searchKeyword,isParentVisible:e.isParentVisible,parentId:e.parentId,dataIslandId:e.dataIslandId,cellsWidth:e.cellsWidth,columnSet:e.columnSet,collections:e.collections};return t.reduce(function(e,t,r){var d=[];return s.isPresentationSet(t)?d=n._convertPresentationSet(i.extend(a,{index:r,presentationSet:t})):s.isPresentationField(t)&&(d=n._convertPresentationField(i.extend(a,{index:r,presentationField:t}))),e=e.concat(d)},[])},_convertPresentationSet:function(e){var t=e.presentationSet,n=e.nestingLevel,s=e.searchKeyword,r=e.isParentVisible,d=e.parentId,o=e.dataIslandId,l=e.collections,h=e.cellsWidth,p=e.columnSet,g=[],I=this.presentationDesignerViewStateModelService.isPresentationItemSelected({id:t.getId()}),m=this.presentationDesignerViewStateModelService.isPresentationSetExpanded(t.getId()),u=this.presentationDesignerViewStateModelService.isPresentationSetPropertiesEditorExpanded(t.getId()),S=i.extend({index:e.index,nestingLevel:n,parentId:d,modelType:c.PRESENTATION_SET,dataIslandId:o,isExpanded:m,isPropertiesEditorExpanded:u,columnSet:p,isSelected:I,height:this._getHeight(u)},t.toJSON(),h);r=r||a.isPresentationSetVisible(s,S),S.dropZoneActivators=this.presentationDesignerDropZoneActivatorFactory.create(S);var v=this._convertPresentationItemChildren({children:t.getChildren(),nestingLevel:n+1,searchKeyword:s,isParentVisible:r,parentId:S.id,isParentExpanded:S.isExpanded,dataIslandId:o,cellsWidth:h,columnSet:p,collections:l});return(r||i.size(v)>0)&&g.push(S),m&&(g=g.concat(v)),g},_convertPresentationField:function(e){var t=e.collections,n=e.nestingLevel,s=e.presentationField,h=t.fields.byId(s.getFieldId()),p=h.type,g=d[p],I=e.searchKeyword,m=e.isParentVisible,u=e.parentId,S=e.dataIslandId,v=e.cellsWidth,D=l[g],E=i.defaults(s.toJSON(),{aggregation:r[g].defaults.value,kind:o[g]});D&&(E=i.defaults(E,{mask:D.defaults.value}));var P=this.presentationDesignerViewStateModelService.isPresentationFieldPropertiesEditorExpanded(s.getId()),x=i.extend({nestingLevel:n,index:e.index,parentId:u,modelType:c.PRESENTATION_FIELD,dataIslandId:S,valueType:g,isPropertiesEditorExpanded:P,columnSet:this.presentationDesignerViewStateModelService.getPresentationDesignerColumnSet(),height:this._getHeight(P)},E,v);x.isSelected=this.presentationDesignerViewStateModelService.isPresentationItemSelected(x);var y=m||a.isPresentationFieldVisible(I,x);return x.dropZoneActivators=this.presentationDesignerDropZoneActivatorFactory.create(x),y?[x]:[]},_getLastRow:function(e,t){var n=e.id,i=!e.dataIslandId,a=i&&this.clientDomainSchemaService.isConstantDataIsland(n);return{lastItemIndex:e.index+1,lastDataIslandIndex:t+1,isOwnerLeaf:s.isPresentationField(e.modelType),isOwnerExpanded:Boolean(e.isExpanded),isOwnerDataIsland:i,isOwnerConstantDataIsland:a,ownerId:n,parentId:e.parentId||n,dataIslandId:e.dataIslandId||n,isLastRow:!0,height:this.settings.height.LAST_ROW,padding:this.settings.height.LAST_ROW_PADDING}}}),n.exports=h});