/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../../model/schema/enum/schemaEntitiesEnum","backbone","../../../../dispatcher/enum/applicationStateEventsEnum"],function(e,t,i){var r=e("underscore"),n=e("../../../../../model/schema/enum/schemaEntitiesEnum"),s=e("backbone"),o=e("../../../../dispatcher/enum/applicationStateEventsEnum"),a={};a[n.DATA_ISLAND]=o.PRESENTATION_DESIGNER_UPDATE_DATA_ISLAND,a[n.PRESENTATION_FIELD]=o.PRESENTATION_DESIGNER_UPDATE_PRESENTATION_FIELD,a[n.PRESENTATION_SET]=o.PRESENTATION_DESIGNER_UPDATE_PRESENTATION_SET;var p=function(e){this.initialize(e)};r.extend(p.prototype,s.Events,{initialize:function(e){this.store=e.store,this.storeChangeEventBus=e.storeChangeEventBus,this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.presentationDesignerEventBus=e.presentationDesignerEventBus,this.validationRulesFactory=e.validationRulesFactory,this._initEvents()},_initEvents:function(){this.listenTo(this.storeChangeEventBus,"change",this._onChange),this.listenTo(this.presentationDesignerEventBus,"edit:property",this._onEditProperty),this.listenTo(this.presentationDesignerEventBus,"edit:enter:property",this._onEnterProperty),this.listenTo(this.presentationDesignerEventBus,"edit:input:property",this._onInputProperty),this.listenTo(this.presentationDesignerEventBus,"edit:esc:property",this._onEscProperty),this.listenTo(this.presentationDesignerEventBus,"edit:blur:property",this._onBlurProperty)},_onChange:function(){var e=this.store.get("editProperty");e.doNotClearOnChange?(delete e.doNotClearOnChange,this.store.set("editProperty",e)):this._clearEditProperty()},_onEditProperty:function(e){var t=e.item.id,i=e.value,n=this.validationRulesFactory.create({property:e.propertyName,modelType:e.item.modelType,id:t}),s={item:r.cloneDeep(e.item),propertyName:e.propertyName,value:i,validator:n,errorMessage:n.validate(i)};s=this._updateForExistingEditProperty(s),this.store.set("editProperty",s)},_updateForExistingEditProperty:function(e){var t=this.store.get("editProperty");return r.isEmpty(t)||(this._updateIfChangedOrCancelEdit(t),r.extend(e,{doNotClearOnChange:!0})),e},_onInputProperty:function(e){var t=this.store.get("editProperty"),i=t.validator;t.value=e,t.errorMessage=i.validate(e),this.store.set("editProperty",t)},_onBlurProperty:function(e){var t=this.store.get("editProperty"),i=t.item&&t.item.id===e.item.id,r=t.propertyName===e.propertyName;i&&r&&(delete t.doNotClearOnChange,this.store.set("editProperty",t),this._updateIfChangedOrCancelEdit(t))},_updateIfChangedOrCancelEdit:function(e){if(e.item){var t=e.item,i=e.propertyName,r=e.value,n=!e.errorMessage;if(t[i]!==r&&n){var s={};s[i]=r;var o=a[t.modelType];this._updatePresentationItem(o,t.id,s)}else this._clearEditProperty()}},_onEnterProperty:function(){var e=this.store.get("editProperty");!e.errorMessage&&this._updateIfChangedOrCancelEdit(e)},_onEscProperty:function(){this._clearEditProperty()},_clearEditProperty:function(){this.store.set("editProperty",{})},_updatePresentationItem:function(e,t,i){this.applicationDispatcherEventBus.trigger(e,{id:t,json:i})}}),i.exports=p});