/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../../../rest/enum/requestCanceledEnum","bundle!DomainDesignerBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../../../../../model/schema/enum/schemaEntitiesEnum","../../../../common/component/validation/enum/messageTypesEnum","../../../../dispatcher/enum/applicationStateEventsEnum"],function(e,i,s){var t=e("underscore"),n=e("backbone"),a=e("../../../../rest/enum/requestCanceledEnum"),r=e("bundle!DomainDesignerBundle"),o=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),l=e("../../../../../model/schema/enum/schemaEntitiesEnum"),c=e("../../../../common/component/validation/enum/messageTypesEnum"),d=e("../../../../dispatcher/enum/applicationStateEventsEnum"),u=o.create(r),h=function(e){this.initialize(e)};t.extend(h.prototype,n.Events,{initialize:function(e){t.bindAll(this,"_createCalcFieldAfterSuccessfulValidation","_updateCalcFieldAfterSuccessfulValidation"),this.saveConfirmationDialog=e.saveConfirmationDialog,this.calculatedFieldsDesignerValidator=e.calculatedFieldsDesignerValidator,this.store=e.store,this.dialog=e.dialog,this.storeChangeEventBus=e.storeChangeEventBus,this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.calculatedFieldsDesignerEventBus=e.calculatedFieldsDesignerEventBus,this.clientDomainSchemaCalcFieldsService=e.clientDomainSchemaCalcFieldsService,this.calculatedFieldsDesignerViewStateModelService=e.calculatedFieldsDesignerViewStateModelService,this.expressionBulkUpdateService=e.expressionBulkUpdateService,this._initEvents()},_initEvents:function(){var e=t.bind(this._validateCalcField,this,this._createCalcFieldAfterSuccessfulValidation),i=t.bind(this._validateCalcField,this,this._updateCalcFieldAfterSuccessfulValidation);this.listenTo(this.saveConfirmationDialog,"button:yes",this._onConfirmationDialogYesButtonClick),this.listenTo(this.storeChangeEventBus,"change",this._onExternalStoreChange),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:hide",this._hideDesigner),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:editExpression",this._onEditExpression),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:editName",this._onEditName),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:editType",this._onEditType),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:updateCalcField",i),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:createCalcField",e),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:validateExpression",this._onValidateExpression),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:cancelValidation",this._onCancelValidation),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:selectOperator",this._onOperatorSelect),this.listenTo(this.calculatedFieldsDesignerEventBus,"designer:addVariableNameToExpression",this._onAddVariableNameToExpression)},_getErrors:function(e){var i=this.store.get("errors");return e=t.extend({},i,e)},_onEditType:function(e){this.store.set({type:e})},_onEditName:function(e){var i=this._getErrors({name:""});this.store.set({name:e,errors:i})},_onEditExpression:function(e){var i=this.store.get("errors");e.expression&&(i=this._getErrors({expression:{message:""}})),e.expression={string:e.expression,object:this.store.get("expression").object},e=t.extend({},e,{errors:i,expressionValidationSuccessMessage:""}),this.store.set(e)},_hideDesigner:function(){this.applicationDispatcherEventBus.trigger(d.CALCULATED_FIELDS_DESIGNER_HIDE)},_validateCalcField:function(e){var i=this;this.store.set("calcFieldValidationInProgress",!0),this.calculatedFieldsDesignerValidator.validate().done(function(s){var t=i._getErrors({expression:{}});i._onValidationSuccess(s,e),i.store.set("errors",t)}).fail(function(e){a.CANCELED!==e&&(e=i._getErrors(e),i.store.set("errors",e))}).always(function(){i.store.set("calcFieldValidationInProgress",!1)})},_onValidationSuccess:function(e,i){var s=this.store.get("errors"),t=e.resultType,n=this.store.get("type");if(this._setFieldReferencesAndExpressionObjectAfterSuccessfulValidation(e),n!==t)if(s.expression.level===c.WARNING)i&&i();else{var a=u("domel.confirmDialog.result.type.do.not.match",n,t);this.saveConfirmationDialog.setContent(a),this.saveConfirmationDialog.open()}else i&&i()},_createCalcFieldAfterSuccessfulValidation:function(){var e=this.calculatedFieldsDesignerViewStateModelService.getContext(),i=t.pick(e,["sourceId","sourceType","sourceName"]);this.applicationDispatcherEventBus.trigger(d.CALCULATED_FIELDS_DESIGNER_CREATE_CALCULATED_FIELD,t.extend({calcField:this.store.toDTO()},i))},_updateCalcFieldAfterSuccessfulValidation:function(){var e=this.calculatedFieldsDesignerViewStateModelService.getContext(),i=this.store.get("originalName"),s=this.store.get("name"),t=this;i===s?this._updateCalcFieldAfterDependentResourcesWithExpressionsUpdate([]):this.expressionBulkUpdateService.getUpdatedExpressions({resourceId:e.calcFieldId,resourceType:l.CALC_FIELD,sourceId:e.sourceId,originalName:i,newName:s}).then(function(e){t._updateCalcFieldAfterDependentResourcesWithExpressionsUpdate(e)})},_updateCalcFieldAfterDependentResourcesWithExpressionsUpdate:function(e){var i=this.calculatedFieldsDesignerViewStateModelService.getContext();this.applicationDispatcherEventBus.trigger(d.CALCULATED_FIELDS_DESIGNER_UPDATE_CALCULATED_FIELD,{calcField:this.store.toDTO(),sourceId:i.sourceId,sourceType:i.sourceType,resources:e})},_onConfirmationDialogYesButtonClick:function(){this.store.get("id")?this._updateCalcFieldAfterSuccessfulValidation():this._createCalcFieldAfterSuccessfulValidation()},_onCancelValidation:function(){this.calculatedFieldsDesignerValidator.cancelValidation()},_onValidateExpression:function(){var e=this,i=this.store.defaults();this.store.set({expressionValidationInProgress:!0,errors:i.errors,expressionValidationSuccessMessage:i.expressionValidationSuccessMessage}),this.calculatedFieldsDesignerValidator.validateExpression().done(function(i){e._onExpressionValidationSuccess(i)}).fail(function(i){if(a.CANCELED!==i){var s=e._getErrors(i);e.store.set("errors",s)}}).always(function(){e.store.set("expressionValidationInProgress",!1)})},_onExpressionValidationSuccess:function(e){var i,s=this.store.get("errors"),t=e.resultType,n=this.store.get("type");this._setFieldReferencesAndExpressionObjectAfterSuccessfulValidation(e),n!==t?(i=u("domel.dialog.result.type.do.not.match",n,t),s=this._getErrors({expression:{level:c.WARNING,message:i}}),this.store.set("errors",s)):(s=this._getErrors({expression:{}}),this.store.set({errors:s,expressionValidationSuccessMessage:u("domain.designer.calcFields.formula.validationSuccess")}))},_setFieldReferencesAndExpressionObjectAfterSuccessfulValidation:function(e){var i={fieldReferences:e.fieldReferences,expression:e.expression};this.store.set(i)},_onExternalStoreChange:function(){var e,i=this.calculatedFieldsDesignerViewStateModelService.isDesignerVisible();i?(e=this._getDesignerStateOnDesignerOpen(),this.store.set(e),this.dialog.open()):(this.store.set({isVisible:i}),this.dialog.close())},_getDesignerStateOnDesignerOpen:function(){var e,i,s=this.store.defaults(),n=this.calculatedFieldsDesignerViewStateModelService.getContext(),a=this.calculatedFieldsDesignerViewStateModelService.isDesignerVisible();return n.calcFieldId?(i=this.clientDomainSchemaCalcFieldsService.getCalculatedFieldJSON(n.calcFieldId),e=t.extend(s,i,{originalName:i.name,isVisible:a,isUsedInJoinExpression:this.clientDomainSchemaCalcFieldsService.isCalcFieldUsedInJoinExpression(n.calcFieldId),isUsedInComplexJoin:this.clientDomainSchemaCalcFieldsService.isCalcFieldUsedInComplexJoin(n.calcFieldId),selectionRange:this._getSelectionRangeByString(i.expression.string)}),e.formulaValue=e.expression.string,e.formulaSelectionRange=e.selectionRange):e=t.extend(s,{name:this.clientDomainSchemaCalcFieldsService.generateCalcFieldName(n),isVisible:a}),e},_onOperatorSelect:function(e){var i,s;i=" "+e+" ",s=this._getExpressionWithRangeByString(i),this.store.set(s)},_getExpressionWithRangeByString:function(e){var i=this.store.get("expression"),s=i.string,t=this.store.get("selectionRange"),n=t.start,a=t.end;s=[s.slice(0,n),e,s.slice(a)].join("");var r=this._getSelectionRangeByString(e,t);return{expression:{object:i.object,string:s},formulaValue:s,selectionRange:r,formulaSelectionRange:r}},_getSelectionRangeByString:function(e,i){i=i||{start:0,end:0};var s=i.start+e.length;return{start:s,end:s}},_onAddVariableNameToExpression:function(e){var i=this._getExpressionWithRangeByString(e);this.store.set(i)}}),s.exports=h});