/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../../../rest/enum/requestCanceledEnum","../../../../common/component/validation/enum/messageTypesEnum","./util/collectFieldReferencesUsedInExpressionUtil","../../../../rest/errorHandling/errorHandlingUtil","../../../../rest/errorHandling/errorMessageUtil","./enum/domElErrorEnum","./enum/errorCodeToErrorLevelEnum","bundle!DomainDesignerBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage"],function(e,i,n){var r=e("jquery"),t=e("underscore"),a=e("../../../../rest/enum/requestCanceledEnum"),s=e("../../../../common/component/validation/enum/messageTypesEnum"),l=e("./util/collectFieldReferencesUsedInExpressionUtil"),o=e("../../../../rest/errorHandling/errorHandlingUtil"),d=e("../../../../rest/errorHandling/errorMessageUtil"),c=e("./enum/domElErrorEnum"),u=e("./enum/errorCodeToErrorLevelEnum"),m=e("bundle!DomainDesignerBundle"),g=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),h=g.create(m),v=function(e){this.initialize(e)};t.extend(v.prototype,{initialize:function(e){this.store=e.store,this.validationService=e.validationService,this.clientDomainSchemaCalcFieldsService=e.clientDomainSchemaCalcFieldsService,this.calculatedFieldsDesignerViewStateModelService=e.calculatedFieldsDesignerViewStateModelService,this.domainSchemaGranularSpecs=e.domainSchemaGranularSpecs},validate:function(){var e=this;this.validationDfd=new r.Deferred;var i=this._validateName();return this._validateExpression().then(function(n){i.name?e.validationDfd.reject(i):e.validationDfd.resolve(n)}).then(null,function(n){e.validationDfd.reject(t.extend({},n,i))}),this.validationDfd.promise()},validateExpression:function(){return this.validationDfd=new r.Deferred,this._validateExpression(this.validationDfd)},cancelValidation:function(){this.validationDfd&&this.validationDfd.reject(a.CANCELED)},validateName:function(){return this._validateName()},_validateName:function(){var e=this.store.get("name"),i=this.calculatedFieldsDesignerViewStateModelService.getContext(),n="";return this.domainSchemaGranularSpecs.calcFieldNameCanNotBeEmpty(e)?this.domainSchemaGranularSpecs.resourceNameShouldNotContainForbiddenCharacters(e)?this.domainSchemaGranularSpecs.calcFieldNameShouldBeUniqueThroughOtherFieldNamesOnSameLevel(i,e)||(n=h("domain.designer.calcFields.name.alreadyInUse")):n=h("domain.designer.calcFields.name.cannotContainInvalidCharacters"):n=h("domain.designer.calcFields.name.cannotBeEmpty"),{name:n}},_validateExpression:function(e){var i=this;return e=e||new r.Deferred,this.store.get("expression").string?this._validateIfCalcFieldHaveDependentFiltersWhenDataTypeHasChanged().then(function(){return i._validateExpressionExternally()}).then(function(e){return t.extend({},e,{fieldReferences:i._getFieldReferencesUsedInExpression(e)})}).then(function(e){return i._validateIfCalcFieldCanHaveConstantExpression(e)}).then(function(i){e.resolve(i)}).then(null,function(n){var r=i._getExpressionErrorMessageOnValidationFail(n);e.reject({expression:r})}):e.reject({expression:{message:h("domain.designer.calcFields.formula.cannotBeEmpty"),level:s.ERROR}}),e.promise()},_validateIfCalcFieldHaveDependentFiltersWhenDataTypeHasChanged:function(){var e=new r.Deferred,i=this.store.get("id"),n=this.store.get("type");return i&&this.domainSchemaGranularSpecs.calcFieldDataTypeCanNotBeChangedIfThereAreDependentFilters(i,n)?e.reject({expression:{message:h("domain.designer.calcFields.calcFieldUsedInFilterExpression"),level:s.ERROR}}):e.resolve(),e},_validateIfCalcFieldCanHaveConstantExpression:function(e){var i=new r.Deferred,n=this.store.get("isUsedInJoinExpression"),t=this.store.get("isUsedInComplexJoin"),a=e.fieldReferences.map(function(e){return e.fieldId}),l=this.clientDomainSchemaCalcFieldsService.isFieldsUsedByCalcFieldAreConstants(a);return(n||t)&&l?i.reject({expression:{message:h("domain.designer.calcFields.formula.cannotBeAConstant"),level:s.ERROR}}):i.resolve(e),i.promise()},_validateExpressionExternally:function(){var e=this._getCalcFieldValidationContext(),i=this.store.get("expression").string,n={expression:{string:i},variables:e};return this.validationService.validateDOMEl(n)},_getCalcFieldValidationContext:function(){var e=this.calculatedFieldsDesignerViewStateModelService.getContext();return this.clientDomainSchemaCalcFieldsService.getCalcFieldValidationContext(e).allowed.map(this._calcFieldValidationContextVariableMapper)},_calcFieldValidationContextVariableMapper:function(e){return t.pick(e,["name","type"])},_getExpressionErrorMessageOnValidationFail:function(e){return e.expression?e.expression:e.responseJSON.errorCode===c.UNDEF_VAR_OR_CIRCULAR_REF_ERROR_CODE?this._getUndefVarOrCircularRefErrorMessage(e):this._getExpressionErrorMessage(e)},_getUndefVarOrCircularRefErrorMessage:function(e){var i=o.getErrors(e),n=t.first(i),r=n.parameters,a=this._groupForbiddenCalcFieldsByName(),l=r.filter(function(e){return a[e.value]});return l.length>0?{message:h("domain.designer.calcFields.formula.circularReference",l),level:s.ERROR}:this._getExpressionErrorMessage(e)},_getExpressionErrorMessage:function(e){var i=o.getErrors(e),n=t.first(i).errorCode;return{message:d.getFirstErrorMessage(e),level:u[n]||s.ERROR}},_getFieldReferencesUsedInExpression:function(e){var i=this.calculatedFieldsDesignerViewStateModelService.getContext(),n=this.clientDomainSchemaCalcFieldsService.getCalcFieldValidationContext(i);return l(e.expression,n)},_groupForbiddenCalcFieldsByName:function(){var e=this.calculatedFieldsDesignerViewStateModelService.getContext(),i=this.clientDomainSchemaCalcFieldsService.getCalcFieldValidationContext(e);return t.indexBy(i.forbidden,"name")}}),n.exports=v});