/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone"],function(e,t,s){var i=e("underscore"),a=e("backbone"),l=function(e){this.initialize(e)};i.extend(l.prototype,a.Events,{initialize:function(e){this.treeDataProvider=e.treeDataProvider,this.storeChangeEventBus=e.storeChangeEventBus,this.calculatedFieldsDesignerViewStateModelService=e.calculatedFieldsDesignerViewStateModelService,this.calculatedFieldsDesignerInitialExpandedNodesProvider=e.calculatedFieldsDesignerInitialExpandedNodesProvider,this.calculatedFieldsDesignerEventBus=e.calculatedFieldsDesignerEventBus,this.tree=e.tree,this.store=e.store,this._initEvents()},_initEvents:function(){this.listenTo(this.storeChangeEventBus,"change",this._onStoreChange),this.listenTo(this.calculatedFieldsDesignerEventBus,"change:searchKeyword",this._onSearchKeywordChange),this.listenTo(this.calculatedFieldsDesignerEventBus,"availableItemsTree:expand",this._onAvailableItemsTreeExpand),this.listenTo(this.calculatedFieldsDesignerEventBus,"availableItemsTree:collapse",this._onAvailableItemsTreeCollapse)},_onAvailableItemsTreeExpand:function(e){var t=this.store.get("searchKeyword"),s=i.clone(this.store.get("availableValuesExpandedNodes")),a=i.clone(this.store.get("availableValuesCollapsedNodes"));t?(delete a[e.resourceId],this.store.set("availableValuesCollapsedNodes",a)):(s[e.resourceId]=!0,this.store.set("availableValuesExpandedNodes",s)),this.treeDataProvider.setNeedToConvert(!0),this._refetchTreeIfVisible()},_onAvailableItemsTreeCollapse:function(e){var t=e.resourceId,s=this.store.get("searchKeyword"),a=i.clone(this.store.get("availableValuesExpandedNodes")),l=i.clone(this.store.get("availableValuesCollapsedNodes"));s?(l[t]=!0,this.store.set("availableValuesCollapsedNodes",l)):(delete a[t],this.store.set("availableValuesExpandedNodes",a)),this.treeDataProvider.setNeedToConvert(!0),this._refetchTreeIfVisible()},_onStoreChange:function(e){this.treeDataProvider.setState({dataStore:e.dataStore}),this._initialTreeRefetchIfVisible(e.dataStore)},_onSearchKeywordChange:function(e){this.store.set({searchKeyword:e,availableValuesCollapsedNodes:{}}),this.treeDataProvider.setNeedToConvert(!0),this._refetchTreeIfVisible()},_refetchTreeIfVisible:function(){this.calculatedFieldsDesignerViewStateModelService.isDesignerVisible()&&this.tree.fetch()},_initialTreeRefetchIfVisible:function(e){var t,s=this.calculatedFieldsDesignerViewStateModelService.getContext(),i=this.calculatedFieldsDesignerViewStateModelService.isDesignerVisible();i&&(t=this.calculatedFieldsDesignerInitialExpandedNodesProvider.getExpandedNodes(e,s),this.store.set("availableValuesExpandedNodes",t),this.tree.fetch())}}),s.exports=l});