/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery","../../../../../model/schema/util/entityUtil"],function(e,t,r){var a=e("underscore"),i=e("jquery"),n=e("../../../../../model/schema/util/entityUtil"),s=function(e){this.metadataService=e.metadataService,this.clientDomainSchemaService=e.clientDomainSchemaService,this.clientResourcePropertiesService=e.clientResourcePropertiesService,this.foreignKeyMetadataConverter=e.foreignKeyMetadataConverter,this.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec=e.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec};a.extend(s.prototype,{getForeignKeys:function(e){var t=this.clientDomainSchemaService.getAllGenericTablesWithParents(e),r=this.clientDomainSchemaService.getDataSourceById(e),a=this.clientResourcePropertiesService.getDataSourceUri(r.name),n=[];t=this._groupTablesByParentId(t);var s=this._getForeignKeysForAllParentIds({dataSourceId:e,dataSourceUri:a,tablesWithParents:t,result:n});return i.when.apply(null,s).then(function(){return n})},_groupTablesByParentId:function(e){return a.groupBy(e,function(e){return e.table.parentId})},_getForeignKeysForAllParentIds:function(e){var t=e.tablesWithParents,r=e.dataSourceId,i=e.dataSourceUri,n=e.result,s=this;return a.map(t,function(e,t){return s._getForeignKeysForSpecificParentId({dataSourceId:r,dataSourceUri:i,parentId:Number(t),tablesWithParents:e,result:n})})},_getForeignKeysForSpecificParentId:function(e){var t=e.dataSourceId,r=e.dataSourceUri,i=e.parentId,n=e.tablesWithParents,s=e.result,o=this,c=this._convertTablesToUriParameters(n);return this.metadataService.getMetadata(r,c,{loadReferences:!0}).then(function(e){if(e){var r=a.isArray(e)?e:[e];s.push.apply(s,o.foreignKeyMetadataConverter.convert({dataSourceId:t,parentId:i,resources:r}))}})},_convertTablesToUriParameters:function(e){return a.map(e,function(e){var t=this._getTableWithParentsButWithoutDataSource(e.table,e.parents);return this._getResourceNames(t)},this)},_getTableWithParentsButWithoutDataSource:function(e,t){return t=a.clone(t),t.reverse(),t.splice(0,1),t.push(e),t},_getResourceNames:function(e){var t=this.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec.isSatisfied();return a.reduce(e,function(e,r){if(n.isDataSourceGroup(r.type)&&t)return e;var a=r.sourceName||r.name;return e.push(a),e},[],this)}}),r.exports=s});