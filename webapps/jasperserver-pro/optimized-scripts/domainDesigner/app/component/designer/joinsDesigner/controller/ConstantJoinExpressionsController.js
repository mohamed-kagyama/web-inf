/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","../../../../rest/enum/requestCanceledEnum","bundle!DomainDesignerBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../enum/constantJoinNullExpressionEnum","../enum/constantJoinExpressionOperatorsEnum","../../../../../model/schema/enum/fieldTypesToGenericTypesEnum","../../../../dispatcher/enum/applicationStateEventsEnum"],function(n,i,s){var e=n("jquery"),o=n("underscore"),t=n("backbone"),a=n("../../../../rest/enum/requestCanceledEnum"),r=n("bundle!DomainDesignerBundle"),l=n("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),c=n("../enum/constantJoinNullExpressionEnum"),p=n("../enum/constantJoinExpressionOperatorsEnum"),E=n("../../../../../model/schema/enum/fieldTypesToGenericTypesEnum"),d=n("../../../../dispatcher/enum/applicationStateEventsEnum"),h=l.create(r),u=function(n){this.initialize(n)};o.extend(u.prototype,t.Events,{initialize:function(n){o.bindAll(this,"_onUnsuccessfulValidation","_saveOrUpdateConstantJoinExpression"),this.saveConstantJoinConfirmationDialog=n.saveConstantJoinConfirmationDialog,this.constantJoinExpressionDialogStore=n.constantJoinExpressionDialogStore,this.constantJoinExpressionDialog=n.constantJoinExpressionDialog,this.constantJoinExpressionConverter=n.constantJoinExpressionConverter,this.applicationDispatcherEventBus=n.applicationDispatcherEventBus,this.joinsDesignerEventBus=n.joinsDesignerEventBus,this.constantJoinExpressionValidator=n.constantJoinExpressionValidator,this.constantJoinExpressionFactory=n.constantJoinExpressionFactory,this.selectOptionsWithAdditionalPropsFactory=n.selectOptionsWithAdditionalPropsFactory,this.clientDomainSchemaJoinsDesignerService=n.clientDomainSchemaJoinsDesignerService,this._initEvents()},_initEvents:function(){this.listenTo(this.joinsDesignerEventBus,"update:constantJoinExpression",this._onBeforeUpdateConstantJoinExpression),this.listenTo(this.joinsDesignerEventBus,"remove:constantJoinExpression",this._onBeforeRemoveConstantJoinExpression),this.listenTo(this.joinsDesignerEventBus,"show:editConstantJoinExpressionDialog",this._onShowEditConstantJoinExpressionDialog),this.listenTo(this.joinsDesignerEventBus,"show:createConstantJoinExpressionDialog",this._onShowCreateConstantJoinExpressionDialog),this.listenTo(this.joinsDesignerEventBus,"hide:constantJoinExpressionDialog",this._onHideConstantJoinExpressionDialog),this.listenTo(this.joinsDesignerEventBus,"constantJoinExpression:changeExpression",this._validateAndFireDispatcherAction),this.listenTo(this.joinsDesignerEventBus,"constantJoinExpression:changeField",this._changeField),this.listenTo(this.joinsDesignerEventBus,"constantJoinExpression:changeValue",this._changeValue),this.listenTo(this.joinsDesignerEventBus,"constantJoinExpression:changeOperator",this._changeOperator),this.listenTo(this.joinsDesignerEventBus,"constantJoinExpression:validateExpression",this._onClickValidateInDialog),this.listenTo(this.joinsDesignerEventBus,"constantJoinExpression:cancelValidation",this._onValidationCancel),this.listenTo(this.saveConstantJoinConfirmationDialog,"button:yes",this._saveOrUpdateConstantJoinExpression)},_onBeforeUpdateConstantJoinExpression:function(n,i){var s=n.id,e=n.joinId,o=n.joinTreeId;this.applicationDispatcherEventBus.trigger(d.JOINS_DESIGNER_UPDATE_CONSTANT_JOIN_EXPRESSION,{id:s,joinTreeId:o,joinId:e,operator:i.operator})},_onBeforeRemoveConstantJoinExpression:function(n){var i=n.id,s=n.joinTreeId;this.applicationDispatcherEventBus.trigger(d.JOINS_DESIGNER_REMOVE_CONSTANT_JOIN_EXPRESSION,{id:i,joinTreeId:s})},_onShowEditConstantJoinExpressionDialog:function(n){var i=n.constantJoinExpression,s=i.joinId,e=this.clientDomainSchemaJoinsDesignerService.getFieldsForTablesInJoin(s),t=this.constantJoinExpressionConverter.getConstantJoinExpressionOptions(o.extend({fields:e},i));this._showConstantJoinExpressionDialog(t)},_onShowCreateConstantJoinExpressionDialog:function(n){var i=n.join.id,s=this.clientDomainSchemaJoinsDesignerService.getFieldsForTablesInJoin(i),e=this.constantJoinExpressionConverter.getConstantJoinExpressionOptions({joinId:n.join.id,fields:s});this._showConstantJoinExpressionDialog(e)},_showConstantJoinExpressionDialog:function(n){var i=this._getFieldTypeAndAvailableOperators({field:n.field,fieldOptions:n.fieldOptions});n=o.extend({},n,i),this.constantJoinExpressionDialogStore.reset(),this.constantJoinExpressionDialogStore.set(n),this.constantJoinExpressionDialog.open()},_getFieldTypeAndAvailableOperators:function(n){var i=n.field,s=o.find(n.fieldOptions,function(n){return n.value===i}).fieldType;return{fieldType:s,availableOperators:this.selectOptionsWithAdditionalPropsFactory.create({operators:p[E[s]]})}},_onHideConstantJoinExpressionDialog:function(){this.constantJoinExpressionDialog.close()},_changeField:function(n,i){var s=o.find(i,function(i){return i.value===n}).fieldType;this._clearValidationErrors(),this.constantJoinExpressionDialogStore.set({field:n,fieldType:s})},_changeValue:function(n){this._clearValidationErrors(),this.constantJoinExpressionDialogStore.set({value:n})},_changeOperator:function(n){this._clearValidationErrors(),this.constantJoinExpressionDialogStore.set({operator:n})},_validateValueExternally:function(n){var i=this.constantJoinExpressionFactory.create(n),s=!i.variables;return this.constantJoinExpressionValidator.validate(i).then(function(n){return(new e.Deferred).resolve(n,s)})},_onValidationCancel:function(){this.constantJoinExpressionValidator.cancelValidation()},_onClickValidateInDialog:function(){var n=this,i=this.constantJoinExpressionDialogStore.toJSON();this.constantJoinExpressionDialogStore.set({expressionValidationInProgress:!0,successMessage:"",errorMessage:"",warningMessage:""}),this._validateValueExternally(i).done(function(s,e){n._onExpressionValidationSuccess({response:s,isLiteral:e,modelDTO:i})}).fail(this._onUnsuccessfulValidation).always(function(){n.constantJoinExpressionDialogStore.set("expressionValidationInProgress",!1)})},_validateAndFireDispatcherAction:function(){var n=this,i=this.constantJoinExpressionDialogStore.toJSON();this.constantJoinExpressionDialogStore.set({constantJoinValidationInProgress:!0}),this._validateValueExternally(i).done(function(s,e){n._onValidationSuccess({response:s,isLiteral:e,modelDTO:i,callback:n._saveOrUpdateConstantJoinExpression})}).fail(this._onUnsuccessfulValidation).always(function(){n.constantJoinExpressionDialogStore.set("constantJoinValidationInProgress",!1)})},_validateInternally:function(n){var i=n.response,s=n.modelDTO,e=n.isLiteral,o=i.resultType,t=s.fieldType,a=n.success,r=n.fail,l=o!==t,p=JSON.stringify(i.expression.object)===c.NULL_EXPRESSION;e&&l&&!p?r&&r():a&&a()},_onValidationSuccess:function(n){var i=n.response,s=n.modelDTO,e=n.callback,t=i.resultType,a=s.fieldType,r=this;this._validateInternally(o.extend(o.omit(n,"callback"),{success:e,fail:function(){if(r.constantJoinExpressionDialogStore.get("warningMessage"))e&&e();else{var n=h("domel.confirmDialog.result.type.do.not.match",t,a);r.saveConstantJoinConfirmationDialog.setContent(n),r.saveConstantJoinConfirmationDialog.open()}}}))},_onExpressionValidationSuccess:function(n){var i,s=n.response,e=n.modelDTO,t=s.resultType,a=e.fieldType,r=this;this.constantJoinExpressionDialogStore.set("errorMessage",""),this._validateInternally(o.extend({},n,{success:function(){r.constantJoinExpressionDialogStore.set("successMessage",h("domain.validation.constantJoinExpressionValue.successful"))},fail:function(){i=h("domel.dialog.result.type.do.not.match",t,a),r.constantJoinExpressionDialogStore.set("warningMessage",i)}}))},_saveOrUpdateConstantJoinExpression:function(){var n=this.constantJoinExpressionDialogStore.toJSON();this.joinsDesignerEventBus.trigger("hide:constantJoinExpressionDialog"),n.id?this.applicationDispatcherEventBus.trigger(d.JOINS_DESIGNER_UPDATE_CONSTANT_JOIN_EXPRESSION,n):this.applicationDispatcherEventBus.trigger(d.JOINS_DESIGNER_CREATE_CONSTANT_JOIN_EXPRESSION,n)},_onUnsuccessfulValidation:function(n){n!==a.CANCELED&&this.constantJoinExpressionDialogStore.set("errorMessage",n)},_clearValidationErrors:function(){this.constantJoinExpressionDialogStore.set({errorMessage:"",successMessage:"",warningMessage:""})}}),s.exports=u});