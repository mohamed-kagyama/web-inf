/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","bundle!DomainDesignerBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage","../../../../dispatcher/enum/applicationStateEventsEnum"],function(e,i,n){var t=e("underscore"),o=e("backbone"),s=e("bundle!DomainDesignerBundle"),a=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),r=e("../../../../dispatcher/enum/applicationStateEventsEnum"),c=a.create(s),g=function(e){t.bindAll(this,"_onForeignKeyInfoReceived"),this.applicationDispatcherEventBus=e.applicationDispatcherEventBus,this.joinsDesignerEventBus=e.joinsDesignerEventBus,this.foreignKeyDiscoveryService=e.foreignKeyDiscoveryService,this.clientDomainSchemaService=e.clientDomainSchemaService,this.confirmationDialog=e.confirmationDialog,this.alertDialog=e.alertDialog,this.clientDomainSchemaJoinsDesignerService=e.clientDomainSchemaJoinsDesignerService,this._initEvents()};t.extend(g.prototype,o.Events,{_initEvents:function(){this.listenTo(this.joinsDesignerEventBus,"generate:joins",this._generateJoins)},_generateJoins:function(e){this._atLeastOneTableAddedToDataSource(e)?this.foreignKeyDiscoveryService.getForeignKeys(e).then(this._onForeignKeyInfoReceived):(this.alertDialog.setMessage(c("domain.designer.joinsDesigner.generate.dialog.warning.noTables")),this.alertDialog.open())},_atLeastOneTableAddedToDataSource:function(e){return this.clientDomainSchemaService.getTablesCount(e)>0},_onForeignKeyInfoReceived:function(e){0===e.length?(this.alertDialog.setMessage(c("domain.designer.joinsDesigner.generate.dialog.warning.noForeignKeyInfo")),this.alertDialog.open()):(this._initConfirmationDialogEvents(e),this.confirmationDialog.open())},_initConfirmationDialogEvents:function(e){this.listenTo(this.confirmationDialog,"button:yes",t.bind(this._onJoinsGenerationConfirmed,this,e)),this.listenTo(this.confirmationDialog,"button:yes button:no",t.bind(this._stopListeningForConfirmationDialog,this))},_stopListeningForConfirmationDialog:function(){this.stopListening(this.confirmationDialog)},_onJoinsGenerationConfirmed:function(e){var i=this.clientDomainSchemaJoinsDesignerService.generateJoins(e);this.applicationDispatcherEventBus.trigger(r.JOINS_DESIGNER_GENERATE_JOINS,i)}}),n.exports=g});