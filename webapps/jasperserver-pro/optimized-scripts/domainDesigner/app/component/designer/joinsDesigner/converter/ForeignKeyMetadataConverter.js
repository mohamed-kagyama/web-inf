/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../../util/pathUtil","../../../../model/enum/joinsEnum","settings!domainSettings"],function(e,t,a){var i=e("underscore"),r=e("../../../../util/pathUtil"),n=e("../../../../model/enum/joinsEnum"),d=e("settings!domainSettings"),l=d.defaultJoinWeight,o=function(e){this.defaultWeight=e.defaultWeight||l,this.clientDomainSchemaMetadataService=e.clientDomainSchemaMetadataService,this.clientDomainSchemaService=e.clientDomainSchemaService,this.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec=e.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec};i.extend(o.prototype,{convert:function(e){var t=e.parentId,a=e.dataSourceId,i=e.resources;return this._tablesToFieldsDTO({tables:i,parentId:t,dataSourceId:a})},_tablesToFieldsDTO:function(e){var t=e.tables,a=e.parentId,r=e.dataSourceId;return i.reduce(t,function(e,t){return t=t.group,e.concat(this._tableToFieldsDTO({table:t,parentId:a,dataSourceId:r}))},[],this)},_tableToFieldsDTO:function(e){var t=e.table,a=e.parentId,i=e.dataSourceId,r=t.name,n=this._getAllFields(t),d=this._getAllTableGroups(t),l=this.clientDomainSchemaService.getTableByNameAndParent(r,a),o=l.id;return this._toFieldsDTO({fields:n,parentId:o,tableId:o,dataSourceId:i}).concat(this._tableGroupsToFieldsDTO({tableGroups:d,parentId:o,tableId:o,dataSourceId:i}))},_tableGroupsToFieldsDTO:function(e){var t=e.tableGroups,a=e.parentId,r=e.tableId,n=e.dataSourceId;return i.reduce(t,function(e,t){return e.concat(this._tableGroupToFieldsDTO({tableGroup:t,parentId:a,tableId:r,dataSourceId:n}))},[],this)},_tableGroupToFieldsDTO:function(e){var t=e.tableGroup,a=e.parentId,i=e.tableId,r=e.dataSourceId,n=t.name,d=this._getAllFields(t),l=this._getAllTableGroups(t),o=this.clientDomainSchemaService.getTableGroupByNameAndParent(n,a),u=o.id;return this._toFieldsDTO({fields:d,parentId:u,tableId:i,dataSourceId:r}).concat(this._tableGroupsToFieldsDTO({tableGroups:l,parentId:u,tableId:i,dataSourceId:r}))},_toFieldsDTO:function(e){var t=e.fields,a=e.parentId,r=e.tableId,n=e.dataSourceId;return i.chain(t).filter(this._filterOurFieldsWhichHasNoForeignKeys).map(function(e){return this._toFieldDTO({field:e,parentId:a,tableId:r,dataSourceId:n})},this).filter(this._filterOurFieldsWhichAreAbsentInSchema).value()},_toFieldDTO:function(e){var t,a=e.field,r=e.parentId,d=e.tableId,l=e.dataSourceId,o=a.name,u=this.clientDomainSchemaService.getFieldByNameAndParent(o,r);if(!u)return t;var s=u.id,c=this._getReferencedField(a.referenceTo,l);return c?t=i.extend({dataSourceId:l,leftTableId:d,leftFieldId:s,rightFieldId:c.id,rightTableId:c.tableId,weight:this.defaultWeight,operator:n.joinOperators.equals.name,type:n.joinTypes.inner.name}):t},_filterOurFieldsWhichAreAbsentInSchema:function(e){return!i.isUndefined(e)},_filterOurFieldsWhichHasNoForeignKeys:function(e){return Boolean(e.referenceTo)},_getAllFields:function(e){return i.chain(e.elements).filter(function(e){return e.element}).map(function(e){return e.element}).value()},_getAllTableGroups:function(e){return i.chain(e.elements).filter(function(e){return e.group}).map(function(e){return e.group}).value()},_getReferencedField:function(e,t){var a=r.split(e,"\\","."),i=this.schemaLessDataSourceWithEmptyResolvedSchemaAttributeSpec.isSatisfied();return this.clientDomainSchemaMetadataService.getFieldByDataSourceIdAndParentNames(t,a,i)}}),a.exports=o});