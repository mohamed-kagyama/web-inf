/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","backbone","../enum/requestCanceledEnum","underscore"],function(e,i,r){var t=e("jquery"),s=e("backbone"),o=e("../enum/requestCanceledEnum"),n=e("underscore"),d=function(e){this.initialize(e)};n.extend(d.prototype,s.Events,{initialize:function(e){e=e||{},n.bindAll(this,"_showLoader","_closeLoader"),this.isLoaderVisible=!1,this.showLoaderDeferred=null,this.closeLoaderDeferred=null,this.loadingDelay=e.loadingDelay,this.loadingMinDuration=e.loadingMinDuration,this.loaderEventBus=e.loaderEventBus,this.closedImmediately=!1,this.deferreds={},this._initEvents()},_initEvents:function(){this.listenTo(this.loaderEventBus,"cancel",this._onCancel)},wrapWithLoader:function(e,i){this._showLoaderAfterDelay();var r=this._getCancelableDeferred(i);return e.done(r.resolve.bind(r)).fail(r.reject.bind(r)),r.promise()},_onStopLoaderIfNoDeferredsLeft:function(){0===Object.keys(this.deferreds).length&&(this._isPendingPromise(this.showLoaderDeferred)?this.showLoaderDeferred.reject():this.closedImmediately||this._stopLoaderAfterDelay())},_isPendingPromise:function(e){return e&&"pending"===e.state()},_showLoaderAfterDelay:function(){this.closedImmediately=!1;var e=this._isPendingPromise(this.closeLoaderDeferred),i=this._isPendingPromise(this.showLoaderDeferred);if(this.isLoaderVisible&&e)this.closeLoaderDeferred.reject();else if(!this.isLoaderVisible&&!i){var r=new t.Deferred;n.delay(r.resolve,this.loadingDelay),r.then(this._showLoader),this.showLoaderDeferred=r}},_stopLoaderAfterDelay:function(){var e=new t.Deferred;n.delay(e.resolve,this.loadingMinDuration),e.then(this._closeLoader),this.closeLoaderDeferred=e},_stopLoaderImmediately:function(){this.closedImmediately=!0,this._closeLoader()},_showLoader:function(){this.isLoaderVisible=!0,this.loaderEventBus.trigger("show")},_closeLoader:function(){this.isLoaderVisible=!1,this.loaderEventBus.trigger("hide")},_getCancelableDeferred:function(e){var i=new t.Deferred,r=n.uniqueId()+"_"+String(Date.now()),s=this;return i.fail(function(){n.isFunction(e)&&e()}).always(function(){s._removeDeferred(r)}),this.deferreds[r]=i,i},_removeDeferred:function(e){delete this.deferreds[e],this._onStopLoaderIfNoDeferredsLeft()},_onCancel:function(){var e=this;this._stopLoaderImmediately(),Object.keys(this.deferreds).forEach(function(i){var r=e.deferreds[i];e._isPendingPromise(r)&&r.reject(o.CANCELED)})}}),r.exports=d});