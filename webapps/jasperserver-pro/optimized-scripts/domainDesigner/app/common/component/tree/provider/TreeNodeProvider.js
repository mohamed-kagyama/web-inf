/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","jquery"],function(e,t,i){function n(e){this.node=e.node||l.cloneDeep(c),this.parentDataProvider=e.parentDataProvider,this.selection=e.selection||{}}function o(e){return l.map(e,function(e){return l.omit(e,"children")})}function r(e){return e.reduce(function e(t,i){if(i.id!==c.id&&t.push(i),i.children&&i.children.length>0){var n=i.children.reduce(e,[]);t=t.concat(n)}return t},[])}function d(e,t){if(e.id===t&&e.id!==c.id)return e;if(e.children)for(var i=0;i<e.children.length;i++){var n=e.children[i],o=d(n,t);if(o)return o}}var l=e("underscore"),s=e("jquery"),c={id:-1,children:[],visible:!1,selected:!1};l.extend(n.prototype,{getData:function(e,t){t=t||{};var i=this;return this._toggleAndLoadNewNodes(e,t).then(function(e){i._selectNodeIfSelectionAction(e,t)}).then(function(){return i._getVisibleAndAllSelectedNodes()})},_toggleAndLoadNewNodes:function(e,t){var i,n=this,o=l.isBoolean(t.open),r=new s.Deferred;e&&(i=this._getNodeById(e.id));var d=!i;if(d){this.node.children.length>0&&(delete this.node,this.node=l.cloneDeep(c)),i=this.node,e&&(i.properties=e)}return o||d?(d?r=this._loadChildren(i,t):l.isUndefined(t.open)||(t.open?r=this._loadChildren(i,t):r.resolve(i)),r.then(function(e){return n._toggleNode(e)})):r.resolve(i),r},_loadChildren:function(e,t){var i,n=this,o=new s.Deferred;return l.isEmpty(e.children)?(i=e.id===c.id?this.node.properties:e.properties,this.parentDataProvider.getData(t,i).then(function(t){return e=n._addNewChildren(e,t.data),e=n._showItem(e)})):(o.resolve(e),o)},_addNewChildren:function(e,t){var i=(l.isNumber(e.level)?e.level:0)+1,n=t.map(function(e){return e.level=i,e});return e.children=e.children.concat(n),e},_toggleNode:function(e){this._isDefaultRootAlreadyExpanded(e)||(e.open=!e.open,e.open?this._showItem(e):l.isEmpty(e.children)||e.children.forEach(this._hideItem,this))},_isDefaultRootAlreadyExpanded:function(e){if(e.id===c.id&&e.visible)return l.every(e.children,function(e){return e.visible})},_selectNodeIfSelectionAction:function(e,t){t.clearSelection&&(this.selection={});var i=e.isSelectable,n=t.select,o=t.multiple;n&&i&&(o?this._toggleNodeSelection(e):this._selectNode(e))},_toggleNodeSelection:function(e){this.selection[e.id]?delete this.selection[e.id]:this.selection[e.id]=!0},_selectNode:function(e){this.selection[e.id]||(this.selection={},this.selection[e.id]=!0)},_showItem:function(e){return e.visible=!0,e.open&&!l.isEmpty(e.children)&&e.children.forEach(this._showItem,this),e},_hideItem:function(e){return e.visible=!1,l.isEmpty(e.children)||e.children.forEach(this._hideItem,this),e},_getVisibleAndAllSelectedNodes:function(){return{visibleNodes:o(r([this.node])),selection:l.clone(this.selection)}},_getNodeById:function(e){return d(this.node,e)}}),l.extend(n,{DEFAULT_ROOT_NODE:c}),i.exports=n});