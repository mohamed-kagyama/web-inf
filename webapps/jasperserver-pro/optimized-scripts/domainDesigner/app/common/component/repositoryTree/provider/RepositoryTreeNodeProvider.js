/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../enum/repositoryFakeFolderEnum","../../../../../rest/enum/mimeTypesEnum","../util/resourceLookupUtil","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"],function(e,r,t){function o(e){return e&&!c.isEmptyFolder(e)}function i(e){e=e||e,n.bindAll(this,"getData","_filterEmptyFolders"),this.resourceLookupsFilter=e.resourceLookupsFilter||o,this.resourceService=e.resourceService,this.toTreeNode=e.resourceLookupToTreeNodeConverter.convert,this.defaultSearchParams=n.defaults(e.defaultSearchParams||{})}var u=e("jquery"),n=e("underscore"),s=e("../enum/repositoryFakeFolderEnum"),a=e("../../../../../rest/enum/mimeTypesEnum"),c=e("../util/resourceLookupUtil"),l=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes");n.extend(i.prototype,{getData:function(e,r){e=e||{},this.fileType=r.fileType||e.fileType;var t=this,o=e.offset,i=e.limit,c=n.defaults({folderUri:r&&r.uri?r.uri:s.ROOT_FOLDER.URI,offset:o,limit:i,recursive:!1,containerType:l.FOLDER},this.defaultSearchParams);return u.when(this.resourceService.search(c),this.resourceService.getResource("",{type:a.REPOSITORY_FOLDER})).then(function(e,o){return t._createFakeRootAndPublicFolder({resource:r,searchResult:e,rootResourceDescriptor:o[0],searchParams:c})}).then(function(e){return t._removePublicFolderFromChildrenOfFakeRootFolder(r,e)}).then(this._filterEmptyFolders).then(function(e){return e.data.each(function(e){e.fileType=t.fileType}),{data:e.data.map(t.toTreeNode),total:e.total}})},getQueryKeyword:function(){return this.defaultSearchParams.q},setQueryKeyword:function(e){this.defaultSearchParams.q=e},resetQueryKeyword:function(){delete this.defaultSearchParams.q},_isFakeResource:function(e){return e&&e.id===s.ROOT_FOLDER.FAKE_ID},_isRootFolder:function(e){return e&&e.uri===s.ROOT_FOLDER.URI},_createFakeRootAndPublicFolder:function(e){var r=e.resource,t=e.searchResult,o=e.searchParams,i=e.rootResourceDescriptor;if(this._isRootFolder(r)&&!this._isFakeResource(r)){var a=n.find(t.data,function(e){return e.uri===s.PUBLIC_FOLDER.URI}),c=[n.extend({},s.ROOT_FOLDER.FOLDER,{label:i.label})];if(!a)return this._getPublicFolder(o).then(function(e){return c=c.concat(e),{data:c,total:c.length}},function(){return(new u.Deferred).resolve({data:c,total:c.length})});c=c.concat(a),t={data:c,total:c.length}}return t},_removePublicFolderFromChildrenOfFakeRootFolder:function(e,r){if(this._isRootFolder(e)&&this._isFakeResource(e)){r={data:r.data.filter(function(e){return e.uri!==s.PUBLIC_FOLDER.URI}),total:r.total-1}}return r},_filterEmptyFolders:function(e){var r;return this.resourceLookupsFilter&&(r=e.data.filter(this.resourceLookupsFilter),e={data:r,total:r.length}),e},_getPublicFolder:function(e){return e=n.extend({},e,{folderUri:s.PUBLIC_FOLDER.URI}),u.when(this.resourceService.search(e),this.resourceService.getResource(s.PUBLIC_FOLDER.URI)).then(function(e,r){return e.data.length?n.extend({},s.PUBLIC_FOLDER.FOLDER,{label:r[0].label}):(new u.Deferred).reject()})}}),t.exports=i});