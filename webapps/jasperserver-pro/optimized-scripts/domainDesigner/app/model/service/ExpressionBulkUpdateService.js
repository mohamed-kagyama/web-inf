/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../util/pathUtil","../../../model/schema/util/entityUtil","../../../model/schema/enum/dataSourceMetadataTypesEnum","../expression/expressionVariables"],function(e,i,a){var r=e("jquery"),n=e("underscore"),t=e("../../util/pathUtil"),s=e("../../../model/schema/util/entityUtil"),l=e("../../../model/schema/enum/dataSourceMetadataTypesEnum"),o=e("../expression/expressionVariables"),c=function(e){this.initialize(e)};n.extend(c.prototype,{initialize:function(e){this.clientDomainSchemaCalcFieldsService=e.clientDomainSchemaCalcFieldsService,this.clientDomainSchemaService=e.clientDomainSchemaService,this.validationService=e.validationService},getUpdatedExpressions:function(e){var i=this._getAllDependenciesWithExpressions(e);return 0===i.length?r.Deferred().resolve([]):this._getUpdatedDependentExpressions(n.extend({},e,{allDependenciesWithExpressions:i}))},_getAllDependenciesWithExpressions:function(e){var i=e.resourceId,a=e.resourceType,r=e.sourceId;return s.isCalcField(a)?this.clientDomainSchemaService.getAllDependenciesWithExpressionsForField(i,r):s.isTableReference(a)?this.clientDomainSchemaService.getAllDependenciesWithExpressionsForTableReference(i):void 0},_getUpdatedDependentExpressions:function(e){var i=this._convertDependenciesToServiceFormat(e),a=this;return this.validationService.validateDOMElCollection(i).then(function(i){var n=a._convertValidationResultToResourcesWhichShouldBeUpdated(i,e.allDependenciesWithExpressions);return r.Deferred().resolve(n)})},_convertValidationResultToResourcesWhichShouldBeUpdated:function(e,i){return e.expressionContexts.map(function(e,a){var r=i[a];return n.extend(n.omit(r,["variables"]),{expression:e.expression})})},_convertDependenciesToServiceFormat:function(e){var i=e.allDependenciesWithExpressions,a=n.bind(this._convertDependencyToServiceFormat,this,e);return i.map(a)},_convertDependencyToServiceFormat:function(e,i){var a=this._getExpressionVariableRenamer(e,i),r=this._getAllVariablesReducer(e,i),t=i.entityType,c=o.updateVariableName(i.expression.object,a),d=n.reduce(i.variables,r,[]),u={expression:{object:c},variables:d};return s.isComplexJoin(t)&&(u.resultType=l.Boolean),u},_getExpressionVariableRenamer:function(e,i){var a=e.resourceType;return e=n.extend({variables:i.variables},e),s.isCalcField(a)?n.bind(this._renameFieldPartInExpressionVariable,this,e):s.isTableReference(a)?n.bind(this._renameTablePartInExpressionVariable,this,e):void 0},_getAllVariablesReducer:function(e){var i=e.resourceType;return s.isCalcField(i)?n.bind(this._allVariablesFieldPartReducer,this,e):s.isTableReference(i)?n.bind(this._allVariablesTablePartReducer,this,e):void 0},_allVariablesTablePartReducer:function(e,i,a){var r,n=e.newName,s=e.originalName;return r=this._isVariableWithSameTableReferenceName(s,a)?t.join([n,a.fieldName],"\\","."):a.name,i.push({name:r,type:a.type}),i},_allVariablesFieldPartReducer:function(e,i,a){var r=this._getVariableName(e,a);return i.push({name:r,type:a.type}),i},_renameTablePartInExpressionVariable:function(e,i){var a=e.originalName,r=e.newName,n=e.variables,s=n[i];return this._isVariableWithSameTableReferenceName(a,s)?t.join([r,s.fieldName],"\\","."):i},_renameFieldPartInExpressionVariable:function(e,i){var a=e.variables,r=a[i];return this._getVariableName(e,r)},_getVariableName:function(e,i){var a=e.newName,r=e.resourceId;return this._isVariableWithSameFieldId(r,i)?i.fieldOnlyVariable?a:t.join([i.sourceName,a],"\\","."):i.name},_isVariableWithSameTableReferenceName:function(e,i){return(i.tableReferenceName||i.sourceName)===e&&!i.fieldOnlyVariable},_isVariableWithSameFieldId:function(e,i){return e===i.id}}),a.exports=c});