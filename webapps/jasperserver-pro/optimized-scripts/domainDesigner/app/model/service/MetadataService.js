/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","./util/dataSourceTypeUtil","../enum/metadataRequestLevelsEnum"],function(e,t,r){var a=e("jquery"),o=e("underscore"),s=e("./util/dataSourceTypeUtil"),n=e("../enum/metadataRequestLevelsEnum"),i=function(e){this.initialize(e)};o.extend(i.prototype,{initialize:function(e){e=e||{},this.restMetadataService=e.restMetadataService,this.metadataServiceCache=e.metadataServiceCache,this.profileAttributeResolver=e.profileAttributeResolver},getMetadata:function(e,t,r){return this._getMetadata(e,t,r)},_getMetadata:function(e,t,r){r=r||{},t=t||[];var s=new a.Deferred,n=this,i=null;try{i=this._getResourcesToFetch(e,t,r)}catch(e){return s.reject({responseJSON:{errorCode:e.message}}),s.promise()}var u={dataSourceUri:e,resourcesToFetch:i,resources:t,additionalOptions:r};if(this._shouldLoadMetadataFromServer(u))this._convertResourcesToServerFormat(u).then(function(e){return n._getMetadataInternal(o.extend({resourcesInServerFormat:e},u))}).then(function(e){s.resolve(e)},function(e){s.reject(e)});else{var c=this._getMetadataFromCache({dataSourceUri:e,resources:t});s.resolve(c)}return s.promise()},_getMetadataInternal:function(e){var t=e.dataSourceUri,r=e.resources,a=e.resourcesToFetch,o=e.resourcesInServerFormat,s=e.additionalOptions,n=this;return this.restMetadataService.getMetadata(t,o,s).then(function(e){return n.metadataServiceCache.add({dataSourceUri:t,resources:a,data:e}),n._getMetadataFromCache({dataSourceUri:t,resources:r})})},_getResourcesToFetch:function(e,t,r){var a=this._getNotCachedResources({dataSourceUri:e,resources:t,refresh:r.refresh});return this._resolveResources(a)},_getNotCachedResources:function(e){var t=e.dataSourceUri,r=e.resources;return e.refresh?r:o.filter(r,function(e){var r=this.metadataServiceCache.get({dataSourceUri:t,path:e});return!Boolean(r)},this)},_resolveResources:function(e){return o.map(e,function(e){return o.map(e,function(e){return this.profileAttributeResolver.resolve(e)},this)},this)},_convertResourcesToServerFormat:function(e){var t=e.resourcesToFetch,r=e.additionalOptions,i=e.dataSourceUri,u=new a.Deferred;return 0===t.length?u.resolve(t):this._getMetadata(i,[],r).then(function(e){var r=s.getDataSourceType(e);return o.map(t,function(e){return o.reduce(e,function(e,t,a){return e[n[r][a]]=t,e},{})})}).then(u.resolve,u.reject),u.promise()},_shouldLoadMetadataFromServer:function(e){var t=e.dataSourceUri,r=e.resourcesToFetch,a=e.resources,s=e.additionalOptions.refresh,n=o.isEmpty(a)&&this._isRootLevelCacheEmpty(t),i=!o.isEmpty(a)&&r.length;return s||n||i},_isRootLevelCacheEmpty:function(e){var t=this.metadataServiceCache.get({dataSourceUri:e,path:[]});return o.isEmpty(t)},_getMetadataFromCache:function(e){var t,r=e.dataSourceUri,a=e.resources;return a.length>0?(t=o.reduce(a,function(e,t){var a=this.metadataServiceCache.get({dataSourceUri:r,path:t});return a&&(e.notSingleResourceWasFoundInCache=!1,e.data.push(a)),e},{data:[],notSingleResourceWasFoundInCache:!0},this),t=t.notSingleResourceWasFoundInCache?void 0:t.data):t=this.metadataServiceCache.get({dataSourceUri:r,path:a}),t}}),r.exports=i});