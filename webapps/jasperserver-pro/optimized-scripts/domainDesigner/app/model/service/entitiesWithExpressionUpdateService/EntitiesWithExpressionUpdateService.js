/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore"],function(e,t,i){var s=e("jquery"),n=e("underscore"),r=function(e){this.initialize(e)};n.extend(r.prototype,{initialize:function(e){this.validationService=e.validationService,this.entitiesProviders=e.entitiesProviders,this.expressionWithContextProviders=e.expressionWithContextProviders,this.expressionUpdaters=e.expressionUpdaters},update:function(e){var t=this._getEntitiesAndExpressionsWithContext(e),i=this,r=t.entitiesExpressionsWithContext;return n.size(r)>0?this.validationService.validateDOMElCollection(r).then(function(s){var n=t.entitiesPerProvider,r=i._splitExpressionsContextByEntitiesPerProvider({expressionContexts:s.expressionContexts,entitiesPerProvider:n});return i._updateExpressions(r,n),e}):(new s.Deferred).resolve(e)},_getEntitiesAndExpressionsWithContext:function(e){var t=this;return n.reduce(this.expressionWithContextProviders,function(i,s,n){var r=t.entitiesProviders[n].getEntities(e),o=s.getExpressionsWithContext(r,e);return i.entitiesPerProvider.push(r),i.entitiesExpressionsWithContext=i.entitiesExpressionsWithContext.concat(o),i},{entitiesPerProvider:[],entitiesExpressionsWithContext:[]})},_splitExpressionsContextByEntitiesPerProvider:function(e){var t=0,i=e.expressionContexts,s=e.entitiesPerProvider;return n.map(s,function(e){var s=t+e.length,n=i.slice(t,s);return t=s,n})},_updateExpressions:function(e,t){n.each(this.expressionUpdaters,function(i,s){i.update(e[s],t[s])})}}),i.exports=r});