/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","../../../rest/enum/mimeTypesEnum","runtime_dependencies/js-sdk/src/common/util/base64","../enum/canvasViewDesignersEnum","../util/resourcePropertiesUtil","../util/resourceNameSpecialCharactersUtil","../../util/uriUtil"],function(e,r,t){var i=e("jquery"),n=e("underscore"),a=e("../../../rest/enum/mimeTypesEnum"),s=e("runtime_dependencies/js-sdk/src/common/util/base64"),o=e("../enum/canvasViewDesignersEnum"),c=e("../util/resourcePropertiesUtil"),u=e("../util/resourceNameSpecialCharactersUtil"),d=e("../../util/uriUtil"),l=function(e){this.dataSourceInfoService=e.dataSourceInfoService,this.asyncServerSchemaModelParserService=e.asyncServerSchemaModelParserService,this.schemaModelConverter=e.schemaModelConverter,this.serverResourcePropertiesModelParser=e.serverResourcePropertiesModelParser,this.entitiesWithExpressionUpdateService=e.entitiesWithExpressionUpdateService,this.parametrizedSchemaResolvingService=e.parametrizedSchemaResolvingService,this.resourcesService=e.resourcesService,this.designerViewStateByDomainProvider=e.designerViewStateByDomainProvider,this.encryptedProfileAttributeErrorSpecification=e.encryptedProfileAttributeErrorSpecification};n.extend(l.prototype,{getInitialDesignerStateByDataSourceUri:function(e){var r=this;return this.dataSourceInfoService.getDataSourceInfo(e).then(function(t){var i=r._createInitialDomainResource(e);return r.asyncServerSchemaModelParserService.parse(i.schema).then(function(e){return{schema:r.schemaModelConverter.toJSON(e),resourceProperties:r.serverResourcePropertiesModelParser.parse(i),viewState:r.designerViewStateByDomainProvider.getViewState(e,{dataSourceType:t.type})}})})},getInitialDesignerStateByDomainResource:function(e){var r=this,t=c.getEmbeddedResourceUri(e.dataSource);e=this._updateDomainWithGroupIfItIsAbsent(e);var n=this.dataSourceInfoService.getDataSourceInfo(t);return this.asyncServerSchemaModelParserService.parse(e.schema).then(function(t){var a=r._getUpdatedClientDomainSchema(t),s=r._loadAllSubResources(e),c=r._cacheParametrizedSchemas(t);return i.when(n,a,s,c).then(function(i,n,a){var s=r.designerViewStateByDomainProvider.getViewState(t,{dataSourceType:i.type,currentDesigner:o.PRESENTATION_DESIGNER});return{schema:n,resourceProperties:r.serverResourcePropertiesModelParser.parse(e,{securityFileContent:a[0],bundlesContent:a[1]}),viewState:s}})})},_cacheParametrizedSchemas:function(e){var r=this,t=i.Deferred();return this.parametrizedSchemaResolvingService.resolve(e).then(function(){t.resolve()},function(e){r.encryptedProfileAttributeErrorSpecification.isSatisfiedBy(e)?t.reject(e):t.resolve()}),t},_updateDomainWithGroupIfItIsAbsent:function(e){if(!this._getFirstResourcesGroup(e)){var r=e.schema.resources,t=c.getEmbeddedResourceUri(e.dataSource);r.push.apply(r,this._getInitialResourcesPartOfTheSchema(t))}return e},createInitialDomainResource:function(e){return this._createInitialDomainResource(e)},_createInitialDomainResource:function(e){return{dataSource:this._getInitialDataSourcePartOfTheSchema(e),schema:{resources:this._getInitialResourcesPartOfTheSchema(e)}}},_getInitialDataSourcePartOfTheSchema:function(e){return{dataSourceReference:{uri:e}}},_getInitialResourcesPartOfTheSchema:function(e){return[{group:{name:this._getDataSourceNameFromUri(e),elements:[]}}]},_getDataSourceNameFromUri:function(e){var r=d.getLastSegment(e);return u.replaceResourceNameSpecialCharacters(r)},_getFirstResourcesGroup:function(e){return n.chain(e.schema.resources).pluck("group").compact().first().value()},_getUpdatedClientDomainSchema:function(e){var r=this;return this.entitiesWithExpressionUpdateService.update(e).then(function(e){return r.schemaModelConverter.toJSON(e)})},_loadAllSubResources:function(e){return i.when(this._loadSecurityFileContent(e),this._loadBundlesContent(e))},_loadSecurityFileContent:function(e){var r=e.securityFile,t=e.uri,n=this;if(r){var s=c.getEmbeddedResourceUri(r);if(c.isResourceDomainSubResource(s,t))return n._loadBase64EncodedResource(s,a.GENERIC_XML)}return(new i.Deferred).resolve(null)},_loadBundlesContent:function(e){var r=e.bundles,t=e.uri,n=this;if(r&&r.length>0){var s=r.map(function(e){var r=e.file,s=c.getFirstKeyValue(r),o=s.uri;return c.isResourceDomainSubResource(o,t)?n._loadBase64EncodedResource(o,a.BUNDLE_PROPERTIES):(new i.Deferred).resolve(null)});return i.when.apply(i,s).then(function(){return Array.prototype.slice.call(arguments,0)})}return(new i.Deferred).resolve([])},_loadBase64EncodedResource:function(e,r){return this.resourcesService.getResource(e,{type:r,dataType:"text"}).then(function(e){return{raw:e,base64:s.encode(e)}})}}),t.exports=l});