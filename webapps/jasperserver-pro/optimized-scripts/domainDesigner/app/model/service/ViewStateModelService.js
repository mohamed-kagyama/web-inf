/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../util/clientSchemaModelUtil","../../../model/schema/util/entityUtil","../util/presentationItemsSelectionUtil","../util/currentSidebarResourceUtil","../util/defaultValueUtil","../enum/canvasViewDesignersEnum","../../../model/schema/enum/schemaEntitiesEnum","../enum/viewStateModelDefaultsEnum","../enum/draftStateTypesEnum","../../component/layout/sidebarView/enum/artificialTreeResourceTypesEnum"],function(e,t,i){var n=e("underscore"),s=e("../util/clientSchemaModelUtil"),r=e("../../../model/schema/util/entityUtil"),a=e("../util/presentationItemsSelectionUtil"),o=e("../util/currentSidebarResourceUtil"),d=e("../util/defaultValueUtil"),c=e("../enum/canvasViewDesignersEnum"),l=e("../../../model/schema/enum/schemaEntitiesEnum"),S=e("../enum/viewStateModelDefaultsEnum"),u=e("../enum/draftStateTypesEnum"),p=e("../../component/layout/sidebarView/enum/artificialTreeResourceTypesEnum"),g=function(e){this.viewStateModel=e.viewStateModel,this.dataStore=e.dataStore,this.designerViewStateMetadataDesignerFirstDataSourceSelectionProvider=e.designerViewStateMetadataDesignerFirstDataSourceSelectionProvider,this.designerViewStateFiltersPositionsProvider=e.designerViewStateFiltersPositionsProvider,this.designerViewStateJoinTreesStateProvider=e.designerViewStateJoinTreesStateProvider,this.designerViewStateJoinsStateProvider=e.designerViewStateJoinsStateProvider};n.extend(g.prototype,{setCurrentDesigner:function(e){this.viewStateModel.setCurrentDesigner(e)},setState:function(e){this.viewStateModel.set(e)},setCurrentResource:function(e,t){this._setCurrentResource(e,t)},replaceDataSource:function(e){var t=e.name,i=e.type,n=this.viewStateModel.getCurrentDesigner();this._resetViewStateModel(),this._setDataSource(t,i),this.viewStateModel.setCurrentDesigner(n)},closeSaveDialog:function(){},showClearAllDataDialog:function(){},openEmptyDataIslandAlertDialog:function(){},closeEmptyDataIslandAlertDialog:function(){},expandSidebarNode:function(e){this._expandSidebarNode(e);var t=this._getToggledNodeRelatedItem(e);t&&this._expandSidebarNode(t)},collapseSidebarNode:function(e){this._collapseSidebarNode(e);var t=this._getToggledNodeRelatedItem(e);t&&this._collapseSidebarNode(t)},addDataSourceGroupsOrTables:function(e,t){var i=this._getMetadataDesignerSpecificProperty("selectedResource");this._addNodeToExpandedNodes(i),this._setMetadataDesignerTreesSelection(e),this._setAddMetadataResourcesError(t)},removeDataSourceGroups:function(e){this._cleanupViewState(),this._setMetadataDesignerTreesSelection(e),this._clearAddResourcesError()},removeTables:function(e){this._cleanupViewState(),this._setMetadataDesignerTreesSelection(e),this._clearAddResourcesError()},removeDerivedTable:function(){this._cleanupViewState()},addSchemaAttribute:function(){this._setMetadataDesignerTreesSelection({resultTreeSelection:[]});var e=this._getMetadataDesignerSpecificProperty("selectedResource");this._addNodeToExpandedNodes(e)},setMetadataDesignerSourceTreeSelection:function(e){this._setMetadataDesignerTreesSelection({sourceTreeSelection:e}),this._clearAddResourcesError()},setMetadataDesignerResultTreeSelection:function(e){this._setMetadataDesignerTreesSelection({resultTreeSelection:e})},setMetadataDesignerSourceTreeSearchKeyword:function(e){var t=this._getMetadataDesignerSpecificProperty("searchKeyword"),i=this._getMetadataDesignerSpecificProperty("selectedResource");t.sourceTree[i.id]=e,this._setMetadataDesignerSpecificProperty("searchKeyword",t)},setMetadataDesignerResultTreeSearchKeyword:function(e){var t=this._getMetadataDesignerSpecificProperty("searchKeyword"),i=this._getMetadataDesignerSpecificProperty("selectedResource");t.resultTree[i.id]=e,this._setMetadataDesignerSpecificProperty("searchKeyword",t)},setMetadataDesignerSidebarSearchKeyword:function(e){this._setDesignerSidebarSearchKeyword(e)},setAddMetadataResourcesError:function(e){this._setAddMetadataResourcesError(e)},setMetadataDesignerCurrentSidebarResource:function(e){this._setMetadataDesignerCurrentSidebarResource(e)},createDerivedTable:function(e){this._addNodeToExpandedNodes({resourceId:e,type:l.DATA_SOURCE}),this._addNodeToExpandedNodes({resourceId:p.DERIVED_TABLE_GROUP,type:p.DERIVED_TABLE_GROUP})},setJoinsDesignerSidebarSearchKeyword:function(e){this._setDesignerSidebarSearchKeyword(e)},setJoinsDesignerSearchKeyword:function(e){var t=this._getJoinsDesignerSpecificProperty("searchKeyword");t.canvas=e,this._setJoinsDesignerSpecificProperty("searchKeyword",t)},setJoinsDesignerCurrentResource:function(e){this._setJoinsDesignerCurrentSidebarResource(e.resource)},generateJoins:function(){this._cleanUpSidebarExpandedNodes(),this.viewStateModel.resetDesigner(c.JOINS_DESIGNER),this.viewStateModel.resetDesigner(c.FILTERS_DESIGNER),this.viewStateModel.resetDesigner(c.PRESENTATION_DESIGNER),this._setJoinTreesInitialViewState(),this._setFiltersInitialViewState(),this._setJoinsInitialViewState()},removeJoin:function(){this._cleanupViewStateFromJoinsDesigner()},removeJoinAlias:function(){this._cleanupViewStateFromJoinsDesigner()},removeJoinExpression:function(){this._cleanupViewStateFromJoinsDesigner()},removeTableReference:function(){this._cleanupViewStateFromJoinsDesigner()},removeJoinTree:function(){this._cleanupViewStateFromJoinsDesigner()},createJoinExpression:function(e){this._createJoinExpression(e)},createJoinTreeWithJoinExpression:function(e){var t=e.index,i=e.joinExpression,s=this.dataStore.getCollection("joinTrees").toArray(),r=s[t],a={};a[r.id]=this.designerViewStateJoinTreesStateProvider.getJoinTreeViewState();var o=this._getJoinsDesignerSpecificProperty("joinTrees");this._setJoinsDesignerSpecificProperty("joinTrees",n.extend({},o,a)),this._createJoinExpression(i),this._setDraftJoinTreeState({}),this._addNodeToExpandedNodes({resourceId:r.id,type:l.JOIN_TREE})},setJoinConstructorState:function(e){this._setJoinConstructorState(e)},setDraftJoinTreeState:function(e){this._setDraftJoinTreeState(e)},toggleJoinTree:function(e,t){var i=this._getJoinsDesignerSpecificProperty("joinTrees");i[e].isExpanded=t,this._setJoinsDesignerSpecificProperty("joinTrees",i)},toggleJoin:function(e){var t=e.joinId,i=this._getJoinsDesignerSpecificProperty("joins");i[t].isExpanded=e.isExpanded,this._setJoinsDesignerSpecificProperty("joins",i)},addConstantDataIsland:function(e){var t=this.dataStore.getCollection("dataIslands"),i=t.findWhere({sourceType:l.CONSTANT_GROUP}),s=n.extend({parentId:i.getId()},e.selection);s=this._getPresentationCanvasSelectionAfterNewItemsWereAdded(s),this._setPresentationDesignerSelection(s)},addDataIslands:function(e){var t,i=e.selection,s=i.selectChildren,r=this.dataStore.getCollection("dataIslands");i=n.extend({},i,{parentId:null}),s&&(t=r.find(function(t,i){return i===e.position}),i.parentId=t.id),e=n.extend({},e,{selection:i}),this._addPresentationItems(e)},addPresentationItems:function(e){this._addPresentationItems(e)},addPresentationSet:function(e){var t=e.parent;r.isDataIsland(t.type)?this._setPresentationDesignerDataIslandNodeExpandedState(t.id,!0):r.isPresentationSet(t.type)&&this._setPresentationDesignerPresentationSetNodeExpandedState(t.id,!0)},presentationDesignerReorderDataIslands:function(){this._updatePresentationDataIslandsSelectionIndexes()},presentationDesignerReorderPresentationItems:function(e){this._updatePresentationSetsAndItemsSelectionIndexesAndParentId(e)},setPresentationDesignerSidebarSearchKeyword:function(e){this._setDesignerSidebarSearchKeyword(e)},setPresentationDesignerSearchKeyword:function(e){var t=this._getPresentationDesignerSpecificProperty("searchKeyword");t.canvas=e,this._setPresentationDesignerSpecificProperty("searchKeyword",t)},setPresentationDesignerSelection:function(e){this._setPresentationDesignerSelection(e)},setPresentationDesignerSidebarSelection:function(e){this._setPresentationDesignerSpecificProperty("sidebarSelection",e)},removeDataIslands:function(){this._cleanupViewStateFromPresentationDesigner()},removePresentationItems:function(){this._cleanupViewStateFromPresentationDesigner()},updatePresentationDataIslandsSelectionIndexes:function(){this._updatePresentationDataIslandsSelectionIndexes()},updatePresentationSetsAndItemsSelectionIndexesAndParentId:function(e){this._updatePresentationSetsAndItemsSelectionIndexesAndParentId(e)},setPresentationDesignerDataIslandNodeExpandedState:function(e,t){this._setPresentationDesignerDataIslandNodeExpandedState(e,t)},setPresentationDesignerPresentationSetNodeExpandedState:function(e,t){this._setPresentationDesignerPresentationSetNodeExpandedState(e,t)},setPresentationDesignerDataIslandEditorExpandedState:function(e,t){var i=this._getPresentationDesignerSpecificProperty("dataIslands");i=this._setPresentationDesignerItemExpandedState({itemType:l.DATA_ISLAND,presentationItems:i,presentationItemId:e,isEditorExpanded:t}),this._setPresentationDesignerSpecificProperty("dataIslands",i)},setPresentationDesignerPresentationSetEditorExpandedState:function(e,t){var i=this._getPresentationDesignerSpecificProperty("presentationSets");i=this._setPresentationDesignerItemExpandedState({itemType:l.PRESENTATION_SET,presentationItems:i,presentationItemId:e,isEditorExpanded:t}),this._setPresentationDesignerSpecificProperty("presentationSets",i)},setPresentationDesignerPresentationFieldEditorExpandedState:function(e,t){var i=this._getPresentationDesignerSpecificProperty("presentationFields");i=this._setPresentationDesignerItemExpandedState({itemType:l.PRESENTATION_FIELD,presentationItems:i,presentationItemId:e,isEditorExpanded:t}),this._setPresentationDesignerSpecificProperty("presentationFields",i)},setColumnSet:function(e){this._setPresentationDesignerSpecificProperty("columnSet",e)},expandAllPresentationItems:function(){this._setPresentationDesignerSpecificProperty("defaultPresentationItemsNodeExpandedState",!0),this._setPresentationDesignerSpecificProperty("defaultPresentationItemsEditorExpandedState",!0),this._setPresentationDesignerAllItemsExpandedState()},collapseAllPresentationItems:function(){this._setPresentationDesignerSpecificProperty("defaultPresentationItemsNodeExpandedState",!1),this._setPresentationDesignerSpecificProperty("defaultPresentationItemsEditorExpandedState",!1),this._setPresentationDesignerAllItemsExpandedState()},updatePresentationDesignerCellsWidth:function(e){this.viewStateModel.setDesignerSpecificRuntimeProperty(c.PRESENTATION_DESIGNER,"cellsWidth",e)},showCalculatedFieldsDesigner:function(e){e=e||{};var t=S.CALCULATED_FIELDS_DESIGNER.VISIBILITY,i=this._getCalculatedFieldsDesignerSpecificRuntimeProperty("context");this._setCalculatedFieldsDesignerSpecificRuntimeProperty(t.property,!t.value),d.setPropertyValueOrDefault(i,S.CALCULATED_FIELDS_DESIGNER.CONTEXT.SOURCE_ID.property,e.sourceId),d.setPropertyValueOrDefault(i,S.CALCULATED_FIELDS_DESIGNER.CONTEXT.SOURCE_TYPE.property,e.sourceType),d.setPropertyValueOrDefault(i,S.CALCULATED_FIELDS_DESIGNER.CONTEXT.SOURCE_NAME.property,e.sourceName),d.setPropertyValueOrDefault(i,S.CALCULATED_FIELDS_DESIGNER.CONTEXT.CALC_FIELD_ID.property,e.calcFieldId)},hideCalculatedFieldsDesigner:function(){this._hideCalculatedFieldsDesigner()},addCalcField:function(e){var t,i,n,s=this.dataStore.getCollection("joinAliases");e.sourceType===p.CONSTANT_GROUP?(i=p.CONSTANT_GROUP,n=p.CONSTANT_GROUP):(i=e.sourceId,n=e.sourceType,e.sourceType===l.TABLE_REFERENCE&&(t=s.byField("tableReferenceId",e.sourceId))&&(i=t.id,n=l.JOIN_ALIAS)),this._addNodeToExpandedNodes({resourceId:i,type:n}),this._hideCalculatedFieldsDesigner()},removeCalcField:function(){this._cleanupViewState()},setFiltersDesignerSidebarSearchKeyword:function(e){this._setDesignerSidebarSearchKeyword(e)},setFiltersDesignerSearchKeyword:function(e){var t=this._getFiltersDesignerSpecificProperty("searchKeyword");t.canvas=e,this._setFiltersDesignerSpecificProperty("searchKeyword",t)},_setDraftStateByType:function(e,t){var i=this.viewStateModel.getDraftState();i[e]=t,this.viewStateModel.setDraftState(i)},clearDraftState:function(e){var t=this.viewStateModel.getDraftState(),i={};n.isEmpty(e)||(i=n.reduce(e,function(e,t){return e[t]&&(e[t]={}),e},t)),this.viewStateModel.setDraftState(i)},cancelDraftFilter:function(){this.setDraftFilter({})},setDraftFilter:function(e){this._setDraftStateByType(u.DRAFT_FILTER,e)},addFilter:function(){var e=this.dataStore.getCollection("filters").last(),t=e.getId(),i=this._getFiltersDesignerSpecificProperty("filtersPositions");i[t]=this.designerViewStateFiltersPositionsProvider.getNextFilterPosition(),this._setFiltersDesignerSpecificProperty("filtersPositions",i),this.setDraftFilter({})},removeFilter:function(e){var t=e.id,i=this._getFiltersDesignerSpecificProperty("filtersPositions");i=n.omit(i,String(t)),this._setFiltersDesignerSpecificProperty("filtersPositions",i)},setFiltersDesignerCurrentResource:function(e){this._setCurrentResource(c.FILTERS_DESIGNER,e.resource)},_expandSidebarNode:function(e){this._getCurrentDesignerSearchKeyword().sidebar?this._removeNodeFromCollapsedNodes(e.resourceId):this._addNodeToExpandedNodes(e)},_collapseSidebarNode:function(e){this._getCurrentDesignerSearchKeyword().sidebar?this._addNodeToCollapsedNodes(e):this._removeNodeFromExpandedNodes(e.resourceId)},_getToggledNodeRelatedItem:function(e){var t,i,n,s,a,o=e.resourceId,d=this.dataStore.getCollections();if(r.isDerivedTable(e.type)?(t=l.TABLE_REFERENCE,s=d.tableReferences.findWhere({tableId:o}),(i=d.joinAliases.findWhere({tableReferenceId:s.id}))&&(s=i,t=l.JOIN_ALIAS)):r.isTableReference(e.type)?(n=d.tableReferences.byId(o),a=d.tables.byId(n.tableId),r.isDerivedTable(a)&&(s=a),t=l.DERIVED_TABLE):r.isJoinAlias(e.type)&&(i=d.joinAliases.byId(o),n=d.tableReferences.byId(i.tableReferenceId),a=d.tables.byId(n.tableId),r.isDerivedTable(a)&&(s=a),t=l.DERIVED_TABLE),s)return{resourceId:s.id,type:t}},_addNodeToExpandedNodes:function(e){var t=this.viewStateModel.getSidebarExpandedNodes();t[e.resourceId]={type:e.type},this.viewStateModel.setSidebarExpandedNodes(t)},_removeNodeFromExpandedNodes:function(e){var t=this.viewStateModel.getSidebarExpandedNodes();delete t[e],this.viewStateModel.setSidebarExpandedNodes(t)},_addNodeToCollapsedNodes:function(e){var t=this.viewStateModel.getSidebarCollapsedNodes();t[e.resourceId]={type:e.type},this.viewStateModel.setSidebarCollapsedNodes(t)},_removeNodeFromCollapsedNodes:function(e){var t=this.viewStateModel.getSidebarCollapsedNodes();delete t[e],this.viewStateModel.setSidebarCollapsedNodes(t)},_getCurrentDesignerSearchKeyword:function(){var e=this.viewStateModel.getCurrentDesigner();return this.viewStateModel.getDesignerSpecificProperty(e,"searchKeyword")},_setDesignerSidebarSearchKeyword:function(e){var t=this.viewStateModel.getCurrentDesigner(),i=this.viewStateModel.getDesignerSpecificProperty(t,"searchKeyword");i.sidebar=e,e&&this.viewStateModel.setSidebarCollapsedNodes({}),this.viewStateModel.setDesignerSpecificProperty(t,"searchKeyword",i)},_selectFirstDataSourceInMetadataSidebar:function(){var e=this.dataStore.getCollection("dataSources"),t=this.designerViewStateMetadataDesignerFirstDataSourceSelectionProvider.getSidebarSelectedResource(e);this._setMetadataDesignerCurrentSidebarResource(t)},_resetViewStateModel:function(){this.viewStateModel.reset(),this._setJoinTreesInitialViewState(),this._setJoinsInitialViewState(),this._setFiltersInitialViewState(),this._selectFirstDataSourceInMetadataSidebar()},_hideCalculatedFieldsDesigner:function(){var e=S.CALCULATED_FIELDS_DESIGNER.VISIBILITY;this._setCalculatedFieldsDesignerSpecificRuntimeProperty(e.property,e.value),this._setCalculatedFieldsDesignerSpecificRuntimeProperty("context",{})},_setAddMetadataResourcesError:function(e){this._setMetadataDesignerSpecificRuntimeProperty("addResourcesError",e)},_setMetadataDesignerCurrentSidebarResource:function(e){this._setMetadataDesignerSpecificProperty("selectedResource",e)},_setMetadataDesignerTreesSelection:function(e){var t=e.sourceTreeSelection,i=e.resultTreeSelection,n=this._getMetadataDesignerSpecificProperty("selection"),s=this._getMetadataDesignerSpecificProperty("selectedResource");t&&(n.sourceTree[s.resourceId]=t),i&&(n.resultTree[s.resourceId]=i),this._setMetadataDesignerSpecificProperty("selection",n)},_setCurrentResource:function(e,t){this.viewStateModel.setCurrentResource(e,t)},_setJoinConstructorState:function(e){this._setDraftStateByType(u.JOIN_CONSTRUCTOR,e)},_setDraftJoinTreeState:function(e){this._setDraftStateByType(u.DRAFT_JOIN_TREE,e)},_addPresentationItems:function(e){var t=e.selection;t&&(t=this._getPresentationCanvasSelectionAfterNewItemsWereAdded(t),this._setPresentationDesignerSelection(t))},_setPresentationDesignerDataIslandNodeExpandedState:function(e,t){var i=this._getPresentationDesignerSpecificProperty("dataIslands");i=this._setPresentationDesignerItemExpandedState({itemType:l.DATA_ISLAND,presentationItems:i,presentationItemId:e,isNodeExpanded:t}),this._setPresentationDesignerSpecificProperty("dataIslands",i)},_setPresentationDesignerPresentationSetNodeExpandedState:function(e,t){var i=this._getPresentationDesignerSpecificProperty("presentationSets");i=this._setPresentationDesignerItemExpandedState({itemType:l.PRESENTATION_SET,presentationItems:i,presentationItemId:e,isNodeExpanded:t}),this._setPresentationDesignerSpecificProperty("presentationSets",i)},_setPresentationDesignerSelection:function(e){this._setPresentationDesignerSpecificProperty("selection",e)},_updatePresentationDataIslandsSelectionIndexes:function(){var e;this._getPresentationDesignerSpecificProperty("selection").parentId||(e=this._getPresentationDataIslandsSelectionWithUpdatedParentAndIndexes(),this._setPresentationDesignerSpecificProperty("selection",e))},_updatePresentationSetsAndItemsSelectionIndexesAndParentId:function(e){e=e||{};var t,i=this._getPresentationDesignerSpecificProperty("selection");i.parentId&&(t=this._getPresentationSetsAndFieldsSelectionWithUpdatedParentAndIndexes(e),this._setPresentationDesignerSpecificProperty("selection",t))},_getPresentationDataIslandsSelectionWithUpdatedParentAndIndexes:function(){var e=this.dataStore.getCollection("dataIslands"),t=this._getPresentationDesignerSpecificProperty("selection");return this._getPresentationItemsSelectionWithUpdatedIndexesAndParent({selection:t,collection:e})},_getPresentationSetsAndFieldsSelectionWithUpdatedParentAndIndexes:function(e){var t=this._getPresentationDesignerSpecificProperty("selection"),i=e.parentId||t.parentId,n=this.dataStore.getCollections(),r=s.getDataIslandOrPresentationSetById(i,n);return this._getPresentationItemsSelectionWithUpdatedIndexesAndParent({parentId:i,selection:t,collection:r.getChildren()})},_getPresentationItemsSelectionWithUpdatedIndexesAndParent:function(e){var t={parentId:null},i=e.selection,r=e.collection,a=e.parentId||i.parentId,o=n.find(i.items,function(e){return e.rangeSelectionStartItem}),d=n.reduce(i.items,function(e,t){var i=s.getResourceIndexInCollectionById(t.id,r);return n.isUndefined(i)||(t.index=i,t.parentId=a,o||0!==i||(t.rangeSelectionStartItem=!0),e[t.id]=t),e},{},this);return t.items=d,n.isEmpty(d)||(t.parentId=a),t},_getPresentationCanvasSelectionAfterNewItemsWereAdded:function(e){var t=e.parentId,i=this._getCollectionForNewPresentationCanvasSelectionGeneration(t),s=e.itemsQuantity,a=this._getPositionOffsetForNewPresentationCanvasSelection(e,i);return{items:n.reduce(new Array(s),function(e,n,s){var o=s+a,d=i[o],c={dataIslandId:d.dataIslandId,id:d.id,index:o,parentId:t,type:r.getEntityName(d)};return 0===s&&(c.rangeSelectionStartItem=!0),e[c.id]=c,e},{}),parentId:t}},_getPositionOffsetForNewPresentationCanvasSelection:function(e,t){return n.isUndefined(e.positionOffset)?t.length-e.itemsQuantity:e.positionOffset},_getCollectionForNewPresentationCanvasSelectionGeneration:function(e){var t,i;return e?(t=s.getDataIslandOrPresentationSetById(e,this.dataStore.getCollections()),i=t.getChildren().toArray()):i=this.dataStore.getCollection("dataIslands").toArray(),i},_setJoinsDesignerCurrentSidebarResource:function(e){this._setCurrentResource(c.JOINS_DESIGNER,e)},_setFiltersInitialViewState:function(){var e=this.dataStore.getCollection("filters"),t=this.designerViewStateFiltersPositionsProvider.getFiltersPositionsByFilters(e);this._setFiltersDesignerSpecificProperty("filtersPositions",t)},_clearAddResourcesError:function(){this._setMetadataDesignerSpecificRuntimeProperty("addResourcesError",{popoverMessage:"",highlightInvalidResources:!1})},_createJoinExpression:function(e){var t=e.leftTableReferenceId,i=e.rightTableReferenceId;this._removeNodeFromExpandedNodes(t),this._removeNodeFromExpandedNodes(i);var n=this._getToggledNodeRelatedItem({resourceId:t,type:l.TABLE_REFERENCE}),s=this._getToggledNodeRelatedItem({resourceId:i,type:l.TABLE_REFERENCE});n&&this._removeNodeFromExpandedNodes(n.resourceId),s&&this._removeNodeFromExpandedNodes(s.resourceId),this._setCurrentResource(c.JOINS_DESIGNER,o.getJoinsDesignerCurrentSidebarResource()),this._setJoinConstructorState({}),this._addJoin()},_addJoin:function(){var e=this._getJoinsDesignerSpecificProperty("joins"),t=this.dataStore.getCollection("joins"),i=this.dataStore.getCollection("joinExpressions"),n=i.last(),s=n.getJoinId(),r=t.byId(s);e[s]||(e[s]={isExpanded:!0,originalWeight:r.getWeight()}),this._setJoinsDesignerSpecificProperty("joins",e)},_setDataSource:function(e,t){this.viewStateModel.setDataSource(e,{type:t})},_setMetadataDesignerSpecificProperty:function(e,t){this.viewStateModel.setDesignerSpecificProperty(c.METADATA_DESIGNER,e,t)},_getMetadataDesignerSpecificProperty:function(e){return this.viewStateModel.getDesignerSpecificProperty(c.METADATA_DESIGNER,e)},_setJoinsDesignerSpecificProperty:function(e,t){this.viewStateModel.setDesignerSpecificProperty(c.JOINS_DESIGNER,e,t)},_getJoinsDesignerSpecificProperty:function(e){return this.viewStateModel.getDesignerSpecificProperty(c.JOINS_DESIGNER,e)},_getJoinsDesignerSpecificRuntimeProperty:function(e){return this.viewStateModel.getDesignerSpecificRuntimeProperty(c.JOINS_DESIGNER,e)},_setFiltersDesignerSpecificProperty:function(e,t){this.viewStateModel.setDesignerSpecificProperty(c.FILTERS_DESIGNER,e,t)},_getFiltersDesignerSpecificProperty:function(e){return this.viewStateModel.getDesignerSpecificProperty(c.FILTERS_DESIGNER,e)},_setPresentationDesignerSpecificProperty:function(e,t){this.viewStateModel.setDesignerSpecificProperty(c.PRESENTATION_DESIGNER,e,t)},_getPresentationDesignerSpecificProperty:function(e){return this.viewStateModel.getDesignerSpecificProperty(c.PRESENTATION_DESIGNER,e)},_setPresentationDesignerAllItemsExpandedState:function(){this._setPresentationDesignerItemsExpandedState(l.DATA_ISLAND),this._setPresentationDesignerItemsExpandedState(l.PRESENTATION_SET),this._setPresentationDesignerItemsExpandedState(l.PRESENTATION_FIELD)},_getPresentationDesignerItemInfo:function(e){var t,i=S.EMPTY_OBJECT;return e===l.DATA_ISLAND?(t="dataIslands",i=S.PRESENTATION_DESIGNER.DATA_ISLAND.value):e===l.PRESENTATION_SET?(t="presentationSets",i=S.PRESENTATION_DESIGNER.PRESENTATION_SET.value):e===l.PRESENTATION_FIELD&&(t="presentationFields",i=S.PRESENTATION_DESIGNER.PRESENTATION_FIELD.value),{listName:t,defaultItemValue:i}},_setPresentationDesignerItemsExpandedState:function(e){var t=this._getPresentationDesignerItemInfo(e),i=this._getPresentationDesignerSpecificProperty(t.listName),s=this._getDefaultPresentationDesignerNodeExpandedState(),r=this._getDefaultPresentationDesignerEditorExpandedState();n.each(n.keys(i),function(t){i=this._setPresentationDesignerItemExpandedState({itemType:e,presentationItems:i,presentationItemId:t,isNodeExpanded:s,isEditorExpanded:r})},this),this._setPresentationDesignerSpecificProperty(t.listName,i)},_setPresentationDesignerItemExpandedState:function(e){var t=e.presentationItems,i=e.presentationItemId,s=e.itemType,r=t[i]||{};return n.isUndefined(e.isNodeExpanded)||this._setPresentationDesignerItemNodeExpandedState(r,e.isNodeExpanded),n.isUndefined(e.isEditorExpanded)||this._setPresentationDesignerItemEditorExpandedState(r,e.isEditorExpanded),d.setPropertyValueOrDefault(t,i,r,this._getPresentationDesignerItemInfo(s).defaultItemValue),t},_setPresentationDesignerItemNodeExpandedState:function(e,t){d.setPropertyValueOrDefault(e,S.PRESENTATION_DESIGNER.NODE_EXPANSION.property,t,this._getDefaultPresentationDesignerNodeExpandedState())},_setPresentationDesignerItemEditorExpandedState:function(e,t){d.setPropertyValueOrDefault(e,S.PRESENTATION_DESIGNER.PROPERTY_EDITOR_EXPANSION.property,t,this._getDefaultPresentationDesignerEditorExpandedState())},_getDefaultPresentationDesignerNodeExpandedState:function(){return this._getPresentationDesignerSpecificProperty("defaultPresentationItemsNodeExpandedState")},_getDefaultPresentationDesignerEditorExpandedState:function(){return this._getPresentationDesignerSpecificProperty("defaultPresentationItemsEditorExpandedState")},_setMetadataDesignerSpecificRuntimeProperty:function(e,t){this.viewStateModel.setDesignerSpecificRuntimeProperty(c.METADATA_DESIGNER,e,t)},_setCalculatedFieldsDesignerSpecificRuntimeProperty:function(e,t){this.viewStateModel.setDesignerSpecificRuntimeProperty(c.CALCULATED_FIELDS_DESIGNER,e,t)},_getCalculatedFieldsDesignerSpecificRuntimeProperty:function(e){return this.viewStateModel.getDesignerSpecificRuntimeProperty(c.CALCULATED_FIELDS_DESIGNER,e)},_setFiltersDesignerSpecificRuntimeProperty:function(e,t){this.viewStateModel.setDesignerSpecificRuntimeProperty(c.FILTERS_DESIGNER,e,t)},_getFiltersDesignerSpecificRuntimeProperty:function(e){return this.viewStateModel.getDesignerSpecificRuntimeProperty(c.FILTERS_DESIGNER,e)},_setJoinTreesInitialViewState:function(){var e=this.dataStore.getCollection("joinTrees"),t=this.designerViewStateJoinTreesStateProvider.getJoinTreesViewState(e);this._setJoinsDesignerSpecificProperty("joinTrees",t)},_setJoinsInitialViewState:function(){var e=this.dataStore.getCollection("joinTrees"),t=this.designerViewStateJoinsStateProvider.getJoinsViewStateByJoinTrees(e);this._setJoinsDesignerSpecificProperty("joins",t)},_cleanupViewState:function(){this._cleanUpSidebarExpandedNodes(),this._cleanupMetadataDesignerViewState(),this._cleanupJoinsDesignerViewState(),this._cleanupFiltersDesignerViewState(),this._cleanupPresentationDesignerViewState()},_cleanupMetadataDesignerViewState:function(){this._cleanupMetadataDesignerCurrentSidebarResource(),this._cleanupMetadataDesignerSourceTreeSelection(),this._cleanupMetadataDesignerResultTreeSelection()},_cleanupJoinsDesignerViewState:function(){this._cleanupJoinsDesignerCurrentSidebarResource(),this._cleanupJoinsDesignerDraftJoinTreeViewState(),this._cleanupJoinsDesignerJoinConstructorViewState(),this._cleanupJoinsDesignerJoinsViewState(),this._cleanupJoinsDesignerJoinTreesViewState()},_cleanupViewStateFromJoinsDesigner:function(){this._cleanUpSidebarExpandedNodes(),this._cleanupJoinsDesignerViewState(),this._cleanupFiltersDesignerViewState(),this._cleanupPresentationDesignerViewState()},_cleanupFiltersDesignerViewState:function(){this._cleanupFiltersDesignerCurrentSidebarResource()},_cleanupPresentationDesignerViewState:function(){this._cleanupPresentationItemsSidebarSelection(),this._cleanupPresentationItemsSelection(),this._cleanupPresentationDesignerDataIslandsViewProperties(),this._cleanupPresentationDesignerSetsViewProperties(),this._cleanupPresentationDesignerFieldsViewProperties(),this._updatePresentationDataIslandsSelectionIndexes(),this._updatePresentationSetsAndItemsSelectionIndexesAndParentId()},_cleanupViewStateFromPresentationDesigner:function(){this._cleanUpSidebarExpandedNodes(),this._cleanupPresentationDesignerViewState()},_cleanUpSidebarExpandedNodes:function(){var e=this.viewStateModel.getSidebarExpandedNodes(),t=this._getRemovedExpandedNodeIds(e);this.viewStateModel.setSidebarExpandedNodes(n.omit(e,t))},_cleanupMetadataDesignerSourceTreeSelection:function(){var e=this._getMetadataDesignerSpecificProperty("selection"),t=this._getMetadataDesignerCanvasSelection(e.sourceTree);e=n.extend({},e,{sourceTree:t}),this._setMetadataDesignerSpecificProperty("selection",e)},_cleanupMetadataDesignerResultTreeSelection:function(){var e=this._getMetadataDesignerSpecificProperty("selection"),t=this._getMetadataDesignerCanvasSelection(e.resultTree);e=n.extend({},e,{resultTree:t}),this._setMetadataDesignerSpecificProperty("selection",e)},_cleanupMetadataDesignerCurrentSidebarResource:function(){var e=o.getMetadataDesignerCurrentSidebarResource({currentSidebarResource:this._getMetadataDesignerSpecificProperty("selectedResource"),collections:this.dataStore.getCollections()});this._setCurrentResource(c.METADATA_DESIGNER,e)},_cleanupJoinsDesignerCurrentSidebarResource:function(){var e=o.getJoinsDesignerCurrentSidebarResource({currentSidebarResource:this._getJoinsDesignerSpecificProperty("selectedResource"),collections:this.dataStore.getCollections()});this._setJoinsDesignerCurrentSidebarResource(e)},_cleanupJoinsDesignerDraftJoinTreeViewState:function(){var e,t=this.dataStore.getCollection("tableReferences"),i=this.viewStateModel.getDraftState(),s=i[u.DRAFT_JOIN_TREE];n.isEmpty(s)||(e=s.joinConstructor.leftSide.tableReferenceId),e&&!t.byId(e)&&this._setDraftStateByType(u.DRAFT_JOIN_TREE,{})},_cleanupJoinsDesignerJoinConstructorViewState:function(){var e,t=this.dataStore.getCollection("tableReferences"),i=this.viewStateModel.getDraftState(),s=i[u.JOIN_CONSTRUCTOR];n.isEmpty(s)||(e=s.leftSide.tableReferenceId),e&&!t.byId(e)&&this._setDraftStateByType(u.JOIN_CONSTRUCTOR,{})},_cleanupJoinsDesignerJoinsViewState:function(){var e=this._getJoinsDesignerSpecificProperty("joins"),t=this._getRemovedResourcesIdsByCollection({collection:this.dataStore.getCollection("joins"),ids:n.keys(e)});this._setJoinsDesignerSpecificProperty("joins",n.omit(e,t))},_cleanupJoinsDesignerJoinTreesViewState:function(){var e=this._getJoinsDesignerSpecificProperty("joinTrees"),t=this._getRemovedResourcesIdsByCollection({collection:this.dataStore.getCollection("joinTrees"),ids:n.keys(e)});this._setJoinsDesignerSpecificProperty("joinTrees",n.omit(e,t))},_cleanupFiltersDesignerCurrentSidebarResource:function(){var e=o.getFiltersDesignerCurrentSidebarResource({currentSidebarResource:this._getFiltersDesignerSpecificProperty("selectedResource"),collections:this.dataStore.getCollections()});this._setCurrentResource(c.FILTERS_DESIGNER,e)},_cleanupPresentationDesignerDataIslandsViewProperties:function(){var e=this._getPresentationDesignerSpecificProperty("dataIslands"),t=this._getRemovedResourcesIdsByCollection({collection:this.dataStore.getCollection("dataIslands"),ids:n.keys(e)});this._setPresentationDesignerSpecificProperty("dataIslands",n.omit(e,t))},_cleanupPresentationDesignerSetsViewProperties:function(){var e=this._getPresentationDesignerSpecificProperty("presentationSets"),t=this._getRemovedResourcesIdsByCollection({collection:this.dataStore.getCollection("presentationSets"),ids:n.keys(e)});this._setPresentationDesignerSpecificProperty("presentationSets",n.omit(e,t))},_cleanupPresentationDesignerFieldsViewProperties:function(){var e=this._getPresentationDesignerSpecificProperty("presentationFields"),t=this._getRemovedResourcesIdsByCollection({collection:this.dataStore.getCollection("presentationFields"),ids:n.keys(e)});this._setPresentationDesignerSpecificProperty("presentationFields",n.omit(e,t))},_cleanupPresentationItemsSelection:function(){var e=a.getPresentationItemsSelection({currentSelection:this._getPresentationDesignerSpecificProperty("selection"),collections:this.dataStore.getCollections()});this._setPresentationDesignerSelection(e)},_cleanupPresentationItemsSidebarSelection:function(){var e=o.getPresentationItemsSidebarSelection({currentSelection:this._getPresentationDesignerSpecificProperty("sidebarSelection"),collections:this.dataStore.getCollections()});this._setPresentationDesignerSpecificProperty("sidebarSelection",e)},_getMetadataDesignerCanvasSelection:function(e){var t=this.dataStore.getCollections(),i=t.dataSources,s=t.dataSourceGroups;return n.reduce(e,function(e,t,n){
return(i.byId(n)||s.byId(n))&&(e[n]=t),e},{})},_getRemovedExpandedNodeIds:function(e){var t=n.map(e,function(e,t){var i=parseInt(t,10);return{id:n.isNaN(i)?t:i,type:e.type}});return this._getRemovedResourcesByIdsAndType(t).map(function(e){return String(e)})},_getRemovedResourcesByIdsAndType:function(e){var t=this.dataStore.getCollections();return n.reduce(e,function(e,i){return s.checkIfResourceExistsInSchemaByIdAndType(i.id,i.type,t)||e.push(i.id),e},[])},_getRemovedResourcesIdsByCollection:function(e){var t=e.collection.reduce(function(e,t){return e[t.id]=!0,e},{}),i=e.ids;return n.reduce(i,function(e,i){return t[i]||e.push(i),e},[])}}),i.exports=g});