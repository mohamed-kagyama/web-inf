/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../model/schema/enum/schemaEntitiesEnum","../../../model/schema/mixin/allCollectionsMixin","../enum/calcFieldsEnum","../../util/pathUtil","../../../model/schema/util/entityUtil","../../../model/schema/util/schemaModelUtil"],function(e,t,i){var l=e("underscore"),n=(e("../../../model/schema/enum/schemaEntitiesEnum"),e("../../../model/schema/mixin/allCollectionsMixin")),a=e("../enum/calcFieldsEnum"),r=e("../../util/pathUtil"),s=e("../../../model/schema/util/entityUtil"),c=e("../../../model/schema/util/schemaModelUtil"),d=function(e){this.initialize(e)};l.extend(d.prototype,n,{initialize:function(e){this.dataStore=e.dataStore,this.domainSchemaService=e.domainSchemaService,this.mixInAllCollections(this.dataStore)},getCalculatedFieldJSON:function(e){var t=this.fields.byId(e);return t&&t.toJSON()},generateCalcFieldName:function(e){return this.domainSchemaService.generateCalcFieldName(e)},getCalcFieldsUsedInOtherCalcFields:function(){return this.fields.reduce(function(e,t){if(s.isCalcField(t)){var i=t;e=t.getFieldReferences().reduce(function(e,t){var l=t.getFieldId(),n=t.getFieldType(),a=e[l];return s.isCalcField(n)&&(a||(a=[],e[l]=a),a.push(i.getId())),e},e)}return e},{})},getCalcFieldValidationContext:function(e){e=e||{};var t=e.sourceType;if(s.isConstantGroup(t))return this._getConstantCalcFieldValidationContext(e);if(s.isTableReference(t))return this._getSingleTableCalcFieldValidationContext(e);if(s.isJoinTree(t))return this._getCrossTableCalcFieldValidationContext(e);throw new Error("Unknown validation context parent type")},isCalcFieldUsedInComplexJoin:function(e){return this.joins.some(function(t){if(s.isComplexJoin(t))return t.getFieldReferences().find(function(t){return t.getFieldId()===e})})},isCalcFieldUsedInJoinExpression:function(e){return this.joinExpressions.some(function(t){return t.leftFieldId===e||t.rightFieldId===e||t.fieldId===e})},isConstantCalcField:function(e){var t=this.fields.byId(e);if(!s.isCalcField(t))return!1;var i=t.getFieldReferences().map(function(e){return e.getFieldId()});return this.isFieldsUsedByCalcFieldAreConstants(i)},isGlobalConstantCalcField:function(e){var t=this.fields.byId(e);return s.isCalcField(t)&&s.isConstantGroup(t.getSourceType())},isFieldsUsedByCalcFieldAreConstants:function(e){return e=l.isArray(e)?e:[e],e=l.map(e,function(e){return l.isNumber(e)?this.fields.byId(e):e},this),!e.some(function(e){return s.isGenericField(e)},this)&&e.every(function(e){return this.isFieldsUsedByCalcFieldAreConstants(e.getFieldReferences().map(function(e){return e.getFieldId()}))},this)},getDefaultConstantGroupName:function(){return a.DEFAULT_CONSTANT_GROUP_NAME},getAllSlaveFields:function(e){if(!e)return[];var t=this.fields.reduce(function(e,t){if(s.isCalcField(t)){var i=t;e=i.getFieldReferences().reduce(function(e,t){var l=e[i.getId()];return l||(l=[],e[i.getId()]=l),l.push(t),e},e)}return e},{});return l.uniq(this._getAllSlaveFieldsRecursive(e,t))},_getSingleTableCalcFieldValidationContext:function(e){var t=e.sourceId,i=e.calcFieldId,n=this.tableReferences.byId(t),a=this.tables.byId(n.getTableId()),r=c.getAllTableFields(a),s=n.getCalcFields(),d=this._getAllMasterCalcFields(i);s=this._groupCollectionByCircularReferences(s,d);var o=l.partial(this._calcFieldVariableContextMapper,"",n),u=[this._getConstantCalcFieldValidationContextForSingleAndCrossTableContexts(),r.map(o),s.allowed.map(o)],C=[s.forbidden.map(o)];return{allowed:l.flatten(u),forbidden:l.flatten(C)}},_getTableCalcFieldValidationContextForCrossTable:function(e){var t=this.tableReferences.byId(e),i=this.tables.byId(t.getTableId()),n=c.getAllTableFields(i),a=t.getCalcFields(),r=l.partial(this._calcFieldVariableContextMapper,t.getName(),t);return l.flatten([n.map(r),a.map(r)])},_getCrossTableCalcFieldValidationContext:function(e){var t=e.sourceId,i=e.calcFieldId,n=this.joinTrees.byId(t),a=n.getCalcFields(),r=this,s=this._getAllMasterCalcFields(i);a=this._groupCollectionByCircularReferences(a,s);var d=[this._getConstantCalcFieldValidationContextForSingleAndCrossTableContexts()];d=n.getJoinAliases().reduce(function(e,t){var i=r.tableReferences.byId(t.getTableReferenceId()),n=r.tables.byId(i.getTableId()),a=c.getAllTableFields(n),s=i.getCalcFields(),d=l.partial(r._calcFieldVariableContextMapper,t.getName(),t),o=l.flatten([a.map(d),s.map(d)]);return e.push(o),e},d);var o=l.partial(this._calcFieldVariableContextMapper,"",n);d=d.concat([a.allowed.map(o)]);var u=[a.forbidden.map(o)];return{allowed:l.flatten(d),forbidden:l.flatten(u)}},_getConstantCalcFieldValidationContextForSingleAndCrossTableContexts:function(){var e=this;return this.constantGroups.reduce(function(t,i){var n=l.partial(e._calcFieldVariableContextMapper,i.getName(),i);return t.concat(i.getCalcFields().map(n))},[])},_getConstantCalcFieldValidationContext:function(e){var t,i=e.calcFieldId,n=e.sourceId,a=e.sourceName;if(n)t=this.constantGroups.byId(n);else{if(!a)throw new Error("Could not determine constant group");t=this.constantGroups.byField("name",a)}var r=this._getAllMasterCalcFields(i),s=this.constantGroups.reduce(function(e,t){return e.concat(t.getCalcFields().toArray())},[]),c=this._groupCollectionByCircularReferences(s,r),d=l.bind(this._constantCalcFieldsReducer,this,t);return{allowed:c.allowed.reduce(d,[]),forbidden:c.forbidden.reduce(d,[])}},_constantCalcFieldsReducer:function(e,t,i){var l=this.constantGroups.byId(i.getSourceId());return l.getId()===e.getId()&&t.push(this._calcFieldVariableContextMapper("",l,i)),t.push(this._calcFieldVariableContextMapper(l.getName(),l,i)),t},_calcFieldVariableContextMapper:function(e,t,i){return{name:e?r.join([e,i.getName()],"\\","."):i.getName(),type:i.getType(),fieldId:i.getId(),fieldType:s.getEntityName(i),sourceId:t.getId(),sourceType:s.getEntityName(t)}},_groupCollectionByCircularReferences:function(e,t){var i={allowed:e||[],forbidden:[]};return t.length>0&&(t=l.groupBy(t),i={allowed:this._filterFieldsCollectionByCircularReferencePredicate({collection:e,allDependentCalcFields:t,inverse:!1}),forbidden:this._filterFieldsCollectionByCircularReferencePredicate({collection:e,allDependentCalcFields:t,inverse:!0})}),i},_filterFieldsCollectionByCircularReferencePredicate:function(e){var t=e.collection,i=e.inverse,n=e.allDependentCalcFields,a=l.partial(this._calcFieldCircularReferenceContextPredicate,n,i);return t?t.filter(a):[]},_calcFieldCircularReferenceContextPredicate:function(e,t,i){var n=l.isUndefined(e[i.getId()]);return t?!n:n},_getAllMasterCalcFields:function(e){if(!e)return[];var t=this.getCalcFieldsUsedInOtherCalcFields(),i=this._getAllMasterCalcFieldsRecursive(e,t),n=[e].concat(i);return l.uniq(n)},_getAllMasterCalcFieldsRecursive:function(e,t){var i=t[e]||[];return l.reduce(i,function(e,i){return e.push(i),e.concat(this._getAllMasterCalcFieldsRecursive(i,t))},[],this)},_getAllSlaveFieldsRecursive:function(e,t){var i=t[e]||[];return l.reduce(i,function(e,i){return s.isCalcField(i.getFieldType())&&(e=e.concat(this._getAllSlaveFieldsRecursive(i.getFieldId(),t))),e.push(i.getFieldId()),e},[],this)}}),i.exports=d});