/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../../model/schema/enum/schemaEntitiesEnum","../../../model/schema/enum/filterOperandTypesEnum","../../../model/schema/util/entityUtil","../../util/pathUtil","../../../model/schema/util/schemaModelUtil"],function(e,t,i){var r=e("underscore"),n=e("../../../model/schema/enum/schemaEntitiesEnum"),l=e("../../../model/schema/enum/filterOperandTypesEnum"),a=e("../../../model/schema/util/entityUtil"),s=e("../../util/pathUtil"),o=e("../../../model/schema/util/schemaModelUtil"),d=function(e){this.initialize(e)};r.extend(d.prototype,{initialize:function(e){this.complexFilterSerializer=e.complexFilterSerializer,this.filterSerializer=e.filterSerializer,this.filtersConcatenator=e.filtersConcatenator,this.filterExpressionAdapter=e.filterExpressionAdapter},serializeTableReferenceFilters:function(e,t){var i={collections:t},n=r.bind(this._tableReferenceFiltersMapper,this,i),l=e.getFilters().map(n);return this._serializeFilters(l)},_tableReferenceFiltersMapper:function(e,t){var i=t.toJSON(),n=t.getFieldReferences(),l=i.expression;if(e=r.extend({fieldReferences:n},e),a.isComplexFilter(t))return this._getComplexFilterJSON(t);var s=this._getTableReferenceFilterOperand(l.left,e),o=this._getTableReferenceFilterOperand(l.right,e);return o=this._addFieldTypeToRightOperand(o,s.fieldType),{left:s,operator:l.operator,right:o}},_getTableReferenceFilterOperand:function(e,t){var i,n,a,s=t.collections,d=t.fieldReferences,c=e.fieldReferenceId,f=r.extend({},e);return l.VARIABLE===e.type&&(i=this._getFieldByFieldReferenceId(c,{collections:s,fieldReferences:d}),a=d.findWhere({id:c}),n=o.getResourceByIdAndType(a.getSourceId(),a.getSourceType(),s),f={type:l.VARIABLE,fieldType:i.getType(),name:this._getTableReferenceFilterOperandVariableName(n,i)}),f},_getTableReferenceFilterOperandVariableName:function(e,t){return a.isConstantGroup(e)?this._getVariableNameWithSourcePrefix(e.getName(),t.getName()):t.getName()},serializeJoinTreeFilters:function(e,t){var i={collections:t},n=r.bind(this._joinTreeFiltersMapper,this,i),l=e.getFilters().map(n);return this._serializeFilters(l)},_joinTreeFiltersMapper:function(e,t){var i=t.toJSON(),n=t.getFieldReferences(),l=i.expression;if(e=r.extend({fieldReferences:n},e),a.isComplexFilter(t))return this._getComplexFilterJSON(t);var s=this._getJoinTreeFilterOperand(l.left,e),o=this._getJoinTreeFilterOperand(l.right,e);return o=this._addFieldTypeToRightOperand(o,s.fieldType),{left:s,operator:l.operator,right:o}},_getComplexFilterJSON:function(e){var t=e.toJSON();return r.extend({},t,{type:n.COMPLEX_FILTER})},_getJoinTreeFilterOperand:function(e,t){var i,n,a,s=t.fieldReferences,d=e.fieldReferenceId,c=t.collections,f=r.extend({},e);return l.VARIABLE===e.type&&(a=s.findWhere({id:d}),i=this._getFieldByFieldReferenceId(d,{collections:c,fieldReferences:s}),n=o.getResourceByIdAndType(a.getSourceId(),a.getSourceType(),c),f={type:l.VARIABLE,fieldType:i.getType(),name:this._getJoinsFilterOperandVariableName(n,i)}),f},_getFieldByFieldReferenceId:function(e,t){var i=t.fieldReferences,r=t.collections,n=i.findWhere({id:e});return r.fields.byId(n.getFieldId())},_getJoinsFilterOperandVariableName:function(e,t){return a.isJoinTree(e)?t.getName():this._getVariableNameWithSourcePrefix(e.getName(),t.getName())},_getVariableNameWithSourcePrefix:function(e,t){return s.join([e,t],"\\",".")},_addFieldTypeToRightOperand:function(e,t){return e.fieldType?e:r.extend({},e,{fieldType:t})},_serializeFilters:function(e){return e=r.reduce(e,function(e,t){var i;return i=a.isComplexFilter(t.type)?this.complexFilterSerializer.convert(t):this.filterSerializer.convert(t),i&&e.push(i),e},[],this),this.filterExpressionAdapter.getExpression(this.filtersConcatenator.concatenateFilters(e))}}),i.exports=d});