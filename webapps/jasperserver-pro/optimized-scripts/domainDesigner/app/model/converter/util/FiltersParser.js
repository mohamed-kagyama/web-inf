/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../expression/expressionVariables","../../../util/pathUtil","../../enum/calcFieldsEnum","../../../../model/schema/enum/filterOperandTypesEnum","../../../../model/schema/util/schemaModelUtil","../../../../model/schema/util/entityUtil","../../expression/filterParserUtil/filterParserUtil"],function(e,t,r){var i=e("underscore"),n=e("../../expression/expressionVariables"),s=e("../../../util/pathUtil"),l=e("../../enum/calcFieldsEnum"),o=e("../../../../model/schema/enum/filterOperandTypesEnum"),a=e("../../../../model/schema/util/schemaModelUtil"),c=e("../../../../model/schema/util/entityUtil"),p=e("../../expression/filterParserUtil/filterParserUtil"),d=n.collect,f=function(e){this.entityFactory=e.entityFactory};i.extend(f.prototype,{parseFilterExpression:function(e){var t=e.filterExpression,r=e.parent,i=e.collections;if(t){var n=p.parseFilter(t)||[];this._createFilterExpressions({parsedFilterExpressions:n,parent:r,collections:i})}},_createFilterExpressions:function(e){var t=e.collections,r=e.parent,n=e.parsedFilterExpressions;i.each(n,function(e){var i,n;c.isComplexFilter(e.type)?(i=this._getComplexFilterExpressionJSON({parsedFilterExpression:e,collections:t,parent:r}),n=this.entityFactory.createComplexFilter(i)):(i=this._getFilterExpressionJSON({parsedFilterExpression:e,collections:t,parent:r}),n=this.entityFactory.createFilterExpression(i)),t.filters.add(n),r.addFilter(n)},this)},_getComplexFilterExpressionJSON:function(e){var t=e.parent,r=e.parsedFilterExpression.expression;return{sourceId:t.getId(),sourceType:c.getEntityName(t),expression:r,fieldReferences:this._createFieldReferencesForComplexFilterExpression(r,{parent:e.parent,collections:e.collections})}},_createFieldReferencesForComplexFilterExpression:function(e,t){var r=t.parent,i=t.collections,n=d(e);return this._createFieldReferencesByExpressionVariables(n,{parent:r,collections:i})},_createFieldReferencesByExpressionVariables:function(e,t){var r=t.parent,n=t.collections;return i.map(e,function(e){var t=this._getFieldUsedInExpression({fieldName:e,collections:n,parent:r}),i=this._getFieldSourceUsedInExpression({parent:r,collections:n,field:t});return this.entityFactory.createFieldReference({fieldId:t.getId(),fieldType:c.getEntityName(t),sourceId:i.getId(),sourceType:c.getEntityName(i)})},this)},_getFilterExpressionJSON:function(e){var t=e.parent,r=this._createFieldReferencesForFilterExpression(e),n={sourceId:t.getId(),sourceType:c.getEntityName(t),expression:{left:{},operator:e.parsedFilterExpression.operator,right:{}},fieldReferences:r};return e=i.extend({},e,{fieldReferences:r}),n.expression.left=this._getFilterExpressionLeftOperand(e),n.expression.right=this._getFilterExpressionRightOperand(e),n},_createFieldReferencesForFilterExpression:function(e){var t=e.parent,r=e.collections,i=e.parsedFilterExpression.left,n=e.parsedFilterExpression.right,s=[];return i.type===o.VARIABLE&&s.push(i.name),n.type===o.VARIABLE&&s.push(n.name),this._createFieldReferencesByExpressionVariables(s,{parent:t,collections:r})},_getFilterExpressionLeftOperand:function(e){var t=e.fieldReferences,r=e.parsedFilterExpression.left;return this._getFilterExpressionOperand({fieldReference:i.first(t),parsedFilterExpressionOperand:r})},_getFilterExpressionRightOperand:function(e){var t=e.fieldReferences,r=e.parsedFilterExpression.right;return this._getFilterExpressionOperand({fieldReference:i.last(t),parsedFilterExpressionOperand:r})},_getFilterExpressionOperand:function(e){var t,r=e.fieldReference,n=e.parsedFilterExpressionOperand;return n.type===o.LITERAL?t={type:o.LITERAL,value:n.value}:n.type===o.VARIABLE?t={type:o.VARIABLE,fieldReferenceId:r.getId()}:n.type===o.RANGE?t={type:o.RANGE,start:n.start,end:n.end}:n.type===o.LIST&&(t={type:o.LIST,items:n.items},n.isAll&&(t=i.extend({},t,{isAll:n.isAll}))),t},_getFieldUsedInExpression:function(e){var t=e.fieldName,r=e.collections,i=e.parent;return this._isConstantGroupField(t)?this._getFieldByNameInConstantGroupsScope({fieldName:t,collections:r}):c.isJoinTree(i)?this._getFieldByNameInJoinTreeScope({fieldName:t,collections:r,joinTree:i}):this._getFieldByNameInTableReferenceScope({fieldName:t,collections:r,tableReference:i})},_isConstantGroupField:function(e){var t=this._splitFieldNameBySeparator(e);return t.length>1&&t[0]===l.DEFAULT_CONSTANT_GROUP_NAME},_getFieldByNameInConstantGroupsScope:function(e){var t=e.fieldName,r=e.collections,i=this._splitFieldNameBySeparator(t);return r.constantGroups.findWhere({name:i[0]}).getCalcFields().findWhere({name:i[1]})},_getFieldByNameInTableReferenceScope:function(e){var t=e.tableReference,r=e.fieldName,i=e.collections,n=a.getTableFieldsByTableReference(t,i).concat(t.getCalcFields().toArray());return this._findFieldByName(r,n)},_getFieldByNameInJoinTreeScope:function(e){var t,r=e.fieldName,i=e.joinTree,n=e.collections,s=this._splitFieldNameBySeparator(r);if(1===s.length)return i.getCalcFields().findWhere({name:s[0]});var l=i.getJoinAliases().findWhere({name:s[0]});return t=a.getCalcFieldsByJoinAlias(l,n).concat(a.getTableFieldsByJoinAlias(l,n)),this._findFieldByName(s[1],t)},_splitFieldNameBySeparator:function(e){return s.split(e,"\\",".")},_getFieldSourceUsedInExpression:function(e){var t=e.parent,r=e.collections,i=e.field,n=c.isCalcField(i),s=n&&c.isConstantGroup(i.getSourceType()),l=n&&c.isJoinTree(i.getSourceType()),o=t;return s?r.constantGroups.byId(i.getSourceId()):(c.isJoinTree(t)&&!l&&(o=t.getJoinAliases().find(function(e){var t,s;return n?(t=a.getTableReferenceByJoinAlias(e,r),s=i.getSourceId()):(t=a.getTableByJoinAlias(e,r),s=i.getTableId()),t.getId()===s})),o)},_findFieldByName:function(e,t){return i.find(t,function(t){return t.getName()===e})}}),r.exports=f});