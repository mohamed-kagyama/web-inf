/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../util/pathUtil","../../util/getResourceSourceNameOrNameUtil","../../../model/schema/util/entityUtil","../util/serverSchemaResourceTypeUtil","../../../model/schema/util/schemaModelUtil","../../../model/util/profileAttributeUtil","../util/resourceNameSpecialCharactersUtil","../../../model/schema/factory/domainSchemaCollectionsFactory","../enum/resourceTypeEnum","../enum/resourcesOrderEnum"],function(e,r,t){function a(e){this.initialize(e)}var n=e("underscore"),s=e("../../util/pathUtil"),o=e("../../util/getResourceSourceNameOrNameUtil"),i=e("../../../model/schema/util/entityUtil"),c=e("../util/serverSchemaResourceTypeUtil"),l=e("../../../model/schema/util/schemaModelUtil"),u=e("../../../model/util/profileAttributeUtil"),d=e("../util/resourceNameSpecialCharactersUtil"),p=e("../../../model/schema/factory/domainSchemaCollectionsFactory"),h=e("../enum/resourceTypeEnum"),f=e("../enum/resourcesOrderEnum");n.extend(a.prototype,{initialize:function(e){n.bindAll(this,"_parseGenericTable","_parseDerivedTable"),this.schemaNameGenerator=e.schemaNameGenerator,this.entityFactory=e.entityFactory,this.calcFieldsParser=e.calcFieldsParser,this.filtersParser=e.filtersParser,this.joinParser=e.joinParser},parse:function(e){this.schemaNameGenerator.reset();var r=p.create();return this._parseSchema({schema:e,collections:r}),r},_parseSchema:function(e){var r=e.schema,t=e.collections;this._parseResources({resources:r.resources,collections:t}),this._parsePresentation({presentation:r.presentation,collections:t})},_parseResources:function(e){var r=e.resources,t=e.collections,a=this._splitToConstantGroupsAndOtherResources(r),s=a.constantGroups,o=this._sortSchemaResources(a.resources);this._parseConstantGroups({constantGroups:s,collections:t}),n.each(o,function(e){var r=c.getResourceType(e);c.isResourceGroup(r)?this._parseDataSource({dataSourceJson:c.getResourceValue(e,r),collections:t}):c.isJoinGroup(r)&&this._parseJoinGroup({joinGroupJson:c.getResourceValue(e,r),collections:t})},this)},_splitToConstantGroupsAndOtherResources:function(e){var r={constantGroups:[],resources:[]};return n.reduce(e,function(e,r){var t=c.getResourceType(r);return t===h.resources.constantsGroups.GROUP?e.constantGroups.push(c.getResourceValue(r,t)):e.resources.push(r),e},r,this)},_sortSchemaResources:function(e){return n.sortBy(e,function(e){var r=c.getResourceType(e);return f[r]},this)},_parseConstantGroups:function(e){this.calcFieldsParser.parseConstantGroups(e)},_parseDataSourceResource:function(e){return this._isDerivedTableReference(e)?this._parseDerivedTableAndCreateTableReference(e):this._isGenericTableReference(e)?this._parseTableReferenceAndGenericTable(e):this._isDataSourceGroup(e)?this._parseDataSourceGroup(e):this._isGenericField(e)?this._parseGenericField(e):void 0},_parseDataSourceResources:function(e){var r=e.resources,t=n.omit(e,"resources");return n.reduce(r,function(e,r){var a=c.getResourceType(r),s=c.getResourceValue(r,a),o=n.extend({},t,{resourceJson:s,resourceType:a}),i=this._parseDataSourceResource(o);return i&&e.push(i),e},[],this)},_parseDataSource:function(e){var r=e.dataSourceJson,t=e.collections,a=this.entityFactory.createDataSource({name:r.name});a.setChildren(this._parseDataSourceResources({resources:r.elements,parent:a,dataSource:a,collections:t})),t.dataSources.add(a)},_parseDataSourceGroup:function(e){var r=e.dataSource,t=e.resourceJson,a=e.parent,n=e.collections,s=this._generateSchemaNameAndSourceName(t,n),o=this.entityFactory.createDataSourceGroup({sourceName:s.sourceName,name:s.name,parentId:a.id,dataSourceId:r.id});return o.setChildren(this._parseDataSourceResources({resources:t.elements,parent:o,dataSource:r,collections:n})),n.dataSourceGroups.add(o),o},_generateSchemaNameAndSourceName:function(e,r){var t,a;return u.containsProfileAttributeWithPlaceholdersOnly(e.name)?(t=d.replaceResourceNameSpecialCharacters(e.name),t=this.schemaNameGenerator.generate(t,function(e){return r.dataSourceGroups.byField("name",e)}),a={name:t,sourceName:e.name}):a={name:e.name,sourceName:e.sourceName},a},_parseDerivedTableAndCreateTableReference:function(e){return this._parseTableReferenceAndAnyTable(n.extend({parseTable:this._parseDerivedTable},e))},_parseTableReferenceAndGenericTable:function(e){var r=e.resourceJson,t=e.collections,a=t.tables.findWhere({name:o(r),parentId:e.parent.id});return this._parseTableReferenceAndAnyTable(n.extend({existingTable:a,parseTable:this._parseGenericTable},e))},_parseTableReferenceAndAnyTable:function(e){var r=e.existingTable,t=e.parseTable,a=e.resourceJson,n=e.parent,s=e.dataSource,o=e.collections,i=r||t({tableReferenceJson:a,dataSource:s,parent:n,collections:o}),c=this.entityFactory.createTableReference({name:a.name,tableId:i.id});return this.calcFieldsParser.parseSingleTableCalcFields({elements:a.elements,table:i,tableReference:c,collections:o}),this.filtersParser.parseFilterExpression({filterExpression:a.filterExpression,parent:c,collections:o}),o.tableReferences.add(c),!r&&i},_parseDerivedTable:function(e){var r=e.tableReferenceJson,t=e.parent,a=e.dataSource,n=e.collections,s=this.entityFactory.createDerivedTable({name:o(r),query:r.query,parentId:t.id,dataSourceId:a.id});return s.setChildren(this._parseDataSourceResources({resources:r.elements,parent:s,table:s,dataSource:a,collections:n})),n.tables.add(s),s},_parseGenericTable:function(e){var r=e.tableReferenceJson,t=e.parent,a=e.dataSource,n=e.collections,s=this.entityFactory.createGenericTable({name:o(r),parentId:t.id,dataSourceId:a.id});return s.setChildren(this._parseDataSourceResources({resources:r.elements,parent:s,table:s,dataSource:a,collections:n})),n.tables.add(s),s},_parseGenericField:function(e){var r=e.resourceJson,t=e.parent,a=e.table,n=e.dataSource,s=e.collections,o=this.entityFactory.createGenericField({name:r.name,sourceName:r.sourceName,type:r.type,dataSourceId:n.id,parentId:t.id,tableId:a.id});return s.fields.add(o),o},_parseJoinGroup:function(e){var r=e.joinGroupJson,t=e.collections,a=this.entityFactory.createJoinTree({name:r.name,includeAllDataIslandJoins:r.joinInfo.includeAllDataIslandJoins,suppressCircularJoins:r.joinInfo.suppressCircularJoins}),s=this._parseJoinAliases({collections:t,joinTree:a,elements:r.elements,mandatoryTables:r.joinInfo.mandatoryTables});a.setJoinAliases(s);var o=n.map(r.joinInfo.joins,function(e){return this.joinParser.parseJoin({joinJson:e,joinTree:a,collections:t})},this);a.setJoins(o),this.calcFieldsParser.parseCrossTableCalcFields({collections:t,joinTree:a,elements:r.elements}),this.filtersParser.parseFilterExpression({filterExpression:r.filterExpression,parent:a,collections:t}),t.joinTrees.add(a)},_parseJoinAliases:function(e){var r=e.collections,t=e.joinTree,a=e.elements,s=e.mandatoryTables||[];return n.chain(a).filter(function(e){var r=c.getResourceType(e);return c.isJoinAlias(r)},this).map(function(e){var a=c.getResourceType(e),o=c.getResourceValue(e,a);return n.indexOf(s,o.name)>-1&&(o.alwaysIncludeTable=!0),this._parseJoinAlias({joinAliasJson:o,joinTree:t,collections:r})},this).value()},_parseJoinAlias:function(e){var r=e.joinAliasJson,t=e.collections,a=e.joinTree,o=n.last(s.split(r.referencePath,"\\",".")),i=t.tableReferences.by({name:o}),c=this.entityFactory.createJoinAlias({name:r.name,alwaysIncludeTable:r.alwaysIncludeTable,joinTreeId:a.id,tableReferenceId:i.id});return t.joinAliases.add(c),c},_parsePresentation:function(e){var r=e.presentation,t=e.collections,a=this._groupTableReferencesByParentId(t);n.each(r,function(e){this._parseDataIsland({dataIslandJson:e,tableReferencesGroupedByParentId:a,collections:t})},this)},_parseDataIsland:function(e){var r=e.dataIslandJson,t=e.collections,a=e.tableReferencesGroupedByParentId,n=r.resourcePath,s=this._getDataIslandSourceByResourcePath({resourcePath:n,collections:t,tableReferencesGroupedByParentId:a}),o=this._getGenericPresentationItemProperties(r),c=this.entityFactory.createDataIsland(o);c.setSourceId(s.id),c.setSourceType(i.getEntityName(s)),c.setChildren(this._parseDataIslandChildren({elements:r.elements,collections:t,dataIsland:c,parent:c,tableReferencesGroupedByParentId:a})),t.dataIslands.add(c)},_parsePresentationSet:function(e){var r=e.presentationSetJson,t=e.parent,a=e.dataIsland,s=e.collections,o=e.tableReferencesGroupedByParentId,i=this._getGenericPresentationItemProperties(r),c=this.entityFactory.createPresentationSet(n.extend(i,{parentId:t.id,dataIslandId:a.id}));return c.setChildren(this._parseDataIslandChildren({elements:r.elements,collections:s,dataIsland:a,parent:c,tableReferencesGroupedByParentId:o})),s.presentationSets.add(c),c},_parseDataIslandChildren:function(e){var r=e.elements,t=e.parent,a=e.dataIsland,s=e.collections,o=e.tableReferencesGroupedByParentId;return n.reduce(r,function(e,r){var n,i=c.getResourceType(r);return r=c.getResourceValue(r,i),c.isPresentationGroup(i)?n=this._parsePresentationSet({presentationSetJson:r,collections:s,dataIsland:a,parent:t,tableReferencesGroupedByParentId:o}):c.isPresentationElement(i)&&(n=this._parsePresentationField({presentationFieldJson:r,collections:s,dataIsland:a,parent:t,tableReferencesGroupedByParentId:o})),n&&e.push(n),e},[],this)},_parsePresentationField:function(e){var r=e.presentationFieldJson,t=e.parent,a=e.dataIsland,s=e.collections,o=e.tableReferencesGroupedByParentId,c=this._getPresentationFieldSourcesByResourcePath({resourcePath:r.resourcePath,collections:s,tableReferencesGroupedByParentId:o}),l=c.resource,u=c.tableReference||c.joinAlias||c.joinTree||c.source,d=this._getGenericPresentationItemProperties(r),p=this.entityFactory.createPresentationField(n.extend(d,{parentId:t.id,dataIslandId:a.id,fieldId:l.id,fieldType:i.getEntityName(l),sourceId:u.id,sourceType:i.getEntityName(u)},this._getSpecificPresentationFieldProperties(r)));return s.presentationFields.add(p),p},_getGenericPresentationItemProperties:function(e){return n.pick(e,["name","label","labelId","description","descriptionId"])},_getSpecificPresentationFieldProperties:function(e){return n.pick(e,["mask","aggregation","kind"])},_isGenericTableReference:function(e){var r=e.resourceJson,t=e.resourceType,a=n.first(r.elements),s=!1;if(c.isResourceGroup(t)&&a){var o=c.getResourceType(a);s=c.isResourceElement(o)}else s=!1;return s},_isDerivedTableReference:function(e){return c.isQueryGroup(e.resourceType)},_isDataSourceGroup:function(e){var r=e.resourceJson,t=e.resourceType,a=!1;if(c.isResourceGroup(t)){var s=n.first(r.elements);a=!s||c.isResourceGroup(c.getResourceType(s))}else a=!1;return a},_isGenericField:function(e){var r=e.resourceJson,t=e.resourceType;return c.isResourceElement(t)&&!r.expression},_getDataIslandSourceByResourcePath:function(e){var r=e.resourcePath,t=e.collections,a=e.tableReferencesGroupedByParentId,n=this._getResourceWithParentsByPath({resourcePath:r,collections:t,tableReferencesGroupedByParentId:a});if(n)return n.tableReference||n.joinTree||n.source},_getPresentationFieldSourcesByResourcePath:function(e){var r=e.resourcePath,t=e.collections,a=e.tableReferencesGroupedByParentId;return this._getResourceWithParentsByPath({resourcePath:r,collections:t,tableReferencesGroupedByParentId:a})},_getResourceWithParentsByPath:function(e){var r=e.resourcePath,t=e.collections,a=e.tableReferencesGroupedByParentId,o=s.split(r,"\\","."),i=n.first(o),c=t.constantGroups.by({name:i}),l=t.dataSources.by({name:i});return c?{resource:c.getCalcFields().by({name:n.last(o)}),source:c}:l?this._getResourceByDataSourcePath({path:o,collections:t,tableReferencesGroupedByParentId:a}):this._getResourceByJoinTreePath({path:o,collections:t})},_getResourceByJoinTreePath:function(e){var r=e.path,t=e.collections;return n.reduce(r,function(e,r){var a,s;if(0===n.keys(e).length)return a=t.joinTrees.byField("name",r),e.resource=a,e.joinTree=a,e.parents=[],e;if(a=e.resource){if(i.isJoinTree(a)){var o=a.getJoinAliases().byField("name",r),c=a.getCalcFields().byField("name",r);if(o){e.joinAlias=o;s=l.getTableReferenceByJoinAlias(o,t)}else c&&(s=c)}else if(i.isTableReference(a)){var u=a.getCalcFields().byField("name",r);if(u)s=u;else{var d=l.getTableByTableReference(a,t);s=d.getChildren().byField("name",r)}}else i.isTableGroup(a)&&(s=a.getChildren().byField("name",r));e.resource=s}return e},{})},_getResourceByDataSourcePath:function(e){var r=e.path,t=e.collections,a=e.tableReferencesGroupedByParentId;return n.reduce(r,function(e,r){var s,o;if(0===n.keys(e).length)return s=t.dataSources.byField("name",r),e.resource=s,e.parents=[],e;if(s=e.resource){if(i.isDataSource(s)||i.isDataSourceGroup(s)){var c=a[s.id]||[],u=n.findWhere(c,{name:r});u?(o=u,e.tableReference=u):o=s.getChildren().chain().filter(function(e){return i.isDataSourceGroup(e)}).byField("name",r)}else if(i.isTableReference(s)){var d=s.getCalcFields().byField("name",r);if(d)o=d;else{var p=l.getTableByTableReference(s,t);o=p.getChildren().byField("name",r)}}else i.isTableGroup(s)&&(o=s.getChildren().byField("name",r));e.resource=o}return e},{})},_groupTableReferencesByParentId:function(e){var r=e.tableReferences.toArray();return n.groupBy(r,function(r){return l.getTableByTableReference(r,e).parentId})}}),t.exports=a});