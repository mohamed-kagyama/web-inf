/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../expression/joinExpressionUtil","../../../model/schema/util/schemaModelUtil","../../../model/schema/util/entityUtil","../enum/resourceTypeEnum","../enum/resourcePropertiesEnum","../enum/dataSourceLevelEnum","../enum/dataSourceToServerLevelEnum","./util/referencePathUtil"],function(e,n,o){function t(e){this.initialize(e)}var r=e("underscore"),s=e("../expression/joinExpressionUtil"),i=e("../../../model/schema/util/schemaModelUtil"),a=e("../../../model/schema/util/entityUtil"),l=e("../enum/resourceTypeEnum"),c=e("../enum/resourcePropertiesEnum"),u=e("../enum/dataSourceLevelEnum"),d=e("../enum/dataSourceToServerLevelEnum"),m=e("./util/referencePathUtil");r.extend(t.prototype,{initialize:function(e){this.filterExpressionsSerializer=e.filterExpressionsSerializer,this.calcFieldSerializer=e.calcFieldSerializer},toJSON:function(e){return this.domainToJson(e)},domainToJson:function(e){return{schema:this.schemaToJson(e)}},schemaToJson:function(e){var n=e.constantGroups,o=e.dataSources,t=e.dataIslands,s=e.joinTrees,i=[],a=this,l=n.map(function(n){return a.constantGroupToJson({constantGroup:n,collections:e})}),c=o.reduce(function(n,o){return r.isEmpty(o.getChildren().first())||n.push(a.dataSourceToJson({dataSource:o,collections:e})),n},[]),u=s.map(function(n){return a.joinTreeToJson({joinTree:n,collections:e})}),d=t.map(function(n){return a.dataIslandToJson({dataIsland:n,collections:e})});return i=i.concat(l,c,u),{resources:i,presentation:d}},constantGroupToJson:function(e){var n,o=e.constantGroup,t=this,r=o.getCalcFields().map(function(e){return t.constantToJson({constant:e})});return n={},n[l.resources.constantsGroups.GROUP]={name:o.name,elements:r},n},constantToJson:function(e){var n=e.constant;return this.calcFieldSerializer.serialize(n)},dataSourceToJson:function(e){var n=e.dataSource,o=e.collections,t=this.dataSourceResourcesChildrenToJson({resource:n,collections:o});return{group:{name:n.name,elements:t}}},dataSourceResourcesChildrenToJson:function(e){var n=e.resource,o=e.collections,t=this;return n.getChildren().reduce(function(e,n){var r=t.dataSourceResourceToJson({resource:n,collections:o});return e=e.concat(r)},[])},dataSourceResourceToJson:function(e){var n=e.resource;return a.isDataSourceGroup(n)?this.dataSourceGroupToJson(e):a.isTable(n)?this.allTableReferencesByTableToJson(e):a.isTableGroup(n)?this.tableGroupToJson(e):a.isGenericField(n)?this.genericFieldToJson(e):void 0},dataSourceGroupToJson:function(e){var n=e.resource,o=e.collections,t=this.dataSourceResourcesChildrenToJson({resource:n,collections:o}),s=n.sourceName,i=n.name,a={group:{name:i,sourceName:s,elements:t}};return r.isEmpty(t)&&(a.group[c.type]=d[u.DATA_SOURCE_GROUP]),a},allTableReferencesByTableToJson:function(e){var n=e.resource,o=e.collections,t=this;return i.getAllTableReferencesByTable(n,o).map(function(e){return t.tableReferenceToJson({tableReference:e,table:n,collections:o})})},tableReferenceToJson:function(e){var n=e.table;return a.isDerivedTable(n)?this.tableReferenceBasedOnDerivedTableToJson(e):this.tableReferenceBasedOnGenericTableToJson(e)},tableReferenceBasedOnDerivedTableToJson:function(e){var n=e.tableReference,o=e.table,t=n.name,r={queryGroup:{name:t,elements:this.tableReferenceChildrenToJson(e),query:o.query}},s=this.tableReferenceFiltersToJson({tableReference:n,collections:e.collections});return s&&(r.queryGroup.filterExpression=s),r},tableReferenceBasedOnGenericTableToJson:function(e){var n=e.tableReference,o=e.table,t=n.name,r=o.name,s={group:{name:t||r,elements:this.tableReferenceChildrenToJson(e)}},i=this.tableReferenceFiltersToJson({tableReference:n,collections:e.collections});return i&&(s.group.filterExpression=i),t&&t!==r&&(s.group.sourceName=r),s},tableReferenceFiltersToJson:function(e){var n=e.tableReference,o=e.collections;return this.filterExpressionsSerializer.serializeTableReferenceFilters(n,o)},tableReferenceChildrenToJson:function(e){var n=e.tableReference,o=e.table,t=e.collections,r=this.dataSourceResourcesChildrenToJson({resource:o,collections:t}),s=this.singleTableCalcFieldsToJson(n);return r.concat(s)},singleTableCalcFieldsToJson:function(e){var n=this;return e.getCalcFields().map(function(e){return n.calcFieldToJson(e)})},tableGroupToJson:function(e){var n=e.resource,o=e.collections,t=this.dataSourceResourcesChildrenToJson({resource:n,collections:o});return{group:{name:n.name,elements:t}}},genericFieldToJson:function(e){var n=e.resource;return{element:{name:n.name,type:n.type,sourceName:n.sourceName}}},calcFieldToJson:function(e){return this.calcFieldSerializer.serialize(e)},joinTreeToJson:function(e){var n=[],o=e.joinTree,t=e.collections,r=this,s=o.getJoinAliases().map(function(e){return e.alwaysIncludeTable&&n.push(e.name),r.joinAliasToJson({joinAlias:e,collections:t})}),i=o.getCalcFields().map(function(e){return r.calcFieldToJson(e)}),a=o.getJoins().map(function(e){return r.joinToJson({join:e,collections:t})}),l={joinGroup:{name:o.name,elements:s.concat(i),joinInfo:{includeAllDataIslandJoins:o.includeAllDataIslandJoins,suppressCircularJoins:o.suppressCircularJoins,joins:a}}};return n.length&&(l.joinGroup.joinInfo.mandatoryTables=n),l=this.joinTreeFiltersToJson(l,{joinTree:o,collections:t})},joinTreeFiltersToJson:function(e,n){var o=n.joinTree,t=n.collections,r=this.filterExpressionsSerializer.serializeJoinTreeFilters(o,t);return r&&(e.joinGroup.filterExpression=r),e},joinAliasToJson:function(e){var n=e.joinAlias,o=e.collections;return{reference:{name:n.name,referencePath:m.getJoinAliasReferencePath(n,o)}}},joinToJson:function(e){var n=e.join,o=e.collections,t=o.joinAliases,r=t.byId(n.leftJoinAliasId),i=t.byId(n.rightJoinAliasId),l={string:""};return a.isJoin(n)?l.string=s.formatJoinExpressions(n.getJoinExpressions(),o):a.isComplexJoin(n)&&(l.string=n.expression.string),{type:n.type,left:r.name,right:i.name,weight:n.weight,expression:l}},dataIslandToJson:function(e){var n,o=e.dataIsland,t=e.collections,s=o,i=this.presentationItemsToJson({items:o.getChildren(),collections:t});s.sourceId&&(n=m.getDataIslandResourcePath(s,e));var a=r.omit(o.toJSON(),["id","sourceId","sourceType"]);return r.extend({},a,{elements:i,resourcePath:n})},presentationItemsToJson:function(e){var n=e.items,o=e.collections,t=this;return n.map(function(e){return a.isPresentationSet(e)?t.presentationSetToJson({set:e,collections:o}):a.isPresentationField(e)?t.presentationFieldToJson({field:e,collections:o}):void 0})},presentationSetToJson:function(e){var n=e.set,o=e.collections,t=this.presentationItemsToJson({items:n.getChildren(),collections:o}),s=r.omit(n.toJSON(),["id"]);return{group:r.extend(s,{elements:t})}},presentationFieldToJson:function(e){var n=e.field,o=e.collections,t=["id","fieldId","fieldType","sourceId","sourceType"];r.isEmpty(n.mask)&&t.push("mask");var s=r.omit(n.toJSON(),t);return{element:r.extend(s,this.getPresentationFieldAdditionalProps(n,o))}},getPresentationFieldAdditionalProps:function(e,n){var o=e.fieldId,t={};return r.extend(t,{resourcePath:m.getPresentationFieldReferencePath(e,n),type:n.fields.byId(o).type}),r.extend(t,{hierarchicalName:m.getPresentationFieldHierarchicalName(e,n)}),t}}),o.exports=t});