/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","backbone","../../model/util/SequenceGenerator","../../util/ListWithCursor","../dispatcher/enum/applicationStateEventsEnum"],function(t,i,e){var s=t("underscore"),r=t("backbone"),n=t("../../model/util/SequenceGenerator"),o=t("../../util/ListWithCursor"),a=t("../dispatcher/enum/applicationStateEventsEnum"),c=function(t){this.initialize(t)};s.extend(c.prototype,r.Events,{initialize:function(t){var i=this._getEntryInitialId(t);this.applicationDispatcherEventBus=t.applicationDispatcherEventBus,this.primaryList=t.list||new o(t),this.secondaryList=new o,this.activeList=this.primaryList,this.entryIdGenerator=new n(i)},setState:function(t,i){this._resetSecondaryList(),this._resetPrimaryList(),this._setActiveListToPrimary(),this.activeList.setList(t),this.activeList.setPosition(i),this._triggerActionsAndDesignerState()},getState:function(t,i){var e=i?this.secondaryList.getList():this.primaryList.getList();return s.isNumber(t)?e[t]:(t=this.primaryList.getPosition(),{list:e,position:t})},pushState:function(t){this._setActiveListToPrimary(),this._removeAllNextEntries(),this._mergePrimaryListWithSecondary(),this._resetSecondaryList(),this._pushState({id:this.entryIdGenerator.next(),viewState:t.viewState||{},domainState:t.domainState||{},resourceProperties:t.resourceProperties||{}})},pushViewState:function(t){this._resetSecondaryList(),this._setActiveListToSecondary();var i=this.primaryList.get();this._pushState({id:i.id,viewState:t.viewState||{},domainState:t.domainState||{},resourceProperties:t.resourceProperties||{}})},undo:function(){this._resetSecondaryList();var t=this._getUndoPosition();!s.isUndefined(t)&&this.primaryList.setPosition(t),this._triggerActionsAndDesignerState()},undoAll:function(){this._resetSecondaryList(),this._setActiveListToPrimary();var t=this._getUndoAllPosition();this.primaryList.setPosition(t),this._triggerActionsAndDesignerState()},redo:function(){this._resetSecondaryList();var t=this._getRedoPosition();!s.isUndefined(t)&&this.primaryList.setPosition(t),this._setActiveListToPrimary(),this._triggerActionsAndDesignerState()},isUndoAvailable:function(){return!s.isUndefined(this._getUndoPosition())},isRedoAvailable:function(){return!s.isUndefined(this._getRedoPosition())},clearHistory:function(){var t=this.primaryList.get();this.primaryList.setList([t],0)},_getUndoPosition:function(){for(var t,i=this.primaryList.get(),e=this.primaryList.getPosition(),s=this.primaryList.getList(),r=e;r>=0;r--){if(s[r].id!==i.id){t=r;break}}return t},_getRedoPosition:function(){var t,i=this.primaryList.get(),e=this.primaryList.getPosition(),r=this.primaryList.getList();if(s.isUndefined(i))return t;for(var n=e;n<r.length;n++){if(r[n].id!==i.id){t=n;break}}return t},_getUndoAllPosition:function(){for(var t=0,i=this.primaryList.getList(),e=0;e<i.length;e++){var s=i[e],r=i[e+1];if(!r)break;if(s.id!==r.id){t=e;break}}return t},_mergePrimaryListWithSecondary:function(){var t=this.secondaryList.get();t&&this.primaryList.add(t)},_resetSecondaryList:function(){this.secondaryList.setList()},_resetPrimaryList:function(){this.primaryList.setList()},_setActiveListToSecondary:function(){this.activeList=this.secondaryList},_setActiveListToPrimary:function(){this.activeList=this.primaryList},_pushState:function(t,i){s.isUndefined(i)?this.activeList.add(t):this.activeList.replace(t,i)},_triggerActionsAndDesignerState:function(){this._triggerDesignerState()},_triggerDesignerState:function(){var t=this._getCurrentViewStateClone(),i=this._getCurrentDomainStateClone(),e=this._getCurrentResourcePropertiesStateClone();this.applicationDispatcherEventBus.trigger(a.SET_STATE_NO_HISTORY,{schema:i,viewState:t,resourceProperties:e})},_getCurrentDomainStateClone:function(){return(this.primaryList.get()||{}).domainState||{}},_getCurrentViewStateClone:function(){var t=this.primaryList.get()||{},i=t.viewState||{};return s.cloneDeep(i)},_getCurrentResourcePropertiesStateClone:function(){var t=this.primaryList.get()||{},i=t.resourceProperties||{};return s.cloneDeep(i)},_removeAllNextEntries:function(){this.activeList.removeAfter()},_getEntryInitialId:function(t){var i=0,e=t.items;if(e&&!s.isEmpty(e)){i=s.last(e).id+1}return i}}),e.exports=c});