/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../mixin/allCollectionsMixin","../util/entityUtil","../util/schemaModelUtil","../enum/schemaEntitiesEnum","../enum/entitiesWithChildResourcesList","../enum/entityTypeToSchemaCollectionMap","../enum/schemaCollectionsEnum"],function(e,t,r){var o=e("underscore"),i=e("../mixin/allCollectionsMixin"),n=e("../util/entityUtil"),s=e("../util/schemaModelUtil"),a=e("../enum/schemaEntitiesEnum"),c=e("../enum/entitiesWithChildResourcesList"),u=e("../enum/entityTypeToSchemaCollectionMap"),d=e("../enum/schemaCollectionsEnum"),l={};l[a.CONSTANT_GROUP]="_createRemoveResourceFromConstantGroupMap",l[a.DATA_SOURCE]="_createRemoveResourceFromDataSourceMap",l[a.DATA_SOURCE_GROUP]="_createRemoveResourceFromDataSourceGroupMap",l[a.TABLE]="_createRemoveResourceFromTableMap",l[a.DERIVED_TABLE]="_createRemoveResourceFromTableMap",l[a.TABLE_GROUP]="_createRemoveResourceFromTableGroupMap",l[a.TABLE_REFERENCE]="_createRemoveResourceFromTableReferenceMap",l[a.JOIN_TREE]="_createRemoveResourceFromJoinTreeMap",l[a.JOIN]="_createRemoveResourceFromJoinMap",l[a.DATA_ISLAND]="_createRemoveResourceFromDataIslandMap",l[a.PRESENTATION_SET]="_createRemoveResourceFromPresentationSetMap";var h=function(e){this.dataStore=e.dataStore,this.schemaModelConverter=e.schemaModelConverter,this.mixInAllCollections(this.dataStore)};o.extend(h.prototype,{setCollection:function(e,t){this._setCollection(this[e],t)},createFieldReference:function(e){return this.schemaModelConverter.parseFieldReference({fieldReferenceJson:e})},addDataSource:function(e){return this.schemaModelConverter.parseDataSource({dataSourceJson:e,collections:this.dataStore.getCollections()})},updateDataSource:function(e){var t=this.dataSources.byId(e.id);return t.update(e),t},removeDataSources:function(e){var t=this._getRemoveResourcesOptions();this._removeDataSources(e,t),this._removeResourcesByRemoveResourcesOptions(t)},_removeDataSources:function(e,t){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.dataSources).forEach(function(e){this._removeDataSource(e,t)},this)},addDataSourceGroups:function(e,t){e=o.isArray(e)?e:[e];var r=this._getDataSourceGroupOrDataSource(t),i=this._getDataSourceByDataSourceGroup(r),n=this.dataStore.getCollections();return e=o.map(e,function(e){return this.schemaModelConverter.parseDataSourceGroup({resource:e,parent:r,dataSource:i,collections:n})},this),r.addChildren(e),e},removeDataSourceGroups:function(e,t){var r=this._getRemoveResourcesOptions();this._removeDataSourceGroups(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removeDataSourceGroups:function(e,t,r){e=o.isArray(e)?e:[e];var i=this._getDataSourceGroupOrDataSource(t);this._getEntitiesByIds(e,this.dataSourceGroups).forEach(function(e){this._removeDataSourceGroupFromParent(e,i,r)},this)},removeDataSourceGroupsAndMoveChildren:function(e,t){var r=this._getDataSourceGroupOrDataSource(t),o=r.getChild(e);r.addChildren(o.getChildren().toArray()),r.getChildren().each(function(e){e.update({parentId:t})}),r.removeChild(e),this.dataSourceGroups.remove(0,this.dataSourceGroups.size())},addDataSourceGroupAndMoveChildren:function(e){this.addDataSourceGroups(e,e.parentId);var t=this.dataSourceGroups.first(),r=[],o=this._getDataSourceGroupOrDataSource(e.parentId);o.getChildren().each(function(e){n.isGenericTable(e)?t.addChildren(e):r.push(e)}),o.setChildren(r),t.getChildren().each(function(e){e.update({parentId:t.id})})},updateDataSourceGroup:function(e){var t=this.dataSourceGroups.byId(e.id);return t.update(e),t},addDerivedTables:function(e,t){e=o.isArray(e)?e:[e];var r=this._getDataSourceGroupOrDataSource(t),i=this._getDataSourceByDataSourceGroup(r),n=this.dataStore.getCollections();return e=o.map(e,function(e){return this.schemaModelConverter.parseDerivedTable({resource:e,parent:r,dataSource:i,collections:n})},this),r.addChildren(e),e},addTables:function(e,t){e=o.isArray(e)?e:[e];var r=this._getDataSourceGroupOrDataSource(t),i=this._getDataSourceByDataSourceGroup(r),n=this.dataStore.getCollections();return e=o.map(e,function(e){return this.schemaModelConverter.parseGenericTable({resource:e,parent:r,dataSource:i,collections:n})},this),r.addChildren(e),e},removeTables:function(e,t){var r=this._getRemoveResourcesOptions();this._removeTables(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removeTables:function(e,t,r){e=o.isArray(e)?e:[e];var i=this._getDataSourceGroupOrDataSource(t);this._getEntitiesByIds(e,this.tables).forEach(function(e){this._removeTableFromParent(e,i,r)},this)},updateTable:function(e){var t=this.tables.byId(e.id);return t.update(e),t},addFields:function(e,t){e=o.isArray(e)?e:[e];var r=this._getTableOrTableGroup(t),i=this._getTableByTableGroup(r),n=this.dataSources.byId(i.dataSourceId),s=this.dataStore.getCollections();return e=o.map(e,function(e){return this.schemaModelConverter.parseField({resource:e,parent:r,dataSource:n,table:i,collections:s})},this),r.addChildren(e),e},removeFields:function(e,t){var r=this._getRemoveResourcesOptions();this._removeFields(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removeFields:function(e,t,r){e=o.isArray(e)?e:[e];var i=this._getTableOrTableGroup(t);this._getEntitiesByIds(e,this.fields).forEach(function(e){this._removeFieldFromParent(e,i,r)},this)},updateField:function(e){var t=this.fields.byId(e.id);return t.update(e),t},addConstantGroup:function(e){return this.schemaModelConverter.parseConstantGroup({constantGroupJson:e,collections:this.dataStore.getCollections()})},removeConstantGroups:function(e){var t=this._getRemoveResourcesOptions();this._removeConstantGroups(e,t),this._removeResourcesByRemoveResourcesOptions(t)},_removeConstantGroups:function(e,t){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.constantGroups).forEach(function(e){this._removeConstantGroup(e,t)},this)},updateConstantGroup:function(e){var t=this.constantGroups.byId(e.id);return t.update(e),t},addCalcField:function(e,t,r){var o=this.dataStore.getCollections(),i=s.getResourceByIdAndType(t,r,o),n=this.schemaModelConverter.parseCalcField({calcFieldJson:e,parent:i,collections:o});return i.addCalcField(n),n},removeCalcFields:function(e,t,r){var o=this._getRemoveResourcesOptions();this._removeCalcFields(e,t,r,o),this._removeResourcesByRemoveResourcesOptions(o)},_removeCalcFields:function(e,t,r,i){e=o.isArray(e)?e:[e];var n=this.dataStore.getCollections(),a=s.getResourceByIdAndType(t,r,n);this._getEntitiesByIds(e,this.fields).forEach(function(e){this._removeCalcFieldFromParent(e,a,i)},this)},updateCalcField:function(e,t,r){var i=this.dataStore.getCollections(),n=s.getResourceByIdAndType(t,r,i),a=n.getCalcFields().byId(e.id);if(a.update(e),o.has(e,"fieldReferences")){var c=e.fieldReferences;a.setFieldReferences(o.map(c,function(e){return this.schemaModelConverter.parseFieldReference({fieldReferenceJson:e})},this))}return a},addFilterExpression:function(e,t,r){var o=this.dataStore.getCollections(),i=s.getResourceByIdAndType(t,r,o),n=this.schemaModelConverter.parseFilterExpression({filterJson:e,parent:i,collections:o});return i.addFilter(n),n},updateFilterExpression:function(e,t,r){var i=this.dataStore.getCollections(),n=s.getResourceByIdAndType(t,r,i),a=n.getFilters().byId(e.id);if(a.update(e),o.has(e,"fieldReferences")){var c=e.fieldReferences;a.setFieldReferences(o.map(c,function(e){return this.schemaModelConverter.parseFieldReference({fieldReferenceJson:e})},this))}return a},removeFilters:function(e,t,r){var o=this._getRemoveResourcesOptions();this._removeFilters(e,t,r,o),this._removeResourcesByRemoveResourcesOptions(o)},_removeFilters:function(e,t,r,i){e=o.isArray(e)?e:[e];var n=this.dataStore.getCollections(),a=s.getResourceByIdAndType(t,r,n);this._getEntitiesByIds(e,this.filters).forEach(function(e){this._removeFilterFromParent(e,a,i)},this)},addTableReference:function(e){return this.schemaModelConverter.parseTableReference({tableReferenceJson:e,collections:this.dataStore.getCollections()})},removeTableReferences:function(e){var t=this._getRemoveResourcesOptions();this._removeTableReferences(e,t),this._removeResourcesByRemoveResourcesOptions(t)},_removeTableReferences:function(e,t){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.tableReferences).forEach(function(e){this._removeTableReference(e,t)},this)},updateTableReference:function(e){var t=this.tableReferences.byId(e.id);return t.update(e),t},addJoinTree:function(e){return this.schemaModelConverter.parseJoinTree({joinTreeJson:e,collections:this.dataStore.getCollections()})},removeJoinTrees:function(e){var t=this._getRemoveResourcesOptions();this._removeJoinTrees(e,t),this._removeResourcesByRemoveResourcesOptions(t)},_removeJoinTrees:function(e,t){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.joinTrees).forEach(function(e){this._removeJoinTree(e,t)},this)},updateJoinTree:function(e){var t=e&&e.id,r=this.joinTrees.byId(t);if(!r)throw new Error("There is no join tree with id "+t);return r.update(e),r},addJoin:function(e,t){var r=this.joinTrees.byId(t);if(!r)throw new Error("There is no join tree with id "+t);var o=this.schemaModelConverter.parseJoin({joinTree:r,joinJson:e,collections:this.dataStore.getCollections()});return r.addJoin(o),o},removeJoins:function(e,t){var r=this._getRemoveResourcesOptions();this._removeJoins(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removeJoins:function(e,t,r){e=o.isArray(e)?e:[e];var i=this.joinTrees.byId(t);if(!i)throw new Error("There is no join tree with id "+t);this._getEntitiesByIds(e,this.joins).forEach(function(e){this._removeJoinFromParent(e,i,r)},this)},updateJoin:function(e){var t=e&&e.id,r=this.joins.byId(t);if(!r)throw new Error("There is no join with id "+t);return r.update(e),r},addJoinAlias:function(e,t){var r=this.joinTrees.byId(t);if(!r)throw new Error("There is no join tree with id "+t);var o=this.schemaModelConverter.parseJoinAlias({joinAliasJson:e,joinTree:r,collections:this.dataStore.getCollections()});return r.addJoinAlias(o),o},updateJoinAlias:function(e){var t=e&&e.id,r=this.joinAliases.byId(t);if(!r)throw new Error("There is no join alias with id "+t);return r.update(e),r},removeJoinAliases:function(e,t){var r=this._getRemoveResourcesOptions();this._removeJoinAliases(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removeJoinAliases:function(e,t,r){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.joinAliases).forEach(function(e){this._removeJoinAliasFromParent(e,t,r)},this)},addJoinExpression:function(e,t){var r=this.joins.byId(t);if(!r)throw new Error("There is no join with id "+t);var o=this.schemaModelConverter.parseJoinExpression({joinExpressionJson:e,join:r,collections:this.dataStore.getCollections()});return r.addJoinExpression(o),o},removeJoinExpressions:function(e){var t=this._getRemoveResourcesOptions();this._removeJoinExpressions(e,t),this._removeResourcesByRemoveResourcesOptions(t)},_removeJoinExpressions:function(e,t){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.joinExpressions).forEach(function(e){this._removeJoinExpressionFromParent(e,null,t)},this)},updateJoinExpression:function(e){var t=e&&e.id,r=this.joinExpressions.byId(t);if(!r)throw new Error("There is no join expression with id "+t);return r.update(e),r},addConstantJoinExpression:function(e,t){var r=this.joins.byId(t);if(!r)throw new Error("There is no join with id "+t);return e=this.schemaModelConverter.parseConstantJoinExpression({joinExpressionJson:e,join:r,collections:this.dataStore.getCollections()}),r.addJoinExpression(e),e},removeConstantJoinExpressions:function(e){this.removeJoinExpressions(e)},updateConstantJoinExpression:function(e){this.updateJoinExpression(e)},addDataIsland:function(e){return e.sourceId||(e.sourceId=null),this.schemaModelConverter.parseDataIsland({dataIslandJson:e,collections:this.dataStore.getCollections()})},removeDataIslands:function(e){var t=this._getRemoveResourcesOptions();this._removeDataIslands(e,t),this._removeResourcesByRemoveResourcesOptions(t)},_removeDataIslands:function(e,t){e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.dataIslands).forEach(function(e){this._removeDataIsland(e,t)},this)},updateDataIsland:function(e){var t=e&&e.id,r=this.dataIslands.byId(t);if(!r)throw new Error("There is no data island with id "+t);return r.update(e),r},addPresentationSets:function(e,t){t=t||{};var r,i=this.dataStore.getCollections(),n=s.getDataIslandOrPresentationSetById(t.parentId,i),a=t.positionInParent;return r=s.getDataIslandByPresentationItem(n,i),e=o.isArray(e)?e:[e],e=o.map(e,function(e){return this.schemaModelConverter.parsePresentationSet({presentationItem:e,parent:n,dataIsland:r,collections:i})},this),n.addChildren(e,a),e},updatePresentationSet:function(e){var t=this.presentationSets.byId(e.id);return t.update(e),t},removePresentationSets:function(e,t){var r=this._getRemoveResourcesOptions();this._removePresentationSets(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removePresentationSets:function(e,t,r){var i=this.dataStore.getCollections(),n=s.getDataIslandOrPresentationSetById(t,i);e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.presentationSets).forEach(function(e){this._removePresentationSetFromParent(e,n,r)},this)},addPresentationFields:function(e,t){t=t||{};var r,i=this.dataStore.getCollections(),a=s.getDataIslandOrPresentationSetById(t.parentId,i),c=t.positionInParent;return n.isDataIsland(a)?r=a:n.isPresentationSet(a)&&(r=s.getDataIslandById(a.dataIslandId,i)),e=o.isArray(e)?e:[e],e=o.map(e,function(e){return this.schemaModelConverter.parsePresentationField({presentationItem:e,parent:a,dataIsland:r,collections:i})},this),a.addChildren(e,c),e},updatePresentationField:function(e){var t=this.presentationFields.byId(e.id);return t.update(e),t},removePresentationFields:function(e,t){var r=this._getRemoveResourcesOptions();this._removePresentationFields(e,t,r),this._removeResourcesByRemoveResourcesOptions(r)},_removePresentationFields:function(e,t,r){var i=this.dataStore.getCollections(),n=s.getDataIslandOrPresentationSetById(t,i);e=o.isArray(e)?e:[e],this._getEntitiesByIds(e,this.presentationFields).forEach(function(e){this._removePresentationFieldFromParent(e,n,r)},this)},removePresentationFieldsFromDataIsland:function(e){var t=this.dataIslands.byId(e),r=this._getRemoveResourcesOptions();if(!t)throw new Error("There is no data island with id "+e);this._removePresentationFieldsByParent(t,r),this._removeResourcesByRemoveResourcesOptions(r)},reorderDataIslands:function(e){var t=this.dataIslands,r=e.dataIslandIds,o=e.position,i=this._getFromCollectionByIdsAndPreserveOrder(r,t);this._removeFromCollectionByIds(r,this.dataIslands),this.dataIslands.add(i,o)},reorderPresentationItems:function(e){var t=this.dataStore.getCollections(),r=e.presentationItemIds,i=e.position,n=e.targetParentId,a=s.getDataIslandOrPresentationSetById(n,t),c=o.map(r,function(e){return s.getPresentationSetOrFieldById(e,t)});o.each(c,function(e){this._removeFromPresentationParent(e,t)},this),this._addChildrenToPresentationParent({children:c,parent:a,position:i})},_addChildrenToPresentationParent:function(e){var t=o.isArray(e.children)?e.children:[e.children],r=e.parent,i=e.position,n=!o.isUndefined(i);o.each(t,function(e,t){var o=n?i+t:i;this._updatePresentationItemParentId(e,r.id),r.addChildren(e,o)},this)},_getFromCollectionByIdsAndPreserveOrder:function(e,t){var r=this._idsListToMap(e);return t.reduce(function(e,t){var o=r[t.id];return o&&(e[o-1]=t),e},[])},_removeFromPresentationParent:function(e,t){var r=e.parentId;s.getDataIslandOrPresentationSetById(r,t).removeChild(e.id)},_updatePresentationItemParentId:function(e,t){var r={id:e.id,parentId:t};n.isPresentationSet(e)?this.updatePresentationSet(r):n.isPresentationField(e)&&this.updatePresentationField(r)},_idsListToMap:function(e){return e.reduce(function(e,t,r){return e[t]=r+1,e},{})},_removeFromCollectionByIds:function(e,t){var r=this._idsListToMap(e);this._removeManyResourcesFromCollection(r,t)},_getDataSourceGroupOrDataSource:function(e){return s.getDataSourceGroupOrDataSource(e,{dataSources:this.dataSources,dataSourceGroups:this.dataSourceGroups})},_getDataSourceByDataSourceGroup:function(e){return n.isDataSource(e)?e:this.dataSources.byId(e.dataSourceId)},_getTableOrTableGroup:function(e){var t=this.tables.byId(e),r=t;return r||(r=this.tableGroups.byId(e)),r},_getTableByTableGroup:function(e){return n.isTable(e)?e:this.tables.byId(e.tableId)},_removeDataSource:function(e,t){var r=e.id;t.removeResourcesMap[d.DATA_SOURCES][r]=!0,e.getChildren().each(function(r){n.isDataSourceGroup(r)?this._removeDataSourceGroup(r,e,t):n.isTable(r)&&this._removeTable(r,e,t)},this)},_removeDataSourceGroupFromParent:function(e,t,r){this._removeDataSourceGroup(e,t,r),this._getRemoveResourceFromParentMap(t,r).children[e.id]=!0},_removeDataSourceGroup:function(e,t,r){var o=e.id;r.removeResourcesMap[d.DATA_SOURCE_GROUPS][o]=!0,e.getChildren().each(function(t){n.isDataSourceGroup(t)?this._removeDataSourceGroup(t,e,r):n.isTable(t)&&this._removeTable(t,e,r)},this)},_removeDataIsland:function(e,t){var r=e.id;t.removeResourcesMap[d.DATA_ISLANDS][r]=!0,this._removePresentationChildren(e,t)},_removePresentationChildren:function(e,t){e.getChildren().each(function(e){n.isPresentationSet(e)?this._removePresentationSet(e,t):n.isPresentationField(e)&&this._removePresentationField(e,t)},this)},_removePresentationSetFromParent:function(e,t,r){this._removePresentationSet(e,r),this._getRemoveResourceFromParentMap(t,r).children[e.id]=!0},_removePresentationSet:function(e,t){t.removeResourcesMap[d.PRESENTATION_SETS][e.id]=!0,this._removePresentationChildren(e,t)},_removePresentationFieldFromParent:function(e,t,r){this._removePresentationField(e,r),this._getRemoveResourceFromParentMap(t,r).children[e.id]=!0},_removePresentationField:function(e,t){t.removeResourcesMap[d.PRESENTATION_FIELDS][e.id]=!0},_removeJoinTree:function(e,t){var r=e.id;t.removeResourcesMap[d.JOIN_TREES][r]=!0,e.getCalcFields().each(function(r){this._removeCalcField(r,e,t)},this),e.getJoinAliases().each(function(r){this._removeJoinAlias(r,e,t)},this),e.getJoins().each(function(r){this._removeJoin(r,e,t)},this),e.getFilters().each(function(e){this._removeFilter(e,t)},this),this._removeSourceFromDataIslandBySourceId(r)},_removeJoinFromParent:function(e,t,r){this._removeJoin(e,t,r),t=t||this.joinTrees.byId(e.joinTreeId),this._getRemoveResourceFromParentMap(t,r).joins[e.id]=!0},_removeJoin:function(e,t,r){var o=e.id;r.removeResourcesMap[d.JOINS][o]=!0,this._removeAllJoinExpressionsByJoin(e,r)},_removePresentationFieldsBySourceId:function(e,t){if(!t.dependentPresentationFieldsBySourceId){var r=this.dataStore.getCollections();t.dependentPresentationFieldsBySourceId=this.presentationFields.reduce(function(e,t){var o={field:t,parent:s.getDataIslandOrPresentationSetById(t.parentId,r)};return e[t.sourceId]||(e[t.sourceId]=[]),e[t.sourceId].push(o),e},{})}var i=t.dependentPresentationFieldsBySourceId[e];o.each(i,function(e){var r=e.field,o=e.parent;this._removePresentationFieldFromParent(r,o,t)},this)},_removePresentationFieldsByParent:function(e,t){var r=e.getChildren().toArray();o.each(r,function(r){n.isPresentationSet(r)?this._removePresentationFieldsByParent(r,t):n.isPresentationField(r)&&this._removePresentationFieldFromParent(r,e,t)},this)},_removeAllJoinExpressionsByJoin:function(e,t){n.isJoin(e)&&e.getJoinExpressions().each(function(e){this._removeJoinExpression(e,t)},this)},_removeJoinAliasFromParent:function(e,t,r){this._removeJoinAlias(e,t,r),t=t||this.joinTrees.byId(e.joinTreeId),this._getRemoveResourceFromParentMap(t,r).joinAliases[e.id]=!0},_removeJoinAlias:function(e,t,r){var o=e.id;r.removeResourcesMap[d.JOIN_ALIASES][o]=!0,this._removeJoinsByJoinAlias(o,r),this._removeFiltersByJoinAlias(o,r),this._removeCalcFieldsByJoinAlias(o,r),this._removePresentationFieldsBySourceId(o,r)},_removeJoinExpressionFromParent:function(e,t,r){this._removeJoinExpression(e,r),t=t||this.joins.byId(e.joinId),this._getRemoveResourceFromParentMap(t,r).joinExpressions[e.id]=!0},_removeJoinExpression:function(e,t){t.removeResourcesMap[d.JOIN_EXPRESSIONS][e.id]=!0},_removeTableFromParent:function(e,t,r){this._removeTable(e,t,r),this._getRemoveResourceFromParentMap(t,r).children[e.id]=!0},_removeTable:function(e,t,r){var o=this,i=e.id;r.removeResourcesMap[d.TABLES][i]=!0,e.children.each(function(t){n.isTableGroup(t)?o._removeTableGroup(t,e,r):n.isField(t)&&o._removeField(t,e,r)}),this.tableReferences.each(function(e){e.tableId===i&&this._removeTableReference(e,r)},this)},_removeTableGroupFromParent:function(e,t,r){throw new Error("not implemented")},_removeTableGroup:function(e,t,r){var o=this,i=e.id;if(r.removeResourcesMap[d.TABLE_GROUPS][i]=!0,!e)throw new Error("There is no table group with id "+i);e.children.each(function(t){n.isTableGroup(t)?o._removeTableGroup(t,e,r):n.isField(t)&&o._removeField(t,e,r)})},_removeSourceFromDataIsland:function(e){e.setSourceId(null),e.setSourceType(null)},_removeSourceFromDataIslandBySourceId:function(e){var t=this.dataIslands.where({sourceId:e});o.each(t,function(e){this._removeSourceFromDataIsland(e)},this)},_removeTableReference:function(e,t){var r=this,i=e.id;t.removeResourcesMap[d.TABLE_REFERENCES][i]=!0;var n=this.joinAliases.where({tableReferenceId:i});o.each(n,function(e){var r=this.joinTrees.byId(e.joinTreeId);this._removeJoinTreeCalcFieldsByTableReferenceId(r,i,t)},this),o.each(n,function(e){this._removeJoinAliasFromParent(e,null,t)},this),e.getCalcFields().toArray().forEach(function(o){r._removeCalcField(o,e,t)}),e.getFilters().each(function(e){r._removeFilter(e,t)}),this._removePresentationFieldsBySourceId(i,t),this._removeSourceFromDataIslandBySourceId(i)},_removeJoinTreeCalcFieldsByTableReferenceId:function(e,t,r){var o=this;s.getJoinTreeCalcFieldsByTableReferenceId(e,t).each(function(t){o._removeCalcFieldFromParent(t,e,r)})},_removeJoinsByJoinAlias:function(e,t){var r=this;this.joins.filter(function(t){return r._joinByJoinAliasFilter(e,t)}).forEach(function(e){this._removeJoinFromParent(e,null,t)},this)},_removeFiltersByJoinAlias:function(e,t){var r=this.joinAliases.byId(e),o=this.joinTrees.byId(r.joinTreeId);o.filters.filter(function(t){return t.fieldReferences.some(function(t){return t.sourceId===e})}).forEach(function(e){this._removeFilterFromParent(e,o,t)},this)},_removeCalcFieldsByJoinAlias:function(e,t){var r=this.joinAliases.byId(e),o=this.joinTrees.byId(r.joinTreeId);o.calcFields.filter(function(t){return t.fieldReferences.some(function(t){return t.sourceId===e})}).forEach(function(e){this._removeCalcFieldFromParent(e,o,t)},this)},_joinByJoinAliasFilter:function(e,t){var r;return n.isComplexJoin(t)?r=t.getFieldReferences().map(function(e){return e.sourceId}):n.isJoin(t)&&(r=[t.leftJoinAliasId,t.rightJoinAliasId]),o.some(r,function(t){return t===e})},_joinExpressionByFieldFilter:function(e,t,r){var o=this.dataStore.getCollections(),i=t.id;if(n.isJoinExpression(r)){var a=this.joinAliases.byId(r.leftJoinAliasId),c=this.joinAliases.byId(r.rightJoinAliasId),u=s.getTableReferenceByJoinAlias(a,o).id,d=s.getTableReferenceByJoinAlias(c,o).id,l=r.leftFieldId,h=r.rightFieldId;return i===u&&l===e||i===d&&h===e}if(n.isConstantJoinExpression(r)){var m=this.joinAliases.byId(r.joinAliasId);return i===s.getTableReferenceByJoinAlias(m,o).id&&e===r.fieldId}return!1},_complexJoinByFieldIdFilter:function(e,t,r){if(n.isComplexJoin(r)){var o=this,i=this.dataStore.getCollections();return r.getFieldReferences().some(function(r){var n=o.joinAliases.byId(r.sourceId);return s.getTableReferenceByJoinAlias(n,i).id===t.id&&r.fieldId===e})}return!1},_filterByFieldFilter:function(e,t,r){var o=this,i=this.dataStore.getCollections();return r.getFieldReferences().some(function(r){if(r.fieldId===e){var a=r.sourceId,c=n.isTableReference(t),u=n.isJoinAlias(r.sourceType);if(c&&u){var d=o.joinAliases.byId(r.sourceId);a=s.getTableReferenceByJoinAlias(d,i).id}return a===t.id}})},_calcFieldsByFieldIdAndSourceFilter:function(e,t,r){var o=this,i=this.dataStore.getCollections();return r.getFieldReferences().some(function(r){var a=r.sourceId;if(n.isJoinAlias(r.sourceType)&&n.isTableReference(t)){var c=o.joinAliases.byId(r.sourceId);a=s.getTableReferenceByJoinAlias(c,i).id}return a===t.id&&r.fieldId===e})},_collectJoinExpressionsForFieldRemoval:function(e,t){return this.joinExpressions.filter(function(r){return this._joinExpressionByFieldFilter(e,t,r)},this)},_collectComplexJoinsForFieldRemoval:function(e,t){var r=this;return this.joins.filter(function(o){return r._complexJoinByFieldIdFilter(e,t,o)})},_collectPresentationFieldsWithParentForFieldRemoval:function(e,t){var r=this.dataStore.getCollections();return t.dependentPresentationFieldsByFieldId||(t.dependentPresentationFieldsByFieldId=this.presentationFields.reduce(function(e,t){var o=s.getDataIslandOrPresentationSetById(t.parentId,r),i={presentationField:t,parent:o};return e[t.fieldId]||(e[t.fieldId]=[]),e[t.fieldId].push(i),e},{})),t.dependentPresentationFieldsByFieldId[e]||[]},_collectMasterCalcFieldsForFieldRemoval:function(e,t){var r=this.dataStore.getCollections(),o=this;return this._getPossibleDependentCalcFieldsByFieldSource(t,r).reduce(function(i,n){if(o._calcFieldsByFieldIdAndSourceFilter(e,t,n)){var a=n.sourceId,c=n.sourceType,u=s.getResourceByIdAndType(a,c,r);i.push({calcField:n,source:u})}return i},[])},_getPossibleDependentCalcFieldsByFieldSource:function(e,t){var r,o,i,a,c=[];return n.isTableReference(e)?(c=e.getCalcFields().toArray(),(r=s.getJoinAliasByTableReferenceId(e.id,t))&&(o=t.joinTrees.byId(r.joinTreeId),c=c.concat(o.getCalcFields().toArray()))):n.isJoinTree(e)?c=e.getCalcFields().toArray():n.isConstantGroup(e)&&(c=t.constantGroups.reduce(function(e,t){return e=e.concat(t.getCalcFields().toArray())},[]),i=t.joinTrees.reduce(function(e,t){return e=e.concat(t.getCalcFields().toArray())},[]),c=c.concat(i),a=t.tableReferences.reduce(function(e,t){return e=e.concat(t.getCalcFields().toArray())},[]),c=c.concat(a)),c},_collectFiltersForFieldRemoval:function(e,t){var r=this.dataStore.getCollections(),o=this;return this.filters.reduce(function(i,n){if(o._filterByFieldFilter(e,t,n)){var a=s.getResourceByIdAndType(n.sourceId,n.sourceType,r);i.push({filter:n,source:a})}return i},[])},_removeAllFieldDependencies:function(e,t,r){var i=this._collectJoinExpressionsForFieldRemoval(e,t),n=this._collectComplexJoinsForFieldRemoval(e,t),s=this._collectPresentationFieldsWithParentForFieldRemoval(e,r),a=this._collectMasterCalcFieldsForFieldRemoval(e,t),c=this._collectFiltersForFieldRemoval(e,t);o.each(c,function(e){this._removeFilterFromParent(e.filter,e.source,r)},this),o.each(a,function(e){this._removeCalcFieldFromParent(e.calcField,e.source,r)},this),o.each(i,function(e){this._removeJoinExpressionFromParent(e,null,r)},this),o.each(n,function(e){this._removeJoinFromParent(e,null,r)},this),o.each(s,function(e){this._removePresentationFieldFromParent(e.presentationField,e.parent,r)},this)},_getAllSourcesForGenericField:function(e){var t=this.dataStore.getCollections();return s.getAllTableReferencesByTableId(e.tableId,t)},_removeFieldFromParent:function(e,t,r){this._removeField(e,t,r),this._getRemoveResourceFromParentMap(t,r).children[e.id]=!0},_removeField:function(e,t,r){var i=e.id,n=this._getAllSourcesForGenericField(e);r.removeResourcesMap[d.FIELDS][i]=!0,o.each(n,function(e){this._removeAllFieldDependencies(i,e,r)},this)},_removeCalcFieldFromParent:function(e,t,r){this._removeCalcField(e,t,r),this._getRemoveResourceFromParentMap(t,r).calcFields[e.id]=!0},_removeCalcField:function(e,t,r){var o=e.id;r.removeResourcesMap[d.FIELDS][o]=!0,this._removeAllFieldDependencies(o,t,r)},_removeConstantGroup:function(e,t){var r=e.id;t.removeResourcesMap[d.CONSTANT_GROUPS][r]=!0,e.getCalcFields().toArray().forEach(function(r){this._removeCalcField(r,e,t)},this),this._removeSourceFromDataIslandBySourceId(r)},_removeFilterFromParent:function(e,t,r){this._removeFilter(e,r),this._getRemoveResourceFromParentMap(t,r).filters[e.id]=!0},_removeFilter:function(e,t){t.removeResourcesMap[d.FILTERS][e.id]=!0},_removeResourcesByRemoveResourcesOptions:function(e){this._removeResourcesByMap(e.removeResourcesMap),this._removeResourcesFromParentByMap(e)},_removeResourcesByMap:function(e){o.each(e,function(e,t){var r=this[t];this._removeManyResourcesFromCollection(e,r,{eagerIndexing:!0})},this)},_removeResourcesFromParentByMap:function(e){var t=e.removeResourcesMap,r=e.removeResourcesFromParentMap;o.each(r,function(e,r){var i=u[r],n=t[i];o.each(e,function(e,t){if(!n[t]){var r=e.entity,i=e.removeResourcesMap;o.each(i,function(e,t){var o=r[t];this._removeManyResourcesFromCollection(e,o)},this)}},this)},this)},_removeManyResourcesFromCollection:function(e,t,r){r=r||{};var o=t.filter(function(t){return!e[t.id]});this._setCollection(t,o,{eagerIndexing:r.eagerIndexing})},_setCollection:function(e,t,r){r=r||{},e.fromArray(t,{eagerIndexing:r.eagerIndexing})},_getRemoveResourcesOptions:function(){var e={removeResourcesMap:{},removeResourcesFromParentMap:{}};return o.each(d,function(t){e.removeResourcesMap[t]={}}),o.each(c,function(t){e.removeResourcesFromParentMap[t]={}}),e},_getEntitiesByIds:function(e,t){if(e.length<5)return e.reduce(function(e,r){var o=t.byId(r);return o&&e.push(o),e},[]);var r=this._idsListToMap(e);return t.filter(function(e){return r[e.id]})},_getRemoveResourceFromParentMap:function(e,t){var r=n.getEntityName(e),o=t.removeResourcesFromParentMap[r][e.id];return o||(o=this._createRemoveResourceFromParentMap(e,r),t.removeResourcesFromParentMap[r][e.id]=o),o.removeResourcesMap},_createRemoveResourceFromParentMap:function(e,t){return this[l[t]](e)},_createRemoveResourceFromEntityWithChildrenOnlyCollectionMap:function(e){return{entity:e,removeResourcesMap:{children:{}}}},_createRemoveResourceFromConstantGroupMap:function(e){return{entity:e,removeResourcesMap:{calcFields:{}}}},_createRemoveResourceFromDataSourceMap:function(e){return this._createRemoveResourceFromEntityWithChildrenOnlyCollectionMap(e)},_createRemoveResourceFromDataSourceGroupMap:function(e){return this._createRemoveResourceFromEntityWithChildrenOnlyCollectionMap(e)},_createRemoveResourceFromTableMap:function(e){return this._createRemoveResourceFromEntityWithChildrenOnlyCollectionMap(e)},_createRemoveResourceFromTableGroupMap:function(e){return this._createRemoveResourceFromEntityWithChildrenOnlyCollectionMap(e)},_createRemoveResourceFromTableReferenceMap:function(e){return{entity:e,removeResourcesMap:{calcFields:{},filters:{}}}},_createRemoveResourceFromJoinTreeMap:function(e){return{entity:e,removeResourcesMap:{joins:{},joinAliases:{},calcFields:{},filters:{}}}},_createRemoveResourceFromJoinMap:function(e){return{entity:e,removeResourcesMap:{joinExpressions:{}}}},_createRemoveResourceFromDataIslandMap:function(e){return this._createRemoveResourceFromEntityWithChildrenOnlyCollectionMap(e)},_createRemoveResourceFromPresentationSetMap:function(e){return this._createRemoveResourceFromEntityWithChildrenOnlyCollectionMap(e)}}),o.extend(h.prototype,i),r.exports=h});