/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../../util/profileAttributeUtil","../enum/domainModelErrorsEnum","../mixin/allCollectionsMixin","../util/entityUtil","../util/schemaModelUtil","../enum/schemaEntitiesEnum","../../util/entityIdMapper","../../../util/predicate/invert","../enum/schemaCollectionsEnum","../enum/specialSchemaNamesEnum"],function(e,i,t){var n=e("underscore"),a=e("../../util/profileAttributeUtil"),r=e("../enum/domainModelErrorsEnum"),o=e("../mixin/allCollectionsMixin"),s=e("../util/entityUtil"),d=e("../util/schemaModelUtil"),c=e("../enum/schemaEntitiesEnum"),l=e("../../util/entityIdMapper"),u=e("../../../util/predicate/invert"),h=e("../enum/schemaCollectionsEnum"),m=e("../enum/specialSchemaNamesEnum"),f=m.SCHEMALESS_NAME_SUBSTITUTION,p=["leftJoinAliasId","rightJoinAliasId"],I=["leftFieldId","rightFieldId","leftJoinAliasId","rightJoinAliasId"],v=function(e){this.initialize(e)};n.extend(v.prototype,{initialize:function(e){this.calcFieldNameGenerator=e.calcFieldNameGenerator,this.domainSchemaDAO=e.domainSchemaDAO,this.dataStore=e.dataStore,this.dataAdapter=e.dataAdapter,this.spec=e.domainSchemaSpecification,this.granularSpecs=e.domainSchemaGranularSpecs,this.mixInAllCollections(this.dataStore)},deserialize:function(){},replaceDataSource:function(e){this._replaceDataSourceName(e.name),e.schemaPairs&&this._mapSchemas(e.schemaPairs),this._removeOrphanResources(e.orphanResources),this._cleanUpAfterResourceRemove()},_cleanUpAfterResourceRemove:function(){this._removeEmptyGenericTables(),this._removeLoneConstantJoinExpressions(),this._removeEmptyJoins(),this._removeEmptyJoinTrees(),this._removeSourceLessDataIslands(),this._removeEmptyConstantGroups()},_removeEmptyGenericTables:function(){var e=this,i=this.tables.filter(function(e){return s.isGenericTable(e)&&0===e.children.size()}),t=n.reduce(i,function(e,i){var t=i.parentId,n=e[t];return n||(n=[],e[t]=n),n.push(i.id),e},{});n.each(t,function(i,t){e.domainSchemaDAO.removeTables(i,Number(t))})},replaceDataSourceName:function(e){this._replaceDataSourceName(e)},_replaceDataSourceName:function(e){this.domainSchemaDAO.updateDataSource({name:e,id:this.dataSources.first().id})},mapSchemas:function(e){this._mapSchemas(e),this._cleanUpAfterResourceRemove()},_mapSchemas:function(e){e=n.isArray(e)?e:[e];var i=this.dataSources.first().id;this._removeUnmappedSchemasAndTables(e,i),this._removeLoneJoinAliases();var t=this.dataSourceGroups.reduce(function(e,i){return i.sourceName&&a.containsProfileAttributeWithPlaceholders(i.sourceName)||e.push(i.toJSON()),e},[]);e.forEach(function(n){var a,r=n[0],o=n[1],s=n.indexOf(f),d=0===s,c=1===s;d?this.domainSchemaDAO.addDataSourceGroupAndMoveChildren({name:e[0][1],parentId:i,dataSourceId:i}):(a=t.reduce(function(e,i){return(i.sourceName||i.name)===r&&e.push(i),e},[]),a.forEach(function(e){c?this.domainSchemaDAO.removeDataSourceGroupsAndMoveChildren(e.id,i):this.domainSchemaDAO.updateDataSourceGroup({sourceName:o,id:e.id})},this))},this)},_removeLoneJoinAliases:function(){var e=this.joinTrees.reduce(function(e,i){return 1===i.joinAliases.size()&&e.push(i.joinAliases.first().id),e},[]);this._removeJoinAliases(e)},_removeUnmappedSchemasAndTables:function(e,i){var t=e.reduce(function(e,i){return e[i[0]]=!0,e},{}),r=this.dataSourceGroups.reduce(function(e,i){var n=i.sourceName||i.name,r=t[n],o=i.sourceName&&a.containsProfileAttributeWithPlaceholders(i.sourceName);return r||o||e.push(i.id),e},[],this);this._removeDataSourceGroups(r,i);var o=this.dataSourceGroups.some(function(e){return e.sourceName&&a.containsProfileAttributeWithPlaceholders(e.sourceName)});if(n.isEmpty(t)&&!o){var d=this.tables.reduce(function(e,i){return s.isGenericTable(i)&&e.push(i.id),e},[]);this._removeTables(d,i)}},_removeOrphanResources:function(e){var i,t=this;e=e||[];var a=n.reduce(e,function(e,a){if(n.isArray(a)?i=t._getResourceByParentPath(a):n.isString(a)&&(i=t.tables.findWhere({name:a})),i){var r=i.getParentId(),o=i.getId();s.isDataSourceGroup(i)&&(e.dataSourceGroupByParent[r]||(e.dataSourceGroupByParent[r]={}),e.dataSourceGroupByParent[r][o]=!0),(s.isTable(i)||s.isDerivedTable(i))&&(e.tablesByParent[r]||(e.tablesByParent[r]={}),e.tablesByParent[r][o]=!0),s.isField(i)&&(e.fieldsByParent[r]||(e.fieldsByParent[r]={}),e.fieldsByParent[r][o]=!0)}return e},{dataSourceGroupByParent:{},tablesByParent:{},fieldsByParent:{}});n.each(a.tablesByParent,function(e,i){e=n.keys(e).map(Number),t._removeTables(e,Number(i))}),n.each(a.fieldsByParent,function(e,i){e=n.keys(e).map(Number),t.domainSchemaDAO.removeFields(e,Number(i))}),n.each(a.dataSourceGroupByParent,function(e,i){e=n.keys(e).map(Number),t._removeDataSourceGroups(e,Number(i))})},_getResourceByParentPath:function(e){var i,t,a,r=n.findWhere(e,{type:c.DATA_SOURCE}),o=n.findWhere(e,{type:c.DATA_SOURCE_GROUP}),s=!r&&o;if(o&&(t=o.name,a=this.dataSourceGroups.byField("name",t)),s)i=a;else{var d,l,u=n.pick(r,"name"),h=this.dataSources.findWhere(u);a||(a=h);var m=n.pick(n.findWhere(e,{type:c.TABLE}),"name"),f=a.children.findWhere(m),p=n.findWhere(e,{type:c.FIELD});p&&(d=n.pick(p,"name"),l=f.children.findWhere(d)),i=l||f}return i},reset:function(e){this.dataStore.deserialize(e)},copyTableReference:function(e){this._copyTableReference(e)},removeTableReference:function(e){if(!this.spec.canRemoveTableReference(e))throw new Error("Can not remove table reference");this.domainSchemaDAO.removeTableReferences(e),this._cleanUpAfterResourceRemove()},renameTableReference:function(e){var i=e.id,t=e.name,n=e.resources||[],a={id:i,name:t};if(!this.spec.canRenameTableReference(i,t))throw new Error("Cannot rename table reference.");var r=this.tableReferences.byId(i).getName();this.domainSchemaDAO.updateTableReference(a),n.length>0&&this._updateDependentResourcesWithExpressions(n),this._renameJoinAliasesByTableReference({id:i,newName:t,oldName:r})},_renameJoinAliasesByTableReference:function(e){var i=this,t=e.id,n=e.newName,a=e.oldName;d.getAllJoinAliasesByTableReferenceId(t,this.dataStore.getCollections()).forEach(function(e){e.getTableReferenceId()===t&&i.spec.shouldRenameJoinAliasOnTableReferenceRename(a,e.getName())&&i.domainSchemaDAO.updateJoinAlias({id:e.getId(),name:n})})},_updateDependentResourcesWithExpressions:function(e){var i=n.groupBy(e,"entityType");n.each(i[c.CALC_FIELD],function(e){this.domainSchemaDAO.updateCalcField({id:e.id,expression:e.expression},e.sourceId,e.sourceType)},this),n.each(i[c.COMPLEX_JOIN],function(e){this.domainSchemaDAO.updateJoin({id:e.id,expression:e.expression})},this)},addDataSourceGroups:function(e,i){this.domainSchemaDAO.addDataSourceGroups(e,i)},updateDataSourceGroup:function(e){this._updateDataSourceGroup(e)},_updateDataSourceGroup:function(e){if(!this.spec.canUpdateDataSourceGroup(e.id,e.name))throw new Error("Cannot update data source group");this.domainSchemaDAO.updateDataSourceGroup(e)},removeDataSourceGroups:function(e,i){this._removeDataSourceGroups(e,i),this._cleanUpAfterResourceRemove()},removeDataSourceGroupsAndDefaultSchemaChildren:function(e){var i=e.defaultSchemaId,t=e.dataSourceGroupIds,n=e.dataSourceGroupsParentId,a=this.dataSourceGroups.byId(i),r=a.children.reduce(function(e,i){return s.isDataSourceGroup(i)?e.dataSourceGroupIds.push(i.id):e.tableIds.push(i.id),e},{tableIds:[],dataSourceGroupIds:[]});this._removeTables(r.tableIds,i),this._removeDataSourceGroups(r.dataSourceGroupIds,i),this._removeDataSourceGroups(t,n),this._cleanUpAfterResourceRemove()},_removeDataSourceGroups:function(e,i){this.domainSchemaDAO.removeDataSourceGroups(e,i)},addTablesWithTableReferences:function(e,i){e=n.isArray(e)?e:[e],n.each(e,function(e){var t=this.domainSchemaDAO.addTables(e.table,i)[0],a=n.extend({tableId:t.getId()},e.reference);this.domainSchemaDAO.addTableReference(a)},this)},removeTables:function(e,i){this._removeTables(e,i),this._cleanUpAfterResourceRemove()},_removeTables:function(e,i){this.domainSchemaDAO.removeTables(e,i)},addDerivedTables:function(e,i){this._addDerivedTables(e,i)},_addDerivedTables:function(e,i){var t=this.domainSchemaDAO.addDerivedTables(e,i);return this._addTableReferencesByTables(t)},updateDerivedTable:function(e){var i=e.derivedTable,t=e.resources,a=this.domainSchemaDAO.updateTable(i);if(!this.spec.canRenameDerivedTable(i.id,i.name,i.dataSourceId))throw new Error("Cannot rename derived table");var r=a.getChildren().map(function(e){return e.getName()}),o=n.pluck(i.children,"name"),s=n.difference(r,o),d=a.getChildren().filter(function(e){return n.contains(s,e.getName())}).map(l);this.domainSchemaDAO.removeFields(d,a.getId());var c=n.difference(o,r),u=n.filter(i.children,function(e){return n.contains(c,e.name)});this.domainSchemaDAO.addFields(u,a.getId());var h=a.getChildren().reduce(function(e,i){return e[i.name]=i,e},{});i.children.each(function(e){var i=h[e.name];i&&i.type!==e.type&&this.domainSchemaDAO.updateField({id:i.id,type:e.type})}.bind(this));var m=this.tableReferences.find(function(e){return e.getTableId()===i.id}),f={name:a.getName(),id:m.getId()};t.length>0&&this._updateDependentResourcesWithExpressions(t),this._renameJoinAliasesByTableReference({id:f.id,newName:f.name,oldName:m.getName()}),this.domainSchemaDAO.updateTableReference(f),this._cleanUpAfterResourceRemove()},copyDerivedTable:function(e){var i=this.tables.byId(e),t=this.tableReferences.find(function(i){return i.getTableId()===e}),a=this._getNameForTableReferenceCopy(i.getName()),r=i.toJSON();r=n.extend(n.omit(r,"id"),{children:i.getChildren().map(function(e){return n.extend(n.omit(e.toJSON(),"id"),{entityType:c.FIELD})}),name:a,dataSourceId:i.getDataSourceId()});var o=this._addDerivedTables(r,i.getParentId()),s=n.first(o);this._copySingleTableCalcFields(t.getCalcFields().toArray(),s)},getNameForTableReferenceCopy:function(e){return this._getNameForTableReferenceCopy(e)},_getNameForTableReferenceCopy:function(e){for(var i=this.dataStore.getCollection("tableReferences"),t=0,n=e;i.by({name:n});)t++,n=e+"_"+t;return n},addFields:function(e){n.each(e,function(e){this.domainSchemaDAO.addFields(e.fields,e.parentId)},this)},generateJoins:function(e){var i=e.dataSourceId,t=e.joinsInfo,a=this._getSelfJoinsGroupedByTableId(t),r=this._reCreateTableReferencesForJoinsGeneration(i,a);n.each(t,function(e){var i=this._createJoinTree({name:e.name,suppressCircularJoins:e.suppressCircularJoins,includeAllDataIslandJoins:e.includeAllDataIslandJoins});n.each(e.joins,function(e){var t,a;e.leftTableId===e.rightTableId?(t=r[e.leftTableId][0],a=r[e.leftTableId][1]):(t=r[e.leftTableId],a=r[e.rightTableId],n.isArray(t)&&(t=n.first(t)),n.isArray(a)&&(a=n.first(a))),this._createJoinExpressionUsingSpecs({leftTableReferenceId:t.getId(),rightTableReferenceId:a.getId(),expression:{leftFieldId:e.leftFieldId,rightFieldId:e.rightFieldId,operator:e.operator},joinTreeId:i.getId(),joinWeight:e.weight,joinType:e.type})},this)},this)},updateDataIsland:function(e,i){this.domainSchemaDAO.updateDataIsland(n.extend({id:e},i))},updateJoinAlias:function(e,i){i=n.extend({id:e},i),this.domainSchemaDAO.updateJoinAlias(i)},removeDataIslands:function(e){e=n.isArray(e)?e:[e],this._checkIfDataIslandsNotExistAndThrowError(e),n.each(e,function(e){this.domainSchemaDAO.removeDataIslands(e)},this)},generateBundleKeys:function(e){e=e||[];var i=this;e.forEach(function(e){var t=(e.id,e.type),a=n.pick(e,["id","labelId","descriptionId"]);s.isDataIsland(t)?i.domainSchemaDAO.updateDataIsland(a):s.isPresentationSet(t)?i.domainSchemaDAO.updatePresentationSet(a):s.isPresentationField(t)&&i.domainSchemaDAO.updatePresentationField(a)})},removePresentationItems:function(e){var i=e.parentId,t=e.presentationItems;n.each(t,function(e){s.isPresentationSet(e.type)?this.domainSchemaDAO.removePresentationSets(e.id,i):s.isPresentationField(e.type)&&this.domainSchemaDAO.removePresentationFields(e.id,i)},this)},removePresentationSets:function(e,i){this.domainSchemaDAO.removePresentationSets(e,i)},removePresentationFields:function(e,i){this.domainSchemaDAO.removePresentationFields(e,i)},removeJoinAlias:function(e){this._removeJoinAliases(e),this._cleanUpAfterResourceRemove()},_removeJoinAliases:function(e){this.domainSchemaDAO.removeJoinAliases(e)},createJoinExpression:function(e){this._createJoinExpressionUsingSpecs(e)},createJoinTreeWithJoinExpression:function(e){var i=this._createJoinTree({name:e.name,suppressCircularJoins:e.suppressCircularJoins,includeAllDataIslandJoins:e.includeAllDataIslandJoins}),t=n.extend({},e.joinExpression,{joinTreeId:i.id});this._createJoinExpressionUsingSpecs(t),this._reorderJoinTree(i,e.index)},reorderJoinTree:function(e,i){var t=this.joinTrees.byId(e);this._reorderJoinTree(t,i)},_reorderJoinTree:function(e,i){var t=this.joinTrees.toArray();t.splice(i,0,e),t=n.filter(t,function(t,n){return t.id!==e.id||i===n}),this.domainSchemaDAO.setCollection(h.JOIN_TREES,t)},_createJoinExpressionUsingSpecs:function(e){var i=e.leftTableReferenceId,t=e.rightTableReferenceId,n=e.expression;if(!this.spec.canCreateJoinExpression({leftTableReferenceId:i,rightTableReferenceId:t,leftTableFieldId:n.leftFieldId,rightTableFieldId:n.rightFieldId}))throw new Error("Can not create join expression with given options");var a=e.joinType,o=e.joinWeight,s=this.joinAliases.byField("tableReferenceId",i),d=this.joinAliases.byField("tableReferenceId",t),c=s&&s.getJoinTreeId(),l=d&&d.getJoinTreeId(),u=s&&d,h=!s&&!d,m=s||d,f=c===l;if(h)this._addJoinExpressionBasedOnNewJoinAliasesToExistingJoinTree({leftTableReferenceId:i,rightTableReferenceId:t,expression:n,joinTreeId:e.joinTreeId,joinType:a,joinWeight:o});else if(u){if(!f)throw new Error(r.CANNOT_CREATE_JOIN_BETWEEN_TWO_JOIN_TREES);this._addJoinExpressionBasedOnExistingJoinAliasesToExistingJoinTree({joinTreeId:c,leftJoinAlias:s,rightJoinAlias:d,expression:n,joinType:a,joinWeight:o})}else if(m){var p=c||l;this._addNotExistingJoinAliasAndJoinExpressionToExistingJoinTree({leftTableReferenceId:i,rightTableReferenceId:t,joinTreeId:p,expression:n,joinType:a,joinWeight:o})}},updateJoinExpression:function(e,i){var t=n.omit(i,I);this.domainSchemaDAO.updateJoinExpression(n.extend({id:e},t))},removeJoinExpression:function(e){var i=e.id,t=e.joinId;this._removeJoinExpression(i,t),this._cleanUpAfterResourceRemove()},updateJoin:function(e,i){var t=n.omit(i,p);this.domainSchemaDAO.updateJoin(n.extend({id:e},t))},removeJoin:function(e){this._removeJoin(e),this._cleanUpAfterResourceRemove()},_removeJoin:function(e){var i=this.joins.byId(e),t=i.getJoinTreeId(),n=this._getAllJoinAliasesFromJoin(i);this.domainSchemaDAO.removeJoins(e,t),this._removeSpecificJoinAliasesIfNotUsed(n,t)},_getAllJoinAliasesFromJoin:function(e,i){return i=i||{},s.isJoin(e)?(i[e.getLeftJoinAliasId()]=!0,i[e.getRightJoinAliasId()]=!0):s.isComplexJoin(e)&&(i=e.fieldReferences.reduce(function(e,i){return s.isJoinAlias(i.sourceType)&&(e[i.sourceId]=!0),e},i)),i},_collectAllUsedJoinAliases:function(e){return e.reduce(function(e,i){return this._getAllJoinAliasesFromJoin(i,e),e},{},this)},_collectAllUnUsedJoinAliases:function(e,i){return e.filter(function(e){return!i[e.id]}).map(l)},_removeSpecificJoinAliasesIfNotUsed:function(e,i){var t=this.joinTrees.byId(i),n=this._collectAllUsedJoinAliases(t.joins),a=this._collectAllUnUsedJoinAliases(t.joinAliases,n).filter(function(i){return e[i]});this._removeJoinAliases(a)},removeJoinTree:function(e){var i=this.dataIslands.byField("sourceId",e);this.domainSchemaDAO.removeJoinTrees(e),i&&this.domainSchemaDAO.removeDataIslands(i.id)},updateJoinTree:function(e,i){this.domainSchemaDAO.updateJoinTree(n.extend({id:e},i))},removeConstantJoinExpression:function(e){this.domainSchemaDAO.removeConstantJoinExpressions(e)},createConstantJoinExpression:function(e,i){this.domainSchemaDAO.addConstantJoinExpression(e,i)},updateConstantJoinExpression:function(e){this.domainSchemaDAO.updateConstantJoinExpression(e)},moveDataIslandsUp:function(e){var i,t=e.position;for(i=0;i<t.length;i++)this._reorderDataIslands({dataIslandIds:[e.dataIslandIds[i]],position:t[i]})},moveDataIslandsDown:function(e){var i,t=e.position;for(i=t.length-1;i>=0;i--)this._reorderDataIslands({dataIslandIds:[e.dataIslandIds[i]],position:t[i]})},movePresentationItemsUp:function(e){var i,t=e.position;for(i=0;i<t.length;i++)this._reorderPresentationItems({presentationItemIds:[e.presentationItemIds[i]],position:t[i],targetParentId:e.targetParentId})},movePresentationItemsDown:function(e){var i,t=e.position;for(i=t.length-1;i>=0;i--)this._reorderPresentationItems({presentationItemIds:[e.presentationItemIds[i]],position:t[i],targetParentId:e.targetParentId})},reorderDataIslands:function(e){this._reorderDataIslands(e)},_reorderDataIslands:function(e){var i=this.dataIslands,t=e.dataIslandIds,n=e.position;if(!this._isArrayUnique(t))throw new Error("Data island ids are not unique");n=this._getNewPosition({targetCollection:i,itemIds:t,position:n}),e.position=n,this.domainSchemaDAO.reorderDataIslands(e)},reorderPresentationItems:function(e){this._reorderPresentationItems(e)},_reorderPresentationItems:function(e){var i=this.dataStore.getCollections(),t=e.presentationItemIds,n=e.position,a=e.targetParentId,r=d.getDataIslandOrPresentationSetById(a,i);if(!this._isArrayUnique(t))throw new Error("Presentation item ids are not unique");n=this._getNewPosition({targetCollection:r.getChildren(),itemIds:t,position:n}),e.position=n,this.domainSchemaDAO.reorderPresentationItems(e)},addDataIslands:function(e,i){var t=this,a=[];if(!n.every(e,function(e){return t.spec.canUseDataIslandName(e.name)}))throw new Error("Data islands should have unique name.");n.each(e,function(e){if(this._isPresentationItemNamesAlreadyInUse(e.children))throw new Error("Presentation items have names which are already in use");var i=this._addDataIsland(e),t=e.children.map(function(e){return n.extend({},e,{parentId:i.id})});this._addPresentationItems({presentationItems:t}),a.push(i.id)},this),n.isUndefined(i)||this._reorderDataIslands({dataIslandIds:a,position:i})},addConstantDataIsland:function(e){var i=e.dataIsland,t=e.position,n=this.domainSchemaDAO.addDataIsland(i);this._reorderDataIslands({dataIslandIds:[n.getId()],position:t})},addPresentationItems:function(e){this._addPresentationItems(e)},_addPresentationItems:function(e){var i,t=e.presentationItems,a=e.position;if(this._isPresentationItemNamesAlreadyInUse(t))throw new Error("Presentation items have names which are already in use");n.each(t,function(e,t){var r=e.entityType;n.isUndefined(a)||(i=t+a),s.isPresentationSet(r)?this._addPresentationSets({presentationSets:e,position:i}):s.isPresentationField(r)&&this._addPresentationFields({presentationFields:e,position:i})},this)},_addPresentationSets:function(e){e=e||{};var i=e.position,t=e.presentationSets;t=n.isArray(e.presentationSets)?t:[t],n.each(t,function(e,t){var a={parentId:e.parentId};n.isUndefined(i)||(a.positionInParent=t+i),this.domainSchemaDAO.addPresentationSets(e,a)},this)},_addPresentationFields:function(e){e=e||{};var i=e.position,t=e.presentationFields;t=n.isArray(e.presentationFields)?t:[t],n.each(t,function(e,t){var a={parentId:e.parentId};n.isUndefined(i)||(a.positionInParent=t+i),this.domainSchemaDAO.addPresentationFields(e,a)},this)},_isPresentationItemNamesAlreadyInUse:function(e){var i=this._flattenPresentationItemNames(e),t=d.reduceCollectionByProperty({collection:this.presentationSets.concat(this.presentationFields),property:"name"});return!this.spec.canUseNewPresentationItemNames(i,t)},_flattenPresentationItemNames:function(e){var i=this;return e.reduce(function(e,t){return e.push(t.name),t.children&&(e=e.concat(i._flattenPresentationItemNames(t.children))),e},[])},updatePresentationField:function(e,i){this.domainSchemaDAO.updatePresentationField(n.extend({id:e},i))},updatePresentationSet:function(e,i){this.domainSchemaDAO.updatePresentationSet(n.extend({id:e},i))},addCalcField:function(e){var i=e.calcField,t=e.sourceId,n=e.sourceType,a=e.sourceName;if(this._validateNewCalcField(e),a){var r=this.constantGroups.byField("name",a);r||(r=this.domainSchemaDAO.addConstantGroup({name:a})),t=r.getId(),n=s.getEntityName(r)}this.domainSchemaDAO.addCalcField(i,t,n)},updateCalcField:function(e){var i=e.calcField,t=e.sourceId,n=e.sourceType,a=e.resources||[];this._validateExistingCalcField(e),this.domainSchemaDAO.updateCalcField(i,t,n),this._updateDependentResourcesWithExpressions(a)},removeCalcField:function(e){var i=e.id,t=e.sourceId,n=e.sourceType;this.domainSchemaDAO.removeCalcFields(i,t,n),this._cleanUpAfterResourceRemove()},_removeEmptyConstantGroups:function(){var e=this.constantGroups.chain().filter(function(e){return 0===e.calcFields.size()}).map(l).toArray();this._removeConstantGroups(e)},generateCalcFieldName:function(e){this.calcFieldNameGenerator.reset();var i=u(n.partial(this.granularSpecs.calcFieldNameShouldBeUniqueThroughOtherFieldNamesOnSameLevel,e));return this.calcFieldNameGenerator.generate(null,i)},removeFilter:function(e){this._removeFilter(e)},addFilter:function(e){this._addFilter(e)},_addFilter:function(e){var i=this._collectFieldReferencesForFilter(e),t=this.domainSchemaDAO.addFilterExpression(i,e.sourceId,e.sourceType);this._updateFieldReferencesInFilterExpression(t,e)},updateFilter:function(e){var i=this.filters.byId(e.id);if(i.getSourceId()!==e.sourceId)this._removeFilter({id:i.getId(),sourceId:i.getSourceId(),sourceType:i.getSourceType()}),this._addFilter(e);else{var t=this._collectFieldReferencesForFilter(e),n=this.domainSchemaDAO.updateFilterExpression(t,e.sourceId,e.sourceType);this._updateFieldReferencesInFilterExpression(n,e)}},_collectFieldReferencesForFilter:function(e){var i=[],t=e.expression.left,a=e.expression.right,r=["fieldId","fieldType","sourceId","sourceType"];return t.sourceId&&i.push(n.pick(t,r)),a.sourceId&&i.push(n.pick(a,r)),n.extend({},e,{fieldReferences:i,expression:{left:n.omit(e.expression.left,r),operator:e.expression.operator,right:n.omit(e.expression.right,r)}})},_updateFieldReferencesInFilterExpression:function(e,i){var t=e.getFieldReferences();if(t.size()>0){var n=e.toJSON().expression,a=i.expression.left,r=i.expression.right;a.sourceId?(n.left.fieldReferenceId=t.at(0).getId(),r.sourceId&&(n.right.fieldReferenceId=t.at(1).getId())):r.sourceId&&(n.right.fieldReferenceId=t.at(0).getId()),this.domainSchemaDAO.updateFilterExpression({id:e.getId(),expression:n},e.getSourceId(),e.getSourceType())}},_removeFilter:function(e){var i=e.id,t=e.sourceId,n=e.sourceType;this.domainSchemaDAO.removeFilters(i,t,n)},_removeConstantGroups:function(e){e=n.isArray(e)?e:[e],n.each(e,function(e){var i=this.dataIslands.findWhere({sourceId:e});this.domainSchemaDAO.removeConstantGroups(e),i&&this.domainSchemaDAO.removeDataIslands(i.getId())},this)},_validateNewCalcField:function(e){var i=e.calcField,t=e.sourceId,n=e.sourceType,a=e.sourceName;if(!this.spec.canCreateCalcField({sourceId:t,sourceType:n,calcFieldId:i.id,calcFieldName:i.name,sourceName:a}))throw new Error("Cannot create calc field")},_validateExistingCalcField:function(e){var i=e.calcField,t=e.sourceId,n=e.sourceType,a=e.sourceName;if(!this.spec.canUpdateCalcField({sourceId:t,sourceType:n,calcFieldId:i.id,calcFieldName:i.name,calcFieldType:i.type,sourceName:a}))throw new Error("Cannot update calc field")},_isArrayUnique:function(e){var i=e.reduce(function(e,i){return e[i]=!0,e},{});return n.keys(i).length===e.length},_getNewPosition:function(e){var i=e.targetCollection,t=e.itemIds,a=e.position;if(a>0){var r=i.filter(function(e,i){if(i>=a)return!1;var r=e.getId();return n.some(t,function(e){if(r===e)return!0})});a-=r.length}return a},_isJoinTreeHasNoJoins:function(e){return 0===e.getJoins().size()},_isJoinTreeHasNoJoinAliases:function(e){return 0===e.getJoinAliases().size()},_addTableReferencesByTables:function(e){return n.map(e,function(e){var i={name:e.getName(),tableId:e.getId()};return this.domainSchemaDAO.addTableReference(i)},this)},_createJoinTree:function(e){return this.domainSchemaDAO.addJoinTree(e)},_getDataIslandsConnectedWithJoinTrees:function(e){return e=n.isArray(e)?e:[e],this.dataIslands.chain().filter(function(i){var t=i.getSourceId();return-1!==e.indexOf(t)}).map(l).toArray()},_removeEmptyJoinTrees:function(){var e=this,i=this.joinTrees.chain().filter(function(i){return e._isJoinTreeHasNoJoins(i)&&e._isJoinTreeHasNoJoinAliases(i)}).map(l).toArray(),t=this._getDataIslandsConnectedWithJoinTrees(i);this.domainSchemaDAO.removeJoinTrees(i),this.domainSchemaDAO.removeDataIslands(t)},_removeEmptyJoins:function(){var e=this.joins.filter(function(e){return s.isJoin(e)&&0===e.joinExpressions.size()});n.each(e,function(e){this.domainSchemaDAO.removeJoins(e.getId(),e.getJoinTreeId())},this)},_removeEmptyDataIslands:function(){var e=this.dataIslands.chain().filter(function(e){return!e.getSourceId()}).map(l).toArray();this.domainSchemaDAO.removeDataIslands(e)},_removeSourceLessDataIslands:function(){var e=this.dataIslands.reduce(function(e,i){return i.sourceId||e.push(i.id),e},[]);this.domainSchemaDAO.removeDataIslands(e)},_createJoin:function(e){return this.domainSchemaDAO.addJoin({leftJoinAliasId:e.leftJoinAliasId,rightJoinAliasId:e.rightJoinAliasId,weight:e.weight,type:e.type},e.joinTreeId)},_createJoinAlias:function(e){return this.domainSchemaDAO.addJoinAlias({tableReferenceId:e.tableReferenceId,name:e.name},e.joinTreeId)},_removeJoinExpression:function(e,i){var t=this.joins.byId(i);this.domainSchemaDAO.removeJoinExpressions(e),this._shouldRemoveJoinAfterJoinExpressionRemoval(t)&&this._removeJoin(i)},_shouldRemoveJoinAfterJoinExpressionRemoval:function(e){var i=e.joinExpressions.every(function(e){return s.isConstantJoinExpression(e)});return 0===e.joinExpressions.size()||i},_removeLoneConstantJoinExpressions:function(){var e=this.joins.reduce(function(e,i){if(s.isJoin(i)){var t=i.joinExpressions;t.every(function(e){return s.isConstantJoinExpression(e)})&&(e=e.concat(t.map(l)))}return e},[],this);this.domainSchemaDAO.removeConstantJoinExpressions(e)},_createJoinExpression:function(e){return this.domainSchemaDAO.addJoinExpression({leftJoinAliasId:e.leftJoinAliasId,rightJoinAliasId:e.rightJoinAliasId,leftFieldId:e.expression.leftFieldId,rightFieldId:e.expression.rightFieldId,operator:e.expression.operator},e.joinId)},_addJoinExpressionBasedOnNewJoinAliasesToExistingJoinTree:function(e){var i=e.leftTableReferenceId,t=this.tableReferences.byId(i),n=e.rightTableReferenceId,a=this.tableReferences.byId(n),r=e.joinTreeId,o=e.expression,s=e.joinType,d=e.joinWeight,c=this._createJoinAlias({tableReferenceId:i,name:t.getName(),joinTreeId:r}),l=this._createJoinAlias({tableReferenceId:n,name:a.getName(),joinTreeId:r}),u=this._createJoin({leftJoinAliasId:c.getId(),rightJoinAliasId:l.getId(),joinTreeId:r,type:s,weight:d});this._createJoinExpression({leftJoinAliasId:c.getId(),rightJoinAliasId:l.getId(),expression:o,joinId:u.getId()})},_addNotExistingJoinAliasAndJoinExpressionToExistingJoinTree:function(e){var i,t,n=e.rightTableReferenceId,a=e.leftTableReferenceId,r=e.joinTreeId,o=e.expression,s=e.joinType,d=e.joinWeight,c=this.joinTrees.byId(r),l=this.tableReferences.byId(n),u=this.tableReferences.byId(a),h=this.joinAliases.byField("tableReferenceId",a),m=this.joinAliases.byField("tableReferenceId",n);h?m||(m=this._createJoinAlias({tableReferenceId:n,name:l.getName(),joinTreeId:c.getId()}),i=h.getId(),t=m.getId()):(h=this._createJoinAlias({tableReferenceId:a,name:u.getName(),joinTreeId:c.getId()}),i=h.getId(),t=m.getId());var f=this._createJoin({leftJoinAliasId:i,rightJoinAliasId:t,joinTreeId:c.getId(),type:s,weight:d});this._createJoinExpression({leftJoinAliasId:h.getId(),rightJoinAliasId:m.getId(),expression:o,joinId:f.getId()})},_addJoinExpressionBasedOnExistingJoinAliasesToExistingJoinTree:function(e){var i=e.leftJoinAlias,t=e.rightJoinAlias,n=e.joinTreeId,a=e.expression,r=e.joinType,o=e.joinWeight,s=this.joinTrees.byId(n),d=this._findJoinInJoinTreeByJoinAliases(i.getId(),t.getId(),s);d||(d=this._createJoin({leftJoinAliasId:i.getId(),rightJoinAliasId:t.getId(),joinTreeId:n,type:r,weight:o})),this._createJoinExpression({leftJoinAliasId:i.getId(),rightJoinAliasId:t.getId(),expression:a,joinId:d.getId()})},_findJoinInJoinTreeByJoinAliases:function(e,i,t){return t.getJoins().find(function(t){return t.getRightJoinAliasId()===i&&t.getLeftJoinAliasId()===e||t.getRightJoinAliasId()===e&&t.getLeftJoinAliasId()===i})},_checkIfDataIslandsNotExistAndThrowError:function(e){var i=n.find(e,function(e){return n.isUndefined(this.dataIslands.byId(e))},this);if(i)throw new Error("There is no data island with id "+i)},_removeAllTableReferencesByDataSourceId:function(e){var i=this,t=this.tableReferences.chain().filter(function(t){return d.getTableByTableReference(t,i.dataStore.getCollections()).getDataSourceId()===e}).map(l).toArray();this.domainSchemaDAO.removeTableReferences(t)},_reCreateTableReferencesForJoinsGeneration:function(e,i){return this._removeAllTableReferencesByDataSourceId(e),this._removeEmptyJoinTrees(),this._removeEmptyDataIslands(),this.tables.reduce(function(e,t){var n,a,r=t.getId();return n=this.domainSchemaDAO.addTableReference({name:t.getName(),tableId:r}),e[r]=n,i[r]&&(a=this._copyTableReference(n.getId()),e[r]=[n,a]),e},{},this)},_getSelfJoinsGroupedByTableId:function(e){return n.chain(e).reduce(function(e,i){return e=e.concat(i.joins)},[]).filter(function(e){return e.leftTableId===e.rightTableId}).reduce(function(e,i){return e[i.leftTableId]?e[i.leftTableId]+=1:e[i.leftTableId]=1,e},{}).value()},_copyTableReference:function(e){var i=this.dataStore.getCollection("tableReferences"),t=i.byId(e),n=this._getNameForTableReferenceCopy(t.getName()),a={name:n,tableId:t.getTableId()},r=this.domainSchemaDAO.addTableReference(a);return this._copySingleTableCalcFields(t.getCalcFields().toArray(),r),r},_copySingleTableCalcFields:function(e,i){if(e.length>0){e=n.clone(e);var t=d.getTableByTableReference(i,this.dataStore.getCollections()),a=d.getAllTableFields(t),r=n.indexBy(a,"name"),o=this.constantGroups.reduce(function(e,i){return e.concat(i.getCalcFields().toArray())},[]);for(o=n.indexBy(o,"id");e.length>0;){var c=this._findCalcFieldWithAllDependenciesWhichAreAlreadyPresent(e,r,o);if(!c)throw new Error("could not find next calc field to copy");var l=n.omit(c.toJSON(),"id");l.fieldReferences=this._mapAllCalcFieldsDependenciesToNew({calcField:c,allFieldsIndexedByName:r,allConstantsById:o,source:i});var u=this.domainSchemaDAO.addCalcField(l,i.getId(),s.getEntityName(i));e=n.without(e,c),r[u.getName()]=u}}},_findCalcFieldWithAllDependenciesWhichAreAlreadyPresent:function(e,i,t){var a=this;return n.find(e,function(e){var n=e.getFieldReferences();return 0===n.size()||!n.find(function(e){var n=d.getFieldByFieldReference(e,a.dataStore.getCollections()),r=i[n.getName()];return!t[n.getId()]&&!r})})},_mapAllCalcFieldsDependenciesToNew:function(e){var i=e.calcField,t=e.allFieldsIndexedByName,n=e.allConstantsById,a=e.source;return i.getFieldReferences().map(function(e){var i,r=d.getFieldByFieldReference(e,this.dataStore.getCollections()),o=n[r.getId()];return o?(i=r,this.domainSchemaDAO.createFieldReference({sourceId:i.getSourceId(),sourceType:i.getSourceType(),fieldId:i.getId(),fieldType:s.getEntityName(i)})):(i=t[r.getName()],this.domainSchemaDAO.createFieldReference({sourceId:a.getId(),sourceType:s.getEntityName(a),fieldId:i.getId(),fieldType:s.getEntityName(i)}))},this)},_addDataIsland:function(e){return this.domainSchemaDAO.addDataIsland({name:e.name,label:e.name,sourceId:e.sourceId,sourceType:e.sourceType})}}),n.extend(v.prototype,o),t.exports=v});