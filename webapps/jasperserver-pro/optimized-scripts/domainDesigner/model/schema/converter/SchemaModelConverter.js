/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","underscore","../util/entityUtil","../enum/schemaCollectionsEnum","../factory/domainSchemaCollectionsFactory"],function(e,t,n){function i(e,t,n){e.length>0&&(t[n]=e)}function r(e,t){return e.entityType=s.getEntityName(t),e}var o=e("underscore"),s=e("../util/entityUtil"),a=e("../enum/schemaCollectionsEnum"),c=e("../factory/domainSchemaCollectionsFactory"),l=function(e){this.entityFactory=e.entityFactory};o.extend(l.prototype,{toJSON:function(e){var t=e[a.DATA_SOURCES],n=e[a.TABLE_REFERENCES],r=e[a.JOIN_TREES],o=e[a.DATA_ISLANDS],s=e[a.CONSTANT_GROUPS],c={},l=s.map(function(e){return this.constantGroupToJson(e)},this),d=t.map(function(e){return this.dataSourceToJSON(e)},this),u=n.map(function(e){return this.tableReferenceToJSON(e)},this),p=r.map(function(e){return this.joinTreeToJSON(e)},this),f=o.map(function(e){return this.dataIslandToJSON(e)},this);return i(Object.freeze(l),c,a.CONSTANT_GROUPS),i(Object.freeze(d),c,a.DATA_SOURCES),i(Object.freeze(u),c,a.TABLE_REFERENCES),i(Object.freeze(p),c,a.JOIN_TREES),i(Object.freeze(f),c,a.DATA_ISLANDS),Object.freeze(c)},constantGroupToJson:function(e){var t=e.toJSON(),n=e.calcFields.map(function(e){return this.calcFieldToJson(e)},this);return i(Object.freeze(n),t,"calcFields"),Object.freeze(t)},calcFieldToJson:function(e){var t=e.toJSON(),n=e.fieldReferences.map(function(e){return this.fieldReferenceToJson(e)},this);return i(Object.freeze(n),t,"fieldReferences"),Object.freeze(t)},tableReferenceToJSON:function(e){var t=e.toJSON(),n=e.calcFields.map(function(e){return this.calcFieldToJson(e)},this),r=e.filters.map(function(e){return this.anyFilterToJson(e)},this);return i(Object.freeze(n),t,"calcFields"),i(Object.freeze(r),t,"filters"),Object.freeze(t)},dataSourceToJSON:function(e){var t=e.toJSON();return t=this.resourceChildrenToJson(t,e.children),Object.freeze(t)},dataSourceGroupToJSON:function(e){return this.resourceWithChildrenToJson(e)},tableToJSON:function(e){return this.resourceWithChildrenToJson(e)},tableGroupToJSON:function(e){return this.resourceWithChildrenToJson(e)},fieldToJSON:function(e){var t=e.toJSON();return t=r(t,e),Object.freeze(t)},joinTreeToJSON:function(e){var t=e.toJSON(),n=e.joins.map(function(e){return this.anyJoinToJson(e)},this),r=e.joinAliases.map(function(e){return this.joinAliasToJSON(e)},this),o=e.calcFields.map(function(e){return this.calcFieldToJson(e)},this),s=e.filters.map(function(e){return this.anyFilterToJson(e)},this);return i(Object.freeze(n),t,"joins"),i(Object.freeze(r),t,"joinAliases"),i(Object.freeze(o),t,"calcFields"),i(Object.freeze(s),t,"filters"),Object.freeze(t)},joinToJSON:function(e){var t=e.toJSON();t=r(t,e);var n=e.joinExpressions.map(function(e){return this.anyJoinExpressionToJson(e)},this);return i(Object.freeze(n),t,"joinExpressions"),Object.freeze(t)},complexJoinToJSON:function(e){var t=e.toJSON();t=r(t,e);var n=e.fieldReferences.map(function(e){return this.fieldReferenceToJson(e)},this);return i(Object.freeze(n),t,"fieldReferences"),Object.freeze(t)},joinAliasToJSON:function(e){return Object.freeze(e.toJSON())},joinExpressionToJSON:function(e){var t=e.toJSON();return t=r(t,e),Object.freeze(t)},constantJoinExpressionToJSON:function(e){var t=e.toJSON();return t=r(t,e),Object.freeze(t)},dataIslandToJSON:function(e){var t=e.toJSON(),n=e.children.map(function(e){return this.anyPresentationItemToJson(e)},this);return i(Object.freeze(n),t,"children"),Object.freeze(t)},presentationSetToJson:function(e){var t=e.toJSON();t=r(t,e);var n=e.children.map(function(e){return this.anyPresentationItemToJson(e)},this);return i(Object.freeze(n),t,"children"),Object.freeze(t)},presentationFieldToJson:function(e){var t=e.toJSON();return t=r(t,e),Object.freeze(t)},resourceWithChildrenToJson:function(e){var t=e.toJSON();return t=r(t,e),t=this.resourceChildrenToJson(t,e.children),Object.freeze(t)},resourceChildrenToJson:function(e,t){var n=t.map(function(e){return this.dataSourceResourceToJson(e)},this);return i(Object.freeze(n),e,"children"),e},dataSourceResourceToJson:function(e){return s.isDataSourceGroup(e)?this.dataSourceGroupToJSON(e):s.isTable(e)?this.tableToJSON(e):s.isTableGroup(e)?this.tableGroupToJSON(e):s.isField(e)?this.fieldToJSON(e):void 0},anyFilterToJson:function(e){return s.isFilterExpression(e)?this.filterExpressionToJson(e):s.isComplexFilter(e)?this.complexFilterToJson(e):void 0},filterExpressionToJson:function(e){var t=e.toJSON(),n=e.fieldReferences.map(function(e){return this.fieldReferenceToJson(e,{serializeId:!0})},this);return i(Object.freeze(n),t,"fieldReferences"),t=r(t,e),Object.freeze(t)},complexFilterToJson:function(e){var t=e.toJSON(),n=e.fieldReferences.map(function(e){return this.fieldReferenceToJson(e)},this);return i(Object.freeze(n),t,"fieldReferences"),t=r(t,e),Object.freeze(t)},fieldReferenceToJson:function(e,t){var n=e.toJSON();return t=t||{},t.serializeId&&(n.id=e.id),Object.freeze(n)},anyJoinToJson:function(e){return s.isJoin(e)?this.joinToJSON(e):s.isComplexJoin(e)?this.complexJoinToJSON(e):void 0},anyJoinExpressionToJson:function(e){return s.isJoinExpression(e)?this.joinExpressionToJSON(e):s.isConstantJoinExpression(e)?this.constantJoinExpressionToJSON(e):void 0},anyPresentationItemToJson:function(e){return s.isPresentationSet(e)?this.presentationSetToJson(e):s.isPresentationField(e)?this.presentationFieldToJson(e):void 0},parse:function(e){e=o.defaults(e||{},{json:{},collections:{}}),e.json=o.defaults({},e.json,{constantGroups:[],dataIslands:[],dataSources:[],tableReferences:[],joinTrees:[]}),e.collections=o.defaults({},e.collections,c.create());var t=e.json,n=e.collections;return o.each(t.constantGroups,function(e){this.parseConstantGroup({constantGroupJson:e,collections:n})},this),o.each(t.dataSources,function(e){this.parseDataSource({dataSourceJson:e,collections:n})},this),o.each(t.tableReferences,function(e){this.parseTableReference({tableReferenceJson:e,collections:n})},this),o.each(t.joinTrees,function(e){this.parseJoinTree({joinTreeJson:e,collections:n})},this),o.each(t.dataIslands,function(e){this.parseDataIsland({dataIslandJson:e,collections:n})},this),n},parseConstantGroup:function(e){var t=e.collections,n=e.constantGroupJson,i=this.entityFactory.createConstantGroup({id:n.id,name:n.name});return i.setCalcFields(o.map(n.calcFields||[],function(e){return this.parseCalcField({calcFieldJson:e,parent:i,collections:t})},this)),t.constantGroups.add(i),i},parseCalcField:function(e){var t=e.calcFieldJson,n=e.parent,i=e.collections,r=this.entityFactory.createCalcField({id:t.id,sourceId:t.sourceId||n.id,sourceType:t.sourceType||s.getEntityName(n)});return r.update(t),r.setFieldReferences(o.map(t.fieldReferences||[],function(e){return this.parseFieldReference({fieldReferenceJson:e})},this)),i.fields.add(r),r},parseTableReference:function(e){var t=e.tableReferenceJson,n=e.collections,i=this.entityFactory.createTableReference({id:t.id});return i.update(t),i.setCalcFields(o.map(t.calcFields||[],function(e){return this.parseCalcField({calcFieldJson:e,parent:i,collections:n})},this)),i.setFilters(o.map(t.filters||[],function(e){return this.parseAnyFilter({filterJson:e,parent:i,collections:n})},this)),n.tableReferences.add(i),i},parseDataSource:function(e){var t=e.dataSourceJson,n=e.collections,i=this.entityFactory.createDataSource({id:t.id,name:t.name});return i.setChildren(o.map(t.children||[],function(t){return this.parseDataSourceResource({resource:t,parent:i,dataSource:i,collections:e.collections})},this)),n.dataSources.add(i),i},parseDataSourceGroup:function(e){var t=e.resource,n=e.parent,i=e.dataSource,r=e.collections,s=this.entityFactory.createDataSourceGroup({id:t.id,name:t.name,sourceName:t.sourceName,parentId:t.parentId||n.id,dataSourceId:t.dataSourceId||i.id});return s.setChildren(o.map(t.children||[],function(e){return this.parseDataSourceResource({resource:e,parent:s,dataSource:i,collections:r})},this)),r.dataSourceGroups.add(s),s},parseGenericTable:function(e){var t=e.resource,n=e.parent,i=e.dataSource,r=e.collections,s=this.entityFactory.createGenericTable({id:t.id,name:t.name,parentId:t.parentId||n.id,dataSourceId:t.dataSourceId||i.id});return s.setChildren(o.map(t.children||[],function(e){return this.parseDataSourceResource({resource:e,parent:s,table:s,dataSource:i,collections:r})},this)),r.tables.add(s),s},parseDerivedTable:function(e){var t=e.resource,n=e.parent,i=e.dataSource,r=e.collections,s=this.entityFactory.createDerivedTable({id:t.id,name:t.name,query:t.query,parentId:t.parentId||n.id,dataSourceId:t.dataSourceId||i.id});return s.setChildren(o.map(t.children||[],function(e){return this.parseDataSourceResource({resource:e,parent:s,table:s,dataSource:i,collections:r})},this)),r.tables.add(s),s},parseTableGroup:function(e){var t=e.resource,n=e.parent,i=e.table,r=e.dataSource,s=e.collections,a=this.entityFactory.createTableGroup({id:t.id,name:t.name,parentId:t.parentId||n.id,tableId:t.tableId||i.id,dataSourceId:t.dataSourceId||r.id});return a.setChildren(o.map(t.children||[],function(e){return this.parseDataSourceResource({resource:e,parent:a,table:i,dataSource:r,collections:s})},this)),s.tableGroups.add(a),a},parseField:function(e){var t=e.resource,n=e.parent,i=e.table,r=e.dataSource,o=e.collections,s=this.entityFactory.createGenericField({id:t.id,type:t.type,name:t.name,sourceName:t.sourceName,parentId:t.parentId||n.id,tableId:t.tableId||i.id,dataSourceId:t.dataSourceId||r.id});return o.fields.add(s),s},parseFieldReference:function(e){var t=e.fieldReferenceJson;return this.entityFactory.createFieldReference(t)},parseJoinTree:function(e){var t=e.joinTreeJson,n=e.collections,i=this.entityFactory.createJoinTree({id:t.id});return i.update(t),i.setJoinAliases(o.map(t.joinAliases||[],function(e){return this.parseJoinAlias({joinAliasJson:e,joinTree:i,collections:n})},this)),i.setJoins(o.map(t.joins||[],function(e){return this.parseAnyJoin({joinJson:e,joinTree:i,collections:n})},this)),i.setCalcFields(o.map(t.calcFields||[],function(e){return this.parseCalcField({calcFieldJson:e,parent:i,collections:n})},this)),i.setFilters(o.map(t.filters||[],function(e){return this.parseAnyFilter({filterJson:e,parent:i,collections:n})},this)),n.joinTrees.add(i),i},parseJoin:function(e){var t=e.joinJson,n=e.joinTree,i=e.collections,r=this.entityFactory.createJoin({id:t.id,joinTreeId:n.id||t.joinTreeId,leftJoinAliasId:t.leftJoinAliasId,rightJoinAliasId:t.rightJoinAliasId,weight:t.weight,type:t.type});return r.setJoinExpressions(o.map(t.joinExpressions||[],function(e){return this.parseAnyJoinExpression({joinExpressionJson:e,join:r,collections:i})},this)),i.joins.add(r),r},parseComplexJoin:function(e){var t=e.joinJson,n=e.joinTree,i=e.collections,r=this.entityFactory.createComplexJoin({id:t.id,joinTreeId:n.id||t.joinTreeId,leftJoinAliasId:t.leftJoinAliasId,rightJoinAliasId:t.rightJoinAliasId,weight:t.weight,type:t.type,expression:t.expression});return r.setFieldReferences(o.map(t.fieldReferences||[],function(e){return this.parseFieldReference({fieldReferenceJson:e})},this)),i.joins.add(r),r},parseJoinAlias:function(e){var t=e.joinAliasJson,n=e.joinTree,i=e.collections,r=this.entityFactory.createJoinAlias({id:t.id,joinTreeId:n.id||t.joinTreeId,tableReferenceId:t.tableReferenceId,alwaysIncludeTable:t.alwaysIncludeTable,name:t.name});return i.joinAliases.add(r),r},parseJoinExpression:function(e){var t=e.joinExpressionJson,n=e.join,i=e.collections,r=this.entityFactory.createJoinExpression(t);return n.id&&r.setJoinId(n.id),i.joinExpressions.add(r),r},parseConstantJoinExpression:function(e){var t=e.joinExpressionJson,n=e.join,i=e.collections,r=this.entityFactory.createConstantJoinExpression(t);return n.id&&r.setJoinId(n.id),i.joinExpressions.add(r),r},parseFilterExpression:function(e){var t=e.filterJson,n=e.parent,i=e.collections,r=this.entityFactory.createFilterExpression({id:t.id,sourceId:t.parentId||n.id,sourceType:t.parentType||s.getEntityName(n)});return r.update(t),r.setFieldReferences(o.map(t.fieldReferences||[],function(e){return this.parseFieldReference({fieldReferenceJson:e})},this)),i.filters.add(r),r},parseDataIsland:function(e){var t=e.dataIslandJson,n=e.collections,i=this.entityFactory.createDataIsland({id:t.id});return i.update(t),i.setChildren(o.map(t.children||[],function(e){return this.parseAnyPresentationItem({presentationItem:e,dataIsland:i,parent:i,collections:n})},this)),n.dataIslands.add(i),i},parsePresentationSet:function(e){var t=e.presentationItem,n=e.dataIsland,i=e.parent,r=e.collections,s=this.entityFactory.createPresentationSet(t);return s.setDataIslandId(t.dataIslandId||n.id),s.setParentId(t.parentId||i.id),s.setChildren(o.map(t.children||[],function(e){return this.parseAnyPresentationItem({presentationItem:e,dataIsland:n,parent:s,collections:r})},this)),r.presentationSets.add(s),s},parsePresentationField:function(e){var t=e.presentationItem,n=e.dataIsland,i=e.parent,r=e.collections,o=this.entityFactory.createPresentationField(t);return o.setDataIslandId(t.dataIslandId||n.id),o.setParentId(t.parentId||i.id),r.presentationFields.add(o),o},parseAnyFilter:function(e){var t=e.filterJson,n=t.entityType;return s.isFilterExpression(n)?this.parseFilterExpression(e):s.isComplexFilter(n)?this.parseComplexFilter(e):void 0},parseComplexFilter:function(e){var t=e.filterJson,n=e.parent,i=e.collections,r=this.entityFactory.createComplexFilter({id:t.id,sourceId:t.parentId||n.id,sourceType:t.parentType||s.getEntityName(n)});return r.update(t),r.setFieldReferences(o.map(t.fieldReferences||[],function(e){return this.parseFieldReference({fieldReferenceJson:e})},this)),i.filters.add(r),r},parseDataSourceResource:function(e){var t=e.resource,n=t.entityType;return s.isDataSourceGroup(n)?this.parseDataSourceGroup(e):s.isGenericTable(n)?this.parseGenericTable(e):s.isDerivedTable(n)?this.parseDerivedTable(e):s.isTableGroup(n)?this.parseTableGroup(e):s.isField(n)?this.parseField(e):void 0},parseAnyJoin:function(e){var t=e.joinJson.entityType;return s.isComplexJoin(t)?this.parseComplexJoin(e):s.isJoin(t)?this.parseJoin(e):void 0},parseAnyJoinExpression:function(e){var t=e.joinExpressionJson.entityType;return s.isConstantJoinExpression(t)?this.parseConstantJoinExpression(e):s.isJoinExpression(t)?this.parseJoinExpression(e):void 0},parseAnyPresentationItem:function(e){var t=e.presentationItem,n=t.entityType;return s.isPresentationSet(n)?this.parsePresentationSet(e):s.isPresentationField(n)?this.parsePresentationField(e):void 0}}),n.exports=l});