/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","./domain.chooser","./domain.components","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/util/touch.controller","runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils"],function(e,t,s){var i=e("dragdropextra"),o=i.Droppables,n=e("prototype"),r=n.$,d=n.$$,a=n.$H,l=n.Hash,c=n.$break,u=e("./domain.chooser"),T=e("./domain.components"),_=e("runtime_dependencies/jrs-ui/src/util/utils.common"),h=_.disableSelectionWithoutCursorStyle,D=_.isIPad,E=_.ValidationModule,I=_.sessionManager,S=_.matchAny,N=e("runtime_dependencies/jrs-ui/src/util/touch.controller"),O=e("runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils");T.chooser.fields={SOURCE_FIELDS_DOM_ID:"sourceFieldsTree",DESTINATION_FIELDS_DOM_ID:"destinationFieldsTree",SOURCE_TABLES_COLUMN_DOM_ID:"sourceTablesColumn",DESTINATION_TABLES_COLUMN_DOM_ID:"destTablesColumn",SOURCE_FIELDS_TREE_PROVIDER:"semantic-layer-tree-data-provider",DESTINATION_FIELDS_TREE_PROVIDER:"semantic-layer-query-tree-data-provider",TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_fields",NODE_CLASS:T.ItemNode,MOVE_BUTTONS_PATTERN_PREFIX:"#moveButtons > .",FLOW_NAVIGATION_BUTTONS:["filtersTab","displayTab","saveTopicTab","goToDesigner"],DRAG_PATTERN:".draggable",CONSTANT_TABLE_ID:"constant_fields_level",DOM_IDS_TO_SAVE_TREE_SELECTION:["#sourceTablesColumn","#destTablesColumn","#left","#right","#toLeft","#toRight"],TAB_CLASS_NAME:"tab",dataIslandParser:new RegExp("(^[^\\.]+)"),sourceFieldsTree:null,destinationFieldsTree:null,nodeCopyMoveController:new T.FieldsCopyMoveController,DATA_CHOOSER_MODE:"dataChooserMode",RE_ENTRANCE_MODE:"reEntranceMode",mode:"dataChooserMode",reEntranceDialogCSSSelector:"#selectFields",fillForm:function(){var e=T.chooser.fields.destinationFieldsTree.getRootNode();T.unescapeTree(e);var t=e.childs.first()?Object.toJSON(e.childs.findAll(function(e){return!e.isHidden()})):"";r("selectedModel").writeAttribute("value",t),r("unsavedChangesPresent").writeAttribute("value",T.chooser.isUnsavedChangesPresent().toString())},init:function(e){this.initTrees(),this.mode==this.RE_ENTRANCE_MODE?T.registerClickHandlers([this.moveButtonsClickEventHandler.bind(this)],this.reEntranceDialogCSSSelector):T.registerClickHandlers([this.moveButtonsClickEventHandler.bind(this)]),T.detailsDialog.init(),T.resetTreeSelectionHandler.init(this.DOM_IDS_TO_SAVE_TREE_SELECTION,function(){return[this.sourceFieldsTree,this.destinationFieldsTree]}.bind(this),this.updateButtonsState.bind(this)),this.updateButtonsState(),this.mode==this.DATA_CHOOSER_MODE&&this.processInvalidFields(e.invalidFields),this.sourceFieldsTree.showTree(100,this.sourceTreeUpdateCallback.bind(this),T.treeErrorHandler,!1),this.destinationFieldsTree.showTree(100,this.destTreeUpdateCallback.bind(this),T.treeErrorHandler,!1),h(r(document.body))},processInvalidFields:function(e){var t=e.deletedFields?"<p>"+e.deletedFields.join("</p><p>")+"</p>":null,s=e.movedFields?"<p>"+e.movedFields.join("</p><p>")+"</p>":null,i="";t&&(i+=T.getMessage("error.itemsDeleted",{fields:t})),s&&(i+=T.getMessage("error.movedFields",{fields:s})),i&&T.detailsDialog.show(i)},sourceTreeUpdateCallback:function(){this.updateButtonsState()},destTreeUpdateCallback:function(){this.updateButtonsState(),this.disableNodesInAdhocReEntrance()},disableNodesInAdhocReEntrance:function(){},initTrees:function(){if(this.sourceFieldsTree=T.createItemsTree({handleNodeOnDblclick:!1,treeId:this.SOURCE_FIELDS_DOM_ID,providerId:this.SOURCE_FIELDS_TREE_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,nodeClass:this.NODE_CLASS,dragPattern:this.DRAG_PATTERN,selectOnMousedown:!D()}),this.destinationFieldsTree=T.createItemsTree({handleNodeOnDblclick:!1,treeId:this.DESTINATION_FIELDS_DOM_ID,providerId:this.DESTINATION_FIELDS_TREE_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,nodeClass:this.NODE_CLASS,dragPattern:this.DRAG_PATTERN,selectOnMousedown:!D()}),D()){var e=r(this.SOURCE_FIELDS_DOM_ID);new N(e,e.up(1));var t=r(this.DESTINATION_FIELDS_DOM_ID);new N(t,t.up(1))}a(this.treeEventFactory).each(function(e){[this.sourceFieldsTree,this.destinationFieldsTree].invoke("observe",e.key,e.value.bind(this))}.bind(this)),this.initDragAndDrop()},validateDataIslands:function(e,t){if(O.trees[t.first().getTreeId()]!==this.sourceFieldsTree)return!0;var s=t.collect(function(e){return this.getNodeDataIsland(e)}.bind(this)).uniq(),i=this.getTreeDataIslands(e);return!(s.without(this.CONSTANT_TABLE_ID).length>1)&&this.isSameDataIslandsOnBothTrees(s,i)},moveNodes:function(e,t,s){if(e&&e.first()){T.chooser.setUnsavedChangesPresent(!0);var i=O.trees[t.getTreeId()];if(E.hideError(r(this.DESTINATION_FIELDS_DOM_ID)),!this.validateDataIslands(i,e))return void E.showError(r(this.DESTINATION_FIELDS_DOM_ID),T.getMessage("error.fromDifferentIslands"));var o=this.nodeCopyMoveController.move(e,t);if(!s){var n=i.selectedNodes.collect(function(e){return e});i.resetSelected(),n.each(function(e){e.refreshStyle()}),o.each(function(e){i.openAndSelectNode(e.param.uri)}),o.each(function(e){e.select()})}this.updateButtonsState(),this.mode==this.DATA_CHOOSER_MODE&&I.resetSession(T.chooser.flowExecutionKey)}},nodeDblClick:function(e){if(e){var t=O.trees[e.getTreeId()],s=t===this.sourceFieldsTree?this.destinationFieldsTree:this.sourceFieldsTree;t&&s&&this.moveNodes(t.selectedNodes,s.getRootNode())}},initDragAndDrop:function(){var e=[this.SOURCE_FIELDS_DOM_ID,this.DESTINATION_FIELDS_DOM_ID,this.SOURCE_TABLES_COLUMN_DOM_ID,this.DESTINATION_TABLES_COLUMN_DOM_ID],t=new l;t.set(this.SOURCE_FIELDS_DOM_ID,[this.DESTINATION_FIELDS_DOM_ID,this.DESTINATION_TABLES_COLUMN_DOM_ID]),t.set(this.SOURCE_TABLES_COLUMN_DOM_ID,[this.DESTINATION_FIELDS_DOM_ID,this.DESTINATION_TABLES_COLUMN_DOM_ID]),t.set(this.DESTINATION_FIELDS_DOM_ID,[this.SOURCE_FIELDS_DOM_ID,this.SOURCE_TABLES_COLUMN_DOM_ID]),t.set(this.DESTINATION_TABLES_COLUMN_DOM_ID,[this.SOURCE_FIELDS_DOM_ID,this.SOURCE_TABLES_COLUMN_DOM_ID]);var s=function(e,t,s){var i=e.node;if(i){var o=O.trees[i.getTreeId()],n=S(t,["#"+this.SOURCE_TABLES_COLUMN_DOM_ID],!0)?this.sourceFieldsTree:this.destinationFieldsTree;o!==n&&this.moveNodes(o.selectedNodes,n.getRootNode())}};e.each(function(e){o.remove(e),o.add(e,{accept:t.get(e),onDrop:s.bind(this)})}.bind(this))},getTreeDataIslands:function(e){var t=e.getRootNode();return t?t.childs.collect(function(e){if(!e.isHidden()){var t=this.dataIslandParser.exec(e.param.extra.resourceId);if(t)return t[0]}}.bind(this)).compact().uniq():[]},getNodeDataIsland:function(e){if("/"!==e.parent.param.uri)return this.getNodeDataIsland(e.parent);var t=this.dataIslandParser.exec(e.param.extra.resourceId);return t?t[0]:void 0},isSameDataIslandsOnBothTrees:function(e,t){return e=e.without(this.CONSTANT_TABLE_ID),t=t.without(this.CONSTANT_TABLE_ID),e.length<=1&&t.concat(e).uniq().length<=1},updateButtonsState:function(){var e=this.destinationFieldsTree,t=this.sourceFieldsTree,s=e.getRootNode()&&e.getRootNode().hasVisibleChilds(),i=t.getRootNode()&&t.getRootNode().hasVisibleChilds(),o=s&&e.selectedNodes.length>0,n=i&&t.selectedNodes.length>0,r=e.getRootNode()&&e.getRootNode().hasEnabledChilds(),d={destTreeHasSelectedNodes:o,sourceTreeHasSelectedNodes:n,destTreeHasVisibleNodes:s,sourceTreeHasVisibleNodes:i,destTreeHasEnabledNodes:r,sourceTreeDataIslands:this.getTreeDataIslands(t),destTreeDataIslands:this.getTreeDataIslands(e)};this.updateMoveButtonsState(d),this.updateFlowButtonsState(d),this.updateTreeItems(d),this.updateReEntrantControls(d)},updateReEntrantControls:function(e){},updateMoveButtonsState:function(e){this.moveButtonsUpdateStatusEventFactory.each(function(t){var s=d(this.MOVE_BUTTONS_PATTERN_PREFIX+t.key)[0],i=t.value.bind(this)(e);T.enableButton(s,i)}.bind(this))},updateFlowButtonsState:function(e){this.FLOW_NAVIGATION_BUTTONS.each(function(t){var s=r(t);if(s){T.enableButton(s,e.destTreeHasVisibleNodes);var i=s.up();i.hasClassName(this.TAB_CLASS_NAME)&&T.enableButton(i,e.destTreeHasVisibleNodes)}},this)},disableNode:function(e,t){t?e.disable():e.enable(),e.isParent()&&e.childs.each(function(e){this.disableNode(e,t)}.bind(this))},updateTreeItems:function(e){var t=this.sourceFieldsTree;if(t&&t.getRootNode()){var s=e.destTreeDataIslands.concat([this.CONSTANT_TABLE_ID]).uniq();t.getRootNode().childs.each(function(e,t){var s=1===e.length||e.include(this.getNodeDataIsland(t));this.disableNode(t,!s)}.bind(this,s))}},moveButtonsClickEventHandler:function(e){var t=!1;return this.moveButtonsClickEventMap.each(function(s){if(T.elementClicked(e,s.key)){var i=O.trees[s.value.sourceTree],o=O.trees[s.value.destTree],n=i.selectedNodes;throw s.value.moveAll&&(n=i.getRootNode().childs.findAll(function(e){return!e.isHidden()})),this.moveNodes(n,o.getRootNode(),s.value.moveAll),t=!0,c}}.bind(this)),t}};var v=T.chooser.fields;v.moveButtonsClickEventMap=a({"#left":{sourceTree:v.DESTINATION_FIELDS_DOM_ID,destTree:v.SOURCE_FIELDS_DOM_ID},"#right":{sourceTree:v.SOURCE_FIELDS_DOM_ID,destTree:v.DESTINATION_FIELDS_DOM_ID},"#toLeft":{moveAll:!0,sourceTree:v.DESTINATION_FIELDS_DOM_ID,destTree:v.SOURCE_FIELDS_DOM_ID},"#toRight":{moveAll:!0,sourceTree:v.SOURCE_FIELDS_DOM_ID,destTree:v.DESTINATION_FIELDS_DOM_ID}}),v.treeEventFactory={"leaf:dblclick":function(e){var t=e.memo.node;v.nodeDblClick(t),Event.stop(e)},"leaf:mouseup":function(e){v.updateButtonsState(),Event.stop(e)},"node:dblclick":function(e){var t=e.memo.node;v.nodeDblClick(t),Event.stop(e)},"node:mouseup":function(e){v.updateButtonsState(),Event.stop(e)}},v.moveButtonsUpdateStatusEventFactory=a({left:function(e){return e.destTreeHasSelectedNodes},right:function(e){return e.sourceTreeHasSelectedNodes&&this.validateDataIslands(this.destinationFieldsTree,this.sourceFieldsTree.selectedNodes)},toLeft:function(e){return e.destTreeHasVisibleNodes&&e.destTreeHasEnabledNodes},toRight:function(e){return e.sourceTreeHasVisibleNodes&&this.isSameDataIslandsOnBothTrees(e.sourceTreeDataIslands,e.destTreeDataIslands)}}),void 0===e&&document.observe("dom:loaded",u.initialize.bind(u)),s.exports=v});