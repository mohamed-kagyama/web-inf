/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","dragdropextra","prototype","underscore","jquery","./domain.components","runtime_dependencies/js-sdk/src/components/dateAndTime/DateAndTimePicker","runtime_dependencies/jrs-ui/src/util/utils.common","runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils","runtime_dependencies/jrs-ui/src/components/list.base","runtime_dependencies/js-sdk/src/common/util/xssUtil","runtime_dependencies/jrs-ui/src/core/core.layout","runtime_dependencies/jrs-ui/src/util/touch.controller","runtime_dependencies/js-sdk/src/common/util/parse/date","momentExtension","runtime_dependencies/js-sdk/src/common/util/parse/NumberUtils"],function(e,t,i){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r=e("dragdropextra"),n=r.Droppables,l=e("prototype"),o=l.$,s=l.$$,d=l.Selector,u=l.Field,c=e("underscore"),h=e("jquery"),m=e("./domain.components"),E=e("runtime_dependencies/js-sdk/src/components/dateAndTime/DateAndTimePicker"),p=e("runtime_dependencies/jrs-ui/src/util/utils.common"),f=p.isNotNullORUndefined,g=p.disableSelectionWithoutCursorStyle,V=p.deepClone,T=p.matchAny,M=p.ValidationModule,v=p.isIE,_=p.isIPad,F=p.enableSelection,y=p.cancelEventBubbling,b=e("runtime_dependencies/jrs-ui/src/dynamicTree/dynamicTree.utils"),I=e("runtime_dependencies/jrs-ui/src/components/list.base"),A=I.dynamicList,S=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),N=e("runtime_dependencies/jrs-ui/src/core/core.layout"),R=e("runtime_dependencies/jrs-ui/src/util/touch.controller"),O=e("runtime_dependencies/js-sdk/src/common/util/parse/date"),D=e("momentExtension"),C=e("runtime_dependencies/js-sdk/src/common/util/parse/NumberUtils"),w=new C;m.typesMap={Integer:"number",Decimal:"number",BigDecimal:"number",Time:"date",Date:"date",Timestamp:"date",String:"string",Boolean:"boolean"},m.javaNumericTypesValidation={"java.lang.Double":{min:w.MinRange,max:w.MaxRange},"java.math.BigDecimal":{min:-1/0,max:1/0},"java.lang.Long":{min:"-9223372036854775808",max:"9223372036854775807"},"java.lang.Integer":{min:"-2147483648",max:"2147483647"},"java.lang.Short":{min:"-32768",max:"32767"},"java.lang.Byte":{min:"-128",max:"127"}},m.getNumberBounds=function(e){return m.javaNumericTypesValidation[e]},m.filter={CALENDAR_DATE_FORMAT:"M dd yy",CALENDAR_TIMESTAMP_FORMAT:"M dd yy",CALENDAR_TIME_FORMAT:"HH:mm:ss",init:function(e){this.TIMEZONE_OFFSET=e.timeOffset,this.FILTER_DATE_FORMAT=e.dateFormat||"MMM dd yyyy",this.FILTER_TIMESTAMP_FORMAT=e.dateTimeFormat||"MMM dd yyyy HH:mm:ss",this.FILTER_TIME_FORMAT=e.timeFormat||"HH:mm:ss",this.CALENDAR_DATE_TIME_SEPARATOR=e.calendarDateTimeSeparator||" ",this.CALENDAR_DATE_FORMAT=e.calendarDateFormat||"M dd yy",this.CALENDAR_TIMESTAMP_FORMAT=e.calendarDateTimeFormat||"M dd yy",this.CALENDAR_TIME_FORMAT=e.calendarTimeFormat||"HH:mm:ss",this.DECIMAL_SEPARATOR=e.decimalSeparator||".",this.GROUPING_SEPARATOR=e.groupingSeparator||",",this.numberFormat=m.NumberFormat(this.DECIMAL_SEPARATOR,this.GROUPING_SEPARATOR),window.MONTH_NAMES=window.Calendar._SMN,window.DAY_NAMES=window.Calendar._SDN,this.ATTRIBUTES_PATTERN=new RegExp("\\s*attribute\\s*\\(\\s*'[^\\/'\\s][^\\/']*'(?:\\s*,\\s*'[^\\/'\\s][^\\/']*')*\\s*\\)\\s*"),this.ATTRIBUTE_VALUE_PATTERN=new RegExp("'(.*)'"),m.javaToDataTypeMap=e.javaToDataTypeMap},toNumber:function(e){return this.numberFormat.toNumber(e)},normalizeNumberEntry:function(e){return this.numberFormat.normalizeNumberEntry(e)},toString:function(e){switch(a(e)){case"undefined":case"function":case"unknown":return"{''}";case"boolean":case"number":case"string":return"{"+e.toString()+"}"}return null===e?"{''}":Object.isArray(e)?"{"+this.arrayToString(e)+"}":void 0},arrayToString:function(e){return e.collect(function(e){return f(e)&&""!==e?e:"''"}).join(", ")}},m.FilterItem=function(e){if(!e||!e.node&&!e.json)throw"Trying to create FilterItem with empty input";this.fieldId=null,this.id=null,this.name=null,this.type=null,this.value=null,this.comparison="",this.locked=null,this.dataType=null,this.javaType=null,this.index=1,e.node?this._initNode(e.node):this._initJson(e.json)},c.extend(m.FilterItem.prototype,{_initNode:function(e){if(e&&e.param&&e.param.extra){var t=e.param.extra;this.setFieldId(e.param.id),this.name=e.name,this.value=[],this.locked=!1,this.javaType=t.JavaType,m.javaToDataTypeMap&&this.javaType&&(t.dataType=m.javaToDataTypeMap[this.javaType]),this.dataType=t.dataType,this.type=m.typesMap[this.dataType]}},_initJson:function(e){e&&(this.init=!0,this.setFieldId(e.fieldId),this.name=e.fieldName,this.type=e.ruleTypeId||e.ruleType,this.setValues(e.value||e.values),this.locked=!e.isParameter,this.comparison=e.comparisonId||e.comparison,this.dataType=e.dataType,this.javaType=e.javaType||e.JavaType)},setFieldId:function(e){this.fieldId=e,this.id=this.normalizeIdentifier(e)},setValues:function(e){if("field"===this.type){this.field2Id=e[0];var t=c.find(b.nodes,function(t){return t.param.id===e[0]});this.name2=t&&t.name}else"string"===this.type&&null===e[0]&&(e=[m.getMessage("filter_null_value")]);this.value=e},getValues:function(){return"field"===this.type?[this.field2Id]:this.value},normalizeIdentifier:function(e){return e&&e.length>0?e.gsub(/[.]/,"_").gsub(/[\W]/,""):e},updateIndex:function(e){this.index=e,this.id+="_"+e,this.init||(this.name+="_"+e)},toJSON:function(){return{fieldId:this.fieldId,fieldName:this.name,ruleTypeId:this.type,value:this.getValues(),isParameter:!this.locked,comparisonId:this.comparison,dataType:this.dataType,javaType:this.javaType}},initFieldFilterItem:function(e){this.type="field",this.field2Id=e.fieldId,this.name2=e.name,this.value=[this.name2]}}),m.FilterList=function(e){if(this._valueList=[],this._keyPositionMapping={},e&&"object"===a(e))for(var t in e)this.set(t,e[t])},c.extend(m.FilterList.prototype,{reIndex:function(e,t){var i;for(var a in this._keyPositionMapping)(i=this._keyPositionMapping[a])>e&&(this._keyPositionMapping[a]=i+t)},unset:function(e){this._valueList.splice(this._keyPositionMapping[e],1),this.reIndex(this._keyPositionMapping[e],-1),delete this._keyPositionMapping[e]},set:function(e,t,i){this._keyPositionMapping[e]>=0?this._valueList.splice(this._keyPositionMapping[e],1,t):(i=i>=0?i:this._valueList.length,this._valueList.splice(i,0,t),i<this._valueList.length-1&&this.reIndex(i-1,1),this._keyPositionMapping[e]=i)},get:function(e){return this._valueList[this._keyPositionMapping[e]]},size:function(){return this._valueList.length},values:function(){return this._valueList.clone()},collect:function(e){return c.collect.call(c,this._valueList,e)}}),m.FilterEditor=function(e,t){this.filterValue=e,t&&(this.flowExecutionKey=t),this.init()},c.extend(m.FilterEditor.prototype,{EDITOR_TEMPLATE:"editorTemplate",create:function(e,t){if(!e||!e.type)return null;var i=null;switch(e.type){case"string":i=new m.StringFilterEditor(e,t);break;case"number":i=new m.NumberFilterEditor(e);break;case"date":case"time":i=new m.DateFilterEditor(e);break;case"boolean":i=new m.BooleanFilterEditor(e);break;case"field":i=new m.FieldFilterEditor(e);break;default:throw"Unsupported editor type: [#{editorType}]".interpolate({editorType:e.type})}return i},init:function(){this.valueEditorsCache={},this.valueEditorsFactory=this.createValueEditorsFactory(),this.initTemplate(),this.initComparisons(this.getFirstComparison()),this.initEventHandlers()},createValueEditorsFactory:function(){return{}},afterDraw:function(){this.fillinTemplate()},beforeRemove:function(){this.removeEventHandlers()},initTemplate:function(){this.editorTemplate=this._cloneTemplate(this.EDITOR_TEMPLATE),this.fieldNameElement=this.editorTemplate.select(".fieldName").first()},fillinTemplate:function(){this.fieldNameElement.update(S.hardEscape(this.getOriginalValue().name)),this.updateFilterValueEditor()},initComparisons:function(e){this._comparisons=this.createComparisons(),this.comparisonId=e,this.comparisonsSelect=this.editorTemplate.select("#fieldAndOperation select")[0],this._comparisons.each(function(t,i){var a={id:t,title:m.getMessage(t)};t===e&&(a.selected="selected",this.selectedIndex=i);var r=new Element("option",a).insert(m.getMessage(t));this.comparisonsSelect.insert(r)}.bind(this))},getFirstComparison:function(){return this.getOriginalValue().comparison||"equals"},initEventHandlers:function(){this.comparisonsSelect.observe("change",this.comparisonSelectedHandler.bindAsEventListener(this)),this.getTemplate().observe("submit",function(e){Event.stop(e)})},removeEventHandlers:function(){Event.stopObserving(this.comparisonsSelect),Event.stopObserving(this.getTemplate())},comparisonSelectedHandler:function(e){this.comparisonId=m.getSelectedOptionId(e.element()),this.updateFilterValueEditor()},updateFilterValueEditor:function(){this.valueEditor=this.createValueEditor(this.comparisonId);var e=this.valueEditor.getTemplate();this.editorTemplate.select("#values")[0].replace(e),this.valueEditor.afterDraw()},createValueEditor:function(e){if(!e)return null;var t=this.getFactoryKey(e),i=this.valueEditorsCache[t];if(!i)try{i=this.valueEditorsFactory[t](this.getOriginalValue.bind(this),e,this.flowExecutionKey),this.valueEditorsCache[t]=i}catch(e){throw"Editor for #{name} is undefined".interpolate({name:t})}return i},processTemplate:function(e){var t=e.select(".fieldName")[0],i=e.select(".operation")[0],a=e.select(".value")[0],r=e.select(".lock")[0],n=this.getValue(),l=n.getOriginalValue();t.update(S.hardEscape(l.name)),i.update(S.hardEscape(m.getMessage(l.comparison))),a.update(S.hardEscape(n.getFormattedValue())),n.lockStatusElement&&r.update(l.locked?S.hardEscape(m.getMessage("domain.filter.locked")):S.hardEscape(m.getMessage("domain.filter.unlocked")));var o="f"+l.id+"_filter";if(!s("#"+o)[0]){var d=n.getTemplate();d.removeClassName("hidden"),e.appendChild(d),d.writeAttribute("id",o)}return e},getTemplate:function(){return this.editorTemplate},getOriginalValue:function(){return this.filterValue},getFormattedValue:function(){return m.filter.toString(this.getOriginalValue().value)},resetToCurrentEditor:function(){this.comparisonId=this.getOriginalValue().comparison,this.comparisonsSelect.selectedIndex=this.selectedIndex},applyEditorValue:function(){this.filterValue=this.getValue(),this.selectedIndex=this.comparisonsSelect.selectedIndex},cancel:function(){this.resetToCurrentEditor(),g(o(document.body)),this.valueEditor&&this.valueEditor.cancel()},getValue:function(){var e=V(this.getOriginalValue());return e.value=this._toArray(this.valueEditor.getValue()),e.comparison=this.comparisonId,e},validate:function(){return this.valueEditor.validate()},_cloneTemplate:function(e){return Element.clone(e,!0)||null},_toArray:function(e){return Object.isArray(e)?e:[e]},handleClick:function(e){this.valueEditor&&m.FilterValueEditor.handleClick.call(this.valueEditor,e)}}),m.StringFilterEditor=function(e,t){m.FilterEditor.call(this,e,t)},m.StringFilterEditor.prototype=V(m.FilterEditor.prototype),m.StringFilterEditor.addMethod("createComparisons",function(){return["isOneOf","isNotOneOf","equals","doesNotEqual","contains","doesNotContain","startsWith","doesNotStartWith","endsWith","doesNotEndWith"]}),m.StringFilterEditor.addMethod("getFactoryKey",function(e){switch(e){case"isOneOf":case"isNotOneOf":return"MultipleValuesEditor";case"equals":case"doesNotEqual":return"ComboSelectEditor";case"contains":case"doesNotContain":case"startsWith":case"doesNotStartWith":case"endsWith":case"doesNotEndWith":return"StringValueEditor";default:throw"Undefined Value type : #{valueType}".interpolate({valueType:e})}}),m.StringFilterEditor.addMethod("createValueEditorsFactory",function(){return{MultipleValuesEditor:function(e,t,i){return new m.MultipleValuesEditor(e,t,i)},ComboSelectEditor:function(e,t,i){return new m.ComboSelectEditor(e,t,i)},StringValueEditor:function(e,t,i){return new m.StringValueEditor(e,t,i)}}}),m.NumberFilterEditor=function(e){m.FilterEditor.call(this,e)},m.NumberFilterEditor.prototype=V(m.FilterEditor.prototype),m.NumberFilterEditor.addMethod("createComparisons",function(){return["equals","isNotEqualTo","isGreaterThan","lessThan","isGreaterThanOrEqualTo","isLessThanOrEqualTo","isBetween","isNotBetween"]}),m.NumberFilterEditor.addMethod("createValueEditor",function(e){if(!e)return null;var t=null;switch(e){case"equals":case"isNotEqualTo":case"isGreaterThan":case"lessThan":case"isGreaterThanOrEqualTo":case"isLessThanOrEqualTo":t=new m.NumberValueEditor(this.getOriginalValue.bind(this),e);break;case"isBetween":case"isNotBetween":t=new m.NumberRangeEditor(this.getOriginalValue.bind(this),e);break;default:throw"Undefined Value type : #{valueType}".interpolate({valueType:e})}return t}),m.NumberFilterEditor.addMethod("getFormattedValue",function(){var e=this.getOriginalValue();switch(e.comparison){case"isBetween":case"isNotBetween":return"{"+e.value.join(" and ")+"}";default:return e.value[0]}}),m.NumberFilterEditor.addMethod("updateFilterValueEditor",function(){m.FilterEditor.prototype.updateFilterValueEditor.call(this),this.registerBlurHandlers()}),m.NumberFilterEditor.addMethod("registerBlurHandlers",function(){var e=this.valueEditor.getValueElement();!Object.isArray(e)&&(e=[e]),e.invoke("observe","blur",function(e){var t=this.getValue(),i=m.filter.normalizeNumberEntry(t);t!=i&&this.setValue(i)})}),m.BooleanFilterEditor=function(e){m.FilterEditor.call(this,e)},m.BooleanFilterEditor.prototype=V(m.FilterEditor.prototype),m.BooleanFilterEditor.addMethod("createComparisons",function(){return["equals","isNotEqualTo"]}),m.BooleanFilterEditor.addMethod("createValueEditor",function(e){if(!e)return null;var t=null;switch(e){case"equals":case"isNotEqualTo":t=new m.BooleanSelectEditor(this.getOriginalValue.bind(this),e);break;default:throw"Undefined Value type : #{valueType}".interpolate({valueType:e})}return t}),m.DateFilterEditor=function(e,t){m.FilterEditor.call(this,e,t)},m.DateFilterEditor.prototype=V(m.FilterEditor.prototype),m.DateFilterEditor.addMethod("createComparisons",function(){return["equals","isNotEqualTo","isAfter","isBefore","isOnOrAfter","isOnOrBefore","isBetween","isNotBetween"]}),m.DateFilterEditor.addMethod("createValueEditor",function(e){if(!e)return null;var t=null;switch(e){case"equals":case"isNotEqualTo":case"isAfter":case"isBefore":case"isOnOrAfter":case"isOnOrBefore":t=new m.DateValueEditor(this.getOriginalValue.bind(this),e);break;case"isBetween":case"isNotBetween":t=new m.DateRangeEditor(this.getOriginalValue.bind(this),e);break;default:throw"Undefined Value type : #{valueType}".interpolate({valueType:e})}return t}),m.DateFilterEditor.addMethod("getFormattedValue",function(){var e=this.getOriginalValue();switch(e.comparison){case"isBetween":case"isNotBetween":return"{"+e.value.join(" and ")+"}";default:return m.FilterEditor.prototype.getFormattedValue.call(this)}}),m.TimeFilterEditor=function(e,t){m.FilterEditor.call(this,e,t)},m.TimeFilterEditor.prototype=V(m.FilterEditor.prototype),m.TimeFilterEditor.addMethod("createComparisons",function(){return["equals","isNotEqualTo","isAfter","isBefore","isOnOrAfter","isOnOrBefore","isBetween","isNotBetween"]}),m.TimeFilterEditor.addMethod("createValueEditor",function(e){if(!e)return null;var t=null;switch(e){case"equals":case"isNotEqualTo":case"isAfter":case"isBefore":case"isOnOrAfter":case"isOnOrBefore":t=new m.StringValueEditor(this.getOriginalValue.bind(this),e);break;case"isBetween":case"isNotBetween":t=new m.TimeRangeEditor(this.getOriginalValue.bind(this),e);break;default:throw"Undefined Value type : #{valueType}".interpolate({valueType:e})}return t}),m.DateFilterEditor.addMethod("getFormattedValue",function(){var e=this.getOriginalValue();switch(e.comparison){case"isBetween":case"isNotBetween":return"{"+e.value.join(" and ")+"}";default:return m.FilterEditor.prototype.getFormattedValue.call(this)}}),m.FieldFilterEditor=function(e,t){this.newFilterValue=V(e),m.FilterEditor.call(this,e,t)},m.FieldFilterEditor.prototype=V(m.FilterEditor.prototype),m.FieldFilterEditor.addMethod("createComparisons",function(){switch(m.typesMap[this.getOriginalValue().dataType]){case"string":return["equals","contains","startsWith","endsWith","doesNotEqual","doesNotContain"];case"number":return["equals","isNotEqualTo","isGreaterThan","lessThan","isGreaterThanOrEqualTo","isLessThanOrEqualTo"];case"date":return["equals","isNotEqualTo","isAfter","isBefore","isOnOrAfter","isOnOrBefore"];case"boolean":return["equals","isNotEqualTo"];default:throw"Unsupported editor type: [#{editorType}]".interpolate({editorType:window.filterValue.type})}}),m.FieldFilterEditor.addMethod("initTemplate",function(){this.editorTemplate=this._cloneTemplate(this.EDITOR_TEMPLATE);var e=this.editorTemplate.down(".checkBox.lock");e&&e.remove();var t=this._cloneTemplate("fieldEditor");t.writeAttribute("id","fieldAndOperation"),t.removeClassName("hidden"),this.editorTemplate.select("#fieldAndOperation").first().replace(t),this.fieldNameElement=this.editorTemplate.select(".fieldName").first(),this.fieldValueElement=this.editorTemplate.select(".fieldName")[1]}),m.FieldFilterEditor.addMethod("handleClick",function(e){T(e,["button#swap"],!0)&&this.swapClickHandler()}),m.FieldFilterEditor.addMethod("fillinTemplate",function(){var e=this.newFilterValue;this.fieldNameElement.update(S.hardEscape(e.name)),this.fieldValueElement.update(S.hardEscape(e.name2))}),m.FieldFilterEditor.addMethod("getValue",function(){return this.newFilterValue.comparison=this.comparisonId,this.newFilterValue.locked=!0,this.newFilterValue}),m.FieldFilterEditor.addMethod("cancel",function(){this.resetToCurrentEditor(),this.newFilterValue=V(this.getOriginalValue())}),m.FieldFilterEditor.addMethod("getFormattedValue",function(){return"{"+String(this.getOriginalValue().name2)+"}"}),m.FieldFilterEditor.addMethod("validate",function(){return!0}),m.FieldFilterEditor.addMethod("swapClickHandler",function(){var e=this.newFilterValue,t=e.name,i=e.fieldId;return e.name=e.name2,e.fieldId=e.field2Id,e.name2=t,e.field2Id=i,e.value=[e.name],this.fillinTemplate(),!0}),m.FieldFilterEditor.addMethod("comparisonSelectedHandler",function(e){this.comparisonId=m.getSelectedOptionId(e.element())}),m.FilterValueEditor=function(e,t){this.getOriginalValue=e,this.currentComparisonId=t,this.init()},m.FilterValueEditor.addMethod("init",function(){this.initTemplate(),this.afterTemplateInitialization(),this.initValidators(),this.initEventHandlers(),this.clickHandlersHash=this.createHandlersHash()}),m.FilterValueEditor.addMethod("initTemplate",function(){this.template=this.createTemplate(),this.initValueElements()}),m.FilterValueEditor.addMethod("createTemplate",function(){var e=Element.clone(this.valueEditorId,!0);return e.writeAttribute("id","values"),e.removeClassName("hidden"),e}),m.FilterValueEditor.addMethod("afterTemplateInitialization",function(){}),m.FilterValueEditor.addMethod("fillinTemplate",function(){this.currentComparisonId===this.getOriginalValue().comparison&&this.setValue(this.getOriginalValue().value),this.setTitle(this.currentComparisonId)}),m.FilterValueEditor.addMethod("setTitle",function(e){var t=this.getValueElement();!Object.isArray(t)&&(t=[t]),t&&t.each(function(t){(t.up("label")||t).writeAttribute("title",this.getTitleMessage(e))}.bind(this))}),m.FilterValueEditor.addMethod("getTitleMessage",function(){return m.getMessage("filter_default_title")}),m.FilterValueEditor.addMethod("initValidators",function(){this.validators=this.createCommonValidators().concat(this.createValidators())}),m.FilterValueEditor.addMethod("createCommonValidators",function(){return[{validator:function(){return m.valueNotEmptyValidator(this.getValue(),m.getMessage("value_should_be_not_empty"))}.bind(this),element:this.getValueElement()}]}),m.FilterValueEditor.addMethod("createValidators",function(){return[]}),m.FilterValueEditor.addMethod("validate",function(){return this.removeMalicious(),M.validate(this.validators)}),m.FilterValueEditor.addMethod("removeMalicious",function(){this.setValue(this.stripValue(this.getValue()))}),m.FilterValueEditor.handleClick=function(e){var t=c.find(this.clickHandlersHash,function(t,i){return e.match(i)});t&&t.call(this,e)},m.FilterValueEditor.addMethod("createHandlersHash",function(){return{}}),m.FilterValueEditor.addMethod("afterDraw",function(){this.fillinTemplate()}),m.FilterValueEditor.addMethod("initValueElements",function(){}),m.FilterValueEditor.addMethod("initEventHandlers",function(){}),m.FilterValueEditor.addMethod("cancel",function(){}),m.FilterValueEditor.addMethod("getTemplate",function(){return this.template}),m.FilterValueEditor.addMethod("setValue",function(e){this.getValueElement().setValue(String(e[0]))}),m.FilterValueEditor.addMethod("getValue",function(){return this.getValueElement().getValue()}),m.FilterValueEditor.addMethod("stripValue",function(e){var t=function(e){return e?e.strip().stripScripts():""};return Object.isArray(e)?e.collect(t):[t(e)]}),m.FilterValueEditor.addMethod("isTimestampField",function(){return"Timestamp"===this.getOriginalValue().dataType}),m.FilterValueEditor.addMethod("isTimeField",function(){return"Time"===this.getOriginalValue().dataType}),m.FilterValueEditor.addMethod("_getControlName",function(){return this.isTimestampField()?"datetimepicker":this.isTimeField()?"timepicker":"datepicker"}),m.FilterValueEditor.addMethod("getValueElement",function(){}),m.SingleDictionaryEditor=function(e,t,i){this.searchParams={limitType:"contains",itemId:e().fieldId,searchWord:""},this.flowExecutionKey=i,m.FilterValueEditor.apply(this,arguments)},m.SingleDictionaryEditor.prototype=V(m.FilterValueEditor.prototype),m.SingleDictionaryEditor.addMethod("afterTemplateInitialization",function(){this.retrieveAvailableDictionaryValues(this.searchParams)}),m.SingleDictionaryEditor.addMethod("initValueElements",function(){this.searchInputElement=this.getTemplate().select(".searchLockup input")[0],this.searchButtonElement=this.getTemplate().select(".searchLockup > .search.button")[0],this.searchClearElement=this.getTemplate().select(".searchLockup .button.searchClear")[0]}),m.SingleDictionaryEditor.addMethod("initEventHandlers",function(){this.searchInputElement.observe("keyup",this.handleKeyup.bind(this))}),m.SingleDictionaryEditor.addMethod("handleKeyup",function(e){switch(e.keyCode){case Event.KEY_TAB:case Event.KEY_ESC:case Event.KEY_LEFT:case Event.KEY_UP:case Event.KEY_RIGHT:case Event.KEY_DOWN:case Event.KEY_DELETE:case Event.KEY_HOME:case Event.KEY_END:case Event.KEY_PAGEUP:case Event.KEY_PAGEDOWN:case Event.KEY_INSERT:return!0;case Event.KEY_RETURN:this.doSearch();break;default:this.onCharacterPressed(e)}return!0}),m.SingleDictionaryEditor.addMethod("createHandlersHash",function(){return{".button.search":function(){this.doSearch()},".button.searchClear":function(){this.onClearButtonClicked(),this.doSearch(this.onClearButtonClicked.bind(this))}}}),m.SingleDictionaryEditor.addMethod("onCharacterPressed",function(){this.updateSearchClearButtonState()}),m.SingleDictionaryEditor.addMethod("updateSearchClearButtonState",function(){this.searchInputElement.getValue().blank()?this.searchClearElement.removeClassName(N.UP_CLASS):this.searchClearElement.addClassName(N.UP_CLASS)}),m.SingleDictionaryEditor.addMethod("doSearch",function(e){M.hideError(this.getAvailableValueElement()),this.searchParams.itemId=this.getOriginalValue().fieldId,this.searchParams.searchWord=this.searchInputElement.getValue(),this.retrieveAvailableDictionaryValues(this.searchParams,e)}),m.SingleDictionaryEditor.addMethod("onClearButtonClicked",function(){this.setSearchValue("")}),m.SingleDictionaryEditor.addMethod("retrieveAvailableDictionaryValues",function(e,t){m.sendAjaxRequest({flowExecutionKey:this.flowExecutionKey,eventId:"availableValues"},e,this.handleAvailableValuesRetrieved.bindAsEventListener(this,t))}),m.SingleDictionaryEditor.addMethod("handleAvailableValuesRetrieved",function(e,t){if(!e||"object"!==a(e)){if("INFO:TOO_MANY_ROWS"===e)return M.showError(this.getAvailableValueElement(),m.getMessage("domain.filter.too_many_records")),void this.getAvailableValueElement().update("");e=[]}try{this.updateDictionaryValuesSelect(e),Object.isFunction(t)&&t()}catch(e){throw"Available values response handling error : #{error}".interpolate({error:e})}}),m.SingleDictionaryEditor.addMethod("initValidators",function(){this.validators=this.createValidators()}),m.SingleDictionaryEditor.addMethod("setSearchValue",function(e){this.searchInputElement.setValue(e),this.updateSearchClearButtonState()}),m.SingleDictionaryEditor.addMethod("afterValueSet",function(){this.updateSearchClearButtonState()}),m.MultipleValuesEditor=function(e,t,i){m.SingleDictionaryEditor.apply(this,arguments)},m.MultipleValuesEditor.prototype=V(m.SingleDictionaryEditor.prototype),m.MultipleValuesEditor.addVar("valueEditorId","multipleValues"),m.MultipleValuesEditor.addMethod("initValueElements",function(){m.SingleDictionaryEditor.prototype.initValueElements.apply(this,arguments),this.availableValuesElement=this.getTemplate().select("select.availableValues")[0],this.selectedValuesElement=this.getTemplate().select("select.selectedValues")[0]}),m.MultipleValuesEditor.addMethod("initEventHandlers",function(){m.SingleDictionaryEditor.prototype.initEventHandlers.apply(this,arguments);var e=v()?"click":"mouseup";e=_()?"blur":e;var t=this.getTemplate();t.on(e,"select.availableValues",m.moveOption.bindAsEventListener(this,function(){return this.selectedValuesElement}.bind(this))),t.on(e,"select.selectedValues",m.moveOption.bindAsEventListener(this,function(){return this.availableValuesElement}.bind(this)))}),m.MultipleValuesEditor.addMethod("updateDictionaryValuesSelect",function(e){var t=m.getSelectValues(this.selectedValuesElement),i=c.difference(e,t),a=m.createSelectWithOptions(i,{class:this.availableValuesElement.readAttribute("class"),multiple:"multiple"});this.availableValuesElement;this.availableValuesElement.replace(a),this.availableValuesElement=this.getTemplate().select("select.availableValues")[0]}),m.moveOption=m.MultipleValuesEditor.moveSelectOption=function(e,t){function i(e,i){e.remove();var a=c.find(i.options,function(t){return t.value>e.value}),r=S.hardEscape(e.text);a?o(a).insert({before:new Element("option",{value:e.value,title:r}).update(r)}):i.insert(new Element("option",{value:e.value,title:r}).update(r)),t.focus()}var a=e.element(),t=t(),r=a.selectedIndex>-1?o(a.options[a.selectedIndex]):e.element();_()?a.childElements().each(function(e){e.selected&&i(e,t)}):Object.isUndefined(r.selectedIndex)&&i(r,t)},m.MultipleValuesEditor.addMethod("createValidators",function(){return[{validator:function(e){return m.baseValidator(function(e){return 0===e.options.length}.curry(this.selectedValuesElement),m.getMessage("value_should_be_not_empty"))}.bind(this),element:this.selectedValuesElement}]}),m.MultipleValuesEditor.addMethod("removeMalicious",function(){}),m.MultipleValuesEditor.addMethod("cancel",function(){M.hideError(this.selectedValuesElement),this.reloadAvailable=!0}),m.MultipleValuesEditor.addMethod("setValue",function(e){this.reloadAvailable&&this.afterTemplateInitialization(),m.setSelectOptions(this.selectedValuesElement,e),this.afterValueSet()}),m.MultipleValuesEditor.addMethod("getAvailableValueElement",function(){return this.availableValuesElement}),m.MultipleValuesEditor.addMethod("getValueElement",function(){return this.selectedValuesElement}),m.MultipleValuesEditor.addMethod("getValue",function(){return m.getSelectValues(this.selectedValuesElement)}),m.MultipleValuesEditor.addMethod("getTitleMessage",function(e){return m.getMessage("filter_multiple_values_title",{comparison:m.getMessage(e)})}),m.ComboSelectEditor=function(e,t,i){m.SingleDictionaryEditor.apply(this,arguments)},m.ComboSelectEditor.prototype=V(m.SingleDictionaryEditor.prototype),m.ComboSelectEditor.addVar("valueEditorId","comboValues"),m.ComboSelectEditor.addMethod("initValueElements",function(){m.SingleDictionaryEditor.prototype.initValueElements.apply(this,arguments),this.availableValuesElement=this.getTemplate().select("select")[0],this.inputElement=this.searchInputElement}),m.ComboSelectEditor.addMethod("initEventHandlers",function(){m.SingleDictionaryEditor.prototype.initEventHandlers.apply(this,arguments),this.initValueChangeHandler(),new u.Observer(this.inputElement,.3,function(e,t){e.writeAttribute("title",t)})}),m.ComboSelectEditor.addMethod("initValueChangeHandler",function(){this.availableValuesElement.observe("change",this.valueSelectedHandler.bind(this))}),m.ComboSelectEditor.addMethod("valueSelectedHandler",function(e){this.setValue(e.element().getValue())}),m.ComboSelectEditor.addMethod("updateDictionaryValuesSelect",function(e){var t=""===e[0]?[]:[""];Event.stopObserving(this.availableValuesElement),this.availableValuesElement.replace(m.createSelectWithOptions(t,e)),this.availableValuesElement=this.getTemplate().select("select")[0],this.initValueChangeHandler(),this.availableValuesElement.selectedIndex=0}),m.ComboSelectEditor.addMethod("onCharacterPressed",function(){m.SingleDictionaryEditor.prototype.onCharacterPressed.call(this),this.availableValuesElement.selectedIndex=0}),m.ComboSelectEditor.addMethod("onClearButtonClicked",function(){m.SingleDictionaryEditor.prototype.onClearButtonClicked.call(this),this.availableValuesElement.selectedIndex=0}),m.ComboSelectEditor.addMethod("setValue",function(e){Object.isArray(e)&&(e=e[0]),this.inputElement.setValue(e),this.afterValueSet()}),m.ComboSelectEditor.addMethod("getAvailableValueElement",function(){return this.availableValuesElement}),m.ComboSelectEditor.addMethod("getValueElement",function(){return this.inputElement}),m.ComboSelectEditor.addMethod("getTitleMessage",function(e){return m.getMessage("filter_combo_title",{comparison:m.getMessage(e)})}),m.StringValueEditor=function(e,t){m.FilterValueEditor.apply(this,arguments)},m.StringValueEditor.prototype=V(m.FilterValueEditor.prototype),m.StringValueEditor.addVar("valueEditorId","stringValues"),m.StringValueEditor.addMethod("initValueElements",function(){this.stringValueElement=this.getTemplate().select("input")[0]}),m.StringValueEditor.addMethod("createValidators",function(){return[{validator:function(e){return m.maxLengthValidator(e,1e3,m.getMessage("too_long_text"))}.bind(this),element:this.getValueElement()}]}),m.StringValueEditor.addMethod("getValueElement",function(){return this.stringValueElement}),m.StringValueEditor.addMethod("getTitleMessage",function(e){return m.getMessage("filter_string_title",{comparison:m.getMessage(e)})}),m.NumberValueEditor=function(e,t){m.StringValueEditor.apply(this,arguments)},m.NumberValueEditor.prototype=V(m.StringValueEditor.prototype),m.NumberValueEditor.addMethod("createValidators",function(){var e=this.getOriginalValue().javaType,t=this.getOriginalValue().dataType,i=m.getNumberBounds(e)||{min:w.MinRange,max:w.MaxRange};return[{validator:function(a){var r=m.numberValidator(a,m.filter.numberFormat,m.getMessage("wrong_number_format",{value:a}));return r.isValid&&(r=m.baseValidator(function(){return"Integer"===t&&m.filter.numberFormat.isInteger(a)},m.getMessage("domain.filter.incorrect_integer_value")),r.isValid&&(r=m.numberBoundsValidator(m.filter.toNumber(a),i,m.getMessage("number_out_of_range",{type:e})))),r},element:this.getValueElement()}]}),m.NumberValueEditor.addMethod("getTitleMessage",function(e){return m.getMessage("filter_number_title",{comparison:m.getMessage(e)})}),m.ValueRangeEditor=function(e,t){m.FilterValueEditor.apply(this,arguments)},m.ValueRangeEditor.prototype=V(m.FilterValueEditor.prototype),m.ValueRangeEditor.addMethod("initValueElements",function(){this.rangeValueElements=c.collect(this.getValueRangeIds(),function(e){return this.getTemplate().select("#"+e.inputId)[0]},this)}),m.ValueRangeEditor.addMethod("createCommonValidators",function(){return c.collect(this.getValueRangeIds(),function(e,t){return{validator:function(e){
return m.valueNotEmptyValidator(this.getElementValue(e),m.getMessage("value_should_be_not_empty"))}.bind(this,t),element:this.getElement(t)}},this)}),m.ValueRangeEditor.addMethod("setValue",function(e){c.each(this.getValueRangeIds(),function(t,i){this.getElement(i).setValue(e[i])},this)}),m.ValueRangeEditor.addMethod("getElement",function(e){return this.rangeValueElements[e]}),m.ValueRangeEditor.addMethod("getElementValue",function(e){return this.getElement(e).getValue()}),m.ValueRangeEditor.addMethod("getValue",function(){return c.collect(this.getValueRangeIds(),function(e,t){return this.getElementValue(t)},this)}),m.ValueRangeEditor.addMethod("getValueElement",function(){return this.rangeValueElements}),m.ValueRangeEditor.addMethod("getTitleMessage",function(e){return m.getMessage("filter_range_title",{comparison:m.getMessage(e)})}),m.NumberRangeEditor=function(e,t){var i=e().id;this.valueEditorId="numberRangeValues",this.RANGE_INPUT_ID="rangeValue",this.BUTTON_SUFFIX="_button",this.numberRangeNames=c.collect([1,2],function(e){var t=this.RANGE_INPUT_ID+"_"+e;return{standardInputId:t,inputId:i+"_"+t}},this),m.ValueRangeEditor.apply(this,arguments)},m.NumberRangeEditor.prototype=V(m.ValueRangeEditor.prototype),m.NumberRangeEditor.addMethod("getValueRangeIds",function(){return this.numberRangeNames}),m.NumberRangeEditor.addMethod("createTemplate",function(){var e=m.FilterValueEditor.prototype.createTemplate.call(this);return c.each(this.getValueRangeIds(),function(t){e.select("#"+t.standardInputId)[0].writeAttribute("id",t.inputId)}),e}),m.NumberRangeEditor.addMethod("createValidators",function(){var e=this.getOriginalValue().javaType,t=m.getNumberBounds(e)||{min:w.MinRange,max:w.MaxRange},i=this.getOriginalValue().dataType;return c.collect(this.getValueRangeIds(),function(a,r){return{validator:function(a){var r,n=this.getElementValue(a);return n.match(m.filter.ATTRIBUTES_PATTERN)?r=m.baseValidator(function(){return!1}):(r=m.numberValidator(n,m.filter.numberFormat,m.getMessage("wrong_number_format",{value:n})),r.isValid&&(r=m.baseValidator(function(){return"Integer"===i&&m.filter.numberFormat.isInteger(n)},m.getMessage("domain.filter.incorrect_integer_value")),r.isValid&&(r=m.numberBoundsValidator(m.filter.toNumber(n),t,m.getMessage("number_out_of_range",{type:e}))))),r}.bind(this,r),element:this.getElement(r)}},this).concat({validator:function(){var i=this.getElementValue(0),a=this.getElementValue(1),r=m.filter.ATTRIBUTES_PATTERN,n=m.filter.ATTRIBUTE_VALUE_PATTERN,l=i.match(r),o=a.match(r),s=i.match(n),d=a.match(n),u=m.numberBoundsValidator(m.filter.toNumber(a),t,m.getMessage("number_out_of_range",{type:e}));return l&&o?m.baseValidator(function(){return s[1]===d[1]},m.getMessage("number_range_error",{from:i,to:a})):l||o?m.baseValidator(function(){return!1}):u.isValid||""===a?m.rangeValidator(m.filter.toNumber(i),m.filter.toNumber(a),m.getMessage("number_range_error",{from:i,to:a})):u}.bind(this),element:this.getElement(1)})}),m.DateValueEditor=function(e,t){"Date"===e().dataType?(this.dateFormat=m.filter.CALENDAR_DATE_FORMAT,this.timeFormat=m.filter.CALENDAR_TIME_FORMAT,e().calendarDateFormat=m.filter.CALENDAR_DATE_FORMAT):"Time"===e().dataType?(this.timeFormat=m.filter.CALENDAR_TIME_FORMAT,e().calendarDateFormat=m.filter.CALENDAR_TIME_FORMAT):(this.dateFormat=m.filter.CALENDAR_DATE_FORMAT,this.timeFormat=m.filter.CALENDAR_TIME_FORMAT,e().calendarDateFormat=m.filter.CALENDAR_TIMESTAMP_FORMAT),this.timeZoneOffset=m.filter.TIMEZONE_OFFSET,this.valueEditorId="dateValues",this.CALENDAR_INPUT_ID="calendar_input",this.CALENDAR_BUTTON_ID="calendar_button",this.dateInputName=e().id+this.CALENDAR_INPUT_ID,this.dateButtonName=e().id+this.CALENDAR_BUTTON_ID,m.FilterValueEditor.apply(this,arguments)},m.DateValueEditor.prototype=V(m.FilterValueEditor.prototype),m.DateValueEditor.addMethod("initValueElements",function(){this.dateValueElement=this.getTemplate().select("#"+this.dateInputName)[0]}),m.DateValueEditor.addMethod("createTemplate",function(){var e=m.FilterValueEditor.prototype.createTemplate.call(this);return e.select("#"+this.CALENDAR_INPUT_ID)[0].writeAttribute("id",this.dateInputName),e}),m.DateValueEditor.addMethod("afterDraw",function(){var e=h("#"+this.dateInputName),t=this._getControlName();this.picker=new E({el:e[0],showOn:"button",buttonText:"",dateFormat:"timepicker"===t?null:this.dateFormat,timeFormat:"datepicker"===t?null:this.timeFormat,showSecond:this.isTimestampField()||this.isTimeField()}),e.next().addClass("button").addClass("picker"),e[0].getValue=function(){return h(this).val()},e.on("mousedown",y),this.fillinTemplate()}),m.DateValueEditor.addMethod("createValidators",function(){return[{validator:function(e){var t=O.toMomentDateOrTimeOrTimestampPattern(m.filter.CALENDAR_DATE_FORMAT,m.filter.CALENDAR_DATE_TIME_SEPARATOR);return this.isTimestampField()&&D(e,t,!0).isValid()&&(e+=" 00:00"),m.dateValidator(e,this.getOriginalValue().calendarDateFormat,m.filter.CALENDAR_DATE_TIME_SEPARATOR,m.getMessage("wrong_date_format",{value:e}))}.bind(this),element:this.getValueElement()}]}),m.DateValueEditor.addMethod("getValueElement",function(){return this.dateValueElement}),m.DateValueEditor.addMethod("getTitleMessage",function(e){return m.getMessage("filter_date_title",{comparison:m.getMessage(e)})}),m.DateRangeEditor=function(e,t){"Date"===e().dataType?(this.dateFormat=m.filter.CALENDAR_DATE_FORMAT,e().calendarDateFormat=m.filter.CALENDAR_DATE_FORMAT):"Time"===e().dataType?(this.timeFormat=m.filter.CALENDAR_TIME_FORMAT,e().calendarDateFormat=m.filter.CALENDAR_TIME_FORMAT):(this.dateFormat=m.filter.CALENDAR_DATE_FORMAT,this.timeFormat=m.filter.CALENDAR_TIME_FORMAT,e().calendarDateFormat=m.filter.CALENDAR_TIMESTAMP_FORMAT),this.timeZoneOffset=m.filter.TIMEZONE_OFFSET;var i=e().id;this.valueEditorId="dateRangeValues",this.RANGE_INPUT_ID="rangeValue",this.BUTTON_SUFFIX="_button",this.dateRangeNames=c.collect([1,2],function(e){var t=this.RANGE_INPUT_ID+"_"+e,a=t+this.BUTTON_SUFFIX;return{standardInputId:t,inputId:i+"_"+t,standardButtonId:a,buttonId:i+"_"+a}},this),m.ValueRangeEditor.apply(this,arguments)},m.DateRangeEditor.prototype=V(m.ValueRangeEditor.prototype),m.DateRangeEditor.addMethod("getValueRangeIds",function(){return this.dateRangeNames}),m.DateRangeEditor.addMethod("createTemplate",function(){var e=m.FilterValueEditor.prototype.createTemplate.call(this);return c.each(this.getValueRangeIds(),function(t){e.select("#"+t.standardInputId)[0].writeAttribute("id",t.inputId)}),e}),m.DateRangeEditor.addMethod("afterDraw",function(){c.each(this.getValueRangeIds(),function(e){var t=h("#"+e.inputId),i=this._getControlName();this.picker=new E({el:t[0],showOn:"button",buttonText:"",dateFormat:"timepicker"===i?null:this.dateFormat,timeFormat:"datepicker"===i?null:this.timeFormat,showSecond:this.isTimestampField()||this.isTimeField()}),t.next().addClass("button").addClass("picker"),t[0].getValue=function(){return h(this).val()},t.on("mousedown",y)},this),this.fillinTemplate()}),m.DateRangeEditor.addMethod("createValidators",function(){return c.collect(this.getValueRangeIds(),function(e,t){return{validator:function(e){var t=this.getElementValue(e),i=O.toMomentDateOrTimeOrTimestampPattern(m.filter.CALENDAR_DATE_FORMAT,m.filter.CALENDAR_DATE_TIME_SEPARATOR);return this.isTimestampField()&&D(t,i,!0).isValid()&&(t+=" 00:00"),m.dateValidator(t,this.getOriginalValue().calendarDateFormat,m.filter.CALENDAR_DATE_TIME_SEPARATOR,m.getMessage("wrong_date_format",{value:t}))}.bind(this,t),element:this.getElement(t)}},this).concat({validator:function(){var e=this.getElementValue(0),t=this.getElementValue(1),i=O.toMomentDateOrTimeOrTimestampPattern(this.getOriginalValue().calendarDateFormat,m.filter.CALENDAR_DATE_TIME_SEPARATOR),a=D(e,i,!0),r=D(t,i,!0);return m.rangeValidator(a.isValid()?a.toDate().getTime():0,r.isValid()?r.toDate().getTime():0,m.getMessage("date_range_error",{from:e,to:t}))}.bind(this),element:this.getElement(1)})}),m.TimeRangeEditor=function(e,t){var i=e().id;this.valueEditorId="numberRangeValues",this.RANGE_INPUT_ID="rangeValue",this.BUTTON_SUFFIX="_button",this.numberRangeNames=c.collect([1,2],function(e){var t=this.RANGE_INPUT_ID+"_"+e;return{standardInputId:t,inputId:i+"_"+t}},this),m.ValueRangeEditor.apply(this,arguments)},m.TimeRangeEditor.prototype=V(m.ValueRangeEditor.prototype),m.TimeRangeEditor.addMethod("getValueRangeIds",function(){return this.numberRangeNames}),m.TimeRangeEditor.addMethod("createTemplate",function(){var e=m.FilterValueEditor.prototype.createTemplate.call(this);return c.each(this.getValueRangeIds(),function(t){e.select("#"+t.standardInputId)[0].writeAttribute("id",t.inputId)}),e}),m.BooleanSelectEditor=function(e,t){m.FilterValueEditor.apply(this,arguments),this.setID(e().id),this.initBooleanLastValueMap(),this.setInitialSelectValue()},m.BooleanSelectEditor.prototype=V(m.FilterValueEditor.prototype),m.BooleanSelectEditor.addVar("valueEditorId","booleanComboValues"),m.BooleanSelectEditor.addMethod("initValueElements",function(){this.selectElement=this.getTemplate().select("select")[0],this.inputElement=this.getTemplate().select("input")[0],this.inputElement.validatorMessageContainer=this.getTemplate().select("div.errorContainer")[0],this.setValueList(),this.initEvents()}),m.BooleanSelectEditor.addMethod("setLastValue",function(e){m.booleanLastValueMap[this.id]=e}),m.BooleanSelectEditor.addMethod("initBooleanLastValueMap",function(){m.booleanLastValueMap=m.booleanLastValueMap||[]}),m.BooleanSelectEditor.addMethod("setInitialSelectValue",function(){this.selectElement.setValue(m.booleanLastValueMap[this.id])}),m.BooleanSelectEditor.addMethod("setID",function(e){this.id=e}),m.BooleanSelectEditor.addMethod("initEvents",function(){var e=this;this.selectElement.observe("change",function(t){var i=t.element().getValue(),a=i===m.getMessage("filter_empty_string")?"":i;e.inputElement.setValue(a),e.setLastValue(a)}),this.inputElement.observe("keyup",function(t){e.selectElement.setValue(m.getMessage("filter_empty_string"))}),this.inputElement.observe("change",function(t){e.setLastValue(t.element().getValue())})}),m.BooleanSelectEditor.addMethod("setValueList",function(){m.setSelectOptions(this.selectElement,[m.getMessage("filter_empty_string"),"true","false"])}),m.BooleanSelectEditor.addMethod("createValidators",function(){var e=this;return[{validator:function(t){var i=m.baseValidator(function(t){return""===e.inputElement.value},m.getMessage("value_should_be_not_empty"));return i.isValid?{isValid:t.match(m.filter.ATTRIBUTES_PATTERN)||"true"===t||"false"===t,errorMessage:m.getMessage("domain.filter.incorrect_attribute_pattern")}:i}.bind(e),element:e.inputElement}]}),m.BooleanSelectEditor.addMethod("getValueElement",function(){return this.inputElement}),m.FilterModelController=function(e,t,i){m.filter.init(i),this.PRE_FILTERS_PANEL="preFilters",this.FILTERS_LIST_ID=e,this.FILTER_EDITOR_CANCEL_BUTTON_ID="filterEditorCancel",this.FILTER_EDITOR_OK_BUTTON_ID="filterEditorOk",this.CREATE_MODE="create",this.UPDATE_MODE="update",this.targetHiddenFieldId="slRules",this.initParams=i,this.filterEditor=t,this._filterEditorsMap=null,this._currentFilter=null,this.mode=null},m.FilterModelController.addMethod("init",function(){if(this._list=new A.List(this.FILTERS_LIST_ID,{listTemplateDomId:"list_domain_chooser_filter",itemTemplateDomId:"list_domain_chooser_filter:leaf",excludeFromSelectionTriggers:[".leaf *"],excludeFromEventHandling:!0}),_()){var e=o(this.FILTERS_LIST_ID);new R(e,e.up())}try{this._filterEditorsMap=new m.FilterList,this.initFilters()}catch(e){window.console&&console.error("Filters initialization failed. Error : #{error}".interpolate({error:e}))}finally{this.updateHiddenField(),this._initListEvents(),this.drawList()}}),m.FilterModelController.addMethod("initFilters",function(){this.initParams.filtersJson.each(function(e){this.addNewToFilterEditorsMap(this.filterEditor.prototype.create(new m.FilterItem({json:e}),this.initParams.flowExecutionKey))}.bind(this))}),m.FilterModelController.addMethod("initDropContainer",function(e){var t={onDrop:this.onDropHandler.bind(this)};e&&(t.accept=e),n.add(o(this.PRE_FILTERS_PANEL),t)}),m.FilterModelController.addMethod("onDropHandler",function(e){var t=e.node;if(t){var i=m.getSelectedTreeNodes(b.trees[t.getTreeId()]);try{1===i.length?this.addFilter(new m.FilterItem({node:t})):2===i.length&&this.addFieldFilter(i)}catch(e){console&&console.error(e)}}}),m.FilterModelController.addMethod("addNewToFilterEditorsMap",function(e,t){if(e){var i=e.getOriginalValue();this.mode!==this.UPDATE_MODE&&this._updateIdIfFilterPresent(i),this._filterEditorsMap.set(i.id,e,t)}}),m.FilterModelController.addMethod("_prepareListItem",function(e){var t=new A.ListItem({cssClassName:N.LEAF_CLASS,value:e});return t.processTemplate=e.processTemplate,t}),m.FilterModelController.addMethod("drawList",function(){var e=this._filterEditorsMap.values().collect(this._prepareListItem);this.getList().setItems(e),this.getList().show()}),m.FilterModelController.addMethod("refreshScroll",function(){var e=N.scrolls.get(this.PRE_FILTERS_PANEL);e&&e.refresh()}),m.FilterModelController.addMethod("addFieldFilter",function(e){if(m.areNodesFromSameIsland(e)){var t=e.collect(function(e){return new m.FilterItem({node:e})}),i=t.first();i.type===t[1].type&&(i.initFieldFilterItem(t[1]),this.addFilter(i))}}),m.FilterModelController.addMethod("addFilter",function(e){try{this.cancelPreviousEditing(),this._updateIdIfFilterPresent(e);var t=this.filterEditor.prototype.create(e,this.initParams.flowExecutionKey),i=this._prepareListItem(t);this.setCurrentFilter(i),this.getList().insertItems(0,[i]),this.getList().refresh(),o(this.FILTERS_LIST_ID).up().scrollTop=0,this.editMode(i),this.mode=this.CREATE_MODE}catch(e){throw this.setCurrentFilter(null),"Unknown filter creation error: #{error}".interpolate({error:e})}}),m.FilterModelController.addMethod("editFilter",function(e){this.cancelPreviousEditing(),e.getValue().resetToCurrentEditor(),this.editMode(e),this.mode=this.UPDATE_MODE}),m.FilterModelController.addMethod("cancelPreviousEditing",function(){if(this._currentFilter){var e=this._currentFilter.getValue();e.cancel();var t=e.getOriginalValue();this._filterEditorsMap.get(t.id)?(this._setItemClassName(this._currentFilter,""),this._currentFilter.refresh()):this.getList().removeItems([this._currentFilter]),this.setCurrentFilter(null)}}),m.FilterModelController.addMethod("removeFilter",function(e){if(e){var t=e.getValue();t.beforeRemove(),this._filterEditorsMap.unset(t.getOriginalValue().id),this.getList().removeItems([e]),this.refreshScroll(),this.updateHiddenField()}}),m.FilterModelController.addMethod("editMode",function(e){this.setCurrentFilter(e),this._setItemClassName(e,"editMode"),e.getValue().afterDraw(),this.refreshScroll(),F(o(document.body))}),m.FilterModelController.addMethod("saveFilter",function(e){var t=e.getValue();t.validate()&&(t.applyEditorValue(),this.addNewToFilterEditorsMap(t,0),this.cancelPreviousEditing(),this.updateHiddenField())}),m.FilterModelController.addMethod("getList",function(){return this._list}),m.FilterModelController.addVar("listEventFactory",{"item:click":function(e){Event.stop(e);var t=Event.extend(e.memo.targetEvent),i=t.element(),a=e.memo.item,r=[i].concat(i.ancestors().slice(0,2));c.any(this._editorElementsMap,function(e,i){return!!d.findElement(r,i,0)&&(Event.stop(t),e.call(this,a),!0)},this)||a.getValue().handleClick(i)}}),m.FilterModelController.addVar("_editorElementsMap",{"#filterEditorOk":function(e){this.saveFilter(e)},"#filterEditorCancel":function(){this.cancelPreviousEditing()},".change":function(e){this.editFilter(e)},".remove":function(e){this.removeFilter(e)}}),m.FilterModelController.addVar("treeEventFactory",{"leaf:dblclick":function(e){var t=e.memo.node;if(Event.stop(e),t){var i=m.getSelectedTreeNodes(b.trees[t.getTreeId()]);try{2===i.length?this.addFieldFilter(i):this.addFilter(new m.FilterItem({node:t}))}catch(e){console&&console.error(e)}}}}),m.FilterModelController.addMethod("setCurrentFilter",function(e){this._currentFilter=e}),m.FilterModelController.addMethod("_setItemClassName",function(e,t){e.setCssClassName(t),e.refreshStyle()}),m.FilterModelController.addMethod("_initListEvents",function(){for(var e in this.listEventFactory)this._list.observe(e,this.listEventFactory[e].bindAsEventListener(this))}),m.FilterModelController.addMethod("_updateIdIfFilterPresent",function(e){var t=this._filterEditorsMap.get(e.id);return t&&e.updateIndex(++t.getOriginalValue().index),e});m.FilterModelController.addMethod("updateHiddenField",function(){var e=Object.toJSON(this._filterEditorsMap.collect(function(e){return e.getOriginalValue()}));s("#"+this.targetHiddenFieldId)[0].writeAttribute("value",e)}),m.setSelectOptions=function(e,t){if(!Object.isElement(e)||!t||!Object.isArray(t))return e;var i=new Date;e.update("");var a=[];return m.appendOptions(a,t),e.update(a.join("")),v()&&(e.className=e.className),window.console&&window.console.log("Select input update time : "+(new Date-i)+" ms."),e},m.createSelectWithOptions=function(){var e=new Date,t=arguments[arguments.length-1],i="";c.isArray(t)||"object"!==a(t)||(i=c.reduce(t||{},function(e,t,i){return e+=i+'="'+t+'" '},""));for(var r=["<select "+i+">"],n=0;n<arguments.length;n++){var l=arguments[n];l&&c.isArray(l)&&m.appendOptions(r,l)}return r.push("</select>"),window.console&&window.console.log("String conversion time : "+(new Date-e)+" ms."),r.join("")},m.appendOptions=function(e,t){for(var i,a,r=0;r<t.length;r++){i=a=null!==t[r]?t[r].replace(/'/g,"&#39;"):m.getMessage("filter_null_value"),""===t[r]&&(i=m.getMessage("filter_empty_string"));var n=S.hardEscape(i);e.push("<option title='"+n+"' value='"+a+"'>"+n+"</option>")}},m.getSelectValues=function(e){return c.map(e.options,function(e){return e.readAttribute("value")})},m.getSelectedOptionId=function(e){return Object.isElement(e)?e.options[e.selectedIndex].readAttribute("id"):null},m.getSelectedTreeNodes=function(e){var t=e.selectedNodes;if(Object.isArray(t))return t.findAll(function(e){return!e.isParent()})},i.exports=m});