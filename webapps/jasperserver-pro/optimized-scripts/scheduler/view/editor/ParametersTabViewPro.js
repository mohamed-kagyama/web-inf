/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","backbone","../../enum/scheduledResourceTypeEnum","runtime_dependencies/jrs-ui/src/scheduler/view/editor/ParametersTabView","runtime_dependencies/bi-dashboard/src/dashboard/model/DashboardModel","runtime_dependencies/bi-dashboard/src/dashboard/dashboardSettings","runtime_dependencies/bi-dashboard/src/dashboard/factory/dashboardComponentViewFactory","../../model/dashboardControlsControllerAdapter","runtime_dependencies/jrs-ui/src/controls/controls.base","runtime_dependencies/jrs-ui/src/namespace/namespace","../../../controls/controls.options","runtime_dependencies/jrs-ui/src/controls/controls.controller"],function(e,o,r){var t=e("jquery"),n=e("underscore"),i=e("backbone"),s=e("../../enum/scheduledResourceTypeEnum"),a=e("runtime_dependencies/jrs-ui/src/scheduler/view/editor/ParametersTabView"),d=e("runtime_dependencies/bi-dashboard/src/dashboard/model/DashboardModel"),l=e("runtime_dependencies/bi-dashboard/src/dashboard/dashboardSettings"),p=e("runtime_dependencies/bi-dashboard/src/dashboard/factory/dashboardComponentViewFactory"),c=e("../../model/dashboardControlsControllerAdapter"),u=e("runtime_dependencies/jrs-ui/src/controls/controls.base"),h=u.OptionsDialog,m=e("runtime_dependencies/jrs-ui/src/namespace/namespace"),g=m.JRS;e("../../../controls/controls.options"),e("runtime_dependencies/jrs-ui/src/controls/controls.controller"),r.exports=a.extend({events:{"click [name=saveCurrentValuesButton]":"saveCurrentValuesClick"},initialize:function(e){var o=a.prototype.initialize.apply(this,arguments);return this.listenTo(this.model,"change:source",this.sourceChangeReportOptions),o},remove:function(){return this.reportOptionsDialog&&this.reportOptionsDialog.remove(),i.View.prototype.remove.apply(this,arguments)},render:function(){var e=a.prototype.render.apply(this,arguments);return this.model.resourceType!==s.DASHBOARD&&(this.reportOptions=new g.Controls.ReportOptions,t(document).on("viewmodel:selection:changed",n.bind(this.viewModelSelectionChange,this)),this.reportOptionsDialog=new h({"button#saveAsBtnSave":n.bind(this.saveAsDialogButtonSaveClick,this),"button#saveAsBtnCancel":n.bind(this.saveAsDialogButtonCancelClick,this)})),e},saveCurrentValuesClick:function(){this.reportOptionsDialog.show()},saveAsDialogButtonSaveClick:function(){var e=this,o=this.reportOptionsDialog.input.getValue(),r=this.model.controlsController.getViewModel().get("selection"),n=o===this.reportOptionsDialog.optionNameToOverwrite;t.when(this.reportOptions.add(this.reportOptions.optionsUrl||this.reportOptions.url,o,r,n)).done(function(){e.reportOptionsDialog.hideWarning();var o=e.reportOptions.getElem().parent();0===o.length&&(o=e.$el.find(".saveCurrentValuesContainer"),o.append(e.reportOptions.getElem())),e.reportOptionsDialog.hide(),delete e.reportOptionsDialog.optionNameToOverwrite}).fail(function(r){try{var t=JSON.parse(r.responseText);"report.options.dialog.confirm.message"===t.errorCode&&!n&&(e.reportOptionsDialog.optionNameToOverwrite=o),e.reportOptionsDialog.showWarning(t.message)}catch(e){}})},saveAsDialogButtonCancelClick:function(){this.reportOptionsDialog.hide()},sourceChange:function(e,o){if(this.model.resourceType===s.DASHBOARD){this.$(".saveCurrentValuesContainer").hide();var r=!this.dashboardModel||this.dashboardModel.get("uri")!==o.reportUnitURI,t=this.model;if(!this.dashboardModel){l.CONTEXT_PATH="..";var n=this.$("#inputControlsContainer"),i=this;this.dashboardModel=new d({uri:o.reportUnitURI},{contextPath:l.CONTEXT_PATH}),this.dashboardModel.on("propertiesAvailable",function(e){if(e.get("useFixedSize"))i.model.fixedSize=!0,i.model.update("source",{referenceWidth:e.get("fixedWidth"),referenceHeight:e.get("fixedHeight")});else{var o=i.model.get("source");i.model.update("source",{referenceWidth:o.referenceWidth||l.DEFAULT_REFERENCE_WIDTH,referenceHeight:o.referenceHeight||l.DEFAULT_REFERENCE_HEIGHT})}}),this.dashboardModel.foundations.on("addComponent",function(e,r){if(r===i.dashboardModel.currentFoundation&&"inputControl"===e.get("type")){i.dashboardModel.hasControls=!0,function(o,r){e.on(o,function(e){var o=t.get("source");o.parameters.parameterValues[r]=e,t.set("source",o)}),i.model.get("source").parameters.parameterValues[o]&&e.set("value",i.model.get("source").parameters.parameterValues[o])}(e.getOwnerParameterName(),e.id);var s=p({model:e,dashboardProperties:i.dashboardModel.currentFoundation.components.getDashboardPropertiesComponent(),dashboardId:o.reportUnitURI});i.model.controlsController.controls.push(s),n.append(s.render().$el)}}),this.model.controlsController=new c(this.model)}r&&this.dashboardModel.fetch().done(function(){i.trigger(i.dashboardModel.hasControls?"IC_Displayed":"failedToGet_IC")}).fail(function(){i.trigger("failedToGet_IC")})}else a.prototype.sourceChange.apply(this,arguments)},sourceChangeReportOptions:function(e,o){var r=this,n=o&&o.reportUnitURI;if(this.reportOptions&&n!==this.reportOptions.url){this.reportOptions.optionsUrl=void 0,this.model.resource("reportOptions",this.model.get("source").reportUnitURI,function(e,o){e||(r.reportOptions.optionsUrl=o.reportUri,t.when(r.reportOptions.fetch(o.reportUri||n,"")).done(function(){r.$el.find(".saveCurrentValuesContainer").append(r.reportOptions.getElem()),t(document).trigger("viewmodel:selection:changed")}))});var i=this.model.get("repositoryDestination").folderURI;this.model.checkPermissionOnFolder(i,function(e,o){var t=!1;e||(t=1===o||30===o),r.$el.find("[name=saveCurrentValuesButton]").attr("disabled",t?null:"disabled")}),this.reportOptions.url=n}},viewModelSelectionChange:function(){var e=this.reportOptions.find({uri:this.reportOptions.url});this.reportOptions.set({selection:e},!0)}})});