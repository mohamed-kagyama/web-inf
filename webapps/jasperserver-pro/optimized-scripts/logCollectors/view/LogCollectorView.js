/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","bundle!all","backbone","runtime_dependencies/js-sdk/src/jrs.configs","runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","../enum/collectorStatusEnum","../model/LogCollectorModel","runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog","text!../templates/logCollector.htm"],function(e,t,o){var n=e("jquery"),i=e("underscore"),s=e("bundle!all"),a=e("backbone"),r=e("runtime_dependencies/js-sdk/src/jrs.configs"),d=e("runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension"),l=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),c=e("../enum/collectorStatusEnum"),m=e("../model/LogCollectorModel"),u=e("runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog"),h=e("text!../templates/logCollector.htm");o.exports=a.View.extend({events:{"keyup input, textarea, select":"updateModelProperty","change input, textarea, select":"updateModelProperty","change [name=verbosity]":"verbosityChange","click [name=stopIcon]":"stopIconClick","click [name=downloadIcon]":"downloadIconClick","click [name=deleteIcon]":"deleteIconClick"},constructor:function(e){var t=n.extend(!0,[],arguments);e=n.extend(!0,{},e),t[0]=e,a.View.apply(this,t)},initialize:function(e){this.options=e,this._updatingModeData={inProgress:!1,timeoutHandler:!1,startTimestamp:0,updateNumber:0,secondsToWaitForShutdown:300},this.model=new m(e.collectorModelFromServer,i.extend({},e,{parse:!0})),d.bind(this,{valid:this.fieldIsValid,invalid:this.fieldIsInvalid,forceUpdate:!0,selector:"name"}),this.listenTo(this.model,"change:verbosity change:status",this.updateUI),this.listenTo(this.model,"change:status",this.statusChange),this.listenTo(this.model,"server_communication_error",this.showServerCommunicationError),this.model.isInShuttingDownMode()&&this._startUpdateProcess()},getErrorDialog:function(){return this.errorDialog?this.errorDialog:this.errorDialog=new l},updateModelProperty:function(e){var t=n(e.target),o={};o[t.attr("realName")||t.attr("name")]="checkbox"===t.attr("type")?t.is(":checked"):n.trim(t.val()),this.model.set(o),this.model.validate(o)},render:function(){return this.setElement(i.template(h,i.extend({},this.model.attributes,{i18n:s,collectorStatusEnum:c}))),this},updateUI:function(e){this.undelegateEvents();var t=i.extend({},this.model.attributes,{i18n:s,collectorStatusEnum:c});e&&(t=i.extend(t,e));var o=n(i.template(h,t));this.$el.find("[name=verbosity]").replaceWith(o.find("[name=verbosity]")),this.$el.find("[name=status]").replaceWith(o.find("[name=status]")),this.$el.find("[name=icons]").children().remove(),this.$el.find("[name=icons]").append(o.find("[name=icons]").children()),this.$el.attr("status",this.model.get("status").toLowerCase()),this.delegateEvents()},fieldIsValid:function(e,t,o){var n=e.$("["+o+'="'+t+'"]').parent();n.removeClass("error"),n.find(".message.warning").text("")},fieldIsInvalid:function(e,t,o,n){if(!0!==o){var i=e.$("["+n+'="'+t+'"]').parent();i.addClass("error"),i.find(".message.warning").text(o)}},verbosityChange:function(){var e=this;this.model.save().fail(function(){e.showServerCommunicationError()})},statusChange:function(){this.trigger("modelStatusChange")},showServerCommunicationError:function(){var e=this.getErrorDialog();e.setMessage(s["logCollectors.alert.server.communication.error"]),e.open()},_startUpdateProcess:function(){!0!==this._updatingModeData.inProgress&&(this._updatingModeData.inProgress=!0,this._updatingModeData.startTimestamp=Math.floor((new Date).getTime()/1e3),this._updatingModeData.updateNumber=0,this._scheduleModelUpdate())},_scheduleModelUpdate:function(){this._updatingModeData.updateNumber++;var e=5;this._updatingModeData.updateNumber<5&&(e=1),this._updatingModeData.timeoutHandler=setTimeout(i.bind(this.updateItsModelFromServer,this),1e3*e)},_stopUpdateProcess:function(){!1!==this._updatingModeData.inProgress&&(clearTimeout(this._updatingModeData.timeoutHandler),this._updatingModeData.timeoutHandler=!1,this._updatingModeData.updateNumber=0,this._updatingModeData.inProgress=!1)},updateItsModelFromServer:function(){this.model.fetch().done(i.bind(function(){if(this.model.isInShuttingDownMode()){if(Math.floor((new Date).getTime()/1e3)-this._updatingModeData.startTimestamp>this._updatingModeData.secondsToWaitForShutdown)return void this._stopUpdateProcess();this._scheduleModelUpdate()}else this._stopUpdateProcess(),this.trigger("stopped")},this)).fail(i.bind(function(){this._stopUpdateProcess()},this))},stopIconClick:function(){if(this.model.isInRunningMode()){var e=this,t=this.model.sendStopSignal();if(!t)return;this.model.set({status:c.SHUTTING_DOWN}),t.fail(function(){e.showServerCommunicationError()}).done(function(){e._startUpdateProcess()})}},downloadIconClick:function(){if(this.model.isInStoppedMode()){var e=r.contextPath+"/rest_v2/diagnostic/collectors/"+this.model.get("id")+"/content",t=document.createElement("iframe");t.src=e,t.style.display="none",n(t).on("load",i.bind(this._onDownloadIframeLoad,this,t)),n("body").append(t)}},_onDownloadIframeLoad:function(e){if(e.contentWindow||e.contentDocument){var t=(e.contentWindow||e.contentDocument).document,o=!1;t.getElementsByTagName("errorDescriptor").length>0&&(o=!0),n("body > *",t).length>0&&(o=!0),!0===o&&this.showServerCommunicationError()}else setTimeout(function(){i.bind(this._onDownloadIframeLoad,this,e)},1e3)},deleteIconClick:function(){if(!this.model.isInShuttingDownMode()){var e=this,t=s["logCollectors.confirm.deleteOne"].replace("{name}",this.model.get("name")).replace("{newline}","<br><br>"),o=new u({title:s["logCollectors.confirm.title"],text:t});this.listenTo(o,"button:yes",function(){e.model.destroy({dataType:"text"}).done(function(){e.remove(),e.trigger("removed",e.model.get("id"))}).fail(function(){e.showServerCommunicationError()})}),o.open()}}})});