/*
 * Copyright (C) 2005 - 2020 TIBCO Software Inc. All rights reserved. Confidentiality & Proprietary.
 * Licensed pursuant to commercial TIBCO End User License Agreement.
 */

define(["require","exports","module","jquery","underscore","underscore.string","bundle!all","backbone.marionette","runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension","../model/LogCollectorModel","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","runtime_dependencies/bi-repository/src/bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory","text!../templates/createLogCollector.htm","text!runtime_dependencies/js-sdk/src/common/templates/dialogErrorPopupTemplate.htm","settings!treeComponent","runtime_dependencies/jrs-ui/src/components/components.dialogs"],function(e,r,o){var t=e("jquery"),s=e("underscore"),i=e("underscore.string"),n=e("bundle!all"),a=e("backbone.marionette"),l=e("runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension"),c=e("../model/LogCollectorModel"),d=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),p=e("runtime_dependencies/bi-repository/src/bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory"),u=e("text!../templates/createLogCollector.htm"),m=e("text!runtime_dependencies/js-sdk/src/common/templates/dialogErrorPopupTemplate.htm"),g=e("settings!treeComponent"),h=e("runtime_dependencies/jrs-ui/src/components/components.dialogs");o.exports=a.ItemView.extend({initialize:function(e){this.options=e||{},this.prepareNewModel()},prepareNewModel:function(){this.unbindValidation(),this.model=new c(s.cloneDeep(c.prototype.defaults),s.extend({},this.options,{parse:!0})),this.reportChooserDialog&&(this.reportChooserDialog.remove(),this.reportChooserDialog=null),this.bindValidation()},render:function(){this.setElement(s.template(u,s.extend({},this.model.attributes,{i18n:n})))},events:{"keyup input[type='text'], input[type='password'], textarea, select":"updateModelProperty","change input[type='text'], input[type='password'], input[type='checkbox'], textarea, select":"updateModelProperty","click button[name=resourceUriBrowseButton]":"onBrowseButtonClick","click button[name=save]":"onSaveButtonClick","click button[name=cancel]":"onCancelButtonClick"},onShow:function(){this.$el.find("[name=name]").focus()},bindValidation:function(){l.bind(this,{valid:this.fieldIsValid,invalid:this.fieldIsInvalid,forceUpdate:!0,selector:"name"})},unbindValidation:function(){l.unbind(this)},fieldIsValid:function(e,r,o){var t=e.$("["+o+"="+r+"]").parent();t.removeClass("error"),t.find(".message.warning").text("")},fieldIsInvalid:function(e,r,o,t){var s=e.$("["+t+"="+r+"]");s.focus();var i=s.parent();i.addClass("error"),i.find(".message.warning").text(o.toString())},updateModelProperty:function(e){var r=t(e.target),o={},s=r.attr("name");o[s]="checkbox"===r.attr("type")?r.is(":checked"):t.trim(r.val()),"userId"===s&&this.fieldIsValid(this,"userId","name"),this.model.set(o),this.model.validate(o)},getReportChooserDialog:function(){if(this.reportChooserDialog)return this.reportChooserDialog;var e=p.getDialog("item");return this.reportChooserDialog=new e({treeBufferSize:parseInt(g.treeLevelLimit,10),resourcesTypeToSelect:[d.REPORT_UNIT,d.ADHOC_DATA_VIEW]}),this.listenTo(this.reportChooserDialog,"close",function(){var e;if(this.reportChooserDialog.selectedResource){e=this.reportChooserDialog.selectedResource.resourceUri;var r=this.$el.find("[name=resourceUri]").val(e);this.model.set("resourceUri",e),r.trigger("change")}}),this.reportChooserDialog},onBrowseButtonClick:function(){this.getReportChooserDialog().open()},onSaveButtonClick:function(){if(this.model.isValid(!0)){var e=this;this.model.save().done(function(){var r=e.model.toJSON();e.trigger("logCollectorHasBeenCreated",r)}).fail(s.bind(this._saveErrorCallback,this))}},onCancelButtonClick:function(){this.trigger("cancelButtonClick")},_saveErrorCallback:function(e){var r=!1;try{r=JSON.parse(e.responseText)}catch(e){}var o=this;r.errorDescriptor&&(r=r.errorDescriptor);var t="";r&&r.parameters?t=r.parameters[0]:-1!==r.message.indexOf("com.jaspersoft.ji.diagnostic.")&&(t=r.message),t=t.replace("com.jaspersoft.ji.diagnostic.",""),"Verbosity"===t&&(t="verbosity"),"collector"!==t&&"Name"!==t||(t="name"),"reportURI"!=t&&"URI"!=t||(t="resourceUri");var s="";if("mandatory.parameter.error"===r.errorCode)s=n["logCollectors.form.parameterIsMissing"];else if("illegal.parameter.value.error"===r.errorCode)s="userId"===t?n["logCollectors.form.userNameIsWrong"]:"resourceUri"===t?n["logCollectors.form.resourceNotFound"].replace("{0}",r.parameters[1]):n["logCollectors.form.parameterIsWrong"];else if("resource.already.exists"===r.errorCode)t="name",s=n["logCollectors.form.nameExists"];else if("access.denied"===r.errorCode)s=n["jsp.accessDenied.errorMsg"],t="resourceUri";else if("resource.not.found"===r.errorCode){var a=r.parameters[0];r.parameters[0].length>50&&(a='"'+i.truncate(r.parameters[0],50)+'"'),s=n["logCollectors.form.resourceNotFound"].replace("{0}",a),t="resourceUri"}else"unsupported.resource.type"===r.errorCode?(s=n["logCollectors.form.resourceNotSupported"],t="resourceUri"):"unsupported.olap.based.resource.type"===r.errorCode&&(s=n["logCollectors.form.unsupported.olap.based.resource.type"],t="resourceUri");if(t)return void this.fieldIsInvalid(o,t,s,"name");this._displayErrorPopup(s||!1,r,e)},_displayErrorPopup:function(e,r,o){var t,i=s.template(m,{message:n["logCollectors.form.failedToSave"],message2:e,errorCode:r[0]?r[0].errorCode:null,errorMsg:r.message,errorLabel:n["logCollectors.form.theReasonIs"],respText:o.responseText,respTextLabel:n["logCollectors.form.fullResponseFromServerIs"]});t=n["logCollectors.form.failedToSave"],e?t+="<br/>"+n["logCollectors.form.theReasonIs"]+": "+e:r[0]&&r[0].errorCode?t+="<br/>"+n["logCollectors.form.theReasonIs"]+": "+r[0].errorCode:r.message&&(t+="<br/>"+n["logCollectors.form.theReasonIs"]+": "+r.message),t+="<br/><br/>"+n["logCollectors.form.fullResponseFromServerIs"]+": "+o.responseText,h.errorPopup.show(i)}})});